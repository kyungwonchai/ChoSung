import subprocess
import sys
import ctypes
import os

def is_admin():
    """관리자 권한 확인"""
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def run_powershell(command):
    """PowerShell 명령어 실행 및 결과 반환"""
    try:
        result = subprocess.run(
            ["powershell", "-Command", command],
            capture_output=True,
            text=True,
            check=True
        )
        return True, result.stdout
    except subprocess.CalledProcessError as e:
        return False, e.stderr

def main():
    print("=== Windows OpenSSH Server Setup Start ===")

    # 1. 관리자 권한 체크
    if not is_admin():
        print("[!] 관리자 권한이 필요합니다. 스크립트를 관리자 권한으로 다시 실행해주세요.")
        # 관리자 권한으로 재실행 시도 (선택 사항, 여기서는 종료)
        input("엔터 키를 누르면 종료합니다...")
        sys.exit(1)

    # 2. OpenSSH Server 설치 여부 확인 및 설치
    print("[*] OpenSSH Server 설치 상태 확인 중...")
    check_cmd = "Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH.Server*'"
    success, output = run_powershell(check_cmd)
    
    if "State : Installed" in output:
        print("    -> 이미 설치되어 있습니다.")
    else:
        print("    -> 설치되어 있지 않습니다. 설치를 시작합니다 (시간이 조금 걸릴 수 있습니다)...")
        install_cmd = "Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0"
        success, install_out = run_powershell(install_cmd)
        if success:
            print("    -> 설치 완료.")
        else:
            print(f"[!] 설치 실패: {install_out}")
            return

    # 3. 서비스 시작 및 자동 실행 설정
    print("[*] SSHD 서비스 설정 중...")
    service_cmds = [
        "Stop-Service sshd",
        "Set-Service -Name sshd -StartupType 'Automatic'",
        "Start-Service sshd"
    ]
    
    for cmd in service_cmds:
        success, err = run_powershell(cmd)
        if not success:
            # 서비스가 없거나 오류 발생 시
            print(f"[!] 서비스 설정 중 오류 발생 ({cmd}): {err}")

    # 4. 방화벽 규칙 확인 (일반적으로 설치 시 자동 추가되나 강제 확인)
    print("[*] 방화벽 규칙 확인 중...")
    # 22번 포트가 열려있는지 확인하는 간단한 로직 (규칙이 없으면 추가)
    fw_cmd = "Get-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -ErrorAction SilentlyContinue"
    success, fw_out = run_powershell(fw_cmd)
    if not success:
         print("    -> 방화벽 규칙이 없어 추가합니다.")
         new_fw_cmd = "New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22"
         run_powershell(new_fw_cmd)
    else:
        print("    -> 방화벽 규칙이 이미 존재합니다.")

    # 5. 접속 정보 출력
    print("\n=== 설정 완료 ===")
    print("[INFO] 이제 우분투에서 접속할 수 있습니다.")
    
    # 현재 사용자 이름 확인
    user_success, user_name = run_powershell('$env:USERNAME')
    current_user = user_name.strip() if user_success else "사용자명"
    
    # IP 주소 확인 (IPv4)
    ip_cmd = "Get-NetIPAddress -AddressFamily IPv4 | Where-Object ConnectionState -eq 'Connected' | Select-Object -ExpandProperty IPAddress"
    _, ip_out = run_powershell(ip_cmd)
    ips = [ip.strip() for ip in ip_out.split('\n') if ip.strip()]
    
    print(f"\n[접속 명령어 예시]")
    if ips:
        for ip in ips:
            # 127.0.0.1 제외
            if not ip.startswith("127."):
                print(f"ssh {current_user}@{ip}")
    else:
        print(f"ssh {current_user}@[윈도우IP]")

    print("\n[참고] Microsoft 계정 로그인 사용자는 비밀번호 대신 이메일 계정 비번을 쓰거나, `whoami` 명령어로 정확한 계정명을 확인해야 합니다.")
    input("\n엔터 키를 누르면 종료합니다...")

if __name__ == "__main__":
    main()