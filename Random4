1. ì‚¬ì „ ì¤€ë¹„ (DB ì—…ë°ì´íŠ¸)
ë¨¼ì € MSSQLì—ì„œ ì•„ë˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì—¬ í…Œì´ë¸” êµ¬ì¡°ë¥¼ í™•ì¥í•´ ì£¼ì„¸ìš”. (ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë˜ë„ë¡ ì„¤ê³„ë¨)

SQL
-- 1. ê¸°ì¡´ FolderIndex í…Œì´ë¸” í™•ì¥ (í†µê³„ ë° ìƒíƒœ ì»¬ëŸ¼ ì¶”ê°€)
IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'FolderIndex' AND COLUMN_NAME = 'TaskCount')
BEGIN
    ALTER TABLE FolderIndex ADD TaskCount INT DEFAULT 0;
    ALTER TABLE FolderIndex ADD LastTaskDate DATETIME NULL;
    ALTER TABLE FolderIndex ADD GroupName NVARCHAR(50) DEFAULT 'Default';
    ALTER TABLE FolderIndex ADD LastRuleContent NVARCHAR(MAX) NULL; -- ë§ˆì§€ë§‰ìœ¼ë¡œ ë³´ë‚¸ ë£° ë‚´ìš©
END

-- 2. ë£°(Rule) ê´€ë¦¬ í…Œì´ë¸”
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ProjectRules' AND xtype='U')
CREATE TABLE ProjectRules (
    RuleID INT IDENTITY(1,1) PRIMARY KEY,
    RuleName NVARCHAR(100) NOT NULL,
    RuleContent NVARCHAR(MAX) NOT NULL,
    IsDefault BIT DEFAULT 0,
    CreatedAt DATETIME DEFAULT GETDATE()
);

-- 3. ì‘ì—… í(Task Queue) í…Œì´ë¸”
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='TaskQueue' AND xtype='U')
CREATE TABLE TaskQueue (
    TaskID INT IDENTITY(1,1) PRIMARY KEY,
    ProjectName NVARCHAR(255) NOT NULL, -- FolderIndexì˜ DisplayNameê³¼ ì—°ê²°
    TaskContent NVARCHAR(MAX),
    Status NVARCHAR(20) DEFAULT 'Pending', -- Pending, Processing, Done, Error
    CreatedAt DATETIME DEFAULT GETDATE(),
    StartedAt DATETIME NULL,
    CompletedAt DATETIME NULL
);

-- 4. í”„ë¡œì íŠ¸ë³„ ë©”ëª¨ í…Œì´ë¸”
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ProjectMemos' AND xtype='U')
CREATE TABLE ProjectMemos (
    ProjectName NVARCHAR(255) PRIMARY KEY,
    MemoContent NVARCHAR(MAX),
    UpdatedAt DATETIME DEFAULT GETDATE()
);
2. í†µí•© ì‹œìŠ¤í…œ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ (upgrade_bridge_system.py)
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” runcline í´ë” ë‚´ë¶€ë¥¼ ëª¨ë“ˆí™”ëœ êµ¬ì¡°(app, services, routes, templates ë“±)ë¡œ ì¬í¸ì„±í•©ë‹ˆë‹¤.

Python
import os

# ==========================================
# 1. Directory Structure Definition
# ==========================================
base_dir = "runcline"
dirs = [
    os.path.join(base_dir, "app"),
    os.path.join(base_dir, "app", "routes"),
    os.path.join(base_dir, "app", "services"),
    os.path.join(base_dir, "app", "templates"),
    os.path.join(base_dir, "app", "static"),
    os.path.join(base_dir, "app", "static", "css"),
    os.path.join(base_dir, "app", "static", "js"),
]

for d in dirs:
    os.makedirs(d, exist_ok=True)

# ==========================================
# 2. Configuration & DB Helper (app/database.py)
# ==========================================
db_code = r"""import pymssql
import os

# Configuration
DB_HOST = '192.168.0.10'
DB_USER = 'sa'
DB_PASSWORD = 'password'
DB_NAME = 'MyDatabase'

def get_db_connection():
    return pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)

def clean_path(path):
    """ìœˆë„ìš° ê²½ë¡œ(\)ë¥¼ ì›¹ í‘œì¤€(/)ìœ¼ë¡œ ë³€í™˜"""
    if path and '\\' in path:
        return path.replace('\\', '/')
    return path
"""
with open(os.path.join(base_dir, "app", "database.py"), "w", encoding="utf-8") as f:
    f.write(db_code)

# ==========================================
# 3. Services (Business Logic)
# ==========================================

# 3-1. SSH Service (app/services/ssh_service.py)
ssh_service_code = r"""import subprocess
import os

def send_rule_via_ssh(ip, account, rule_content, target_path='/tmp/current_rule.txt'):
    """
    SSHë¥¼ í†µí•´ ë£° ë‚´ìš©ì„ ì›ê²©ì§€ íŒŒì¼ë¡œ ì „ì†¡ (echo ë°©ì‹ ì‚¬ìš©)
    ìœˆë„ìš°ì˜ ê²½ìš° Powershell ë“±ì„ ê³ ë ¤í•´ì•¼ í•˜ì§€ë§Œ, 
    OpenSSH Serverê°€ ì„¤ì¹˜ëœ ìœˆë„ìš°ë¼ë©´ ê¸°ë³¸ cmd/powershellì—ì„œ ë¦¬ë‹¤ì´ë ‰ì…˜ì´ ë™ì‘í•¨.
    """
    try:
        # ë£° ë‚´ìš©ì˜ ì¤„ë°”ê¿ˆ ë“±ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ Base64 ì¸ì½”ë”© í›„ ì „ì†¡ ì¶”ì²œí•˜ì§€ë§Œ,
        # ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ í…ìŠ¤íŠ¸ ì „ì†¡ (íŠ¹ìˆ˜ë¬¸ì ì£¼ì˜)
        # ì•ˆì „í•œ ì „ì†¡ì„ ìœ„í•´ ë¡œì»¬ì— ì„ì‹œíŒŒì¼ ìƒì„± í›„ scp ì „ì†¡ ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        
        temp_filename = f"temp_rule_{ip}.txt"
        with open(temp_filename, 'w', encoding='utf-8') as f:
            f.write(rule_content)
            
        # SCP Command
        # scp temp_rule.txt user@ip:destination
        # ìœˆë„ìš° íƒ€ê²Ÿì¸ ê²½ìš° ê²½ë¡œê°€ C:/... ì¼ ìˆ˜ ìˆìŒ. ìƒëŒ€ê²½ë¡œ(í™ˆë””ë ‰í† ë¦¬) ê¶Œì¥.
        remote_dest = f"{account}@{ip}:rule.txt" 
        
        cmd = ['scp', '-o', 'StrictHostKeyChecking=no', temp_filename, remote_dest]
        
        subprocess.check_call(cmd)
        
        if os.path.exists(temp_filename):
            os.remove(temp_filename)
            
        return True, "Rule Sent Successfully"
    except Exception as e:
        return False, str(e)
"""
with open(os.path.join(base_dir, "app", "services", "ssh_service.py"), "w", encoding="utf-8") as f:
    f.write(ssh_service_code)

# ==========================================
# 4. Routes (Controllers)
# ==========================================

# 4-1. Main Routes (app/routes/main_routes.py)
main_routes_code = r"""from flask import Blueprint, render_template
from app.database import get_db_connection, clean_path

main_bp = Blueprint('main', __name__)

@main_bp.route('/')
def index():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    # í”„ë¡œì íŠ¸ ëª©ë¡ + í ìƒíƒœ(ë…¸ë€ìƒ‰ í‘œì‹œìš©) + ê·¸ë£¹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    # LEFT JOINìœ¼ë¡œ í˜„ì¬ íì— Pending/Processing ìƒíƒœì¸ ì‘ì—…ì´ ìˆëŠ”ì§€ í™•ì¸ (IsQueued)
    query = \"\"\"
        SELECT 
            f.IPAddress, f.Account, f.DisplayName, f.FullPath, f.GroupName, 
            f.TaskCount, CONVERT(VARCHAR, f.LastTaskDate, 120) as LastTaskDate,
            f.LastRuleContent,
            CASE WHEN q.TaskID IS NOT NULL THEN 1 ELSE 0 END as IsQueued
        FROM FolderIndex f
        LEFT JOIN TaskQueue q ON f.DisplayName = q.ProjectName 
             AND q.Status IN ('Pending', 'Processing')
        ORDER BY f.LastTaskDate DESC, f.DisplayName ASC
    \"\"\"
    cursor.execute(query)
    rows = cursor.fetchall()
    
    # ê²½ë¡œ ì •ì œ
    for row in rows:
        row['FullPath'] = clean_path(row['FullPath'])
        
    # í†µê³„: ì´ í˜¸ì¶œ íšŸìˆ˜
    cursor.execute("SELECT SUM(TaskCount) as TotalCalls FROM FolderIndex")
    stats = cursor.fetchone()
    total_calls = stats['TotalCalls'] if stats['TotalCalls'] else 0

    conn.close()
    return render_template('index.html', projects=rows, total_calls=total_calls)

@main_bp.route('/settings')
def settings():
    return render_template('settings.html')
"""
with open(os.path.join(base_dir, "app", "routes", "main_routes.py"), "w", encoding="utf-8") as f:
    f.write(main_routes_code)

# 4-2. API Routes (app/routes/api_routes.py)
api_routes_code = r"""from flask import Blueprint, request, jsonify
from app.database import get_db_connection
from app.services.ssh_service import send_rule_via_ssh
import subprocess
import os

api_bp = Blueprint('api', __name__)

# --- VSCode Open ---
@api_bp.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    target_ip = data.get('ip')
    user = data.get('account')
    path = data.get('path')
    
    # ë¡œì»¬ IP í™•ì¸ ë¡œì§ ìƒëµ (ê°„ì†Œí™”)
    cmd = ['code', '--no-sandbox', '--new-window']
    
    # ìœˆë„ìš° ê²½ë¡œ ì²˜ë¦¬ (SSH í•„ìš” ì—¬ë¶€ íŒë‹¨ì€ í´ë¼ì´ì–¸íŠ¸ IP ë¹„êµ ë˜ëŠ” ë¬´ì¡°ê±´ SSH)
    # ì—¬ê¸°ì„œëŠ” ë¬´ì¡°ê±´ SSHë¡œ ê°€ì • (ì´ì „ ìš”ì²­ì‚¬í•­ ë°˜ì˜)
    remote_arg = f"ssh-remote+{user}@{target_ip}"
    cmd.extend(['--remote', remote_arg, path])
    
    try:
        env = os.environ.copy()
        if 'DISPLAY' not in env: env['DISPLAY'] = ':0'
        subprocess.Popen(cmd, env=env)
        return jsonify({'status': 'success'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

# --- Stats & Group Info (Pollingìš©) ---
@api_bp.route('/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    # ê·¸ë£¹ë³„ í”„ë¡œì íŠ¸ ìˆ˜
    cursor.execute("SELECT GroupName, COUNT(*) as Cnt FROM FolderIndex GROUP BY GroupName")
    group_counts = cursor.fetchall()
    
    # ê·¸ë£¹ë³„ í™œì„±(íì— ìˆëŠ”) ì‘ì—… ìˆ˜
    cursor.execute(\"\"\"
        SELECT f.GroupName, COUNT(*) as Cnt 
        FROM TaskQueue q
        JOIN FolderIndex f ON q.ProjectName = f.DisplayName
        WHERE q.Status IN ('Pending', 'Processing')
        GROUP BY f.GroupName
    \"\"\")
    active_counts = cursor.fetchall()
    
    conn.close()
    return jsonify({'groups': group_counts, 'active': active_counts})

# --- Rule Management ---
@api_bp.route('/rules', methods=['GET', 'POST'])
def handle_rules():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    if request.method == 'GET':
        cursor.execute("SELECT * FROM ProjectRules ORDER BY RuleID DESC")
        rules = cursor.fetchall()
        conn.close()
        return jsonify(rules)
        
    if request.method == 'POST':
        data = request.json
        cursor.execute("INSERT INTO ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", 
                       (data['name'], data['content']))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

@api_bp.route('/rules/deploy', methods=['POST'])
def deploy_rule():
    data = request.json
    project_name = data.get('project_name')
    rule_id = data.get('rule_id')
    
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    # 1. ë£° ë‚´ìš© ì¡°íšŒ
    cursor.execute("SELECT RuleContent FROM ProjectRules WHERE RuleID=%s", (rule_id,))
    rule = cursor.fetchone()
    
    # 2. íƒ€ê²Ÿ í”„ë¡œì íŠ¸ ì •ë³´ ì¡°íšŒ
    cursor.execute("SELECT IPAddress, Account FROM FolderIndex WHERE DisplayName=%s", (project_name,))
    target = cursor.fetchone()
    
    if not rule or not target:
        conn.close()
        return jsonify({'status': 'error', 'message': 'Not found'}), 404
        
    # 3. SSH ì „ì†¡ (Service í˜¸ì¶œ)
    success, msg = send_rule_via_ssh(target['IPAddress'], target['Account'], rule['RuleContent'])
    
    if success:
        # DBì— ë§ˆì§€ë§‰ ì „ì†¡ ë£° ê¸°ë¡
        cursor.execute("UPDATE FolderIndex SET LastRuleContent=%s WHERE DisplayName=%s", 
                       (rule['RuleContent'], project_name))
        conn.commit()
        
    conn.close()
    return jsonify({'status': 'success' if success else 'error', 'message': msg})

# --- Memo Management ---
@api_bp.route('/memos/<project_name>', methods=['GET', 'POST'])
def handle_memo(project_name):
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    if request.method == 'GET':
        cursor.execute("SELECT MemoContent FROM ProjectMemos WHERE ProjectName=%s", (project_name,))
        row = cursor.fetchone()
        conn.close()
        return jsonify({'content': row['MemoContent'] if row else ''})
        
    if request.method == 'POST':
        content = request.json.get('content')
        # MERGE Query for Memo
        sql = \"\"\"
            MERGE ProjectMemos AS target
            USING (SELECT %s as PName) AS source
            ON (target.ProjectName = source.PName)
            WHEN MATCHED THEN UPDATE SET MemoContent = %s, UpdatedAt = GETDATE()
            WHEN NOT MATCHED THEN INSERT (ProjectName, MemoContent) VALUES (%s, %s);
        \"\"\"
        cursor.execute(sql, (project_name, content, project_name, content))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

# --- Task Queue Management ---
@api_bp.route('/queue', methods=['GET', 'POST'])
def handle_queue():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    if request.method == 'GET': # íŠ¹ì • í”„ë¡œì íŠ¸ì˜ í ì¡°íšŒ
        p_name = request.args.get('project')
        cursor.execute("SELECT * FROM TaskQueue WHERE ProjectName=%s AND Status IN ('Pending', 'Processing') ORDER BY TaskID", (p_name,))
        rows = cursor.fetchall()
        conn.close()
        return jsonify(rows)
        
    if request.method == 'POST': # ì‘ì—… ì¶”ê°€
        data = request.json
        p_name = data.get('project')
        content = data.get('content')
        
        # 1. íì— ì¶”ê°€
        cursor.execute("INSERT INTO TaskQueue (ProjectName, TaskContent) VALUES (%s, %s)", (p_name, content))
        
        # 2. í†µê³„ ì—…ë°ì´íŠ¸ (í˜¸ì¶œ íšŸìˆ˜ ì¦ê°€, ë§ˆì§€ë§‰ ë‚ ì§œ ê°±ì‹ )
        cursor.execute("UPDATE FolderIndex SET TaskCount = TaskCount + 1, LastTaskDate = GETDATE() WHERE DisplayName=%s", (p_name,))
        
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(api_routes_code)

# ==========================================
# 5. Templates (HTML)
# ==========================================

# 5-1. Index HTML (Dashboard)
index_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>AI Automation Bridge v2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #1e1e1e; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .table-dark { --bs-table-bg: #2d2d2d; color: #e0e0e0; }
        .btn-sm { font-size: 0.8rem; }
        .highlight-queue { background-color: #4a4a2a !important; color: #fff; } /* ë…¸ë€ìƒ‰ ê³„ì—´ ê°•ì¡° */
        .stats-box { background: #2d2d2d; padding: 10px; border-radius: 5px; border: 1px solid #444; }
        .total-counter { font-size: 1.2rem; font-weight: bold; color: #4caf50; }
        .modal-content { background-color: #2d2d2d; color: #fff; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-robot"></i> AI Bridge v2</a>
            <div class="d-flex align-items-center">
                <span class="me-3">Total Calls: <span class="total-counter">{{ total_calls }}</span></span>
                <a href="/settings" class="btn btn-outline-light"><i class="bi bi-gear-fill"></i></a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-md-2">
                <div class="stats-box mb-3">
                    <h6><i class="bi bi-folder"></i> Groups</h6>
                    <div id="groupStats">Loading...</div>
                </div>
                <div class="stats-box">
                    <h6><i class="bi bi-activity"></i> Active Tasks</h6>
                    <div id="activeStats" class="text-warning">Loading...</div>
                </div>
            </div>

            <div class="col-md-10">
                <table class="table table-dark table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Group</th>
                            <th>Project (ID)</th>
                            <th>Path</th>
                            <th>Last Active</th>
                            <th>Calls</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in projects %}
                        <tr class="{{ 'highlight-queue' if p.IsQueued else '' }}" id="row-{{ p.DisplayName }}">
                            <td><span class="badge bg-secondary">{{ p.GroupName }}</span></td>
                            <td class="fw-bold">{{ p.DisplayName }}</td>
                            <td class="small text-muted">{{ p.FullPath }}</td>
                            <td>{{ p.LastTaskDate }}</td>
                            <td>{{ p.TaskCount }}</td>
                            <td>
                                <button class="btn btn-primary btn-sm me-1" onclick="openVsCode('{{ p.IPAddress }}', '{{ p.Account }}', '{{ p.FullPath }}')">
                                    <i class="bi bi-code-slash"></i>
                                </button>
                                <button class="btn btn-success btn-sm me-1" onclick="openTaskModal('{{ p.DisplayName }}')">
                                    <i class="bi bi-plus-lg"></i> Task
                                </button>
                                <button class="btn btn-info btn-sm me-1" onclick="openRuleModal('{{ p.DisplayName }}')">
                                    <i class="bi bi-send"></i> Rule
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="openMemoModal('{{ p.DisplayName }}')">
                                    <i class="bi bi-sticky"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Task - <span id="modalProjectName" class="text-warning"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Current Queue</h6>
                    <ul class="list-group bg-dark mb-3" id="currentQueueList"></ul>
                    
                    <div class="form-group">
                        <label>New Command / Task</label>
                        <textarea class="form-control bg-dark text-white" id="taskContent" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="submitTask()">Add to Queue</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ruleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deploy Rule</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Project: <span id="ruleProjectName" class="fw-bold"></span></p>
                    <div class="mb-3">
                        <label>Select Rule</label>
                        <select class="form-select bg-dark text-white" id="ruleSelect"></select>
                    </div>
                    <div class="alert alert-secondary small" id="lastRuleInfo">
                        Last Sent: <br><span id="lastRuleContent">None</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" onclick="deployRule()">Deploy Rule (SSH)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="memoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Project Memo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control bg-dark text-white" id="memoContent" rows="10" placeholder="Private notes for next goals..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveMemo()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>
"""
with open(os.path.join(base_dir, "app", "templates", "index.html"), "w", encoding="utf-8") as f:
    f.write(index_html)

# 5-2. Settings HTML
settings_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Settings - Rule Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-white p-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Rule Management</h2>
            <a href="/" class="btn btn-secondary">Back to Dashboard</a>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card bg-secondary text-white mb-3">
                    <div class="card-header">Create New Rule</div>
                    <div class="card-body">
                        <input type="text" id="newRuleName" class="form-control mb-2" placeholder="Rule Name">
                        <textarea id="newRuleContent" class="form-control mb-2" rows="5" placeholder="Rule Content"></textarea>
                        <button class="btn btn-success w-100" onclick="addRule()">Save Rule</button>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card bg-secondary text-white">
                    <div class="card-header">Existing Rules</div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush bg-dark" id="ruleList">
                            </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', loadRules);

        function loadRules() {
            fetch('/api/rules')
            .then(r => r.json())
            .then(data => {
                const list = document.getElementById('ruleList');
                list.innerHTML = '';
                data.forEach(rule => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item bg-dark text-white border-secondary';
                    li.innerHTML = `<strong>${rule.RuleName}</strong><pre class="small text-muted mb-0">${rule.RuleContent}</pre>`;
                    list.appendChild(li);
                });
            });
        }

        function addRule() {
            const name = document.getElementById('newRuleName').value;
            const content = document.getElementById('newRuleContent').value;
            if(!name || !content) return alert('Fill all fields');

            fetch('/api/rules', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, content})
            }).then(() => {
                document.getElementById('newRuleName').value = '';
                document.getElementById('newRuleContent').value = '';
                loadRules();
            });
        }
    </script>
</body>
</html>
"""
with open(os.path.join(base_dir, "app", "templates", "settings.html"), "w", encoding="utf-8") as f:
    f.write(settings_html)

# ==========================================
# 6. Static JS (app/static/js/main.js)
# ==========================================
js_code = r"""
let currentProject = '';
const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
const ruleModal = new bootstrap.Modal(document.getElementById('ruleModal'));
const memoModal = new bootstrap.Modal(document.getElementById('memoModal'));

// --- Initial Load ---
document.addEventListener('DOMContentLoaded', () => {
    updateDashboardStats();
    setInterval(updateDashboardStats, 5000); // 5ì´ˆë§ˆë‹¤ ëŒ€ì‹œë³´ë“œ í†µê³„ ê°±ì‹ 
});

function updateDashboardStats() {
    fetch('/api/stats/dashboard')
    .then(r => r.json())
    .then(data => {
        // Render Group Stats
        const gDiv = document.getElementById('groupStats');
        gDiv.innerHTML = data.groups.map(g => `<div>${g.GroupName}: ${g.Cnt}</div>`).join('');
        
        // Render Active Stats
        const aDiv = document.getElementById('activeStats');
        if(data.active.length === 0) aDiv.innerHTML = 'None';
        else aDiv.innerHTML = data.active.map(a => `<div>${a.GroupName}: ${a.Cnt}</div>`).join('');
    });
}

// --- Action: Open VSCode ---
function openVsCode(ip, account, path) {
    fetch('/api/open_vscode', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ip, account, path})
    });
}

// --- Action: Task Queue ---
function openTaskModal(pName) {
    currentProject = pName;
    document.getElementById('modalProjectName').innerText = pName;
    document.getElementById('taskContent').value = ''; // Reset
    
    // Load current queue
    fetch(`/api/queue?project=${pName}`)
    .then(r => r.json())
    .then(tasks => {
        const list = document.getElementById('currentQueueList');
        list.innerHTML = tasks.length ? '' : '<li class="list-group-item bg-dark text-muted">No active tasks</li>';
        tasks.forEach(t => {
            list.innerHTML += `<li class="list-group-item bg-dark text-white border-secondary">
                <span class="badge bg-warning text-dark">${t.Status}</span> ${t.TaskContent}
            </li>`;
        });
        taskModal.show();
    });
}

function submitTask() {
    const content = document.getElementById('taskContent').value;
    if(!content) return;
    
    fetch('/api/queue', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({project: currentProject, content: content})
    }).then(() => {
        taskModal.hide();
        // UI ì¦‰ì‹œ ë°˜ì˜ (ë…¸ë€ìƒ‰ ë°°ê²½)
        document.getElementById(`row-${currentProject}`).classList.add('highlight-queue');
        updateDashboardStats(); // í†µê³„ ê°±ì‹ 
        location.reload(); // ì¹´ìš´íŠ¸ ê°±ì‹ ì„ ìœ„í•´ ë¦¬ë¡œë“œ (SPAë¡œ í•  ìˆ˜ë„ ìˆì§€ë§Œ ê°„ë‹¨í•˜ê²Œ)
    });
}

// --- Action: Deploy Rule ---
function openRuleModal(pName) {
    currentProject = pName;
    document.getElementById('ruleProjectName').innerText = pName;
    
    // 1. Load Rules
    fetch('/api/rules')
    .then(r => r.json())
    .then(rules => {
        const sel = document.getElementById('ruleSelect');
        sel.innerHTML = rules.map(r => `<option value="${r.RuleID}">${r.RuleName}</option>`).join('');
    });
    
    // 2. Load Last Rule Info (from page data or fetch if needed, here simplified)
    // ì‹¤ì œë¡œëŠ” APIì—ì„œ LastRuleContentë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ í•´ì•¼ í•¨.
    ruleModal.show();
}

function deployRule() {
    const ruleId = document.getElementById('ruleSelect').value;
    fetch('/api/rules/deploy', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({project_name: currentProject, rule_id: ruleId})
    })
    .then(r => r.json())
    .then(res => {
        alert(res.message);
        if(res.status === 'success') ruleModal.hide();
    });
}

// --- Action: Memo ---
function openMemoModal(pName) {
    currentProject = pName;
    fetch(`/api/memos/${pName}`)
    .then(r => r.json())
    .then(data => {
        document.getElementById('memoContent').value = data.content;
        memoModal.show();
    });
}

function saveMemo() {
    const content = document.getElementById('memoContent').value;
    fetch(`/api/memos/${currentProject}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content})
    }).then(() => memoModal.hide());
}
"""
with open(os.path.join(base_dir, "app", "static", "js", "main.js"), "w", encoding="utf-8") as f:
    f.write(js_code)


# ==========================================
# 7. Entry Point (run_bridge.py) - Renamed app.py
# ==========================================
entry_code = r"""from flask import Flask
from app.routes.main_routes import main_bp
from app.routes.api_routes import api_bp

app = Flask(__name__, template_folder='app/templates', static_folder='app/static')

# Register Blueprints
app.register_blueprint(main_bp)
app.register_blueprint(api_bp, url_prefix='/api')

if __name__ == '__main__':
    print("ğŸš€ AI Automation Bridge v2 Started on Port 9111")
    # Host 0.0.0.0 for external access
    app.run(host='0.0.0.0', port=9111, debug=True)
"""
with open(os.path.join(base_dir, "run_bridge.py"), "w", encoding="utf-8") as f:
    f.write(entry_code)

print("âœ… AI Automation Bridge v2 System setup complete!")
print(f"ğŸ“‚ Folder: ./{base_dir}")
print("ğŸ‘‰ Run: python3 runcline/run_bridge.py")
3. ê¸°ëŠ¥ ìš”ì•½ ë° ì‚¬ìš© ê°€ì´ë“œ
êµ¬ì¡° ë³€ê²½ (SOLID ë° ëª¨ë“ˆí™” ì ìš©) ê¸°ì¡´ì˜ ê±°ëŒ€í•œ ë‹¨ì¼ íŒŒì¼ ëŒ€ì‹ , runcline/app/ í•˜ìœ„ì— ê¸°ëŠ¥ë³„ë¡œ íŒŒì¼ì„ ìª¼ê°°ìŠµë‹ˆë‹¤.

routes/: í™”ë©´(main_routes)ê³¼ ë°ì´í„°(api_routes) ì²˜ë¦¬ ë¶„ë¦¬

services/: SSH ì „ì†¡ ë“± í•µì‹¬ ë¡œì§ ë¶„ë¦¬

database.py: DB ì—°ê²° ê´€ë¦¬ í†µí•©

ì£¼ìš” ê¸°ëŠ¥ ì„¤ëª…

ë©”ì¸ ëŒ€ì‹œë³´ë“œ (/)

ì¢Œì¸¡ ìƒë‹¨: ê·¸ë£¹ë³„ í”„ë¡œì íŠ¸ ìˆ˜, í˜„ì¬ ìˆ˜í–‰ ì¤‘(ë…¸ë€ë¶ˆ)ì¸ ì‘ì—… ìˆ˜ ì‹¤ì‹œê°„ í‘œì‹œ.

ìƒë‹¨: ì „ì²´ í˜¸ì¶œ íšŸìˆ˜(Total Calls) í…ìŠ¤íŠ¸ í‘œì‹œ.

í…Œì´ë¸”: í”„ë¡œì íŠ¸ëª…(ID), ê²½ë¡œ, ë§ˆì§€ë§‰ í™œë™ ì‹œê°„ í‘œì‹œ.

ë…¸ë€ ë°°ê²½: í˜„ì¬ íì— ì‘ì—…ì´ ìˆìœ¼ë©´ í•´ë‹¹ í–‰ì´ ë…¸ë€ìƒ‰ìœ¼ë¡œ ê°•ì¡°ë©ë‹ˆë‹¤.

ì‘ì—… ì¶”ê°€ (Task ë²„íŠ¼)

ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ì´ ëœ¹ë‹ˆë‹¤.

ìƒë‹¨: í˜„ì¬ ì´ í”„ë¡œì íŠ¸ì˜ ëŒ€ê¸°ì—´(Queue) ìƒíƒœë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.

í•˜ë‹¨: í…ìŠ¤íŠ¸ ì…ë ¥ì°½. í”„ë¡œì íŠ¸ëª…ì´ ìë™ìœ¼ë¡œ ë°”ì¸ë”©ë˜ì–´ ìˆì–´ ë‚´ìš©ë§Œ ì ê³  ì—”í„°ì¹˜ë©´ íì— ìŒ“ì…ë‹ˆë‹¤.

ë£° ê´€ë¦¬ ë° ë°°í¬ (Rule ë²„íŠ¼ & ì„¤ì •)

ìš°ìƒë‹¨ í†±ë‹ˆë°”í€´ ì•„ì´ì½˜ì„ ëˆ„ë¥´ë©´ ë£°ì„ ìƒì„±/ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¦¬ìŠ¤íŠ¸ì—ì„œ Rule ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ë§Œë“¤ì–´ë‘” ë£° ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ SSHë¡œ ì¦‰ì‹œ ì „ì†¡í•©ë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ ë³´ë‚¸ ë£°ì´ ë¬´ì—‡ì´ì—ˆëŠ”ì§€ DBì— ê¸°ë¡ë©ë‹ˆë‹¤.

ë©”ëª¨ì¥ (Memo ë²„íŠ¼)

ê° í”„ë¡œì íŠ¸ë³„ë¡œ ë‚˜ë§Œ ë³´ëŠ” ëª©í‘œ/ë©”ëª¨ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì‹¤í–‰ ë°©ë²•

python3 runcline/run_bridge.py

ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:9111 ì ‘ì†

ì´ì œ ì´ ì‹œìŠ¤í…œì€ ë‹¨ìˆœí•œ í´ë” ì—´ê¸°ë¥¼ ë„˜ì–´, AI ì—ì´ì „íŠ¸ì—ê²Œ ì‘ì—…ì„ ì§€ì‹œí•˜ê³ (Queue), í–‰ë™ ì§€ì¹¨ì„ í•˜ë‹¬í•˜ê³ (Rule), ì§„í–‰ ìƒí™©ì„ ëª¨ë‹ˆí„°ë§í•˜ëŠ” ê´€ì œíƒ‘ ì—­í• ì„ í•˜ê²Œ ë©ë‹ˆë‹¤.