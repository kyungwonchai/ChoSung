import os
import sys
import ctypes
import subprocess
import shutil

def is_admin():
    """관리자 권한 확인"""
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def run_command(cmd):
    """명령어 실행 함수 (인코딩 에러 방지 버전)"""
    # text=True를 빼고 바이트로 받아서 직접 디코딩합니다.
    result = subprocess.run(cmd, shell=True, capture_output=True)
    
    # 우선 CP949(한국어 윈도우 기본)로 시도하고, 안되면 UTF-8, 그래도 안되면 무시
    try:
        stdout = result.stdout.decode('cp949')
    except UnicodeDecodeError:
        stdout = result.stdout.decode('utf-8', errors='ignore')

    try:
        stderr = result.stderr.decode('cp949')
    except UnicodeDecodeError:
        stderr = result.stderr.decode('utf-8', errors='ignore')

    return result.returncode == 0, stdout, stderr

def read_file_safe(filepath):
    """파일 읽기 (인코딩 자동 감지)"""
    encodings = ['utf-8', 'cp949', 'mbcs']
    for enc in encodings:
        try:
            with open(filepath, 'r', encoding=enc) as f:
                return f.readlines()
        except UnicodeDecodeError:
            continue
    # 다 실패하면 에러 무시하고 읽기
    with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
        return f.readlines()

def main():
    print("=== Windows SSH Key Setup (Encoding Safe Ver) ===")

    # 1. 관리자 권한 체크
    if not is_admin():
        print("[!] 관리자 권한이 필요합니다. 스크립트를 관리자 권한으로 다시 실행해주세요.")
        input("엔터 키를 누르면 종료합니다...")
        sys.exit(1)

    # 2. 사용자 입력 (공개키)
    print("\n[Step 1] 우분투에서 복사한 공개키(ssh-rsa ...)를 아래에 붙여넣고 엔터를 치세요:")
    try:
        # 입력받을 때도 인코딩 이슈가 있을 수 있어 sys.stdin 사용
        public_key = sys.stdin.readline().strip()
    except:
        public_key = input(">> ").strip()
    
    if not public_key:
        print("[!] 키가 입력되지 않았습니다.")
        return

    # 3. 경로 설정
    user_profile = os.environ['USERPROFILE']
    ssh_dir = os.path.join(user_profile, '.ssh')
    auth_keys_file = os.path.join(ssh_dir, 'authorized_keys')

    # 4. .ssh 디렉토리 생성
    if not os.path.exists(ssh_dir):
        os.makedirs(ssh_dir)

    # 키 추가
    key_exists = False
    if os.path.exists(auth_keys_file):
        lines = read_file_safe(auth_keys_file)
        content = "".join(lines)
        if public_key in content:
            key_exists = True
    
    if not key_exists:
        # 쓸 때는 utf-8로 강제
        with open(auth_keys_file, 'a', encoding='utf-8') as f:
            f.write(public_key + "\n")
        print("[*] authorized_keys 파일에 키 저장 완료.")
    else:
        print("[*] 이미 등록된 키입니다.")

    # 5. 권한(ACL) 설정
    print("[*] 파일 권한(ACL) 재설정 중...")
    current_user = os.environ['USERNAME']
    
    # icacls 명령어 실행
    cmd = f'icacls "{auth_keys_file}" /inheritance:r /grant:r "{current_user}:F" /grant:r SYSTEM:F /grant:r Administrators:F'
    success, out, err = run_command(cmd)
    
    if success:
        print("    -> 권한 설정 성공.")
    else:
        print(f"[!] 권한 설정 경고(무시 가능할 수 있음): {err}")

    # 6. sshd_config 수정
    print("[*] sshd_config 설정 변경 중...")
    config_path = r"C:\ProgramData\ssh\sshd_config"
    
    if os.path.exists(config_path):
        shutil.copy(config_path, config_path + ".bak") # 백업
        
        lines = read_file_safe(config_path)
        new_lines = []
        comment_mode = False
        
        for line in lines:
            stripped = line.strip()
            # 설정 변경 로직
            if stripped.lower().startswith("passwordauthentication"):
                new_lines.append("PasswordAuthentication no\n")
            elif stripped.lower().startswith("pubkeyauthentication"):
                new_lines.append("PubkeyAuthentication yes\n")
            elif stripped.lower().startswith("match group administrators"):
                comment_mode = True
                new_lines.append(f"# {line}")
            else:
                if comment_mode:
                    if stripped.lower().startswith("authorizedkeysfile"):
                        new_lines.append(f"# {line}")
                        comment_mode = False
                    elif line.startswith(" ") or line.startswith("\t"):
                         new_lines.append(f"# {line}")
                    else:
                         new_lines.append(line)
                         comment_mode = False
                else:
                    new_lines.append(line)

        try:
            with open(config_path, 'w', encoding='utf-8') as f:
                f.writelines(new_lines)
            print("    -> 설정 파일 수정 완료.")
        except Exception as e:
            print(f"[!] 파일 쓰기 실패: {e}")

        # 서비스 재시작
        print("[*] sshd 서비스 재시작 중...")
        run_command("Stop-Service sshd")
        run_command("Start-Service sshd")
        print("    -> 서비스 재시작 완료.")

    else:
        print(f"[!] {config_path} 파일을 찾을 수 없습니다.")

    print("\n=== 설정 완료 ===")
    input("엔터 키를 누르면 종료합니다...")

if __name__ == "__main__":
    main()