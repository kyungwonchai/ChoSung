import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ í”„ë¡œì íŠ¸ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸ”¥ [ULTIMATE FIX] v61: DB íŒŒì¼ ë³´ì¡´ ë° ì „ì²´ ê¸°ëŠ¥ ë³µêµ¬...")

# 1. run_bridge.py (ì„œë¹„ìŠ¤ í¬íŠ¸ 9111 ë° ê·¸ë£¹ í‘œì‹œ ë¡œì§)
# í˜•ë‹˜ì˜ database.pyë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.
main_code = r"""from flask import Flask, render_template
from app.routes.api_routes import api_bp
from app.database import get_db_connection

app = Flask(__name__, static_folder='app/static', template_folder='app/templates')
app.secret_key = 'kw_final_v61_fix'

# ë¸”ë£¨í”„ë¦°íŠ¸ ë“±ë¡
app.register_blueprint(api_bp)

@app.route('/')
def index():
    try:
        conn = get_db_connection()
        # í˜•ë‹˜ì˜ database.py ì»¤ì„œ ë°©ì‹ì— ìƒê´€ì—†ì´ ë™ì‘í•˜ë„ë¡ ì¼ë°˜ ì»¤ì„œ ì‚¬ìš© í›„ ë”•ì…”ë„ˆë¦¬ ë³€í™˜
        cursor = conn.cursor()
        cursor.execute("SELECT *, ISNULL(GroupName, 'None') as GroupName FROM cline_FolderIndex ORDER BY GroupName, DisplayName")
        columns = [column[0] for column in cursor.description]
        projects = [dict(zip(columns, row)) for row in cursor.fetchall()]
        
        cursor.execute("SELECT COUNT(*) FROM cline_TaskQueue")
        total = cursor.fetchone()[0]
        conn.close()
        return render_template('index.html', projects=projects, total_calls=total)
    except Exception as e:
        return f"<h1>Server Error (500)</h1><p>{str(e)}</p><br>Check your database.py credentials.", 500

@app.route('/settings')
def settings():
    return render_template('settings.html')

if __name__ == '__main__':
    # í˜•ë‹˜ì˜ ì„œë¹„ìŠ¤ í¬íŠ¸ 9111 ê³ ì •
    app.run(host='0.0.0.0', port=9111, debug=True)
"""
with open(os.path.join(base_dir, "run_bridge.py"), "w", encoding="utf-8") as f: f.write(main_code)

# 2. api_routes.py (IP 10.244.120.24 ì ìš© ë° ëª¨ë“  ê¸°ëŠ¥ ë™ê¸°í™”)
# JSON ì‘ë‹µì„ ë³´ì¥í•˜ì—¬ 'Unexpected token <' ì—ëŸ¬ë¥¼ ì°¨ë‹¨í•©ë‹ˆë‹¤.
api_code = r"""from flask import Blueprint, request, jsonify, abort
from app.database import get_db_connection
import subprocess, os, json, shlex, base64, re

api_bp = Blueprint('api', __name__)

# ğŸ›¡ï¸ [IP WHITELIST] - í˜•ë‹˜ ì•„ì´í”¼
IP_WHITELIST = ["127.0.0.1", "localhost", "10.244.120.24"]

@api_bp.before_app_request
def gate():
    if request.path.startswith('/static'): return
    ip = request.headers.get('X-Forwarded-For', request.remote_addr).split(',')[0].strip()
    if ip not in IP_WHITELIST:
        # ì—ëŸ¬ ì‹œ HTMLì´ ì•„ë‹Œ JSONì„ ë˜ì ¸ì•¼ í”„ë¡ íŠ¸ì—”ë“œê°€ ì•ˆ ê¹¨ì§‘ë‹ˆë‹¤.
        return jsonify({"error": "Unauthorized", "ip": ip}), 403

# --- [STATS] ì¢Œì¸¡ ì¼/ì›”/ì£¼ ì§‘ê³„ (cnt í‚¤ ì†Œë¬¸ì ì¼ì¹˜) ---
@api_bp.route('/api/stats/dashboard', methods=['GET'])
def get_dash():
    try:
        conn = get_db_connection(); cursor = conn.cursor()
        cursor.execute("SELECT ISNULL(GroupName, 'None'), COUNT(*) FROM cline_FolderIndex GROUP BY GroupName")
        groups = [{'GroupName': r[0], 'Cnt': r[1]} for r in cursor.fetchall()]
        
        def gs(days):
            cursor.execute(f"SELECT COUNT(*) FROM cline_TaskQueue WHERE Status='Done' AND CompletedAt >= DATEADD(day, -{days}, GETDATE())")
            r = cursor.fetchone(); return {'cnt': r[0] if r else 0}
            
        res = {
            'groups': groups,
            'counts': { 'day': gs(1), 'week': gs(7), 'month': gs(30) }
        }
        conn.close(); return jsonify(res)
    except Exception as e: return jsonify({"error": str(e)}), 500

# --- [RULES] ìˆ˜ì • ë° ì „ì†¡ ---
@api_bp.route('/api/rules', methods=['GET', 'POST', 'PUT', 'DELETE'])
def handle_rules():
    conn = get_db_connection(); cursor = conn.cursor()
    if request.method == 'GET':
        cursor.execute("SELECT RuleID, RuleName, RuleContent FROM cline_ProjectRules ORDER BY RuleID DESC")
        res = [{'RuleID': r[0], 'RuleName': r[1], 'RuleContent': r[2]} for r in cursor.fetchall()]
        conn.close(); return jsonify(res)
    
    d = request.json
    if request.method == 'POST':
        cursor.execute("INSERT INTO cline_ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", (d['name'], d['content']))
    elif request.method == 'PUT':
        cursor.execute("UPDATE cline_ProjectRules SET RuleName=%s, RuleContent=%s WHERE RuleID=%s", (d['name'], d['content'], d['id']))
    elif request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_ProjectRules WHERE RuleID=%s", (request.args.get('id'),))
    conn.commit(); conn.close(); return jsonify({'status': 'success'})

@api_bp.route('/api/rules/deploy', methods=['POST'])
def deploy():
    d = request.json
    conn = get_db_connection(); cursor = conn.cursor()
    cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (d['rule_id'],))
    r = cursor.fetchone()
    cursor.execute("SELECT IPAddress, Account FROM cline_FolderIndex WHERE FullPath=%s", (d['project_path'],))
    t = cursor.fetchone()
    if not r or not t: return jsonify({'status': 'error', 'message': 'Not Found'})
    
    content = r[1].replace('{SUBJECT}', d['project_name']).replace('{TARGET_PATH}', d['project_path'].replace('\\', '/'))
    r_dir = os.path.join(d['project_path'], ".clinerules").replace('\\', '/')
    r_file = os.path.join(r_dir, "absoluterule.md").replace('\\', '/')
    b64 = base64.b64encode(content.encode('utf-8')).decode('utf-8')
    
    if t[0] in ['127.0.0.1', 'localhost']:
        if not os.path.exists(r_dir): os.makedirs(r_dir, exist_ok=True)
        with open(r_file, 'w', encoding='utf-8') as f: f.write(content)
        ok = True
    else:
        cmd = f"mkdir -p {shlex.quote(r_dir)} && echo '{b64}' | base64 -d > {shlex.quote(r_file)}"
        subprocess.run(['ssh', f"{t[1]}@{t[0]}", cmd]); ok = True
    
    if ok: 
        cursor.execute("UPDATE cline_FolderIndex SET LastRuleName=%s WHERE FullPath=%s", (r[0], d['project_path']))
        conn.commit()
    conn.close(); return jsonify({'status': 'success'})

# --- [SYSTEM] í & VSCode ---
@api_bp.route('/api/queue', methods=['GET'])
def get_queue():
    conn = get_db_connection(); cursor = conn.cursor()
    cursor.execute("SELECT TaskID, ProjectName, TaskContent, Status FROM cline_TaskQueue WHERE Status IN ('Pending', 'Processing')")
    res = [{'TaskID': r[0], 'ProjectName': r[1], 'TaskContent': r[2], 'Status': r[3]} for r in cursor.fetchall()]
    conn.close(); return jsonify(res)

@api_bp.route('/api/open_vscode', methods=['POST'])
def open_v():
    d = request.json
    cmd = ['code', '--new-window']
    if d['ip'] not in ['127.0.0.1', 'localhost']: cmd.extend(['--remote', f"ssh-remote+{d['account']}@{d['ip']}", d['path']])
    else: cmd.append(d['path'])
    subprocess.Popen(cmd, env=os.environ.copy()); return jsonify({'status': 'success'})
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f: f.write(api_code)

print("\nâœ¨ [RECONSTRUCTION COMPLETE] v61: ëª¨ë“  ê¸°ëŠ¥ ë³µêµ¬!")
print("ğŸ‘‰ database.pyëŠ” í˜•ë‹˜ì˜ ì›ë³¸ ê·¸ëŒ€ë¡œ ë³´ì¡´ë˜ì—ˆìŠµë‹ˆë‹¤.")
print("ğŸ‘‰ ì„œë¹„ìŠ¤ í¬íŠ¸: 9111 / ì ‘ì† í—ˆìš© IP: 10.244.120.24")