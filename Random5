import os
import sys

# 1. í”„ë¡œì íŠ¸ í´ë” ìƒì„± (ì†Œë¬¸ì)
project_folder = "diagnosis_tool"
templates_folder = os.path.join(project_folder, "templates")

if not os.path.exists(templates_folder):
    os.makedirs(templates_folder)
    print(f"[INFO] í´ë” ìƒì„± ì™„ë£Œ: {project_folder}, {templates_folder}")

# 2. app.py ìƒì„± (Flask ì„œë²„ ë° ì§„ë‹¨ ë¡œì§)
app_code = r"""
import time
import traceback
import psutil
import pymysql
import pymssql
import socket
import os
from flask import Flask, render_template, Response, stream_with_context

app = Flask(__name__)

# === [ì„¤ì •] DB ì ‘ì† ì •ë³´ (ì—¬ê¸°ì— ì‹¤ì œ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”) ===
MYSQL_CONFIG = {
    'host': 'localhost',
    'user': 'root',
    'password': 'your_password',
    'charset': 'utf8mb4',
    'cursorclass': pymysql.cursors.DictCursor
}

MSSQL_CONFIG = {
    'server': 'localhost',
    'user': 'sa',
    'password': 'your_password',
    'database': 'master'
}

# === ì§„ë‹¨ í•¨ìˆ˜ ëª¨ìŒ (Generator ì‚¬ìš©ìœ¼ë¡œ ì‹¤ì‹œê°„ ë¡œê·¸ ì „ì†¡) ===

def log(msg, level="INFO"):
    timestamp = time.strftime("%H:%M:%S")
    color = "white"
    if level == "OK": color = "#00ff00"
    if level == "ERROR": color = "#ff4444"
    if level == "WARN": color = "orange"
    if level == "HEADER": color = "#00ccff"
    
    return f'<div style="color:{color};">[{timestamp}] {msg}</div>\n'

def check_system_resource():
    yield log("=== ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì ê²€ ì‹œì‘ ===", "HEADER")
    try:
        cpu = psutil.cpu_percent(interval=1)
        mem = psutil.virtual_memory()
        disk = psutil.disk_usage('/')
        
        yield log(f"CPU ì‚¬ìš©ëŸ‰: {cpu}%")
        yield log(f"ë©”ëª¨ë¦¬: {mem.percent}% (ì‚¬ìš©: {mem.used // (1024**2)}MB / ì „ì²´: {mem.total // (1024**2)}MB)")
        yield log(f"ë””ìŠ¤í¬: {disk.percent}% (ì—¬ìœ : {disk.free // (1024**3)}GB)")
        yield log("ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì ê²€ ì™„ë£Œ", "OK")
    except Exception:
        yield log(f"ì‹œìŠ¤í…œ ì ê²€ ì‹¤íŒ¨: {traceback.format_exc()}", "ERROR")

def check_network_basic():
    yield log("=== ë„¤íŠ¸ì›Œí¬ ê¸°ë³¸ ì ê²€ (Google Ping) ===", "HEADER")
    try:
        host = "8.8.8.8"
        port = 53
        timeout = 3
        socket.setdefaulttimeout(timeout)
        socket.socket(socket.AF_INET, socket.SOCK_STREAM).connect((host, port))
        yield log(f"ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì„±ê³µ ({host})", "OK")
    except Exception:
        yield log(f"ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨: {traceback.format_exc()}", "ERROR")

def check_mysql_connect():
    yield log("=== MySQL ë‹¨ìˆœ ì—°ê²° ì ê²€ ===", "HEADER")
    try:
        conn = pymysql.connect(**MYSQL_CONFIG)
        conn.close()
        yield log("MySQL ì—°ê²° ì„±ê³µ", "OK")
    except Exception:
        yield log(f"MySQL ì—°ê²° ì—ëŸ¬ ë°œìƒ:\n{traceback.format_exc()}", "ERROR")

def check_mssql_connect():
    yield log("=== MSSQL ë‹¨ìˆœ ì—°ê²° ì ê²€ ===", "HEADER")
    try:
        conn = pymssql.connect(**MSSQL_CONFIG)
        conn.close()
        yield log("MSSQL ì—°ê²° ì„±ê³µ", "OK")
    except Exception:
        yield log(f"MSSQL ì—°ê²° ì—ëŸ¬ ë°œìƒ:\n{traceback.format_exc()}", "ERROR")

def check_mysql_full():
    yield log("=== MySQL ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ìˆœì°¨ ì •ë°€ ì§„ë‹¨ ===", "HEADER")
    conn = None
    try:
        conn = pymysql.connect(**MYSQL_CONFIG)
        cursor = conn.cursor()
        
        # ì‹œìŠ¤í…œ DB ì œì™¸ ëª©ë¡
        exclude_dbs = ['information_schema', 'mysql', 'performance_schema', 'sys']
        
        cursor.execute("SHOW DATABASES")
        dbs = [row['Database'] for row in cursor.fetchall()]
        
        target_dbs = [db for db in dbs if db not in exclude_dbs]
        yield log(f"ì§„ë‹¨ ëŒ€ìƒ DB ëª©ë¡: {target_dbs}")
        
        for db_name in target_dbs:
            yield log(f"--> [MySQL] '{db_name}' ë°ì´í„°ë² ì´ìŠ¤ ì§„ì… ì¤‘...", "WARN")
            try:
                conn.select_db(db_name)
                cursor.execute("SHOW TABLES")
                tables = cursor.fetchall()
                table_count = len(tables)
                yield log(f"    - '{db_name}' ì ‘ì† ì„±ê³µ. í…Œì´ë¸” ìˆ˜: {table_count}ê°œ", "OK")
                
                # ê°„ë‹¨í•œ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ (ì˜ˆ: ì²« ë²ˆì§¸ í…Œì´ë¸” ì¡°íšŒ ì‹œë„)
                if table_count > 0:
                    first_table = list(tables[0].values())[0]
                    cursor.execute(f"SELECT count(*) as cnt FROM `{first_table}`")
                    row_cnt = cursor.fetchone()['cnt']
                    yield log(f"    - '{first_table}' í…Œì´ë¸” ì¡°íšŒ í…ŒìŠ¤íŠ¸ ì„±ê³µ (í–‰ ìˆ˜: {row_cnt})", "OK")
                    
            except Exception as e:
                yield log(f"    - '{db_name}' ì§„ë‹¨ ì¤‘ ì—ëŸ¬: {str(e)}", "ERROR")
            
            time.sleep(0.5) # ì‹œê°ì  ë¡œê·¸ í™•ì¸ì„ ìœ„í•œ ì•½ê°„ì˜ ì§€ì—°
            
    except Exception:
        yield log(f"MySQL ì „ì²´ ì§„ë‹¨ ì‹¤íŒ¨:\n{traceback.format_exc()}", "ERROR")
    finally:
        if conn: conn.close()

def check_mssql_full():
    yield log("=== MSSQL ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ìˆœì°¨ ì •ë°€ ì§„ë‹¨ ===", "HEADER")
    conn = None
    try:
        conn = pymssql.connect(**MSSQL_CONFIG)
        cursor = conn.cursor(as_dict=True)
        
        # ì‹œìŠ¤í…œ DB ì œì™¸
        exclude_dbs = ['master', 'tempdb', 'model', 'msdb']
        
        cursor.execute("SELECT name FROM sys.databases")
        dbs = [row['name'] for row in cursor.fetchall()]
        
        target_dbs = [db for db in dbs if db not in exclude_dbs]
        yield log(f"ì§„ë‹¨ ëŒ€ìƒ DB ëª©ë¡: {target_dbs}")
        
        for db_name in target_dbs:
            yield log(f"--> [MSSQL] '{db_name}' ë°ì´í„°ë² ì´ìŠ¤ ì§„ì… ì¤‘...", "WARN")
            try:
                # MSSQLì€ USE ëª…ë ¹ì–´ë¡œ ì „í™˜
                cursor.execute(f"USE [{db_name}]")
                cursor.execute("SELECT count(*) as cnt FROM information_schema.tables")
                row = cursor.fetchone()
                yield log(f"    - '{db_name}' ì ‘ì† ì„±ê³µ. í…Œì´ë¸” ìˆ˜: {row['cnt']}ê°œ", "OK")
            except Exception as e:
                yield log(f"    - '{db_name}' ì§„ë‹¨ ì¤‘ ì—ëŸ¬: {str(e)}", "ERROR")
            
            time.sleep(0.5)
            
    except Exception:
        yield log(f"MSSQL ì „ì²´ ì§„ë‹¨ ì‹¤íŒ¨:\n{traceback.format_exc()}", "ERROR")
    finally:
        if conn: conn.close()

def check_env_vars():
    yield log("=== í™˜ê²½ ë³€ìˆ˜ ë° ê²½ë¡œ ì ê²€ ===", "HEADER")
    try:
        cwd = os.getcwd()
        user = os.getenv('USERNAME') or os.getenv('USER')
        yield log(f"í˜„ì¬ ì‘ì—… ê²½ë¡œ: {cwd}")
        yield log(f"ì‹¤í–‰ ìœ ì €: {user}")
        yield log("í™˜ê²½ ë³€ìˆ˜ ì½ê¸° ì„±ê³µ", "OK")
    except Exception:
        yield log(f"í™˜ê²½ ë³€ìˆ˜ ì ê²€ ì‹¤íŒ¨: {traceback.format_exc()}", "ERROR")

def check_file_permissions():
    yield log("=== ë¡œê·¸ í´ë” ì“°ê¸° ê¶Œí•œ ì ê²€ ===", "HEADER")
    try:
        test_file = "test_permission.tmp"
        with open(test_file, "w") as f:
            f.write("test")
        os.remove(test_file)
        yield log("í˜„ì¬ í´ë” ì“°ê¸°/ì‚­ì œ ê¶Œí•œ ì •ìƒ", "OK")
    except Exception:
        yield log(f"íŒŒì¼ ê¶Œí•œ ì—ëŸ¬: {traceback.format_exc()}", "ERROR")

def check_python_libs():
    yield log("=== í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ ì ê²€ ===", "HEADER")
    yield log(f"Flask Version: {Flask.__version__}")
    yield log(f"PyMySQL Version: {pymysql.__version__}")
    yield log(f"Psutil Version: {psutil.__version__}")
    yield log("ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ", "OK")

def check_port_listener():
    yield log("=== 80/443 í¬íŠ¸ ë¦¬ìŠ¤ë‹ ìƒíƒœ (ê°„ì´) ===", "HEADER")
    # ì‹¤ì œ êµ¬í˜„ ì‹œì—ëŠ” netstat subprocess í˜¸ì¶œ ë“±ì´ í•„ìš”í•˜ë‚˜ ì—¬ê¸°ì„  ìƒëµ
    yield log("í¬íŠ¸ ì ê²€ ë¡œì§ì€ OS ê¶Œí•œ ë¬¸ì œë¡œ ìƒëµí•©ë‹ˆë‹¤ (ì½”ë“œ ì°¸ê³ )", "WARN")

# === ë¼ìš°íŒ… ë° ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ===

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/diagnose/<target>')
def diagnose(target):
    def generate():
        yield log(f"=== ì§„ë‹¨ ì‹œì‘: {target} ===", "HEADER")
        time.sleep(0.5)
        
        # ì „ì²´ ì§„ë‹¨
        if target == 'all':
            yield from check_system_resource()
            yield from check_network_basic()
            yield from check_env_vars()
            yield from check_file_permissions()
            yield from check_python_libs()
            yield from check_mysql_full()
            yield from check_mssql_full()
        
        # ê°œë³„ ì§„ë‹¨ ë§¤í•‘
        elif target == 'resource': yield from check_system_resource()
        elif target == 'network': yield from check_network_basic()
        elif target == 'mysql_conn': yield from check_mysql_connect()
        elif target == 'mssql_conn': yield from check_mssql_connect()
        elif target == 'mysql_full': yield from check_mysql_full()
        elif target == 'mssql_full': yield from check_mssql_full()
        elif target == 'env': yield from check_env_vars()
        elif target == 'perm': yield from check_file_permissions()
        elif target == 'libs': yield from check_python_libs()
        else:
            yield log("ì•Œ ìˆ˜ ì—†ëŠ” ì§„ë‹¨ ëª…ë ¹ì…ë‹ˆë‹¤.", "ERROR")
            
        yield log("=== ëª¨ë“  ì§„ë‹¨ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ===", "HEADER")

    return Response(stream_with_context(generate()), mimetype='text/html')

if __name__ == '__main__':
    # ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™” (ì—ëŸ¬ ìƒì„¸ ì¶œë ¥)
    app.run(host='0.0.0.0', port=5000, debug=True)
"""

# 3. index.html ìƒì„± (ì‹¤ì‹œê°„ ë¡œê·¸ ë·°ì–´ UI)
html_code = r"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œìŠ¤í…œ ìƒì„¸ ì§„ë‹¨ ë„êµ¬</title>
    <style>
        body { font-family: 'Consolas', sans-serif; background-color: #1e1e1e; color: #ddd; padding: 20px; }
        h1 { color: #fff; border-bottom: 2px solid #444; padding-bottom: 10px; }
        .control-panel { margin-bottom: 20px; background: #252526; padding: 15px; border-radius: 5px; }
        button {
            background-color: #333; color: white; border: 1px solid #555;
            padding: 8px 15px; margin: 5px; cursor: pointer; transition: 0.2s;
            font-family: inherit;
        }
        button:hover { background-color: #444; border-color: #888; }
        button.btn-danger { background-color: #800; border-color: #a00; font-weight: bold; }
        button.btn-danger:hover { background-color: #a00; }
        
        #log-container {
            background-color: #000; color: #0f0;
            border: 1px solid #444; padding: 15px;
            height: 600px; overflow-y: auto;
            white-space: pre-wrap; line-height: 1.4;
            font-size: 14px; box-shadow: inset 0 0 10px #000;
        }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ í†µí•© ì‹œìŠ¤í…œ ì •ë°€ ì§„ë‹¨ê¸° (Debug Mode)</h1>
    
    <div class="control-panel">
        <h3>ğŸš€ ì „ì²´ ì§„ë‹¨</h3>
        <button class="btn-danger" onclick="startDiagnosis('all')">ì „ì²´ ì‹œìŠ¤í…œ ë° DB í’€ìŠ¤ìº” ì‹œì‘</button>
        
        <h3>ğŸ” ê°œë³„ ì •ë°€ ì§„ë‹¨ (10ì¢…)</h3>
        <button onclick="startDiagnosis('resource')">1. ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤(CPU/RAM/Disk)</button>
        <button onclick="startDiagnosis('network')">2. ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬(Ping)</button>
        <button onclick="startDiagnosis('env')">3. í™˜ê²½ë³€ìˆ˜ ì ê²€</button>
        <button onclick="startDiagnosis('perm')">4. íŒŒì¼ ì“°ê¸° ê¶Œí•œ</button>
        <button onclick="startDiagnosis('libs')">5. íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬</button>
        <br>
        <button onclick="startDiagnosis('mysql_conn')">6. MySQL ë‹¨ìˆœ ì—°ê²°</button>
        <button onclick="startDiagnosis('mssql_conn')">7. MSSQL ë‹¨ìˆœ ì—°ê²°</button>
        <button onclick="startDiagnosis('mysql_full')">8. MySQL DB ìˆœì°¨ ì •ë°€ì§„ë‹¨</button>
        <button onclick="startDiagnosis('mssql_full')">9. MSSQL DB ìˆœì°¨ ì •ë°€ì§„ë‹¨</button>
    </div>

    <h3>ğŸ–¥ï¸ ì‹¤ì‹œê°„ ì§„ë‹¨ ë¡œê·¸ (Real-time Output)</h3>
    <div id="log-container">ëŒ€ê¸° ì¤‘... ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§„ë‹¨ì„ ì‹œì‘í•˜ì„¸ìš”.</div>

    <script>
        async function startDiagnosis(target) {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = `<div style='color:yellow'>[SYSTEM] '${target}' ì§„ë‹¨ ìš”ì²­ ì‹œì‘... ì—°ê²° ì¤‘...</div>`;
            
            try {
                const response = await fetch(`/diagnose/${target}`);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    // HTML íƒœê·¸ê°€ í¬í•¨ëœ í…ìŠ¤íŠ¸ë¥¼ ëˆ„ì í•´ì„œ ë³´ì—¬ì¤Œ
                    logContainer.innerHTML += chunk;
                    
                    // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
                logContainer.innerHTML += "<div style='color:cyan'>[SYSTEM] ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì¢…ë£Œ.</div><br>";
            } catch (error) {
                logContainer.innerHTML += `<div style='color:red'>[FATAL ERROR] ìë°”ìŠ¤í¬ë¦½íŠ¸ í†µì‹  ì˜¤ë¥˜: ${error}</div>`;
            }
        }
    </script>
</body>
</html>
"""

# íŒŒì¼ ì“°ê¸°
with open(os.path.join(project_folder, "app.py"), "w", encoding="utf-8") as f:
    f.write(app_code)
    print(f"[INFO] ìƒì„± ì™„ë£Œ: {os.path.join(project_folder, 'app.py')}")

with open(os.path.join(templates_folder, "index.html"), "w", encoding="utf-8") as f:
    f.write(html_code)
    print(f"[INFO] ìƒì„± ì™„ë£Œ: {os.path.join(templates_folder, 'index.html')}")

# ë§ˆë¬´ë¦¬ ì•ˆë‚´ ë©”ì‹œì§€
print("\n" + "="*50)
print("âœ… ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
print("1. ì•„ë˜ ëª…ë ¹ì–´ë¡œ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”:")
print("   pip install flask pymysql pymssql psutil")
print("\n2. app.pyë¥¼ ì—´ì–´ DB ì ‘ì† ì •ë³´(MYSQL_CONFIG, MSSQL_CONFIG)ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.")
print("\n3. ì•± ì‹¤í–‰:")
print(f"   cd {project_folder}")
print("   python app.py")
print("="*50)