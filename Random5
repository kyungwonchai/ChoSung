import os
import sys

PROJECT_ROOT = "DB_Sherlock_Pro"

file_contents = {}

# ==========================================
# 1. [Core] ë°ì´í„° ëª¨ë¸ ì •ì˜
# ==========================================
file_contents["app/core/interfaces.py"] = """
from abc import ABC, abstractmethod
from dataclasses import dataclass, field
from typing import List, Dict, Any

@dataclass
class QueryStat:
    text: str          # ì¿¼ë¦¬ ë‚´ìš©
    avg_time: str      # í‰ê·  ì†Œìš” ì‹œê°„ (ì´ˆ)
    exec_count: int    # ì‹¤í–‰ íšŸìˆ˜
    last_exec: str     # ë§ˆì§€ë§‰ ì‹¤í–‰ ì‹œê°„

@dataclass
class DiagnosticResult:
    status: str
    score: int
    summary: str
    details: List[str] = field(default_factory=list)
    worst_queries: List[QueryStat] = field(default_factory=list) # ì›ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ë¦¬ìŠ¤íŠ¸
    recommendations: List[str] = field(default_factory=list)

class IDiagnosticStrategy(ABC):
    @abstractmethod
    def diagnose(self, config: Dict[str, Any]) -> DiagnosticResult:
        pass
"""

file_contents["app/core/__init__.py"] = ""

# ==========================================
# 2. [Infra] MSSQL ì •ë°€ íƒ€ê²© ì „ëµ (ë²”ì¸ ìƒ‰ì¶œ)
# ==========================================
file_contents["app/infra/mssql_strategy.py"] = """
import pymssql
from app.core.interfaces import IDiagnosticStrategy, DiagnosticResult, QueryStat

class MSSQLStrategy(IDiagnosticStrategy):
    def diagnose(self, config: dict) -> DiagnosticResult:
        result = DiagnosticResult("Healthy", 100, "ì•ˆì •ì ")
        conn = None
        try:
            conn = pymssql.connect(
                server=config['host'], port=str(config['port']),
                user=config['user'], password=config['password'],
                database=config['db_name'], timeout=10
            )
            cursor = conn.cursor(as_dict=True)

            # ---------------------------------------------------------
            # [í•µì‹¬] ì›ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ì¶”ì¶œ (CPU & ì†Œìš”ì‹œê°„ ê¸°ì¤€ ì •ë ¬)
            # ---------------------------------------------------------
            cursor.execute(\"\"\"
                SELECT TOP 5
                    SUBSTRING(st.text, (qs.statement_start_offset/2) + 1,
                    ((CASE statement_end_offset WHEN -1 THEN DATALENGTH(st.text) ELSE qs.statement_end_offset END
                            - qs.statement_start_offset)/2) + 1) AS query_text,
                    (qs.total_elapsed_time / qs.execution_count / 1000000.0) AS avg_seconds,
                    qs.execution_count,
                    qs.last_execution_time
                FROM sys.dm_exec_query_stats AS qs
                CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS st
                WHERE qs.last_execution_time > DATEADD(day, -1, GETDATE()) -- ìµœê·¼ 1ì¼ ë‚´ ì‹¤í–‰ëœ ê²ƒë§Œ
                ORDER BY qs.total_worker_time DESC -- [ì •ë ¬ ê¸°ì¤€] CPU ì‚¬ìš©ëŸ‰ ë†’ì€ ìˆœ (ê°€ì¥ ë¬´ê±°ìš´ ë†ˆ)
            \"\"\")
            
            rows = cursor.fetchall()
            if rows:
                for row in rows:
                    q_text = row['query_text'][:200] + "..." if len(row['query_text']) > 200 else row['query_text']
                    result.worst_queries.append(QueryStat(
                        text=q_text,
                        avg_time=f"{row['avg_seconds']:.4f}s",
                        exec_count=row['execution_count'],
                        last_exec=str(row['last_execution_time'])
                    ))
                
                # ì ìˆ˜ ê¹ê¸° (ê°€ì¥ ëŠë¦° ì¿¼ë¦¬ê°€ 3ì´ˆ ì´ìƒì´ë©´ ê°ì )
                if rows[0]['avg_seconds'] > 3.0:
                    result.score -= 20
                    result.details.append("3ì´ˆ ì´ìƒ ì†Œìš”ë˜ëŠ” ì¿¼ë¦¬ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.")
                    result.status = "Warning"

            # ---------------------------------------------------------
            # [ë³´ì¡°] ëŒ€ê¸° ìœ í˜• ë¶„ì„ (ë½ ê±¸ë¦¬ëŠ”ì§€ í™•ì¸)
            # ---------------------------------------------------------
            cursor.execute(\"\"\"
                SELECT TOP 3 wait_type, wait_time_ms / 1000.0 AS wait_sec
                FROM sys.dm_os_wait_stats
                WHERE wait_type NOT IN ('SLEEP_TASK', 'BROKER_EVENT_HANDLER', 'DIRTY_PAGE_POLL')
                ORDER BY wait_time_ms DESC
            \"\"\")
            waits = cursor.fetchall()
            if waits and waits[0]['wait_sec'] > 60:
                result.recommendations.append(f"ì£¼ìš” ëŒ€ê¸°: {waits[0]['wait_type']} (ë³‘ëª© ì˜ì‹¬)")
                result.score -= 10

        except Exception as e:
            return DiagnosticResult("Error", 0, f"ì ‘ì† ë¶ˆê°€: {str(e)}")
        finally:
            if conn: conn.close()
            
        return result
"""

# ==========================================
# 3. [Infra] MySQL ì •ë°€ íƒ€ê²© ì „ëµ (sys ìŠ¤í‚¤ë§ˆ í™œìš©)
# ==========================================
file_contents["app/infra/mysql_strategy.py"] = """
import pymysql
from app.core.interfaces import IDiagnosticStrategy, DiagnosticResult, QueryStat

class MySQLStrategy(IDiagnosticStrategy):
    def diagnose(self, config: dict) -> DiagnosticResult:
        result = DiagnosticResult("Healthy", 100, "ì•ˆì •ì ")
        conn = None
        try:
            conn = pymysql.connect(
                host=config['host'], port=config['port'],
                user=config['user'], password=config['password'],
                database=config['db_name'], connect_timeout=10,
                cursorclass=pymysql.cursors.DictCursor
            )
            with conn.cursor() as cursor:
                # ---------------------------------------------------------
                # [í•µì‹¬] ì›ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ì¶”ì¶œ (sys.statement_analysis í™œìš©)
                # ---------------------------------------------------------
                try:
                    cursor.execute(\"\"\"
                        SELECT query, exec_count, 
                               format_pico_time(avg_latency) as avg_time_str, 
                               (avg_latency / 1000000000000.0) as avg_seconds,
                               last_seen
                        FROM sys.statement_analysis 
                        ORDER BY avg_latency DESC 
                        LIMIT 5
                    \"\"\")
                    rows = cursor.fetchall()
                    for row in rows:
                        q_text = row['query'][:200] + "..." if len(row['query']) > 200 else row['query']
                        result.worst_queries.append(QueryStat(
                            text=q_text,
                            avg_time=f"{row['avg_seconds']:.4f}s",
                            exec_count=row['exec_count'],
                            last_exec=str(row['last_seen'])
                        ))
                        
                    if rows and rows[0]['avg_seconds'] > 3.0:
                        result.score -= 20
                        result.details.append("í‰ê·  3ì´ˆ ì´ìƒ ì†Œìš”ë˜ëŠ” ëŠë¦° ì¿¼ë¦¬ ì¡´ì¬")
                        result.status = "Warning"

                except Exception:
                    # sys ìŠ¤í‚¤ë§ˆê°€ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° fallback
                    result.details.append("sys ìŠ¤í‚¤ë§ˆ ê¶Œí•œ ì—†ìŒ (ì¿¼ë¦¬ ë¶„ì„ ì œí•œë¨)")

                # ---------------------------------------------------------
                # [ë³´ì¡°] ì „ì²´ ìŠ¤ìº” ë¹„ìœ¨ í™•ì¸
                # ---------------------------------------------------------
                cursor.execute("SHOW GLOBAL STATUS LIKE 'Select_full_join'")
                val = cursor.fetchone()
                if val and int(val['Value']) > 100:
                    result.recommendations.append("ì¸ë±ìŠ¤ ì—†ì´ ì¡°ì¸í•˜ëŠ” ì¿¼ë¦¬ê°€ ë§ìŠµë‹ˆë‹¤ (Full Join)")
                    result.score -= 10

        except Exception as e:
            return DiagnosticResult("Error", 0, f"MySQL ì˜¤ë¥˜: {str(e)}")
        finally:
            if conn: conn.close()
        return result
"""

file_contents["app/infra/__init__.py"] = ""

# ==========================================
# 4. [Service] í ì—”ì§„
# ==========================================
file_contents["app/services/engine.py"] = """
import threading, queue, time
from app.infra.mssql_strategy import MSSQLStrategy
from app.infra.mysql_strategy import MySQLStrategy

class DiagnosticEngine:
    def __init__(self):
        self.q = queue.Queue()
        self.results = {}
        threading.Thread(target=self._worker, daemon=True).start()

    def submit(self, db_id, config):
        self.results[db_id] = {"status": "Pending", "summary": "ëŒ€ê¸° ì¤‘..."}
        self.q.put((db_id, config))

    def get_results(self):
        return self.results

    def _worker(self):
        while True:
            db_id, config = self.q.get()
            self.results[db_id] = {"status": "Running", "summary": "ë¶„ì„ ì¤‘..."}
            
            try:
                strategy = MSSQLStrategy() if "MSSQL" in config['type'] else MySQLStrategy()
                res = strategy.diagnose(config)
                self.results[db_id] = res.__dict__ # Dataclass to dict
                # dataclass ë‚´ë¶€ list of dataclassë¥¼ dictë¡œ ë³€í™˜
                self.results[db_id]['worst_queries'] = [q.__dict__ for q in res.worst_queries]
            except Exception as e:
                self.results[db_id] = {"status": "Error", "summary": str(e), "worst_queries": []}
            
            self.q.task_done()
"""

file_contents["app/services/__init__.py"] = ""

# ==========================================
# 5. [Web] Flask & UI (ì›ŒìŠ¤íŠ¸ ì¿¼ë¦¬ í…Œì´ë¸” í‘œì‹œ)
# ==========================================
file_contents["app/web/app.py"] = """
from flask import Flask, render_template, request, jsonify
from app.services.engine import DiagnosticEngine

app = Flask(__name__, template_folder='templates')
engine = DiagnosticEngine()

# [ì„¤ì •] 50ê°œ DB ë¦¬ìŠ¤íŠ¸ ì˜ˆì‹œ
INVENTORY = {
    "DB_1": {"name": "MES_Main", "type": "MSSQL2014", "host": "127.0.0.1", "port": 1433, "user": "sa", "password": "pw", "db_name": "TestDB"},
    "DB_2": {"name": "ERP_Sub", "type": "MSSQL2016", "host": "127.0.0.1", "port": 1433, "user": "sa", "password": "pw", "db_name": "TestDB2"},
    "DB_3": {"name": "Web_Log", "type": "MySQL5.7", "host": "127.0.0.1", "port": 3306, "user": "root", "password": "pw", "db_name": "LogDB"}
}

@app.route('/')
def index(): return render_template('dashboard.html', inventory=INVENTORY)

@app.route('/diagnose', methods=['POST'])
def diagnose():
    db_id = request.json['db_id']
    if db_id in INVENTORY:
        engine.submit(db_id, INVENTORY[db_id])
        return jsonify("ok")
    return jsonify("error"), 404

@app.route('/status')
def status(): return jsonify(engine.get_results())

def run(): app.run(host='0.0.0.0', port=9999)
"""

file_contents["app/web/templates/dashboard.html"] = """
<!DOCTYPE html>
<html>
<head>
    <title>DB Sherlock Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .query-text { font-family: monospace; font-size: 0.85em; color: #d63384; background: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
        .card { transition: all 0.3s; }
        .status-Healthy { border-top: 4px solid #198754; }
        .status-Warning { border-top: 4px solid #ffc107; }
        .status-Error { border-top: 4px solid #dc3545; }
    </style>
</head>
<body class="bg-light p-4">
    <h2 class="mb-4">ğŸ•µï¸â€â™‚ï¸ DB ë²”ì¸ ì¿¼ë¦¬ ì¶”ì  ì‹œìŠ¤í…œ <small class="text-muted">(Port: 9999)</small></h2>
    
    <div class="row">
        {% for id, db in inventory.items() %}
        <div class="col-12 mb-4">
            <div class="card shadow-sm" id="card-{{id}}">
                <div class="card-header d-flex justify-content-between align-items-center bg-white">
                    <h5 class="m-0">{{ db.name }} <span class="badge bg-secondary ms-2">{{ db.type }}</span></h5>
                    <button onclick="check('{{id}}')" class="btn btn-dark btn-sm">ë²”ì¸ ìƒ‰ì¶œ ì‹œì‘</button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 border-end text-center">
                            <h2 id="score-{{id}}" class="display-6 fw-bold text-muted">-</h2>
                            <span id="status-{{id}}" class="badge bg-light text-dark border">ëŒ€ê¸° ì¤‘</span>
                        </div>
                        <div class="col-md-9">
                            <ul id="issues-{{id}}" class="list-unstyled text-danger mb-3"></ul>
                            
                            <h6 class="fw-bold border-bottom pb-2">ğŸš¨ ì›ŒìŠ¤íŠ¸ ì¿¼ë¦¬ TOP 5 (ì†Œìš”ì‹œê°„ ìˆœ)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" style="font-size: 0.9rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 60%;">ì¿¼ë¦¬ ë‚´ìš© (Query Text)</th>
                                            <th style="width: 15%;">í‰ê·  ì‹œê°„</th>
                                            <th style="width: 10%;">íšŸìˆ˜</th>
                                            <th style="width: 15%;">ë§ˆì§€ë§‰ ì‹¤í–‰</th>
                                        </tr>
                                    </thead>
                                    <tbody id="worst-{{id}}">
                                        <tr><td colspan="4" class="text-center text-muted">ì§„ë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        function check(id) {
            document.getElementById(`status-${id}`).innerText = "ì¶”ì  ì¤‘...";
            fetch('/diagnose', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({db_id: id})
            });
        }

        setInterval(async () => {
            const res = await fetch('/status');
            const data = await res.json();
            
            for(const [id, res] of Object.entries(data)) {
                // ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
                const card = document.getElementById(`card-${id}`);
                card.className = `card shadow-sm status-${res.status || 'Pending'}`;
                
                document.getElementById(`score-${id}`).innerText = res.score ? res.score + "ì " : "-";
                document.getElementById(`status-${id}`).innerText = res.status || "ëŒ€ê¸°";
                
                // ì´ìŠˆ ë¦¬ìŠ¤íŠ¸
                const issues = (res.details || []).concat(res.recommendations || []);
                document.getElementById(`issues-${id}`).innerHTML = issues.map(i => `<li>âš ï¸ ${i}</li>`).join('');

                // ì›ŒìŠ¤íŠ¸ ì¿¼ë¦¬ í…Œì´ë¸”
                const tbody = document.getElementById(`worst-${id}`);
                if (res.worst_queries && res.worst_queries.length > 0) {
                    tbody.innerHTML = res.worst_queries.map(q => `
                        <tr>
                            <td><div class="query-text text-break">${q.text}</div></td>
                            <td class="fw-bold text-danger">${q.avg_time}</td>
                            <td>${q.exec_count}</td>
                            <td>${q.last_exec}</td>
                        </tr>
                    `).join('');
                } else if (res.status === 'Healthy') {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success">ğŸ‰ ë°œê²¬ëœ ì•…ì„± ì¿¼ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
            }
        }, 1500);
    </script>
</body>
</html>
"""

file_contents["run_sherlock.py"] = """
import sys, os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from app.web.app import run

if __name__ == "__main__":
    try:
        import pymssql, pymysql, flask
        print(">>> DB Sherlock Pro ê°€ë™ ì‹œì‘ (Port: 9999)")
        run()
    except ImportError as e:
        print(f"í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ëˆ„ë½: {e.name}")
        print("pip install pymssql pymysql flask")
"""

def create_project():
    if not os.path.exists(PROJECT_ROOT): os.makedirs(PROJECT_ROOT)
    for path, content in file_contents.items():
        full_path = os.path.join(PROJECT_ROOT, path)
        os.makedirs(os.path.dirname(full_path), exist_ok=True)
        with open(full_path, "w", encoding="utf-8") as f: f.write(content.strip())
    print(f"âœ… ì„¤ì¹˜ ì™„ë£Œ! 'cd {PROJECT_ROOT}' í›„ 'python run_sherlock.py' ì‹¤í–‰í•˜ì„¸ìš”.")

if __name__ == "__main__":
    create_project()