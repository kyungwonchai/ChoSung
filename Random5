import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ í”„ë¡œì íŠ¸ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.")
    exit()

print("ğŸ”¥ [FINAL RESTORE] v50: Settings 404 & API Path Alignment...")

# 1. run_bridge.py (ë©”ì¸ ì„œë²„: /settings ê²½ë¡œ í™•ì‹¤íˆ ì¶”ê°€)
main_code = r"""from flask import Flask, render_template
from app.routes.api_routes import api_bp
from app.database import get_db_connection

app = Flask(__name__, static_folder='app/static', template_folder='app/templates')
app.secret_key = 'kw_unreal_v50_final'

# ë¸”ë£¨í”„ë¦°íŠ¸ ë“±ë¡ (prefix ì—†ì´ ë“±ë¡í•˜ì—¬ api_routes ë‚´ì˜ /api/ ê²½ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
app.register_blueprint(api_bp)

@app.route('/')
def index():
    try:
        conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
        cursor.execute("SELECT * FROM cline_FolderIndex ORDER BY GroupName, DisplayName")
        projects = cursor.fetchall()
        cursor.execute("SELECT COUNT(*) as cnt FROM cline_TaskQueue")
        total = cursor.fetchone()['cnt']
        conn.close()
        return render_template('index.html', projects=projects, total_calls=total)
    except Exception as e:
        return f"Database Error: {e}", 500

# [FIX] í˜•ë‹˜ì´ ì°¾ìœ¼ì‹œë˜ ì…‹íŒ… í˜ì´ì§€ 404 í•´ê²°
@app.route('/settings')
def settings_page():
    return render_template('settings.html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
"""
with open(os.path.join(base_dir, "run_bridge.py"), "w", encoding="utf-8") as f: f.write(main_code)

# 2. api_routes.py (ëª¨ë“  APIë¥¼ /api/ ê²½ë¡œë¡œ í†µì¼)
api_code = r"""from flask import Blueprint, request, jsonify, abort
from app.database import get_db_connection
import subprocess, os, json, shlex, urllib.request, ssl, re, base64

api_bp = Blueprint('api', __name__)

# ğŸ›¡ï¸ [IP WHITELIST] - ì—¬ê¸°ì— í˜•ë‹˜ ì•„ì´í”¼ ë„£ìœ¼ì„¸ìš”
IP_WHITELIST = ["127.0.0.1", "localhost", "192.168.0.10"]

def get_visitor_ip():
    xf = request.headers.get('X-Forwarded-For')
    return xf.split(',')[0].strip() if xf else request.remote_addr

@api_bp.before_app_request
def gate():
    if request.path.startswith('/static'): return
    v_ip = get_visitor_ip()
    if v_ip not in IP_WHITELIST:
        # JSONìœ¼ë¡œ ì—ëŸ¬ë¥¼ ì¤˜ì•¼ ì›¹ì—ì„œ 'Unexpected token'ì´ ì•ˆ ëœ¹ë‹ˆë‹¤.
        return jsonify({"error": "Unauthorized", "your_ip": v_ip}), 403

# --- [DASHBOARD API] ---
@api_bp.route('/api/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    groups = cursor.fetchall()
    def gs(sql):
        cursor.execute(sql); r = cursor.fetchone()
        return {'cnt': r['Cnt'], 'dur': r['Dur']} if r else {'cnt': 0, 'dur': 0}
    d = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -1, GETDATE()) AND Status='Done'")
    w = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -7, GETDATE()) AND Status='Done'")
    m = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(month, -1, GETDATE()) AND Status='Done'")
    conn.close(); return jsonify({'groups': groups, 'active': [], 'counts': {'day': d, 'week': w, 'month': m}})

# --- [RULE DEPLOY API] ---
@api_bp.route('/api/rules/deploy', methods=['POST'])
def deploy_rule():
    d = request.json
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (d['rule_id'],))
    r = cursor.fetchone()
    cursor.execute("SELECT IPAddress, Account FROM cline_FolderIndex WHERE FullPath=%s", (d['project_path'],))
    t = cursor.fetchone()
    
    if not r or not t: return jsonify({'status': 'error', 'message': 'Not Found'})
    
    content = r['RuleContent'].replace('{SUBJECT}', d['project_name']).replace('{TARGET_PATH}', d['project_path'].replace('\\', '/'))
    r_dir = os.path.join(d['project_path'], ".clinerules").replace('\\', '/')
    r_file = os.path.join(r_dir, "absoluterule.md").replace('\\', '/')
    b64 = base64.b64encode(content.encode('utf-8')).decode('utf-8')
    
    if t['IPAddress'] in ['127.0.0.1', 'localhost']:
        if not os.path.exists(r_dir): os.makedirs(r_dir, exist_ok=True)
        with open(r_file, 'w', encoding='utf-8') as f: f.write(content)
        ok = True
    else:
        cmd = f"mkdir -p {shlex.quote(r_dir)} && echo '{b64}' | base64 -d > {shlex.quote(r_file)}"
        subprocess.run(['ssh', f"{t['Account']}@{t['IPAddress']}", cmd])
        ok = True
    
    if ok: cursor.execute("UPDATE cline_FolderIndex SET LastRuleName=%s WHERE FullPath=%s", (r['RuleName'], d['project_path'])); conn.commit()
    conn.close(); return jsonify({'status': 'success'})

# --- [ê¸°íƒ€ API: ë³µêµ¬] ---
@api_bp.route('/api/queue', methods=['GET', 'POST', 'DELETE'])
def handle_queue():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT TaskID, ProjectName, TaskContent, Status FROM cline_TaskQueue WHERE Status IN ('Pending', 'Processing')")
        r = cursor.fetchall(); conn.close(); return jsonify(r)
    return jsonify([])

@api_bp.route('/api/bookmarks', methods=['GET'])
def get_bm():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True); cursor.execute("SELECT * FROM cline_WebBookmarks"); r = cursor.fetchall(); conn.close(); return jsonify(r)
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f: f.write(api_code)

# 3. settings.html (ì—†ìœ¼ë©´ 404 ë‚˜ë¯€ë¡œ ìƒì„±)
settings_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head><meta charset="UTF-8"><title>Settings</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></head>
<body class="bg-dark text-white p-5">
    <h2>âš™ï¸ Bridge Settings</h2>
    <hr>
    <div class="card bg-secondary p-3 mb-3">IP Whitelist ë° ê¸°ë³¸ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
    <a href="/" class="btn btn-primary">Back to Dashboard</a>
</body>
</html>
"""
os.makedirs(os.path.join(base_dir, "app", "templates"), exist_ok=True)
with open(os.path.join(base_dir, "app", "templates", "settings.html"), "w", encoding="utf-8") as f: f.write(settings_html)

print("\nâœ¨ [SUCCESS] v50 Restoration Complete!")
print("ğŸ‘‰ ì´ì œ 'python3 run_bridge.py' ì‹¤í–‰í•˜ì„¸ìš”. ì…‹íŒ…ì°½(404) í•´ê²°ëìŠµë‹ˆë‹¤.")