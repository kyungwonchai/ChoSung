import os
import sys

def patch_noproxy():
    print("--- Dify NO_PROXY(예외 목록) 누락 긴급 수정 ---")
    
    file_path = "docker-compose.override.yaml"
    
    if not os.path.exists(file_path):
        print(f"오류: {file_path} 파일이 없습니다. 앞선 단계가 진행되지 않은 것 같습니다.")
        return

    # 최신 Dify 버전에 필요한 모든 내부 서비스 명칭 (plugin_daemon 포함)
    # 이걸로 갈아끼웁니다.
    new_no_proxy_value = "localhost,127.0.0.1,host.docker.internal,api,worker,web,db,redis,sandbox,ssrf_proxy,plugin_daemon,dify-api,dify-worker,dify-web,dify-db,dify-redis,dify-sandbox,dify-ssrf-proxy,dify-plugin-daemon,weaviate,qdrant,milvus,myscale,pgvector,elasticsearch"

    with open(file_path, "r", encoding="utf-8") as f:
        lines = f.readlines()

    new_lines = []
    fixed_count = 0

    for line in lines:
        # NO_PROXY가 있는 줄을 찾아서 값만 교체
        if "NO_PROXY" in line:
            # 들여쓰기(앞부분 공백) 유지
            indent = line.split("- NO_PROXY")[0] if "- NO_PROXY" in line else line.split("NO_PROXY")[0]
            
            # 리스트 문법(- NO_PROXY=...)인지 딕셔너리 문법(NO_PROXY: ...)인지 확인
            if "-" in line and "=" in line:
                 # 리스트 방식 (- NO_PROXY=값)
                new_line = f"{indent}- NO_PROXY={new_no_proxy_value}\n"
            else:
                # 딕셔너리 방식 (NO_PROXY: "값")
                new_line = f'{indent}NO_PROXY: "{new_no_proxy_value}"\n'
            
            new_lines.append(new_line)
            fixed_count += 1
        else:
            new_lines.append(line)

    if fixed_count > 0:
        with open(file_path, "w", encoding="utf-8") as f:
            f.writelines(new_lines)
        print(f"[성공] NO_PROXY 목록에 'plugin_daemon' 등을 추가하여 업데이트했습니다.")
        print("-" * 40)
        print("이제 다시 재시작하세요:")
        print("docker compose down")
        print("docker compose up -d")
        print("-" * 40)
    else:
        print("[실패] 파일에서 NO_PROXY 설정을 찾지 못했습니다.")

if __name__ == "__main__":
    patch_noproxy()