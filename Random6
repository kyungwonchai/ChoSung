import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ ì˜¤ë¥˜: 'runcline' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸš€ AI Bridge v8: UI/UX Ultimate Update...")

# ==========================================
# 1. Settings HTML (app/templates/settings.html)
#    - ë£° í¸ì§‘ ë²„ê·¸ ìˆ˜ì • (ë°ì´í„° ì „ë‹¬ ë°©ì‹ ë³€ê²½)
# ==========================================
print("1ï¸âƒ£ Settings HTML ì—…ë°ì´íŠ¸ (ë£° í¸ì§‘ ë²„ê·¸ ìˆ˜ì •)...")
settings_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #121212; color: #e0e0e0; }
        .card { border: 1px solid #333; }
        .list-group-item { border-color: #333; }
        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ ê°•í™” */
        .form-control { background-color: #1e1e1e; border: 1px solid #444; color: #fff; }
        .form-control:focus { background-color: #252526; border-color: #0dcaf0; color: #fff; box-shadow: 0 0 10px rgba(13, 202, 240, 0.2); }
    </style>
</head>
<body class="bg-dark text-white p-4">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold"><i class="bi bi-gear-wide-connected text-info"></i> Rule Management</h2>
            <a href="/" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
        </div>
        
        <div class="row">
            <div class="col-md-5">
                <div class="card bg-dark shadow-lg">
                    <div class="card-header border-secondary fw-bold text-info" id="formTitle">Create New Rule</div>
                    <div class="card-body">
                        <input type="hidden" id="editRuleId">
                        <div class="mb-3">
                            <label class="form-label text-secondary small">Rule Name</label>
                            <input type="text" id="ruleName" class="form-control" placeholder="e.g. Flask Agent Protocol">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary small">Content (Markdown/Text)</label>
                            <textarea id="ruleContent" class="form-control font-monospace" rows="15" placeholder="# Write your rule here..."></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success flex-grow-1" onclick="saveRule()"><i class="bi bi-save"></i> Save Rule</button>
                            <button class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-7">
                <div class="card bg-dark shadow-lg">
                    <div class="card-header border-secondary fw-bold">Existing Rules</div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="ruleList">
                            </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rulesData = []; // ì „ì—­ ë³€ìˆ˜ë¡œ ë£° ë°ì´í„° ì €ì¥ (ë”°ì˜´í‘œ ê¹¨ì§ ë°©ì§€)

        document.addEventListener('DOMContentLoaded', loadRules);

        function loadRules() {
            fetch('/api/rules')
            .then(r => r.json())
            .then(data => {
                rulesData = data; // ë°ì´í„° ì €ì¥
                const list = document.getElementById('ruleList');
                list.innerHTML = '';
                data.forEach((rule, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item bg-dark text-white d-flex justify-content-between align-items-center p-3';
                    li.innerHTML = `
                        <div style="overflow:hidden;">
                            <div class="fw-bold text-light">${rule.RuleName}</div>
                            <div class="small text-secondary text-truncate" style="max-width: 400px;">${rule.RuleContent.substring(0, 50)}...</div>
                        </div>
                        <div style="min-width: 100px; text-align: right;">
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="loadRuleIntoForm(${index})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRule(${rule.RuleID})"><i class="bi bi-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(li);
                });
            });
        }

        function loadRuleIntoForm(index) {
            const rule = rulesData[index];
            document.getElementById('formTitle').innerText = 'Edit Rule: ' + rule.RuleName;
            document.getElementById('editRuleId').value = rule.RuleID;
            document.getElementById('ruleName').value = rule.RuleName;
            document.getElementById('ruleContent').value = rule.RuleContent;
        }

        function saveRule() {
            const id = document.getElementById('editRuleId').value;
            const name = document.getElementById('ruleName').value;
            const content = document.getElementById('ruleContent').value;
            
            if(!name || !content) return alert('Input required');

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/rules/${id}` : '/api/rules';

            fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, content})
            }).then(() => {
                resetForm();
                loadRules();
            });
        }

        function deleteRule(id) {
            if(!confirm('Delete this rule?')) return;
            fetch(`/api/rules/${id}`, { method: 'DELETE' })
            .then(() => loadRules());
        }

        function resetForm() {
            document.getElementById('formTitle').innerText = 'Create New Rule';
            document.getElementById('editRuleId').value = '';
            document.getElementById('ruleName').value = '';
            document.getElementById('ruleContent').value = '';
        }
    </script>
</body>
</html>
"""
with open(os.path.join(base_dir, "app", "templates", "settings.html"), "w", encoding="utf-8") as f:
    f.write(settings_html)


# ==========================================
# 2. Index HTML (app/templates/index.html)
#    - ì œëª© "AI"ë¡œ ë³€ê²½
#    - ê²€ìƒ‰ì°½ "ì„¸ìƒ ì œì¼ ê°„ì§€" ìŠ¤íƒ€ì¼ ì ìš©
#    - íˆìŠ¤í† ë¦¬ Markdown ë Œë”ë§ (marked.js)
#    - ëª¨ë‹¬ í™•ì¥ (modal-xl -> 95% width)
# ==========================================
print("2ï¸âƒ£ Index HTML ì—…ë°ì´íŠ¸ (ê°„ì§€ ê²€ìƒ‰ì°½ & Markdown íˆìŠ¤í† ë¦¬)...")
index_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #0d0d0d; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-dark { --bs-table-bg: #161616; }
        .table-hover tbody tr:hover { background-color: #2a2a2a; transition: 0.2s; }
        
        /* ìƒíƒœ í‘œì‹œ ë°°ê²½ */
        .bg-active-job { background: linear-gradient(90deg, #0f3d24 0%, #161616 100%) !important; border-left: 4px solid #00e676; }
        .bg-memo-exists { background: linear-gradient(90deg, #0d3d52 0%, #161616 100%) !important; border-left: 4px solid #00bcd4; }
        
        /* ì„¸ìƒ ì œì¼ ê°„ì§€ë‚˜ëŠ” ê²€ìƒ‰ì°½ */
        .search-container {
            position: relative;
            width: 100%;
            max-width: 600px;
        }
        .gganji-search {
            width: 100%;
            background: #1a1a1a;
            border: 2px solid transparent;
            border-radius: 50px; /* ë‘¥ê¸€ê²Œ */
            padding: 12px 20px 12px 50px; /* ì•„ì´ì½˜ ê³µê°„ í™•ë³´ */
            color: #fff;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            background-image: linear-gradient(#1a1a1a, #1a1a1a), linear-gradient(45deg, #00c6ff, #0072ff);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }
        .gganji-search:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(0, 198, 255, 0.4);
            transform: scale(1.02);
        }
        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #00c6ff;
            font-size: 1.2rem;
            pointer-events: none;
        }

        /* ë²„íŠ¼ ë° ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .action-btns { display: flex; gap: 8px; flex-wrap: nowrap; align-items: center; }
        .count-badge { font-size: 1.2rem; font-weight: 800; color: #fff; background: #222; padding: 6px 14px; border-radius: 8px; min-width: 50px; text-align: center; border: 1px solid #444; box-shadow: inset 0 0 10px #000; }
        .project-path { font-size: 0.8rem; color: #ffc107 !important; display: block; margin-top: 2px; font-family: 'Consolas', monospace; opacity: 0.9; }
        .rule-badge { font-size: 0.7rem; display: block; margin-top: 2px; color: #0dcaf0; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-content { background-color: #1e1e1e; border: 1px solid #444; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        .modal-header { border-bottom: 1px solid #333; }
        .modal-footer { border-top: 1px solid #333; }
        
        /* 100% í™œìš© íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ (Extra Wide) */
        .modal-xl-custom { max-width: 95% !important; }
        
        /* Markdown ë Œë”ë§ ìŠ¤íƒ€ì¼ (Dark Theme) */
        .markdown-body {
            color: #e0e0e0;
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.6;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { border-bottom: 1px solid #444; padding-bottom: 0.3em; margin-top: 1.5em; color: #fff; }
        .markdown-body code { background-color: #2d2d2d; padding: 2px 5px; border-radius: 4px; color: #ff7b72; font-family: 'Consolas', monospace; }
        .markdown-body pre { background-color: #161616; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #333; }
        .markdown-body pre code { background-color: transparent; color: #e0e0e0; padding: 0; }
        .markdown-body blockquote { border-left: 4px solid #007acc; padding-left: 15px; color: #aaa; margin: 1em 0; }
        .markdown-body ul, .markdown-body ol { padding-left: 2em; }

        .history-item { 
            border-left: 2px solid #444; 
            padding-left: 20px; 
            margin-bottom: 30px; 
            position: relative; 
        }
        .history-item::before { 
            content: ''; position: absolute; left: -7px; top: 0; 
            width: 12px; height: 12px; border-radius: 50%; background: #444; 
            border: 2px solid #1e1e1e;
        }
        .history-item.done { border-color: #28a745; }
        .history-item.done::before { background: #28a745; box-shadow: 0 0 10px #28a745; }
        .history-item.processing { border-color: #ffc107; }
        .history-item.processing::before { background: #ffc107; box-shadow: 0 0 10px #ffc107; }
        
        /* ì°¨íŠ¸ ë° ì‚¬ì´ë“œë°” */
        .sticky-sidebar { position: sticky; top: 20px; height: calc(100vh - 40px); overflow-y: auto; padding-right: 5px; }
        .stats-box { background: #222; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .bar-container { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.8rem; }
        .bar-label { width: 60px; text-align: right; margin-right: 10px; color: #888; font-family: monospace; }
        .bar-wrapper { flex-grow: 1; background: #333; height: 10px; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, #007acc, #00c6ff); border-radius: 5px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-black border-bottom border-dark py-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold fs-3 text-white" href="#">
                <i class="bi bi-cpu-fill text-primary"></i> AI
            </a>
            
            <div class="search-container mx-auto">
                <i class="bi bi-search search-icon"></i>
                <input type="text" id="globalSearch" class="gganji-search" placeholder="Search Projects, Paths, Tasks..." onkeyup="filterTable()">
            </div>
            
            <div class="d-flex align-items-center">
                <span class="me-4 fs-5 text-secondary">Calls <span class="fw-bold text-success">{{ total_calls }}</span></span>
                <a href="/settings" class="btn btn-outline-secondary rounded-pill px-4"><i class="bi bi-gear-fill"></i> Settings</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row g-4">
            <div class="col-md-2">
                <div class="sticky-sidebar">
                    <div class="stats-box">
                        <h6 class="text-secondary text-uppercase small fw-bold mb-3"><i class="bi bi-lightning-fill text-warning"></i> Queue</h6>
                        <div id="activeStats" class="mt-2 text-warning fw-bold">None</div>
                    </div>
                    <div class="stats-box">
                        <h6 class="text-secondary text-uppercase small fw-bold mb-3"><i class="bi bi-graph-up text-primary"></i> Daily Trend</h6>
                        <div id="dailyStats"></div>
                    </div>
                    <div class="stats-box">
                        <h6 class="text-secondary text-uppercase small fw-bold mb-3"><i class="bi bi-calendar-week text-success"></i> Weekly Trend</h6>
                        <div id="weeklyStats"></div>
                    </div>
                    <div class="stats-box">
                        <h6 class="text-secondary text-uppercase small fw-bold mb-3"><i class="bi bi-grid-fill text-info"></i> Groups</h6>
                        <div id="groupStats" class="small">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="col-md-10">
                <table class="table table-dark table-hover align-middle shadow rounded overflow-hidden" id="projectTable">
                    <thead>
                        <tr class="text-secondary text-uppercase small" style="border-bottom: 2px solid #333;">
                            <th style="width: 100px;">Group</th>
                            <th style="min-width: 400px;">Actions</th>
                            <th class="text-center" style="width: 100px;">Count</th>
                            <th>Project</th>
                            <th>Active</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in projects %}
                        <tr class="{{ 'bg-active-job' if p.IsQueued else ('bg-memo-exists' if p.HasMemo else '') }}">
                            <td><span class="badge bg-secondary opacity-50 rounded-pill">{{ p.GroupName }}</span></td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="openVsCode('{{ p.IPAddress }}', '{{ p.Account }}', '{{ p.FullPath }}')" title="Code"><i class="bi bi-code-slash"></i></button>
                                    <button class="btn btn-success btn-sm rounded-pill px-3" onclick="openTaskModal('{{ p.DisplayName }}', '{{ p.FullPath }}', `{{ p.CommonInstruction or '' }}`)" title="Task"><i class="bi bi-plus-lg"></i> Task</button>
                                    <div class="text-center" style="width: 100px;">
                                        <button class="btn {{ 'btn-info' if p.LastRuleName else 'btn-outline-info' }} btn-sm w-100 rounded-pill" onclick="openRuleModal('{{ p.DisplayName }}', '{{ p.FullPath }}')" title="Deploy Rule">
                                            <i class="bi bi-send"></i> Rule
                                        </button>
                                        {% if p.LastRuleName %}<span class="rule-badge text-truncate" style="max-width:100px;">{{ p.LastRuleName }}</span>{% endif %}
                                    </div>
                                    <button class="btn btn-secondary btn-sm rounded-circle" onclick="openMemoModal('{{ p.DisplayName }}', '{{ p.FullPath }}')" title="Memo" style="width: 32px; height: 32px;"><i class="bi bi-sticky"></i></button>
                                    <button class="btn btn-warning btn-sm rounded-circle" onclick="openHistoryModal('{{ p.DisplayName }}', '{{ p.FullPath }}')" title="History" style="width: 32px; height: 32px;"><i class="bi bi-clock-history"></i></button>
                                </div>
                            </td>
                            <td class="text-center"><div class="count-badge">{{ p.TaskCount }}</div></td>
                            <td>
                                <div class="fw-bold text-white fs-5">{{ p.DisplayName }}</div>
                                <div class="project-path">{{ p.FullPath }}</div>
                            </td>
                            <td class="small opacity-50">{{ p.LastTaskDate }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl-custom modal-dialog-scrollable"> <div class="modal-content">
                <div class="modal-header border-secondary bg-dark">
                    <h5 class="modal-title"><i class="bi bi-clock-history text-warning"></i> Task History - <span id="histProjectName" class="text-white"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-black">
                    <div id="historyTimeline" class="p-4 container-fluid"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header border-secondary"><h5 class="modal-title">Task Manager - <span id="modalProjectName" class="text-warning"></span></h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 class="text-secondary mb-2">Active Queue</h6><ul class="list-group bg-dark mb-4" id="currentQueueList"></ul><div class="form-group mb-3"><label class="text-info small fw-bold mb-1">Common Instruction</label><textarea class="form-control bg-dark text-info border-info" id="commonInstruction" rows="2"></textarea></div><div class="form-group"><label class="text-white mb-1">New Task</label><textarea class="form-control bg-dark text-white border-secondary" id="taskContent" rows="3"></textarea></div></div><div class="modal-footer border-secondary"><button class="btn btn-success" onclick="submitTask()">Add to Queue</button></div></div></div></div>
    <div class="modal fade" id="ruleModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Deploy Rule</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Project: <span id="ruleProjectName" class="fw-bold"></span></p><select class="form-select bg-dark text-white mb-2" id="ruleSelect"></select></div><div class="modal-footer"><button class="btn btn-info" onclick="deployRule()">Deploy</button></div></div></div></div>
    <div class="modal fade" id="memoModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Memo</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea class="form-control bg-dark text-white" id="memoContent" rows="10"></textarea></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveMemo()">Save</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global
        let currentProject = '', currentPath = '';
        const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
        const ruleModal = new bootstrap.Modal(document.getElementById('ruleModal'));
        const memoModal = new bootstrap.Modal(document.getElementById('memoModal'));
        const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));

        document.addEventListener('DOMContentLoaded', () => { updateDashboardStats(); setInterval(updateDashboardStats, 5000); });

        // Search Filter
        function filterTable() {
            const input = document.getElementById('globalSearch').value.toUpperCase();
            const tr = document.getElementById('projectTable').getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                tr[i].style.display = (tr[i].textContent || tr[i].innerText).toUpperCase().indexOf(input) > -1 ? "" : "none";
            }
        }

        function updateDashboardStats() {
            fetch('/api/stats/dashboard').then(r => r.json()).then(data => {
                document.getElementById('groupStats').innerHTML = data.groups.map(g => `<div class="d-flex justify-content-between mb-1"><span>${g.GroupName}</span> <span class="badge bg-dark border">${g.Cnt}</span></div>`).join('');
                document.getElementById('activeStats').innerHTML = data.active.length ? data.active.map(a => `<div class="d-flex justify-content-between mb-1"><span>${a.GroupName}</span> <span class="badge bg-warning text-dark">${a.Cnt}</span></div>`).join('') : 'None';
                renderBars('dailyStats', data.daily);
                renderBars('weeklyStats', data.weekly);
            });
        }
        function renderBars(id, data) {
            if(!data || !data.length) { document.getElementById(id).innerHTML = '<div class="text-secondary small">No data</div>'; return; }
            const maxVal = Math.max(...data.map(d => d.Val));
            document.getElementById(id).innerHTML = data.map(d => `
                <div class="bar-container">
                    <div class="bar-label">${d.Label}</div>
                    <div class="bar-wrapper"><div class="bar-fill" style="width: ${(d.Val/maxVal)*100}%"></div></div>
                </div>`).join('');
        }

        // --- History (Markdown & Wide) ---
        function openHistoryModal(name, path) {
            document.getElementById('histProjectName').innerText = name;
            const div = document.getElementById('historyTimeline');
            div.innerHTML = '<div class="text-center p-5 text-secondary"><div class="spinner-border mb-3"></div><br>Loading history...</div>';
            
            fetch('/api/history', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({path: path}) })
            .then(r => r.json())
            .then(rows => {
                if(rows.length === 0) {
                    div.innerHTML = '<div class="text-center p-5 text-secondary"><h5>No history found.</h5><p>Start a task to see results here.</p></div>';
                    return;
                }
                div.innerHTML = rows.map(r => {
                    // Markdown Rendering
                    const requestHtml = marked.parse(r.TaskContent || '');
                    const resultHtml = r.ResultContent ? marked.parse(r.ResultContent) : '';
                    
                    const statusColor = r.Status === 'Done' ? 'success' : (r.Status === 'Processing' ? 'warning' : 'secondary');
                    
                    return `
                    <div class="history-item ${r.Status === 'Done' ? 'done' : (r.Status === 'Processing' ? 'processing' : '')}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div><span class="badge bg-${statusColor} fs-6">${r.Status}</span> <span class="text-secondary ms-2 small">ID: ${r.TaskID}</span></div>
                            <div class="text-secondary font-monospace small">${r.CompletedAt || r.CreatedAt}</div>
                        </div>
                        
                        <div class="card bg-dark border-secondary mb-3">
                            <div class="card-header border-secondary py-1 text-info small fw-bold">REQUEST</div>
                            <div class="card-body py-2 markdown-body">${requestHtml}</div>
                        </div>
                        
                        ${r.ResultContent ? `
                        <div class="card bg-dark border-${statusColor} mb-2">
                            <div class="card-header border-${statusColor} py-1 text-${statusColor} small fw-bold">RESULT</div>
                            <div class="card-body py-3 markdown-body">${resultHtml}</div>
                        </div>` : '<div class="text-secondary small fst-italic ps-2">Waiting for result...</div>'}
                    </div>
                    `;
                }).join('');
            });
            historyModal.show();
        }

        // --- Standard Functions ---
        function openTaskModal(name, path, common) { currentProject = name; currentPath = path; document.getElementById('modalProjectName').innerText = name; document.getElementById('taskContent').value = ''; document.getElementById('commonInstruction').value = common; loadQueue(path); taskModal.show(); }
        function loadQueue(path) { fetch(`/api/queue?path=${encodeURIComponent(path)}`).then(r => r.json()).then(tasks => { document.getElementById('currentQueueList').innerHTML = tasks.length ? tasks.map(t => `<li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between"><div><span class="badge bg-warning text-dark me-2">${t.Status}</span> ${t.TaskContent.substring(0,40)}...</div><button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${t.TaskID})"><i class="bi bi-trash"></i></button></li>`).join('') : '<li class="list-group-item bg-dark text-secondary text-center">Empty</li>'; }); }
        function submitTask() { const c = document.getElementById('taskContent').value; const ci = document.getElementById('commonInstruction').value; if(!c) return; fetch('/api/queue', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({project:currentProject, path:currentPath, content:c, common_instruction:ci}) }).then(()=>{ document.getElementById('taskContent').value=''; loadQueue(currentPath); updateDashboardStats(); location.reload(); }); }
        function deleteTask(id) { if(confirm('Delete?')) fetch(`/api/queue?id=${id}`, {method:'DELETE'}).then(()=>loadQueue(currentPath)); }
        function openVsCode(ip, acc, path) { fetch('/api/open_vscode', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ip, account:acc, path}) }); }
        function openRuleModal(n, p) { currentProject=n; currentPath=p; document.getElementById('ruleProjectName').innerText=n; fetch('/api/rules').then(r=>r.json()).then(rules=>{ document.getElementById('ruleSelect').innerHTML=rules.map(r=>`<option value="${r.RuleID}">${r.RuleName}</option>`).join(''); ruleModal.show(); }); }
        function deployRule() { const id=document.getElementById('ruleSelect').value; fetch('/api/rules/deploy', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({project_name:currentProject, project_path:currentPath, rule_id:id}) }).then(r=>r.json()).then(res=>{ alert(res.message); ruleModal.hide(); location.reload(); }); }
        function openMemoModal(n, p) { currentProject=n; currentPath=p; fetch('/api/memos/get', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({path:p})}).then(r=>r.json()).then(d=>{ document.getElementById('memoContent').value=d.content; memoModal.show(); }); }
        function saveMemo() { const c=document.getElementById('memoContent').value; fetch('/api/memos', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({project:currentProject, path:currentPath, content:c})}).then(()=>{ memoModal.hide(); location.reload(); }); }
    </script>
</body>
</html>
"""
with open(os.path.join(base_dir, "app", "templates", "index.html"), "w", encoding="utf-8") as f:
    f.write(index_html)

print("\nâœ… v8 ì—…ë°ì´íŠ¸ ì™„ë£Œ!")
print("1. ë£° í¸ì§‘: ë²„ê·¸ ìˆ˜ì • (ë°ì´í„° ë¡œë”© ë°©ì‹ ê°œì„ )")
print("2. UI: ì œëª© 'AI', ê°„ì§€ë‚˜ëŠ” ê²€ìƒ‰ì°½ ì ìš©")
print("3. íˆìŠ¤í† ë¦¬: Markdown ë Œë”ë§ + ëª¨ë‹¬ ê°€ë¡œí­ 95% í™•ì¥")
print("ğŸ‘‰ 'python3 runcline/run_bridge.py' ì‹¤í–‰í•˜ì„¸ìš”.")