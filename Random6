import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print(f"âŒ ì˜¤ë¥˜: '{base_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# ==========================================
# SSH Service ìˆ˜ì • (Robust Version)
# - ìœˆë„ìš°/ë¦¬ëˆ…ìŠ¤ ê²½ë¡œ ìë™ ê°ì§€
# - ê°•ì œ í´ë” ìƒì„± (ì´ë¯¸ ìˆì–´ë„ ì—ëŸ¬ ì•ˆ ë‚¨)
# - ë¬´ì¡°ê±´ ë®ì–´ì“°ê¸°
# ==========================================
ssh_service_code = r"""import subprocess
import os

def send_rule_via_ssh(ip, account, rule_content, project_path):
    try:
        # 1. ê²½ë¡œ ë³´ì • (ìœˆë„ìš° ì—­ìŠ¬ë˜ì‹œ -> ìŠ¬ë˜ì‹œ)
        if '\\' in project_path:
            project_path = project_path.replace('\\', '/')
            
        # 2. íƒ€ê²Ÿ ê²½ë¡œ ì„¤ì • (.clinerules í´ë”)
        target_dir = f"{project_path}/.clinerules"
        target_file = f"{target_dir}/absoluterule.md"
        
        # 3. ë¡œì»¬ ì„ì‹œ íŒŒì¼ ìƒì„±
        temp_filename = f"temp_rule_{ip}.md"
        with open(temp_filename, 'w', encoding='utf-8') as f:
            f.write(rule_content)
            
        # 4. [í´ë” ìƒì„±] OSë³„ "ê°•ì œ ìƒì„±" ëª…ë ¹ì–´ ë¶„ê¸°
        # check=Falseë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ ì¡´ì¬í•´ì„œ ì—ëŸ¬ê°€ ë‚˜ë”ë¼ë„ ë¬´ì‹œí•˜ê³  ì§„í–‰
        
        if ':' in project_path: 
            # [Windows] ë“œë¼ì´ë¸Œ ë¬¸ì(:)ê°€ ìˆìœ¼ë©´ ìœˆë„ìš°ë¡œ ê°„ì£¼
            # PowerShellì˜ New-Item -ForceëŠ” í´ë”ê°€ ì—†ìœ¼ë©´ ë§Œë“¤ê³ , ìˆìœ¼ë©´ ì•„ë¬´ ì—ëŸ¬ ì—†ì´ ë„˜ì–´ê° (ê°€ì¥ í™•ì‹¤)
            # ì£¼ì˜: ê²½ë¡œì— ì‘ì€ë”°ì˜´í‘œ(')ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µë°± ë¬¸ì œ ë°©ì§€
            mkdir_cmd_str = f"powershell -Command \"New-Item -ItemType Directory -Force -Path '{target_dir}'\""
            
            # SSHë¡œ ëª…ë ¹ì–´ ì „ì†¡
            subprocess.run(['ssh', f'{account}@{ip}', mkdir_cmd_str], check=False)
            
        else:
            # [Linux] mkdir -p ì˜µì…˜ì€ ìƒìœ„ í´ë”ë„ ë§Œë“¤ê³ , ì´ë¯¸ ìˆì–´ë„ ì—ëŸ¬ ì•ˆ ëƒ„
            mkdir_cmd_str = f'mkdir -p "{target_dir}"'
            
            # SSHë¡œ ëª…ë ¹ì–´ ì „ì†¡
            subprocess.run(['ssh', f'{account}@{ip}', mkdir_cmd_str], check=False)

        # 5. [SCP] íŒŒì¼ ì „ì†¡ (ë¬´ì¡°ê±´ ë®ì–´ì“°ê¸°)
        # scpëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ëŒ€ìƒ íŒŒì¼ì´ ìˆìœ¼ë©´ ë®ì–´ì”ë‹ˆë‹¤.
        remote_dest = f'{account}@{ip}:"{target_file}"'
        
        # SCP ì‹¤í–‰ (ì—¬ê¸°ì„œëŠ” ì—ëŸ¬ê°€ ë‚˜ë©´ ì§„ì§œ ë¬¸ì œì´ë¯€ë¡œ check_call ìœ ì§€)
        scp_cmd = ['scp', '-o', 'StrictHostKeyChecking=no', temp_filename, remote_dest]
        subprocess.check_call(scp_cmd)
        
        # 6. ì²­ì†Œ
        if os.path.exists(temp_filename):
            os.remove(temp_filename)
            
        return True, "Rule deployed successfully (Overwritten)"
        
    except subprocess.CalledProcessError as e:
        # SCP ì‹¤íŒ¨ ì‹œ êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜
        return False, f"SCP/SSH Failed: {e}"
    except Exception as e:
        return False, str(e)
"""

target_file = os.path.join(base_dir, "app", "services", "ssh_service.py")
with open(target_file, "w", encoding="utf-8") as f:
    f.write(ssh_service_code)

print("âœ… SSH ì„œë¹„ìŠ¤ ìˆ˜ì • ì™„ë£Œ!")
print("ğŸ‘‰ ì ìš© ì‚¬í•­:")
print("   1. ìœˆë„ìš°ì¼ ê²½ìš° PowerShell 'New-Item -Force' ì‚¬ìš© (í´ë” ì—†ìœ¼ë©´ ìƒì„±, ìˆìœ¼ë©´ í†µê³¼)")
print("   2. ë¦¬ëˆ…ìŠ¤ì¼ ê²½ìš° 'mkdir -p' ì‚¬ìš© (ìƒìœ„ í´ë” ìë™ ìƒì„±)")
print("   3. ì—ëŸ¬ ë¬´ì‹œ ë¡œì§ ì¶”ê°€ë¡œ 'Non-zero exit' íŒì—… ë°©ì§€")
print("ğŸ‘‰ ë‹¤ì‹œ ì‹¤í–‰: python3 runcline/run_bridge.py")