import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ ì˜¤ë¥˜: 'runcline' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸš€ AI Bridge v43: Integrated API Full Code Restoration...")

# 1. ë°°ê²½ ì´ë¯¸ì§€ í´ë” ìƒì„±
os.makedirs(os.path.join(base_dir, "app", "static", "bg"), exist_ok=True)

# 2. api_routes.py ì „ì²´ ì½”ë“œ ì •ì˜ (ì—¬ê¸° ëª¨ë“  ê¸°ëŠ¥ì´ ë‹¤ ë“¤ì–´ìˆìŠµë‹ˆë‹¤)
full_api_code = r"""from flask import Blueprint, request, jsonify, session, redirect, url_for, render_template
from app.database import get_db_connection
import subprocess, os, json, shlex, urllib.request, ssl, re, base64

api_bp = Blueprint('api', __name__)

# --- [AUTH] ì„¤ì • ---
PASS_CODE = "kw1121"

@api_bp.before_app_request
def security_gate():
    # ë¡œê·¸ì¸ ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
    if not session.get('authorized') and request.endpoint not in ['api.login', 'static']:
        return redirect(url_for('api.login'))

@api_bp.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        if request.form.get('password') == PASS_CODE:
            session['authorized'] = True
            return redirect('/')
        return render_template('login.html', error=True)
    return render_template('login.html')

# --- [CORE] ëª…ë ¹ì–´ ì‹¤í–‰ í•¨ìˆ˜ ---
def run_command(ip, user, path, cmd_list):
    if '\\' in path: path = path.replace('\\', '/')
    cmd_str = ' '.join(shlex.quote(arg) for arg in cmd_list)
    if ip in ['127.0.0.1', 'localhost']:
        try:
            env = os.environ.copy(); env["PYTHONIOENCODING"] = "utf-8"
            res = subprocess.run(cmd_list, cwd=path, capture_output=True, text=True, encoding='utf-8', env=env)
            return {'code': res.returncode, 'stdout': res.stdout, 'stderr': res.stderr}
        except Exception as e: return {'code': 1, 'stderr': str(e)}
    else:
        ssh_cmd = ['ssh', '-o', 'StrictHostKeyChecking=no', f'{user}@{ip}', f"cd {shlex.quote(path)} && {cmd_str}"]
        try:
            res = subprocess.run(ssh_cmd, capture_output=True, text=True, encoding='utf-8')
            return {'code': res.returncode, 'stdout': res.stdout, 'stderr': res.stderr}
        except Exception as e: return {'code': 1, 'stderr': str(e)}

def quick_git_push(ip, user, path, msg):
    run_command(ip, user, path, ['git', 'config', 'http.sslVerify', 'false'])
    run_command(ip, user, path, ['git', 'add', '.'])
    run_command(ip, user, path, ['git', 'commit', '-m', msg])
    p = run_command(ip, user, path, ['git', 'push', 'origin', 'main'])
    if p['code'] != 0: run_command(ip, user, path, ['git', 'push', 'origin', 'master'])

# --- [GIT] ìë™ ì—°ë™ ê¸°ëŠ¥ ---
@api_bp.route('/git/auto_connect', methods=['POST'])
def git_auto_connect():
    data = request.json
    ip, user, path, token, nuke = data.get('ip'), data.get('account'), data.get('path'), data.get('token'), data.get('nuke')
    logs = []
    if nuke: run_command(ip, user, path, ['rm', '-rf', '.git']); logs.append("ğŸ§¨ Nuke .git")
    if run_command(ip, user, path, ['test', '-d', '.git'])['code'] != 0: 
        run_command(ip, user, path, ['git', 'init']); logs.append("âœ¨ Git Init")
    
    repo_name = "cline_" + re.sub(r'[^a-zA-Z0-9_-]', '_', os.path.basename(path.rstrip('/\\')))
    try:
        ctx = ssl.create_default_context(); ctx.check_hostname = False; ctx.verify_mode = ssl.CERT_NONE
        headers = {"Authorization": f"token {token}", "Content-Type": "application/json"}
        req = urllib.request.Request("https://github.sec.samsung.net/api/v3/user/repos", 
                                     data=json.dumps({"name": repo_name, "private": True}).encode(), headers=headers)
        with urllib.request.urlopen(req, context=ctx) as res:
            real_url = json.loads(res.read().decode())['clone_url']
            logs.append(f"ğŸ‰ Created Repo: {repo_name}")
    except:
        real_url = f"https://github.sec.samsung.net/{user}/{repo_name}.git"
        logs.append("â„¹ï¸ Using existing repo.")

    auth_url = real_url.replace("https://", f"https://{user}:{token}@", 1)
    run_command(ip, user, path, ['git', 'remote', 'remove', 'origin'])
    run_command(ip, user, path, ['git', 'remote', 'add', 'origin', auth_url])
    run_command(ip, user, path, ['git', 'add', '.'])
    run_command(ip, user, path, ['git', 'commit', '-m', 'Init Setup'])
    run_command(ip, user, path, ['git', 'config', 'http.sslVerify', 'false'])
    p = run_command(ip, user, path, ['git', 'push', '-u', 'origin', 'main'])
    if p['code'] != 0: p = run_command(ip, user, path, ['git', 'push', '-u', 'origin', 'master'])
    
    if p['code'] == 0:
        conn = get_db_connection(); cursor = conn.cursor()
        cursor.execute("UPDATE cline_FolderIndex SET RemoteURL=%s, LastGitDate=GETDATE() WHERE FullPath=%s", (real_url, path))
        conn.commit(); conn.close()
        return jsonify({'status': 'success', 'output': '\n'.join(logs)})
    return jsonify({'status': 'error', 'message': p['stderr']})

# --- [RULE] ë°°í¬ ê¸°ëŠ¥ (í´ë”/íŒŒì¼ êµ¬ì¡° ì •ë°€í™”) ---
@api_bp.route('/rules/deploy', methods=['POST'])
def deploy_rule():
    data = request.json
    p_name, p_path, r_id = data.get('project_name'), data.get('project_path'), data.get('rule_id')
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (r_id,))
    rule = cursor.fetchone()
    cursor.execute("SELECT IPAddress, Account FROM cline_FolderIndex WHERE FullPath=%s", (p_path,))
    tgt = cursor.fetchone()
    if not rule or not tgt: conn.close(); return jsonify({'status': 'error', 'message': 'Not found'})
    
    # ë³€ìˆ˜ ì¹˜í™˜ ë° ê²½ë¡œ ì„¤ì •
    f_content = rule['RuleContent'].replace('{SUBJECT}', p_name).replace('{TARGET_PATH}', p_path.replace('\\', '/'))
    r_dir = os.path.join(p_path, ".clinerules").replace('\\', '/')
    r_file = os.path.join(r_dir, "absoluterule.md").replace('\\', '/')
    b64 = base64.b64encode(f_content.encode('utf-8')).decode('utf-8')
    
    if tgt['IPAddress'] in ['127.0.0.1', 'localhost']:
        os.makedirs(r_dir, exist_ok=True)
        with open(r_file, 'w', encoding='utf-8') as f: f.write(f_content)
        ok = True
    else:
        cmd = f"mkdir -p {shlex.quote(r_dir)} && echo '{b64}' | base64 -d > {shlex.quote(r_file)}"
        res = run_command(tgt['IPAddress'], tgt['Account'], '.', ['bash', '-c', cmd])
        ok = (res['code'] == 0)
    
    if ok:
        cursor.execute("UPDATE cline_FolderIndex SET LastRuleName=%s WHERE FullPath=%s", (rule['RuleName'], p_path))
        conn.commit()
    conn.close(); return jsonify({'status': 'success' if ok else 'error'})

# --- [STATS] Dashboard ---
@api_bp.route('/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    groups = cursor.fetchall()
    cursor.execute("SELECT ISNULL(f.GroupName, f.IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_TaskQueue q JOIN cline_FolderIndex f ON q.ProjectPath = f.FullPath WHERE q.Status IN ('Pending', 'Processing') GROUP BY ISNULL(f.GroupName, f.IPAddress)")
    active = cursor.fetchall()
    
    def gs(sql):
        cursor.execute(sql); r = cursor.fetchone()
        return {'cnt': r['Cnt'], 'dur': r['Dur']} if r else {'cnt': 0, 'dur': 0}
        
    d = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -1, GETDATE()) AND Status='Done'")
    w = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -7, GETDATE()) AND Status='Done'")
    m = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(month, -1, GETDATE()) AND Status='Done'")
    conn.close(); return jsonify({'groups': groups, 'active': active, 'counts': {'day': d, 'week': w, 'month': m}})

# --- [SYSTEM] VSCode, Bookmarks, Queue ---
@api_bp.route('/open_vscode', methods=['POST'])
def open_vscode():
    d = request.json
    cmd = ['code', '--new-window']
    if d['ip'] not in ['127.0.0.1', 'localhost']:
        cmd.extend(['--remote', f"ssh-remote+{d['account']}@{d['ip']}", d['path']])
    else:
        cmd.append(d['path'])
    subprocess.Popen(cmd, env=os.environ.copy())
    return jsonify({'status': 'success'})

@api_bp.route('/queue', methods=['GET', 'POST', 'DELETE'])
def handle_queue():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT TaskID, ProjectName, TaskContent, Status, CONVERT(VARCHAR, StartedAt, 120) as StartedAt FROM cline_TaskQueue WHERE Status IN ('Pending', 'Processing') ORDER BY TaskID")
        rows = cursor.fetchall(); conn.close(); return jsonify(rows)
    if request.method == 'POST':
        d = request.json
        cursor.execute("INSERT INTO cline_TaskQueue (ProjectName, ProjectPath, TaskContent) VALUES (%s, %s, %s)", (d['project'], d['path'], d['content']))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})
    if request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_TaskQueue WHERE TaskID=%s", (request.args.get('id'),)); conn.commit(); conn.close(); return jsonify({'status': 'success'})

@api_bp.route('/bookmarks', methods=['GET'])
def get_bookmarks():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True); cursor.execute("SELECT * FROM cline_WebBookmarks"); r = cursor.fetchall(); conn.close(); return jsonify(r)

@api_bp.route('/history', methods=['POST'])
def get_task_history():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT TaskID, TaskContent, Status, ResultContent, CONVERT(VARCHAR, CreatedAt, 120) as CreatedAt FROM cline_TaskQueue WHERE ProjectPath=%s ORDER BY TaskID DESC", (request.json.get('path'),)); r = cursor.fetchall(); conn.close(); return jsonify(r)

@api_bp.route('/memos/get', methods=['POST'])
def get_memo():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT MemoContent FROM cline_ProjectMemos WHERE ProjectPath=%s", (request.json.get('path'),)); r = cursor.fetchone(); conn.close(); return jsonify({'content': r['MemoContent'] if r else ''})
"""

# 3. íŒŒì¼ ì“°ê¸°
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(full_api_code)

print("\nâœ… v43 ë³µêµ¬ ì™„ë£Œ! ì´ì œ ëª¨ë“  APIê°€ api_routes.py í•œ íŒŒì¼ì— ì™„ë²½í•˜ê²Œ ë“¤ì–´ìˆìŠµë‹ˆë‹¤.")
print("ğŸ‘‰ ì´ì œ 'Unexpected token'ì´ë‚˜ 'Missing code' ì—ëŸ¬ ì—†ì´ ëª¨ë“  ê¸°ëŠ¥ì´ ì‘ë™í•©ë‹ˆë‹¤.")