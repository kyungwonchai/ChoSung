아래 코드를 복사해서 /home/kw/setup_final.py로 저장하세요.

python3 setup_final.py 로 실행하세요.

Python
import os
import sys

# ==============================================================================
# [설정] 사용자 환경 (수정 불필요)
# ==============================================================================
USER_HOME = "/home/kw"
PROJECT_NAME = "dify_bridge"
TARGET_DIR = os.path.join(USER_HOME, PROJECT_NAME)
VENV_PYTHON = os.path.join(USER_HOME, "myvenv1/bin/python") # 가상환경 파이썬

# ==============================================================================
# [파일 1] server.py : 불필요한 헤더 제거 및 최적화
# ==============================================================================
SERVER_CODE = """
from flask import Flask, request, jsonify
import requests
import time
import json

app = Flask(__name__)

# ##############################################################################
# [사용자 수정 영역] ★ 여기만 고치면 됩니다 ★
# ##############################################################################

# 1. 회사 AI API 전체 주소 (curl의 --url 부분)
COMPANY_API_URL = "http://YOUR_COMPANY_API_URL_HERE" 

# 2. 회사 API 인증 키 (curl의 x-api-key 부분)
# 키가 없다면 비워두세요: ""
COMPANY_API_KEY = "YOUR_API_KEY_HERE"

# ##############################################################################

@app.route('/v1/chat/completions', methods=['POST'])
def proxy_chat():
    print(f"\\n[LOG] Dify 요청 수신함")
    
    try:
        # 1. Dify 데이터 파싱
        dify_data = request.json
        messages = dify_data.get('messages', [])
        
        # 마지막 질문 추출
        user_input = ""
        if messages:
            for msg in reversed(messages):
                if msg['role'] == 'user':
                    user_input = msg['content']
                    break
        
        print(f"[LOG] 사용자 질문: {user_input}")

        # 2. 회사 API 전송용 데이터 (curl --data 부분)
        payload = {
            "input_type": "chat",
            "output_type": "chat",
            "input_value": user_input
        }

        # 3. 헤더 설정 (Content-Type은 requests가 자동 처리함)
        headers = {}
        if COMPANY_API_KEY:
            headers["x-api-key"] = COMPANY_API_KEY

        # 4. 회사 API 호출
        print(f"[LOG] 회사 API 호출 중... {COMPANY_API_URL}")
        response = requests.post(
            COMPANY_API_URL, 
            headers=headers, 
            json=payload,      # json=... 을 쓰면 application/json 자동 적용됨
            timeout=120
        )
        
        # 5. 응답 처리
        if response.status_code == 200:
            try:
                # JSON 응답을 문자열로 변환하여 전달
                # (나중에 필요하면 resp_json['answer'] 등으로 특정 필드만 뽑으세요)
                resp_json = response.json()
                ai_answer = str(resp_json) 
            except:
                ai_answer = response.text
        else:
            error_msg = f"API Error: {response.status_code} - {response.text}"
            print(f"[ERROR] {error_msg}")
            ai_answer = error_msg

        print(f"[LOG] 답변 반환 완료")

        # 6. Dify용 포맷으로 변환 (OpenAI 표준)
        openai_resp = {
            "id": "chatcmpl-" + str(int(time.time())),
            "object": "chat.completion",
            "created": int(time.time()),
            "model": "company-ai",
            "choices": [{
                "index": 0,
                "message": {"role": "assistant", "content": ai_answer},
                "finish_reason": "stop"
            }],
            "usage": {
                "prompt_tokens": len(user_input),
                "completion_tokens": len(ai_answer),
                "total_tokens": 0
            }
        }
        return jsonify(openai_resp)

    except Exception as e:
        print(f"[ERROR] {e}")
        return jsonify({"error": str(e)}), 500

@app.route('/v1/models', methods=['GET'])
def list_models():
    return jsonify({"object": "list", "data": [{"id": "company-ai", "object": "model"}]})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001)
"""

# ==============================================================================
# [파일 2] install_service.sh : 서비스 재등록 및 재시작 스크립트
# ==============================================================================
SERVICE_SCRIPT = f"""#!/bin/bash

SERVICE_NAME="dify-bridge"
SERVICE_FILE="/etc/systemd/system/$SERVICE_NAME.service"

echo "[INFO] 1. 필수 라이브러리 확인..."
"{os.path.dirname(VENV_PYTHON)}/pip" install flask requests

echo "[INFO] 2. Systemd 서비스 파일 갱신..."
sudo bash -c "cat > $SERVICE_FILE" <<EOL
[Unit]
Description=Dify Bridge Server (Python Flask)
After=network.target

[Service]
User={os.getlogin()}
WorkingDirectory={TARGET_DIR}
ExecStart={VENV_PYTHON} {os.path.join(TARGET_DIR, 'server.py')}
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOL

echo "[INFO] 3. 서비스 재시작 중..."
sudo systemctl daemon-reload
sudo systemctl enable $SERVICE_NAME
sudo systemctl restart $SERVICE_NAME

echo "----------------------------------------------------"
echo "[완료] 브릿지 서버가 업데이트되었습니다."
echo "----------------------------------------------------"
"""

def create_files():
    # 폴더 확인
    if not os.path.exists(TARGET_DIR):
        os.makedirs(TARGET_DIR)

    # server.py 덮어쓰기
    server_path = os.path.join(TARGET_DIR, "server.py")
    with open(server_path, "w", encoding="utf-8") as f:
        f.write(SERVER_CODE.strip())
    
    # install_service.sh 덮어쓰기
    sh_path = os.path.join(TARGET_DIR, "install_service.sh")
    with open(sh_path, "w", encoding="utf-8") as f:
        f.write(SERVICE_SCRIPT.strip())
    os.chmod(sh_path, 0o755)

    print("-" * 50)
    print("최종 파일 생성이 완료되었습니다!")
    print(f"1. 편집: nano {server_path}")
    print("   (열어서 COMPANY_API_URL 과 COMPANY_API_KEY 만 입력하세요)")
    print("-" * 50)
    print(f"2. 적용: {sh_path}")
    print("   (이걸 실행하면 서비스가 재시작되어 변경 사항이 바로 적용됩니다)")
    print("-" * 50)

if __name__ == "__main__":
    create_files()
[지금 바로 해야 할 일]
위 코드를 복사해서 setup_final.py 실행.

nano /home/kw/dify_bridge/server.py 열어서:

COMPANY_API_URL: 회사 API 주소 넣기.

COMPANY_API_KEY: API 키 넣기.

헤더(fsfds) 걱정 끝! (코드에서 지워버렸으니 신경 안 써도 됩니다)

/home/kw/dify_bridge/install_service.sh 실행.

이제 복잡한 헤더 고민 없이 주소랑 키만 넣으면 바로 붙습니다!