import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ í”„ë¡œì íŠ¸ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸ”¥ [ULTIMATE RESTORE] v51: Real Settings (Bookmarks) & Link Logic...")

# 1. settings.html (ì§„ì§œ ë¶ë§ˆí¬ ê´€ë¦¬ UI ë³µêµ¬)
settings_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>BRIDGE SETTINGS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #050508; color: #e0e0e0; font-family: 'Inter', sans-serif; }
        .settings-card { background: rgba(20, 20, 35, 0.6); border: 1px solid rgba(100, 100, 255, 0.1); border-radius: 16px; padding: 25px; margin-bottom: 20px; }
        .form-control { background: #000; border: 1px solid #333; color: #fff; }
        .form-control:focus { background: #111; border-color: #5c6bc0; color: #fff; box-shadow: none; }
        .table { color: #ccc; }
        .table thead th { border-bottom: 2px solid #5c6bc0; color: #00e5ff; }
    </style>
</head>
<body class="p-5">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-gear-fill me-2 text-info"></i> System Settings</h2>
            <a href="/" class="btn btn-outline-light rounded-pill px-4">Back to Dashboard</a>
        </div>

        <div class="settings-card">
            <h5 class="mb-4 text-warning"><i class="bi bi-bookmark-plus me-2"></i> Web Bookmark Management</h5>
            <div class="row g-3 mb-4">
                <div class="col-md-5"><input type="text" id="bmTitle" class="form-control" placeholder="ì‚¬ì´íŠ¸ ëª…ì¹­ (ì˜ˆ: GitHub Enterprise)"></div>
                <div class="col-md-5"><input type="text" id="bmUrl" class="form-control" placeholder="https://..."></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" onclick="addBookmark()">Add</button></div>
            </div>
            
            <table class="table table-hover">
                <thead><tr><th>Title</th><th>URL</th><th class="text-center">Action</th></tr></thead>
                <tbody id="bookmarkList">
                    </tbody>
            </table>
        </div>

        <div class="settings-card">
            <h5 class="text-muted"><i class="bi bi-shield-lock me-2"></i> Security Info</h5>
            <p class="small text-secondary mb-0">í˜„ì¬ IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ê°€ ì ìš© ì¤‘ì…ë‹ˆë‹¤. ì•„ì´í”¼ ë³€ê²½ ì‹œ <code>api_routes.py</code>ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        function loadBookmarks() {
            fetch('/api/bookmarks').then(r=>r.json()).then(data=>{
                const tbody = document.getElementById('bookmarkList');
                tbody.innerHTML = data.map(b=>`
                    <tr>
                        <td class="fw-bold">${b.Title}</td>
                        <td class="text-info">${b.URL}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBookmark(${b.BookmarkID})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        function addBookmark() {
            const title = document.getElementById('bmTitle').value;
            const url = document.getElementById('bmUrl').value;
            if(!title || !url) return alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');

            fetch('/api/bookmarks', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, url})
            }).then(() => {
                document.getElementById('bmTitle').value = '';
                document.getElementById('bmUrl').value = '';
                loadBookmarks();
            });
        }

        function deleteBookmark(id) {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            fetch(`/api/bookmarks?id=${id}`, { method: 'DELETE' }).then(() => loadBookmarks());
        }

        document.addEventListener('DOMContentLoaded', loadBookmarks);
    </script>
</body>
</html>
"""
os.makedirs(os.path.join(base_dir, "app", "templates"), exist_ok=True)
with open(os.path.join(base_dir, "app", "templates", "settings.html"), "w", encoding="utf-8") as f: f.write(settings_html)

# 2. api_routes.py (ë¶ë§ˆí¬ CRUD ì™„ë²½ ë³µêµ¬ ë° ë£° ë°°í¬ ë¡œì§ ìœ ì§€)
api_code = r"""from flask import Blueprint, request, jsonify, abort
from app.database import get_db_connection
import subprocess, os, json, shlex, urllib.request, ssl, re, base64

api_bp = Blueprint('api', __name__)

# ğŸ›¡ï¸ [IP WHITELIST]
IP_WHITELIST = ["127.0.0.1", "localhost", "192.168.0.10"]

def get_visitor_ip():
    xf = request.headers.get('X-Forwarded-For')
    return xf.split(',')[0].strip() if xf else request.remote_addr

@api_bp.before_app_request
def gate():
    if request.path.startswith('/static'): return
    v_ip = get_visitor_ip()
    if v_ip not in IP_WHITELIST:
        return jsonify({"error": "Unauthorized", "your_ip": v_ip}), 403

# --- [REAL BOOKMARK API] ---
@api_bp.route('/api/bookmarks', methods=['GET', 'POST', 'DELETE'])
def handle_bookmarks():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_WebBookmarks ORDER BY CreatedAt ASC")
        rows = cursor.fetchall(); conn.close(); return jsonify(rows)
    
    if request.method == 'POST':
        d = request.json
        cursor.execute("INSERT INTO cline_WebBookmarks (Title, URL) VALUES (%s, %s)", (d['title'], d['url']))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})
    
    if request.method == 'DELETE':
        bid = request.args.get('id')
        cursor.execute("DELETE FROM cline_WebBookmarks WHERE BookmarkID=%s", (bid,))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})

# --- [RULE DEPLOY API] ---
@api_bp.route('/api/rules/deploy', methods=['POST'])
def deploy_rule():
    d = request.json
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (d['rule_id'],))
    rule = cursor.fetchone()
    cursor.execute("SELECT IPAddress, Account FROM cline_FolderIndex WHERE FullPath=%s", (d['project_path'],))
    target = cursor.fetchone()
    
    if not rule or not target: return jsonify({'status': 'error', 'message': 'Not Found'})
    
    content = rule['RuleContent'].replace('{SUBJECT}', d['project_name']).replace('{TARGET_PATH}', d['project_path'].replace('\\', '/'))
    r_dir = os.path.join(d['project_path'], ".clinerules").replace('\\', '/')
    r_file = os.path.join(r_dir, "absoluterule.md").replace('\\', '/')
    b64 = base64.b64encode(content.encode('utf-8')).decode('utf-8')
    
    if target['IPAddress'] in ['127.0.0.1', 'localhost']:
        os.makedirs(r_dir, exist_ok=True)
        with open(r_file, 'w', encoding='utf-8') as f: f.write(content)
        ok = True
    else:
        cmd = f"mkdir -p {shlex.quote(r_dir)} && echo '{b64}' | base64 -d > {shlex.quote(r_file)}"
        subprocess.run(['ssh', f"{target['Account']}@{target['IPAddress']}", cmd])
        ok = True
    
    if ok: 
        cursor.execute("UPDATE cline_FolderIndex SET LastRuleName=%s WHERE FullPath=%s", (rule['RuleName'], d['project_path']))
        conn.commit()
    conn.close(); return jsonify({'status': 'success'})

# --- [OTHER API] ---
@api_bp.route('/api/stats/dashboard', methods=['GET'])
def get_stats():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    g = cursor.fetchall(); conn.close(); return jsonify({'groups': g, 'counts': {'day':{'cnt':0}, 'week':{'cnt':0}, 'month':{'cnt':0}}})
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f: f.write(api_code)

print("\nâœ¨ [REAL RESTORE] v51: Settings Bookmark Manager & Link API Fixed.")
print("ğŸ‘‰ ì´ì œ ì…‹íŒ…ì°½ì—ì„œ ì›ë˜ ì“°ì‹œë˜ ì›¹ì£¼ì†Œ ì„¤ì •ì„ ì •ìƒì ìœ¼ë¡œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")