Sub ProcessSheetData()
    Dim lastRow As Long
    Dim cell As Range
    Dim dict As Object
    Dim key As String
    Dim col As Integer
    Dim b4Color As Long
    Dim isDictInitialized As Boolean

    ' B4의 배경색 가져오기
    b4Color = 주차2_시트.Range("B4").Interior.Color

    ' 마지막 사용된 행 계산
    lastRow = 주차2_시트.Cells(주차2_시트.Rows.Count, "D").End(xlUp).Row

    ' 딕셔너리 초기화
    Set dict = CreateObject("Scripting.Dictionary")
    isDictInitialized = False ' 딕셔너리가 초기화되었는지 확인하는 플래그

    ' D열의 각 셀 반복
    For Each cell In 주차2_시트.Range("D4:D" & lastRow)
        ' 병합된 셀이 아닌 경우
        If Not cell.MergeCells Then
            ' 배경색이 희거나 투명한지 확인
            If cell.Interior.Color = xlNone Or cell.Interior.Color = RGB(255, 255, 255) Then
                ' 딕셔너리 초기화 (플래그 초기화)
                Set dict = CreateObject("Scripting.Dictionary")
                isDictInitialized = False
            Else
                ' 값이 있는 경우 딕셔너리 초기화 플래그 확인
                If Not isDictInitialized Then
                    isDictInitialized = True ' 딕셔너리를 다시 사용 가능하도록 설정
                End If
                ' 값이 있는 경우 키 추출 및 합산 처리
                If Trim(cell.Value) <> "" Then
                    key = GetKey(cell.Value)
                    If Not dict.exists(key) Then
                        dict(key) = Array(0, 0, 0, 0, 0, 0) ' F~K 열 초기값
                    End If

                    ' F~K 열 값을 합산
                    For col = 1 To 6
                        dict(key)(col - 1) = dict(key)(col - 1) + 주차2_시트.Cells(cell.Row, 6 + col).Value
                    Next col
                End If
            End If
        Else
            ' 병합된 셀이고 배경색이 B4와 같은 경우
            If cell.Interior.Color = b4Color Then
                Dim cValue As String
                cValue = 주차2_시트.Cells(cell.Row, "C").Value

                ' C열 값이 키와 일치하는 경우
                If dict.exists(cValue) Then
                    For col = 1 To 6
                        주차2_시트.Cells(cell.Row, 6 + col).Value = dict(cValue)(col - 1)
                    Next col
                End If
            End If
        End If
    Next cell

    MsgBox "작업 완료!", vbInformation
End Sub

' 키를 추출하는 함수
Function GetKey(value As String) As String
    Dim i As Long
    Dim char As String
    Dim keyStart As Long
    Dim keyEnd As Long

    keyStart = 0
    keyEnd = InStr(1, value, "/") - 1 ' / 위치 전까지

    If keyEnd > 0 Then
        For i = keyEnd To 1 Step -1
            char = Mid(value, i, 1)
            ' 첫 번째 영어 문자를 발견한 위치
            If char Like "[A-Za-z]" Then
                keyStart = i
                Exit For
            End If
        Next i
    End If

    ' 키 추출
    If keyStart > 0 And keyEnd > 0 Then
        GetKey = Mid(value, keyStart, keyEnd - keyStart + 1)
    Else
        GetKey = "" ' 키가 없으면 빈 문자열 반환
    End If