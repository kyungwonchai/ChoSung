using System;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Windows.Forms;
using SharpAvi;

namespace ScreenRecorder
{
    public partial class MainForm : Form
    {
        private IAviVideoWriter writer;
        private ScreenCapture screenCapture;
        private Timer timer;

        public MainForm()
        {
            InitializeComponent();
        }

        private void ButtonA_Click(object sender, EventArgs e)
        {
            var processes = Process.GetProcesses()
                                   .Where(p => p.MainWindowTitle.Length != 0)
                                   .Select(p => p.ProcessName)
                                   .ToArray();
            ComboBoxA.Items.AddRange(processes);
        }

        private void RecordStartButton1_Click(object sender, EventArgs e)
        {
            var selectedProcess = ComboBoxA.SelectedItem.ToString();
            var process = Process.GetProcessesByName(selectedProcess).FirstOrDefault();
            if (process == null) return;

            var rect = new User32.Rect();
            User32.GetWindowRect(process.MainWindowHandle, ref rect);

            var width = rect.right - rect.left;
            var height = rect.bottom - rect.top;

            screenCapture = new ScreenCapture();
            writer = new AviWriter("temp.avi")
            {
                FramesPerSecond = 10,
                EmitIndex1 = true
            };

            var stream = writer.AddVideoStream();
            stream.Width = width;
            stream.Height = height;
            stream.Codec = KnownFourCCs.Codecs.Uncompressed;

            timer = new Timer { Interval = 100 };
            timer.Tick += (s, args) =>
            {
                var frame = screenCapture.CaptureRectangle(rect.ToRectangle());
                stream.WriteFrame(true, frame, 0, frame.Length);
            };
            timer.Start();
        }

        private void RecordStopButton1_Click(object sender, EventArgs e)
        {
            timer.Stop();
            writer.Close();

            var now = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            var destPath = Path.Combine(@"C:\rec", $"{now}.avi");
            Directory.CreateDirectory(@"C:\rec");
            File.Move("temp.avi", destPath);
        }
    }

    // ... 나머지 필요한 코드 (User32 클래스, ScreenCapture 클래스 등) ...
}
