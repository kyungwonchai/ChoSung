using System;
using System.Diagnostics;
using System.Drawing;
using System.Runtime.InteropServices;
using System.Windows.Forms;

namespace CaptureWindowExample
{
    public partial class Form2 : Form
    {
        [DllImport("user32.dll")]
        public static extern bool GetWindowRect(IntPtr hWnd, out RECT lpRect);

        [DllImport("user32.dll")]
        public static extern bool EnumWindows(EnumWindowsProc enumProc, IntPtr lParam);

        [DllImport("user32.dll")]
        public static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint processId);

        public delegate bool EnumWindowsProc(IntPtr hWnd, IntPtr lParam);

        public struct RECT
        {
            public int Left;
            public int Top;
            public int Right;
            public int Bottom;
        }

        // 전역 변수로 핸들 저장
        private IntPtr targetHWnd;

        public Form2()
        {
            InitializeComponent();
            FindTargetWindowHandle("notepad");  // 예시 프로세스 이름입니다. 실제 프로세스 이름으로 교체하세요.
        }

        private void FindTargetWindowHandle(string targetProcessName)
        {
            EnumWindows((hWnd, lParam) =>
            {
                uint processId;
                GetWindowThreadProcessId(hWnd, out processId);

                if (Process.GetProcessById((int)processId).ProcessName == targetProcessName)
                {
                    targetHWnd = hWnd;
                    return false;
                }
                return true;
            }, IntPtr.Zero);
        }

        private void Button1_Click(object sender, EventArgs e)
        {
            // 윈도우 크기 얻기
            RECT rect;
            GetWindowRect(targetHWnd, out rect);

            int width = rect.Right - rect.Left;
            int height = rect.Bottom - rect.Top;

            // 캡처 및 저장
            Bitmap bitmap = new Bitmap(width, height);
            Graphics g = Graphics.FromImage(bitmap);
            g.CopyFromScreen(rect.Left, rect.Top, 0, 0, new Size(width, height));
            bitmap.Save("capture.png");
        }
    }
}
