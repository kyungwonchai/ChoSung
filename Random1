네, Stored Procedure에서 쿼리 결과가 전부 0으로 나오는 이유는 아래와 같습니다:

최신 모델을 찾지 못했거나, 해당 모델과 일치하는 최근 10개의 데이터가 없을 경우

@마지막모델 값이 NULL이면 RecentData CTE가 비어 있어서 MIN() 값들이 모두 NULL이 되고, ISNULL에 의해 0이 리턴됨.
프로시저에서 SELECT를 제대로 실행하지 않았을 경우

Stored Procedure에서 SELECT가 실행되지 않으면 rs에 데이터가 들어오지 않음.
✅ 해결 방법
📌 1. 프로시저 내 SELECT 결과 확인을 위한 디버깅 추가
sql
코드 복사
ALTER PROCEDURE Get_Min_RecentData_ByModel
    @라인명 NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @마지막모델 NVARCHAR(255);
    DECLARE @최신시간 DATETIME;

    -- 가장 최근 모델과 time1 값 가져오기 (디버깅 추가)
    SELECT TOP 1 
        @마지막모델 = 모델,
        @최신시간 = time1
    FROM dbo.ExcelData
    WHERE 라인 = @라인명
    ORDER BY time1 DESC;

    -- 최신 모델 디버깅용 출력 (이 값을 직접 확인해보세요)
    PRINT '최신 모델: ' + ISNULL(@마지막모델, 'NULL');
    PRINT '최신 시간: ' + ISNULL(CAST(@최신시간 AS NVARCHAR), 'NULL');

    -- 최신 모델이 NULL이면 아무것도 조회되지 않으므로 에러 방지
    IF @마지막모델 IS NULL
    BEGIN
        PRINT 'ERROR: 해당 라인의 최신 모델을 찾을 수 없음.';
        RETURN;
    END

    WITH RecentData AS (
        SELECT TOP 10 *
        FROM dbo.ExcelData
        WHERE 라인 = @라인명 AND 모델 = @마지막모델
        ORDER BY time1 DESC
    )
    -- 데이터가 있는지 확인
    SELECT * FROM RecentData;  -- 🟢 SQL 실행 후 결과 확인 (디버깅용)

    -- 최종 결과 반환
    SELECT 
        @라인명 AS 라인,
        @마지막모델 AS 모델,
        @최신시간 AS 최신시간,

        ISNULL(MIN(CASE WHEN BCT1_1 >= 1 THEN BCT1_1 ELSE NULL END), 0) AS BCT1_1,
        ISNULL(MIN(CASE WHEN BCT1_2 >= 1 THEN BCT1_2 ELSE NULL END), 0) AS BCT1_2,
        ISNULL(MIN(CASE WHEN BCT1_3 >= 1 THEN BCT1_3 ELSE NULL END), 0) AS BCT1_3,
        ISNULL(MIN(CASE WHEN BCT1_4 >= 1 THEN BCT1_4 ELSE NULL END), 0) AS BCT1_4,
        ISNULL(MIN(CASE WHEN BCT1_5 >= 1 THEN BCT1_5 ELSE NULL END), 0) AS BCT1_5,
        ISNULL(MIN(CASE WHEN BCT1_6 >= 1 THEN BCT1_6 ELSE NULL END), 0) AS BCT1_6,
        ISNULL(MIN(CASE WHEN BCT1_7 >= 1 THEN BCT1_7 ELSE NULL END), 0) AS BCT1_7,
        ISNULL(MIN(CASE WHEN BCT1_8 >= 1 THEN BCT1_8 ELSE NULL END), 0) AS BCT1_8
    FROM RecentData;
END;
🔹 추가된 디버깅 코드
PRINT 문을 추가하여 최신 모델과 최신 시간 값이 정상적으로 조회되는지 확인
SELECT * FROM RecentData; 실행하여 RecentData가 비어있는지 확인
✅ 2. VBA에서 Recordset 받아서 메시지 박스로 출력
📌 VBA에서 Stored Procedure 결과를 메시지 박스로 확인하는 코드
vba
코드 복사
Sub ExecuteStoredProcedure(LineName As String)
    Dim conn As Object
    Dim rs As Object
    Dim sqlQuery As String
    Dim dbPath As String
    Dim result As String

    ' MSSQL 연결 설정
    dbPath = "Provider=SQLOLEDB;Data Source=서버이름;Initial Catalog=DB이름;User ID=사용자이름;Password=비밀번호;"
    Set conn = CreateObject("ADODB.Connection")
    conn.Open dbPath

    ' 프로시저 실행 쿼리
    sqlQuery = "EXEC Get_Min_RecentData_ByModel '" & LineName & "'"

    ' Recordset 열기
    Set rs = conn.Execute(sqlQuery)

    ' 결과 출력 (메시지 박스)
    If Not rs.EOF Then
        result = "라인: " & rs.Fields("라인").Value & vbCrLf
        result = result & "모델: " & rs.Fields("모델").Value & vbCrLf
        result = result & "최신시간: " & rs.Fields("최신시간").Value & vbCrLf

        Dim i As Integer
        For i = 3 To rs.Fields.Count - 1  ' BCT, TCT 데이터 출력
            result = result & rs.Fields(i).Name & ": " & rs.Fields(i).Value & vbCrLf
        Next i

        MsgBox result, vbInformation, "Stored Procedure 결과"
    Else
        MsgBox "데이터 없음 (라인: " & LineName & ")", vbCritical, "에러"
    End If

    ' 종료
    rs.Close
    conn.Close
    Set rs = Nothing
    Set conn = Nothing
End Sub
✅ 3. 실행 방법
📌 Immediate 창 (Ctrl + G)에서 실행
vba
코드 복사
ExecuteStoredProcedure "L1"
메시지 박스로 결과 출력
라인, 모델, 최신 시간, 최소값(BCT, TCT 등) 확인 가능
✅ 4. 결과 예시
📌 VBA MsgBox 출력 예시
makefile
코드 복사
라인: L1
모델: A100
최신시간: 2025-03-18 14:10
BCT1_1: 9
BCT1_2: 4
BCT1_3: 6
...