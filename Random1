import os
import csv
import re
from datetime import datetime

# 디렉토리 경로 및 출력 CSV 파일 경로 설정
directory_path = 'c:/abc/'
output_csv_path = 'output.csv'

# 정규 표현식 패턴 설정
time_pattern = r'\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}'  # 날짜와 시간 추출 패턴
key_pattern = r'고유키:[^\s]+'  # 고유키 추출 패턴 (공백 전까지)
send_value_pattern = r'보낸값:[^\s]+'  # 보낸값 추출 패턴 (공백 전까지)
recv_value_pattern = r'받은값:[^\s]+'  # 받은값 추출 패턴 (공백 전까지)

# 옵션 설정: 최대 기록할 행 수
max_rows = 2
data_for_csv = []  # CSV로 저장할 데이터를 담을 리스트

# 디렉토리 내 모든 파일 순회
for filename in os.listdir(directory_path):
    # "detailCMD"가 포함된 .txt 파일만 처리
    if filename.endswith('.txt') and 'detailCMD' in filename:
        file_path = os.path.join(directory_path, filename)
        print(f"\nProcessing file: {filename}")
        
        with open(file_path, 'r', encoding='utf-8') as file:
            lines = file.readlines()  # 파일의 모든 줄을 읽음
            i = 0
            
            # 각 줄을 순회하면서 "보낸값"과 "받은값" 쌍 찾기
            while i < len(lines):
                print(f"\nChecking line {i + 1}: {lines[i].strip()}")
                
                # "보낸값" 줄을 찾음
                send_match = re.search(send_value_pattern, lines[i])
                
                if send_match:
                    print(f"Found '보낸값' in line {i + 1}")
                    
                    # "보낸값" 줄에서 시간, 고유키, 보낸값 추출
                    time_match = re.search(time_pattern, lines[i])
                    key_match = re.search(key_pattern, lines[i])
                    
                    if time_match and key_match:
                        # 시간과 고유키 추출
                        time_str = time_match.group()
                        unique_key = key_match.group().split(':')[1]  # 고유키 값만 추출
                        send_value = send_match.group().split(':')[1]  # 보낸값 값만 추출
                        print(f"Extracted - Time: {time_str}, Unique Key: {unique_key}, Sent Value: {send_value}")

                        # 다음 줄에서 "받은값" 추출
                        if i + 1 < len(lines):
                            print(f"Checking line {i + 2} for '받은값': {lines[i + 1].strip()}")
                            recv_match = re.search(recv_value_pattern, lines[i + 1])
                        else:
                            recv_match = None

                        if recv_match:
                            recv_value = recv_match.group().split(':')[1]  # 받은값 값만 추출
                            print(f"Found - Received Value: {recv_value}")
                            
                            # 시간 형식을 "yyMMdd HHmmss"로 변환
                            original_time = datetime.strptime(time_str, '%Y-%m-%d %H:%M:%S.%f')
                            formatted_time = original_time.strftime('%y%m%d %H%M%S')

                            # CSV에 추가할 데이터 리스트에 삽입
                            data_for_csv.append([formatted_time, unique_key, send_value, recv_value])

                            # 데이터가 max_rows만큼 모이면 CSV로 저장하고 종료
                            if len(data_for_csv) >= max_rows:
                                with open(output_csv_path, 'w', newline='', encoding='utf-8') as csvfile:
                                    csv_writer = csv.writer(csvfile)
                                    csv_writer.writerow(['Time', 'Unique Key', 'Sent Value', 'Received Value'])
                                    csv_writer.writerows(data_for_csv)
                                print(f'\nCSV 파일 생성 완료: {output_csv_path}')
                                exit()  # 스크립트 종료
                        else:
                            print(f"Received Value not found in line {i + 2}")
                    
                    # "보낸값" 다음 줄로 이동
                    i += 2
                else:
                    # "보낸값"이 없는 경우 다음 줄로 이동
                    print(f"No '보낸값' found in line {i + 1}")
                    i += 1

# 혹시 max_rows보다 적게 데이터가 모일 경우에 대비하여 최종 저장
if data_for_csv and len(data_for_csv) < max_rows:
    with open(output_csv_path, 'w', newline='', encoding='utf-8') as csvfile:
        csv_writer = csv.writer(csvfile)
        csv_writer.writerow(['Time', 'Unique Key', 'Sent Value', 'Received Value'])
        csv_writer.writerows(data_for_csv)
    print(f'\nCSV 파일 생성 완료: {output_csv_path}')
else:
    print("\nNo sufficient data extracted.")
