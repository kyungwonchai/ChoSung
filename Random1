using System;
using System.Data;
using System.Data.SqlClient;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace YourNamespace
{
    public partial class MainForm : Form
    {
        private SqlConnection connection;
        private string connectionString = "your_connection_string";
        private Timer timer;
        private readonly object lockObj = new object();

        public MainForm()
        {
            InitializeComponent();
        }

        private void MainForm_Load(object sender, EventArgs e)
        {
            ConnectToDatabase();
            StartTimer();
        }

        private void ConnectToDatabase()
        {
            try
            {
                connection = new SqlConnection(connectionString);
                connection.Open();
                MessageBox.Show("Connected to the database.");
            }
            catch (Exception ex)
            {
                MessageBox.Show("Failed to connect to the database.");
            }
        }

        private void StartTimer()
        {
            // 타이머 설정
            timer = new Timer(ProcessData, null, TimeSpan.Zero, TimeSpan.FromSeconds(5));
        }

        private void ProcessData(object state)
        {
            lock (lockObj)
            {
                // check 테이블의 stat1 상태 확인
                string statQuery = "SELECT stat1 FROM check";
                SqlCommand statCommand = new SqlCommand(statQuery, connection);
                string stat = (string)statCommand.ExecuteScalar();

                // stat1이 "ON"인 경우에만 Process1과 Process2 함수 실행
                if (stat == "ON")
                {
                    Task.Run(async () =>
                    {
                        await Process1();
                        await Process2();
                    }).Wait();
                }
            }
        }

        private async Task Process1()
        {
            //
