using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Windows.Forms;

namespace YourNamespace
{
    public partial class YourForm : Form
    {
        private SqlConnection connection;
        private SqlCommand command;

        public YourForm()
        {
            InitializeComponent();
            connection = new SqlConnection("YourConnectionString");
            command = new SqlCommand("SELECT DISTINCT Email FROM YourTable", connection);
        }

        private void RefreshPanel1()
        {
            // 버튼 클릭 시 panel1 초기화
            panel1.Controls.Clear();

            try
            {
                connection.Open();
                SqlDataReader reader = command.ExecuteReader();

                if (reader.HasRows)
                {
                    while (reader.Read())
                    {
                        string email = reader["Email"].ToString();

                        // 메일 주소별로 추가 데이터 조회
                        List<string> additionalData = GetAdditionalData(email);

                        // 동적으로 데이터 표시할 컨트롤 생성
                        Label emailLabel = new Label();
                        emailLabel.Text = "Email: " + email;

                        foreach (string data in additionalData)
                        {
                            Label dataLabel = new Label();
                            dataLabel.Text = data;
                            panel1.Controls.Add(dataLabel);
                        }

                        // 메일 주소와 추가 데이터 사이에 구분선 추가
                        Label separatorLabel = new Label();
                        separatorLabel.Text = "-----------------------";
                        panel1.Controls.Add(separatorLabel);
                    }
                }
                else
                {
                    // 행이 없는 경우 처리
                    Label noDataLabel = new Label();
                    noDataLabel.Text = "행이 없습니다.";
                    panel1.Controls.Add(noDataLabel);
                }

                reader.Close();
            }
            catch (Exception ex)
            {
                // 예외 처리
                MessageBox.Show("오류 발생: " + ex.Message);
            }
            finally
            {
                connection.Close();
            }
        }

        private List<string> GetAdditionalData(string email)
        {
            List<string> additionalData = new List<string>();

            try
            {
                // 추가 데이터 조회 쿼리를 구성하여 실행
                string query = "SELECT Area, Quantity, RemainingDays, AdminInfo, DateSetting FROM YourTable WHERE Email = @Email";
                SqlCommand additionalCommand = new SqlCommand(query, connection);
                additionalCommand.Parameters.AddWithValue("@Email", email);

                SqlDataReader reader = additionalCommand.ExecuteReader();

                if (reader.HasRows)
                {
                    while (reader.Read())
                    {
                        string area = reader["Area"].ToString();
                        string quantity = reader["Quantity"].ToString();
                        string remainingDays = reader["RemainingDays"].ToString();
                        string adminInfo = reader["AdminInfo"].ToString();
                        string dateSetting = reader["DateSetting"].ToString();

                        // 추가 데이터를 정리하여 문자열로 생성
                        string data = $"구역: {area}, 수량: {quantity}, 남은 날짜: {remainingDays}, 관리자 정보: {adminInfo}, 날짜 설정값: {dateSetting}";

                        additionalData.Add(data);
                    }
                }

                reader.Close();
            }
            catch (Exception ex)
            {
                // 예외 처리
                MessageBox.Show("오류 발생: " + ex.Message);
            }

            return additionalData;
        }

        private void YourButton_Click(object sender, EventArgs e)
        {
            RefreshPanel1();
        }
    }
}
