import os
import csv
import re
from datetime import datetime

# Directory containing text files
directory_path = 'c:/abc/'

# Output CSV file
output_csv_path = 'output.csv'

# Regular expressions to match the data in each line
time_pattern = r'\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}'
key_pattern = r'고유키:\w+'
send_value_pattern = r'보낸 값:.*?\*\*'
recv_value_pattern = r'받은 값:.*?\*\*'

# Prepare data for CSV output
data_for_csv = []

# Process each file in the directory
for filename in os.listdir(directory_path):
    # Only process .txt files containing "detailCMD"
    if filename.endswith('.txt') and 'detailCMD' in filename:
        file_path = os.path.join(directory_path, filename)
        
        with open(file_path, 'r', encoding='utf-8') as file:
            for line in file:
                # Extract time, unique key, sent value, and received value using regex
                time_match = re.search(time_pattern, line)
                key_match = re.search(key_pattern, line)
                send_value_match = re.search(send_value_pattern, line)
                recv_value_match = re.search(recv_value_pattern, line)

                # Ensure all fields are found in the line
                if time_match and key_match and send_value_match and recv_value_match:
                    # Extract and format each field
                    time_str = time_match.group()
                    unique_key = key_match.group().split(':')[1]
                    send_value = send_value_match.group().split(':')[-1].strip()
                    recv_value = recv_value_match.group().split(':')[-1].strip()

                    # Format time as yyMMdd HHmmss
                    original_time = datetime.strptime(time_str, '%Y-%m-%d %H:%M:%S.%f')
                    formatted_time = original_time.strftime('%y%m%d %H%M%S')

                    # Append row to data list
                    data_for_csv.append([formatted_time, unique_key, send_value, recv_value])

# Write data to CSV
with open(output_csv_path, 'w', newline='', encoding='utf-8') as csvfile:
    csv_writer = csv.writer(csvfile)
    csv_writer.writerow(['Time', 'Unique Key', 'Sent Value', 'Received Value'])
    csv_writer.writerows(data_for_csv)
