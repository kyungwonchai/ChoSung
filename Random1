록 해야 합니다. 다음과 같이 수정해보겠습니다.

1. 데이터베이스 저장 프로시저 수정
조회 시 날짜마다 번호별로 중복되지 않도록 조회하는 프로시저를 수정합니다.

sql
코드 복사
CREATE PROCEDURE GetReportsByDateRange
    @StartDate DATE,
    @EndDate DATE
AS
BEGIN
    SELECT
        Date,
        Number,
        MAX(CASE WHEN ShiftType = '주' THEN Report ELSE NULL END) AS DayShift,
        MAX(CASE WHEN ShiftType = '후' THEN Report ELSE NULL END) AS EveningShift,
        MAX(CASE WHEN ShiftType = '야' THEN Report ELSE NULL END) AS NightShift,
        MAX(CASE WHEN ShiftType = '공통' THEN Report ELSE NULL END) AS CommonReport
    FROM
        ShiftReport
    WHERE
        Date BETWEEN @StartDate AND @EndDate
    GROUP BY
        Date, Number
    ORDER BY
        Date, Number;
END
2. C# 코드 수정
C# 코드에서 검색 시 프로시저를 호출하도록 수정합니다.

csharp
코드 복사
using System;
using System.Data;
using System.Data.SqlClient;
using System.Net;
using System.Windows;
using DevExpress.Xpf.Editors;
using DevExpress.Xpf.Grid;

namespace ShiftReportApp
{
    public partial class MainWindow : Window
    {
        private string connectionString = "your_connection_string_here";
        private DataTable searchTable;
        private DataTable logTable;

        public MainWindow()
        {
            InitializeComponent();
            Loaded += MainWindow_Loaded;
        }

        private void MainWindow_Loaded(object sender, RoutedEventArgs e)
        {
            LoadTodayReport(null, null);
            DateTime yesterday = DateTime.Now.Date.AddDays(-1);
            DateTime today = DateTime.Now.Date;
            LoadSearchReports(yesterday.ToString("yyyy-MM-dd"), today.ToString("yyyy-MM-dd"));
        }

        private void LoadTodayReport(object sender, RoutedEventArgs e)
        {
            DateTime today = DateTime.Now.Date;
            LoadReport(today.ToString("yyyy-MM-dd"));
        }

        private void LoadYesterdayReport(object sender, RoutedEventArgs e)
        {
            DateTime yesterday = DateTime.Now.Date.AddDays(-1);
            LoadReport(yesterday.ToString("yyyy-MM-dd"));
        }

        private void LoadReport(string date)
        {
            DataTable dataTable = new DataTable();

            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                SqlCommand cmd = new SqlCommand("GetReportsByDate", conn);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Date", date);

                SqlDataAdapter adapter = new SqlDataAdapter(cmd);
                adapter.Fill(dataTable);
            }

            if (dataTable.Rows.Count == 0)
            {
                AddEmptyReportsForDate(date);
                using (SqlConnection conn = new SqlConnection(connectionString))
                {
                    SqlCommand cmd = new SqlCommand("GetReportsByDate", conn);
                    cmd.CommandType = CommandType.StoredProcedure;
                    cmd.Parameters.AddWithValue("@Date", date);

                    SqlDataAdapter adapter = new SqlDataAdapter(cmd);
                    adapter.Fill(dataTable);
                }
            }

            ClearReports();

            if (dataTable.Rows.Count > 0)
            {
                foreach (DataRow row in dataTable.Rows)
                {
                    int number = Convert.ToInt32(row["Number"]);
                    string shiftType = row["ShiftType"].ToString();

                    if (shiftType == "주")
                    {
                        ((TextBox)FindName($"DayShiftReport{number}")).Text = row["Report"].ToString();
                    }
                    else if (shiftType == "후")
                    {
                        ((TextBox)FindName($"EveningShiftReport{number}")).Text = row["Report"].ToString();
                    }
                    else if (shiftType == "야")
                    {
                        ((TextBox)FindName($"NightShiftReport{number}")).Text = row["Report"].ToString();
                    }
                    else if (shiftType == "공통")
                    {
                        ((TextBox)FindName($"CommonReport{number}")).Text = row["Report"].ToString();
                    }

                    ((TextBlock)FindName($"Date{number}")).Text = date;
                }
            }
        }

        private void AddEmptyReportsForDate(string date)
        {
            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                conn.Open();
                for (int i = 1; i <= 4; i++)
                {
                    foreach (string shiftType in new[] { "주", "후", "야", "공통" })
                    {
                        SqlCommand cmd = new SqlCommand("SaveReport", conn);
                        cmd.CommandType = CommandType.StoredProcedure;
                        cmd.Parameters.AddWithValue("@Date", date);
                        cmd.Parameters.AddWithValue("@Number", i);
                        cmd.Parameters.AddWithValue("@ShiftType", shiftType);
                        cmd.Parameters.AddWithValue("@Report", "");
                        cmd.Parameters.AddWithValue("@IPAddress", GetLocalIPAddress());
                        cmd.ExecuteNonQuery();
                    }
                }
            }
        }

        private void ClearReports()
        {
            for (int i = 1; i <= 4; i++)
            {
                ((TextBox)FindName($"DayShiftReport{i}")).Text = "";
                ((TextBox)FindName($"EveningShiftReport{i}")).Text = "";
                ((TextBox)FindName($"NightShiftReport{i}")).Text = "";
                ((TextBox)FindName($"CommonReport{i}")).Text = "";
            }
        }

        private void TextBox_LostFocus(object sender, RoutedEventArgs e)
        {
            TextBox textBox = sender as TextBox;
            string report = textBox.Text;
            string name = textBox.Name;
            string shiftType = "";
            int number = 0;

            if (name.StartsWith("DayShiftReport"))
            {
                shiftType = "주";
                number = int.Parse(name.Substring("DayShiftReport".Length));
            }
            else if (name.StartsWith("EveningShiftReport"))
            {
                shiftType = "후";
                number = int.Parse(name.Substring("EveningShiftReport".Length));
            }
            else if (name.StartsWith("NightShiftReport"))
            {
                shiftType = "야";
                number = int.Parse(name.Substring("NightShiftReport".Length));
            }
            else if (name.StartsWith("CommonReport"))
            {
                shiftType = "공통";
                number = int.Parse(name.Substring("CommonReport".Length));
            }

            string date = ((TextBlock)FindName($"Date{number}")).Text;
            string ipAddress = GetLocalIPAddress();
            SaveReport(date, number, shiftType, report, ipAddress);
        }

        private void SaveReport(string date, int number, string shiftType, string report, string ipAddress)
        {
            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                conn.Open();
                SqlCommand cmd = new SqlCommand("SaveReport", conn);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Date", date);
                cmd.Parameters.AddWithValue("@Number", number);
                cmd.Parameters.AddWithValue("@ShiftType", shiftType);
                cmd.Parameters.AddWithValue("@Report", report);
                cmd.Parameters.AddWithValue("@IPAddress", ipAddress);

                cmd.ExecuteNonQuery();

                // 로그 기록
                SaveLog(date, number, shiftType, report, ipAddress);
            }
        }

        private void SaveLog(string date, int number, string shiftType, string report, string ipAddress)
        {
            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                conn.Open();
                SqlCommand cmd = new SqlCommand("SaveLog", conn);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Date", date);
                cmd.Parameters.AddWithValue("@Number", number);
                cmd.Parameters.AddWithValue("@ShiftType", shiftType);
                cmd.Parameters.AddWithValue("@Report", report);
                cmd.Parameters.AddWithValue("@IPAddress", ipAddress);
                cmd.Parameters.AddWithValue("@Timestamp", DateTime.Now);

                cmd.ExecuteNonQuery();
            }
        }

        private string GetLocalIPAddress()
        {
            string localIP = "127.0.0.1";
            try
            {
                var host = Dns.GetHostEntry(Dns.GetHostName());
                foreach (var ip in host.AddressList)
                {
                    if (ip.AddressFamily == System.Net.Sockets.AddressFamily.InterNetwork)
                    {
                        localIP = ip.ToString();
                        break;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("IP 주소를 가져오는 중 오류가 발생했습니다: " + ex.Message);
            }
            return localIP;
        }

        private void OnSearchReports(object sender, RoutedEventArgs e)
        {
            DateTime? startDate = startDatePicker.DateTime;
            DateTime? endDate = endDatePicker.DateTime;

            if (startDate.HasValue && endDate.HasValue)
            {
                LoadSearchReports(startDate.Value.ToString("yyyy-MM-dd"), endDate.Value.ToString("yyyy-MM-dd"));
            }
        }

        private void LoadSearchReports(string startDate, string endDate)
        {
            searchTable = new DataTable();

            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                SqlCommand cmd = new SqlCommand("GetReportsByDateRange", conn);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@StartDate", startDate);
                cmd.Parameters.AddWithValue("@EndDate", endDate);

                SqlDataAdapter adapter = new SqlDataAdapter(cmd);
                adapter.Fill(searchTable);
            }

            gridControlSearch.ItemsSource = searchTable.DefaultView;
        }

        private void OnLogSearch(object sender, RoutedEventArgs e)
        {
            DateTime? selectedDate = logDatePicker.DateTime;
            if (selectedDate.HasValue)
            {
                LoadLogReport(selectedDate.Value.ToString("yyyy-MM-dd"));
            }
        }

        private void LoadLogReport(string date)
        {
            logTable = new DataTable();

            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                SqlCommand cmd = new SqlCommand("GetLogByDate", conn);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@Date", date);

                SqlDataAdapter adapter = new SqlDataAdapter(cmd);
                adapter.Fill(logTable);
            }

            if (logTable.Rows.Count > 0)
            {
                gridControlLog.ItemsSource = logTable.DefaultView;
            }
            else
            {
                MessageBox.Show("선택한 날짜에 대한 로그가 없습니다.");
            }
        }
    }
}
이제 이 코드는 각 날짜마다 번호별로 중복되지 않도록 쿼리에서 데이터를 조회합니다. 검색 결과가 날짜별로 하나의 번호만 포함되도록 했습니다. 추가적인