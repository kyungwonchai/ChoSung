using DevExpress.XtraPivotGrid;
using System;
using System.Data;
using System.Net.NetworkInformation;
using System.Threading.Tasks;

public partial class Form1 : Form
{
    private PivotGridControl pivotGridControl1;
    private DataTable dataTable1;

    public Form1()
    {
        InitializeComponent();
    }

    private async void Form1_Load(object sender, EventArgs e)
    {
        // PivotGridControl 생성
        pivotGridControl1 = new PivotGridControl();
        pivotGridControl1.Dock = DockStyle.Fill;
        this.Controls.Add(pivotGridControl1);

        // DataTable 생성 및 데이터 추가
        CreateDataTable();
        AddDataToDataTable();

        // 연결여부 컬럼 추가 및 값 할당
        await AddConnectivityColumnAsync();

        // PivotGridControl에 DataTable 설정
        pivotGridControl1.DataSource = dataTable1;

        // 피벗그리드 컬럼 표시 설정
        SetColumnDisplay();
    }

    private void CreateDataTable()
    {
        dataTable1 = new DataTable("SampleData");

        // 열 추가
        dataTable1.Columns.Add("Category", typeof(string));
        dataTable1.Columns.Add("Product", typeof(string));
        dataTable1.Columns.Add("VISA_IP", typeof(string));
    }

    private void AddDataToDataTable()
    {
        // 데이터 추가
        dataTable1.Rows.Add("Category A", "Product 1", "192.168.0.1");
        dataTable1.Rows.Add("Category A", "Product 2", "192.168.0.2");
        dataTable1.Rows.Add("Category B", "Product 3", "192.168.0.3");
        dataTable1.Rows.Add("Category B", "Product 4", "192.168.0.4");
    }

    private async Task AddConnectivityColumnAsync()
    {
        dataTable1.Columns.Add("Connectivity", typeof(int));

        foreach (DataRow row in dataTable1.Rows)
        {
            string ipAddress = row["VISA_IP"].ToString();
            bool isPingable = await IsPingableAsync(ipAddress);

            row["Connectivity"] = isPingable ? 1 : 0;
        }
    }

    private async Task<bool> IsPingableAsync(string ipAddress)
    {
        using (Ping ping = new Ping())
        {
            try
            {
                PingReply reply = await ping.SendPingAsync(ipAddress, 100); // 타임아웃 100ms로 설정

                return reply.Status == IPStatus.Success;
            }
            catch (Exception)
            {
                return false;
            }
        }
    }

    private void SetColumnDisplay()
    {
        PivotGridField connectivityField = new PivotGridField("Connectivity", PivotArea.ColumnArea);
        connectivityField.ValueFormat.FormatType = DevExpress.Utils.FormatType.Custom;
        connectivityField.ValueFormat.FormatString = "0;[Red]0;[Black]";

        pivotGridControl1.Fields.Add(connectivityField);
    }
}
