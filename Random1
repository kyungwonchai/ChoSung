using UnityEngine;
using UnityEngine.UI;
using System.Collections;
using System.Collections.Generic;
using System.Text.RegularExpressions;

public class RackSystemManager : MonoBehaviour
{
    [Header("핵심 연결 대상")]
    public Transform rackContainer;

    [Header("머티리얼")]
    public Material defaultLampMaterial;
    public Material litLampMaterial;

    [Header("애니메이션")]
    public float animationDuration = 0.5f;
    public float slideOutDistance = 0.4f;

    private Dictionary<string, GameObject> maskObjects = new Dictionary<string, GameObject>();
    private Dictionary<string, Renderer> lampRenderers = new Dictionary<string, Renderer>();
    private Coroutine lastAnimationCoroutine;
    private GameObject lastMovedMask;
    private Renderer lastLitLamp;
    private Vector3 lastMaskOriginalLocalPosition;


    void Start()
    {
        InitializeAllRacks();
    }

    // ★★★ 현재 계층 구조에 맞게 초기화 로직 전면 수정 ★★★
    void InitializeAllRacks()
    {
        Debug.Log("랙 시스템 초기화를 시작합니다...");

        if (rackContainer == null) 
        {
            Debug.LogError("Rack Container가 연결되지 않았습니다! Inspector 창을 확인해주세요.");
            return;
        }

        // rackContainer의 1단계 자식들(A_12d, A_22d 등)을 순회
        foreach (Transform rackParent in rackContainer)
        {
            string rackName = rackParent.name; // 예: "A_12d"

            // 각 랙 하위의 모든 렌더러(램프, 마스크 등)를 찾음
            Renderer[] childRenderers = rackParent.GetComponentsInChildren<Renderer>(true);
            foreach(Renderer rend in childRenderers)
            {
                string localName = rend.name; // 예: "Lamp_A01"
                
                // 글로벌 고유 키 생성 (예: "A_12d_Lamp_A01")
                string globalKey = $"{rackName}_{localName}";

                if (localName.StartsWith("Lamp_"))
                {
                    if (!lampRenderers.ContainsKey(globalKey))
                    {
                        lampRenderers.Add(globalKey, rend);
                        if (defaultLampMaterial != null) rend.material = defaultLampMaterial;
                    }
                }
                else if (localName.StartsWith("Mask_"))
                {
                     if (!maskObjects.ContainsKey(globalKey))
                    {
                        maskObjects.Add(globalKey, rend.gameObject);
                    }
                }
            }
        }
        Debug.Log($"초기화 완료: {lampRenderers.Count}개의 램프, {maskObjects.Count}개의 마스크가 등록되었습니다.");
    }

    // ★★★ 새로운 바코드 형식에 맞게 파싱 로직 전면 수정 ★★★
    public void ProcessBarcode(string barcode)
    {
        Debug.Log($"입력된 바코드 처리 시작: {barcode}");
        ResetPreviousSlot();

        if (string.IsNullOrEmpty(barcode) || !barcode.StartsWith("MMF10")) return;
        
        // 정규식을 사용하여 바코드 파싱 (예: MMF10A_42dA01)
        // 그룹 1: 랙 이름 (A_42d), 그룹 2: 층 (A), 그룹 3: 칸번호 (01)
        var match = Regex.Match(barcode.Substring(5), @"(.+?)([A-C])(\d{2})$");

        if (!match.Success)
        {
            Debug.LogError($"잘못된 바코드 형식입니다: {barcode}");
            return;
        }

        string rackName = match.Groups[1].Value; // "A_42d"
        string floor = match.Groups[2].Value;    // "A"
        string slotNum = match.Groups[3].Value;  // "01"

        // 글로벌 고유 키 조합
        string lampKey = $"{rackName}_Lamp_{floor}{slotNum}";
        string maskKey = $"{rackName}_Mask_{floor}{slotNum}";
        
        Debug.Log($"찾는 램프 키: {lampKey}");
        Debug.Log($"찾는 마스크 키: {maskKey}");

        if (lampRenderers.TryGetValue(lampKey, out Renderer targetLampRenderer))
        {
            Debug.Log($"성공: {lampKey} 램프를 찾았습니다. 불을 켭니다.");
            if (litLampMaterial != null) targetLampRenderer.material = litLampMaterial;
            lastLitLamp = targetLampRenderer;
        }
        else
        {
            Debug.LogWarning($"경고: {lampKey} 이름의 램프를 찾지 못했습니다.");
        }

        if (maskObjects.TryGetValue(maskKey, out GameObject targetMask))
        {
            Debug.Log($"성공: {maskKey} 마스크를 찾았습니다. 애니메이션을 시작합니다.");
            lastMovedMask = targetMask;
            lastMaskOriginalLocalPosition = targetMask.transform.localPosition;
            lastAnimationCoroutine = StartCoroutine(AnimateMask(targetMask, true));
        }
        else
        {
            Debug.LogWarning($"경고: {maskKey} 이름의 마스크를 찾지 못했습니다.");
        }
    }

    void ResetPreviousSlot()
    {
        if (lastAnimationCoroutine != null) StopCoroutine(lastAnimationCoroutine);
        if (lastLitLamp != null && defaultLampMaterial != null)
        {
            lastLitLamp.material = defaultLampMaterial;
            lastLitLamp = null;
        }
        if (lastMovedMask != null)
        {
            StartCoroutine(AnimateMask(lastMovedMask, false));
            lastMovedMask = null;
        }
    }

    IEnumerator AnimateMask(GameObject mask, bool isSlidingOut)
    {
        Rigidbody rb = mask.GetComponent<Rigidbody>();
        if (rb != null) rb.isKinematic = true;

        Vector3 startPosition = mask.transform.localPosition;
        Vector3 endPosition;

        Vector3 slideDirection = Vector3.up; 

        if (isSlidingOut) { endPosition = startPosition + slideDirection * slideOutDistance; }
        else { endPosition = lastMaskOriginalLocalPosition; }

        float timeElapsed = 0;
        while (timeElapsed < animationDuration)
        {
            mask.transform.localPosition = Vector3.Lerp(startPosition, endPosition, timeElapsed / animationDuration);
            timeElapsed += Time.deltaTime;
            yield return null;
        }
        mask.transform.localPosition = endPosition;

        if (rb != null) rb.isKinematic = false;
    }

    public void ActivateFromInputField(InputField inputField)
    {
        if (inputField != null && !string.IsNullOrEmpty(inputField.text))
        {
            ProcessBarcode(inputField.text.ToUpper());
        }
    }
}