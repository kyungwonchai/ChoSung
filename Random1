using System;
using System.Data.SqlClient;
using System.IO;
using System.Windows.Forms;

// This variable holds the name of the currently selected header in the list box.
private string currentHeaderName;

private void listBox1_DoubleClick(object sender, EventArgs e)
{
    currentHeaderName = "dia" + listBox1.SelectedItem.ToString();

    using (SqlConnection connection = new SqlConnection(/*your connection string*/))
    {
        connection.Open();

        using (SqlCommand cmd = new SqlCommand("SELECT DiagramContent FROM TBL1 WHERE HeaderName = @headerName", connection))
        {
            cmd.Parameters.AddWithValue("@headerName", currentHeaderName);

            string diagramContent = cmd.ExecuteScalar() as string;
            if (diagramContent != null)
            {
                byte[] bytes = Convert.FromBase64String(diagramContent);
                using (MemoryStream ms = new MemoryStream(bytes))
                {
                    ms.Position = 0;
                    diagramControl1.LoadDocument(ms);
                }
            }
        }
    }
}

private void saveButton_Click(object sender, EventArgs e)
{
    if (currentHeaderName == null)
    {
        MessageBox.Show("Please select a header first.");
        return;
    }

    string diagramContent;
    using (MemoryStream ms = new MemoryStream())
    {
        diagramControl1.SaveDocument(ms);
        ms.Position = 0;
        byte[] bytes = ms.ToArray();
        diagramContent = Convert.ToBase64String(bytes);
    }

    using (SqlConnection connection = new SqlConnection(/*your connection string*/))
    {
        connection.Open();

        using (SqlCommand cmd = new SqlCommand("SELECT COUNT(*) FROM TBL1 WHERE HeaderName = @headerName", connection))
        {
            cmd.Parameters.AddWithValue("@headerName", currentHeaderName);
            int count = (int)cmd.ExecuteScalar();

            if (count == 0)
            {
                // Insert new entry
                cmd.CommandText = "INSERT INTO TBL1 (HeaderName, DiagramContent) VALUES (@headerName, @diagramContent)";
                cmd.Parameters.AddWithValue("@diagramContent", diagramContent);
                cmd.ExecuteNonQuery();
            }
            else
            {
                // Update existing entry
                cmd.CommandText = "UPDATE TBL1 SET DiagramContent = @diagramContent WHERE HeaderName = @headerName";
                cmd.Parameters.AddWithValue("@diagramContent", diagramContent);
                cmd.ExecuteNonQuery();
            }
        }
    }
}
