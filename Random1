using System;
using System.Drawing;
using System.Runtime.InteropServices;

namespace HiddenWindowCapture
{
    class Program
    {
        // Win32 API 함수 선언
        [DllImport("user32.dll")]
        public static extern IntPtr GetDC(IntPtr hWnd);

        [DllImport("gdi32.dll")]
        public static extern IntPtr CreateCompatibleDC(IntPtr hdc);

        [DllImport("gdi32.dll")]
        public static extern IntPtr CreateCompatibleBitmap(IntPtr hdc, int nWidth, int nHeight);

        [DllImport("gdi32.dll")]
        public static extern IntPtr SelectObject(IntPtr hdc, IntPtr bmp);

        [DllImport("gdi32.dll")]
        public static extern bool BitBlt(IntPtr hdcDest, int xDest, int yDest, int wDest, int hDest, IntPtr hdcSource, int xSrc, int ySrc, int rop);

        static void Main(string[] args)
        {
            // 대상 윈도우의 핸들을 얻습니다. (예: Notepad)
            IntPtr hWnd = new IntPtr(0x00000000000); // 실제 핸들 값을 넣으세요.
            IntPtr hdcSrc = GetDC(hWnd);

            // 캡처할 영역의 크기
            int width = 800;
            int height = 600;

            IntPtr hdcDest = CreateCompatibleDC(hdcSrc);
            IntPtr hBitmap = CreateCompatibleBitmap(hdcSrc, width, height);

            // 대상 비트맵을 선택합니다.
            SelectObject(hdcDest, hBitmap);
            // BitBlt 함수를 사용해 이미지를 캡처합니다.
            BitBlt(hdcDest, 0, 0, width, height, hdcSrc, 0, 0, 0x00CC0020);

            // 저장하려는 비트맵 객체 생성
            Bitmap bmp = Bitmap.FromHbitmap(hBitmap);

            // 이미지 저장
            bmp.Save("captured.bmp");
        }
    }
}
