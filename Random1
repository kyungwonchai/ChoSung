import os

# ==============================================================================
# [FIXED] dashboard.html
# 1. Selection Preservation: 텍스트가 변하지 않으면 DOM을 건드리지 않음
# 2. UI Layout: 텍스트 박스 가독성 및 여백 개선
# ==============================================================================
dashboard_html = """
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>CLINE OPS MANAGER</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0d1117; --sidebar: #161b22; --panel: #21262d; --border: #30363d; 
            --accent: #58a6ff; --text: #c9d1d9; --text-dim: #8b949e; 
            --cmd-bg: #000; --cmd-text: #4fc1ff;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        .sidebar { width: 320px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg); }
        
        .tabs { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); }
        .tab { flex: 1; padding: 15px 0; text-align: center; cursor: pointer; font-size: 0.8em; font-weight: 700; color: var(--text-dim); border-bottom: 2px solid transparent; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); background: rgba(88, 166, 255, 0.1); }
        
        .tab-content { display: none; height: 100%; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        .list-area { flex: 1; overflow-y: auto; padding: 10px; }
        .bottom-bar { padding: 15px; border-top: 1px solid var(--border); background: var(--panel); }

        .item { padding: 12px; border-radius: 6px; margin-bottom: 5px; cursor: pointer; border: 1px solid transparent; position: relative; }
        .item:hover { background: rgba(255,255,255,0.04); border-color: var(--border); }
        .item.active { background: rgba(88, 166, 255, 0.15); border-color: var(--accent); }
        .item-head { font-weight: 600; font-size: 0.95em; color: var(--text); }
        .item-sub { font-size: 0.8em; color: var(--text-dim); margin-top: 4px; }
        
        .btn-group { position: absolute; right: 10px; top: 10px; display: none; gap: 5px; }
        .item:hover .btn-group { display: flex; }
        .btn-mini { padding: 4px 8px; font-size: 0.75em; border-radius: 4px; cursor: pointer; border: 1px solid transparent; font-weight: 600; }
        .btn-edit { background: #1f6feb; color: white; }
        .btn-del { background: #da3633; color: white; }

        .workspace { display: none; flex-direction: column; height: 100%; }
        .ws-head { padding: 20px; border-bottom: 1px solid var(--border); background: var(--panel); }
        .ws-body { flex: 1; padding: 20px; overflow-y: auto; display:flex; flex-direction:column; gap:20px; }
        
        /* [FIX] Command Box Layout */
        .cmd-section { display: flex; flex-direction: column; gap: 20px; }
        .cmd-container { display: flex; flex-direction: column; gap: 8px; }
        .cmd-label { font-size: 0.85em; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .os-tag { padding: 3px 8px; border-radius: 4px; background: #238636; color: #fff; font-size: 0.75em; letter-spacing: 0.5px; }
        .os-tag.win { background: #1f6feb; }

        .cmd-box { 
            background: var(--cmd-bg); 
            border: 1px solid var(--border); 
            padding: 15px; 
            border-radius: 6px; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.9em;
            color: var(--cmd-text); 
            cursor: pointer; 
            white-space: pre-wrap; /* 줄바꿈 유지 */
            word-break: break-all; /* 긴 명령어도 박스 안에서 줄바꿈 */
            position: relative; 
            transition: border-color 0.2s;
            line-height: 1.5;
        }
        .cmd-box:hover { border-color: var(--accent); }
        /* 클릭 안내 문구 */
        .cmd-box::before { 
            content: "CLICK TO SELECT"; 
            position: absolute; top: -20px; right: 0; 
            font-size: 0.7em; color: var(--text-dim); font-family: 'Inter', sans-serif; 
            opacity: 0; transition: opacity 0.2s;
        }
        .cmd-box:hover::before { opacity: 1; }

        input, select, textarea { background: #0d1117; border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 6px; width: 100%; font-family: inherit; margin-bottom: 10px; }
        button { background: var(--accent); color: #0d1117; border: none; padding: 10px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; }
        .modal-box { background: var(--panel); border: 1px solid var(--border); width: 500px; padding: 25px; border-radius: 12px; }
        .code-area { font-family: 'JetBrains Mono', monospace; font-size: 0.9em; height: 400px; background: #0d1117; color: #e6edf3; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { text-align: left; padding: 10px; color: var(--text-dim); border-bottom: 1px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        ::selection { background: #1f6feb; color: white; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="tabs">
            <div class="tab active" onclick="tab('proj')">PROJ</div>
            <div class="tab" onclick="tab('types')">PC</div>
            <div class="tab" onclick="tab('scripts')">PY</div>
            <div class="tab" onclick="tab('rules')">RULE</div>
        </div>
        <div id="t-proj" class="tab-content active"><div class="list-area" id="l-proj"></div><div class="bottom-bar"><button onclick="openProjModal()">+ NEW PROJECT</button></div></div>
        <div id="t-types" class="tab-content"><div class="list-area" id="l-types"></div><div class="bottom-bar"><button onclick="openTypeModal()">+ PC TYPE</button></div></div>
        <div id="t-scripts" class="tab-content"><div class="list-area" id="l-scripts"></div><div class="bottom-bar"><button onclick="openScriptModal()">+ SCRIPT</button></div></div>
        <div id="t-rules" class="tab-content"><div class="list-area" id="l-rules"></div><div class="bottom-bar"><button onclick="openRuleModal()">+ RULE</button></div></div>
    </div>

    <div class="main">
        <div id="workspace" class="workspace">
            <div class="ws-head">
                <div style="font-weight:700; font-size:1.2em;" id="ws-title"></div>
                <div style="font-size:0.8em; color:var(--text-dim);" id="ws-meta"></div>
            </div>
            <div class="ws-body">
                <div class="cmd-section">
                    <div class="cmd-container">
                        <div class="cmd-label"><span class="os-tag">UBUNTU / MAC</span> (Bash)</div>
                        <div class="cmd-box" id="cmd-linux" onclick="selectText('cmd-linux')"></div>
                    </div>
                    <div class="cmd-container">
                        <div class="cmd-label"><span class="os-tag win">WINDOWS</span> (PowerShell)</div>
                        <div class="cmd-box" id="cmd-win" onclick="selectText('cmd-win')"></div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
                    <input id="new-cmd" placeholder="Command to Queue..." onkeypress="if(event.key==='Enter') addCmd()">
                    <button onclick="addCmd()" style="width:100px;">QUEUE</button>
                </div>
                
                <div style="flex:1; border:1px solid var(--border); border-radius:6px; overflow-y:auto;">
                    <table cellspacing="0"><thead><tr><th>STATUS</th><th>COMMAND</th><th></th></tr></thead><tbody id="tbl-cmd"></tbody></table>
                </div>
            </div>
        </div>
        <div id="empty" style="margin:auto; color:var(--text-dim);">SELECT PROJECT</div>
    </div>

    <div id="m-proj" class="modal"><div class="modal-box"><h3>Project</h3><input id="ip-subj" placeholder="Subject ID"><input id="ip-memo" placeholder="Memo"><label>PC Type</label><select id="ip-type"></select><label>Script</label><select id="ip-script"></select><label>Rule</label><select id="ip-rule"></select><button onclick="saveProj()" style="margin-top:10px;">SAVE</button><button onclick="closeModal('m-proj')" style="background:none; margin-top:5px;">CANCEL</button></div></div>
    <div id="m-script" class="modal"><div class="modal-box" style="width:800px;"><h3>Python Script</h3><input type="hidden" id="is-id"><input id="is-name" placeholder="Name"><textarea id="is-content" class="code-area"></textarea><button onclick="saveScript()" style="margin-top:10px;">SAVE</button><button onclick="closeModal('m-script')" style="background:none;">CANCEL</button></div></div>
    <div id="m-type" class="modal"><div class="modal-box"><h3>PC Type</h3><input type="hidden" id="it-id"><input id="it-name" placeholder="Name"><input id="it-venv" placeholder="Venv Root Path"><button onclick="saveType()">SAVE</button><button onclick="closeModal('m-type')" style="background:none;">CANCEL</button></div></div>
    <div id="m-rule" class="modal"><div class="modal-box"><h3>Global Rule</h3><input type="hidden" id="ir-id"><input id="ir-name" placeholder="Name"><textarea id="ir-content" rows="8"></textarea><button onclick="saveRule()">SAVE</button><button onclick="closeModal('m-rule')" style="background:none;">CANCEL</button></div></div>

    <script>
        const host = window.location.origin;
        let curSubj = null; let scripts=[], rules=[], types=[];

        window.onerror = function(msg, url, line) { console.error("JS Error: " + msg + " at " + line); };

        init();
        function init() { refreshAll(); setInterval(() => { if(curSubj) loadDetail(curSubj); }, 1500); }
        function refreshAll() { loadTypes(); loadRules(); loadScripts(); loadProjs(); }
        
        function tab(t) {
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelector(`.tab[onclick="tab('${t}')"]`).classList.add('active');
            document.getElementById('t-'+t).classList.add('active');
        }

        async function loadProjs() {
            try {
                const d = await (await fetch('/api/projects')).json();
                document.getElementById('l-proj').innerHTML = d.map(p => `
                    <div class="item ${curSubj===p.Proj_Subject?'active':''}" onclick="sel('${p.Proj_Subject}')">
                        <div class="item-head">${p.Proj_Subject}</div>
                        <div class="item-sub">${p.Type_Name} | ${p.Script_Name}</div>
                        <div class="btn-group">
                            <div class="btn-mini btn-del" onclick="event.stopPropagation(); delProj('${p.Proj_Subject}')">DEL</div>
                        </div>
                    </div>`).join('');
            } catch(e) { console.error(e); }
        }
        async function loadScripts() {
            try {
                scripts = await (await fetch('/api/scripts')).json();
                document.getElementById('l-scripts').innerHTML = scripts.map(s => `
                    <div class="item">
                        <div class="item-head">${s.Script_Name}</div>
                        <div class="btn-group"><div class="btn-mini btn-edit" onclick="openScriptModal(${s.Script_ID})">EDIT</div><div class="btn-mini btn-del" onclick="delScript(${s.Script_ID})">DEL</div></div>
                    </div>`).join('');
                document.getElementById('ip-script').innerHTML = scripts.map(s => `<option value="${s.Script_ID}">${s.Script_Name}</option>`).join('');
            } catch(e) { console.error(e); }
        }
        async function loadTypes() {
            try {
                types = await (await fetch('/api/pctypes')).json();
                document.getElementById('l-types').innerHTML = types.map(t => `
                    <div class="item">
                        <div class="item-head">${t.Type_Name}</div>
                        <div class="item-sub">${t.Default_Venv}</div>
                        <div class="btn-group"><div class="btn-mini btn-edit" onclick="openTypeModal(${t.Type_ID})">EDIT</div><div class="btn-mini btn-del" onclick="delType(${t.Type_ID})">DEL</div></div>
                    </div>`).join('');
                document.getElementById('ip-type').innerHTML = types.map(t => `<option value="${t.Type_ID}">${t.Type_Name}</option>`).join('');
            } catch(e) { console.error(e); }
        }
        async function loadRules() {
            try {
                rules = await (await fetch('/api/rules')).json();
                document.getElementById('l-rules').innerHTML = rules.map(r => `
                    <div class="item">
                        <div class="item-head">${r.Rule_Name}</div>
                        <div class="item-sub">${r.Rule_Content.substring(0,25)}...</div>
                        <div class="btn-group"><div class="btn-mini btn-edit" onclick="openRuleModal(${r.Rule_ID})">EDIT</div><div class="btn-mini btn-del" onclick="delRule(${r.Rule_ID})">DEL</div></div>
                    </div>`).join('');
                document.getElementById('ip-rule').innerHTML = rules.map(r => `<option value="${r.Rule_ID}">${r.Rule_Name}</option>`).join('');
            } catch(e) { console.error(e); }
        }

        async function saveProj() { await fetch('/api/project', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({subject:document.getElementById('ip-subj').value, memo:document.getElementById('ip-memo').value, type_id:document.getElementById('ip-type').value, rule_id:document.getElementById('ip-rule').value, script_id:document.getElementById('ip-script').value})}); closeModal('m-proj'); loadProjs(); }
        async function saveScript() { await fetch('/api/script', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:document.getElementById('is-id').value, name:document.getElementById('is-name').value, content:document.getElementById('is-content').value})}); closeModal('m-script'); loadScripts(); }
        async function saveType() { await fetch('/api/pctype', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:document.getElementById('it-id').value, name:document.getElementById('it-name').value, venv:document.getElementById('it-venv').value})}); closeModal('m-type'); loadTypes(); }
        async function saveRule() { await fetch('/api/rule', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:document.getElementById('ir-id').value, name:document.getElementById('ir-name').value, content:document.getElementById('ir-content').value})}); closeModal('m-rule'); loadRules(); }

        async function delProj(s) { if(confirm('Del?')) { await fetch('/api/project/'+s, {method:'DELETE'}); loadProjs(); } }
        async function delScript(id) { if(confirm('Del?')) { await fetch('/api/script/'+id, {method:'DELETE'}); loadScripts(); } }
        async function delType(id) { if(confirm('Del?')) { await fetch('/api/pctype/'+id, {method:'DELETE'}); loadTypes(); } }
        async function delRule(id) { if(confirm('Del?')) { await fetch('/api/rule/'+id, {method:'DELETE'}); loadRules(); } }

        function openProjModal() { document.getElementById('ip-subj').value=''; document.getElementById('ip-memo').value=''; closeModal('m-proj'); document.getElementById('m-proj').style.display='flex'; }
        function openScriptModal(id) { document.getElementById('is-id').value=''; document.getElementById('is-name').value=''; document.getElementById('is-content').value='# [INJECTED_CONFIG]\\n'; if(id){const s=scripts.find(x=>x.Script_ID==id); document.getElementById('is-id').value=s.Script_ID; document.getElementById('is-name').value=s.Script_Name; document.getElementById('is-content').value=s.Script_Content;} document.getElementById('m-script').style.display='flex'; }
        function openTypeModal(id) { document.getElementById('it-id').value=''; document.getElementById('it-name').value=''; document.getElementById('it-venv').value=''; if(id){const t=types.find(x=>x.Type_ID==id); document.getElementById('it-id').value=t.Type_ID; document.getElementById('it-name').value=t.Type_Name; document.getElementById('it-venv').value=t.Default_Venv;} document.getElementById('m-type').style.display='flex'; }
        function openRuleModal(id) { document.getElementById('ir-id').value=''; document.getElementById('ir-name').value=''; document.getElementById('ir-content').value=''; if(id){const r=rules.find(x=>x.Rule_ID==id); document.getElementById('ir-id').value=r.Rule_ID; document.getElementById('ir-name').value=r.Rule_Name; document.getElementById('ir-content').value=r.Rule_Content;} document.getElementById('m-rule').style.display='flex'; }
        
        function closeModal(id) { document.getElementById(id).style.display='none'; }

        function sel(s) { curSubj=s; document.getElementById('workspace').style.display='flex'; document.getElementById('empty').style.display='none'; loadDetail(s); }
        
        async function loadDetail(s) {
            try {
                const d = await (await fetch('/api/detail/'+s)).json();
                document.getElementById('ws-title').innerText = s;
                document.getElementById('ws-meta').innerText = `${d.info.Type_Name} / ${d.info.Script_Name}`;
                
                let venv = d.info.Default_Venv || "python";
                const url = `${host}/get_worker/${s}`;
                
                let cmdLinux = "";
                let cmdWin = "";

                if (venv !== "python" && venv !== "python3" && (venv.indexOf("/") > -1 || venv.indexOf("\\\\") > -1)) {
                    let path = venv.split('\\\\').join('/');
                    if (path.endsWith("/")) path = path.slice(0, -1);
                    if (!path.endsWith("activate")) path = path + "/bin/activate";
                    cmdLinux = `mkdir -p ${s} && cd ${s} && curl -s "${url}" -o worker.py && source "${path}" && python worker.py`;
                } else {
                    cmdLinux = `mkdir -p ${s} && cd ${s} && curl -s "${url}" -o worker.py && python3 worker.py`;
                }

                if (venv !== "python" && (venv.indexOf("/") > -1 || venv.indexOf("\\\\") > -1)) {
                    let path = venv.split('/').join('\\\\');
                    if (path.endsWith("\\\\")) path = path.slice(0, -1);
                    if (!path.toLowerCase().endsWith("activate.ps1")) path = path + "\\\\Scripts\\\\Activate.ps1";
                    cmdWin = `New-Item -ItemType Directory -Force ${s}; Set-Location ${s}; Invoke-WebRequest "${url}" -OutFile worker.py; & "${path}"; python worker.py`;
                } else {
                    cmdWin = `New-Item -ItemType Directory -Force ${s}; Set-Location ${s}; Invoke-WebRequest "${url}" -OutFile worker.py; python worker.py`;
                }

                // [FIX] 값이 다를 때만 업데이트 (선택 유지)
                const boxLinux = document.getElementById('cmd-linux');
                const boxWin = document.getElementById('cmd-win');
                
                if(boxLinux.innerText !== cmdLinux) boxLinux.innerText = cmdLinux;
                if(boxWin.innerText !== cmdWin) boxWin.innerText = cmdWin;
                
                // List update
                const newTbl = d.cmds.map(c=>`<tr><td style="color:${c.Cmd_Status===1?'#58a6ff':(c.Cmd_Status===2?'#2ea043':'#8b949e')}">${c.Cmd_Status===0?'WAIT':(c.Cmd_Status===1?'RUNNING':'DONE')}</td><td style="font-family:'JetBrains Mono'">${c.Cmd_Text}</td><td><button class="btn-del" onclick="delCmd(${c.Cmd_ID})">×</button></td></tr>`).join('');
                const tbl = document.getElementById('tbl-cmd');
                if(tbl.innerHTML !== newTbl) tbl.innerHTML = newTbl;

            } catch(e) { console.error(e); }
        }

        async function addCmd() { const v=document.getElementById('new-cmd').value; if(!v)return; await fetch('/api/command', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({subject:curSubj, command:v})}); document.getElementById('new-cmd').value=''; loadDetail(curSubj); }
        async function delCmd(id) { await fetch('/api/command/'+id, {method:'DELETE'}); loadDetail(curSubj); }

        // [기능] 전체 선택 함수
        function selectText(id) {
            const node = document.getElementById(id);
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(node);
            selection.removeAllRanges();
            selection.addRange(range);
            try { navigator.clipboard.writeText(node.innerText); } catch(e){}
        }
    </script>
</body>
</html>
"""

def apply_fix():
    with open('app/templates/dashboard.html', 'w', encoding='utf-8') as f:
        f.write(dashboard_html.strip())
    print("[패치 완료] 새로고침 하시면 텍스트 박스 선택 시 풀리지 않습니다.")

if __name__ == "__main__":
    apply_fix()