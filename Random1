import os

PROJECT_NAME = "SmdEdgeLauncher"
BASE_DIR = os.path.join(os.getcwd(), PROJECT_NAME)

# 1. CS Project
content_csproj = f"""<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net6.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <UseWPF>true</UseWPF>
    <RootNamespace>{PROJECT_NAME}</RootNamespace>
    <AssemblyName>{PROJECT_NAME}</AssemblyName>
  </PropertyGroup>
</Project>
"""

# 2. App.xaml
content_app_xaml = """<Application x:Class="SmdEdgeLauncher.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             StartupUri="MainWindow.xaml">
    <Application.Resources>
        <SolidColorBrush x:Key="AppBackground" Color="#1E1E1E"/>
        <SolidColorBrush x:Key="AppForeground" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="AppAccent" Color="#00ADB5"/>
        <Style TargetType="Button">
            <Setter Property="Background" Value="#2D2D30"/>
            <Setter Property="Foreground" Value="{StaticResource AppAccent}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" BorderBrush="{StaticResource AppAccent}" BorderThickness="1" CornerRadius="0">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#3E3E42"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Application.Resources>
</Application>
"""

# 3. App.xaml.cs
content_app_xaml_cs = """using System.Windows;
namespace SmdEdgeLauncher { public partial class App : Application { } }
"""

# 4. NativeMethods.cs
content_native_methods = """using System;
using System.Runtime.InteropServices;
namespace SmdEdgeLauncher.Services
{
    public static class NativeMethods
    {
        [DllImport("user32.dll")] public static extern bool SetWindowPos(IntPtr hWnd, IntPtr hWndInsertAfter, int X, int Y, int cx, int cy, uint uFlags);
        [DllImport("user32.dll")] public static extern IntPtr FindWindow(string lpClassName, string lpWindowName);
        [DllImport("user32.dll")] public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
    }
}
"""

# 5. RelayCommand.cs
content_relay_command = """using System;
using System.Windows.Input;
namespace SmdEdgeLauncher.Core
{
    public class RelayCommand : ICommand
    {
        private readonly Action<object> _execute;
        public RelayCommand(Action<object> execute) => _execute = execute;
        public bool CanExecute(object parameter) => true;
        public void Execute(object parameter) => _execute(parameter);
        public event EventHandler CanExecuteChanged;
    }
}
"""

# 6. MainViewModel.cs
content_main_vm = """using System;
using System.Diagnostics;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using SmdEdgeLauncher.Core;

namespace SmdEdgeLauncher.ViewModels
{
    public class MainViewModel : System.ComponentModel.INotifyPropertyChanged
    {
        // ▼▼▼ 사용자 수정 영역 (PC IP 및 웹 주소) ▼▼▼
        private const string PC1_IP = "192.168.0.101"; 
        private const string PC2_IP = "192.168.0.102";
        private const string NOTE_URL = "https://keep.google.com";

        public ICommand LaunchCommand { get; }
        public ICommand CloseCommand { get; }
        private bool _isLockedOnTop = true;
        public bool IsLockedOnTop { get => _isLockedOnTop; set { _isLockedOnTop = value; OnPropertyChanged(nameof(IsLockedOnTop)); } }

        public MainViewModel()
        {
            LaunchCommand = new RelayCommand(o => LaunchSystem());
            CloseCommand = new RelayCommand(o => Application.Current.Shutdown());
        }

        private void LaunchSystem()
        {
            try 
            {
                Process.Start(new ProcessStartInfo { FileName = NOTE_URL, UseShellExecute = true });
                Process.Start("mstsc", $"/v:{PC1_IP}");
                Process.Start("mstsc", $"/v:{PC2_IP}");
            }
            catch (Exception ex) { MessageBox.Show("Error: " + ex.Message); }
        }

        public event System.ComponentModel.PropertyChangedEventHandler PropertyChanged;
        protected void OnPropertyChanged(string name) => PropertyChanged?.Invoke(this, new System.ComponentModel.PropertyChangedEventArgs(name));
    }
}
"""

# 7. MainWindow.xaml
content_mainwindow_xaml = """<Window x:Class="SmdEdgeLauncher.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:SmdEdgeLauncher.ViewModels"
        Title="SMD Edge" WindowStyle="None" AllowsTransparency="True" Background="#F01E1E1E"
        Topmost="{Binding IsLockedOnTop}" ShowInTaskbar="False" Loaded="Window_Loaded">
    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>
    <Border BorderBrush="#00ADB5" BorderThickness="2">
        <Grid Margin="15">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <CheckBox IsChecked="{Binding IsLockedOnTop}" Content="TOP FIX" Foreground="#888" VerticalAlignment="Center" Margin="0,0,10,0"/>
                <Button Command="{Binding CloseCommand}" Content=" X " Background="#CC0000" Foreground="White" Width="30" Height="20"/>
            </StackPanel>
            <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="SMD EDGE COMMANDER" Foreground="White" FontSize="20" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,0,0,20"/>
                <Button Command="{Binding LaunchCommand}" Content="INITIATE WORKSPACE" Width="250" Height="50" FontSize="16" FontWeight="Bold"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>
"""

# 8. MainWindow.xaml.cs (Fixed Namespace Issue)
content_mainwindow_xaml_cs = """using System;
using System.Windows;
using System.Windows.Threading;
using SmdEdgeLauncher.ViewModels; // 네임스페이스 추가됨

namespace SmdEdgeLauncher
{
    public partial class MainWindow : Window
    {
        private DispatcherTimer _timer;

        public MainWindow()
        {
            InitializeComponent();
            // 항상 위 유지 및 복구 감시 타이머
            _timer = new DispatcherTimer { Interval = TimeSpan.FromSeconds(1) };
            _timer.Tick += (s, e) => 
            {
                if (DataContext is MainViewModel vm && vm.IsLockedOnTop)
                {
                    if (WindowState == WindowState.Minimized) WindowState = WindowState.Normal;
                    Topmost = true;
                    Activate();
                }
            };
            _timer.Start();
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            // 좌100, 상100 제외 꽉 채우기
            this.Left = 100;
            this.Top = 100;
            this.Width = SystemParameters.PrimaryScreenWidth - 100;
            this.Height = SystemParameters.PrimaryScreenHeight - 100;
        }
    }
}
"""

def write_file(path, content):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content)

def create_project():
    if not os.path.exists(BASE_DIR): os.makedirs(BASE_DIR)
    
    write_file(os.path.join(BASE_DIR, f"{PROJECT_NAME}.csproj"), content_csproj)
    write_file(os.path.join(BASE_DIR, "App.xaml"), content_app_xaml)
    write_file(os.path.join(BASE_DIR, "App.xaml.cs"), content_app_xaml_cs)
    write_file(os.path.join(BASE_DIR, "MainWindow.xaml"), content_mainwindow_xaml)
    write_file(os.path.join(BASE_DIR, "MainWindow.xaml.cs"), content_mainwindow_xaml_cs)
    write_file(os.path.join(BASE_DIR, "Services", "NativeMethods.cs"), content_native_methods)
    write_file(os.path.join(BASE_DIR, "Core", "RelayCommand.cs"), content_relay_command)
    write_file(os.path.join(BASE_DIR, "ViewModels", "MainViewModel.cs"), content_main_vm)

if __name__ == "__main__":
    create_project()
    print("Done.")