model1	ColName	MinValueWithoutOutliers
A100	ACT2_1	0.45
A100	ACT2_2	0.48
A100	ACT2BEST_1	0.42
A100	ACT2BEST_2	0.47
...	...	...
이제 여기서 각 모델별로

ACT2_1 ~ ACT2_8 그룹

ACT2BEST_1 ~ ACT2BEST_8 그룹

각 그룹의 MinValueWithoutOutliers 중 가장 큰 값 (즉, group-wise max of mins) 를 조회하고 싶은 거지?

해결 쿼리 (전체 포함, 마지막에 그룹별 MAX만 뽑기):
sql
코드 복사
WITH LastestModels AS (
    SELECT DISTINCT model1
    FROM dbo.ExcelData
    WHERE line1 = 'SMD_12'
      AND CAST(time1 AS DATE) = '2025-03-28'
),
ExcelFiltered AS (
    SELECT
        E.time1,
        E.model1,
        E.line1,
        E.ACT2_1, E.ACT2_2, E.ACT2_3, E.ACT2_4,
        E.ACT2_5, E.ACT2_6, E.ACT2_7, E.ACT2_8,
        E.ACT2BEST_1, E.ACT2BEST_2, E.ACT2BEST_3, E.ACT2BEST_4,
        E.ACT2BEST_5, E.ACT2BEST_6, E.ACT2BEST_7, E.ACT2BEST_8
    FROM dbo.ExcelData E
    INNER JOIN LastestModels L ON E.model1 = L.model1
    WHERE E.time1 >= DATEADD(HOUR, -5, GETDATE())
),
Unpivoted AS (
    SELECT
        model1,
        ColName,
        Value
    FROM ExcelFiltered
    UNPIVOT (
        Value FOR ColName IN (
            ACT2_1, ACT2_2, ACT2_3, ACT2_4, ACT2_5, ACT2_6, ACT2_7, ACT2_8,
            ACT2BEST_1, ACT2BEST_2, ACT2BEST_3, ACT2BEST_4,
            ACT2BEST_5, ACT2BEST_6, ACT2BEST_7, ACT2BEST_8
        )
    ) AS Unpvt
    WHERE Value > 0
),
WithQuantiles AS (
    SELECT
        model1,
        ColName,
        Value,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q3
    FROM Unpivoted
),
FilteredByIQR AS (
    SELECT model1, ColName, Value
    FROM WithQuantiles
    WHERE Value BETWEEN Q1 AND Q3
),
MinByCol AS (
    SELECT
        model1,
        ColName,
        MIN(Value) AS MinValueWithoutOutliers
    FROM FilteredByIQR
    GROUP BY model1, ColName
),
GroupMax AS (
    SELECT
        model1,
        MAX(CASE WHEN ColName LIKE 'ACT2_%' THEN MinValueWithoutOutliers ELSE NULL END) AS MaxOfACT2,
        MAX(CASE WHEN ColName LIKE 'ACT2BEST_%' THEN MinValueWithoutOutliers ELSE NULL END) AS MaxOfACT2BEST
    FROM MinByCol
    GROUP BY model1
)
SELECT *
FROM GroupMax
ORDER BY model1;
결과 예시:
model1	MaxOfACT2	MaxOfACT2BEST
A100	0.58	0.51
B200	0.60	0.55
이렇게 하면 모델별로 두 군(8개씩)에서 이상치 제거된 값 중의 최솟값들 중에서 가장 큰 값만 뽑을 수 있어.