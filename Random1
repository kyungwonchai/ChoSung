<dx:ThemedWindow
    x:Class="LockerManagementApp.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:dx="http://schemas.devexpress.com/winfx/2008/xaml/core"
    xmlns:dxg="http://schemas.devexpress.com/winfx/2008/xaml/grid"
    xmlns:dxe="http://schemas.devexpress.com/winfx/2008/xaml/editors"
    xmlns:dxgt="http://schemas.devexpress.com/winfx/2008/xaml/grid/themekeys"
    xmlns:dxb="http://schemas.devexpress.com/winfx/2008/xaml/bars"
    xmlns:dxlc="http://schemas.devexpress.com/winfx/2008/xaml/layoutcontrol"
    xmlns:local="clr-namespace:LockerManagementApp.Views"
    xmlns:viewmodels="clr-namespace:LockerManagementApp.ViewModels"
    xmlns:models="clr-namespace:LockerManagementApp.Models"
    xmlns:infra="clr-namespace:LockerManagementApp.Infrastructure"
    Title="ì‚¬ë¬¼í•¨ ê´€ë¦¬ í”„ë¡œê·¸ë¨ (DevExpress MVVM - .NET Framework 4.8)" Height="750" Width="1300"
    Loaded="MainWindow_Loaded" Closing="MainWindow_Closing"
    FontSize="14"
    >

    <dx:ThemedWindow.DataContext>
        <viewmodels:MainViewModel/>
    </dx:ThemedWindow.DataContext>

    <dx:ThemedWindow.Resources>
        <infra:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <infra:HighlightCellConverter x:Key="HighlightCellConverter"/>

        <Style x:Key="LightBlueHeaderStyle" TargetType="dxg:BaseGridHeader"> <Setter Property="Background" Value="LightBlue"/> <Setter Property="HorizontalContentAlignment" Value="Center"/> <Setter Property="FontWeight" Value="Bold"/> <Setter Property="Foreground" Value="Black"/> </Style>
        <Style TargetType="dxg:GridColumnHeader" BasedOn="{StaticResource LightBlueHeaderStyle}"/>
        <Style TargetType="dxg:BandHeaderControl" BasedOn="{StaticResource LightBlueHeaderStyle}"/>

        <Style x:Key="HighlightCellStyle" TargetType="dxg:CellContentPresenter">
            <Setter Property="Background">
                <Setter.Value>
                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                        <Binding Path="Value"/>
                        <Binding Path="Column.FieldName"/>
                        <Binding Path="View.DataContext.SelectedCellValue"/>
                        <Binding Path="View.DataContext.SelectedCellColumnFieldName"/>
                    </MultiBinding>
                </Setter.Value>
            </Setter>
        </Style>

    </dx:ThemedWindow.Resources>

    <Grid>
        <Grid.RowDefinitions> <RowDefinition Height="Auto"/> <RowDefinition Height="*"/> <RowDefinition Height="Auto"/> </Grid.RowDefinitions>

        <DockPanel Grid.Row="0" LastChildFill="True">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" Margin="5">
                 <TextBlock Text="ì¼ë°˜ í‚¤:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                 <PasswordBox x:Name="NormalPasswordBox" Width="100" VerticalAlignment="Center" infra:PasswordHelper.Attach="True" infra:PasswordHelper.Password="{Binding NormalPasswordInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                 <Button Content="í™•ì¸" Margin="5,0,15,0" Command="{Binding CheckNormalPasswordCommand}"/>
                <TextBlock Text="ë§ˆìŠ¤í„° í‚¤:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <PasswordBox x:Name="MasterPasswordBox" Width="100" VerticalAlignment="Center" infra:PasswordHelper.Attach="True" infra:PasswordHelper.Password="{Binding MasterPasswordInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                <Button Content="í™•ì¸" Margin="5,0,0,0" Command="{Binding CheckMasterPasswordCommand}"/>
            </StackPanel>
            <Border Background="LightGray" Padding="5">
                 <StackPanel Orientation="Horizontal">
                    <Button Content="ğŸ”„ ìƒˆë¡œê³ ì¹¨" Margin="3" Command="{Binding LoadDataCommand}"/>
                    <Button Content="ğŸ’¾ ë³€ê²½ ì‚¬í•­ ì €ì¥" Margin="3" Command="{Binding SaveChangesCommand}" Visibility="{Binding IsEditModeEnabled, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"/>
                    <Button Content="âš™ï¸ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬" Margin="15,3,3,3" Command="{Binding OpenMasterDataWindowCommand}" ToolTip="ë§ˆìŠ¤í„° ë°ì´í„°(ì¸µ, êµ¬ì—­ ë“±)ë¥¼ ê´€ë¦¬í•˜ëŠ” ìƒˆ ì°½ì„ ì—½ë‹ˆë‹¤." Visibility="{Binding IsMasterModeEnabled, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"/>
                    <Button Content="ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½" Margin="5,3,3,3" Command="{Binding OpenPasswordChangeWindowCommand}" ToolTip="ë§ˆìŠ¤í„° ë˜ëŠ” ì¼ë°˜ í‚¤ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤." Visibility="{Binding IsMasterModeEnabled, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"/>
                    <Button Content="ğŸ“œ ë¡œê·¸ ë³´ê¸°" Margin="5,3,3,3" Command="{Binding OpenLogWindowCommand}" ToolTip="ë°ì´í„° ë³€ê²½ ì´ë ¥ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤."/>
                    <Button Content="ğŸ“„ Excel ì €ì¥" Margin="15,3,3,3" Command="{Binding ExportToExcelCommand}" ToolTip="í˜„ì¬ ê·¸ë¦¬ë“œ ë‚´ìš©ì„ Excel íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤."/>
                 </StackPanel>
            </Border>
        </DockPanel>

        <Grid Grid.Row="1" Margin="5">
            <Grid.RowDefinitions> <RowDefinition Height="Auto"/> <RowDefinition Height="*"/> </Grid.RowDefinitions>
            <Border Grid.Row="0" Background="WhiteSmoke" Padding="3">
                <StackPanel Orientation="Horizontal">
                    <Button Content="â• ìƒˆ ì‚¬ë¬¼í•¨ ì¶”ê°€" Margin="3" Command="{Binding AddNewCommand}" Visibility="{Binding IsEditModeEnabled, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"/>
                    <Button Content="âŒ ì„ íƒ í•­ëª© ì‚­ì œ" Margin="3" Command="{Binding DeleteCommand}" Visibility="{Binding IsEditModeEnabled, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"/>
                </StackPanel>
            </Border>
            <dxg:GridControl Grid.Row="1" ItemsSource="{Binding LockerAssignments}" SelectedItem="{Binding SelectedAssignment, Mode=TwoWay}"
                             CurrentItemChanged="GridControl_CurrentItemChanged">
                <dxg:GridControl.View>
                    <dxg:TableView x:Name="mainTableView" AllowPerPixelScrolling="True" ShowGroupPanel="True" AllowEditing="True"
                                   NavigationStyle="Cell" ShowAutoFilterRow="True" NewItemRowPosition="None"
                                   ShowIndicator="True" ShowSearchPanelMode="Always"
                                   FocusedColumnChanged="TableView_FocusedColumnChanged"
                                   UseLightweightTemplates="None">
                        <dxg:TableView.RowCellMenuCustomizations>
                            <dxb:BarItemSeparator/>
                            <dxb:BarButtonItem Content="í–‰ ì‚­ì œ" Command="{Binding View.DataContext.DeleteCommand}" Glyph="{dx:DXImage Svg/Actions/Delete.svg}"/>
                        </dxg:TableView.RowCellMenuCustomizations>
                    </dxg:TableView>
                </dxg:GridControl.View>
                <dxg:GridControl.Columns>
                    <dxg:GridColumn FieldName="LockerType" Header="ì¢…ë¥˜" Width="100" Fixed="Left" HeaderStyle="{StaticResource LightBlueHeaderStyle}" CellStyle="{StaticResource HighlightCellStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllLockerTypes}" DisplayMember="Name" ValueMember="Name" IsTextEditable="False" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Floor" Header="ì¸µ" Width="60" HeaderStyle="{StaticResource LightBlueHeaderStyle}" CellStyle="{StaticResource HighlightCellStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllFloors}" DisplayMember="Name" ValueMember="Name" IsTextEditable="False" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Zone" Header="êµ¬ì—­" Width="80" HeaderStyle="{StaticResource LightBlueHeaderStyle}" CellStyle="{StaticResource HighlightCellStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllZones}" DisplayMember="Name" ValueMember="Name" IsTextEditable="True" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="SpecificLocation" Header="ì„¸ë¶€ ìœ„ì¹˜" Width="120" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="UserName" Header="ì„±ëª…" Width="100" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="KnoxId" Header="Knox ID" Width="100" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="SubPart" Header="ì†ŒíŒŒíŠ¸" Width="120" HeaderStyle="{StaticResource LightBlueHeaderStyle}" CellStyle="{StaticResource HighlightCellStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllSubParts}" DisplayMember="Name" ValueMember="Name" IsTextEditable="True" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Administrator" Header="ê´€ë¦¬ ë‹´ë‹¹ì" Width="120" HeaderStyle="{StaticResource LightBlueHeaderStyle}" CellStyle="{StaticResource HighlightCellStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllAdministrators}" DisplayMember="Name" ValueMember="Name" IsTextEditable="True" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="TransferStatus" Header="ì „ë°°ë³µì§" Width="100" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Details" Header="ë‚´ìš©" Width="150" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Left"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Remarks" Header="íŠ¹ì´ì‚¬í•­" Width="150" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Left"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Notes" Header="ë¹„ê³ " Width="150" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Left"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="LastUpdated" Header="ìµœì¢… ìˆ˜ì •ì¼ì‹œ" Width="150" AllowEditing="False" ReadOnly="True" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:DateEditSettings MaskType="DateTime" Mask="yyyy-MM-dd HH:mm:ss" MaskUseAsDisplayFormat="True" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Id" Header="ID" Visible="False" ReadOnly="True"/>
                </dxg:GridControl.Columns>
            </dxg:GridControl>
        </Grid>

        <StatusBar Grid.Row="2" Background="LightGray"> <StatusBarItem><TextBlock Text="{Binding StatusBarText}" Margin="5,0"/></StatusBarItem> </StatusBar>
    </Grid>

</dx:ThemedWindow>
```

---

**2. `ViewModels/MainViewModel.cs` (ìˆ˜ì •)**

`ExportToExcelCommand` ë° ê´€ë ¨ ë¡œì§ì„ ì¶”ê°€í•©ë‹ˆë‹¤. ì‹¤ì œ íŒŒì¼ ì €ì¥ì€ Viewì˜ ì½”ë“œ ë¹„í•˜ì¸ë“œì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ `RequestExcelExport` Actionì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```csharp
// FILE_ID: ViewModels/MainViewModel_20250410150000
using LockerManagementApp.Data;
using LockerManagementApp.Models;
using LockerManagementApp.Infrastructure;
using LockerManagementApp.Views;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Configuration;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Data.Entity.Validation;
using System.Data.SqlClient;
using System.Data.Entity.Core;
using System.Linq;
using System.Security;
using System.Threading;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using System.Runtime.InteropServices;
using System.IO;
using System.Text;
using System.Windows.Threading;
using System.Diagnostics;
using Microsoft.Win32; // SaveFileDialog ì‚¬ìš©

namespace LockerManagementApp.ViewModels
{
    public class MainViewModel : ViewModelBase, IDisposable
    {
        private LockerDbContext _context;
        private ObservableCollection<LockerAssignment> _lockerAssignments;
        private LockerAssignment _selectedAssignment;
        private string _statusBarText = "ì¤€ë¹„ ì™„ë£Œ";
        private string _currentAdmin = "í™ê¸¸ë™A";
        private SecureString _masterPasswordInput;
        private SecureString _normalPasswordInput;
        private bool _isMasterModeEnabled = false;
        private bool _isNormalModeEnabled = false;
        private ObservableCollection<LockerType> _allLockerTypes;
        private ObservableCollection<Floor> _allFloors;
        private ObservableCollection<Zone> _allZones;
        private ObservableCollection<SubPart> _allSubParts;
        private ObservableCollection<Administrator> _allAdministrators;
        public LogViewModel LogVM { get; private set; }
        private readonly CancellationTokenSource _cts = new CancellationTokenSource();
        private bool _disposed = false;
        private object _selectedCellValue;
        private string _selectedCellColumnFieldName;
        private DispatcherTimer _reAuthTimer;

        #region Public Properties
        public ObservableCollection<LockerAssignment> LockerAssignments { get => _lockerAssignments; set => SetProperty(ref _lockerAssignments, value); }
        public LockerAssignment SelectedAssignment { get => _selectedAssignment; set => SetProperty(ref _selectedAssignment, value); }
        public string StatusBarText { get => _statusBarText; set => SetProperty(ref _statusBarText, value); }
        public SecureString MasterPasswordInput { get => _masterPasswordInput; set => SetProperty(ref _masterPasswordInput, value); }
        public SecureString NormalPasswordInput { get => _normalPasswordInput; set => SetProperty(ref _normalPasswordInput, value); }
        public bool IsMasterModeEnabled { get => _isMasterModeEnabled; set { if (SetProperty(ref _isMasterModeEnabled, value)) OnPropertyChanged(nameof(IsEditModeEnabled)); } }
        public bool IsNormalModeEnabled { get => _isNormalModeEnabled; set { if (SetProperty(ref _isNormalModeEnabled, value)) OnPropertyChanged(nameof(IsEditModeEnabled)); } }
        public bool IsEditModeEnabled => IsMasterModeEnabled || IsNormalModeEnabled;
        public ObservableCollection<LockerType> AllLockerTypes { get => _allLockerTypes; set => SetProperty(ref _allLockerTypes, value); }
        public ObservableCollection<Floor> AllFloors { get => _allFloors; set => SetProperty(ref _allFloors, value); }
        public ObservableCollection<Zone> AllZones { get => _allZones; set => SetProperty(ref _allZones, value); }
        public ObservableCollection<SubPart> AllSubParts { get => _allSubParts; set => SetProperty(ref _allSubParts, value); }
        public ObservableCollection<Administrator> AllAdministrators { get => _allAdministrators; set => SetProperty(ref _allAdministrators, value); }
        public object SelectedCellValue { get => _selectedCellValue; private set => SetProperty(ref _selectedCellValue, value); }
        public string SelectedCellColumnFieldName { get => _selectedCellColumnFieldName; private set => SetProperty(ref _selectedCellColumnFieldName, value); }

        // *** ì‹ ê·œ: Viewì—ì„œ Excel ì €ì¥ ë¡œì§ì„ ì‹¤í–‰í•˜ë„ë¡ ìš”ì²­í•˜ëŠ” Action ***
        public Action<string> RequestExcelExport { get; set; }

        #endregion

        #region Commands
        public ICommand LoadDataCommand { get; }
        public ICommand SaveChangesCommand { get; }
        public ICommand AddNewCommand { get; }
        public ICommand DeleteCommand { get; }
        public ICommand CheckMasterPasswordCommand { get; }
        public ICommand CheckNormalPasswordCommand { get; }
        public ICommand RefreshMasterDataCommand { get; }
        public ICommand OpenMasterDataWindowCommand { get; }
        public ICommand OpenLogWindowCommand { get; }
        public ICommand OpenPasswordChangeWindowCommand { get; }
        public ICommand ExportToExcelCommand { get; } // *** ì‹ ê·œ: Excel ì €ì¥ ì»¤ë§¨ë“œ ***
        #endregion

        public MainViewModel()
        {
            try { _context = new LockerDbContext(); } catch (Exception ex) { if (!App.IsShuttingDown) MessageBox.Show($"DB ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜:\n{ex.ToString()}", "ì´ˆê¸°í™” ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); else Debug.WriteLine($"ì¢…ë£Œ ì¤‘ DB ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜ ë¬´ì‹œë¨: {ex.Message}"); StatusBarText = "DB ì—°ê²° ì˜¤ë¥˜!"; return; }
            _lockerAssignments = new ObservableCollection<LockerAssignment>(); _allLockerTypes = new ObservableCollection<LockerType>(); _allFloors = new ObservableCollection<Floor>(); _allZones = new ObservableCollection<Zone>(); _allSubParts = new ObservableCollection<SubPart>(); _allAdministrators = new ObservableCollection<Administrator>();
            try { LogVM = new LogViewModel(); } catch (Exception ex) { if (!App.IsShuttingDown) MessageBox.Show($"LogViewModel ìƒì„± ì˜¤ë¥˜:\n{ex.ToString()}", "ì´ˆê¸°í™” ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); else Debug.WriteLine($"ì¢…ë£Œ ì¤‘ LogViewModel ìƒì„± ì˜¤ë¥˜ ë¬´ì‹œë¨: {ex.Message}"); }
            LoadDataCommand = new RelayCommand(async _ => await LoadInitialDataAsync(), CanExecuteCommand); SaveChangesCommand = new RelayCommand(async _ => await SaveChangesAsync(), CanSaveChangesExecute); AddNewCommand = new RelayCommand(AddNewLocker, CanExecuteCommand); DeleteCommand = new RelayCommand(async _ => await DeleteSelectedAsync(), CanDeleteExecute); CheckMasterPasswordCommand = new RelayCommand(async _ => await CheckMasterPassword(_), CanExecuteCommand); CheckNormalPasswordCommand = new RelayCommand(async _ => await CheckNormalPassword(_), CanExecuteCommand); RefreshMasterDataCommand = new RelayCommand(async _ => await LoadMasterDataAsync(), CanExecuteCommand); OpenMasterDataWindowCommand = new RelayCommand(OpenMasterDataWindow, _ => CanExecuteCommand(_) && IsMasterModeEnabled); OpenLogWindowCommand = new RelayCommand(OpenLogWindow, CanExecuteCommand); OpenPasswordChangeWindowCommand = new RelayCommand(OpenPasswordChangeWindow, _ => CanExecuteCommand(_) && IsMasterModeEnabled);
            ExportToExcelCommand = new RelayCommand(ExportToExcel, CanExecuteCommand); // *** ì‹ ê·œ ì»¤ë§¨ë“œ ì´ˆê¸°í™” ***
            if (_context != null) { _ = LoadInitialDataAsync(); }
            SetupReAuthTimer();
        }

        private bool CanExecuteCommand(object parameter) => !_disposed;
        private bool CanSaveChangesExecute(object parameter) { if (_disposed || _context == null) return false; try { bool hasChanges = _context.ChangeTracker.HasChanges(); Debug.WriteLine($"[{DateTime.Now:HH:mm:ss.fff}] CanSaveChangesExecute í˜¸ì¶œë¨: HasChanges={hasChanges}"); return hasChanges; } catch(Exception ex) { Debug.WriteLine($"!!! CanSaveChangesExecute í™•ì¸ ì¤‘ ì˜¤ë¥˜: {ex.Message}"); return false; } }
        private bool CanDeleteExecute(object parameter) => !_disposed && SelectedAssignment != null;

        private async Task LoadInitialDataAsync() { if (!CanExecuteCommand(null) || _cts.IsCancellationRequested) return; await LoadMasterDataAsync(); if (!CanExecuteCommand(null) || _cts.IsCancellationRequested) return; await LoadAssignmentsAsync(); }
        private async Task LoadAssignmentsAsync() { if (!CanExecuteCommand(null) || _context == null || _cts.IsCancellationRequested) return; StatusBarText = "ì‚¬ë¬¼í•¨ ëª©ë¡ ë¡œë”© ì¤‘..."; List<LockerAssignment> assignments = null; try { var trackedAssignments = _context.ChangeTracker.Entries<LockerAssignment>().ToList(); if (trackedAssignments.Any()) { foreach (var entry in trackedAssignments) entry.State = EntityState.Detached; } if (!CanExecuteCommand(null) || _cts.IsCancellationRequested) return; assignments = await _context.LockerAssignments.OrderBy(l => l.Floor).ThenBy(l => l.Zone).ThenBy(l => l.SpecificLocation).ToListAsync(_cts.Token); if (_cts.IsCancellationRequested || _disposed) { Debug.WriteLine("LoadAssignmentsAsync ì‘ì—… ì·¨ì†Œë¨ (await ì´í›„)."); return; } Application.Current.Dispatcher.Invoke(() => { if (_cts.IsCancellationRequested || _disposed || Application.Current == null) return; LockerAssignments = new ObservableCollection<LockerAssignment>(assignments); StatusBarText = $"ì´ {LockerAssignments.Count}ê°œ ë¡œë“œ ì™„ë£Œ."; (DeleteCommand as RelayCommand)?.RaiseCanExecuteChanged(); (SaveChangesCommand as RelayCommand)?.RaiseCanExecuteChanged(); }); } catch (OperationCanceledException) { Debug.WriteLine("LoadAssignmentsAsync ì‘ì—… ì·¨ì†Œë¨."); if (!_disposed) StatusBarText = "ì‚¬ë¬¼í•¨ ëª©ë¡ ë¡œë”© ì·¨ì†Œë¨."; } catch (ObjectDisposedException) { Debug.WriteLine("LoadAssignmentsAsync ì‹¤í–‰ ì¤‘ DbContext Disposeë¨."); if (!_disposed) StatusBarText = "ì‚¬ë¬¼í•¨ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜ (ì»¨í…ìŠ¤íŠ¸ í•´ì œë¨)."; } catch (Exception ex) { if (CanExecuteCommand(null) && !_cts.IsCancellationRequested) HandleGenericException("ì‚¬ë¬¼í•¨ ëª©ë¡ ë¡œë”©", ex); } }
        private async Task LoadMasterDataAsync() { if (!CanExecuteCommand(null) || _cts.IsCancellationRequested) return; StatusBarText = "ë§ˆìŠ¤í„° ë°ì´í„°(ì½¤ë³´ë°•ìŠ¤ìš©) ë¡œë”© ì¤‘..."; LockerDbContext tempContext = null; try { using (tempContext = new LockerDbContext()) { var types = await tempContext.LockerTypes.OrderBy(t => t.Name).AsNoTracking().ToListAsync(_cts.Token); if (_cts.IsCancellationRequested || _disposed) return; var floors = await tempContext.Floors.OrderBy(f => f.Name).AsNoTracking().ToListAsync(_cts.Token); if (_cts.IsCancellationRequested || _disposed) return; var zones = await tempContext.Zones.OrderBy(z => z.Name).AsNoTracking().ToListAsync(_cts.Token); if (_cts.IsCancellationRequested || _disposed) return; var subParts = await tempContext.SubParts.OrderBy(p => p.Name).AsNoTracking().ToListAsync(_cts.Token); if (_cts.IsCancellationRequested || _disposed) return; var administrators = await tempContext.Administrators.OrderBy(a => a.Name).AsNoTracking().ToListAsync(_cts.Token); if (_cts.IsCancellationRequested || _disposed) return; Application.Current.Dispatcher.Invoke(() => { if (_cts.IsCancellationRequested || _disposed || Application.Current == null) return; AllLockerTypes = new ObservableCollection<LockerType>(types); AllFloors = new ObservableCollection<Floor>(floors); AllZones = new ObservableCollection<Zone>(zones); AllSubParts = new ObservableCollection<SubPart>(subParts); AllAdministrators = new ObservableCollection<Administrator>(administrators); if (!_cts.IsCancellationRequested && !_disposed) StatusBarText = "ë§ˆìŠ¤í„° ë°ì´í„°(ì½¤ë³´ë°•ìŠ¤ìš©) ë¡œë“œ ì™„ë£Œ."; }); } } catch (OperationCanceledException) { Debug.WriteLine("LoadMasterDataAsync ì‘ì—… ì·¨ì†Œë¨."); if (!_disposed) StatusBarText = "ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”© ì·¨ì†Œë¨."; } catch (ObjectDisposedException) { Debug.WriteLine("LoadMasterDataAsync ì‹¤í–‰ ì¤‘ DbContext Disposeë¨."); if (!_disposed) StatusBarText = "ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”© ì˜¤ë¥˜ (ì»¨í…ìŠ¤íŠ¸ í•´ì œë¨)."; } catch (Exception ex) { if (CanExecuteCommand(null) && !_cts.IsCancellationRequested) HandleGenericException("ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”©", ex); } }
        private async Task CheckMasterPassword(object parameter) { if (!CanExecuteCommand(parameter)) return; try { var masterKeySetting = await _context.AppSettings.AsNoTracking().FirstOrDefaultAsync(s => s.SettingKey == "MasterKey", _cts.Token); if (_cts.IsCancellationRequested || _disposed) return; if (masterKeySetting == null || string.IsNullOrEmpty(masterKeySetting.SettingValue)) { MessageBox.Show("ë°ì´í„°ë² ì´ìŠ¤ì— ë§ˆìŠ¤í„° í‚¤(MasterKey) ì„¤ì • ì—†ìŒ.", "ì„¤ì • ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); return; } string plainPassword = ConvertToUnsecureString(MasterPasswordInput); if (plainPassword == masterKeySetting.SettingValue) { IsMasterModeEnabled = true; IsNormalModeEnabled = false; StatusBarText = "ë§ˆìŠ¤í„° ëª¨ë“œ í™œì„±í™”."; MessageBox.Show("ë§ˆìŠ¤í„° í‚¤ í™•ì¸ ì™„ë£Œ.", "ì„±ê³µ", MessageBoxButton.OK, MessageBoxImage.Information); } else { IsMasterModeEnabled = false; MessageBox.Show("ë§ˆìŠ¤í„° í‚¤ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } } catch (OperationCanceledException) { Debug.WriteLine("CheckMasterPassword ì‘ì—… ì·¨ì†Œë¨."); } catch (Exception ex) { HandleGenericException("ë§ˆìŠ¤í„° í‚¤ í™•ì¸", ex); IsMasterModeEnabled = false; } }
        private async Task CheckNormalPassword(object parameter) { if (!CanExecuteCommand(parameter)) return; try { var normalKeySetting = await _context.AppSettings.AsNoTracking().FirstOrDefaultAsync(s => s.SettingKey == "NormalKey", _cts.Token); if (_cts.IsCancellationRequested || _disposed) return; if (normalKeySetting == null || string.IsNullOrEmpty(normalKeySetting.SettingValue)) { MessageBox.Show("ë°ì´í„°ë² ì´ìŠ¤ì— ì¼ë°˜ í‚¤(NormalKey) ì„¤ì • ì—†ìŒ.", "ì„¤ì • ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); return; } string plainPassword = ConvertToUnsecureString(NormalPasswordInput); if (plainPassword == normalKeySetting.SettingValue) { IsNormalModeEnabled = true; IsMasterModeEnabled = false; StatusBarText = "ì¼ë°˜ í¸ì§‘ ëª¨ë“œ í™œì„±í™”."; MessageBox.Show("ì¼ë°˜ í‚¤ í™•ì¸ ì™„ë£Œ.", "ì„±ê³µ", MessageBoxButton.OK, MessageBoxImage.Information); } else { IsNormalModeEnabled = false; MessageBox.Show("ì¼ë°˜ í‚¤ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } } catch (OperationCanceledException) { Debug.WriteLine("CheckNormalPassword ì‘ì—… ì·¨ì†Œë¨."); } catch (Exception ex) { HandleGenericException("ì¼ë°˜ í‚¤ í™•ì¸", ex); IsNormalModeEnabled = false; } }
        private void OpenMasterDataWindow(object parameter) { if (!CanOpenMasterDataWindow(parameter)) return; if (!BackupDataToCsv()) { if (MessageBox.Show("ë°ì´í„° ë°±ì—… ì‹¤íŒ¨. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", "ë°±ì—… ì‹¤íŒ¨", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No) return; } try { using (var masterDataVM = new MasterDataViewModel()) { var masterDataWindow = new MasterDataWindow { DataContext = masterDataVM, Owner = Application.Current.MainWindow }; masterDataWindow.ShowDialog(); _ = LoadMasterDataAsync(); _ = LoadAssignmentsAsync(); } } catch (Exception ex) { if (!App.IsShuttingDown && !_disposed) MessageBox.Show($"ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ì°½ ì—´ê¸° ì˜¤ë¥˜:\n{ex.ToString()}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); else Debug.WriteLine($"ì¢…ë£Œ ì¤‘ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ì°½ ì—´ê¸° ì˜¤ë¥˜ ë¬´ì‹œë¨: {ex.Message}"); } }
        private void OpenLogWindow(object parameter) { if (!CanExecuteCommand(parameter)) return; try { using (var logVM = new LogViewModel()) { var logWindow = new LogWindow { DataContext = logVM, Owner = Application.Current.MainWindow }; logWindow.ShowDialog(); } } catch (Exception ex) { if (!App.IsShuttingDown && !_disposed) MessageBox.Show($"ë¡œê·¸ ë³´ê¸° ì°½ ì—´ê¸° ì˜¤ë¥˜:\n{ex.ToString()}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); else Debug.WriteLine($"ì¢…ë£Œ ì¤‘ ë¡œê·¸ ë³´ê¸° ì°½ ì—´ê¸° ì˜¤ë¥˜ ë¬´ì‹œë¨: {ex.Message}"); } }
        private void OpenPasswordChangeWindow(object parameter) { if (!CanOpenPasswordChangeWindow(parameter)) return; try { PasswordChangeWindow passwordChangeWindow = null; PasswordChangeViewModel passwordChangeVM = null; bool? dialogResult = null; try { passwordChangeVM = new PasswordChangeViewModel(); passwordChangeWindow = new PasswordChangeWindow { DataContext = passwordChangeVM, Owner = Application.Current.MainWindow }; dialogResult = passwordChangeWindow.ShowDialog(); } finally { passwordChangeVM?.Dispose(); } if (dialogResult == true) { StatusBarText = "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”."; IsMasterModeEnabled = false; IsNormalModeEnabled = false; MasterPasswordInput = new SecureString(); NormalPasswordInput = new SecureString(); OnPropertyChanged(nameof(MasterPasswordInput)); OnPropertyChanged(nameof(NormalPasswordInput)); } } catch (Exception ex) { if (!App.IsShuttingDown && !_disposed) MessageBox.Show($"ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì°½ ì—´ê¸° ì˜¤ë¥˜:\n{ex.ToString()}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); else Debug.WriteLine($"ì¢…ë£Œ ì¤‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì°½ ì—´ê¸° ì˜¤ë¥˜ ë¬´ì‹œë¨: {ex.Message}"); } }

        #region CRUD ë° ê¸°íƒ€ ë©”ì„œë“œ
        private async Task SaveChangesAsync() { if (!CanSaveChangesExecute(null)) { StatusBarText = "ì €ì¥í•  ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."; return; } StatusBarText = "ë³€ê²½ ì‚¬í•­ ì €ì¥ ì¤‘..."; Debug.WriteLine($"[{DateTime.Now:HH:mm:ss.fff}] MainViewModel SaveChangesAsync ì‹œì‘: HasChanges={_context.ChangeTracker.HasChanges()}"); foreach(var entry in _context.ChangeTracker.Entries().Where(e => e.State != EntityState.Unchanged && e.State != EntityState.Detached)) { Debug.WriteLine($"  - ì¶”ì ëœ ì—”í‹°í‹° (MainVM): {entry.Entity.GetType().Name}, ìƒíƒœ: {entry.State}"); } List<DbEntityEntry> allChangedEntriesForRollback = _context.ChangeTracker.Entries().Where(e => e.State != EntityState.Unchanged).ToList(); try { var changedLockerEntries = _context.ChangeTracker.Entries<LockerAssignment>().Where(e => e.State == EntityState.Added || e.State == EntityState.Modified).ToList(); var allItemsToCheck = LockerAssignments.ToList(); var duplicates = allItemsToCheck.GroupBy(l => new { l.Floor, l.Zone, l.SpecificLocation }).Where(g => g.Count() > 1).Select(g => g.Key); if (duplicates.Any()) { MessageBox.Show($"ì €ì¥ ë¶ˆê°€: ì¤‘ë³µ ìœ„ì¹˜ ë°œê²¬ - {string.Join(", ", duplicates.Select(d => $"{d.Floor}-{d.Zone}-{d.SpecificLocation}"))}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); RollbackChanges(allChangedEntriesForRollback); return; } foreach(var entry in changedLockerEntries) { entry.Entity.Administrator = _currentAdmin; } Debug.WriteLine($"  -> MainVM _context.SaveChangesAsync í˜¸ì¶œ ì‹œë„..."); int changedCount = await _context.SaveChangesAsync(_cts.Token); Debug.WriteLine($"  -> MainVM _context.SaveChangesAsync ì™„ë£Œ. ê²°ê³¼ = {changedCount}"); StatusBarText = $"ì„±ê³µì ìœ¼ë¡œ {changedCount}ê°œ ì €ì¥ë¨."; (SaveChangesCommand as RelayCommand)?.RaiseCanExecuteChanged(); } catch (OperationCanceledException) { Debug.WriteLine("SaveChangesAsync ì‘ì—… ì·¨ì†Œë¨."); StatusBarText = "ì €ì¥ ì‘ì—… ì·¨ì†Œë¨."; RollbackChanges(allChangedEntriesForRollback); } catch (DbEntityValidationException vex) { HandleValidationException(vex); RollbackChanges(allChangedEntriesForRollback); } catch (DbUpdateException dbEx) { HandleDbUpdateException(dbEx); RollbackChanges(allChangedEntriesForRollback); } catch (Exception ex) { if (CanExecuteCommand(null) && !_cts.IsCancellationRequested) HandleGenericException("ì €ì¥", ex); RollbackChanges(allChangedEntriesForRollback); } finally { Debug.WriteLine($"[{DateTime.Now:HH:mm:ss.fff}] MainViewModel SaveChangesAsync ì¢…ë£Œ."); } }
        private void RollbackChanges(IEnumerable<DbEntityEntry> changedEntries) { if (_context == null || _disposed || changedEntries == null) return; foreach (var entry in changedEntries.ToList()) { switch (entry.State) { case EntityState.Modified: try { entry.Reload(); } catch { entry.State = EntityState.Unchanged; } break; case EntityState.Added: entry.State = EntityState.Detached; if (entry.Entity is LockerAssignment addedEntity && LockerAssignments.Contains(addedEntity)) LockerAssignments.Remove(addedEntity); break; case EntityState.Deleted: entry.State = EntityState.Unchanged; break; } } StatusBarText = "ë³€ê²½ ë¡¤ë°±ë¨."; (SaveChangesCommand as RelayCommand)?.RaiseCanExecuteChanged(); }
        private void AddNewLocker(object parameter) { if (!CanExecuteCommand(parameter)) return; if (MessageBox.Show("ìƒˆë¡œìš´ ì‚¬ë¬¼í•¨ ì •ë³´ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", "ìƒˆ ì‚¬ë¬¼í•¨ ì¶”ê°€", MessageBoxButton.YesNo, MessageBoxImage.Question) == MessageBoxResult.No) return; var newAssignment = new LockerAssignment { LockerType = AllLockerTypes.FirstOrDefault()?.Name ?? "ê°œì¸ì‚¬ë¬¼í•¨", Floor = AllFloors.FirstOrDefault()?.Name ?? "1", Zone = AllZones.FirstOrDefault()?.Name ?? "A", SpecificLocation = "ìƒˆ ìœ„ì¹˜-" + Guid.NewGuid().ToString("N").Substring(0, 4), Administrator = _currentAdmin, LastUpdated = DateTime.Now }; LockerAssignments.Add(newAssignment); _context.LockerAssignments.Add(newAssignment); SelectedAssignment = newAssignment; StatusBarText = "ìƒˆ ì‚¬ë¬¼í•¨ ì¶”ê°€ë¨. ì €ì¥ í•„ìš”."; try { var entryState = _context.Entry(newAssignment).State; bool hasChangesNow = _context.ChangeTracker.HasChanges(); Debug.WriteLine($"[{DateTime.Now:HH:mm:ss.fff}] AddNewLocker ì™„ë£Œ: ìƒˆ ì—”í‹°í‹° ìƒíƒœ = {entryState}, HasChanges = {hasChangesNow}"); if (entryState != EntityState.Added || !hasChangesNow) { Debug.WriteLine("!!! ê²½ê³ : AddNewLocker í›„ ì—”í‹°í‹° ìƒíƒœê°€ Addedê°€ ì•„ë‹ˆê±°ë‚˜ HasChangesê°€ falseì…ë‹ˆë‹¤."); } } catch (Exception ex) { Debug.WriteLine($"!!! AddNewLocker ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜: {ex.Message}"); } (SaveChangesCommand as RelayCommand)?.RaiseCanExecuteChanged(); }
        private async Task DeleteSelectedAsync() { if (!CanDeleteExecute(null)) return; if (MessageBox.Show($"'{SelectedAssignment.Floor}-{SelectedAssignment.Zone}-{SelectedAssignment.SpecificLocation}' ì‚­ì œ?", "í™•ì¸", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.Yes) { StatusBarText = "ì‚­ì œ ì¤‘..."; List<DbEntityEntry> changesForRollback = _context.ChangeTracker.Entries().Where(e => e.State != EntityState.Unchanged).ToList(); try { var assignmentToDelete = SelectedAssignment; var entry = _context.Entry(assignmentToDelete); if (entry.State == EntityState.Detached) { _context.LockerAssignments.Attach(assignmentToDelete); } _context.LockerAssignments.Remove(assignmentToDelete); Debug.WriteLine($"  -> MainVM _context.SaveChangesAsync í˜¸ì¶œ ì‹œë„ (ì‚­ì œ)..."); int changedCount = await _context.SaveChangesAsync(_cts.Token); Debug.WriteLine($"  -> MainVM _context.SaveChangesAsync ì™„ë£Œ (ì‚­ì œ). ê²°ê³¼ = {changedCount}"); LockerAssignments.Remove(assignmentToDelete); SelectedAssignment = null; StatusBarText = $"ì„±ê³µì ìœ¼ë¡œ {changedCount}ê°œ ì‚­ì œë¨."; (SaveChangesCommand as RelayCommand)?.RaiseCanExecuteChanged(); } catch (OperationCanceledException) { Debug.WriteLine("DeleteSelectedAsync ì‘ì—… ì·¨ì†Œë¨."); StatusBarText = "ì‚­ì œ ì‘ì—… ì·¨ì†Œë¨."; RollbackChanges(changesForRollback); } catch (DbUpdateException dbEx) { HandleDbUpdateException(dbEx); RollbackChanges(changesForRollback); await LoadAssignmentsAsync(); } catch (Exception ex) { if (CanExecuteCommand(null) && !_cts.IsCancellationRequested) HandleGenericException("ì‚­ì œ", ex); RollbackChanges(changesForRollback); await LoadAssignmentsAsync(); } } }
        #endregion

        #region Backup Logic (CSV)
        private bool BackupDataToCsv() { string backupDir = @"C:\agent"; string fileName = $"LockerBackup_{DateTime.Now:yyyyMMdd_HHmmss}.csv"; string filePath = Path.Combine(backupDir, fileName); StatusBarText = "ë°ì´í„° ë°±ì—… ì‹œì‘..."; try { Directory.CreateDirectory(backupDir); using (var backupContext = new LockerDbContext()) using (var writer = new StreamWriter(filePath, false, Encoding.UTF8)) { WriteTableToCsv<LockerType>(backupContext, writer); WriteTableToCsv<Floor>(backupContext, writer); WriteTableToCsv<Zone>(backupContext, writer); WriteTableToCsv<SubPart>(backupContext, writer); WriteTableToCsv<Administrator>(backupContext, writer); WriteTableToCsv<LockerAssignment>(backupContext, writer); WriteTableToCsv<AuditLog>(backupContext, writer); } StatusBarText = $"ë°ì´í„° ë°±ì—… ì™„ë£Œ: {filePath}"; if (!_disposed && !App.IsShuttingDown) MessageBox.Show($"ë°ì´í„°ê°€ ë‹¤ìŒ ìœ„ì¹˜ì— ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤:\n{filePath}", "ë°±ì—… ì™„ë£Œ", MessageBoxButton.OK, MessageBoxImage.Information); return true; } catch (Exception ex) { StatusBarText = $"ë°ì´í„° ë°±ì—… ì‹¤íŒ¨: {ex.Message}"; if (!_disposed && !App.IsShuttingDown) MessageBox.Show($"ë°ì´í„° ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n{ex.ToString()}", "ë°±ì—… ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); return false; } }
        private void WriteTableToCsv<T>(LockerDbContext context, StreamWriter writer) where T : class { var dbSet = context.Set<T>(); var entityType = typeof(T); var properties = entityType.GetProperties().Where(p => p.GetGetMethod().IsVirtual == false).ToList(); writer.WriteLine($"--- Table: {entityType.Name} ---"); writer.WriteLine(string.Join(",", properties.Select(p => EscapeCsvValue(p.Name)))); foreach (var entity in dbSet.AsNoTracking()) { var values = properties.Select(p => EscapeCsvValue(p.GetValue(entity)?.ToString() ?? "")); writer.WriteLine(string.Join(",", values)); } writer.WriteLine(); writer.WriteLine(); }
        private string EscapeCsvValue(string value) { if (string.IsNullOrEmpty(value)) return ""; if (value.Contains(",") || value.Contains("\"") || value.Contains("\r") || value.Contains("\n")) { return $"\"{value.Replace("\"", "\"\"")}\""; } return value; }
        #endregion

        #region Highlight Logic
        public EntityState GetEntityState(object entity) { if (_context == null || _disposed || entity == null) return EntityState.Detached; try { return _context.Entry(entity).State; } catch (Exception ex) { Debug.WriteLine($"GetEntityState ì˜¤ë¥˜: {ex.Message}"); return EntityState.Detached; } }
        public void UpdateHighlightInfo(string fieldName, LockerAssignment currentItem) { var targetColumns = new List<string> { "LockerType", "Floor", "Zone", "SubPart", "Administrator" }; if (currentItem != null && fieldName != null && targetColumns.Contains(fieldName)) { var propertyInfo = typeof(LockerAssignment).GetProperty(fieldName); if (propertyInfo != null) { SelectedCellValue = propertyInfo.GetValue(currentItem); SelectedCellColumnFieldName = fieldName; } else { ClearHighlightInfo(); } } else { ClearHighlightInfo(); } }
        private void ClearHighlightInfo() { SelectedCellValue = null; SelectedCellColumnFieldName = null; }
        #endregion

        #region Timer Logic for Re-Authentication
        private void SetupReAuthTimer() { _reAuthTimer = new DispatcherTimer { Interval = TimeSpan.FromSeconds(81) }; _reAuthTimer.Tick += Timer_Tick; _reAuthTimer.Start(); Debug.WriteLine("ì¬ì¸ì¦ íƒ€ì´ë¨¸ ì‹œì‘ë¨ (81ì´ˆ ê°„ê²©)."); }
        private void Timer_Tick(object sender, EventArgs e) { if (IsMasterModeEnabled || IsNormalModeEnabled) { Debug.WriteLine($"[{DateTime.Now:HH:mm:ss.fff}] ì¬ì¸ì¦ íƒ€ì´ë¨¸ ë°œìƒ. í¸ì§‘ ëª¨ë“œë¥¼ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤."); IsMasterModeEnabled = false; IsNormalModeEnabled = false; StatusBarText = "ë³´ì•ˆì„ ìœ„í•´ ì¬ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤."; } }
        #endregion

        #region Helper Methods
        private void HandleGenericException(string operation, Exception ex) { if (App.IsShuttingDown || _disposed) { Debug.WriteLine($"ì¢…ë£Œ ì¤‘ {operation} ì˜¤ë¥˜ ë¬´ì‹œë¨: {ex.Message}"); return; } StatusBarText = $"{operation} ì˜¤ë¥˜: {ex.Message}"; MessageBox.Show($"{operation} ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n{ex.ToString()}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); }
        private void HandleDbUpdateException(DbUpdateException dbEx) { if (App.IsShuttingDown || _disposed) { Debug.WriteLine($"ì¢…ë£Œ ì¤‘ DB ì—…ë°ì´íŠ¸ ì˜¤ë¥˜ ë¬´ì‹œë¨: {dbEx.Message}"); return; } Exception innerMostException = dbEx; while (innerMostException.InnerException != null) innerMostException = innerMostException.InnerException; string innerExMsg = innerMostException.Message; var validationErrors = dbEx.Entries.SelectMany(e => e.GetValidationResult().ValidationErrors); string validationErrorMsg = ""; if (validationErrors.Any()) validationErrorMsg = "\n\nìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜:\n" + string.Join("\n", validationErrors.Select(err => $" - {err.PropertyName}: {err.ErrorMessage}")); StatusBarText = $"DB ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: {innerExMsg}"; MessageBox.Show($"ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n{innerExMsg}{validationErrorMsg}\n\n(ì „ì²´ ì˜¤ë¥˜: {dbEx.ToString()})", "DB ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); try { foreach(var entry in dbEx.Entries) { entry.Reload(); } } catch { /* Reload ì‹¤íŒ¨ ë¬´ì‹œ */ } }
        private void HandleValidationException(DbEntityValidationException vex) { if (App.IsShuttingDown || _disposed) { Debug.WriteLine($"ì¢…ë£Œ ì¤‘ ìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜ ë¬´ì‹œë¨: {vex.Message}"); return; } var errorMessages = vex.EntityValidationErrors.SelectMany(x => x.ValidationErrors).Select(x => $"{x.PropertyName}: {x.ErrorMessage}"); var fullErrorMessage = string.Join("\n", errorMessages); var exceptionMessage = $"ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜:\n{fullErrorMessage}"; StatusBarText = "ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜ ë°œìƒ"; MessageBox.Show(exceptionMessage, "ìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); Debug.WriteLine($"!!! DbEntityValidationException ë°œìƒ:\n{exceptionMessage}\n{vex.ToString()}"); }
        private string ConvertToUnsecureString(SecureString securePassword) { if (securePassword == null) return string.Empty; IntPtr ptr = IntPtr.Zero; try { ptr = Marshal.SecureStringToGlobalAllocUnicode(securePassword); return Marshal.PtrToStringUni(ptr); } finally { Marshal.ZeroFreeGlobalAllocUnicode(ptr); } }
        #endregion
