using DevExpress.XtraPivotGrid;

// PivotGridControl 생성
PivotGridControl pivotGrid = new PivotGridControl();

// PivotGrid 설정
pivotGrid.BeginUpdate();
pivotGrid.DataSource = table_rpa_runlog; // 테이블 조회 결과를 바인딩
PivotGridField fieldDate = new PivotGridField("rpastart", PivotArea.RowArea); // 날짜 필드
fieldDate.Caption = "날짜";
fieldDate.GroupInterval = PivotGroupInterval.Date; // 날짜별 그룹화
pivotGrid.Fields.Add(fieldDate);

PivotGridField fieldTotalCount = new PivotGridField("mailok", PivotArea.DataArea); // 총 횟수 필드
fieldTotalCount.Caption = "총 횟수";
fieldTotalCount.SummaryType = DevExpress.Data.PivotGrid.PivotSummaryType.Count;
pivotGrid.Fields.Add(fieldTotalCount);

PivotGridField fieldSuccessCount = new PivotGridField("mailok", PivotArea.DataArea); // 성공 횟수 필드
fieldSuccessCount.Caption = "성공 횟수";
fieldSuccessCount.SummaryType = DevExpress.Data.PivotGrid.PivotSummaryType.Count;
fieldSuccessCount.FilterValues.Add(true); // 성공인 경우 필터링
pivotGrid.Fields.Add(fieldSuccessCount);

PivotGridField fieldSuccessRate = new PivotGridField("성공율", PivotArea.DataArea); // 성공율 필드
fieldSuccessRate.Caption = "성공율";
fieldSuccessRate.SummaryType = DevExpress.Data.PivotGrid.PivotSummaryType.Custom; // 사용자 정의 집계
fieldSuccessRate.CustomSummary += (sender, e) =>
{
    if (e.DataField == fieldSuccessRate)
    {
        int totalCount = Convert.ToInt32(e.GetCellValue(fieldTotalCount)); // 총 횟수 필드
        int successCount = Convert.ToInt32(e.GetCellValue(fieldSuccessCount)); // 성공 횟수 필드
        if (totalCount > 0)
        {
            e.CustomValue = (double)successCount / totalCount; // 성공율 계산
        }
    }
};
pivotGrid.Fields.Add(fieldSuccessRate);

pivotGrid.EndUpdate();
