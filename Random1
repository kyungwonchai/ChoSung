from flask import Flask, redirect, request
import pyodbc
import uuid

app = Flask(__name__)

# MSSQL 연결 설정
server = 'your-server-name'
database = 'your-database-name'
username = 'your-username'
password = 'your-password'
cnxn = pyodbc.connect('DRIVER={ODBC Driver 17 for SQL Server};SERVER='+server+';DATABASE='+database+';UID='+username+';PWD='+password)
cursor = cnxn.cursor()

# 사용자 식별자와 조건을 연결하는 딕셔너리 (임시로 예시로 작성)
conditions = {}

# 고유한 링크 생성 및 사용자에게 전달
@app.route('/generate-link', methods=['POST'])
def generate_link():
    user_id = str(uuid.uuid4())  # 사용자에게 고유한 식별자 생성
    condition = request.form['condition']  # 사용자의 조건을 전달받습니다.

    link = f'/redirect-page/{user_id}'  # 식별자와 연결된 링크 생성
    conditions[user_id] = condition  # 식별자와 조건을 딕셔너리에 저장

    return f'고유한 링크 생성 완료: {link}'

# 링크를 통한 리다이렉션 처리
@app.route('/redirect-page/<string:user_id>')
def redirect_page(user_id):
    condition = conditions.get(user_id)  # 딕셔너리에서 식별자에 해당하는 조건을 가져옴

    if condition:
        # MSSQL에서 해당 사용자의 조건에 해당하는 값을 조회하는 쿼리를 실행
        query = f"SELECT value FROM your_table WHERE condition='{condition}'"
        cursor.execute(query)
        result = cursor.fetchone()

        if result:
            value = result[0]  # 조회된 값
            return f'조건에 해당하는 값: {value}'
        else:
            return '값을 찾을 수 없습니다.'
    else:
        return '링크가 유효하지 않습니다.'

if __name__ == '__main__':
    app.run()
