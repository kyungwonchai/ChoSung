using System.Collections.Concurrent;
using System.Threading.Tasks;

ConcurrentQueue<string> queryQueue = new ConcurrentQueue<string>();

// 첫 번째 태스크: 데이터 체크 및 쿼리 생성
var produceTask = Task.Run(() => 
{
    foreach(var item in someCollection)
    {
        if(/* your condition */)
        {
            string query = /* 생성된 쿼리 */;
            queryQueue.Enqueue(query);
        }
    }
});

// 두 번째 태스크: 벌크 인서트
var consumeTask = Task.Run(() => 
{
    List<string> bulkQueries = new List<string>();

    while(!produceTask.IsCompleted || !queryQueue.IsEmpty)
    {
        if(queryQueue.TryDequeue(out string query))
        {
            bulkQueries.Add(query);

            if(bulkQueries.Count >= 50)
            {
                BulkInsert(bulkQueries);
                bulkQueries.Clear();
            }
        }
    }

    // 마지막 나머지 쿼리 처리
    if(bulkQueries.Count > 0)
    {
        BulkInsert(bulkQueries);
    }
});

Task.WaitAll(produceTask, consumeTask);

void BulkInsert(List<string> queries)
{
    // 여기에서 벌크 인서트 로직을 작성하세요
}
