import os

# 1. íŒŒì¼ ë° í´ë” êµ¬ì¡° ìƒì„±
def setup_project():
    # í´ë” ìƒì„±
    if not os.path.exists('templates'):
        os.makedirs('templates')

    # HTML í…œí”Œë¦¿ ì‘ì„± (index.html)
    html_content = """
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©í™”ë²½ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 30px; }
        .table-hover tbody tr:hover { background-color: #f1f1f1; cursor: pointer; }
        .expiry-near { color: red; font-weight: bold; }
        pre { white-space: pre-wrap; word-wrap: break-word; background: #eee; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">ğŸ›¡ï¸ ë°©í™”ë²½ ê´€ë¦¬ ëª©ë¡ (ë§Œë£Œ ì„ë°•ìˆœ)</h2>
        
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addModal">ì‹ ê·œ ë“±ë¡</button>

        <table class="table table-bordered table-hover shadow-sm bg-white">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>ì œëª©</th>
                    <th>ë‚´ìš©</th>
                    <th>ì¶œë°œ/ë„ì°© ìœ„ì¹˜</th>
                    <th>ë§Œë£Œì¼</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for item in list %}
                <tr>
                    <td>{{ item.id }}</td>
                    <td>{{ item.title }}</td>
                    <td>{{ item.content }}</td>
                    <td>{{ item.src_dest }}</td>
                    <td class="expiry-near">{{ item.expiry_date }}</td>
                    <td>
                        <button class="btn btn-sm btn-info text-white" onclick="showDetails('{{ item.id }}')">ì„¸ë¶€ë‚´ìš©</button>
                        <a href="/delete/{{ item.id }}" class="btn btn-sm btn-danger" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                    </td>
                </tr>
                <div id="detail_data_{{ item.id }}" style="display:none;">{{ item.details }}</div>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form action="/add" method="POST" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ì‹ ê·œ ë°©í™”ë²½ ê·œì¹™ ë“±ë¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label>ì œëª©</label><input type="text" name="title" class="form-control" required></div>
                    <div class="mb-3"><label>ë‚´ìš©</label><input type="text" name="content" class="form-control" required></div>
                    <div class="mb-3"><label>ì¶œë°œ/ë„ì°© ìœ„ì¹˜</label><input type="text" name="src_dest" class="form-control" required></div>
                    <div class="mb-3"><label>ë§Œë£Œì‹œê°„</label><input type="date" name="expiry_date" class="form-control" required></div>
                    <div class="mb-3">
                        <label>ì„¸ë¶€ë‚´ìš© (CSV/Text ë³µì‚¬ ë¶™ì—¬ë„£ê¸°)</label>
                        <textarea name="details" class="form-control" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìƒì„¸ ë©”ëª¨ ë‚´ìš©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="detail_viewer"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showDetails(id) {
            const content = document.getElementById('detail_data_' + id).innerText;
            document.getElementById('detail_viewer').innerText = content;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }
    </script>
</body>
</html>
    """
    with open('templates/index.html', 'w', encoding='utf-8') as f:
        f.write(html_content)

    # 2. app.py ì‘ì„±
    app_py_content = """
from flask import Flask, render_template, request, redirect
import pymssql

app = Flask(__name__)

# --- DB ì„¤ì • (ê²½ì›ë‹˜ ì •ë³´ ë°˜ì˜) ---
DB_CONFIG = {
    'server': '10.244.123.102',
    'port': 1633,
    'user': 'YOUR_ID',        # ì‹¤ì œ ID ì…ë ¥ í•„ìš”
    'password': 'YOUR_PASSWORD', # ì‹¤ì œ PW ì…ë ¥ í•„ìš”
    'database': 'KW_DesktopDB'
}

TABLE_NAME = "firewall26_list"

def get_db_connection():
    return pymssql.connect(
        server=DB_CONFIG['server'],
        port=DB_CONFIG['port'],
        user=DB_CONFIG['user'],
        password=DB_CONFIG['password'],
        database=DB_CONFIG['database'],
        charset='utf8'
    )

def init_db():
    conn = get_db_connection()
    cursor = conn.cursor()
    # í…Œì´ë¸” ìƒì„± (ì—†ì„ ê²½ìš°)
    cursor.execute(f'''
        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='{TABLE_NAME}' AND xtype='U')
        CREATE TABLE {TABLE_NAME} (
            id INT IDENTITY(1,1) PRIMARY KEY,
            title NVARCHAR(255),
            content NVARCHAR(255),
            src_dest NVARCHAR(255),
            details NVARCHAR(MAX),
            expiry_date DATE
        )
    ''')
    conn.commit()
    conn.close()

@app.route('/')
def index():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    # ë§Œë£Œê¸°ê°„ ì˜¤ë¦„ì°¨ìˆœ(ê°€ê¹Œìš´ ë‚ ì§œ ìˆœ) ì •ë ¬
    cursor.execute(f"SELECT * FROM {TABLE_NAME} ORDER BY expiry_date ASC")
    rows = cursor.fetchall()
    conn.close()
    return render_template('index.html', list=rows)

@app.route('/add', method=['POST']) # ì˜¤íƒ€ ìˆ˜ì • ê°€ëŠ¥ì„± ëŒ€ë¹„ methods
@app.route('/add', methods=['POST'])
def add():
    data = request.form
    conn = get_db_connection()
    cursor = conn.cursor()
    sql = f"INSERT INTO {TABLE_NAME} (title, content, src_dest, details, expiry_date) VALUES (%s, %s, %s, %s, %s)"
    cursor.execute(sql, (data['title'], data['content'], data['src_dest'], data['details'], data['expiry_date']))
    conn.commit()
    conn.close()
    return redirect('/')

@app.route('/delete/<int:id>')
def delete(id):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute(f"DELETE FROM {TABLE_NAME} WHERE id = %d", (id,))
    conn.commit()
    conn.close()
    return redirect('/')

if __name__ == '__main__':
    init_db()
    # ìš°ë¶„íˆ¬ ì„œë²„ì—ì„œ ì™¸ë¶€ ì ‘ì† í—ˆìš©ì„ ìœ„í•´ 0.0.0.0ìœ¼ë¡œ ì‹¤í–‰
    app.run(host='0.0.0.0', port=5000, debug=True)
    """
    with open('app.py', 'w', encoding='utf-8') as f:
        f.write(app_py_content)

    print("âœ… í”„ë¡œì íŠ¸ íŒŒì¼ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    print("ğŸ‘‰ 'app.py' íŒŒì¼ ìƒë‹¨ì˜ DB_USERì™€ DB_PASSWORDë¥¼ ìˆ˜ì • í›„ ì‹¤í–‰í•˜ì„¸ìš”.")

if __name__ == "__main__":
    setup_project()