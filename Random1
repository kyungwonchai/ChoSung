-- Step 1: 동적 SQL을 위한 고유 module1 값 조회 (가정)
DECLARE @columns NVARCHAR(MAX), @sql NVARCHAR(MAX);

SELECT @columns = COALESCE(@columns + ', ', '') + QUOTENAME(module1)
FROM (SELECT DISTINCT module1 FROM YourSecondTable) AS Modules;

-- Step 2: 동적 SQL을 구성하여 피벗 쿼리 실행
SET @sql = N'SELECT p.sensor, p.valavg1, p.unit, p.lcl, p.ucl, ' + @columns + '
             FROM 
             (
                 SELECT sensor, valavg1, unit, lcl, ucl
                 FROM YourFirstTable
             ) AS p
             JOIN 
             (
                 SELECT module1, val1, sensor
                 FROM YourSecondTable
             ) AS d
             PIVOT
             (
                 SUM(val1)
                 FOR module1 IN (' + @columns + ')
             ) AS pv';

-- Step 3: 동적 SQL 실행
EXEC sp_executesql @sql;
