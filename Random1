using System;
using System.Data.SqlClient;
using System.Windows.Forms;
using DevExpress.XtraEditors;
using DevExpress.XtraGrid.Views.Grid;
using DevExpress.XtraDiagram;

public partial class MainForm : XtraForm
{
    private string g_loginid;
    private SqlConnection connection;

    public MainForm()
    {
        InitializeComponent();
        connection = new SqlConnection("Data Source=서버주소;Initial Catalog=데이터베이스명;User ID=사용자명;Password=비밀번호;");
    }

    private void MainForm_Load(object sender, EventArgs e)
    {
        connection.Open();

        LoadData();

        gridView1.RowClick += GridView1_RowClick;
    }

    private void LoadData()
    {
        string selectQuery = "SELECT * FROM View_ProjectList";
        SqlDataAdapter dataAdapter = new SqlDataAdapter(selectQuery, connection);
        System.Data.DataTable dataTable = new System.Data.DataTable();
        dataAdapter.Fill(dataTable);
        gridControl1.DataSource = dataTable;
    }

    private void ButtonAdd_Click(object sender, EventArgs e)
    {
        string pname = textEdit1.Text;

        if (!string.IsNullOrEmpty(pname))
        {
            AddNewProject(pname);

            LoadData();
        }
    }

    private void AddNewProject(string pname)
    {
        string insertQuery = $"INSERT INTO T1_ProjectList (Pname, Date1, loginid) VALUES (@Pname, GETDATE(), @Loginid)";
        using (SqlCommand command = new SqlCommand(insertQuery, connection))
        {
            command.Parameters.AddWithValue("@Pname", pname);
            command.Parameters.AddWithValue("@Loginid", g_loginid);
            command.ExecuteNonQuery();
        }
    }

    private void GridView1_RowClick(object sender, RowClickEventArgs e)
    {
        GridView gridView = (GridView)sender;
        int selectedRowHandle = gridView.FocusedRowHandle;
        string pname = (string)gridView.GetRowCellValue(selectedRowHandle, "Pname");

        FilterProjectDetails(pname);

        gridView2.DoubleClick += GridView2_DoubleClick;
    }

    private void FilterProjectDetails(string pname)
    {
        string selectQuery = "SELECT * FROM View_ProjectDetail WHERE Pname = @Pname AND loginid = @Loginid";
        SqlDataAdapter dataAdapter = new SqlDataAdapter(selectQuery, connection);
        dataAdapter.SelectCommand.Parameters.AddWithValue("@Pname", pname);
        dataAdapter.SelectCommand.Parameters.AddWithValue("@Loginid", g_loginid);
        System.Data.DataTable dataTable = new System.Data.DataTable();
        dataAdapter.Fill(dataTable);
        gridControl2.DataSource = dataTable;
    }

    private void GridView2_DoubleClick(object sender, EventArgs e)
    {
        GridView gridView = (GridView)sender;
        int selectedRowHandle = gridView.FocusedRowHandle;
        string diagram = (string)gridView.GetRowCellValue(selectedRowHandle, "Diagram");

        diagramControl1.LoadDocumentFromString(diagram);
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing && (components != null))
        {
            components.Dispose();
        }
        base.Dispose(disposing);
        connection.Close();
    }
}
