import os
import csv
from datetime import datetime

# Log file directory
log_directory = "c:/test"

# List to store the parsed log data
log_data = []

# Iterate through all .txt files in the directory (no subdirectories)
for filename in os.listdir(log_directory):
    if filename.endswith(".txt") and "commandqueue" not in filename.lower():
        file_path = os.path.join(log_directory, filename)
        
        # Open and read the file once, process all lines at once
        with open(file_path, 'r', encoding='utf-8') as file:
            lines = file.readlines()
            for line in lines:
                # Extract time value enclosed in [] and the remaining part as SentValue
                if '[' in line and ']' in line:
                    start_idx = line.index('[')
                    end_idx = line.index(']', start_idx) + 1
                    time_value = line[start_idx:end_idx]  # Extract the time value with brackets
                    remaining_value = line[end_idx:].strip()  # Remaining part of the line as SentValue
                    
                    log_data.append([time_value, remaining_value])

# Sort the log data by the time value
log_data.sort(key=lambda x: x[0])

# Prepare the output directory
output_directory = "c:/test/csv2"
os.makedirs(output_directory, exist_ok=True)

# Create the output file name with the current timestamp
timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
output_file = os.path.join(output_directory, f"{timestamp}_log_output.csv")

# Save the sorted data to a CSV file
with open(output_file, 'w', newline='', encoding='utf-8-sig') as csvfile:
    csvwriter = csv.writer(csvfile)
    # Write column headers
    csvwriter.writerow(["Time", "SentValue"])
    # Write all the data at once
    csvwriter.writerows(log_data)
