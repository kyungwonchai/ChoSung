import os
import json

# === í”„ë¡œì íŠ¸ ë£¨íŠ¸ ===
ROOT = "db_master_tool"
TEMPLATES = os.path.join(ROOT, "templates")

# === ë””ë ‰í† ë¦¬ ìƒì„± ===
if not os.path.exists(TEMPLATES):
    os.makedirs(TEMPLATES)

# ==============================================================================
# 1. app.py (ë°±ì—”ë“œ ë¡œì§: ì„¤ì • ê´€ë¦¬ + ì§„ë‹¨ ì—”ì§„)
# ==============================================================================
app_code = r"""
import os
import json
import traceback
import datetime
from flask import Flask, render_template, request, jsonify, Response, stream_with_context
import pymysql
import pymssql

app = Flask(__name__)
CONFIG_FILE = 'db_config.json'

# === [ì„¤ì • ê´€ë¦¬] JSON íŒŒì¼ë¡œ DB ì •ë³´ ì˜êµ¬ ì €ì¥ ===
def load_configs():
    if not os.path.exists(CONFIG_FILE):
        return {}
    try:
        with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    except:
        return {}

def save_configs(configs):
    with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
        json.dump(configs, f, indent=4, ensure_ascii=False)

# === [ìœ í‹¸] HTML ë¡œê·¸ í¬ë§¤í„° ===
def log_msg(msg, level="INFO"):
    ts = datetime.datetime.now().strftime("%H:%M:%S")
    colors = {"INFO":"#ccc", "OK":"#28a745", "WARN":"#ffc107", "ERROR":"#dc3545", "HEADER":"#17a2b8"}
    c = colors.get(level, "#ccc")
    icon = {"INFO":"â„¹ï¸", "OK":"âœ…", "WARN":"âš ï¸", "ERROR":"âŒ", "HEADER":"ğŸš€"}.get(level, "")
    return f'<div style="color:{c}; font-family:monospace; margin:4px 0;">[{ts}] {icon} {msg}</div>\n'

def table_html(data):
    if not data: return '<div style="color:#666; margin-left:15px; font-style:italic;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
    headers = data[0].keys()
    html = '<table class="table table-dark table-sm table-bordered" style="font-size:0.85rem; margin-top:5px;">'
    html += '<thead class="thead-light"><tr>' + ''.join([f'<th>{h}</th>' for h in headers]) + '</tr></thead><tbody>'
    for row in data:
        html += '<tr>' + ''.join([f'<td>{str(v)[:100]}</td>' for v in row.values()]) + '</tr>'
    html += '</tbody></table>'
    return html

# === [ë¼ìš°íŠ¸] í˜ì´ì§€ ì´ë™ ===
@app.route('/')
def index():
    return render_template('index.html')

@app.route('/settings')
def settings():
    return render_template('settings.html')

# === [API] ì„¤ì • CRUD ===
@app.route('/api/config', methods=['GET', 'POST', 'DELETE'])
def api_config():
    configs = load_configs()
    
    if request.method == 'GET':
        return jsonify(configs)
    
    if request.method == 'POST':
        data = request.json
        name = data.get('alias')
        if not name: return jsonify({"error": "ë³„ì¹­(Alias)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."}), 400
        configs[name] = data
        save_configs(configs)
        return jsonify({"success": True})
    
    if request.method == 'DELETE':
        name = request.json.get('alias')
        if name in configs:
            del configs[name]
            save_configs(configs)
        return jsonify({"success": True})

# === [í•µì‹¬] ì§„ë‹¨ ì‹¤í–‰ (Streaming) ===
@app.route('/run_diag', methods=['POST'])
def run_diag():
    target_name = request.form.get('target_name')
    checked_items = request.form.getlist('checks[]') # ì²´í¬ëœ í•­ëª© ë¦¬ìŠ¤íŠ¸
    
    configs = load_configs()
    target_cfg = configs.get(target_name)

    def generate():
        if not target_cfg:
            yield log_msg("ì„¤ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "ERROR")
            return

        db_type = target_cfg.get('db_type')
        host = target_cfg.get('host')
        
        yield log_msg(f"[{target_name}] {db_type.upper()} ì§„ë‹¨ ì‹œì‘... ({host})", "HEADER")
        
        conn = None
        try:
            # 1. DB ì—°ê²°
            if db_type == 'mssql':
                conn = pymssql.connect(
                    server=target_cfg['host'], 
                    port=int(target_cfg['port']), 
                    user=target_cfg['user'], 
                    password=target_cfg['password'], 
                    database=target_cfg.get('db_name', 'master')
                )
                cursor = conn.cursor(as_dict=True)
            elif db_type == 'mysql':
                conn = pymysql.connect(
                    host=target_cfg['host'], 
                    port=int(target_cfg['port']), 
                    user=target_cfg['user'], 
                    password=target_cfg['password'], 
                    charset='utf8mb4',
                    cursorclass=pymysql.cursors.DictCursor
                )
                cursor = conn.cursor()
            
            yield log_msg("DB ì—°ê²° ì„±ê³µ. ì„ íƒëœ í•­ëª© ì ê²€ ì‹œì‘.", "OK")
            
            # 2. ì²´í¬ í•­ëª©ë³„ ì‹¤í–‰ ë¡œì§
            # === [MSSQL] ===
            if db_type == 'mssql':
                if 'cpu' in checked_items:
                    yield log_msg("1. CPU ê³¼ë¶€í•˜ ì•…ì„± ì¿¼ë¦¬ ë¶„ì„", "WARN")
                    sql = "SELECT TOP 10 SUBSTRING(qt.text, (qs.statement_start_offset/2)+1, ((CASE qs.statement_end_offset WHEN -1 THEN DATALENGTH(qt.text) ELSE qs.statement_end_offset END - qs.statement_start_offset)/2) + 1) AS [Query], qs.execution_count, qs.total_worker_time/1000 AS [TotalCPU_ms], qs.last_execution_time FROM sys.dm_exec_query_stats qs CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) qt ORDER BY qs.total_worker_time DESC"
                    cursor.execute(sql)
                    yield table_html(cursor.fetchall())

                if 'lock' in checked_items:
                    yield log_msg("2. Blocking / Deadlock ì„¸ì…˜ ì¶”ì ", "WARN")
                    sql = "SELECT spid, blocked, status, loginame, hostname, cmd, wait_time, lastwaittype FROM sys.sysprocesses WHERE blocked > 0 OR spid IN (SELECT blocked FROM sys.sysprocesses)"
                    cursor.execute(sql)
                    yield table_html(cursor.fetchall())

                if 'missing_idx' in checked_items:
                    yield log_msg("3. ëˆ„ë½ ì¸ë±ìŠ¤ ì¶”ì²œ", "WARN")
                    sql = "SELECT TOP 10 d.statement AS [Table], ROUND(s.avg_total_user_cost * s.avg_user_impact * (s.user_seeks + s.user_scans),0) AS [Score], mid.equality_columns FROM sys.dm_db_missing_index_group_stats s JOIN sys.dm_db_missing_index_groups g ON s.group_handle = g.index_group_handle JOIN sys.dm_db_missing_index_details mid ON mid.index_handle = g.index_handle ORDER BY [Score] DESC"
                    cursor.execute(sql)
                    yield table_html(cursor.fetchall())

                if 'storage' in checked_items:
                    yield log_msg("4. íŒŒì¼ ìš©ëŸ‰ ì ê²€", "INFO")
                    sql = "SELECT d.name, ROUND(SUM(mf.size) * 8 / 1024, 0) AS SizeMB FROM sys.master_files mf JOIN sys.databases d ON mf.database_id = d.database_id GROUP BY d.name ORDER BY SizeMB DESC"
                    cursor.execute(sql)
                    yield table_html(cursor.fetchall())
            
            # === [MySQL] ===
            elif db_type == 'mysql':
                if 'process' in checked_items:
                    yield log_msg("1. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ (Processlist)", "WARN")
                    cursor.execute("SELECT id, user, host, db, command, time, state, info FROM information_schema.processlist WHERE command != 'Sleep' ORDER BY time DESC LIMIT 20")
                    yield table_html(cursor.fetchall())

                if 'storage' in checked_items:
                    yield log_msg("2. í…Œì´ë¸” ìš©ëŸ‰ TOP 20", "INFO")
                    cursor.execute("SELECT table_schema, table_name, round(((data_length + index_length) / 1024 / 1024), 2) as SizeMB, table_rows FROM information_schema.TABLES WHERE table_schema NOT IN ('information_schema', 'mysql', 'performance_schema', 'sys') ORDER BY SizeMB DESC LIMIT 20")
                    yield table_html(cursor.fetchall())

                if 'status' in checked_items:
                    yield log_msg("3. ì£¼ìš” ìƒíƒœ ë³€ìˆ˜ (Connections, Aborted)", "WARN")
                    cursor.execute("SHOW GLOBAL STATUS WHERE Variable_name IN ('Aborted_connects', 'Threads_connected', 'Threads_running', 'Slow_queries', 'Uptime')")
                    yield table_html(cursor.fetchall())

            yield log_msg("âœ¨ ì„ íƒëœ ëª¨ë“  ì§„ë‹¨ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "HEADER")

        except Exception as e:
            yield log_msg(f"ì—ëŸ¬ ë°œìƒ: {str(e)}", "ERROR")
            yield log_msg(traceback.format_exc(), "ERROR")
        finally:
            if conn: conn.close()

    return Response(stream_with_context(generate()), mimetype='text/html')

if __name__ == '__main__':
    # 0.0.0.0ìœ¼ë¡œ ì—´ì–´ì„œ ì™¸ë¶€ ì ‘ì† ê°€ëŠ¥í•˜ê²Œ í•¨
    app.run(host='0.0.0.0', port=5000, debug=True)
"""

# ==============================================================================
# 2. templates/index.html (ë©”ì¸ í™”ë©´: DB ì„ íƒ -> ì²´í¬ë°•ìŠ¤ -> ì‹¤í–‰)
# ==============================================================================
index_html = r"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DB Master Tool</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <style>
        body { background-color: #1e1e1e; color: #ddd; }
        .card { background-color: #2b2b2b; border: 1px solid #444; }
        .form-control, .custom-select { background-color: #333; color: #fff; border: 1px solid #555; }
        #log-window { height: 600px; overflow-y: auto; background: #000; border: 1px solid #444; padding: 10px; font-family: 'Consolas', monospace; font-size: 0.9rem; }
        .btn-primary { background-color: #007bff; border-color: #007bff; }
        .section-title { border-bottom: 2px solid #555; padding-bottom: 10px; margin-bottom: 20px; color: #17a2b8; }
    </style>
</head>
<body class="p-4">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-light">ğŸ› ï¸ DB Master Diagnostic Tool</h2>
            <a href="/settings" class="btn btn-outline-light">âš™ï¸ ì„¤ì •(DB ê´€ë¦¬) í™”ë©´ìœ¼ë¡œ ì´ë™</a>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="card p-3 mb-3">
                    <h5 class="section-title">1. ëŒ€ìƒ DB ì„ íƒ</h5>
                    <div class="form-group">
                        <select id="target_db" class="custom-select" onchange="updateCheckboxes()">
                            <option value="">-- DBë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                        </select>
                        <small class="text-muted mt-2 d-block">* ì„¤ì • í™”ë©´ì—ì„œ ì¶”ê°€í•œ ëª©ë¡ì´ ë³´ì…ë‹ˆë‹¤.</small>
                    </div>
                </div>

                <div class="card p-3">
                    <h5 class="section-title">2. ì ê²€ í•­ëª© ì²´í¬</h5>
                    <form id="diagForm">
                        <div id="mssql_checks" style="display:none;">
                            <h6 class="text-warning">MSSQL Checks</h6>
                            <div class="custom-control custom-checkbox mb-2">
                                <input type="checkbox" class="custom-control-input" id="chk_m_cpu" name="checks[]" value="cpu" checked>
                                <label class="custom-control-label" for="chk_m_cpu">CPU ê³¼ì ìœ  ì¿¼ë¦¬</label>
                            </div>
                            <div class="custom-control custom-checkbox mb-2">
                                <input type="checkbox" class="custom-control-input" id="chk_m_lock" name="checks[]" value="lock" checked>
                                <label class="custom-control-label" for="chk_m_lock">Lock / Blocking</label>
                            </div>
                            <div class="custom-control custom-checkbox mb-2">
                                <input type="checkbox" class="custom-control-input" id="chk_m_idx" name="checks[]" value="missing_idx">
                                <label class="custom-control-label" for="chk_m_idx">ëˆ„ë½ ì¸ë±ìŠ¤ ì¶”ì²œ</label>
                            </div>
                            <div class="custom-control custom-checkbox mb-2">
                                <input type="checkbox" class="custom-control-input" id="chk_m_st" name="checks[]" value="storage">
                                <label class="custom-control-label" for="chk_m_st">íŒŒì¼ ìš©ëŸ‰ ì ê²€</label>
                            </div>
                        </div>

                        <div id="mysql_checks" style="display:none;">
                            <h6 class="text-info">MySQL Checks</h6>
                            <div class="custom-control custom-checkbox mb-2">
                                <input type="checkbox" class="custom-control-input" id="chk_y_proc" name="checks[]" value="process" checked>
                                <label class="custom-control-label" for="chk_y_proc">ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤</label>
                            </div>
                            <div class="custom-control custom-checkbox mb-2">
                                <input type="checkbox" class="custom-control-input" id="chk_y_st" name="checks[]" value="storage">
                                <label class="custom-control-label" for="chk_y_st">í…Œì´ë¸” ìš©ëŸ‰ TOP 20</label>
                            </div>
                            <div class="custom-control custom-checkbox mb-2">
                                <input type="checkbox" class="custom-control-input" id="chk_y_stat" name="checks[]" value="status">
                                <label class="custom-control-label" for="chk_y_stat">ì£¼ìš” ìƒíƒœ ë³€ìˆ˜</label>
                            </div>
                        </div>
                    </form>
                    <button class="btn btn-success btn-block mt-3 font-weight-bold" onclick="startDiag()">ğŸš€ ì§„ë‹¨ ì‹œì‘ (Start)</button>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-secondary text-white font-weight-bold">
                        ğŸ“º ì‹¤ì‹œê°„ ì§„ë‹¨ ë¡œê·¸
                    </div>
                    <div id="log-window">
                        <div style="color:gray; text-align:center; margin-top:250px;">
                            ì¢Œì¸¡ì—ì„œ DBì™€ í•­ëª©ì„ ì„ íƒí•˜ê³  [ì‹œì‘]ì„ ëˆ„ë¥´ì„¸ìš”.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dbConfigs = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadConfigs() {
            const res = await fetch('/api/config');
            dbConfigs = await res.json();
            const select = document.getElementById('target_db');
            select.innerHTML = '<option value="">-- DBë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
            
            for (const [alias, cfg] of Object.entries(dbConfigs)) {
                const opt = document.createElement('option');
                opt.value = alias;
                opt.innerText = `[${cfg.db_type.toUpperCase()}] ${alias} (${cfg.host})`;
                select.appendChild(opt);
            }
        }

        // DB ì„ íƒ ì‹œ í•´ë‹¹ë˜ëŠ” ì²´í¬ë°•ìŠ¤ë§Œ ë³´ì—¬ì£¼ê¸°
        function updateCheckboxes() {
            const alias = document.getElementById('target_db').value;
            const mSection = document.getElementById('mssql_checks');
            const ySection = document.getElementById('mysql_checks');

            mSection.style.display = 'none';
            ySection.style.display = 'none';

            if (!alias) return;

            const type = dbConfigs[alias].db_type;
            if (type === 'mssql') mSection.style.display = 'block';
            if (type === 'mysql') ySection.style.display = 'block';
        }

        // ì§„ë‹¨ ì‹¤í–‰
        async function startDiag() {
            const alias = document.getElementById('target_db').value;
            if (!alias) { alert('ëŒ€ìƒ DBë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

            const log = document.getElementById('log-window');
            log.innerHTML = `<div style="color:cyan">--- ì‹œìŠ¤í…œ ì—°ê²° ì¤€ë¹„ ì¤‘... ---</div>`;

            const formData = new FormData(document.getElementById('diagForm'));
            formData.append('target_name', alias);

            try {
                const response = await fetch('/run_diag', { method: 'POST', body: formData });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                log.innerHTML = ''; // ì´ˆê¸°í™”
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    log.innerHTML += decoder.decode(value);
                    log.scrollTop = log.scrollHeight;
                }
            } catch (err) {
                log.innerHTML += `<div style="color:red">[Error] í†µì‹  ì‹¤íŒ¨: ${err}</div>`;
            }
        }

        loadConfigs();
    </script>
</body>
</html>
"""

# ==============================================================================
# 3. templates/settings.html (ì„¤ì • ê´€ë¦¬ í™”ë©´)
# ==============================================================================
settings_html = r"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DB ì„¤ì • ê´€ë¦¬</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <style>body { background-color: #1e1e1e; color: #ddd; }</style>
</head>
<body class="p-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>âš™ï¸ DB ì—°ê²° ì„¤ì • ê´€ë¦¬</h3>
            <a href="/" class="btn btn-secondary">ğŸ”™ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card bg-dark border-secondary p-3">
                    <h5 class="text-info border-bottom pb-2">ìƒˆ DB ì¶”ê°€</h5>
                    <form id="configForm">
                        <div class="form-group">
                            <label>ë³„ì¹­ (Alias) *ê³ ìœ ê°’</label>
                            <input type="text" class="form-control" id="alias" placeholder="ì˜ˆ: ìš´ì˜ì„œë²„_MES">
                        </div>
                        <div class="form-group">
                            <label>DB íƒ€ì…</label>
                            <select class="form-control" id="db_type" onchange="togglePort()">
                                <option value="mssql">MSSQL (SQL Server)</option>
                                <option value="mysql">MySQL / MariaDB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Host IP</label>
                            <input type="text" class="form-control" id="host" placeholder="127.0.0.1">
                        </div>
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" class="form-control" id="port" value="1433">
                        </div>
                        <div class="form-group">
                            <label>User ID</label>
                            <input type="text" class="form-control" id="user">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" class="form-control" id="password">
                        </div>
                        <div class="form-group" id="db_name_group">
                            <label>DB Name (MSSQL Only)</label>
                            <input type="text" class="form-control" id="db_name" value="master">
                        </div>
                        <button type="button" class="btn btn-primary btn-block" onclick="saveConfig()">ì €ì¥ (Save)</button>
                    </form>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card bg-dark border-secondary p-3">
                    <h5 class="text-success border-bottom pb-2">ì €ì¥ëœ DB ëª©ë¡</h5>
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>ë³„ì¹­</th>
                                <th>íƒ€ì…</th>
                                <th>Host</th>
                                <th>User</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="configList">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        function togglePort() {
            const type = document.getElementById('db_type').value;
            document.getElementById('port').value = (type === 'mssql') ? 1433 : 3306;
            document.getElementById('db_name_group').style.display = (type === 'mssql') ? 'block' : 'none';
        }

        async function loadList() {
            const res = await fetch('/api/config');
            const data = await res.json();
            const tbody = document.getElementById('configList');
            tbody.innerHTML = '';

            for (const [alias, cfg] of Object.entries(data)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-weight-bold text-warning">${alias}</td>
                    <td><span class="badge badge-${cfg.db_type === 'mssql' ? 'primary' : 'info'}">${cfg.db_type}</span></td>
                    <td>${cfg.host}:${cfg.port}</td>
                    <td>${cfg.user}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteConfig('${alias}')">ì‚­ì œ</button></td>
                `;
                tbody.appendChild(tr);
            }
        }

        async function saveConfig() {
            const alias = document.getElementById('alias').value;
            if(!alias) { alert('ë³„ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

            const payload = {
                alias: alias,
                db_type: document.getElementById('db_type').value,
                host: document.getElementById('host').value,
                port: document.getElementById('port').value,
                user: document.getElementById('user').value,
                password: document.getElementById('password').value,
                db_name: document.getElementById('db_name').value
            };

            await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadList();
        }

        async function deleteConfig(alias) {
            if(!confirm(alias + ' ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch('/api/config', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({alias: alias})
            });
            loadList();
        }

        loadList();
    </script>
</body>
</html>
"""

# === íŒŒì¼ ì“°ê¸° ì‘ì—… ===
def write_file(path, content):
    with open(path, 'w', encoding='utf-8') as f:
        f.write(content.strip())
    print(f"âœ… Created: {path}")

write_file(os.path.join(ROOT, "app.py"), app_code)
write_file(os.path.join(TEMPLATES, "index.html"), index_html)
write_file(os.path.join(TEMPLATES, "settings.html"), settings_html)

print("\n" + "="*50)
print("êµ¬ì¶• ì™„ë£Œ. ì•„ë˜ ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.")
print(f"1. cd {ROOT}")
print("2. pip install flask pymysql pymssql")
print("3. python app.py")
print("4. ì ‘ì†: http://localhost:5000 (ì„¤ì • ë©”ë‰´ ë¨¼ì € ë“¤ì–´ê°€ì„¸ìš”)")
print("="*50)