래는 MSSQL 2014 기준으로 작성된 쿼리입니다.
요구사항에 맞춰 ExcelData 테이블에서 LastestModels의 model과 일치하고, time1이 최근 5시간 이내인 레코드들을 대상으로
ACT2_1 ~ ACT2_8 와 ACT2BEST_1 ~ ACT2BEST_8 까지 총 16개 컬럼에 대해
0보다 큰 값만 대상으로 하되, 1사분위수(Q1)와 3사분위수(Q3)를 제외한 값들 중에서 가장 작은 값을 구합니다.

sql
코드 복사
WITH FilteredData AS (
    SELECT *
    FROM ExcelData E
    WHERE EXISTS (
        SELECT 1
        FROM LastestModels L
        WHERE L.model = E.model1
    )
    AND E.time1 >= DATEADD(HOUR, -5, GETDATE())
),
Unpivoted AS (
    SELECT
        model1,
        time1,
        ColName,
        Value
    FROM FilteredData
    UNPIVOT (
        Value FOR ColName IN (
            ACT2_1, ACT2_2, ACT2_3, ACT2_4, ACT2_5, ACT2_6, ACT2_7, ACT2_8,
            ACT2BEST_1, ACT2BEST_2, ACT2BEST_3, ACT2BEST_4,
            ACT2BEST_5, ACT2BEST_6, ACT2BEST_7, ACT2BEST_8
        )
    ) AS unpvt
    WHERE Value > 0
),
WithQuantiles AS (
    SELECT
        model1,
        ColName,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q3,
        Value
    FROM Unpivoted
),
FilteredByQuantiles AS (
    SELECT model1, ColName, Value
    FROM WithQuantiles
    WHERE Value >= Q1 AND Value <= Q3
)
SELECT
    model1,
    ColName,
    MIN(Value) AS MinValue
FROM FilteredByQuantiles
GROUP BY model1, ColName
ORDER BY model1, ColName;
설명:
FilteredData: LastestModels의 모델과 일치하고, time1이 최근 5시간 이내인 데이터 필터링.

Unpivoted: ACT2_1~8, ACT2BEST_1~8 컬럼을 세로로 변환하여 컬럼명을 ColName, 값을 Value로 통합.

WithQuantiles: model1, ColName 별로 1분위(Q1), **3분위(Q3)**를 계산.

FilteredByQuantiles: Q1 이상 Q3 이하의 값만 남김 (이상치 제외).

최종 SELECT: 남은 값들 중 컬럼별 가장 작은 값을 출력.