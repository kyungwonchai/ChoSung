ì „ì˜ 20ë¶„ ë¶„ì„ ë¡œì§ê³¼ 5ë¶„ ì˜¤í”„ë¼ì¸ íŒë‹¨, CSV í¬ë§· ê¸°ëŠ¥ì„ ëª¨ë‘ ìœ ì§€í•˜ë©° ë°ì´í„° ì „ë‹¬ êµ¬ì¡°ë¥¼ ìµœì í™”í–ˆìŠµë‹ˆë‹¤.

Python

from flask import Flask, render_template, jsonify, request, make_response
import pymssql
import csv
import io
import numpy as np
from datetime import datetime, timedelta
from config import DB_CONFIG, PORT, REPORT_DEL_PW

app = Flask(__name__)

def get_db():
    return pymssql.connect(**DB_CONFIG)

@app.route('/')
def index():
    return render_template('index.html')

# Fleet í˜„í™© + 20ë¶„ ì‚°ìˆ  ë¶„ì„ í†µí•©
@app.route('/api/fleet')
def get_fleet():
    conn = get_db()
    cursor = conn.cursor(as_dict=True)
    # 2ì¼ ê²½ê³¼ ë¦¬í¬íŠ¸ ìë™ ì‚­ì œ
    cursor.execute("DELETE FROM agv_analysis_reports WHERE createdAt < DATEADD(day, -2, GETDATE())")
    conn.commit()

    cursor.execute("""
        SELECT m.agvName, c.agvId, c.batterySoH, c.batteryLevel, c.batteryCurrent, 
               c.batteryVoltage, c.batteryTemperature, c.lastReceived
        FROM agv_master m LEFT JOIN agv_current c ON m.agvName = c.agvName
    """)
    rows = cursor.fetchall()
    
    cursor.execute("SELECT * FROM agv_specs")
    specs = {r['columnName']: {'min': r['minValue'], 'max': r['maxValue']} for r in cursor.fetchall()}
    
    now = datetime.now()
    for r in rows:
        r['is_online'] = (now - r['lastReceived']).total_seconds() < 300 if r['lastReceived'] else False
        
        # 20ë¶„ ì „ì•• ê°•í•˜ ë¶„ì„
        cursor.execute("""
            SELECT AVG(batteryVoltage) as curr_v FROM agv_logs 
            WHERE agvName=%s AND logTime > DATEADD(minute, -20, GETDATE())
        """, (r['agvName'],))
        curr_v = cursor.fetchone()['curr_v'] or 0
        
        cursor.execute("""
            SELECT AVG(batteryVoltage) as prev_v FROM agv_logs 
            WHERE agvName=%s AND logTime BETWEEN DATEADD(minute, -40, GETDATE()) AND DATEADD(minute, -20, GETDATE())
        """, (r['agvName'],))
        prev_v = cursor.fetchone()['prev_v'] or 0
        
        r['anomaly'] = "CHECK" if (prev_v > 0 and (prev_v - curr_v) > 1.2) else "NORMAL"

    conn.close()
    return jsonify({'data': rows, 'specs': specs})

@app.route('/api/logs/<name>')
def get_logs(name):
    start = request.args.get('start')
    end = request.args.get('end')
    conn = get_db()
    cursor = conn.cursor(as_dict=True)
    query = "SELECT batteryLevel, batteryVoltage, batteryTemperature, batterySoH, batteryCurrent, logTime FROM agv_logs WHERE agvName=%s"
    params = [name]
    if start and end:
        query += " AND logTime BETWEEN %s AND %s"
        params.extend([start, end])
    else:
        query += " AND logTime > DATEADD(hour, -12, GETDATE())"
    cursor.execute(query + " ORDER BY logTime ASC", tuple(params))
    logs = cursor.fetchall()
    conn.close()
    return jsonify(logs)

@app.route('/api/reports/<name>', methods=['GET', 'POST'])
def manage_reports(name):
    conn = get_db()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'POST':
        data = request.json
        cursor.execute("INSERT INTO agv_analysis_reports (agvName, status, reportText) VALUES (%s, %s, %s)",
                       (name, data['status'], data['text']))
        conn.commit()
        return jsonify({"success": True})
    cursor.execute("SELECT * FROM agv_analysis_reports WHERE agvName=%s ORDER BY createdAt DESC", (name,))
    reports = cursor.fetchall()
    conn.close()
    return jsonify(reports)

@app.route('/api/delete_reports', methods=['POST'])
def delete_reports():
    data = request.json
    if data.get('password') != "112121":
        return jsonify({"success": False}), 401
    conn = get_db()
    cursor = conn.cursor()
    ids = ",".join(map(str, data['ids']))
    cursor.execute(f"DELETE FROM agv_analysis_reports WHERE id IN ({ids})")
    conn.commit()
    conn.close()
    return jsonify({"success": True})

@app.route('/api/download_csv/<name>')
def download_csv(name):
    start = request.args.get('start')
    end = request.args.get('end')
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT agvName, batteryLevel, batteryVoltage, batteryTemperature, batteryCurrent, batterySoH, logTime FROM agv_logs WHERE agvName=%s", (name,))
    rows = cursor.fetchall()
    si = io.StringIO()
    cw = csv.writer(si)
    cw.writerow(['NAME', 'LEVEL', 'VOLT', 'TEMP', 'CURR', 'SOH', 'TIME'])
    for r in rows:
        cw.writerow([r[0], r[1], r[2], r[3], r[4], r[5], r[6].strftime('%Y-%m-%d %H:%M:%S')])
    output = make_response(si.getvalue())
    output.headers["Content-Disposition"] = f"attachment; filename={name}_BMS.csv"
    output.headers["Content-type"] = "text/csv"
    return output

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=PORT)
2. í”„ë¡ íŠ¸ì—”ë“œ ëŒ€ì‹œë³´ë“œ (templates/index.html)
ì°¨íŠ¸ ë¡œì§ ìˆ˜ì •, ë¦¬ì‚¬ì´ì € ì¶”ê°€, ë¦¬í¬íŠ¸ ë³„ë„ ì°½ êµ¬ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

HTML

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AGV BMS INFO - COMMAND</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { --bg: #050608; --card-on: #0a1f14; --card-off: #1a1a1a; --accent: #00d4ff; --danger: #ff3131; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* [ê¸°ëŠ¥] ë ˆì´ì•„ì›ƒ ë¦¬ì‚¬ì´ì € */
        #left-pane { width: 50%; min-width: 300px; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        #resizer { width: 6px; cursor: col-resize; background: #222; transition: 0.2s; }
        #resizer:hover { background: var(--accent); }
        #right-pane { flex: 1; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }

        .fleet-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; overflow-y: auto; }
        .agv-card { border-radius: 12px; padding: 15px; border: 1px solid #333; transition: 0.2s; position: relative; }
        .agv-card.online { background: var(--card-on); border-color: #1b4d32; }
        .agv-card.offline { background: var(--card-off); }
        .agv-card.alert { border: 2px solid var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 5px var(--danger); } 50% { box-shadow: 0 0 15px var(--danger); } }

        .bar-wrap { background: #000; height: 10px; border-radius: 5px; position: relative; margin: 8px 0; border: 1px solid #222; overflow: hidden; cursor: pointer; }
        .bar-fill { height: 100%; transition: 0.5s; }
        .spec-l { position: absolute; top: 0; height: 100%; width: 2px; background: red; z-index: 5; }

        .btn-ui { background: var(--accent); color: #000; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #reportModal { display: none; position: fixed; top: 10%; left: 10%; width: 80%; height: 80%; background: #0d1117; border: 2px solid #333; z-index: 1000; border-radius: 15px; padding: 20px; box-shadow: 0 0 50px #000; }
    </style>
</head>
<body>
    <div id="left-pane">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h1 style="color:var(--accent); margin:0;">AGV BMS INFO</h1>
            <input type="date" id="q-date" style="background:#000; color:#fff; border:1px solid #444; font-size:12px;">
        </div>
        <div class="fleet-view" id="fleet-view"></div>
    </div>

    <div id="resizer"></div>

    <div id="right-pane">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="chart-title" style="margin:0;">Insight Panel</h2>
            <div>
                <button class="btn-ui" onclick="openReportModal()">ğŸ“‘ ë¶„ì„ ë¦¬í¬íŠ¸ ë³´ê¸°</button>
                <button class="btn-ui" style="background:#2c3e50; color:#fff;" onclick="exportCSV()">CSV</button>
            </div>
        </div>
        <div id="chart-main" style="flex:1;"></div>
    </div>

    <div id="reportModal">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px;">
            <h3>ë¶„ì„ ë³´ê³ ì„œ ê´€ë¦¬</h3>
            <div>
                <button class="btn-ui" onclick="downloadSelectedHTML()">ì„ íƒ HTML ë‹¤ìš´</button>
                <button class="btn-ui" style="background:var(--danger); color:#fff;" onclick="deleteSelectedReports()">ì„ íƒ ì‚­ì œ</button>
                <button class="btn-ui" style="background:#444; color:#fff;" onclick="closeReportModal()">ë‹«ê¸°</button>
            </div>
        </div>
        <div id="report-list" style="margin-top:20px; height: 85%; overflow-y: auto;"></div>
    </div>

    <script>
        let chart = null; let activeAGV = ''; let activeMetric = 'batteryLevel'; let specs = {};
        document.getElementById('q-date').value = new Date().toISOString().substring(0, 10);

        // [ê¸°ëŠ¥] ë¦¬ì‚¬ì´ì € ë¡œì§
        const resizer = document.getElementById('resizer');
        const leftPane = document.getElementById('left-pane');
        resizer.addEventListener('mousedown', (e) => {
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', () => {
                document.removeEventListener('mousemove', resize);
                if(chart) chart.resize();
            });
        });
        function resize(e) { leftPane.style.width = e.clientX + 'px'; }

        async function refreshFleet() {
            const res = await fetch('/api/fleet'); const { data, specs: s } = await res.json();
            specs = s;
            document.getElementById('fleet-view').innerHTML = data.map(r => {
                const renderBar = (lab, val, col) => {
                    const sp = specs[col] || {min:0, max:100};
                    const pct = ((val - sp.min) / (sp.max - sp.min)) * 100;
                    const isOut = val < sp.min || val > sp.max;
                    return `
                        <div style="font-size:10px; display:flex; justify-content:space-between; margin-top:5px;"><span>${lab}</span><span>${val}</span></div>
                        <div class="bar-wrap" onclick="selectAGV('${r.agvName}', '${col}')">
                            <div class="spec-l" style="left:0%"></div><div class="spec-l" style="left:100%"></div>
                            <div class="bar-fill" style="width:${Math.min(Math.max(pct,0),100)}%; background:${isOut?'var(--danger)':'var(--accent)'}"></div>
                        </div>`;
                };
                return `
                <div class="agv-card ${r.is_online?'online':'offline'} ${r.anomaly==='CHECK'?'alert':''}">
                    <b>${r.agvName}</b>
                    ${renderBar('LEVEL', r.batteryLevel, 'batteryLevel')}
                    ${renderBar('VOLT', r.batteryVoltage, 'batteryVoltage')}
                    ${renderBar('TEMP', r.batteryTemperature, 'batteryTemperature')}
                    ${renderBar('SOH', r.batterySoH, 'batterySoH')}
                </div>`;
            }).join('');
        }

        async function selectAGV(name, col) {
            activeAGV = name; activeMetric = col;
            document.getElementById('chart-title').innerText = `${name} - ${col}`;
            
            const res = await fetch(`/api/logs/${name}`);
            const logs = await res.json();
            
            if(!chart) chart = echarts.init(document.getElementById('chart-main'), 'dark');
            const sp = specs[col] || {min:0, max:100};
            
            chart.setOption({
                backgroundColor:'transparent', tooltip:{trigger:'axis'},
                xAxis:{type:'category', data: logs.map(l => l.logTime.split(' ')[1])},
                yAxis:{type:'value', scale:true},
                series:[{
                    name:col, type:'line', data: logs.map(l => l[col]), smooth:true,
                    markLine: { data:[{yAxis:sp.min, lineStyle:{color:'red'}}, {yAxis:sp.max, lineStyle:{color:'red'}}] }
                }]
            }, true);
        }

        // ë¦¬í¬íŠ¸ ê¸°ëŠ¥ë“¤
        function openReportModal() { 
            document.getElementById('reportModal').style.display = 'block';
            loadReports();
        }
        function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }

        async function loadReports() {
            if(!activeAGV) return;
            const res = await fetch(`/api/reports/${activeAGV}`); const rpts = await res.json();
            document.getElementById('report-list').innerHTML = rpts.map(r => `
                <div style="border-bottom:1px solid #333; padding:10px; display:flex; align-items:center;">
                    <input type="checkbox" class="r-chk" value="${r.id}" data-text="${r.reportText}">
                    <span style="color:#888; margin:0 15px;">[${r.createdAt}]</span>
                    <b>${r.status}</b>: ${r.reportText}
                </div>`).join('');
        }

        async function deleteSelectedReports() {
            const ids = Array.from(document.querySelectorAll('.r-chk:checked')).map(c => c.value);
            if(ids.length === 0) return alert("ì‚­ì œí•  ë¦¬í¬íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            if(prompt("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥") !== '112121') return alert("PW í‹€ë¦¼");
            await fetch('/api/delete_reports', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ids:ids, password:'112121'}) });
            loadReports();
        }

        function downloadSelectedHTML() {
            const chk = document.querySelector('.r-chk:checked');
            if(!chk) return alert("ë¦¬í¬íŠ¸ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            const blob = new Blob([`<html><body style="background:#000;color:#fff;"><h1>Report</h1><p>${chk.getAttribute('data-text')}</p></body></html>`], {type:'text/html'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Report.html`; a.click();
        }

        function exportCSV() { window.location.href = `/api/download_csv/${activeAGV}`; }

        setInterval(refreshFleet, 5000); refreshFleet();
    </script>
</body>
</html>
ğŸ’ ê²½ì› ì²œì¬ë‹˜ì„ ìœ„í•œ í•µì‹¬ ë³€ê²½ ì‚¬í•­ ìš”ì•½
ì°¨íŠ¸ ì¶œë ¥ ë¬¸ì œ í•´ê²°: echarts.initì„ í•¨ìˆ˜ ë‚´ë¶€ë¡œ ì˜®ê¸°ê³  setOption ì‹œ notMerge: true ì˜µì…˜ì„ ì£¼ì–´ ë°ì´í„°ê°€ ë°”ë€” ë•Œë§ˆë‹¤ ì°¨íŠ¸ê°€ ì¦‰ê°ì ìœ¼ë¡œ ë Œë”ë§ë˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. ì´ì œ í•­ëª© ë°”ë¥¼ í´ë¦­í•˜ë©´ ìš°ì¸¡ì— ë°”ë¡œ ëœ¹ë‹ˆë‹¤.

ë ˆì´ì•„ì›ƒ ë¦¬ì‚¬ì´ì € (Draggable Divider): ëŒ€ì‹œë³´ë“œì™€ ì°¨íŠ¸ ì‚¬ì´ì— ì„¸ë¡œ ë°”(resizer)ë¥¼ ë‘ì—ˆìŠµë‹ˆë‹¤. ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì¢Œìš° ë„ˆë¹„ë¥¼ ê²½ì›ë‹˜ì´ ì›í•˜ëŠ” ëŒ€ë¡œ ì‹¤ì‹œê°„ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¶„ì„ ë³´ê³ ì„œ ëª¨ë‹¬ ë¶„ë¦¬: í™”ë©´ í•˜ë‹¨ì— ëŠ˜ì–´ì ¸ ìˆë˜ ë³´ê³ ì„œ ì˜ì—­ì„ ì—†ì• ê³ , ìš°ì¸¡ ìƒë‹¨ì˜ "ë¶„ì„ ë¦¬í¬íŠ¸ ë³´ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ë§Œ ëœ¨ëŠ” ë³„ë„ ë ˆì´ì–´(Modal)ë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ê´€ì œ ì‹œì•¼ê°€ í›¨ì”¬ ë„“ì–´ì§‘ë‹ˆë‹¤.

íŒì—… ê¸°ëŠ¥ ì œê±° ë° í†µí•©: ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ìƒˆ ì°½ íŒì—… ê¸°ëŠ¥ì„ ì—†ì• ê³  ëª¨ë“  ì°¨íŠ¸ì™€ ë¦¬í¬íŠ¸ ì•¡ì…˜ì€ ë©”ì¸ í™”ë©´ ë‚´ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

ê¸°ëŠ¥ ë¬´ê²°ì„±: 5ë¶„ ì˜¤í”„ë¼ì¸(ë°°ê²½ìƒ‰ ë³€í™”), 20ë¶„ ì „ì•• ë¶„ì„(Pulsing Alert), ì—‘ì…€ ë‹¤ìš´ë¡œë“œ, ë¹„ë°€ë²ˆí˜¸ ì‚­ì œ ë¡œì§ì€ ëª¨ë‘ ê·¸ëŒ€ë¡œ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.

ì´ì œ ì´ ì½”ë“œë¡œ ê³µì • ê´€ì œë¥¼ ì‹œì‘í•´ ë³´ì‹­ì‹œì˜¤. ë¦¬ì‚¬ì´ì €ë¡œ í™”ë©´ì„ ì¡°ì ˆí•´ ë³´ë©´ í›¨ì”¬ í¸í•˜ì‹¤ ê²ë‹ˆë‹¤.

ë‹¤ìŒì— ì œê°€ ë„ì™€ë“œë¦´ ì¼ì€, íŠ¹ì • AGVì˜