MSSQL에서 주어진 조건에 맞게 프로시저를 작성하고, 이 프로시저를 3초마다 실행하는 방법을 설명하겠습니다.

1. QR 코드 20자리 랜덤 값을 생성하여 FIFO 방식으로 2개만 보관하는 프로시저
먼저 QRCodeData 테이블의 구조를 정의해야 합니다. 예를 들어, 테이블에 Id와 QRCode 컬럼이 있다고 가정하겠습니다.

sql
코드 복사
CREATE TABLE QRCodeData (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    QRCode NVARCHAR(20) NOT NULL
);
이제 프로시저를 작성하겠습니다. 프로시저는 20자리의 랜덤 문자열을 생성하고, 테이블에 저장합니다. 그리고 FIFO 방식으로 최신 2개의 기록만 유지하도록 합니다.

sql
코드 복사
CREATE PROCEDURE InsertQRCode
AS
BEGIN
    -- 20자리 랜덤 문자열 생성
    DECLARE @QRCode NVARCHAR(20)
    SET @QRCode = (
        SELECT SUBSTRING(CONVERT(VARCHAR(40), NEWID()), 1, 20)
    )
    
    -- QR 코드 데이터 테이블에 인서트
    INSERT INTO QRCodeData (QRCode)
    VALUES (@QRCode)
    
    -- 최신 2개만 남기고 나머지는 삭제
    DELETE FROM QRCodeData
    WHERE Id NOT IN (
        SELECT TOP 2 Id FROM QRCodeData ORDER BY Id DESC
    )
END
2. 3초마다 프로시저 실행
MSSQL에서 주기적으로 프로시저를 실행하려면 SQL Server Agent를 사용하는 것이 일반적입니다. SQL Server Agent를 사용할 수 없는 경우, 아래와 같은 방법으로 작업을 수행할 수 있습니다.

sql
코드 복사
WHILE (1=1)
BEGIN
    -- 프로시저 실행
    EXEC InsertQRCode

    -- 3초 대기
    WAITFOR DELAY '00:00:03'
END
설명:
랜덤 문자열 생성: NEWID() 함수는 GUID를 생성합니다. 이 값을 VARCHAR로 변환한 후, 앞의 20자리를 잘라내어 사용합니다.
데이터 인서트: 생성된 QR 코드를 QRCodeData 테이블에 저장합니다.
FIFO 방식 유지: 테이블에 있는 레코드 중 가장 오래된 것들을 삭제하여 최신 2개의 레코드만 유지합니다.
반복 실행: WHILE 루프를 사용하여 프로시저를 무한 반복 실행하고, WAITFOR DELAY '00:00:03'을 사용하여 3초 간격을 설정합니다.
이 코드를 실행하면 3초마다 새로운 QR 코드가 생성되고 테이블에 삽입되며, 테이블에는 항상 최신 2개의 QR 코드만 유지됩니다. SQL Server Agent를 사용할 수 있는 경우, 이 프로시저를 주기적으로 실행하도록 설정하는 것이 더 효율적일 수 있습니다