import pymssql
import csv
import re

# 데이터베이스 연결 정보
server = '192.168.1.100'
user = 'sa'
password = 'mypassword123'
database = 'NPM_DAS_DATAS'

# MSSQL 데이터베이스 연결 (포트 5555로 설정)
conn = pymssql.connect(server=server, user=user, password=password, database=database, port=5555)
cursor = conn.cursor()

# LOG로 시작하고 특정 패턴을 따르는 모든 테이블 이름 가져오기
cursor.execute("""
    SELECT TABLE_NAME
    FROM INFORMATION_SCHEMA.TABLES
    WHERE TABLE_NAME LIKE 'LOG\_%\_%' ESCAPE '\'
""")

tables = cursor.fetchall()
pattern = re.compile(r'^LOG_\d{2}_\d{8}$')

# 결과를 저장할 리스트 초기화
result_rows = []

# 각 테이블에서 log1 컬럼 값이 'splicing'인 행 찾기
for table in tables:
    table_name = table[0]
    if pattern.match(table_name):
        query = f"SELECT line1, machine1, lane1, log1, log2, datatime1 FROM {table_name} WHERE log1 = 'splicing'"
        cursor.execute(query)
        rows = cursor.fetchall()
        result_rows.extend(rows)

# CSV 파일로 내보내기
csv_file = 'splicing_logs.csv'
with open(csv_file, mode='w', newline='') as file:
    writer = csv.writer(file)
    # 헤더 작성
    writer.writerow(['line1', 'machine1', 'lane1', 'log1', 'log2', 'datatime1'])
    # 데이터 작성
    writer.writerows(result_rows)

print(f"CSV 파일이 '{csv_file}' 이름으로 성공적으로 생성되었습니다.")

# 연결 종료