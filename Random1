using System;
using System.Data;
using System.Drawing;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.IO;
using System.Drawing.Imaging;

// 백그라운드 작업을 위한 비동기 메서드
private async Task UpdateRichEditControlAsync(DataTable dataTable, RichEditControl richEditControl)
{
    // DataTable의 내용을 표 형태로 변환하여 HTML 생성
    string tableHtml = ConvertDataTableToHtml(dataTable);

    // 백그라운드에서 HTML을 이미지로 변환
    await Task.Run(() =>
    {
        var tempHtmlFile = Path.GetTempFileName();
        var tempImageFile = Path.ChangeExtension(tempHtmlFile, ".png");

        // HTML 파일로 저장
        File.WriteAllText(tempHtmlFile, tableHtml);

        // 웹 브라우저 컨트롤을 사용하여 HTML을 이미지로 변환
        using (var webBrowser = new WebBrowser())
        {
            webBrowser.ScrollBarsEnabled = false;
            webBrowser.ScriptErrorsSuppressed = true;
            webBrowser.Navigate(tempHtmlFile);

            while (webBrowser.ReadyState != WebBrowserReadyState.Complete)
            {
                Application.DoEvents();
            }

            webBrowser.ClientSize = new Size(webBrowser.Document.Body.ScrollRectangle.Width, webBrowser.Document.Body.ScrollRectangle.Height);
            webBrowser.BringToFront();

            Bitmap bitmap = new Bitmap(webBrowser.Width, webBrowser.Height);
            webBrowser.DrawToBitmap(bitmap, new Rectangle(0, 0, webBrowser.Width, webBrowser.Height));

            bitmap.Save(tempImageFile, ImageFormat.Png);
        }

        // 이미지 파일을 RichEditControl에 삽입
        richEditControl.Invoke(new MethodInvoker(() =>
        {
            richEditControl.Document.BeginUpdate();
            richEditControl.Document.Images.Append(Image.FromFile(tempImageFile));
            richEditControl.Document.EndUpdate();
        }));

        // 임시 파일 삭제
        File.Delete(tempHtmlFile);
        File.Delete(tempImageFile);
    });
}

// DataTable을 HTML 표 형태로 변환하는 메서드
private string ConvertDataTableToHtml(DataTable dataTable)
{
    string html = "<table style=\"border-collapse: collapse;\">";

    // 테이블 헤더 생성
    html += "<tr style=\"background-color: #ADD8E6;\">";
    foreach (DataColumn column in dataTable.Columns)
    {
        html += "<th style=\"border: 1px solid #000; padding: 8px;\">" + column.ColumnName + "</th>";
    }
    html += "</tr>";

    // 테이블 데이터 생성
    foreach (DataRow row in dataTable.Rows)
    {
        html += "<tr>";
        foreach (object item in row.ItemArray)
        {
            html += "<td style=\"border: 1px solid #000; padding: 8px;\">" + item.ToString() + "</td>";
        }
        html += "</tr>";
    }

    html += "</table>";

    return html;
}

// 예시로 사용하는 메서드
private async void LoadDataInBackground()
{
    // 예시로 DataTable 생성
    DataTable dataTable = new DataTable();
    dataTable.Columns.Add("Name", typeof(string));
    dataTable.Columns.Add("Age", typeof(int));
    dataTable.Rows.Add("John Doe", 30);
    dataTable.Rows.Add("Jane Smith", 25);

    // RichEditControl 업데이트를 백그라운드로 실행
    await UpdateRichEditControlAsync(dataTable, richEditControl1);
}
