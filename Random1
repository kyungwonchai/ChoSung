import requests
import pymssql

def fetch_recipient_emails():
    # MSSQL 연결 설정
    server = 'your-server-name'
    database = 'your-database-name'
    username = 'your-username'
    password = 'your-password'

    conn = pymssql.connect(server, username, password, database)
    cursor = conn.cursor()

    # 수신자 이메일 주소 가져오기 (예시로 'users' 테이블 사용)
    query = 'SELECT emailAddress, recipientType FROM users'
    cursor.execute(query)
    results = cursor.fetchall()

    recipient_emails = []
    for row in results:
        email_address = row[0]
        recipient_type = row[1]
        if recipient_type == 'TO':
            recipient_emails.append(email_address)

    conn.close()

    return recipient_emails

def send_email(user_id, system_id, access_token, recipient_emails, subject, contents):
    url = 'your-email-api-url'

    headers = {
        'Authorization': 'Bearer ' + access_token,
        'System-ID': system_id
    }

    data = {
        'userID': user_id,
        'recipientEmailAddresses': [{'emailAddress': email, 'recipientType': 'TO'} for email in recipient_emails],
        'subject': subject,
        'contents': contents,
        'contentType': 'HTML',
        'docSecuType': 'PERSONAL',
        'sender': {'emailAddress': 'sender@example.com'}
    }

    try:
        response = requests.post(url, headers=headers, json=data)
        if response.status_code == 200:
            print("이메일이 발송되었습니다.")
        else:
            print("이메일 발송 실패:", response.text)
    except requests.exceptions.RequestException as e:
        print("이메일 발송 중 오류가 발생했습니다:", str(e))

# 예시 사용법
user_id = 'your-user-id'
system_id = 'your-system-id'
access_token = 'your-access-token'
subject = '이메일 제목'
contents = '<h1>안녕하세요!</h1><p>이메일 본문입니다.</p>'

recipient_emails = fetch_recipient_emails()

send_email(user_id, system_id, access_token, recipient_emails, subject, contents)
