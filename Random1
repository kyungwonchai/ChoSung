ê² ìŠµë‹ˆë‹¤. ì—¬ëŸ¬ ë¬¸ì œê°€ ê²¹ì³ ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. í•˜ë‚˜ì”© í•´ê²°í•´ ë³´ì£ .

íŠ¹ì´ì‚¬í•­ ì»¬ëŸ¼ ì—ëŸ¬: ì •í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ê°€ í•„ìš”í•˜ì§€ë§Œ, ë³´í†µ ë°”ì¸ë”© ê²½ë¡œ ì˜¤ë¥˜ ë˜ëŠ” ì €ì¥ ì‹œ ë°ì´í„° ë³€í™˜/ìœ íš¨ì„± ê²€ì‚¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. XAML ë°”ì¸ë”©ì„ í™•ì¸í•˜ê³ , ì €ì¥ ë¡œì§(MainViewModel.SaveChangesAsync)ì—ì„œ í•´ë‹¹ ì»¬ëŸ¼ ê´€ë ¨ íŠ¹ë³„í•œ ì²˜ë¦¬ê°€ ìˆëŠ”ì§€ ì ê²€í•©ë‹ˆë‹¤.
ì„¸ë¶€ìœ„ì¹˜ ìˆ«ìë§Œ ì…ë ¥: MainWindow.xamlì˜ í•´ë‹¹ GridColumnì— Maskë¥¼ ì ìš©í•˜ì—¬ ìˆ«ìë§Œ ì…ë ¥ë˜ë„ë¡ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
MasterDataWindow ì €ì¥/ì¢…ë£Œ ì‹œ ì˜¤ë¥˜ (RelayCommand 47ì¤„): ì´ ì˜¤ë¥˜ëŠ” RelayCommandê°€ ì‹¤í–‰í•œ ë©”ì„œë“œ ë‚´ë¶€(ì—¬ê¸°ì„œëŠ” MasterDataViewModelì˜ SaveMasterDataChangesAsync ë˜ëŠ” ì°½ ì¢…ë£Œ í›„ MainViewModelì—ì„œ í˜¸ì¶œë˜ëŠ” LoadMasterDataAsync ë“±)ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. íŠ¹íˆ ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥ ë° ì—°ì‡„ ì—…ë°ì´íŠ¸ ë¡œì§ì´ ë³µì¡í•˜ë¯€ë¡œ SaveMasterDataChangesAsync ë‚´ë¶€ì˜ ì˜¤ë¥˜ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. í•´ë‹¹ ë©”ì„œë“œì˜ ì˜¤ë¥˜ ì²˜ë¦¬ ë° ë¡œê¹…ì„ ê°•í™”í•´ì•¼ í•©ë‹ˆë‹¤.
ì—°ì‡„ ì—…ë°ì´íŠ¸ (ì¬í™•ì¸): 3ë²ˆ ì˜¤ë¥˜ì™€ ì§ì ‘ì ìœ¼ë¡œ ì—°ê´€ë©ë‹ˆë‹¤. SaveMasterDataChangesAsyncì˜ ì—°ì‡„ ì—…ë°ì´íŠ¸ ë¡œì§(SQL ì‹¤í–‰ ë¶€ë¶„)ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
ìë™ ë°±ì—… (ì‹ ê·œ): MasterDataWindowê°€ ì—´ë¦´ ë•Œ, ëª¨ë“  í…Œì´ë¸” ë°ì´í„°ë¥¼ CSV íŒŒì¼(Excelì—ì„œ ì—´ ìˆ˜ ìˆìŒ)ë¡œ C:\agent\ í´ë”ì— ë°±ì—…í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ë¡œì§ì€ MainViewModelì˜ OpenMasterDataWindowCommand ì‹¤í–‰ ë¶€ë¶„ì— ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì ì ˆí•©ë‹ˆë‹¤. ë°±ì—… ì‹œì—ëŠ” UIì™€ ë…ë¦½ì ì¸ ìƒˆ DbContextë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.
ìˆ˜ì •í•´ì•¼ í•  íŒŒì¼ ëª©ë¡:

Views/MainWindow.xaml (ì„¸ë¶€ìœ„ì¹˜ Mask ì¶”ê°€, íŠ¹ì´ì‚¬í•­ ì»¬ëŸ¼ í™•ì¸)
ViewModels/MainViewModel.cs (ë°±ì—… ë¡œì§ ì¶”ê°€, OpenMasterDataWindowCommand ìˆ˜ì •)
ViewModels/MasterDataViewModel.cs (SaveMasterDataChangesAsync ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”)
ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ìœ„ 3ê°œ íŒŒì¼ì˜ ìˆ˜ì •ëœ ì „ì²´ ì½”ë“œë¥¼ ì—¬ê¸°ì— ë°”ë¡œ ì‘ì„±í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

1. Views/MainWindow.xaml (ìˆ˜ì •)

"ì„¸ë¶€ìœ„ì¹˜" ì»¬ëŸ¼ì— ìˆ«ì ë§ˆìŠ¤í¬(MaskType="Numeric") ì¶”ê°€.
"íŠ¹ì´ì‚¬í•­" ì»¬ëŸ¼ì˜ EditSettingsê°€ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì»¬ëŸ¼ê³¼ ìœ ì‚¬í•œì§€ í™•ì¸ (ê¸°ë³¸ TextEditSettings ì‚¬ìš©).
XML

<dx:ThemedWindow
    x:Class="LockerManagementApp.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:dx="http://schemas.devexpress.com/winfx/2008/xaml/core"
    xmlns:dxg="http://schemas.devexpress.com/winfx/2008/xaml/grid"
    xmlns:dxe="http://schemas.devexpress.com/winfx/2008/xaml/editors"
    xmlns:dxgt="http://schemas.devexpress.com/winfx/2008/xaml/grid/themekeys"
    xmlns:dxb="http://schemas.devexpress.com/winfx/2008/xaml/bars"
    xmlns:dxlc="http://schemas.devexpress.com/winfx/2008/xaml/layoutcontrol"
    xmlns:local="clr-namespace:LockerManagementApp.Views"
    xmlns:viewmodels="clr-namespace:LockerManagementApp.ViewModels"
    xmlns:models="clr-namespace:LockerManagementApp.Models"
    xmlns:infra="clr-namespace:LockerManagementApp.Infrastructure"
    Title="ì‚¬ë¬¼í•¨ ê´€ë¦¬ í”„ë¡œê·¸ë¨ (DevExpress MVVM - .NET Framework 4.8)" Height="750" Width="1300"
    Loaded="MainWindow_Loaded" Closing="MainWindow_Closing"
    >

    <dx:ThemedWindow.DataContext>
        <viewmodels:MainViewModel/>
    </dx:ThemedWindow.DataContext>

    <dx:ThemedWindow.Resources>
        <infra:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <Style x:Key="LightBlueHeaderStyle" TargetType="dxg:BaseGridHeader"> <Setter Property="Background" Value="LightBlue"/> <Setter Property="HorizontalContentAlignment" Value="Center"/> <Setter Property="FontWeight" Value="Bold"/> </Style>
        <Style TargetType="dxg:GridColumnHeader" BasedOn="{StaticResource LightBlueHeaderStyle}"/> <Style TargetType="dxg:BandHeaderControl" BasedOn="{StaticResource LightBlueHeaderStyle}"/>
    </dx:ThemedWindow.Resources>

    <Grid>
        <Grid.RowDefinitions> <RowDefinition Height="Auto"/> <RowDefinition Height="*"/> <RowDefinition Height="Auto"/> </Grid.RowDefinitions>

        <DockPanel Grid.Row="0" LastChildFill="True">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" Margin="5">
                <TextBlock Text="ë§ˆìŠ¤í„° í‚¤:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <PasswordBox x:Name="MasterPasswordBox" Width="100" VerticalAlignment="Center" infra:PasswordHelper.Attach="True" infra:PasswordHelper.Password="{Binding MasterPasswordInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                <Button Content="í™•ì¸" Margin="5,0,0,0" Command="{Binding CheckMasterPasswordCommand}"/>
            </StackPanel>
            <Border Background="LightGray" Padding="5">
                 <StackPanel Orientation="Horizontal"> <Button Content="ğŸ”„ ìƒˆë¡œê³ ì¹¨" Margin="3" Command="{Binding LoadDataCommand}"/> <Button Content="ğŸ’¾ ë³€ê²½ ì‚¬í•­ ì €ì¥" Margin="3" Command="{Binding SaveChangesCommand}"/>
                     <Button Content="âš™ï¸ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬" Margin="15,3,3,3" Command="{Binding OpenMasterDataWindowCommand}" ToolTip="ë§ˆìŠ¤í„° ë°ì´í„°(ì¸µ, êµ¬ì—­ ë“±)ë¥¼ ê´€ë¦¬í•˜ëŠ” ìƒˆ ì°½ì„ ì—½ë‹ˆë‹¤." Visibility="{Binding IsMasterModeEnabled, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"/>
                 </StackPanel>
            </Border>
        </DockPanel>

        <Grid Grid.Row="1" Margin="5">
            <Grid.RowDefinitions> <RowDefinition Height="Auto"/> <RowDefinition Height="*"/> </Grid.RowDefinitions>
            <Border Grid.Row="0" Background="WhiteSmoke" Padding="3"> <StackPanel Orientation="Horizontal"> <Button Content="â• ìƒˆ ì‚¬ë¬¼í•¨ ì¶”ê°€" Margin="3" Command="{Binding AddNewCommand}"/> <Button Content="âŒ ì„ íƒ í•­ëª© ì‚­ì œ" Margin="3" Command="{Binding DeleteCommand}"/> <Button Content="ğŸ§¹ ë°°ì • í•´ì œ" Margin="3" Command="{Binding ClearAssignmentCommand}"/> </StackPanel> </Border>
            <dxg:GridControl Grid.Row="1" ItemsSource="{Binding LockerAssignments}" SelectedItem="{Binding SelectedAssignment, Mode=TwoWay}">
                <dxg:GridControl.View> <dxg:TableView AllowPerPixelScrolling="True" ShowGroupPanel="True" AllowEditing="True" NavigationStyle="Cell" ShowAutoFilterRow="True" NewItemRowPosition="None" ShowIndicator="True" ShowSearchPanelMode="Always"> <dxg:TableView.RowCellMenuCustomizations> <dxb:BarButtonItem Content="ë°°ì • í•´ì œ" Command="{Binding View.DataContext.ClearAssignmentCommand}" Glyph="{dx:DXImage Svg/Actions/DeleteList.svg}"/> <dxb:BarItemSeparator/> <dxb:BarButtonItem Content="í–‰ ì‚­ì œ" Command="{Binding View.DataContext.DeleteCommand}" Glyph="{dx:DXImage Svg/Actions/Delete.svg}"/> </dxg:TableView.RowCellMenuCustomizations> </dxg:TableView> </dxg:GridControl.View>
                <dxg:GridControl.Columns>
                    <dxg:GridColumn FieldName="LockerType" Header="ì¢…ë¥˜" Width="100" Fixed="Left" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllLockerTypes}" DisplayMember="Name" ValueMember="Name" IsTextEditable="False" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Floor" Header="ì¸µ" Width="60" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllFloors}" DisplayMember="Name" ValueMember="Name" IsTextEditable="False" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Zone" Header="êµ¬ì—­" Width="80" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllZones}" DisplayMember="Name" ValueMember="Name" IsTextEditable="True" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="SpecificLocation" Header="ì„¸ë¶€ ìœ„ì¹˜" Width="120" HeaderStyle="{StaticResource LightBlueHeaderStyle}">
                        <dxg:GridColumn.EditSettings>
                            <dxe:TextEditSettings MaskType="Numeric" Mask="d" MaskUseAsDisplayFormat="True" HorizontalContentAlignment="Center"/>
                            </dxg:GridColumn.EditSettings>
                    </dxg:GridColumn>
                    <dxg:GridColumn FieldName="UserName" Header="ì„±ëª…" Width="100" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="KnoxId" Header="Knox ID" Width="100" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="SubPart" Header="ì†ŒíŒŒíŠ¸" Width="120" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllSubParts}" DisplayMember="Name" ValueMember="Name" IsTextEditable="True" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Administrator" Header="ê´€ë¦¬ ë‹´ë‹¹ì" Width="120" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:ComboBoxEditSettings ItemsSource="{Binding AllAdministrators}" DisplayMember="Name" ValueMember="Name" IsTextEditable="True" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="TransferStatus" Header="ì „ë°°ë³µì§" Width="100" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Details" Header="ë‚´ìš©" Width="150" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Left"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Remarks" Header="íŠ¹ì´ì‚¬í•­" Width="150" HeaderStyle="{StaticResource LightBlueHeaderStyle}">
                        <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Left"/> </dxg:GridColumn.EditSettings>
                    </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Notes" Header="ë¹„ê³ " Width="150" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:TextEditSettings HorizontalContentAlignment="Left"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="LastUpdated" Header="ìµœì¢… ìˆ˜ì •ì¼ì‹œ" Width="150" AllowEditing="False" ReadOnly="True" HeaderStyle="{StaticResource LightBlueHeaderStyle}"> <dxg:GridColumn.EditSettings> <dxe:DateEditSettings MaskType="DateTime" Mask="yyyy-MM-dd HH:mm:ss" MaskUseAsDisplayFormat="True" HorizontalContentAlignment="Center"/> </dxg:GridColumn.EditSettings> </dxg:GridColumn>
                    <dxg:GridColumn FieldName="Id" Header="ID" Visible="False" ReadOnly="True"/>
                </dxg:GridControl.Columns>
            </dxg:GridControl>
        </Grid>

        <StatusBar Grid.Row="2" Background="LightGray"> <StatusBarItem><TextBlock Text="{Binding StatusBarText}" Margin="5,0"/></StatusBarItem> </StatusBar>
    </Grid>

</dx:ThemedWindow>
2. ViewModels/MainViewModel.cs (ìˆ˜ì •)

OpenMasterDataWindowCommand ì‹¤í–‰ ë¡œì§ì— ë°±ì—… ê¸°ëŠ¥(BackupDataToCsv) í˜¸ì¶œ ì¶”ê°€.
BackupDataToCsv í—¬í¼ ë©”ì„œë“œ êµ¬í˜„ (CSV ë°©ì‹).
C#

// í•„ìš”í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¶”ê°€
using LockerManagementApp.Data;
using LockerManagementApp.Models;
using LockerManagementApp.Infrastructure;
using LockerManagementApp.Views;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Configuration;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Linq;
using System.Security;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using System.Runtime.InteropServices;
using System.IO; // íŒŒì¼/ë””ë ‰í† ë¦¬ ì‘ì—…ìš©
using System.Text; // Encoding ì‚¬ìš©

namespace LockerManagementApp.ViewModels
{
    /// <summary>
    /// ë©”ì¸ ViewModel (ë°±ì—… ê¸°ëŠ¥ ì¶”ê°€)
    /// </summary>
    public class MainViewModel : ViewModelBase, IDisposable
    {
        private LockerDbContext _context;
        private ObservableCollection<LockerAssignment> _lockerAssignments;
        private LockerAssignment _selectedAssignment;
        private string _statusBarText = "ì¤€ë¹„ ì™„ë£Œ";
        private string _currentAdmin = "í™ê¸¸ë™A";

        private SecureString _masterPasswordInput;
        private bool _isMasterModeEnabled = false;

        private ObservableCollection<LockerType> _allLockerTypes;
        private ObservableCollection<Floor> _allFloors;
        private ObservableCollection<Zone> _allZones;
        private ObservableCollection<SubPart> _allSubParts;
        private ObservableCollection<Administrator> _allAdministrators;

        // LogViewModel ìœ ì§€ (ë¡œê·¸ íƒ­ì´ í•„ìš”í•˜ë‹¤ë©´)
        public LogViewModel LogVM { get; private set; }

        #region Public Properties
        // ... (ì´ì „ê³¼ ë™ì¼) ...
        public ObservableCollection<LockerAssignment> LockerAssignments { get => _lockerAssignments; set => SetProperty(ref _lockerAssignments, value); }
        public LockerAssignment SelectedAssignment { get => _selectedAssignment; set { if (SetProperty(ref _selectedAssignment, value)) { ((RelayCommand)DeleteCommand).RaiseCanExecuteChanged(); ((RelayCommand)ClearAssignmentCommand).RaiseCanExecuteChanged(); } } }
        public string StatusBarText { get => _statusBarText; set => SetProperty(ref _statusBarText, value); }
        public SecureString MasterPasswordInput { get => _masterPasswordInput; set => SetProperty(ref _masterPasswordInput, value); }
        public bool IsMasterModeEnabled { get => _isMasterModeEnabled; set => SetProperty(ref _isMasterModeEnabled, value); }
        public ObservableCollection<LockerType> AllLockerTypes { get => _allLockerTypes; set => SetProperty(ref _allLockerTypes, value); }
        public ObservableCollection<Floor> AllFloors { get => _allFloors; set => SetProperty(ref _allFloors, value); }
        public ObservableCollection<Zone> AllZones { get => _allZones; set => SetProperty(ref _allZones, value); }
        public ObservableCollection<SubPart> AllSubParts { get => _allSubParts; set => SetProperty(ref _allSubParts, value); }
        public ObservableCollection<Administrator> AllAdministrators { get => _allAdministrators; set => SetProperty(ref _allAdministrators, value); }
        #endregion

        #region Commands
        // ... (ì´ì „ê³¼ ë™ì¼) ...
        public ICommand LoadDataCommand { get; }
        public ICommand SaveChangesCommand { get; }
        public ICommand AddNewCommand { get; }
        public ICommand DeleteCommand { get; }
        public ICommand ClearAssignmentCommand { get; }
        public ICommand CheckMasterPasswordCommand { get; }
        public ICommand RefreshMasterDataCommand { get; }
        public ICommand OpenMasterDataWindowCommand { get; }
        #endregion

        public MainViewModel()
        {
            try { _context = new LockerDbContext(); }
            catch (Exception ex) { MessageBox.Show($"DB ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜:\n{ex.ToString()}", "ì´ˆê¸°í™” ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); StatusBarText = "DB ì—°ê²° ì˜¤ë¥˜!"; return; }

            _lockerAssignments = new ObservableCollection<LockerAssignment>();
            _allLockerTypes = new ObservableCollection<LockerType>();
            _allFloors = new ObservableCollection<Floor>();
            _allZones = new ObservableCollection<Zone>();
            _allSubParts = new ObservableCollection<SubPart>();
            _allAdministrators = new ObservableCollection<Administrator>();

            // LogViewModel ìƒì„± (ë¡œê·¸ íƒ­ ì‚¬ìš© ì‹œ)
            LogVM = new LogViewModel();

            LoadDataCommand = new RelayCommand(async _ => await LoadInitialDataAsync());
            SaveChangesCommand = new RelayCommand(async _ => await SaveChangesAsync());
            AddNewCommand = new RelayCommand(AddNewLocker);
            DeleteCommand = new RelayCommand(async _ => await DeleteSelectedAsync(), _ => SelectedAssignment != null);
            ClearAssignmentCommand = new RelayCommand(ClearSelectedAssignment, _ => SelectedAssignment != null && SelectedAssignment.IsAssigned);
            CheckMasterPasswordCommand = new RelayCommand(CheckMasterPassword);
            RefreshMasterDataCommand = new RelayCommand(async _ => await LoadMasterDataAsync());
            OpenMasterDataWindowCommand = new RelayCommand(OpenMasterDataWindow); // ë°±ì—… ë¡œì§ í¬í•¨ë¨

            if (_context != null) { _ = LoadInitialDataAsync(); }
        }

        // --- ë°ì´í„° ë¡œë”© ë©”ì„œë“œ (ì´ì „ê³¼ ë™ì¼) ---
        private async Task LoadInitialDataAsync() { await LoadMasterDataAsync(); await LoadAssignmentsAsync(); }
        private async Task LoadAssignmentsAsync() { if (_context == null) return; StatusBarText = "ì‚¬ë¬¼í•¨ ëª©ë¡ ë¡œë”© ì¤‘..."; try { var assignments = await _context.LockerAssignments.OrderBy(l => l.Floor).ThenBy(l => l.Zone).ThenBy(l => l.SpecificLocation).ToListAsync(); LockerAssignments = new ObservableCollection<LockerAssignment>(assignments); StatusBarText = $"ì´ {LockerAssignments.Count}ê°œ ë¡œë“œ ì™„ë£Œ."; } catch (Exception ex) { HandleGenericException("ì‚¬ë¬¼í•¨ ëª©ë¡ ë¡œë”©", ex); } }
        private async Task LoadMasterDataAsync() { if (_context == null) return; StatusBarText = "ë§ˆìŠ¤í„° ë°ì´í„°(ì½¤ë³´ë°•ìŠ¤ìš©) ë¡œë”© ì¤‘..."; try { AllLockerTypes = new ObservableCollection<LockerType>(await _context.LockerTypes.OrderBy(t => t.Name).AsNoTracking().ToListAsync()); AllFloors = new ObservableCollection<Floor>(await _context.Floors.OrderBy(f => f.Name).AsNoTracking().ToListAsync()); AllZones = new ObservableCollection<Zone>(await _context.Zones.OrderBy(z => z.Name).AsNoTracking().ToListAsync()); AllSubParts = new ObservableCollection<SubPart>(await _context.SubParts.OrderBy(p => p.Name).AsNoTracking().ToListAsync()); AllAdministrators = new ObservableCollection<Administrator>(await _context.Administrators.OrderBy(a => a.Name).AsNoTracking().ToListAsync()); StatusBarText = "ë§ˆìŠ¤í„° ë°ì´í„°(ì½¤ë³´ë°•ìŠ¤ìš©) ë¡œë“œ ì™„ë£Œ."; } catch (InvalidOperationException ioEx) when (ioEx.Message.Contains("DataReader")) { HandleGenericException("ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”© (DataReader ì¶©ëŒ ê°€ëŠ¥ì„±)", ioEx); MessageBox.Show("ë°ì´í„° ë¡œë”© ì¤‘ ì¶©ëŒ ë°œìƒ. App.config ì—°ê²° ë¬¸ìì—´ì— MultipleActiveResultSets=True; ì˜µì…˜ í™•ì¸ ë˜ëŠ” ì¬ì‹œë„.", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); } catch (Exception ex) { HandleGenericException("ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”©", ex); } }
        private void CheckMasterPassword(object parameter) { try { string storedMasterKey = ConfigurationManager.AppSettings["MasterKey"]; if (string.IsNullOrEmpty(storedMasterKey)) { MessageBox.Show("App.configì— ë§ˆìŠ¤í„° í‚¤(MasterKey) ì—†ìŒ.", "ì„¤ì • ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); return; } string plainPassword = ConvertToUnsecureString(MasterPasswordInput); if (plainPassword == storedMasterKey) { IsMasterModeEnabled = true; StatusBarText = "ë§ˆìŠ¤í„° ëª¨ë“œ í™œì„±í™”."; MessageBox.Show("ë§ˆìŠ¤í„° í‚¤ í™•ì¸ ì™„ë£Œ.", "ì„±ê³µ", MessageBoxButton.OK, MessageBoxImage.Information); } else { IsMasterModeEnabled = false; MessageBox.Show("ë§ˆìŠ¤í„° í‚¤ ë¶ˆì¼ì¹˜.", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } } catch (ConfigurationErrorsException confEx) { MessageBox.Show($"ì„¤ì • íŒŒì¼ ì˜¤ë¥˜:\n{confEx.Message}", "ì„¤ì • ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } catch (Exception ex) { MessageBox.Show($"ë§ˆìŠ¤í„° í‚¤ í™•ì¸ ì˜¤ë¥˜: {ex.Message}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } }

        /// <summary>
        /// ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ì°½ ì—´ê¸° (+ ë°±ì—… ê¸°ëŠ¥)
        /// </summary>
        private void OpenMasterDataWindow(object parameter)
        {
            // *** ì‹ ê·œ ê¸°ëŠ¥: ë°±ì—… ì‹¤í–‰ ***
            if (!BackupDataToCsv()) // ë°±ì—… ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨ ë˜ëŠ” ê³„ì† ì§„í–‰ ì—¬ë¶€ ê²°ì •
            {
                if (MessageBox.Show("ë°ì´í„° ë°±ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", "ë°±ì—… ì‹¤íŒ¨", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
                {
                    return; // ì¤‘ë‹¨
                }
            }

            // --- ê¸°ì¡´ ì°½ ì—´ê¸° ë¡œì§ ---
            try
            {
                var masterDataVM = new MasterDataViewModel(); // ìƒˆ ViewModel (ìì²´ DbContext ì‚¬ìš©)
                var masterDataWindow = new MasterDataWindow { DataContext = masterDataVM, Owner = Application.Current.MainWindow };
                masterDataWindow.ShowDialog(); // ëª¨ë‹¬ë¡œ í‘œì‹œ

                // ì°½ ë‹«íŒ í›„ ì½¤ë³´ë°•ìŠ¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                _ = LoadMasterDataAsync();

                masterDataVM.Dispose(); // ViewModel ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            }
            catch (Exception ex) { MessageBox.Show($"ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ì°½ ì—´ê¸° ì˜¤ë¥˜:\n{ex.ToString()}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); }
        }


        #region CRUD ë° ê¸°íƒ€ ë©”ì„œë“œ (ì´ì „ê³¼ ë™ì¼)
        private async Task SaveChangesAsync() { if (_context == null) return; StatusBarText = "ë³€ê²½ ì‚¬í•­ ì €ì¥ ì¤‘..."; List<DbEntityEntry> allChangedEntriesForRollback = _context.ChangeTracker.Entries().Where(e => e.State != EntityState.Unchanged).ToList(); try { var changedLockerEntries = _context.ChangeTracker.Entries<LockerAssignment>().Where(e => e.State == EntityState.Added || e.State == EntityState.Modified).ToList(); var allItemsToCheck = LockerAssignments.ToList(); var duplicates = allItemsToCheck.GroupBy(l => new { l.Floor, l.Zone, l.SpecificLocation }).Where(g => g.Count() > 1).Select(g => g.Key); if (duplicates.Any()) { MessageBox.Show($"ì €ì¥ ë¶ˆê°€: ì¤‘ë³µ ìœ„ì¹˜ ë°œê²¬ - {string.Join(", ", duplicates.Select(d => $"{d.Floor}-{d.Zone}-{d.SpecificLocation}"))}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); RollbackChanges(allChangedEntriesForRollback); return; } foreach(var entry in changedLockerEntries) { entry.Entity.Administrator = _currentAdmin; } int changedCount = await _context.SaveChangesAsync(); StatusBarText = $"ì„±ê³µì ìœ¼ë¡œ {changedCount}ê°œ ì €ì¥ë¨."; } catch (DbUpdateException dbEx) { HandleDbUpdateException(dbEx); RollbackChanges(allChangedEntriesForRollback); } catch (Exception ex) { HandleGenericException("ì €ì¥", ex); RollbackChanges(allChangedEntriesForRollback); } }
        private void RollbackChanges(IEnumerable<DbEntityEntry> changedEntries) { if (_context == null || changedEntries == null) return; foreach (var entry in changedEntries.ToList()) { switch (entry.State) { case EntityState.Modified: entry.CurrentValues.SetValues(entry.OriginalValues); entry.State = EntityState.Unchanged; break; case EntityState.Added: entry.State = EntityState.Detached; if (entry.Entity is LockerAssignment addedEntity && LockerAssignments.Contains(addedEntity)) LockerAssignments.Remove(addedEntity); break; case EntityState.Deleted: entry.State = EntityState.Unchanged; break; } } StatusBarText = "ë³€ê²½ ë¡¤ë°±ë¨."; }
        private void AddNewLocker(object parameter) { if (_context == null) return; var newAssignment = new LockerAssignment { LockerType = AllLockerTypes.FirstOrDefault()?.Name ?? "ê°œì¸ì‚¬ë¬¼í•¨", Floor = AllFloors.FirstOrDefault()?.Name ?? "1", Zone = AllZones.FirstOrDefault()?.Name ?? "A", SpecificLocation = "ìƒˆ ìœ„ì¹˜-" + Guid.NewGuid().ToString("N").Substring(0, 4), Administrator = _currentAdmin, LastUpdated = DateTime.Now }; LockerAssignments.Add(newAssignment); _context.LockerAssignments.Add(newAssignment); SelectedAssignment = newAssignment; StatusBarText = "ìƒˆ ì‚¬ë¬¼í•¨ ì¶”ê°€ë¨. ì €ì¥ í•„ìš”."; }
        private async Task DeleteSelectedAsync() { if (_context == null || SelectedAssignment == null) return; if (MessageBox.Show($"'{SelectedAssignment.Floor}-{SelectedAssignment.Zone}-{SelectedAssignment.SpecificLocation}' ì‚­ì œ?", "í™•ì¸", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.Yes) { StatusBarText = "ì‚­ì œ ì¤‘..."; List<DbEntityEntry> changesForRollback = _context.ChangeTracker.Entries().Where(e => e.State != EntityState.Unchanged).ToList(); try { var assignmentToDelete = SelectedAssignment; var entry = _context.Entry(assignmentToDelete); if (entry.State == EntityState.Detached) { _context.LockerAssignments.Attach(assignmentToDelete); } _context.LockerAssignments.Remove(assignmentToDelete); int changedCount = await _context.SaveChangesAsync(); LockerAssignments.Remove(assignmentToDelete); SelectedAssignment = null; StatusBarText = $"ì„±ê³µì ìœ¼ë¡œ {changedCount}ê°œ ì‚­ì œë¨."; } catch (DbUpdateException dbEx) { HandleDbUpdateException(dbEx); RollbackChanges(changesForRollback); await LoadAssignmentsAsync(); } catch (Exception ex) { HandleGenericException("ì‚­ì œ", ex); RollbackChanges(changesForRollback); await LoadAssignmentsAsync(); } } }
        private void ClearSelectedAssignment(object parameter) { if (_context == null || SelectedAssignment == null) return; SelectedAssignment.UserName = null; SelectedAssignment.KnoxId = null; SelectedAssignment.SubPart = null; _context.Entry(SelectedAssignment).State = EntityState.Modified; SelectedAssignment.Administrator = _currentAdmin; StatusBarText = "ë°°ì • í•´ì œë¨. ì €ì¥ í•„ìš”."; }
        #endregion

        #region Backup Logic (CSV)

        /// <summary>
        /// í˜„ì¬ ëª¨ë“  í…Œì´ë¸” ë°ì´í„°ë¥¼ CSV íŒŒì¼ë¡œ ë°±ì—…í•©ë‹ˆë‹¤.
        /// </summary>
        /// <returns>ë°±ì—… ì„±ê³µ ì—¬ë¶€</returns>
        private bool BackupDataToCsv()
        {
            string backupDir = @"C:\agent"; // ë°±ì—… í´ë” ê²½ë¡œ
            string fileName = $"LockerBackup_{DateTime.Now:yyyyMMdd_HHmmss}.csv"; // ë‚ ì§œì‹œê°„ í¬í•¨ íŒŒì¼ëª…
            string filePath = Path.Combine(backupDir, fileName);
            StatusBarText = "ë°ì´í„° ë°±ì—… ì‹œì‘...";

            try
            {
                // ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´)
                Directory.CreateDirectory(backupDir);

                // ë°±ì—…ìš© ìƒˆ DbContext ìƒì„± (UI ì»¨í…ìŠ¤íŠ¸ì™€ ë¶„ë¦¬)
                using (var backupContext = new LockerDbContext())
                using (var writer = new StreamWriter(filePath, false, Encoding.UTF8)) // UTF-8 ì¸ì½”ë”©
                {
                    // ê° í…Œì´ë¸” ë°ì´í„° ë°±ì—…
                    WriteTableToCsv<LockerType>(backupContext, writer);
                    WriteTableToCsv<Floor>(backupContext, writer);
                    WriteTableToCsv<Zone>(backupContext, writer);
                    WriteTableToCsv<SubPart>(backupContext, writer);
                    WriteTableToCsv<Administrator>(backupContext, writer);
                    WriteTableToCsv<LockerAssignment>(backupContext, writer);
                    WriteTableToCsv<AuditLog>(backupContext, writer);
                }

                StatusBarText = $"ë°ì´í„° ë°±ì—… ì™„ë£Œ: {filePath}";
                MessageBox.Show($"ë°ì´í„°ê°€ ë‹¤ìŒ ìœ„ì¹˜ì— ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤:\n{filePath}", "ë°±ì—… ì™„ë£Œ", MessageBoxButton.OK, MessageBoxImage.Information);
                return true;
            }
            catch (Exception ex)
            {
                StatusBarText = $"ë°ì´í„° ë°±ì—… ì‹¤íŒ¨: {ex.Message}";
                MessageBox.Show($"ë°ì´í„° ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n{ex.ToString()}", "ë°±ì—… ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
                return false;
            }
        }

        /// <summary>
        /// íŠ¹ì • í…Œì´ë¸” ë°ì´í„°ë¥¼ CSV í˜•ì‹ìœ¼ë¡œ StreamWriterì— ì”ë‹ˆë‹¤.
        /// </summary>
        private void WriteTableToCsv<T>(LockerDbContext context, StreamWriter writer) where T : class
        {
            var dbSet = context.Set<T>();
            var entityType = typeof(T);
            var properties = entityType.GetProperties(); // ì—”í‹°í‹°ì˜ ì†ì„± ì •ë³´ ê°€ì ¸ì˜¤ê¸°

            writer.WriteLine($"--- Table: {entityType.Name} ---"); // í…Œì´ë¸” êµ¬ë¶„

            // í—¤ë” ì“°ê¸° (ì†ì„± ì´ë¦„)
            writer.WriteLine(string.Join(",", properties.Select(p => EscapeCsvValue(p.Name))));

            // ë°ì´í„° ì“°ê¸°
            foreach (var entity in dbSet)
            {
                var values = properties.Select(p => EscapeCsvValue(p.GetValue(entity)?.ToString() ?? ""));
                writer.WriteLine(string.Join(",", values));
            }
            writer.WriteLine(); // í…Œì´ë¸” ê°„ ë¹ˆ ì¤„ ì¶”ê°€
            writer.WriteLine();
        }

        /// <summary>
        /// CSV ê°’ì— í¬í•¨ë  ìˆ˜ ìˆëŠ” íŠ¹ìˆ˜ ë¬¸ì(ì‰¼í‘œ, ë”°ì˜´í‘œ, ì¤„ë°”ê¿ˆ)ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        /// </summary>
        private string EscapeCsvValue(string value)
        {
            if (string.IsNullOrEmpty(value)) return "";

            // ê°’ì— ì‰¼í‘œë‚˜ ë”°ì˜´í‘œ, ì¤„ë°”ê¿ˆ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í°ë”°ì˜´í‘œë¡œ ë¬¶ê³ , ë‚´ë¶€ì˜ í°ë”°ì˜´í‘œëŠ” ë‘ ë²ˆ ì”ë‹ˆë‹¤.
            if (value.Contains(",") || value.Contains("\"") || value.Contains("\r") || value.Contains("\n"))
            {
                return $"\"{value.Replace("\"", "\"\"")}\"";
            }
            return value;
        }


        #endregion

        #region Helper Methods (ì´ì „ê³¼ ë™ì¼)
        private void HandleGenericException(string operation, Exception ex) { StatusBarText = $"{operation} ì˜¤ë¥˜: {ex.Message}"; MessageBox.Show($"{operation} ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n{ex.ToString()}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); }
        private void HandleDbUpdateException(DbUpdateException dbEx) { var innerExMsg = dbEx.InnerException?.InnerException?.Message ?? dbEx.InnerException?.Message ?? dbEx.Message; StatusBarText = $"DB ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: {innerExMsg}"; MessageBox.Show($"DB ì‘ì—… ì˜¤ë¥˜:\n{innerExMsg}\n\n{dbEx.ToString()}", "DB ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); try { foreach(var entry in dbEx.Entries) { entry.Reload(); } } catch { /* Reload ì‹¤íŒ¨ ë¬´ì‹œ */ } }
        private string ConvertToUnsecureString(SecureString securePassword) { if (securePassword == null) return string.Empty; IntPtr ptr = IntPtr.Zero; try { ptr = Marshal.SecureStringToGlobalAllocUnicode(securePassword); return Marshal.PtrToStringUni(ptr); } finally { Marshal.ZeroFreeGlobalAllocUnicode(ptr); } }
        #endregion

        #region IDisposable êµ¬í˜„
        private bool disposed = false;
        protected virtual void Dispose(bool disposing) { if (!disposed) { if (disposing) { _context?.Dispose(); LogVM?.Dispose(); /* MasterDataVMì€ OpenMasterDataWindowì—ì„œ ê´€ë¦¬ */ } disposed = true; } }
        public void Dispose() { Dispose(true); GC.SuppressFinalize(this); }
        #endregion
    }
}
3. ViewModels/MasterDataViewModel.cs (ìˆ˜ì •)

SaveMasterDataChangesAsync ë©”ì„œë“œ ë‚´ ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™” (íŠ¹íˆ ExecuteSqlCommandAsync ë¶€ë¶„)
C#

using LockerManagementApp.Data;
using LockerManagementApp.Models;
using LockerManagementApp.Infrastructure;
using System;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using System.Collections.Generic;
using System.Diagnostics;

namespace LockerManagementApp.ViewModels
{
    /// <summary>
    /// ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ViewModel (ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”)
    /// </summary>
    public class MasterDataViewModel : ViewModelBase, IDisposable
    {
        private readonly LockerDbContext _context;

        #region Observable Collections & Properties
        public ObservableCollection<LockerType> LockerTypes { get; set; }
        public ObservableCollection<Floor> Floors { get; set; }
        public ObservableCollection<Zone> Zones { get; set; }
        public ObservableCollection<SubPart> SubParts { get; set; }
        public ObservableCollection<Administrator> Administrators { get; set; }
        private object _selectedItem;
        public object SelectedItem { get => _selectedItem; set { if (SetProperty(ref _selectedItem, value)) RaiseCanExecuteChanged(); } }
        private string _statusMessage;
        public string StatusMessage { get => _statusMessage; set => SetProperty(ref _statusMessage, value); }
        #endregion

        #region Commands
        public ICommand LoadAllMasterDataCommand { get; }
        public ICommand AddItemCommand { get; }
        public ICommand DeleteItemCommand { get; }
        public ICommand SaveChangesCommand { get; }
        #endregion

        public MasterDataViewModel()
        {
            try { _context = new LockerDbContext(); }
            catch (Exception ex) { MessageBox.Show($"[MasterData] DB ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜:\n{ex.ToString()}", "ì´ˆê¸°í™” ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); StatusMessage = "[MasterData] DB ì—°ê²° ì˜¤ë¥˜!"; LockerTypes = new ObservableCollection<LockerType>(); Floors = new ObservableCollection<Floor>(); Zones = new ObservableCollection<Zone>(); SubParts = new ObservableCollection<SubPart>(); Administrators = new ObservableCollection<Administrator>(); LoadAllMasterDataCommand = new RelayCommand(_ => { }, _ => false); AddItemCommand = new RelayCommand(_ => { }, _ => false); DeleteItemCommand = new RelayCommand(_ => { }, _ => false); SaveChangesCommand = new RelayCommand(_ => { }, _ => false); return; }

            LockerTypes = new ObservableCollection<LockerType>(); Floors = new ObservableCollection<Floor>(); Zones = new ObservableCollection<Zone>(); SubParts = new ObservableCollection<SubPart>(); Administrators = new ObservableCollection<Administrator>();
            LoadAllMasterDataCommand = new RelayCommand(async _ => await LoadAllMasterDataAsync());
            AddItemCommand = new RelayCommand(AddItem, CanAddItemExecute);
            DeleteItemCommand = new RelayCommand(DeleteItem, CanDeleteItemExecute);
            SaveChangesCommand = new RelayCommand(async _ => await SaveMasterDataChangesAsync(), CanSaveChangesExecute);
            if (_context != null) { _ = LoadAllMasterDataAsync(); }
        }

        #region Data Loading and CRUD Methods
        public async Task LoadAllMasterDataAsync() { if (_context == null) return; StatusMessage = "ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”© ì¤‘..."; try { var lockerTypes = await _context.LockerTypes.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); LockerTypes.Clear(); lockerTypes.ForEach(LockerTypes.Add); var floors = await _context.Floors.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); Floors.Clear(); floors.ForEach(Floors.Add); var zones = await _context.Zones.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); Zones.Clear(); zones.ForEach(Zones.Add); var subParts = await _context.SubParts.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); SubParts.Clear(); subParts.ForEach(SubParts.Add); var administrators = await _context.Administrators.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); Administrators.Clear(); administrators.ForEach(Administrators.Add); StatusMessage = "ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë“œ ì™„ë£Œ."; } catch (Exception ex) { StatusMessage = $"ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: {ex.Message}"; MessageBox.Show(StatusMessage, "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } }
        private bool CanAddItemExecute(object parameter) => _context != null && parameter is string category && !string.IsNullOrEmpty(category);
        private void AddItem(object parameter) { if (!CanAddItemExecute(parameter)) return; if (parameter is string category) { try { object newItem = null; switch (category.ToLower()) { case "lockertype": newItem = _context.LockerTypes.Add(new LockerType { Name = "ìƒˆ ì¢…ë¥˜" }); LockerTypes.Add((LockerType)newItem); break; case "floor": newItem = _context.Floors.Add(new Floor { Name = "ìƒˆ ì¸µ" }); Floors.Add((Floor)newItem); break; case "zone": newItem = _context.Zones.Add(new Zone { Name = "ìƒˆ êµ¬ì—­" }); Zones.Add((Zone)newItem); break; case "subpart": newItem = _context.SubParts.Add(new SubPart { Name = "ìƒˆ ì†ŒíŒŒíŠ¸" }); SubParts.Add((SubPart)newItem); break; case "administrator": newItem = _context.Administrators.Add(new Administrator { Name = "ìƒˆ ê´€ë¦¬ì" }); Administrators.Add((Administrator)newItem); break; default: MessageBox.Show("ì•Œ ìˆ˜ ì—†ëŠ” ì¹´í…Œê³ ë¦¬.", "ì˜¤ë¥˜"); return; } SelectedItem = newItem; StatusMessage = "ìƒˆ í•­ëª© ì¶”ê°€ë¨. ì €ì¥ í•„ìš”."; RaiseCanExecuteChanged(); } catch (Exception ex) { StatusMessage = $"í•­ëª© ì¶”ê°€ ì˜¤ë¥˜: {ex.Message}"; MessageBox.Show(StatusMessage, "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } } }
        private bool CanDeleteItemExecute(object parameter) => _context != null && SelectedItem != null;
        private void DeleteItem(object parameter) { if (!CanDeleteItemExecute(parameter)) return; string itemName = GetItemName(SelectedItem); if (itemName == null) return; string confirmMessage = $"'{itemName}' ì‚­ì œ?"; if (HasAssociatedAssignments(SelectedItem, itemName)) { confirmMessage += "\n\nê²½ê³ : ì‚¬ìš© ì¤‘ì¸ ì‚¬ë¬¼í•¨ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤!"; } if (MessageBox.Show(confirmMessage, "ì‚­ì œ í™•ì¸", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.Yes) { try { object entityToDelete = null; if (SelectedItem is LockerType lt) entityToDelete = lt; else if (SelectedItem is Floor f) entityToDelete = f; else if (SelectedItem is Zone z) entityToDelete = z; else if (SelectedItem is SubPart sp) entityToDelete = sp; else if (SelectedItem is Administrator ad) entityToDelete = ad; else return; var entry = _context.Entry(entityToDelete); if (entry.State == EntityState.Detached) _context.Set(entityToDelete.GetType()).Attach(entityToDelete); entry.State = EntityState.Deleted; if (SelectedItem is LockerType lt1) LockerTypes.Remove(lt1); else if (SelectedItem is Floor f1) Floors.Remove(f1); else if (SelectedItem is Zone z1) Zones.Remove(z1); else if (SelectedItem is SubPart sp1) SubParts.Remove(sp1); else if (SelectedItem is Administrator ad1) Administrators.Remove(ad1); SelectedItem = null; StatusMessage = "í•­ëª© ì‚­ì œ ëŒ€ê¸° ì¤‘. ì €ì¥ í•„ìš”."; RaiseCanExecuteChanged(); } catch (Exception ex) { StatusMessage = $"í•­ëª© ì‚­ì œ ì˜¤ë¥˜: {ex.Message}"; MessageBox.Show(StatusMessage, "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); _ = LoadAllMasterDataAsync(); } } }
        private string GetItemName(object item) { return item?.GetType().GetProperty("Name")?.GetValue(item)?.ToString(); }
        private bool HasAssociatedAssignments(object item, string itemName) { if (_context == null || item == null || string.IsNullOrEmpty(itemName)) return false; try { if (item is LockerType) return _context.LockerAssignments.Any(a => a.LockerType == itemName); if (item is Floor) return _context.LockerAssignments.Any(a => a.Floor == itemName); if (item is Zone) return _context.LockerAssignments.Any(a => a.Zone == itemName); if (item is SubPart) return _context.LockerAssignments.Any(a => a.SubPart == itemName); if (item is Administrator) return _context.LockerAssignments.Any(a => a.Administrator == itemName); } catch (Exception ex) { Debug.WriteLine($"ì—°ê´€ ë°ì´í„° í™•ì¸ ì˜¤ë¥˜: {ex.Message}"); return true; } return false; }

        /// <summary>
        /// ë§ˆìŠ¤í„° ë°ì´í„° ë³€ê²½ ì‚¬í•­ ì €ì¥ (ì—°ì‡„ ì—…ë°ì´íŠ¸ í¬í•¨) - ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”
        /// </summary>
        private async Task SaveMasterDataChangesAsync()
        {
            if (!CanSaveChangesExecute(null)) { StatusMessage = "ì €ì¥í•  ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."; return; }
            StatusMessage = "ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥ ì¤‘...";
            List<DbEntityEntry> changesForRollback = _context.ChangeTracker.Entries().Where(e => e.State != EntityState.Unchanged).ToList();

            using (var transaction = _context.Database.BeginTransaction())
            {
                try
                {
                    Debug.WriteLine("ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥ ì‹œì‘ - íŠ¸ëœì­ì…˜ ì‹œì‘ë¨.");
                    var modifiedNameEntries = _context.ChangeTracker.Entries()
                        .Where(e => e.State == EntityState.Modified && (e.Entity is LockerType || e.Entity is Floor || e.Entity is Zone || e.Entity is SubPart || e.Entity is Administrator))
                        .Select(e => new { Entry = e, EntityType = e.Entity.GetType(), OriginalName = e.OriginalValues["Name"]?.ToString(), CurrentName = e.CurrentValues["Name"]?.ToString() })
                        .Where(x => x.OriginalName != null && x.CurrentName != null && x.OriginalName != x.CurrentName).ToList();
                    Debug.WriteLine($"ì´ë¦„ ë³€ê²½ ê°ì§€ëœ ë§ˆìŠ¤í„° ë°ì´í„° ìˆ˜: {modifiedNameEntries.Count}");

                    foreach (var modified in modifiedNameEntries)
                    {
                        // ... (ì—°ì‡„ ì—…ë°ì´íŠ¸ SQL ì‹¤í–‰ ë¡œì§ - ì´ì „ê³¼ ë™ì¼, ë‚´ë¶€ try-catch í¬í•¨) ...
                        StatusMessage = $"'{modified.OriginalName}' -> '{modified.CurrentName}' ì—°ì‡„ ì—…ë°ì´íŠ¸ ì¤‘..."; Debug.WriteLine($"ì—°ì‡„ ì—…ë°ì´íŠ¸ ì‹œë„: Type={modified.EntityType.Name}, Original='{modified.OriginalName}', New='{modified.CurrentName}'"); int updatedCount = 0; string updateSql = ""; string targetColumn = ""; if (modified.EntityType == typeof(LockerType)) targetColumn = "LockerType"; else if (modified.EntityType == typeof(Floor)) targetColumn = "Floor"; else if (modified.EntityType == typeof(Zone)) targetColumn = "Zone"; else if (modified.EntityType == typeof(SubPart)) targetColumn = "SubPart"; else if (modified.EntityType == typeof(Administrator)) targetColumn = "Administrator"; if (!string.IsNullOrEmpty(targetColumn)) { updateSql = $"UPDATE LockerAssignments SET [{targetColumn}] = {{0}} WHERE [{targetColumn}] = {{1}}"; try { updatedCount = await _context.Database.ExecuteSqlCommandAsync(updateSql, modified.CurrentName, modified.OriginalName); StatusMessage = $"'{modified.OriginalName}' -> '{modified.CurrentName}' ({updatedCount}ê°œ ì—…ë°ì´íŠ¸ ì™„ë£Œ)."; Debug.WriteLine($"  SQL ì‹¤í–‰ ì„±ê³µ: {updateSql} | Params: '{modified.CurrentName}', '{modified.OriginalName}' | Rows Affected: {updatedCount}"); } catch (Exception sqlEx) { Debug.WriteLine($"*** ì—°ì‡„ ì—…ë°ì´íŠ¸ SQL ì‹¤í–‰ ì˜¤ë¥˜! SQL: {updateSql}, Params: '{modified.CurrentName}', '{modified.OriginalName}'\n*** ì˜¤ë¥˜: {sqlEx.ToString()}"); StatusMessage = $"'{modified.OriginalName}' ì—°ì‡„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!"; throw new Exception($"ì—°ì‡„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ({modified.OriginalName} -> {modified.CurrentName}): {sqlEx.Message}", sqlEx); } } else { Debug.WriteLine($"  ê²½ê³ : ì—”í‹°í‹° íƒ€ì… '{modified.EntityType.Name}'ì— ëŒ€í•œ ëŒ€ìƒ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
                    }

                    Debug.WriteLine("ë§ˆìŠ¤í„° ë°ì´í„° ë³€ê²½ ì‚¬í•­ ì €ì¥ ì‹œë„ (SaveChangesAsync)...");
                    int masterDataChanges = await _context.SaveChangesAsync(); // ë¡œê·¸ëŠ” DbContextì—ì„œ ìë™ ê¸°ë¡
                    Debug.WriteLine($"ë§ˆìŠ¤í„° ë°ì´í„° SaveChanges ì™„ë£Œ. ë³€ê²½ ê±´ìˆ˜: {masterDataChanges}");

                    transaction.Commit(); Debug.WriteLine("íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì™„ë£Œ.");
                    StatusMessage = $"ë§ˆìŠ¤í„° ë°ì´í„° ë³€ê²½ ì‚¬í•­ ({masterDataChanges}ê±´) ë° ì—°ì‡„ ì—…ë°ì´íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
                }
                catch (DbUpdateException dbEx) // SaveChangesì—ì„œ ë°œìƒí•œ DB ì œì•½ ì¡°ê±´ ë“±ì˜ ì˜¤ë¥˜
                {
                    Debug.WriteLine($"*** ë§ˆìŠ¤í„° ë°ì´í„° SaveChanges ì¤‘ DbUpdateException ë°œìƒ! íŠ¸ëœì­ì…˜ ë¡¤ë°± ì‹œë„...\n*** ì˜¤ë¥˜: {dbEx.ToString()}");
                    try { transaction.Rollback(); Debug.WriteLine("íŠ¸ëœì­ì…˜ ë¡¤ë°± ì™„ë£Œ."); } catch (Exception rbEx) { Debug.WriteLine($"*** íŠ¸ëœì­ì…˜ ë¡¤ë°± ì¤‘ ì˜¤ë¥˜ ë°œìƒ!\n*** ì˜¤ë¥˜: {rbEx.ToString()}"); }
                    HandleDbUpdateExceptionForMasterData(dbEx); // ìƒì„¸ ì˜¤ë¥˜ ì²˜ë¦¬
                    RollbackMasterDataChanges(changesForRollback); // ì»¨í…ìŠ¤íŠ¸ ìƒíƒœ ë˜ëŒë¦¬ê¸°
                }
                catch (Exception ex) // ì—°ì‡„ ì—…ë°ì´íŠ¸ SQL ì˜¤ë¥˜ ë˜ëŠ” ê¸°íƒ€ ì˜ˆì™¸
                {
                    Debug.WriteLine($"*** ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥/ì—°ì‡„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ! íŠ¸ëœì­ì…˜ ë¡¤ë°± ì‹œë„...\n*** ì˜¤ë¥˜: {ex.ToString()}");
                    try { transaction.Rollback(); Debug.WriteLine("íŠ¸ëœì­ì…˜ ë¡¤ë°± ì™„ë£Œ."); } catch (Exception rbEx) { Debug.WriteLine($"*** íŠ¸ëœì­ì…˜ ë¡¤ë°± ì¤‘ ì˜¤ë¥˜ ë°œìƒ!\n*** ì˜¤ë¥˜: {rbEx.ToString()}"); }
                    StatusMessage = $"ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
                    MessageBox.Show($"{StatusMessage}\n\nìì„¸í•œ ë‚´ìš©ì€ ì¶œë ¥ ì°½ì„ í™•ì¸í•˜ì„¸ìš”.", "ì €ì¥ ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
                    RollbackMasterDataChanges(changesForRollback); // ì»¨í…ìŠ¤íŠ¸ ìƒíƒœ ë˜ëŒë¦¬ê¸°
                }
            }
            await LoadAllMasterDataAsync(); // ì‘ì—… ì™„ë£Œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            RaiseCanExecuteChanged(); // ì €ì¥ í›„ CanExecute ìƒíƒœ ê°±ì‹ 
        }

        // ë¡¤ë°± í—¬í¼ (ì´ì „ê³¼ ë™ì¼)
        private void RollbackMasterDataChanges(List<DbEntityEntry> changedEntries) { if (_context == null || changedEntries == null) return; foreach (var entry in changedEntries) { switch (entry.State) { case EntityState.Modified: try { entry.Reload(); } catch { entry.State = EntityState.Unchanged; } break; case EntityState.Added: entry.State = EntityState.Detached; break; case EntityState.Deleted: entry.State = EntityState.Unchanged; break; } } StatusMessage = "ë§ˆìŠ¤í„° ë°ì´í„° ë³€ê²½ ë¡¤ë°±ë¨."; _ = LoadAllMasterDataAsync(); }

        // ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥ ì‹œ DbUpdateException ì²˜ë¦¬ í—¬í¼
        private void HandleDbUpdateExceptionForMasterData(DbUpdateException dbEx) { var innerExMsg = dbEx.InnerException?.InnerException?.Message ?? dbEx.InnerException?.Message ?? dbEx.Message; StatusMessage = $"DB ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: {innerExMsg}"; MessageBox.Show($"DB ì‘ì—… ì˜¤ë¥˜:\n{innerExMsg}\n\n{dbEx.ToString()}", "DB ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); }

        #endregion

        private void RaiseCanExecuteChanged() { (AddItemCommand as RelayCommand)?.RaiseCanExecuteChanged(); (DeleteItemCommand as RelayCommand)?.RaiseCanExecuteChanged(); (SaveChangesCommand as RelayCommand)?.RaiseCanExecuteChanged(); }
        #region IDisposable êµ¬í˜„
        private bool disposed = false;
        protected virtual void Dispose(bool disposing) { if (!disposed) { if (disposing) { _context?.Dispose(); } disposed = true; } }
        public void Dispose() { Dispose(true); GC.SuppressFinalize(this); }
        #endregion
    }
}
 1 ì£¼ìš” ë³€ê²½ ì‚¬í•­: Â  
1.
github.com
github.com

MainViewModel.cs: OpenMasterDataWindow ë©”ì„œë“œì— ë°±ì—… ë¡œì§(BackupDataToCsv) í˜¸ì¶œì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ë°±ì—… ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì— ë”°ë¼ ì§„í–‰ ì—¬ë¶€ë¥¼ ê²°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. BackupDataToCsv ë° ê´€ë ¨ í—¬í¼ ë©”ì„œë“œ(WriteTableToCsv, EscapeCsvValue)ë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. ë°±ì—… ì‹œì—ëŠ” UIì™€ ë…ë¦½ì ì¸ ìƒˆ DbContextë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
MasterDataViewModel.cs: SaveMasterDataChangesAsync ë©”ì„œë“œ ë‚´ì˜ try-catch ë¸”ë¡ì„ ì¢€ ë” ì„¸ë¶„í™”í•˜ì—¬ ExecuteSqlCommandAsync (ì—°ì‡„ ì—…ë°ì´íŠ¸) ì‹¤íŒ¨ì™€ SaveChangesAsync (ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥) ì‹¤íŒ¨ë¥¼ êµ¬ë¶„í•˜ê³ , ì˜¤ë¥˜ ë°œìƒ ì‹œ ë” ìì„¸í•œ ë””ë²„ê·¸ ì •ë³´ë¥¼ ì¶œë ¥í•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. (í•µì‹¬ ë¡œì§ ìì²´ëŠ” ì´ì „ê³¼ ë™ì¼)
MainWindow.xaml: "ì„¸ë¶€ìœ„ì¹˜" ì»¬ëŸ¼ì˜ EditSettingsë¥¼ TextEditSettingsë¡œ ë³€ê²½í•˜ê³  MaskType="Numeric" ë° Mask="d" (ì •ìˆ˜ë§Œ í—ˆìš©)ë¥¼ ì¶”ê°€í•˜ì—¬ ìˆ«ìë§Œ ì…ë ¥ë˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. "íŠ¹ì´ì‚¬í•­" ì»¬ëŸ¼ì€ ê¸°ë³¸ TextEditSettingsë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìœ ì§€í–ˆìŠµë‹ˆë‹¤ (ì˜¤ë¥˜ ë°œìƒ ì‹œ ì •í™•í•œ ì›ì¸ íŒŒì•… í•„ìš”).
í™•ì¸ ë° ì¶”ê°€ ì¡°ì¹˜:

ë°±ì—… í´ë”: C:\agent í´ë”ê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì§€ë§Œ, ì“°ê¸° ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ê¶Œí•œì´ ì—†ìœ¼ë©´ ë°±ì—…ì´ ì‹¤íŒ¨í•©ë‹ˆë‹¤.