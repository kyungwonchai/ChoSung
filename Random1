래는 열려있는 파일을 기준으로 작업하는 매크로입니다. 파일 경로를 지정할 필요 없이, 이미 열린 엑셀 파일에서 데이터를 처리합니다.

VBA 매크로 코드
vba
코드 복사
Sub ProcessOpenWorkbooks()
    Dim wbA As Workbook, wbB As Workbook
    Dim wsS1 As Worksheet, wsTarget As Worksheet
    Dim cell As Range
    Dim CH1 As String, SH1 As String
    Dim y1 As Range, y2 As Range
    Dim targetRow As Long

    ' 열린 파일 중 A와 B 설정 (SOP와 SMD로 시작하는 파일 찾기)
    For Each wbA In Application.Workbooks
        If Left(wbA.Name, 3) = "SOP" Then Exit For
    Next wbA

    For Each wbB In Application.Workbooks
        If Left(wbB.Name, 3) = "SMD" Then Exit For
    Next wbB

    If wbA Is Nothing Or wbB Is Nothing Then
        MsgBox "SOP 또는 SMD로 시작하는 파일이 모두 열려있지 않습니다."
        Exit Sub
    End If

    ' S1 시트 찾기 (사내와 외주 포함된 시트)
    For Each wsS1 In wbA.Worksheets
        If InStr(wsS1.Name, "사내") > 0 And InStr(wsS1.Name, "외주") > 0 Then Exit For
    Next wsS1

    If wsS1 Is Nothing Then
        MsgBox "A 파일에 '사내'와 '외주'가 포함된 시트를 찾을 수 없습니다."
        Exit Sub
    End If

    ' S1에서 CH1 찾기
    For Each cell In wsS1.Range("C150:C" & wsS1.Cells(wsS1.Rows.Count, "C").End(xlUp).Row)
        If InStr(cell.Value, "W") > 0 And IsNumeric(Mid(cell.Value, 2, 2)) And InStr(cell.Value, "일별 생산계획") > 0 Then
            CH1 = Left(cell.Value, 3) ' W55 추출
            SH1 = Mid(CH1, 2, 2) & "주차" ' 주차 생성
            Exit For
        End If
    Next cell

    If CH1 = "" Or SH1 = "" Then
        MsgBox "CH1 또는 SH1 값을 찾을 수 없습니다."
        Exit Sub
    End If

    ' y1, y2 설정
    For Each cell In wsS1.Range("C150:C" & wsS1.Cells(wsS1.Rows.Count, "C").End(xlUp).Row)
        If cell.MergeArea.Columns.Count > 1 Then
            Dim mergeRow As Long
            mergeRow = cell.Row
            If InStr(wsS1.Cells(mergeRow, "E").Value, "SM-") > 0 Then
                Set y1 = wsS1.Cells(mergeRow, "E")
                Set y2 = wsS1.Range(wsS1.Cells(mergeRow, "F"), wsS1.Cells(mergeRow, "K"))
                Exit For
            End If
        End If
    Next cell

    If y1 Is Nothing Or y2 Is Nothing Then
        MsgBox "y1 또는 y2 값을 찾을 수 없습니다."
        Exit Sub
    End If

    ' B 파일에서 SH1 시트 찾기
    For Each wsTarget In wbB.Worksheets
        If InStr(wsTarget.Name, SH1) > 0 Then Exit For
    Next wsTarget

    If wsTarget Is Nothing Then
        MsgBox "B 파일에 '" & SH1 & "' 시트를 찾을 수 없습니다."
        Exit Sub
    End If

    ' z1, z2로 데이터 복사
    targetRow = wsTarget.Cells(wsTarget.Rows.Count, "D").End(xlUp).Row + 1
    wsTarget.Cells(targetRow, "D").Value = y1.Value ' z1에 복사
    wsTarget.Range(wsTarget.Cells(targetRow, "F"), wsTarget.Cells(targetRow, "K")).Value = y2.Value ' z2에 복사

    ' 완료 메시지
    MsgBox "데이터 복사가 완료되었습니다."
End Sub
주요 변경 사항
파일 접근 방식: