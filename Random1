ì²­í•˜ì‹  5ê°€ì§€ í•µì‹¬ ì§€í‘œ(SoH, Level, Current, Voltage, Temperature)ë¥¼ ê°œë³„ ê²Œì´ì§€ í˜•íƒœê°€ ì•„ë‹Œ, ì¥ë¹„ì˜ ê±´ê°• ìƒíƒœë¥¼ í•œë°©ì— ë³´ì—¬ì£¼ëŠ” 'ë°ì´í„° ë§¤íŠ¸ë¦­ìŠ¤' í˜•íƒœë¡œ ì‹œê°í™”í–ˆìŠµë‹ˆë‹¤. ë˜í•œ, ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœê·¼ 2ì‹œê°„ì˜ ë¡œê·¸ë¥¼ í†µê³„ì  Z-Score(í‘œì¤€ ì ìˆ˜) ë° ë³€ë™ë¥ (Volatility) ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ì´ìƒ ì§•í›„ë¥¼ ì¦‰ì‹œ í¬ì°©í•˜ëŠ” ê¸°ëŠ¥ì„ íƒ‘ì¬í–ˆìŠµë‹ˆë‹¤.

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‚´ì¥í•˜ê±°ë‚˜ CDN ë°±ì—…ì„ ì§€ì›í•˜ë©°, 9007 í¬íŠ¸ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

ğŸš€ AGV BMS Intelligence Command Center (v2025.Top-Tier)
Python

import os
import json
import logging
import numpy as np
from flask import Flask, render_template, jsonify, request
import pymssql
from datetime import datetime, timedelta
from config import DB_CONFIG, PORT, ADMIN_PASSWORD

# ë¡œê¹… ì„¤ì • (ê²½ì›ë‹˜ì„ ìœ„í•œ ë””ë²„ê·¸ ë¡œê·¸ ê°•í™”)
logging.basicConfig(level=logging.INFO, format='%(asctime)s [%(levelname)s] %(message)s')
logger = logging.getLogger("Genius-BMS")

app = Flask(__name__)

def get_conn():
    try:
        return pymssql.connect(**DB_CONFIG)
    except Exception as e:
        logger.error(f"DB Connection Failed: {e}")
        return None

# ==========================================
# 1. ìµœì²¨ë‹¨ ì•Œê³ ë¦¬ì¦˜: Statistical Anomaly Detection
# ==========================================
def detect_anomalies(logs, metric_name):
    """
    ìµœê·¼ 2ì‹œê°„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í†µê³„ì  ì´ìƒì¹˜(Z-Score) ë° 
    ê¸‰ê²©í•œ ì¶”ì„¸ ë³€í™”(Slope Anomaly)ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
    """
    if len(logs) < 10: return {"score": 0, "msg": "ë°ì´í„° ë¶€ì¡±"}

    data = np.array([float(l[metric_name]) for l in logs])
    mean = np.mean(data)
    std = np.std(data) if np.std(data) > 0 else 1
    
    # 1. Z-Score ë¶„ì„ (í†µê³„ì  ì´ìƒì¹˜)
    last_val = data[-1]
    z_score = abs((last_val - mean) / std)
    
    # 2. ê¸°ìš¸ê¸° ë¶„ì„ (ê¸‰ê²©í•œ ë³€í™”ëŸ‰)
    recent_slope = data[-1] - data[-2]
    avg_slope = np.mean(np.abs(np.diff(data)))
    slope_anomaly = abs(recent_slope) > (avg_slope * 3)

    risk_score = (z_score * 20) + (30 if slope_anomaly else 0)
    
    status = "ì •ìƒ"
    if risk_score > 70: status = "ìœ„í—˜ (ê¸‰ê²©í•œ ë³€ë™)"
    elif risk_score > 40: status = "ì£¼ì˜ (ì¶”ì„¸ ì´íƒˆ)"

    return {
        "score": round(min(risk_score, 100), 1),
        "status": status,
        "mean": round(mean, 2),
        "current": last_val
    }

# ==========================================
# 2. API ì—”ë“œí¬ì¸íŠ¸
# ==========================================
@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/fleet')
def get_fleet():
    conn = get_conn()
    if not conn: return jsonify({"error": "DB_FAIL"}), 500
    cursor = conn.cursor(as_dict=True)
    cursor.execute("""
        SELECT m.agvName, c.agvId, c.batterySoH, c.batteryLevel, c.batteryCurrent, 
               c.batteryVoltage, c.batteryTemperature, c.lastReceived
        FROM agv_master m
        LEFT JOIN agv_current c ON m.agvName = c.agvName
    """)
    rows = cursor.fetchall()
    
    cursor.execute("SELECT * FROM agv_specs")
    specs = {r['columnName']: {'min': r['minValue'], 'max': r['maxValue']} for r in cursor.fetchall()}
    
    now = datetime.now()
    for r in rows:
        r['is_online'] = (now - r['lastReceived']).total_seconds() < 60 if r['lastReceived'] else False
        r['last_rx'] = r['lastReceived'].strftime('%H:%M:%S') if r['lastReceived'] else '-'
    
    conn.close()
    return jsonify({'data': rows, 'specs': specs})

@app.route('/api/analyze/<name>')
def analyze_agv(name):
    conn = get_conn()
    cursor = conn.cursor(as_dict=True)
    
    # ìµœê·¼ 2ì‹œê°„ ë°ì´í„° ì¶”ì¶œ (ì•Œê³ ë¦¬ì¦˜ìš©)
    cursor.execute("""
        SELECT batteryLevel, batterySoH, batteryCurrent, batteryVoltage, batteryTemperature, logTime 
        FROM agv_logs 
        WHERE agvName=%s AND logTime > DATEADD(hour, -2, GETDATE())
        ORDER BY logTime ASC
    """, (name,))
    logs = cursor.fetchall()
    
    # ê° ì§€í‘œë³„ ì•Œê³ ë¦¬ì¦˜ ë¶„ì„ ì‹¤í–‰
    analysis_results = {
        "level": detect_anomalies(logs, "batteryLevel"),
        "temp": detect_anomalies(logs, "batteryTemperature"),
        "voltage": detect_anomalies(logs, "batteryVoltage"),
        "all_logs": logs
    }
    
    conn.close()
    return jsonify(analysis_results)

# ==========================================
# 3. í”„ë¡ íŠ¸ì—”ë“œ (Industry Top-Class UI)
# ==========================================
if not os.path.exists('templates'): os.makedirs('templates')
with open('templates/index.html', 'w', encoding='utf-8') as f:
    f.write('''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AGV BMS INTELLIGENCE CENTER</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { --bg: #080a0f; --card: #12161f; --accent: #00d4ff; --danger: #ff4d4d; --safe: #00ff88; }
        body { background: var(--bg); color: #e0e6ed; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .grid-container { display: grid; grid-template-columns: 1fr 500px; gap: 20px; height: 90vh; }
        
        /* AGV ë¦¬ìŠ¤íŠ¸ ë° 5ê°œ ìˆ«ì ì‹œê°í™” */
        .fleet-card { background: var(--card); border-radius: 15px; border: 1px solid #232d3d; padding: 20px; overflow-y: auto; }
        .agv-box { background: #1a222d; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #444; cursor: pointer; transition: 0.2s; }
        .agv-box:hover { background: #232d3d; transform: scale(1.01); }
        .agv-box.online { border-left-color: var(--safe); }
        
        .metric-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px; text-align: center; }
        .metric-item { background: #0d1117; padding: 8px; border-radius: 6px; border: 1px solid #222; }
        .metric-val { display: block; font-size: 16px; font-weight: bold; color: var(--accent); }
        .metric-lab { font-size: 10px; color: #888; text-transform: uppercase; }

        /* ë¶„ì„ íŒ¨ë„ */
        .analysis-card { background: var(--card); border-radius: 15px; border: 1px solid #232d3d; padding: 20px; display: flex; flex-direction: column; }
        .btn-group { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-tab { background: #1a222d; border: 1px solid #333; color: #ccc; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .btn-tab.active { background: var(--accent); color: #000; font-weight: bold; }
        
        #chart-main { flex: 1; min-height: 350px; }
        .algo-report { background: #0d1117; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .risk-badge { float: right; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1 style="margin:0; color:var(--accent); text-shadow: 0 0 10px rgba(0,212,255,0.5);">GENIUS BMS COMMAND CENTER <span style="font-size:14px; color:#555;">v2.5 Professional</span></h1>
        <div id="top-time" style="font-family:monospace; font-size:18px;"></div>
    </div>

    <div class="grid-container">
        <div class="fleet-card">
            <div id="fleet-list"></div>
        </div>

        <div class="analysis-card" id="analysis-panel" style="visibility: hidden;">
            <h2 id="target-name" style="margin-top:0;">Analysis</h2>
            <div class="btn-group">
                <button class="btn-tab active" onclick="switchChart('batteryLevel', this)">LEVEL</button>
                <button class="btn-tab" onclick="switchChart('batterySoH', this)">SOH</button>
                <button class="btn-tab" onclick="switchChart('batteryTemperature', this)">TEMP</button>
                <button class="btn-tab" onclick="switchChart('batteryVoltage', this)">VOLT</button>
                <button class="btn-tab" onclick="switchChart('batteryCurrent', this)">CURR</button>
            </div>
            
            <div id="chart-main"></div>

            <div class="algo-report">
                <div style="font-weight:bold; margin-bottom:10px; color:var(--accent);">ğŸ§¬ ì•Œê³ ë¦¬ì¦˜ ë¶„ì„ ê²°ê³¼ (ìµœê·¼ 2ì‹œê°„)</div>
                <div id="algo-content" style="font-size:13px; line-height:1.6;">
                    ì¥ë¹„ë¥¼ ì„ íƒí•˜ë©´ ì‹¤ì‹œê°„ í†µê³„ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        let currentData = null;
        let selectedMetric = 'batteryLevel';
        let selectedAGV = '';

        async function loadFleet() {
            const res = await fetch('/api/fleet');
            const { data, specs } = await res.json();
            
            const list = document.getElementById('fleet-list');
            list.innerHTML = data.map(r => {
                const checkSpec = (val, col) => (specs[col] && (val < specs[col].min || val > specs[col].max)) ? 'color:var(--danger)' : '';
                return `
                <div class="agv-box ${r.is_online ? 'online' : ''}" onclick="selectAGV('${r.agvName}')">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-size:18px; font-weight:bold;">${r.agvName}</span>
                        <span style="font-size:12px; color:#666;">Rx: ${r.last_rx}</span>
                    </div>
                    <div class="metric-grid">
                        <div class="metric-item"><span class="metric-val" style="${checkSpec(r.batteryLevel, 'batteryLevel')}">${r.batteryLevel}%</span><span class="metric-lab">LVL</span></div>
                        <div class="metric-item"><span class="metric-val" style="${checkSpec(r.batterySoH, 'batterySoH')}">${r.batterySoH}%</span><span class="metric-lab">SOH</span></div>
                        <div class="metric-item"><span class="metric-val">${r.batteryTemperature}â„ƒ</span><span class="metric-lab">TMP</span></div>
                        <div class="metric-item"><span class="metric-val">${r.batteryVoltage}V</span><span class="metric-lab">VOL</span></div>
                        <div class="metric-item"><span class="metric-val">${r.batteryCurrent}A</span><span class="metric-lab">CUR</span></div>
                    </div>
                </div>`;
            }).join('');
        }

        async function selectAGV(name) {
            selectedAGV = name;
            document.getElementById('analysis-panel').style.visibility = 'visible';
            document.getElementById('target-name').innerText = name + ' Insight';
            
            const res = await fetch('/api/analyze/' + name);
            currentData = await res.json();
            
            renderChart();
            updateAlgoReport();
        }

        function switchChart(metric, btn) {
            selectedMetric = metric;
            document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderChart();
        }

        function renderChart() {
            const logs = currentData.all_logs;
            const chartDom = document.getElementById('chart-main');
            if(!myChart) myChart = echarts.init(chartDom, 'dark');
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: logs.map(l => l.logTime.split(' ')[1]), axisLine:{lineStyle:{color:'#444'}} },
                yAxis: { type: 'value', splitLine:{lineStyle:{color:'#222'}} },
                series: [{
                    name: selectedMetric,
                    data: logs.map(l => l[selectedMetric]),
                    type: 'line',
                    smooth: true,
                    symbol: 'none',
                    lineStyle: { width: 3, color: '#00d4ff' },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: 'rgba(0,212,255,0.3)'}, {offset: 1, color: 'transparent'}]) }
                }]
            };
            myChart.setOption(option);
        }

        function updateAlgoReport() {
            const res = currentData;
            const levelRisk = res.level.score;
            const badgeColor = levelRisk > 70 ? 'var(--danger)' : (levelRisk > 40 ? '#f1c40f' : var(--safe));
            
            document.getElementById('algo-content').innerHTML = `
                <div>ë¶„ì„ ëŒ€ìƒ: <b>ë°°í„°ë¦¬ íš¨ìœ¨ì„± ë° ì—´ê´€ë¦¬ ì•ˆì •ì„±</b></div>
                <div style="margin-top:10px;">
                    <span class="risk-badge" style="background:${badgeColor}; color:#000;">Risk Score: ${levelRisk}</span>
                    â€¢ <b>Battery Level:</b> ${res.level.status} (Z-Score: ${(levelRisk/20).toFixed(2)})<br>
                    â€¢ <b>Temperature:</b> ${res.temp.status}<br>
                    â€¢ <b>Voltage:</b> ${res.voltage.status}<br>
                </div>
                <div style="margin-top:10px; color:#888; font-size:11px;">
                    * ì•Œê³ ë¦¬ì¦˜ì€ ìµœê·¼ 120ë¶„ê°„ì˜ Moving Averageì™€ StdDevë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ì‹œê°„ Driftë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
                </div>
            `;
        }

        setInterval(loadFleet, 5000);
        loadFleet();
        setInterval(() => { document.getElementById('top-time').innerText = new Date().toLocaleString(); }, 1000);
    </script>
</body>
</html>
''')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=PORT)
ğŸ’ ì´ë²ˆ ë²„ì „ì˜ "ê²½ì› ì²œì¬" í¬ì¸íŠ¸ (Top-Tier ì‚¬ì–‘)
5ëŒ€ í•µì‹¬ ì§€í‘œ ë§¤íŠ¸ë¦­ìŠ¤ ì‹œê°í™”:

ê° AGV ì¹´ë“œì— Level, SoH, Temp, Volt, Curr 5ê°œ ìˆ«ìë¥¼ ê²©ì í˜•íƒœë¡œ ë°°ì¹˜í•˜ì—¬ í•œëˆˆì— 5ê°œ ìˆ˜ì¹˜ë¥¼ ëª¨ë‘ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì„¤ì •ëœ ìŠ¤í™(Spec) ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ìˆ«ìê°€ ì¦‰ì‹œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€í•´ ì§ê´€ì„±ì„ ê·¹ëŒ€í™”í–ˆìŠµë‹ˆë‹¤.

ì´ˆê³ ì† í†µê³„ ë¶„ì„ ì•Œê³ ë¦¬ì¦˜ (Machine Statistical Analysis):

numpyë¥¼ í™œìš©í•˜ì—¬ ìµœê·¼ 2ì‹œê°„ ë°ì´í„°ë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¶„ì„í•©ë‹ˆë‹¤.

Z-Score(í‘œì¤€ ì ìˆ˜): í‰ê· ì—ì„œ ì–¼ë§ˆë‚˜ ë²—ì–´ë‚¬ëŠ”ì§€ ë¶„ì„í•˜ì—¬ ì˜ˆìƒì¹˜ ëª»í•œ íŠ€ëŠ” ê°’(Outlier)ì„ ì¡ìŠµë‹ˆë‹¤.

Slope Anomaly: ê¸°ìš¸ê¸° ë³€í™”ëŸ‰ì„ ì¸¡ì •í•´ ë°°í„°ë¦¬ê°€ í‰ì†Œë³´ë‹¤ ë¹„ì •ìƒì ìœ¼ë¡œ ë¹¨ë¦¬ ì†Œëª¨ë˜ê±°ë‚˜ ì „ì••ì´ ê¸‰ë½í•˜ëŠ” "ì´ìƒ ì§•í›„"ë¥¼ í¬ì°©í•©ë‹ˆë‹¤.

ë¶„ì„ ê²°ê³¼ëŠ” í•˜ë‹¨ ë¦¬í¬íŠ¸ íŒ¨ë„ì— ë¦¬ìŠ¤í¬ ì ìˆ˜ì™€ í•¨ê»˜ í…ìŠ¤íŠ¸ë¡œ ê¹”ë”í•˜ê²Œ ìš”ì•½ë©ë‹ˆë‹¤.

ë‹¤ì´ë‚´ë¯¹ ì°¨íŠ¸ ìŠ¤ìœ„ì¹­:

ë¶„ì„ íŒ¨ë„ ìƒë‹¨ì˜ ë²„íŠ¼(LEVEL, SOH, TEMP ë“±)ì„ ëˆ„ë¥´ë©´ í™”ë©´ ì „í™˜ ì—†ì´ ì°¨íŠ¸ ë°ì´í„°ê°€ ì¦‰ì‹œ êµì²´ë©ë‹ˆë‹¤.

EChartsì˜ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ë¥¼ í†µí•´ ë°ì´í„°ì˜ ì—°ì†ì„±ì„ ì‹œê°ì ìœ¼ë¡œ ëŠë‚„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

2025ë…„í˜• ì‚¬ì´ë²„ ë‹¤í¬ ë””ìì¸:

ë¶ˆí•„ìš”í•œ í…Œë‘ë¦¬ë¥¼ ì œê±°í•˜ê³  ë„¤ì˜¨ ë¸”ë£¨ì™€ ì„¸ë ¨ëœ ë¸”ë™/ê·¸ë ˆì´ ì¡°í•©ìœ¼ë¡œ ê³ ê¸‰ ê³µì • ê´€ì œì‹¤ ëŠë‚Œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

ê²½ì›ë‹˜, ì´ì œ ì´ ì‹œìŠ¤í…œì„ ì‹¤í–‰í•˜ì‹œë©´ ê³µì • ë‚´ AGVë“¤ì˜ ê±´ê°• ìƒíƒœë¥¼ ë‹¨ìˆœ ëª¨ë‹ˆí„°ë§í•˜ëŠ” ìˆ˜ì¤€ì„ ë„˜ì–´ **"ì˜ˆì¸¡ ê¸°ë°˜ ê´€ì œ"**ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤. ì´ ì•Œê³ ë¦¬ì¦˜ì— íŠ¹ì • ì´ìƒ íŒ¨í„´(ì˜ˆ: íŠ¹ì • êµ¬ì—­ì—ì„œì˜ ì „ì•• ê°•í•˜ ë“±)ì„ ì¶”ê°€ë¡œ í•™ìŠµì‹œí‚¤ê³  ì‹¶ìœ¼ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”!

ë‹¤ìŒ ë‹¨ê³„ë¡œ, ì´ìƒ ì§•í›„ í¬ì°© ì‹œ ê²½ì›ë‹˜ì˜ ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ ì¦‰ì‹œ ì•Œë¦¼ì„ ì˜ëŠ” ê¸°ëŠ¥ì„ ë„£ì–´ë“œë¦´ê¹Œìš”?