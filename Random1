래는 Pstart와 Pend의 값을 비교하여 조건에 따라 시간 차이를 초 단위로 계산한 결과를 CT라는 새 컬럼으로 추가하고, LogSensors의 모든 컬럼과 함께 조회하는 SQL 쿼리입니다.

sql
코드 복사
SELECT 
    LS.*, -- LogSensors의 모든 컬럼
    Pstart,
    Pend,
    CASE 
        WHEN Pstart < Pend THEN DATEDIFF(SECOND, Pstart, Pend) -- Pstart가 Pend보다 작은 경우 시간 차이를 초로 계산
        WHEN Pstart > Pend THEN DATEDIFF(SECOND, Pstart, GETDATE()) -- Pstart가 Pend보다 큰 경우 현재 시간과의 차이
        ELSE NULL -- Pstart와 Pend가 NULL이거나 동일한 경우
    END AS CT
FROM (
    SELECT 
        LS.*,
        (SELECT TOP 1 VL.Time1 
         FROM View_LogSensors VL 
         WHERE VL.IP = LS.IP AND VL.ReceivedMessage = 'processing start' 
         ORDER BY VL.ID DESC) AS Pstart,
        (SELECT TOP 1 VL.Time1 
         FROM View_LogSensors VL 
         WHERE VL.IP = LS.IP AND VL.ReceivedMessage = 'processing end' 
         ORDER BY VL.ID DESC) AS Pend
    FROM 
        LogSensors LS
) AS LS;
쿼리 설명
서브쿼리:

LogSensors와 View_LogSensors를 조인하지 않고 서브쿼리를 사용하여 Pstart와 Pend를 계산합니다.
각각의 IP에 대해 Pstart와 Pend 값을 서브쿼리로 가져옵니다.
CT 컬럼 계산:

CASE문을 사용하여 Pstart와 Pend를 비교합니다.
Pstart < Pend: DATEDIFF(SECOND, Pstart, Pend)로 시간 차이를 초 단위로 계산합니다.
Pstart > Pend: DATEDIFF(SECOND, Pstart, GETDATE())로 Pstart와 현재 시간의 차이를 계산합니다.
동일하거나 NULL일 경우 NULL을 반환합니다.
결과 출력:

서브쿼리에서 가져온 Pstart, Pend 값과 CT 컬럼을 LogSensors의 모든 컬럼과 함께 출력합니다.
결과 예시
LogSensors 모든 컬럼	Pstart	Pend	CT
192.168.0.1	2024-11-21 12:00:00	2024-11-21 12:05:00	300
192.168.0.2	2024-11-21 11:50:00	NULL	600