경원님, 인트라넷 환경에서 윈도우 서버(2012)를 NTP 서버로 활용해 라즈베리파이의 시간을 동기화하는 것은 아주 효율적인 선택입니다. 라즈베리파이4(대부분 OS 기준)에 기본 내장된 systemd-timesyncd 서비스를 활용하는 것이 가장 깔끔합니다.

요청하신 대로 한 번에 설정을 끝낼 수 있는 파이썬 스크립트와 체크리스트를 정리해 드립니다.

1. NTP 동기화 자동 설정 스크립트
이 스크립트는 /etc/systemd/timesyncd.conf 파일을 수정하여 NTP 서버를 지정하고 서비스를 재시작합니다.

Python

import os
import subprocess

def setup_ntp():
    ntp_server = "10.244.123.95"
    config_path = "/etc/systemd/timesyncd.conf"
    
    # 1. 기존 설정 백업
    if os.path.exists(config_path):
        os.system(f"sudo cp {config_path} {config_path}.bak")
    
    # 2. NTP 서버 설정 내용 작성
    config_content = f"""[Time]
NTP={ntp_server}
#FallbackNTP=0.debian.pool.ntp.org 1.debian.pool.ntp.org
"""
    
    try:
        # 파일 쓰기 (sudo 권한 필요)
        with open("temp_ntp_conf", "w") as f:
            f.write(config_content)
        
        os.system(f"sudo mv temp_ntp_conf {config_path}")
        
        # 3. 서비스 재시작 및 활성화
        print("--- 서비스 재시작 및 동기화 적용 중 ---")
        subprocess.run(["sudo", "systemctl", "restart", "systemd-timesyncd"], check=True)
        subprocess.run(["sudo", "timedatectl", "set-ntp", "true"], check=True)
        
        # 4. 결과 확인
        print("\n[설정 완료] 현재 동기화 상태:")
        subprocess.run(["timedatectl", "status"], check=True)
        
    except Exception as e:
        print(f"오류 발생: {e}")

if __name__ == "__main__":
    setup_ntp()
2. 방화벽 및 네트워크 체크 (중요)
자동 동기화 주소를 바꿔도 바로 적용되지 않는다면 두 가지를 확인해야 합니다.

1) 포트 개방 (UDP 123)
NTP는 UDP 123번 포트를 사용합니다.

라즈베리파이: 내부 방화벽(ufw)이 켜져 있다면 허용해야 합니다.

명령어: sudo ufw allow 123/udp

사내 네트워크: 10.244.x.x 대역 간에 UDP 123번 포트가 차단되어 있는지 네트워크 담당자에게 확인이 필요할 수 있습니다.

윈도우 서버: 윈도우 방화벽에서 '인바운드 규칙'에 **NTP(UDP 123)**가 허용되어 있는지 확인하세요.

2) 윈도우 서버 2012 설정
윈도우 서버는 기본적으로 도메인 컨트롤러가 아니면 NTP 서버 기능이 꺼져 있을 수 있습니다. 서버에서 아래 명령어가 실행되어 있는지 확인이 필요합니다.

w32tm /config /reliable:YES /update

레지스트리 확인: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer의 Enabled 값이 1이어야 합니다.

3. 동기화 강제 적용 및 확인
스크립트 실행 후 바로 시간이 맞지 않는다면 아래 명령어로 강제 동기화를 시도하고 로그를 확인하세요.

로그 확인: 동기화 실패 원인이 나옵니다.

Bash

journalctl -u systemd-timesyncd
동기화 상태 상세 확인:

Bash

timedatectl show-timesync --all
Tip: systemd-timesyncd는 점진적으로 시간을 맞추는 성질이 있습니다. 만약 현재 시간과 서버 시간 차이가 너무 크면 동기화에 시간이 걸릴 수 있으니, sudo date -s "YYYY-MM-DD HH:MM:SS"로 대략적인 시간을 먼저 맞춘 후 서비스를 돌리는 것이 좋습니다.

추가로 윈도우 서버 쪽 설정 상태를 확인하는 방법이나, 다른 네트워크 트러블슈팅이 필요하시면 말씀해 주세요! 구미 공장 인트라넷 환경에 맞춰 더 상세히 가이드해 드릴 수 있습니다.

다음에 제가 무엇을 도와드릴까요?