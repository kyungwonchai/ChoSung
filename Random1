using System;
using System.Linq;
using DevExpress.XtraSpreadsheet;
using DevExpress.XtraSpreadsheet.Commands;

public class SpreadsheetController
{
    private XtraTabControl tabControl;
    private ListBox listBoxSheets;

    public SpreadsheetController(XtraTabControl tabControl, ListBox listBoxSheets)
    {
        this.tabControl = tabControl;
        this.listBoxSheets = listBoxSheets;

        // 탭 컨트롤에 이벤트 핸들러 등록
        tabControl.SelectedPageChanged += OnTabSelectedPageChanged;

        // 탭 컨트롤이 처음 로딩될 때 바로 스프레드시트 데이터 처리
        ProcessInitialSpreadsheetData();
    }

    // 탭이 선택될 때 호출되는 이벤트 핸들러
    private void OnTabSelectedPageChanged(object sender, TabPageChangedEventArgs e)
    {
        // 선택된 탭 페이지에서 해당하는 스프레드시트 컨트롤 가져오기
        var spreadsheetControl = e.Page.Controls.OfType<SpreadsheetControl>().FirstOrDefault();

        if (spreadsheetControl != null)
        {
            // 해당 탭 페이지의 스프레드시트 컨트롤에 데이터를 불러와서 업데이트
            UpdateSpreadsheetData(spreadsheetControl);

            // 해당 탭 페이지의 스프레드시트 컨트롤에서 시트 이름들을 가져와서 리스트 박스에 세로로 나열
            listBoxSheets.Items.Clear();
            WorksheetCollection worksheets = spreadsheetControl.Document.Worksheets;
            foreach (Worksheet sheet in worksheets)
            {
                listBoxSheets.Items.Add(sheet.Name);
            }
        }
    }

    // 스프레드시트에 데이터를 업데이트하는 메서드 (이 부분은 실제 데이터를 업데이트하는 로직으로 대체되어야 합니다.)
    private void UpdateSpreadsheetData(SpreadsheetControl spreadsheetControl)
    {
        // 여기에 데이터를 업데이트하는 로직을 작성합니다.
        // 스프레드시트 컨트롤에 데이터를 불러와서 업데이트하는 코드가 위치해야 합니다.
        // 각 탭 페이지에 해당하는 데이터를 로드하여 스프레드시트에 표시하는 로직을 구현하세요.
        // 예시: spreadsheetControl.Document.LoadDocument("파일경로");
    }

    // 초기 로딩 시점에 스프레드시트 데이터 처리
    private void ProcessInitialSpreadsheetData()
    {
        foreach (var tabPage in tabControl.TabPages)
        {
            var spreadsheetControl = tabPage.Controls.OfType<SpreadsheetControl>().FirstOrDefault();
            if (spreadsheetControl != null)
            {
                // 각 탭 페이지에 대한 초기 스프레드시트 데이터 처리
                UpdateSpreadsheetData(spreadsheetControl);

                // 리스트 박스에 시트 이름 추가
                WorksheetCollection worksheets = spreadsheetControl.Document.Worksheets;
                foreach (Worksheet sheet in worksheets)
                {
                    listBoxSheets.Items.Add(sheet.Name);
                }
            }
        }
    }
}
