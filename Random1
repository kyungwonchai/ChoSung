ì•¼ í•¨

ğŸ”¥ í•´ê²° ë°©ë²•
ê° ê·¸ë£¹ì„ Queue<Task>ë¡œ ê´€ë¦¬í•˜ì—¬ ë³‘ëª© ì—†ì´ ìˆœì°¨ ì‹¤í–‰
ë³‘ë ¬ ì‹¤í–‰ì„ ë§‰ê³ , ë°˜ë“œì‹œ ìˆœì°¨ ì‹¤í–‰ë˜ë„ë¡ Task.Run().Wait() í™œìš©
ì‘ì—…ì´ ì ì  ìŒ“ì´ì§€ ì•Šë„ë¡ ì‹¤í–‰ì´ ëë‚œ í›„ ë‹¤ìŒ ì‘ì—…ì„ ì‹¤í–‰í•˜ë„ë¡ ë³´ì¥
ğŸ“Œ ì™„ë²½í•œ WinForms ì½”ë“œ
csharp
Copy code
using System;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace AsyncWinForms
{
    public partial class Form1 : Form
    {
        private CancellationTokenSource _ctsA; // A-B ê·¸ë£¹ ê´€ë¦¬
        private CancellationTokenSource _ctsC; // C-D-E ê·¸ë£¹ ê´€ë¦¬

        private readonly Queue<Func<Task>> _taskQueueAB = new Queue<Func<Task>>(); // A-B ì‘ì—… í
        private readonly Queue<Func<Task>> _taskQueueCDE = new Queue<Func<Task>>(); // C-D-E ì‘ì—… í

        private bool _isProcessingAB = false; // A-B ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
        private bool _isProcessingCDE = false; // C-D-E ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸

        public Form1()
        {
            InitializeComponent();
        }

        // âœ… [ì‹œì‘ ë²„íŠ¼] ë‘ ê°œì˜ ë¬´í•œ ë£¨í”„ ì‹¤í–‰
        private void btnStart_Click(object sender, EventArgs e)
        {
            if (_ctsA == null)
            {
                _ctsA = new CancellationTokenSource();
                Task.Run(() => ProcessLoopAB(_ctsA.Token)); // A-B ë£¨í”„ ì‹œì‘
            }

            if (_ctsC == null)
            {
                _ctsC = new CancellationTokenSource();
                Task.Run(() => ProcessLoopCDE(_ctsC.Token)); // C-D-E ë£¨í”„ ì‹œì‘
            }
        }

        // âœ… [A-B ê·¸ë£¹ ì „ìš© ë¬´í•œ ë£¨í”„]
        private async Task ProcessLoopAB(CancellationToken token)
        {
            for (;;)
            {
                if (token.IsCancellationRequested) break; // ì¢…ë£Œ ìš”ì²­ ì‹œ ë£¨í”„ íƒˆì¶œ

                if (!_isProcessingAB && _taskQueueAB.Count > 0)
                {
                    _isProcessingAB = true;
                    var task = _taskQueueAB.Dequeue();
                    await task();
                    _isProcessingAB = false;
                }

                await Task.Delay(10); // CPU ê³¼ë¶€í•˜ ë°©ì§€
            }
        }

        // âœ… [C-D-E ê·¸ë£¹ ì „ìš© ë¬´í•œ ë£¨í”„]
        private async Task ProcessLoopCDE(CancellationToken token)
        {
            for (;;)
            {
                if (token.IsCancellationRequested) break;

                if (!_isProcessingCDE && _taskQueueCDE.Count > 0)
                {
                    _isProcessingCDE = true;
                    var task = _taskQueueCDE.Dequeue();
                    await task();
                    _isProcessingCDE = false;
                }

                await Task.Delay(10);
            }
        }

        // âœ… [ì¤‘ì§€ ë²„íŠ¼] ëª¨ë“  ë£¨í”„ ì¢…ë£Œ
        private void btnStop_Click(object sender, EventArgs e)
        {
            _ctsA?.Cancel(); _ctsA = null;
            _ctsC?.Cancel(); _ctsC = null;
        }

        // âœ… A-B ê·¸ë£¹ì— ì‘ì—… ì¶”ê°€ (ìˆœì°¨ ì‹¤í–‰ ë³´ì¥)
        private void EnqueueAB(Func<Task> task)
        {
            _taskQueueAB.Enqueue(task);
        }

        // âœ… C-D-E ê·¸ë£¹ì— ì‘ì—… ì¶”ê°€ (ìˆœì°¨ ì‹¤í–‰ ë³´ì¥)
        private void EnqueueCDE(Func<Task> task)
        {
            _taskQueueCDE.Enqueue(task);
        }

        // âœ… A-B ê·¸ë£¹ í•¨ìˆ˜ë“¤ (ìˆœì°¨ ì‹¤í–‰)
        private async Task FunctionA()
        {
            AddLog("Function A ì‹¤í–‰");
            await Task.Delay(500); // ì‘ì—… ì‹œê°„
        }

        private async Task FunctionB()
        {
            AddLog("Function B ì‹¤í–‰");
            await Task.Delay(500);
        }

        // âœ… C-D-E ê·¸ë£¹ í•¨ìˆ˜ë“¤ (ìˆœì°¨ ì‹¤í–‰)
        private async Task FunctionC()
        {
            AddLog("Function C ì‹œì‘");
            await Task.Delay(3000);
            AddLog("Function C ì¢…ë£Œ");
        }

        private async Task FunctionD()
        {
            AddLog("Function D ì‹œì‘");
            await Task.Delay(2000);
            AddLog("Function D ì¢…ë£Œ");
        }

        private async Task FunctionE()
        {
            AddLog("Function E ì‹œì‘");
            await Task.Delay(1000);
            AddLog("Function E ì¢…ë£Œ");
        }

        // âœ… í…ŒìŠ¤íŠ¸ ë²„íŠ¼ (A-B ê·¸ë£¹ ì‘ì—… ì¶”ê°€)
        private void btnTestAB_Click(object sender, EventArgs e)
        {
            EnqueueAB(FunctionA);
            EnqueueAB(FunctionB);
        }

        // âœ… í…ŒìŠ¤íŠ¸ ë²„íŠ¼ (C-D-E ê·¸ë£¹ ì‘ì—… ì¶”ê°€)
        private void btnTestCDE_Click(object sender, EventArgs e)
        {
            EnqueueCDE(FunctionC);
            EnqueueCDE(FunctionD);
            EnqueueCDE(FunctionE);
        }

        // âœ… ListBoxì— ë¡œê·¸ ì¶”ê°€ (ìµœëŒ€ 100ê°œ ìœ ì§€)
        private void AddLog(string message)
        {
            if (listBox1.InvokeRequired)
            {
                listBox1.Invoke((Action)(() => AddLog(message)));
                return;
            }

            if (listBox1.Items.Count >= 100)
                listBox1.Items.RemoveAt(0);

            listBox1.Items.Add($"{DateTime.Now:HH:mm:ss} - {message}");
            listBox1.TopIndex = listBox1.Items.Count - 1;
        }
    }
}
ğŸ”¥ ì‹¤í–‰ íë¦„ (ì´ì œ ì™„ë²½í•¨)
âœ” A-B ê·¸ë£¹ (ìˆœì°¨ ì‹¤í–‰) â†’ btnTestAB_Click ëˆ„ë¥´ë©´ FunctionA â†’ FunctionB ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ë¨
âœ” C-D-E ê·¸ë£¹ (ìˆœì°¨ ì‹¤í–‰) â†’ btnTestCDE_Click ëˆ„ë¥´ë©´ FunctionC â†’ FunctionD â†’ FunctionE ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ë¨
âœ” ê° ê·¸ë£¹ì€ Queue<Task>ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆœì°¨ ì‹¤í–‰ ë³´ì¥ (ë³‘ë ¬ë¡œ ìŸì•„ì§€ëŠ” ë¬¸ì œ í•´ê²°!)
âœ” ë‘ ê°œì˜ ë¬´í•œ ë£¨í”„ê°€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ì‘ì—…ì´ ë³‘ëª© ì—†ì´ ì‹¤í–‰ë¨
âœ” CPU ê³¼ë¶€í•˜ ì—†ì´ ìµœì ì˜ ì‹¤í–‰ ê°€ëŠ¥ (await Task.Delay(10))

ğŸš€ ì´ì œ ì™„ë²½í•˜ê²Œ ë¶„ë¦¬ + ìˆœì°¨ ì‹¤í–‰!
A-BëŠ” ê°™ì´ ì‹¤í–‰ë˜ë©´ì„œë„ ìˆœì°¨ ìœ ì§€!
C-D-EëŠ” ë”°ë¡œ ì‹¤í–‰ë˜ë©´ì„œë„ ìˆœì°¨ ìœ ì§€!
ë³‘ëª© ë¬¸ì œ í•´ê²° â†’ ì‹¤í–‰ì´ ìŒ“ì´ì§€ ì•ŠìŒ!