이고, 알았다! 미안하다 진짜.
말한 대로라면 이미 WITH로 LastestModels 를 만든 상황에서 그 아래 또 다른 WITH를 못 쓰는 구조라는 거지?

그럼 전체를 한 WITH 블록 안에 묶고, 거기서부터 SELECT로 쿼리를 마무리해줄게.
이제 다시 차분하게, 정확하게 짜준다. 아래는 하나의 WITH 블록에 모든 걸 다 넣은 구조야:

sql
코드 복사
WITH LastestModels AS (
    -- 여기서 라인별 최신 모델을 미리 구해놨다고 가정
    SELECT model
    FROM YourLastestModelTable
),
ExcelFiltered AS (
    SELECT *
    FROM ExcelData E
    INNER JOIN LastestModels L ON E.model1 = L.model
    WHERE E.time1 >= DATEADD(HOUR, -5, GETDATE())
),
Unpivoted AS (
    SELECT
        model1,
        ColName,
        Value
    FROM ExcelFiltered
    UNPIVOT (
        Value FOR ColName IN (
            ACT2_1, ACT2_2, ACT2_3, ACT2_4, ACT2_5, ACT2_6, ACT2_7, ACT2_8,
            ACT2BEST_1, ACT2BEST_2, ACT2BEST_3, ACT2BEST_4,
            ACT2BEST_5, ACT2BEST_6, ACT2BEST_7, ACT2BEST_8
        )
    ) AS Unpvt
    WHERE Value > 0
),
WithQuantiles AS (
    SELECT
        model1,
        ColName,
        Value,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q3
    FROM Unpivoted
),
FilteredByIQR AS (
    SELECT model1, ColName, Value
    FROM WithQuantiles
    WHERE Value BETWEEN Q1 AND Q3
)
SELECT
    model1,
    ColName,
    MIN(Value) AS MinValueWithoutOutliers
FROM FilteredByIQR
GROUP BY model1, ColName
ORDER BY model1, ColName;
설명 다시 짧게 요약:
LastestModels: 라인별 최신 모델만 먼저 구해.

ExcelFiltered: 최근 5시간 이내이면서 그 모델과 일치하는 것만.

Unpivoted: 16개 컬럼을 세로로 바꿈.

WithQuantiles: Q1, Q3 분위수 계산.

FilteredByIQR: 이상치 제거.

최종 SELECT: 각 모델-컬럼별 이상치 제외한 최소값.
