tartReceiving() 메서드가 비동기 수신을 처리하는 부분인데, 제가 SocketClientMergeOI 클래스 내부에서 이 함수를 호출하고 정의하지 않아서 빨간줄이 뜨는 문제가 발생한 것입니다. StartReceiving() 메서드를 추가로 구현하여 서버로부터 메시지를 수신하는 로직을 넣겠습니다.

수정된 코드:
csharp
코드 복사
using System;
using System.Collections.ObjectModel;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;

public class SocketClientMergeOI
{
    private TcpClient _client; // TCP 클라이언트 객체
    private NetworkStream _stream; // 네트워크 스트림
    private readonly string _ipAddress; // 접속할 서버의 IP 주소
    private readonly int _port; // 접속할 서버의 포트 번호
    private bool _isConnected; // 서버와의 연결 여부 플래그
    private readonly int _retryInterval = 10000; // 10초 간격으로 재연결 시도

    // ObservableCollection을 사용하여 메시지 목록 관리
    public ObservableCollection<MessageLog> MessageLogs { get; private set; } // 읽기 전용

    // 생성자: IP 주소와 포트로 소켓 클라이언트를 초기화
    public SocketClientMergeOI(string ipAddress, int port)
    {
        _ipAddress = ipAddress; // 입력받은 IP 저장
        _port = port; // 입력받은 포트 저장
        _client = new TcpClient(); // TCP 클라이언트 생성
        _isConnected = false; // 초기 연결 상태 false
        MessageLogs = new ObservableCollection<MessageLog>(); // 메시지 로그 초기화
        StartConnectionAttemptAsync(); // 연결 시도 시작
    }

    // 서버에 연결 시도하는 비동기 함수
    private async void StartConnectionAttemptAsync()
    {
        while (!_isConnected) // 연결이 될 때까지 반복
        {
            try
            {
                await _client.ConnectAsync(_ipAddress, _port); // 서버에 연결 시도
                _isConnected = true; // 연결 성공
                _stream = _client.GetStream(); // 스트림 생성
                LogMessage("System", _ipAddress, "Connected", ""); // 연결 성공 로그 남김
                StartReceiving(); // 메시지 수신 대기
            }
            catch (Exception)
            {
                LogMessage("System", _ipAddress, "Retrying in 10 seconds...", ""); // 재시도 로그
                await Task.Delay(_retryInterval); // 10초 대기 후 재시도
            }
        }
    }

    // 서버로부터 메시지를 수신하는 비동기 함수
    private async void StartReceiving()
    {
        byte[] buffer = new byte[1024]; // 수신할 데이터를 담을 버퍼 생성

        while (_isConnected) // 연결된 동안 메시지 수신을 계속 시도
        {
            try
            {
                int bytesRead = await _stream.ReadAsync(buffer, 0, buffer.Length); // 데이터를 비동기적으로 읽음
                if (bytesRead > 0)
                {
                    string receivedMessage = Encoding.ASCII.GetString(buffer, 0, bytesRead); // 수신된 데이터를 문자열로 변환
                    LogMessage(_ipAddress, "Client", "", receivedMessage); // 수신 메시지를 로그에 기록
                }
            }
            catch (Exception)
            {
                _isConnected = false; // 연결이 끊긴 경우
                LogMessage("System", _ipAddress, "Connection lost", ""); // 연결 끊김 로그
                StartConnectionAttemptAsync(); // 다시 연결 시도
            }
        }
    }

    // 메시지를 전송하고 응답을 받는 비동기 함수
    public async Task<string> SendAndReceiveMessageAsync(string message)
    {
        if (!_isConnected) // 연결이 되어 있지 않으면
            return "Not connected";

        string fullMessage = $"\x02{message}\x03"; // STX 및 ETX 추가
        byte[] messageBytes = Encoding.ASCII.GetBytes(fullMessage); // 메시지를 바이트 배열로 변환

        try
        {
            await _stream.WriteAsync(messageBytes, 0, messageBytes.Length); // 서버에 전송
            LogMessage("Client", _ipAddress, message, ""); // 전송 로그 남김
        }
        catch (Exception)
        {
            return "Send Failed";
        }

        // 서버로부터 응답 대기 및 검증
        string response = await ReceiveMessageAsync();
        LogMessage(_ipAddress, "Client", message, response); // 응답 로그 기록
        return ValidateResponse(message, response); // 응답 검증 후 결과 반환
    }

    // 서버로부터 메시지를 수신하는 비동기 함수
    private async Task<string> ReceiveMessageAsync()
    {
        byte[] buffer = new byte[1024]; // 수신할 데이터를 담을 버퍼

        try
        {
            int bytesRead = await _stream.ReadAsync(buffer, 0, buffer.Length); // 데이터를 비동기적으로 수신
            if (bytesRead > 0)
            {
                string receivedMessage = Encoding.ASCII.GetString(buffer, 0, bytesRead); // 수신된 데이터를 문자열로 변환
                return receivedMessage; // 변환된 메시지 반환
            }
        }
        catch (Exception)
        {
            _isConnected = false; // 연결이 끊긴 경우
            LogMessage("System", _ipAddress, "Connection lost", ""); // 연결 끊김 로그
            StartConnectionAttemptAsync(); // 다시 연결 시도
        }

        return string.Empty;
    }

    // 메시지 로그 추가 함수
    private void LogMessage(string sender, string receiver, string sentMessage, string responseMessage)
    {
        // 로그 항목 추가
        MessageLog log = new MessageLog
        {
            Timestamp = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"),
            Sender = sender,
            Receiver = receiver,
            SentMessage = sentMessage,
            ResponseMessage = responseMessage
        };

        if (MessageLogs.Count >= 50) // 최대 50개 로그 유지
        {
            MessageLogs.RemoveAt(0); // 오래된 항목 삭제
        }

        MessageLogs.Add(log); // 새로운 항목 추가
    }

    // 응답 검증 함수
    private string ValidateResponse(string sentMessage, string receivedMessage)
    {
        if (receivedMessage.StartsWith("\x02") && receivedMessage.EndsWith("\x03"))
        {
            string cleanMessage = receivedMessage.Trim('\x02', '\x03');
            if (cleanMessage == "OK")
            {
                return "OK";
            }
            else if (cleanMessage == sentMessage)
            {
                return "NG";
            }
        }
        return "Invalid Response";
    }

    // 연결을 중지하는 함수
    public void StopConnection()
    {
        _isConnected = false;
        _stream?.Close();
        _client?.Close();
    }
}

// 메시지 로그를 위한 클래스
public class MessageLog
{
    public string Timestamp { get; set; } // 메시지의 타임스탬프
    public string Sender { get; set; } // 발신자
    public string Receiver { get; set; } // 수신자
    public string SentMessage { get; set; } // 전송된 메시지
    public string ResponseMessage { get; set; } // 수신된 응답 메시지
}
수정된 내용:
StartReceiving 함수 추가: 서버로부터 지속적으로 메시지를 수신하기 위한 비동기 함수입니다. 연결이 끊기면 다시 연결을 시도합니다.
LogMessage 호출: 메시지를 수신할 때 LogMessage를 호출하여 로그를 기록합니다.
while (_isConnected) 루프: 서버와 연결된 상태에서 계속 수신을 시도하도록 구현되었습니다.
이제 StartReceiving() 함수가 정상적으로 동작할 것입