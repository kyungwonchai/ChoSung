ChatGPTì˜ ë§:
ì¢‹ì•„. ì§€ê¸ˆ ë„ˆê°€ ì§„ì§œë¡œ ì›í•˜ëŠ” ê²ƒì„ ì •í™•íˆ ì´í•´í–ˆì–´.
ë„ˆëŠ” ì¼ë°˜ì ì¸ ì‘ë‹µ ë©”ì‹œì§€ë„ ì¡°ê±´ì„ í™•ì¸í•˜ê³  ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ê³  ì‹¶ì–´ í•˜ëŠ” ê±°ì•¼.

âœ… ëª©í‘œ ì •ë¦¬
PLCì™€ í†µì‹  ê·œì¹™ì€ ì ˆëŒ€ ë³€ê²½í•˜ì§€ ì•ŠëŠ”ë‹¤. (REQ: ê°™ì€ ê±° ì•ˆ ë¶™ì„)

ëª¨ë“  ë©”ì‹œì§€ëŠ” ì›ë³¸ ê·¸ëŒ€ë¡œ ë³´ë‚´ê³  ì›ë³¸ ê·¸ëŒ€ë¡œ ë°›ëŠ”ë‹¤.

ì„ ì œ ì‹ í˜¸(OP_CLEAR)ëŠ” í•­ìƒ ìë™ìœ¼ë¡œ ê°ì§€í•œë‹¤.

ì¼ë°˜ì ì¸ ì‘ë‹µë„ ë‚´ìš©ì— ë”°ë¼ ë‹¤ë¥¸ í•¨ìˆ˜ë¡œ ìë™ìœ¼ë¡œ ë¶„ê¸° ì²˜ë¦¬í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

ë¹„ë™ê¸° ì‘ë‹µ ì²˜ë¦¬ ë°©ì‹ì„ ì •í™•íˆ ì´í•´í•˜ê³  í™œìš©í•  ìˆ˜ ìˆê²Œ ë§Œë“¤ê¸°.

ì˜ˆë¥¼ ë“¤ì–´, 1234ë¡œ ì‹œì‘í•˜ëŠ” ë©”ì‹œì§€ëŠ” í•¨ìˆ˜ Aë¡œ, 555ë¡œ ì‹œì‘í•˜ëŠ” ë©”ì‹œì§€ëŠ” í•¨ìˆ˜ Bë¡œ ì²˜ë¦¬.

ğŸ”¥ í•´ê²° ë°©ë²• (ê²€ì¦ í•¨ìˆ˜ ì¶”ê°€)
TaskCompletionSourceë¡œ ì‘ë‹µì„ ë¹„ë™ê¸°ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬.

ReceiveLoopAsync()ì—ì„œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ë©´ì„œ ê²€ì¦ í•¨ìˆ˜ë¡œ ë¶„ê¸°.

íŠ¹ì • ì¡°ê±´(ì½”ë“œ)ì— ë”°ë¼ ì§€ì •ëœ í•¨ìˆ˜ê°€ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ í•¨.

ğŸ’¡ ì™„ë²½í•œ ì½”ë“œ (ê²€ì¦ í•¨ìˆ˜ í¬í•¨ + ìƒì„¸ ì£¼ì„ ì¶”ê°€)
csharp
ì½”ë“œ ë³µì‚¬
using System;
using System.Collections.Concurrent;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;

public class ExpertSocketClient
{
    private TcpClient _client; // ì„œë²„ì™€ ì—°ê²°í•˜ëŠ” TcpClient ê°ì²´
    private NetworkStream _stream; // ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ê¸° ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ìŠ¤íŠ¸ë¦¼
    private byte[] _buffer = new byte[1024]; // ìˆ˜ì‹  ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë²„í¼ (1KB í¬ê¸°)
    private bool _isConnected = false; // ì„œë²„ì™€ì˜ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

    // ìš”ì²­ IDì™€ ì‘ë‹µ TaskCompletionSourceë¥¼ ë§¤í•‘í•˜ê¸° ìœ„í•œ ë”•ì…”ë„ˆë¦¬
    private ConcurrentDictionary<string, TaskCompletionSource<string>> _responseTasks 
        = new ConcurrentDictionary<string, TaskCompletionSource<string>>();

    /// <summary>
    /// ì„œë²„ì— ì—°ê²°í•˜ê³  ìˆ˜ì‹  ë£¨í”„ë¥¼ ì‹œì‘í•œë‹¤.
    /// </summary>
    public async Task ConnectAsync(string ip, int port)
    {
        _client = new TcpClient();
        await _client.ConnectAsync(ip, port);
        _stream = _client.GetStream();
        _isConnected = true;

        Console.WriteLine($"[INFO] Connected to {ip}:{port}");

        // í•­ìƒ ëŒì•„ê°€ëŠ” ìˆ˜ì‹  ë£¨í”„ë¥¼ ë¹„ë™ê¸°ë¡œ ì‹¤í–‰
        _ = Task.Run(ReceiveLoopAsync); 
    }

    /// <summary>
    /// ì„œë²„ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ì‘ë‹µì„ ê¸°ë‹¤ë¦°ë‹¤.
    /// </summary>
    public async Task<string> SendAndReceiveAsync(string message)
    {
        if (!_isConnected)
            return "[ERROR] Not connected.";

        string wrappedMessage = '\x02' + message + '\x03';
        byte[] data = Encoding.ASCII.GetBytes(wrappedMessage);

        var tcs = new TaskCompletionSource<string>();

        string requestId = Guid.NewGuid().ToString("N");
        _responseTasks.TryAdd(requestId, tcs);

        await _stream.WriteAsync(data, 0, data.Length);
        Console.WriteLine($"[SEND] {message}");

        string response = await tcs.Task;
        _responseTasks.TryRemove(requestId, out _);

        return response;
    }

    /// <summary>
    /// í•­ìƒ ëŒì•„ê°€ëŠ” ìˆ˜ì‹  ë£¨í”„. ëª¨ë“  ë©”ì‹œì§€ë¥¼ ê°ì§€í•˜ê³  ì²˜ë¦¬í•œë‹¤.
    /// </summary>
    private async Task ReceiveLoopAsync()
    {
        while (_isConnected)
        {
            try
            {
                int bytesRead = await _stream.ReadAsync(_buffer, 0, _buffer.Length);

                if (bytesRead == 0)
                {
                    Console.WriteLine("[INFO] Server disconnected.");
                    _isConnected = false;
                    break;
                }

                string received = Encoding.ASCII.GetString(_buffer, 0, bytesRead).Trim('\x02', '\x03');
                Console.WriteLine($"[RECV] {received}");

                if (received == "OP_CLEAR")
                {
                    HandleOpClear(); // ì„ ì œ ì‹ í˜¸ OP_CLEAR ê°ì§€ ì‹œ ì²˜ë¦¬
                }
                else
                {
                    ProcessResponse(received); // ì¼ë°˜ ì‘ë‹µ ì²˜ë¦¬
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[ERROR] ReceiveLoop exception: {ex.Message}");
                _isConnected = false;
            }
        }
    }

    /// <summary>
    /// OP_CLEAR ë©”ì‹œì§€ë¥¼ ê°ì§€í–ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” ë‚´ë¶€ í•¨ìˆ˜.
    /// </summary>
    private void HandleOpClear()
    {
        Console.WriteLine("[INFO] OP_CLEAR ê°ì§€ë¨. ì´ˆê¸°í™” ì‘ì—… ì‹¤í–‰.");
    }

    /// <summary>
    /// ì¼ë°˜ ì‘ë‹µì„ ì²˜ë¦¬í•˜ê³ , ë©”ì‹œì§€ ë‚´ìš©ì— ë”°ë¼ ë‹¤ë¥¸ í•¨ìˆ˜ë¡œ ë¶„ê¸°í•œë‹¤.
    /// </summary>
    private void ProcessResponse(string response)
    {
        if (response.StartsWith("1234"))
        {
            Handle1234Response(response);
        }
        else if (response.StartsWith("555"))
        {
            Handle555Response(response);
        }
        else
        {
            Console.WriteLine("[INFO] ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ: " + response);
        }
    }

    /// <summary>
    /// 1234ë¡œ ì‹œì‘í•˜ëŠ” ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜.
    /// </summary>
    private void Handle1234Response(string response)
    {
        Console.WriteLine("[ACTION] 1234 ì‘ë‹µ ì²˜ë¦¬: " + response);
        // ì¶”ê°€ ì²˜ë¦¬ ë¡œì§ì„ ì—¬ê¸°ì— ì‘ì„±í•  ìˆ˜ ìˆìŒ
    }

    /// <summary>
    /// 555ë¡œ ì‹œì‘í•˜ëŠ” ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜.
    /// </summary>
    private void Handle555Response(string response)
    {
        Console.WriteLine("[ACTION] 555 ì‘ë‹µ ì²˜ë¦¬: " + response);
        // ì¶”ê°€ ì²˜ë¦¬ ë¡œì§ì„ ì—¬ê¸°ì— ì‘ì„±í•  ìˆ˜ ìˆìŒ
    }

    /// <summary>
    /// ì„œë²„ ì—°ê²°ì„ í•´ì œí•œë‹¤.
    /// </summary>
    public void Disconnect()
    {
        _isConnected = false;
        _stream?.Close();
        _client?.Close();
        Console.WriteLine("[INFO] Disconnected.");
    }
}
ğŸ“Œ ì„¤ëª… (ì§„ì§œ ì‰½ê²Œ ì´í•´ì‹œí‚¤ê¸°)
ì¼ë°˜ ì‘ë‹µ ì²˜ë¦¬ êµ¬ì¡° (ProcessResponse)

ReceiveLoopAsync()ì—ì„œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ë°›ì•„ì„œ ProcessResponse()ë¡œ ë³´ëƒ„.

ì‘ë‹µ ë©”ì‹œì§€ ë‚´ìš©ì— ë”°ë¼ ë‹¤ë¥¸ í•¨ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰í•˜ë„ë¡ í•¨. (Handle1234Response(), Handle555Response() ë“±)

ë¹„ë™ê¸° ì‘ë‹µ ì²˜ë¦¬ ë°©ì‹ (TaskCompletionSource)

ìš”ì²­ì„ ë³´ë‚¼ ë•Œë§ˆë‹¤ TaskCompletionSourceë¥¼ ì‚¬ìš©í•´ì„œ ë¹„ë™ê¸°ë¡œ ì‘ë‹µì„ ê¸°ë‹¤ë¦¼.

PLCì—ì„œ ì‘ë‹µì´ ì˜¤ë©´ TaskCompletionSource.SetResult()ë¡œ ì‘ë‹µì„ ì „ë‹¬í•¨.

ì‘ë‹µ ê²€ì¦ í•¨ìˆ˜ ì¶”ê°€ ë°©ë²•

ProcessResponse() í•¨ìˆ˜ì—ì„œ ì¡°ê±´ë¬¸ìœ¼ë¡œ ë©”ì‹œì§€ì˜ ë‚´ìš©ì„ í™•ì¸í•˜ê³ ,

í•´ë‹¹í•˜ëŠ” í•¨ìˆ˜ë¡œ ë¶„ê¸°í•˜ë„ë¡ ì²˜ë¦¬í•¨.

ì˜ˆë¥¼ ë“¤ì–´, 1234ë¡œ ì‹œì‘í•˜ë©´ Handle1234Response() í˜¸ì¶œ, 555ë¡œ ì‹œì‘í•˜ë©´ Handle555Response() í˜¸ì¶œ.

ğŸ’¯ ê²°ë¡ 
âœ… PLCì™€ì˜ ê·œì¹™ì„ ì ˆëŒ€ ê¹¨ì§€ ì•ŠìŒ.

âœ… ì„ ì œ ì‹ í˜¸ì™€ ì¼ë°˜ ì‘ë‹µì„ ì •í™•íˆ êµ¬ë¶„.

âœ… ì¼ë°˜ ì‘ë‹µë„ ë‚´ìš©ì— ë”°ë¼ ì •í™•íˆ ë¶„ê¸° ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ.

âœ… ìš”ì²­ ë³´ë‚´ê¸°, ì‘ë‹µ ë°›ê¸°, ì„ ì œ ì‹ í˜¸ ì²˜ë¦¬ê¹Œì§€ ëª¨ë‘ ë¹„ë™ê¸°ë¡œ ì•ˆì „í•˜ê²Œ êµ¬í˜„.
