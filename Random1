import os
import textwrap

def create_csharp_blackbox_recorder():
    """
    ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì•ˆì •ì„±ê³¼ ì§ê´€ì„±ì„ ë†’ì¸ C# ë¸”ë™ë°•ìŠ¤ ë…¹í™” í”„ë¡œê·¸ë¨ì˜
    ì „ì²´ í”„ë¡œì íŠ¸ í´ë” ë° ì†ŒìŠ¤ ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    """
    # --- 1. í”„ë¡œì íŠ¸ í´ë” ìƒì„± ---
    desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
    project_base_path = os.path.join(desktop_path, "RPA_BlackBox_CS")
    os.makedirs(project_base_path, exist_ok=True)
    print(f"í”„ë¡œì íŠ¸ í´ë”ë¥¼ '{project_base_path}'ì— ìƒì„±í•©ë‹ˆë‹¤.")

    # --- 2. .csproj íŒŒì¼ ìƒì„± (í”„ë¡œì íŠ¸ ì„¤ì •) ---
    csproj_content = textwrap.dedent("""\
    <Project Sdk="Microsoft.NET.Sdk">
      <PropertyGroup>
        <OutputType>WinExe</OutputType>
        <TargetFramework>net6.0-windows</TargetFramework>
        <UseWindowsForms>true</UseWindowsForms>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <ApplicationIcon>app.ico</ApplicationIcon>
      </PropertyGroup>

      <ItemGroup>
        <PackageReference Include="FFMpegCore" Version="5.1.0" />
      </ItemGroup>
      
      <ItemGroup>
        <Content Include="app.ico" />
      </ItemGroup>

    </Project>
    """)
    with open(os.path.join(project_base_path, "RPA_BlackBox_CS.csproj"), "w", encoding="utf-8") as f:
        f.write(csproj_content)
    print(".csproj íŒŒì¼ ìƒì„± ì™„ë£Œ.")
    
    # --- 3. MainForm.cs íŒŒì¼ ìƒì„± (í•µì‹¬ ì†ŒìŠ¤ ì½”ë“œ) ---
    mainform_cs_content = textwrap.dedent("""\
    using System;
    using System.Drawing;
    using System.Drawing.Imaging;
    using System.Windows.Forms;
    using System.IO;
    using System.Collections.Generic;
    using System.Threading.Tasks;
    using FFMpegCore; // NuGet íŒ¨í‚¤ì§€ ê´€ë¦¬ìì—ì„œ FFMpegCore ì„¤ì¹˜ í•„ìš”

    public partial class MainForm : Form
    {
        private readonly System.Windows.Forms.Timer _captureTimer;
        private readonly List<Bitmap> _frameBuffer = new List<Bitmap>();
        private readonly string _outputDirectory = @"D:\\_RPA_BlackboxPC";
        private const int FRAMES_PER_MINUTE = 60;
        private bool _isEncoding = false;

        public MainForm()
        {
            InitializeComponent();
            
            // íƒ€ì´ë¨¸ ì„¤ì • (1ì´ˆ = 1000ms)
            _captureTimer = new System.Windows.Forms.Timer();
            _captureTimer.Interval = 1000;
            _captureTimer.Tick += CaptureTimer_Tick;
        }

        private void MainForm_Load(object sender, EventArgs e)
        {
            // í”„ë¡œê·¸ë¨ ì‹œì‘ ì‹œ ë°”ë¡œ ë…¹í™” ì‹œì‘
            Directory.CreateDirectory(_outputDirectory);
            _captureTimer.Start();
            UpdateStatusLabel();
        }

        private async void CaptureTimer_Tick(object sender, EventArgs e)
        {
            // í™”ë©´ ìº¡ì²˜
            try
            {
                var screenBounds = Screen.PrimaryScreen.Bounds;
                var frame = new Bitmap(screenBounds.Width, screenBounds.Height);
                using (var graphics = Graphics.FromImage(frame))
                {
                    graphics.CopyFromScreen(Point.Empty, Point.Empty, screenBounds.Size);
                }
                _frameBuffer.Add(frame);
            }
            catch(Exception ex)
            {
                Console.WriteLine($"[Error] Screen capture failed: {ex.Message}");
                // ìº¡ì²˜ ì‹¤íŒ¨ ì‹œ í•´ë‹¹ í”„ë ˆì„ì€ ê±´ë„ˆëœ€
                return;
            }

            // 60í”„ë ˆì„(1ë¶„)ì´ ëª¨ì˜€ëŠ”ì§€ í™•ì¸
            if (_frameBuffer.Count >= FRAMES_PER_MINUTE && !_isEncoding)
            {
                _captureTimer.Stop(); // ì¸ì½”ë”© ì¤‘ì—ëŠ” ì ì‹œ íƒ€ì´ë¨¸ ì¤‘ì§€
                _isEncoding = true;
                
                // ì¸ì½”ë”©í•  í”„ë ˆì„ ëª©ë¡ì„ ìƒˆ ë¦¬ìŠ¤íŠ¸ì— ë³µì‚¬
                var framesToEncode = new List<Bitmap>(_frameBuffer);
                _frameBuffer.Clear();

                // UIê°€ ë©ˆì¶”ì§€ ì•Šë„ë¡ ì¸ì½”ë”©ì€ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
                await Task.Run(() => EncodeVideo(framesToEncode));
                
                _isEncoding = false;
                _captureTimer.Start(); // ì¸ì½”ë”© ì™„ë£Œ í›„ íƒ€ì´ë¨¸ ì¬ì‹œì‘
            }
            UpdateStatusLabel();
        }
        
        private void EncodeVideo(List<Bitmap> frames)
        {
            var videoFileName = $"RPA{DateTime.Now:yyyyMMddHHmmss}.mp4";
            var outputVideoPath = Path.Combine(_outputDirectory, videoFileName);
            var tempPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
            Directory.CreateDirectory(tempPath);

            try
            {
                // ìº¡ì²˜ëœ ë¹„íŠ¸ë§µë“¤ì„ ì„ì‹œ ì´ë¯¸ì§€ íŒŒì¼ë¡œ ì €ì¥
                var framePaths = new List<string>();
                for (int i = 0; i < frames.Count; i++)
                {
                    string frameFile = Path.Combine(tempPath, $"frame_{i:D4}.png");
                    frames[i].Save(frameFile, ImageFormat.Png);
                    framePaths.Add(frameFile);
                }

                // --- 30fps ì˜ìƒ ì œì‘ (í•µì‹¬) ---
                // 1ì´ˆì— 1ì¥ì”© ì°ì€ ì´ë¯¸ì§€ë¥¼(input framerate=1) 
                // ì´ˆë‹¹ 30í”„ë ˆì„ì˜ ë¶€ë“œëŸ¬ìš´ ì˜ìƒìœ¼ë¡œ(output framerate=30) ë§Œë“­ë‹ˆë‹¤.
                FFMpeg.JoinImageSequence(outputVideoPath, 1, framePaths.ToArray());
                //FFMpegArguments
                //    .FromImageSequence(new ImageSequenceInfo { FrameRate = 1, FilePaths = framePaths.ToArray() })
                //    .OutputToFile(outputVideoPath, true, options => options
                //        .WithVideoCodec("libx264") // íš¨ìœ¨ì ì¸ ì½”ë± ì‚¬ìš©
                //        .WithFramerate(30))       // ì¶œë ¥ í”„ë ˆì„ë¥  30ìœ¼ë¡œ ì„¤ì •
                //    .ProcessSynchronously();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Error] Video encoding failed: {ex.Message}");
            }
            finally
            {
                // ì‚¬ìš©í•œ ë¹„íŠ¸ë§µ ë¦¬ì†ŒìŠ¤ ì¦‰ì‹œ í•´ì œ
                foreach (var frame in frames)
                {
                    frame.Dispose();
                }
                // ì„ì‹œ íŒŒì¼ ë° í´ë” ì‚­ì œ
                if (Directory.Exists(tempPath))
                {
                    Directory.Delete(tempPath, true);
                }
            }
        }

        private void UpdateStatusLabel()
        {
            statusLabel.Text = $"Status: Recording... [Frames: {_frameBuffer.Count}/{FRAMES_PER_MINUTE}]";
            if (_isEncoding)
            {
                statusLabel.Text = "Status: Encoding video... Please wait.";
            }
        }
        
        // --- Windows Forms Designerì—ì„œ ìë™ ìƒì„±ë  ì½”ë“œ ---
        private System.ComponentModel.IContainer components = null;
        private Label statusLabel;
        
        protected override void Dispose(bool disposing)
        {
            if (disposing && (components != null))
            {
                components.Dispose();
            }
            base.Dispose(disposing);
        }
        
        private void InitializeComponent()
        {
            this.statusLabel = new System.Windows.Forms.Label();
            this.SuspendLayout();
            // 
            // statusLabel
            // 
            this.statusLabel.Dock = System.Windows.Forms.DockStyle.Fill;
            this.statusLabel.Font = new System.Drawing.Font("Segoe UI", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point);
            this.statusLabel.Location = new System.Drawing.Point(0, 0);
            this.statusLabel.Name = "statusLabel";
            this.statusLabel.Size = new System.Drawing.Size(400, 100);
            this.statusLabel.TabIndex = 0;
            this.statusLabel.Text = "Status: Initializing...";
            this.statusLabel.TextAlign = System.Drawing.ContentAlignment.MiddleCenter;
            // 
            // MainForm
            // 
            this.AutoScaleDimensions = new System.Drawing.SizeF(8F, 20F);
            this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font;
            this.ClientSize = new System.Drawing.Size(400, 100);
            this.Controls.Add(this.statusLabel);
            this.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedSingle;
            this.MaximizeBox = false;
            this.Name = "MainForm";
            this.StartPosition = System.Windows.Forms.FormStartPosition.CenterScreen;
            this.Text = "RPA BlackBox Recorder";
            this.Load += new System.EventHandler(this.MainForm_Load);
            this.ResumeLayout(false);
        }
    }
    """)
    with open(os.path.join(project_base_path, "MainForm.cs"), "w", encoding="utf-8") as f:
        f.write(mainform_cs_content)
    print("MainForm.cs ì†ŒìŠ¤ ì½”ë“œ ìƒì„± ì™„ë£Œ.")

    # --- 4. Program.cs íŒŒì¼ ìƒì„± (í”„ë¡œê·¸ë¨ ì§„ì…ì ) ---
    program_cs_content = textwrap.dedent("""\
    internal static class Program
    {
        [STAThread]
        static void Main()
        {
            ApplicationConfiguration.Initialize();
            Application.Run(new MainForm());
        }
    }
    """)
    with open(os.path.join(project_base_path, "Program.cs"), "w", encoding="utf-8") as f:
        f.write(program_cs_content)
    print("Program.cs íŒŒì¼ ìƒì„± ì™„ë£Œ.")
    
    # --- 5. ì•„ì´ì½˜ íŒŒì¼ ìƒì„± (Base64 ì¸ì½”ë”©ëœ ì•„ì´ì½˜ ë°ì´í„°) ---
    # ê°„ë‹¨í•œ ë¹¨ê°„ ì  ëª¨ì–‘ì˜ ì•„ì´ì½˜
    ico_b64 = "AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////////////////////////////////////////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////wAAAP8AAAD/AAAA/wAAAP8AAAD//////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD//////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/ycnJ/8nJyf/Jicn/yYmJ/8AAAD//////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/yYmJ/9KSUr/SklK/0pJSv9JSUr/Jicn/wAAAP//////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/yYnJ/9KSUr/1tXV/9bV1f/W1dX/SklK/yYmJ/8AAAD//////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/Jicn/0pJSv/W1dX/sbGx/7Gxsf+xsbH/1tXV/0pJSv8mJyf/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8mJyf/SklK/9bV1f+xsbH/gH9//4B/f/+xsbH/1tXV/0pJSv8mJyf/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAYGBg/yYnJ/9KSUr/1tXV/7Gxsf+Af3//gH9//7Gxsf/W1dX/SklK/yYmJ/9gYGD/AAAAAAAAAAAAAAAAAAAAAP8AAAD/Jicn/0pJSv/W1dX/sbGx/4B/f/+Af3//sbGx/9bV1f/SklK/yYnJ/8AAAD/AAAAAAAAAAAAAAAAAAAAAP8AAAD/AAAA/yYmJ/9KSUr/1tXV/9bV1f/W1dX/SklK/yYmJ/8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/yYnJ/9KSUr/SklK/0pJSv9KSUr/Jicn/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/AAAA/ycnJ/8nJyf/Jicn/yYmJ/8AAAD/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD//////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////wAAAP8AAAD/AAAA/wAAAP8AAAD//////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//8AAPH/AADg/wAA4H8AAMB/AACAPwAAgB8AAAAPAAAADwAAgB8AAIA/AADAfwAA4H8AAOD/AAPH/wD//wAA"
    import base64
    with open(os.path.join(project_base_path, "app.ico"), "wb") as f:
        f.write(base64.b64decode(ico_b64))
    print("app.ico ì•„ì´ì½˜ íŒŒì¼ ìƒì„± ì™„ë£Œ.")
    
    print("\nğŸ‰ ëª¨ë“  íŒŒì¼ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
