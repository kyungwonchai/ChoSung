# MVVM 패턴에서 COM 포트를 가장 안전하게 해제하는 방법은 프로그램 종료 시 발생할 수 있는 모든 시나리오를 고려해 COM 포트를 닫는 것입니다. 이를 위해, IDisposable 인터페이스를 활용하고, 프로그램이 정상적으로 종료되거나 강제 종료되는 경우를 대비하여 이벤트 핸들러를 설정하는 것이 좋습니다. 다음은 이를 구현한 전문가 수준의 코드입니다:

1. ComPortClass (COM 포트 클래스)
먼저, COM 포트를 관리하는 클래스를 작성합니다. 이 클래스는 IDisposable을 구현하고, 프로그램 종료 시 자동으로 포트를 해제할 수 있도록 합니다.

csharp
코드 복사
using System;
using System.IO.Ports;

public class ComPortClass : IDisposable
{
    private SerialPort _serialPort;
    private bool _disposed = false;

    public ComPortClass(string portName, int baudRate)
    {
        // SerialPort 객체 초기화
        _serialPort = new SerialPort(portName, baudRate);
        _serialPort.Open();
    }

    // 포트 해제 메서드
    public void ClosePort()
    {
        if (_serialPort != null && _serialPort.IsOpen)
        {
            _serialPort.Close();
        }
    }

    // IDisposable 구현
    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    protected virtual void Dispose(bool disposing)
    {
        if (!_disposed)
        {
            if (disposing)
            {
                // 관리되는 리소스 해제
                ClosePort();
                _serialPort.Dispose();
            }
            // 관리되지 않는 리소스 해제

            _disposed = true;
        }
    }

    // 소멸자
    ~ComPortClass()
    {
        Dispose(false);
    }
}
2. MainViewModel에서 ComPortClass 사용
이제 MainViewModel에서 ComPortClass의 인스턴스를 생성하고, 프로그램 종료 시 해당 인스턴스를 안전하게 해제하도록 설정합니다.

csharp
코드 복사
using System;
using System.Windows;

public class MainViewModel
{
    private ComPortClass _comPort;

    public MainViewModel()
    {
        // COM 포트 인스턴스 생성
        _comPort = new ComPortClass("COM1", 9600);

        // Application 종료 이벤트 구독
        Application.Current.Exit += OnApplicationExit;
        AppDomain.CurrentDomain.ProcessExit += OnProcessExit;
    }

    // Application 종료 시 호출되는 메서드
    private void OnApplicationExit(object sender, ExitEventArgs e)
    {
        DisposeComPort();
    }

    // 강제 종료 시 호출되는 메서드
    private void OnProcessExit(object sender, EventArgs e)
    {
        DisposeComPort();
    }

    // COM 포트 인스턴스 해제 메서드
    private void DisposeComPort()
    {
        if (_comPort != null)
        {
            _comPort.Dispose();
            _comPort = null;
        }
    }
}
3. 설명
Dispose 메서드: IDisposable을 구현하여 객체가 수동으로 해제될 때와 프로그램이 종료될 때 COM 포트를 닫습니다. GC.SuppressFinalize(this)를 호출하여 가비지 컬렉터가 이미 해제된 객체를 다시 해제하지 않도록 방지합니다.
종료 이벤트 구독: Application.Current.Exit와 AppDomain.CurrentDomain.ProcessExit 이벤트를 구독하여 프로그램이 정상적으로 종료되거나 강제 종료되는 경우 모두 COM 포트를 해제할 수 있도록 합니다.