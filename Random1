from flask import Flask, request, render_template
from werkzeug.utils import secure_filename
import os
import pyodbc
from pptx import Presentation
from openpyxl import load_workbook
from io import BytesIO

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = 'uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB 제한

# MSSQL 연결 설정
conn_str = 'DRIVER={ODBC Driver 17 for SQL Server};SERVER=your_server;DATABASE=your_database;UID=your_username;PWD=your_password'
cnxn = pyodbc.connect(conn_str)
cursor = cnxn.cursor()

# 메인 페이지
@app.route('/')
def index():
    return render_template('index.html')

# BA 버튼 클릭 시 파일 선택 페이지
@app.route('/ba', methods=['GET', 'POST'])
def ba():
    if request.method == 'POST':
        file = request.files['file']
        if file:
            filename = secure_filename(file.filename)
            file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))

            # PPTX 파일인 경우
            if filename.lower().endswith('.pptx'):
                prs = Presentation(os.path.join(app.config['UPLOAD_FOLDER'], filename))
                for slide_num, slide in enumerate(prs.slides):
                    image = slide.export_as_slide().get_image()
                    image_path = os.path.join(app.config['UPLOAD_FOLDER'], f'{slide_num}.png')
                    image.save(image_path)

                    with open(image_path, 'rb') as f:
                        image_data = f.read()

                    # MSSQL DB에 이미지 저장
                    sql = "INSERT INTO your_table (제목, 번호, 이미지) VALUES (?, ?, ?)"
                    val = (filename, slide_num, image_data)
                    cursor.execute(sql, val)
                    cnxn.commit()

                # 이미지 변환 후 파일 삭제
                os.remove(os.path.join(app.config['UPLOAD_FOLDER'], filename))
                for slide_num in range(len(prs.slides)):
                    os.remove(os.path.join(app.config['UPLOAD_FOLDER'], f'{slide_num}.png'))

            # XLSX 파일인 경우
            elif filename.lower().endswith('.xlsx'):
                wb = load_workbook(os.path.join(app.config['UPLOAD_FOLDER'], filename))
                for sheet_name in wb.sheetnames:
                    sheet = wb[sheet_name]
                    image = sheet._images[0].image
                    image_data = BytesIO(image.blob)

                    # MSSQL DB에 이미지 저장
                    sql = "INSERT INTO your_table (제목, 번호, 이미지) VALUES (?, ?, ?)"
                    val = (filename, sheet.title, image_data.getvalue())
                    cursor.execute(sql, val)
                    cnxn.commit()

                # 이미지 변환 후 파일 삭제
                os.remove(os.path.join(app.config['UPLOAD_FOLDER'], filename))

            return '파일이 성공적으로 처리되었습니다.'
    
    return render_template('ba.html')

# BB 버튼 클릭 시 이미지들을 뿌려주는 페이지
@app.route('/bb')
def bb():
    # MSSQL DB에서 이미지들을 가져옴
    cursor.execute("SELECT * FROM your_table ORDER BY 번호 ASC")
    results = cursor.fetchall()
    
    return render_template('bb.html', results=results)

if __name__ == '__main__':
    app.run()
