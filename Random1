아래는 MSSQL 2014에서 LogMessages 테이블의 내용을 백업용 테이블인 LogMessages_backup으로 복사하고, 3일 이상 지난 데이터를 삭제하는 저장 프로시저 코드입니다. 테이블 생성 코드와 프로시저 코드를 함께 제공합니다.

테이블 생성 코드
sql
코드 복사
-- 원본 테이블 생성
CREATE TABLE LogMessages (
    ID INT PRIMARY KEY IDENTITY(1,1),
    Message NVARCHAR(255),
    Time1 DATETIME
);

-- 백업 테이블 생성
CREATE TABLE LogMessages_backup (
    ID INT PRIMARY KEY IDENTITY(1,1),
    Message NVARCHAR(255),
    Time1 DATETIME
);
프로시저 코드
sql
코드 복사
CREATE PROCEDURE BackupAndDeleteOldLogMessages
AS
BEGIN
    -- 현재 날짜에서 3일 전 날짜 계산
    DECLARE @ThreeDaysAgo DATETIME = DATEADD(DAY, -3, GETDATE());
    
    -- 3일 이전 데이터 백업
    INSERT INTO LogMessages_backup (Message, Time1)
    SELECT Message, Time1
    FROM LogMessages
    WHERE Time1 < @ThreeDaysAgo;

    -- 원본 테이블에서 3일 이전 데이터 삭제
    DELETE FROM LogMessages
    WHERE Time1 < @ThreeDaysAgo;

    PRINT '3일 이전 데이터가 백업 테이블로 이동되고 원본 테이블에서 삭제되었습니다.';
END;
프로시저 실행 방법
저장 프로시저를 생성한 후, 아래 명령어를 실행하여 3일 지난 데이터를 백업하고 삭제합니다.

sql
코드 복사
EXEC BackupAndDeleteOldLogMessages;
테스트 데이터 삽입 및 실행 예제
sql
코드 복사
-- 테스트 데이터 삽입
INSERT INTO LogMessages (Message, Time1)
VALUES 
('Test Message 1', DATEADD(DAY, -4, GETDATE())), -- 4일 전
('Test Message 2', DATEADD(DAY, -2, GETDATE())), -- 2일 전
('Test Message 3', GETDATE());                  -- 오늘

-- 프로시저 실행
EXEC BackupAndDeleteOldLogMessages;

-- 결과 확인
SELECT * FROM LogMessages;
SELECT * FROM LogMessages_backup;
동작 설명
백업: LogMessages 테이블에서 Time1 값이 3일 이전인 데이터를 LogMessages_backup 테이블에 복사합니다.
삭제: 백업된 데이터를 기준으로 원본 테이블에서 해당 데이터를 삭제합니다.