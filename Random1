using System;
using System.Data.SqlClient;
using System.Windows.Forms;
using DevExpress.XtraEditors;
using DevExpress.XtraGrid.Views.Grid;
using DevExpress.XtraDiagram;

public partial class MainForm : XtraForm
{
    private string g_loginid;

    public MainForm()
    {
        InitializeComponent();
    }

    private void MainForm_Load(object sender, EventArgs e)
    {
        // 데이터베이스 연결 설정
        string connectionString = "Data Source=서버주소;Initial Catalog=데이터베이스명;User ID=사용자명;Password=비밀번호;";
        SqlConnection connection = new SqlConnection(connectionString);
        connection.Open();

        // View_ProjectList 데이터를 GridControl1에 바인딩
        string selectQuery = "SELECT * FROM View_ProjectList";
        SqlDataAdapter dataAdapter = new SqlDataAdapter(selectQuery, connection);
        System.Data.DataTable dataTable = new System.Data.DataTable();
        dataAdapter.Fill(dataTable);
        gridControl1.DataSource = dataTable;

        // GridControl1의 이벤트 핸들러 등록
        gridView1.RowClick += GridView1_RowClick;
    }

    private void ButtonAdd_Click(object sender, EventArgs e)
    {
        string pname = textEdit1.Text;

        if (!string.IsNullOrEmpty(pname))
        {
            // 새 프로젝트 추가
            string insertQuery = $"INSERT INTO T1_ProjectList (Pname, Date1, loginid) VALUES ('{pname}', GETDATE(), '{g_loginid}')";
            ExecuteNonQuery(insertQuery);

            // View_ProjectList 데이터를 업데이트하여 GridControl1에 바인딩
            string selectQuery = "SELECT * FROM View_ProjectList";
            SqlDataAdapter dataAdapter = new SqlDataAdapter(selectQuery, connection);
            System.Data.DataTable dataTable = new System.Data.DataTable();
            dataAdapter.Fill(dataTable);
            gridControl1.DataSource = dataTable;
        }
    }

    private void GridView1_RowClick(object sender, RowClickEventArgs e)
    {
        GridView gridView = (GridView)sender;
        int selectedRowHandle = gridView.FocusedRowHandle;
        int id = (int)gridView.GetRowCellValue(selectedRowHandle, "ID");
        string pname = (string)gridView.GetRowCellValue(selectedRowHandle, "Pname");

        // View_ProjectDetail 데이터를 필터링하여 GridControl2에 바인딩
        string selectQuery = $"SELECT * FROM View_ProjectDetail WHERE Pname = '{pname}' AND loginid = '{g_loginid}'";
        SqlDataAdapter dataAdapter = new SqlDataAdapter(selectQuery, connection);
        System.Data.DataTable dataTable = new System.Data.DataTable();
        dataAdapter.Fill(dataTable);
        gridControl2.DataSource = dataTable;

        // GridControl2의 이벤트 핸들러 등록
        gridView2.DoubleClick += GridView2_DoubleClick;
    }

    private void GridView2_DoubleClick(object sender, EventArgs e)
    {
        GridView gridView = (GridView)sender;
        int selectedRowHandle = gridView.FocusedRowHandle;
        string diagram = (string)gridView.GetRowCellValue(selectedRowHandle, "Diagram");

        // DiagramControl1에 diagram 값을 설정하여 Diagram을 표시
        diagramControl1.LoadDocumentFromString(diagram);
    }

    private void ExecuteNonQuery(string query)
    {
        using (SqlCommand command = new SqlCommand(query, connection))
        {
            command.ExecuteNonQuery();
        }
    }
}
