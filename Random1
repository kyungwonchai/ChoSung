using System;
using System.Management;

class Program
{
    static void Main()
    {
        WqlEventQuery query = new WqlEventQuery("SELECT * FROM Win32_DeviceChangeEvent WHERE EventType = 2 OR EventType = 3");
        ManagementEventWatcher watcher = new ManagementEventWatcher(query);
        watcher.EventArrived += new EventArrivedEventHandler(DeviceChanged);

        Console.WriteLine("디바이스 상태 감지를 시작합니다. 프로그램을 종료하려면 Enter 키를 누르세요.");
        watcher.Start();
        Console.ReadLine();
        watcher.Stop();
    }

    static void DeviceChanged(object sender, EventArrivedEventArgs e)
    {
        Console.WriteLine("디바이스 상태 변경 감지됨: " + e.NewEvent["EventType"]);
        CheckDisplayDevices();
    }

    static void CheckDisplayDevices()
    {
        var searcher = new ManagementObjectSearcher("\\\\.\\ROOT\\cimv2", "SELECT * FROM Win32_PnPEntity WHERE ClassGuid = '{4d36e96e-e325-11ce-bfc1-08002be10318}'");

        foreach (ManagementObject queryObj in searcher.Get())
        {
            Console.WriteLine("Caption: {0}", queryObj["Caption"]);
            Console.WriteLine("Description: {0}", queryObj["Description"]);
            Console.WriteLine("Status: {0}", queryObj["Status"]);
        }
    }
}
