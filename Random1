구조를 정확히 반영하여, proviewer\data 경로 아래에 있는 Machine*으로 시작하는 각 폴더 내의 Stage1 폴더 안에 위치한 *.pro 파일을 검색하고, 해당 파일들을 Stage1 폴더 안의 Lane1 및 Lane2 폴더로 분리하는 코드로 수정하겠습니다.

1. XAML 코드 (MainWindow.xaml)
버튼과 DataGrid를 포함한 XAML 코드입니다. DataGrid는 파일명, 바코드, Lane 정보를 표시합니다.

xml
코드 복사
<Window x:Class="ProFileProcessor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Pro File Processor" Height="350" Width="525">
    <Grid>
        <!-- 파일 분배 결과를 표시하는 DataGrid -->
        <DataGrid x:Name="ResultDataGrid" HorizontalAlignment="Left" Height="200" Margin="10,10,0,0" VerticalAlignment="Top" Width="480" AutoGenerateColumns="False">
            <DataGrid.Columns>
                <DataGridTextColumn Header="File Name" Binding="{Binding FileName}" Width="*"/>
                <DataGridTextColumn Header="Barcode" Binding="{Binding Barcode}" Width="*"/>
                <DataGridTextColumn Header="Lane" Binding="{Binding Lane}" Width="*"/>
            </DataGrid.Columns>
        </DataGrid>
        
        <!-- 파일 분배를 시작하는 버튼 -->
        <Button Content="Distribute Files" HorizontalAlignment="Left" Margin="10,220,0,0" VerticalAlignment="Top" Width="120" Height="30" Click="OnDistributeFilesButtonClick"/>
    </Grid>
</Window>
2. MainWindow.xaml.cs
여기에서는 ObservableCollection을 사용하여 DataGrid에 파일 결과를 표시하며, 버튼 클릭 시 파일 분배 작업을 비동기적으로 실행하도록 구성합니다.

csharp
코드 복사
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using System.Windows;

namespace ProFileProcessor
{
    public partial class MainWindow : Window
    {
        public ObservableCollection<FileResult> ResultFiles { get; set; } // DataGrid에 표시할 파일 결과 리스트
        private FileDistributor _fileDistributor;

        public MainWindow()
        {
            InitializeComponent();
            ResultFiles = new ObservableCollection<FileResult>(); // 결과 리스트 초기화
            ResultDataGrid.ItemsSource = ResultFiles; // DataGrid 바인딩
            _fileDistributor = new FileDistributor(LogResult); // 파일 분배기 생성
        }

        // 버튼 클릭 시 파일 분배 작업을 비동기로 실행
        private async void OnDistributeFilesButtonClick(object sender, RoutedEventArgs e)
        {
            ResultFiles.Clear(); // 기존 결과 초기화
            await Task.Run(() => _fileDistributor.DistributeFilesAsync(ResultFiles)); // 파일 분배 비동기 실행
        }

        // 결과를 DataGrid에 추가하는 메서드
        private void LogResult(string message)
        {
            Dispatcher.Invoke(() => Console.WriteLine(message)); // 콘솔에 로그 메시지 출력 (디버깅용)
        }
    }

    // DataGrid에 표시할 파일 정보 모델 클래스
    public class FileResult
    {
        public string FileName { get; set; }
        public string Barcode { get; set; }
        public string Lane { get; set; }
    }
}
3. FileDistributor.cs
FileDistributor 클래스에서는 Machine*으로 시작하는 각 폴더의 Stage1 폴더 내에서 *.pro 파일을 검색하고, 해당 파일들을 Stage1 폴더의 Lane1 또는 Lane2로 분리하여 이동합니다.

csharp
코드 복사
using System;
using System.Collections.ObjectModel;
using System.Data.SqlClient;
using System.IO;
using System.Threading.Tasks;

namespace ProFileProcessor
{
    public class FileDistributor
    {
        private const string DataDirectory = @"C:\proviewer\data";
        private readonly Action<string> _logResult;

        public FileDistributor(Action<string> logResult)
        {
            _logResult = logResult;
        }

        public async Task DistributeFilesAsync(ObservableCollection<FileResult> resultFiles)
        {
            // "Machine"으로 시작하는 모든 폴더 가져오기
            var machineFolders = Directory.GetDirectories(DataDirectory, "Machine*");

            foreach (var machineFolder in machineFolders)
            {
                // 각 Machine 폴더 내의 Stage1 폴더에서만 .pro 파일 찾기
                var stage1Folder = Path.Combine(machineFolder, "Stage1");
                if (Directory.Exists(stage1Folder))
                {
                    var proFiles = Directory.GetFiles(stage1Folder, "*.pro");

                    foreach (var filePath in proFiles)
                    {
                        // 파일에서 Code 값을 추출
                        var codeValue = ExtractCodeValue(filePath);
                        if (codeValue != null)
                        {
                            // 데이터베이스에서 Lane 분류 조건 확인
                            var targetLane = GetTargetLaneFromDatabase(codeValue, stage1Folder);
                            if (targetLane != null)
                            {
                                // 분류된 파일 정보를 저장하고 결과 DataGrid에 추가
                                await MoveFileToLaneAsync(filePath, targetLane, codeValue, resultFiles);
                            }
                        }
                    }
                }
            }

            _logResult("All files have been processed.");
        }

        private string ExtractCodeValue(string filePath)
        {
            foreach (var line in File.ReadLines(filePath))
            {
                if (line.StartsWith("Code="))
                {
                    return line.Substring(5).Trim(); // Code= 이후 값을 추출
                }
            }
            return null;
        }

        private string GetTargetLaneFromDatabase(string code, string stage1Folder)
        {
            // 데이터베이스 연결 문자열 설정
            string connectionString = "Server=your_server_name;Database=your_database_name;User Id=your_user_id;Password=your_password;";
            string targetLane = null;

            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Open();

                // 조건에 맞는 szmodelname을 조회하는 쿼리
                string query = "SELECT TOP 1 szmodelname FROM View_SPI_barcode WHERE szbarcode LIKE @code + '%'";

                using (SqlCommand command = new SqlCommand(query, connection))
                {
                    command.Parameters.AddWithValue("@code", code);
                    var result = command.ExecuteScalar() as string;

                    // 모델명 결과에 따라 Lane 분류 결정
                    if (!string.IsNullOrEmpty(result))
                    {
                        if (result.Contains("_TM_"))
                        {
                            targetLane = Path.Combine(stage1Folder, "Lane2"); // Lane2 폴더 경로
                        }
                        else if (result.Contains("_BM_"))
                        {
                            targetLane = Path.Combine(stage1Folder, "Lane1"); // Lane1 폴더 경로
                        }
                    }
                }
            }

            return targetLane;
        }

        private async Task MoveFileToLaneAsync(string filePath, string targetLane, string barcode, ObservableCollection<FileResult> resultFiles)
        {
            if (string.IsNullOrEmpty(targetLane))
            {
                _logResult($"No target lane found for file: {filePath}");
                return;
            }

            try
            {
                // 대상 폴더가 없으면 생성
                if (!Directory.Exists(targetLane))
                {
                    Directory.CreateDirectory(targetLane);
                }

                // 파일 이동
                string fileName = Path.GetFileName(filePath);
                string targetPath = Path.Combine(targetLane, fileName);

                File.Move(filePath, targetPath);

                // DataGrid에 추가할 파일 결과 생성 및 추가
                var fileResult = new FileResult
                {
                    FileName = fileName,
                    Barcode = barcode,
                    Lane = targetLane.Contains("Lane1") ? "Lane1" : "Lane2"
                };
                resultFiles.Add(fileResult);

                _logResult($"File moved to {targetLane}: {fileName}");
            }
            catch (Exception ex)
            {
                _logResult($"Error moving file {filePath}: {ex.Message}");
            }
        }
    }
}
요약:
Machine* 폴더의 Stage1 폴더에서 .pro 파일을 검색합니다.
각 파일에서 Code= 값을 추출하고, 데이터베이스에서 szmodelname을 확인하여 조건에 따라 Lane1 또는 Lane2로 분류합니다.