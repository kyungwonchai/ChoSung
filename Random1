해! 이제 네가 말한 WITH LastestModels 구문을 기준으로 전체 쿼리를 정확하게 구성해줄게.
즉, SMD_12 라인의 2025-03-28 날짜의 데이터에서 중복 없이 model1을 추출하고,
이 모델들에 대해서만 최근 5시간 이내의 데이터를 필터링하여
ACT2_1~8, ACT2BEST_1~8의 값 중에서 0보다 큰 값만 골라
1사분위수 ~ 3사분위수(Q1~Q3) 사이 값 중 최솟값을 model1 + 컬럼별로 추출하는 쿼리다.

최종 통합 쿼리 (MSSQL 2014):
sql
코드 복사
WITH LastestModels AS (
    SELECT DISTINCT model1
    FROM dbo.ExcelData
    WHERE line1 = 'SMD_12'
      AND CAST(time1 AS DATE) = '2025-03-28'
),
ExcelFiltered AS (
    SELECT *
    FROM dbo.ExcelData E
    INNER JOIN LastestModels L ON E.model1 = L.model1
    WHERE E.time1 >= DATEADD(HOUR, -5, GETDATE())
),
Unpivoted AS (
    SELECT
        model1,
        ColName,
        Value
    FROM ExcelFiltered
    UNPIVOT (
        Value FOR ColName IN (
            ACT2_1, ACT2_2, ACT2_3, ACT2_4, ACT2_5, ACT2_6, ACT2_7, ACT2_8,
            ACT2BEST_1, ACT2BEST_2, ACT2BEST_3, ACT2BEST_4,
            ACT2BEST_5, ACT2BEST_6, ACT2BEST_7, ACT2BEST_8
        )
    ) AS Unpvt
    WHERE Value > 0
),
WithQuantiles AS (
    SELECT
        model1,
        ColName,
        Value,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q3
    FROM Unpivoted
),
FilteredByIQR AS (
    SELECT model1, ColName, Value
    FROM WithQuantiles
    WHERE Value BETWEEN Q1 AND Q3
)
SELECT
    model1,
    ColName,
    MIN(Value) AS MinValueWithoutOutliers
FROM FilteredByIQR
GROUP BY model1, ColName
ORDER BY model1, ColName;
결과 예시:
model1	ColName	MinValueWithoutOutliers
AAA123	ACT2_1	0.456
AAA123	ACT2_2	0.501
BBB456	ACT2BEST_3	0.601
...	...	...
필요하면 이 결과를 피벗 테이블처럼 model1 한 줄에 16개 컬럼이 가로로 나오게 해줄 수도 있어.
혹은 SMD_12 외 다른 라인도 같이 비교하고 싶을 때 조건 추가하는 것도 도와줄 수 있어.

말만 해줘, 바로 만들어줄게.






나의 말:
excelfilteredㅇ에 대해 model1 열이 여러번지정이되었다는데 라인8에서


ChatGPT의 말:
좋아, 그 오류는 아주 자주 나는 거야.
에러 메시지 "The column 'model1' was specified multiple times"는 ExcelFiltered CTE 안의 SELECT * 때문이야.

왜냐면 ExcelData 테이블과 LastestModels CTE 둘 다 model1 컬럼을 갖고 있어서 SELECT * 하면 중복 컬럼이 생겨버려.
해결하려면 SELECT * 대신, 명시적으로 필요한 컬럼만 지정하면 돼!

수정된 ExcelFiltered 부분:
sql
코드 복사
ExcelFiltered AS (
    SELECT
        E.time1,
        E.model1,
        E.line1,
        E.ACT2_1, E.ACT2_2, E.ACT2_3, E.ACT2_4,
        E.ACT2_5, E.ACT2_6, E.ACT2_7, E.ACT2_8,
        E.ACT2BEST_1, E.ACT2BEST_2, E.ACT2BEST_3, E.ACT2BEST_4,
        E.ACT2BEST_5, E.ACT2BEST_6, E.ACT2BEST_7, E.ACT2BEST_8
    FROM dbo.ExcelData E
    INNER JOIN LastestModels L ON E.model1 = L.model1
    WHERE E.time1 >= DATEADD(HOUR, -5, GETDATE())
),
이제 전체 쿼리에 붙이면 완벽하게 동작할 거야.
즉, SELECT * 대신 E.컬럼명으로 필요한 컬럼만 정확히 나열하면 돼.
불필요한 중복도 줄고 성능도 좋아져.