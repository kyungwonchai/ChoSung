using System;
using System.Management;
using System.Data.SqlClient;
using System.Windows.Forms;

public partial class MainForm : Form
{
    ManagementEventWatcher watcher = null;

    public MainForm()
    {
        InitializeComponent();
        StartWatching();
    }

    private void StartWatching()
    {
        WqlEventQuery query = new WqlEventQuery("SELECT * FROM Win32_DeviceChangeEvent WHERE EventType = 2 OR EventType = 3");
        watcher = new ManagementEventWatcher(query);
        watcher.EventArrived += new EventArrivedEventHandler(DeviceChanged);
        watcher.Start();
    }

    private void DeviceChanged(object sender, EventArrivedEventArgs e)
    {
        LogToDatabase(e.NewEvent["EventType"].ToString());
    }

    private void LogToDatabase(string eventType)
    {
        string connectionString = "Your Connection String Here";
        using (SqlConnection connection = new SqlConnection(connectionString))
        {
            string commandText = "INSERT INTO YourTableName (EventType, EventTime) VALUES (@eventType, @eventTime)";
            using (SqlCommand command = new SqlCommand(commandText, connection))
            {
                command.Parameters.AddWithValue("@eventType", eventType);
                command.Parameters.AddWithValue("@eventTime", DateTime.Now);

                connection.Open();
                command.ExecuteNonQuery();
            }
        }
    }

    protected override void OnFormClosing(FormClosingEventArgs e)
    {
        base.OnFormClosing(e);
        if (watcher != null)
        {
            watcher.Stop();
        }
    }
}
