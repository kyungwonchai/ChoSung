MSSQL 2014 프로시저 생성 코드
📌 특정 라인의 최근 10개 데이터를 가져와, 각 컬럼의 1 이상 값 중 최소값을 구하고 NULL 값은 0으로 변환하여 반환하는 프로시저
sql
코드 복사
CREATE PROCEDURE Get_Min_RecentData
    @라인명 NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;

    WITH RecentData AS (
        SELECT TOP 10 *
        FROM dbo.ExcelData
        WHERE 라인 = @라인명
        ORDER BY time1 DESC
    )
    SELECT 
        ISNULL(MIN(CASE WHEN BCT1_1 >= 1 THEN BCT1_1 ELSE NULL END), 0) AS BCT1_1,
        ISNULL(MIN(CASE WHEN BCT1_2 >= 1 THEN BCT1_2 ELSE NULL END), 0) AS BCT1_2,
        ISNULL(MIN(CASE WHEN BCT1_3 >= 1 THEN BCT1_3 ELSE NULL END), 0) AS BCT1_3,
        ISNULL(MIN(CASE WHEN BCT1_4 >= 1 THEN BCT1_4 ELSE NULL END), 0) AS BCT1_4,
        ISNULL(MIN(CASE WHEN BCT1_5 >= 1 THEN BCT1_5 ELSE NULL END), 0) AS BCT1_5,
        ISNULL(MIN(CASE WHEN BCT1_6 >= 1 THEN BCT1_6 ELSE NULL END), 0) AS BCT1_6,
        ISNULL(MIN(CASE WHEN BCT1_7 >= 1 THEN BCT1_7 ELSE NULL END), 0) AS BCT1_7,
        ISNULL(MIN(CASE WHEN BCT1_8 >= 1 THEN BCT1_8 ELSE NULL END), 0) AS BCT1_8,

        ISNULL(MIN(CASE WHEN BCT2_1 >= 1 THEN BCT2_1 ELSE NULL END), 0) AS BCT2_1,
        ISNULL(MIN(CASE WHEN BCT2_2 >= 1 THEN BCT2_2 ELSE NULL END), 0) AS BCT2_2,
        ISNULL(MIN(CASE WHEN BCT2_3 >= 1 THEN BCT2_3 ELSE NULL END), 0) AS BCT2_3,
        ISNULL(MIN(CASE WHEN BCT2_4 >= 1 THEN BCT2_4 ELSE NULL END), 0) AS BCT2_4,
        ISNULL(MIN(CASE WHEN BCT2_5 >= 1 THEN BCT2_5 ELSE NULL END), 0) AS BCT2_5,
        ISNULL(MIN(CASE WHEN BCT2_6 >= 1 THEN BCT2_6 ELSE NULL END), 0) AS BCT2_6,
        ISNULL(MIN(CASE WHEN BCT2_7 >= 1 THEN BCT2_7 ELSE NULL END), 0) AS BCT2_7,
        ISNULL(MIN(CASE WHEN BCT2_8 >= 1 THEN BCT2_8 ELSE NULL END), 0) AS BCT2_8,

        ISNULL(MIN(CASE WHEN TCT1_1 >= 1 THEN TCT1_1 ELSE NULL END), 0) AS TCT1_1,
        ISNULL(MIN(CASE WHEN TCT1_2 >= 1 THEN TCT1_2 ELSE NULL END), 0) AS TCT1_2,
        ISNULL(MIN(CASE WHEN TCT1_3 >= 1 THEN TCT1_3 ELSE NULL END), 0) AS TCT1_3,
        ISNULL(MIN(CASE WHEN TCT1_4 >= 1 THEN TCT1_4 ELSE NULL END), 0) AS TCT1_4,
        ISNULL(MIN(CASE WHEN TCT1_5 >= 1 THEN TCT1_5 ELSE NULL END), 0) AS TCT1_5,
        ISNULL(MIN(CASE WHEN TCT1_6 >= 1 THEN TCT1_6 ELSE NULL END), 0) AS TCT1_6,
        ISNULL(MIN(CASE WHEN TCT1_7 >= 1 THEN TCT1_7 ELSE NULL END), 0) AS TCT1_7,
        ISNULL(MIN(CASE WHEN TCT1_8 >= 1 THEN TCT1_8 ELSE NULL END), 0) AS TCT1_8,

        ISNULL(MIN(CASE WHEN TCT2_1 >= 1 THEN TCT2_1 ELSE NULL END), 0) AS TCT2_1,
        ISNULL(MIN(CASE WHEN TCT2_2 >= 1 THEN TCT2_2 ELSE NULL END), 0) AS TCT2_2,
        ISNULL(MIN(CASE WHEN TCT2_3 >= 1 THEN TCT2_3 ELSE NULL END), 0) AS TCT2_3,
        ISNULL(MIN(CASE WHEN TCT2_4 >= 1 THEN TCT2_4 ELSE NULL END), 0) AS TCT2_4,
        ISNULL(MIN(CASE WHEN TCT2_5 >= 1 THEN TCT2_5 ELSE NULL END), 0) AS TCT2_5,
        ISNULL(MIN(CASE WHEN TCT2_6 >= 1 THEN TCT2_6 ELSE NULL END), 0) AS TCT2_6,
        ISNULL(MIN(CASE WHEN TCT2_7 >= 1 THEN TCT2_7 ELSE NULL END), 0) AS TCT2_7,
        ISNULL(MIN(CASE WHEN TCT2_8 >= 1 THEN TCT2_8 ELSE NULL END), 0) AS TCT2_8

    FROM RecentData;
END;
✅ 프로시저 실행 방법
📌 특정 라인의 데이터 조회
sql
코드 복사
EXEC Get_Min_RecentData @라인명 = 'L1';
'L1' 부분에 원하는 라인 값을 입력하면 해당 라인의 최근 10개 데이터에서 최소값을 가져옴.
NULL 값은 0으로 변환됨.
✅ VBA에서 프로시저 실행 (MS Access)
vba
코드 복사
Sub ExecuteStoredProcedure(LineName As String)
    Dim conn As Object
    Dim rs As Object
    Dim sqlQuery As String
    Dim dbPath As String

    ' 데이터베이스 경로 (MSSQL 연결 설정)
    dbPath = "Provider=SQLOLEDB;Data Source=서버이름;Initial Catalog=DB이름;User ID=사용자이름;Password=비밀번호;"

    ' MSSQL 연결
    Set conn = CreateObject("ADODB.Connection")
    conn.Open dbPath

    ' 프로시저 실행 쿼리
    sqlQuery = "EXEC Get_Min_RecentData @라인명 = '" & LineName & "'"

    ' Recordset 열기
    Set rs = conn.Execute(sqlQuery)

    ' 결과 출력
    If Not rs.EOF Then
        Debug.Print "=== 최소값 결과 (라인: " & LineName & ") ==="
        Dim i As Integer
        For i = 0 To rs.Fields.Count - 1
            Debug.Print rs.Fields(i).Name & ": " & rs.Fields(i).Value
        Next i
    Else
        Debug.Print "데이터 없음 (라인: " & LineName & ")"
    End If

    ' 종료
    rs.Close
    conn.Close
    Set rs = Nothing
    Set conn = Nothing
End Sub
✅ VBA에서 실행 예시
vba
코드 복사
ExecuteStoredProcedure "L1"
📌 Immediate Window 출력 예시 (Ctrl + G)
makefile
코드 복사
=== 최소값 결과 (라인: L1) ===
BCT1_1: 8
BCT1_2: 3
BCT1_3: 6
BCT1_4: 7
...