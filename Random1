using DevExpress.XtraEditors;
using DevExpress.XtraGrid;
using DevExpress.XtraGrid.Views.Grid;
using DevExpress.XtraPrinting;
using DevExpress.XtraPrinting.Export;
using DevExpress.XtraPrinting.Export.Xlsx;
using System;
using System.Drawing;
using System.IO;
using System.Windows.Forms;

namespace WinFormsApp
{
    public partial class MainForm : XtraForm
    {
        private GridControl gridControl;
        private GridView gridView;
        private SimpleButton exportButton;

        public MainForm()
        {
            InitializeComponent();
        }

        private void MainForm_Load(object sender, EventArgs e)
        {
            // GridControl과 GridView 초기화
            gridControl = new GridControl();
            gridView = new GridView(gridControl);
            gridControl.MainView = gridView;
            gridControl.ViewCollection.Add(gridView);
            gridView.GridControl = gridControl;

            // 데이터 및 이미지를 포함한 예시 데이터 설정
            gridView.Columns.AddVisible("Name");
            gridView.Columns.AddVisible("Age");
            gridView.Columns.AddVisible("Image", typeof(Image));
            gridView.AddNewRow();
            gridView.SetRowCellValue(0, "Name", "John Doe");
            gridView.SetRowCellValue(0, "Age", 30);
            gridView.SetRowCellValue(0, "Image", Image.FromFile("image.jpg"));

            // Export 버튼 초기화
            exportButton = new SimpleButton();
            exportButton.Text = "Export to Excel";
            exportButton.Click += ExportButton_Click;

            // 컨트롤 배치
            LayoutControls();
        }

        private void LayoutControls()
        {
            // GridControl과 Export 버튼을 FlowLayoutPanel에 추가
            FlowLayoutPanel panel = new FlowLayoutPanel();
            panel.Dock = DockStyle.Fill;
            panel.Controls.Add(gridControl);
            panel.Controls.Add(exportButton);

            // FlowLayoutPanel을 MainForm에 추가
            Controls.Add(panel);
        }

        private void ExportButton_Click(object sender, EventArgs e)
        {
            // 저장할 Excel 파일 경로 선택
            SaveFileDialog saveFileDialog = new SaveFileDialog();
            saveFileDialog.Filter = "Excel files|*.xlsx";
            if (saveFileDialog.ShowDialog() == DialogResult.OK)
            {
                // Export 옵션 설정
                XlsxExportOptionsEx options = new XlsxExportOptionsEx();
                options.ExportType = ExportType.WYSIWYG;
                options.ShowGridLines = true;

                // 데이터와 이미지를 포함한 Excel 내보내기
                using (FileStream stream = new FileStream(saveFileDialog.FileName, FileMode.Create))
                {
                    gridView.ExportToXlsx(stream, options);
                }

                // 완료 메시지 표시
                XtraMessageBox.Show("Export completed!", "Export", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }
    }
}
