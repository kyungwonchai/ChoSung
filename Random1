using System;
using System.Data;
using System.Net.NetworkInformation;
using System.Threading.Tasks;
using System.Windows.Forms;

public partial class MainForm : Form
{
    DataTable dataTable;

    public MainForm()
    {
        InitializeComponent();
        
        // 테스트를 위한 DataTable 생성
        dataTable = new DataTable();
        dataTable.Columns.Add("IPAddress", typeof(string));
        dataTable.Columns.Add("Conn", typeof(int));
        
        // 40개의 IP 주소를 DataTable에 추가
        for (int i = 0; i < 40; i++)
        {
            dataTable.Rows.Add($"192.168.1.{i}", 0);
        }
    }

    private async void btnPing_Click(object sender, EventArgs e)
    {
        await RunPingTest(dataTable);
    }

    private async Task RunPingTest(DataTable dt)
    {
        var tasks = new Task[dt.Rows.Count];

        for (int i = 0; i < dt.Rows.Count; i++)
        {
            var index = i;  // 클로저 때문에 별도의 변수를 만들어줍니다.
            tasks[i] = Task.Run(() => DoPing(dt.Rows[index]));
        }

        await Task.WhenAll(tasks);
    }

    private void DoPing(DataRow row)
    {
        string ipAddress = row["IPAddress"].ToString();
        
        using (var ping = new Ping())
        {
            var reply = ping.Send(ipAddress);

            if (reply.Status == IPStatus.Success)
            {
                this.Invoke((Action)(() => 
                {
                    row["Conn"] = 1;
                }));
            }
            else
            {
                this.Invoke((Action)(() => 
                {
                    row["Conn"] = 0;
                }));
            }
        }
    }
}
