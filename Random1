아래는 요청하신 내용을 반영한 수정된 VBA 코드입니다. 코드는 두 번째 루프에서 병합된 C와 D 셀을 처리하고, )와 (를 변환하여 분리된 키를 생성한 뒤, 딕셔너리에서 해당 키의 값을 합산하여 F~K 열에 채워줍니다.

코드
vba
코드 복사
Sub ProcessAndFillMergedCellsWithSplit()
    Dim lastRow As Long
    Dim currentRow As Long
    Dim dict As Object
    Dim t1 As String
    Dim b4Color As Long
    Dim prevCValue As String
    Dim mergeCValue As String
    Dim totalArr(0 To 5) As Double
    Dim partKeys() As String
    Dim baseKey As String
    Dim splitKey As String
    Dim dictKey As Variant
    Dim col As Integer

    ' 딕셔너리 생성
    Set dict = CreateObject("Scripting.Dictionary")

    ' C3부터 B100000의 마지막 행까지 확인
    lastRow = 주차2_시트.Cells(주차2_시트.Rows.Count, "B").End(xlUp).Row

    ' 초기값 설정
    t1 = ""
    prevCValue = ""

    ' B4의 배경색 가져오기
    b4Color = 주차2_시트.Range("B4").Interior.Color

    ' 첫 번째 루프: 딕셔너리 생성
    For currentRow = 3 To lastRow
        Dim cValue As String
        Dim dValue As String

        cValue = Trim(주차2_시트.Cells(currentRow, "C").Value)
        dValue = Trim(주차2_시트.Cells(currentRow, "D").Value)

        ' C열 값이 빈 값이 아니면 t1 업데이트
        If cValue <> "" Then
            t1 = cValue
        End If

        ' D열에서 키 추출
        Dim key As String
        key = GetKey(dValue)

        ' t1과 키를 묶어서 새로운 키 생성
        If t1 <> "" And key <> "" Then
            Dim combinedKey As String
            combinedKey = t1 & "_" & key

            ' 딕셔너리에 키가 없으면 초기화
            If Not dict.exists(combinedKey) Then
                dict(combinedKey) = Array(0, 0, 0, 0, 0, 0) ' F~K 열 초기값
            End If

            ' 딕셔너리에서 배열 복사
            Dim tempArr As Variant
            tempArr = dict(combinedKey)

            ' F~K 열 값을 배열에 합산
            For col = 1 To 6
                tempArr(col - 1) = tempArr(col - 1) + Val(주차2_시트.Cells(currentRow, 6 + col).Value)
            Next col

            ' 수정된 배열을 다시 딕셔너리에 저장
            dict(combinedKey) = tempArr
        End If
    Next currentRow

    ' 두 번째 루프: 병합된 셀 처리 및 F~K 열 채우기
    For currentRow = 3 To lastRow
        ' 병합된 C열 처리
        If 주차2_시트.Cells(currentRow, "C").MergeCells Then
            mergeCValue = Trim(주차2_시트.Cells(currentRow, "C").Value)

            ' C열 배경색이 B4와 같은 경우
            If 주차2_시트.Cells(currentRow, "C").Interior.Color = b4Color Then
                ' 병합된 C열 값 변환: )를 빈 값으로, (를 /로 변경 후 분리
                mergeCValue = Replace(mergeCValue, ")", "")
                mergeCValue = Replace(mergeCValue, "(", "/")
                partKeys = Split(mergeCValue, "/")

                ' 이전 C열 값과 결합하여 키 생성 및 합산
                If prevCValue <> "" Then
                    For Each splitKey In partKeys
                        splitKey = Trim(splitKey)
                        baseKey = prevCValue & "_" & splitKey

                        ' 딕셔너리의 모든 키를 순회하며 포함 여부 확인
                        For Each dictKey In dict.Keys
                            If dictKey = baseKey Then
                                ' 포함된 키의 값을 합산
                                For col = 0 To 5
                                    totalArr(col) = totalArr(col) + dict(dictKey)(col)
                                Next col
                            End If
                        Next dictKey
                    Next splitKey

                    ' 결과를 F~K 열에 채우기
                    For col = 0 To 5
                        주차2_시트.Cells(currentRow, 6 + col).Value = totalArr(col)
                    Next col

                    ' 합산 배열 초기화
                    For col = 0 To 5
                        totalArr(col) = 0
                    Next col
                End If
            End If
        Else
            ' 병합되지 않은 경우 이전 C값 업데이트
            If Trim(주차2_시트.Cells(currentRow, "C").Value) <> "" Then
                prevCValue = Trim(주차2_시트.Cells(currentRow, "C").Value)
            End If
        End If
    Next currentRow

    MsgBox "작업 완료!", vbInformation
End Sub

' 키를 추출하는 함수
Function GetKey(value As String) As String
    Dim i As Long
    Dim char As String
    Dim keyStart As Long
    Dim keyEnd As Long

    keyStart = 0
    keyEnd = InStr(1, value, "/") - 1 ' / 위치 전까지

    If keyEnd > 0 Then
        For i = keyEnd To 1 Step -1
            char = Mid(value, i, 1)
            ' 첫 번째 영어 문자를 발견한 위치
            If char Like "[A-Za-z]" Then
                keyStart = i
                Exit For
            End If
        Next i
    End If

    ' 키 추출
    If keyStart > 0 And keyEnd > 0 Then
        GetKey = Mid(value, keyStart, keyEnd - keyStart + 1)
    Else
        GetKey = "" ' 키가 없으면 빈 문자열 반환
    End If
End Function
주요 구현 내용
C와 D 병합된 셀 처리:

병합된 셀에서 C열 값이 B4 배경색과 같으면 처리.
)를 제거하고 (를 /로 변경하여 키를 생성.
/로 분리된 키 생성:

Split을 사용해 /로 분리된 키를 각각 처리.
이전 C열 값(prevCValue)와 결합하여 딕셔너리 키를 생성.
딕셔너리 값 합산:

생성된 키를 기반으로 딕셔너리를 순회하며 값 합산.
포함된 값을 totalArr에 저장 후 F~K 열에 출력.
루프 초기화:

totalArr 배열은 합산 후 초기화하여 다음 순회를 준비.
사용 방법
코드 삽입:

Excel VBA 편집기에서 새 모듈을 추가하고 코드를 붙여넣습니다.
매크로 실행:

매크로를 실행하여 작업을 수행합니다.
결과 확인:
