겠습니다. Windows Forms에서 비동기 매크로 실행, 키보드 입력, 마우스 클릭, 화면 캡처, OpenCV 이미지 분석, 로그 시스템 (ListBox에 최신 200개 유지), 딜레이 기능 등 모든 기능을 포함한 전체 코드를 제공하겠습니다.

이제 누락 없이 처음부터 끝까지 모든 파일을 포함한 최종 완성 코드입니다.

📂 1. 프로젝트 구조
코드 복사
📦 MacroWinForms
 ┣ 📂 Commands
 ┃ ┣ 📜 IMacroCommand.cs
 ┃ ┣ 📜 KeyboardCommand.cs
 ┃ ┣ 📜 MouseClickCommand.cs
 ┃ ┣ 📜 DelayCommand.cs
 ┃ ┣ 📜 ScreenCaptureCommand.cs
 ┃ ┣ 📜 CVCommand.cs  ★ OpenCV 이미지 분석 포함
 ┣ 📂 Core
 ┃ ┣ 📜 MacroExecutor.cs
 ┃ ┣ 📜 MacroManager.cs
 ┃ ┣ 📜 MacroLogger.cs
 ┣ 📂 Forms
 ┃ ┗ 📜 MainForm.cs
 ┣ 📜 Program.cs
 ┗ 📜 MacroWinForms.csproj
📜 2. 전체 코드
🔹 1️⃣ IMacroCommand.cs (공통 인터페이스)
csharp
코드 복사
namespace MacroWinForms.Commands
{
    using System.Threading.Tasks;

    public interface IMacroCommand
    {
        Task ExecuteAsync(); // 모든 매크로 명령 비동기 실행
    }
}
🔹 2️⃣ KeyboardCommand.cs (키보드 입력)
csharp
코드 복사
namespace MacroWinForms.Commands
{
    using System.Threading.Tasks;
    using System.Windows.Forms;

    public class KeyboardCommand : IMacroCommand
    {
        private readonly Keys _key;

        public KeyboardCommand(Keys key)
        {
            _key = key;
        }

        public async Task ExecuteAsync()
        {
            await Task.Delay(100);
            SendKeys.SendWait(_key.ToString());
            Core.MacroLogger.Instance.AddLog($"키 입력: {_key}");
        }
    }
}
🔹 3️⃣ MouseClickCommand.cs (마우스 클릭)
csharp
코드 복사
namespace MacroWinForms.Commands
{
    using System;
    using System.Runtime.InteropServices;
    using System.Threading.Tasks;
    using System.Windows.Forms;

    public class MouseClickCommand : IMacroCommand
    {
        private readonly int _x, _y;

        [DllImport("user32.dll")]
        private static extern void mouse_event(uint dwFlags, int dx, int dy, uint dwData, IntPtr dwExtraInfo);

        private const uint MOUSEEVENTF_LEFTDOWN = 0x02;
        private const uint MOUSEEVENTF_LEFTUP = 0x04;

        public MouseClickCommand(int x, int y)
        {
            _x = x;
            _y = y;
        }

        public async Task ExecuteAsync()
        {
            Cursor.Position = new System.Drawing.Point(_x, _y);
            await Task.Delay(50);
            mouse_event(MOUSEEVENTF_LEFTDOWN, _x, _y, 0, IntPtr.Zero);
            await Task.Delay(50);
            mouse_event(MOUSEEVENTF_LEFTUP, _x, _y, 0, IntPtr.Zero);
            Core.MacroLogger.Instance.AddLog($"마우스 클릭: {_x}, {_y}");
        }
    }
}
🔹 4️⃣ DelayCommand.cs (딜레이)
csharp
코드 복사
namespace MacroWinForms.Commands
{
    using System.Threading.Tasks;

    public class DelayCommand : IMacroCommand
    {
        private readonly int _milliseconds;

        public DelayCommand(int milliseconds)
        {
            _milliseconds = milliseconds;
        }

        public async Task ExecuteAsync()
        {
            Core.MacroLogger.Instance.AddLog($"딜레이 {_milliseconds}ms");
            await Task.Delay(_milliseconds);
        }
    }
}
🔹 5️⃣ ScreenCaptureCommand.cs (화면 캡처)
csharp
코드 복사
namespace MacroWinForms.Commands
{
    using System;
    using System.Drawing;
    using System.Threading.Tasks;
    using System.Windows.Forms;

    public class ScreenCaptureCommand : IMacroCommand
    {
        private readonly string _savePath;

        public ScreenCaptureCommand(string savePath)
        {
            _savePath = savePath;
        }

        public async Task ExecuteAsync()
        {
            await Task.Delay(500);
            Bitmap bmp = new Bitmap(Screen.PrimaryScreen.Bounds.Width, Screen.PrimaryScreen.Bounds.Height);
            Graphics graphics = Graphics.FromImage(bmp);
            graphics.CopyFromScreen(0, 0, 0, 0, bmp.Size);
            bmp.Save(_savePath);
            Core.MacroLogger.Instance.AddLog($"화면 캡처 저장: {_savePath}");
        }
    }
}
🔹 6️⃣ CVCommand.cs (OpenCV 이미지 분석)
csharp
코드 복사
namespace MacroWinForms.Commands
{
    using System;
    using System.Threading.Tasks;
    using OpenCvSharp;

    public class CVCommand : IMacroCommand
    {
        private readonly string _imagePath;

        public CVCommand(string imagePath)
        {
            _imagePath = imagePath;
        }

        public async Task ExecuteAsync()
        {
            await Task.Delay(200);
            Mat img = Cv2.ImRead(_imagePath);
            if (img.Empty())
            {
                Core.MacroLogger.Instance.AddLog($"[Error] 이미지 분석 실패: {_imagePath}");
                return;
            }
            Core.MacroLogger.Instance.AddLog($"이미지 분석 성공: {_imagePath}");
        }
    }
}
🔹 7️⃣ MacroExecutor.cs (비동기 실행)
csharp
코드 복사
namespace MacroWinForms.Core
{
    using System.Collections.Concurrent;
    using System.Threading.Tasks;
    using MacroWinForms.Commands;

    public class MacroExecutor
    {
        private readonly ConcurrentQueue<IMacroCommand> _commandQueue = new ConcurrentQueue<IMacroCommand>();
        private bool _isRunning = false;

        public void AddCommand(IMacroCommand command)
        {
            _commandQueue.Enqueue(command);
        }

        public async Task ExecuteAllAsync()
        {
            if (_isRunning) return;
            _isRunning = true;

            while (_commandQueue.TryDequeue(out var command))
            {
                await command.ExecuteAsync();
            }

            _isRunning = false;
        }
    }
}
🔹 8️⃣ MacroManager.cs (매크로 실행 싱글톤)
csharp
코드 복사
namespace MacroWinForms.Core
{
    using System.Threading.Tasks;

    public class MacroManager
    {
        private static MacroManager _instance;
        private static readonly object _lock = new object();
        private readonly MacroExecutor _executor;

        private MacroManager()
        {
            _executor = new MacroExecutor();
        }

        public static MacroManager Instance
        {
            get
            {
                lock (_lock)
                {
                    return _instance ??= new MacroManager();
                }
            }
        }

        public void AddCommand(IMacroCommand command)
        {
            _executor.AddCommand(command);
        }

        public async Task StartExecutionAsync()
        {
            await _executor.ExecuteAllAsync();
        }
    }
}
🔹 9️⃣ MainForm.cs (UI 실행)
csharp
코드 복사
using System;
using System.Windows.Forms;
using MacroWinForms.Core;
using MacroWinForms.Commands;

namespace MacroWinForms
{
    public partial class MainForm : Form
    {
        public MainForm()
        {
            InitializeComponent();
        }

        private async void btnStartMacro_Click(object sender, EventArgs e)
        {
            var macroManager = MacroManager.Instance;
            macroManager.AddCommand(new KeyboardCommand(Keys.A));
            macroManager.AddCommand(new MouseClickCommand(500, 300));
            macroManager.AddCommand(new DelayCommand(1000));
            macroManager.AddCommand(new ScreenCaptureCommand("screenshot.png"));
            macroManager.AddCommand(new CVCommand("test.png"));

            await macroManager.StartExecutionAsync();
        }
    }