// FILE_ID: ViewModels/PasswordChangeViewModel_20250410141500
using LockerManagementApp.Data;
using LockerManagementApp.Infrastructure;
using LockerManagementApp.Models;
using System;
using System.Data.Entity;
using System.Diagnostics;
using System.Linq;
using System.Runtime.InteropServices;
using System.Security;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;

namespace LockerManagementApp.ViewModels
{
    public class PasswordChangeViewModel : ViewModelBase, IDisposable
    {
        private readonly LockerDbContext _context;
        private bool _disposed = false;

        private SecureString _currentPassword;
        private SecureString _newPassword;
        private SecureString _confirmPassword;
        private string _statusMessage;

        public SecureString CurrentPassword { get => _currentPassword; set { if(SetProperty(ref _currentPassword, value)) RaiseCanExecuteChanged(); } }
        public SecureString NewPassword { get => _newPassword; set { if(SetProperty(ref _newPassword, value)) RaiseCanExecuteChanged(); } }
        public SecureString ConfirmPassword { get => _confirmPassword; set { if(SetProperty(ref _confirmPassword, value)) RaiseCanExecuteChanged(); } }
        public string StatusMessage { get => _statusMessage; set => SetProperty(ref _statusMessage, value); }

        public ICommand ChangeMasterKeyCommand { get; }
        public ICommand ChangeNormalKeyCommand { get; }

        public event EventHandler RequestClose;
        public bool PasswordChangeSuccess { get; private set; } = false;


        public PasswordChangeViewModel()
        {
            try { _context = new LockerDbContext(); }
            catch (Exception ex) { if (!App.IsShuttingDown) MessageBox.Show($"[PasswordChange] DB 컨텍스트 생성 오류:\n{ex.ToString()}", "초기화 오류", MessageBoxButton.OK, MessageBoxImage.Error); else Debug.WriteLine($"종료 중 [PasswordChange] DB 컨텍스트 생성 오류 무시됨: {ex.Message}"); StatusMessage = "DB 연결 오류!"; ChangeMasterKeyCommand = new RelayCommand(_ => { }, _ => false); ChangeNormalKeyCommand = new RelayCommand(_ => { }, _ => false); return; }

            ChangeMasterKeyCommand = new RelayCommand(async _ => await ChangePasswordAsync("MasterKey"), CanChangePasswordExecute);
            ChangeNormalKeyCommand = new RelayCommand(async _ => await ChangePasswordAsync("NormalKey"), CanChangePasswordExecute);
        }

        private bool CanChangePasswordExecute(object parameter)
        {
            return !_disposed &&
                   CurrentPassword != null && CurrentPassword.Length > 0 &&
                   NewPassword != null && NewPassword.Length > 0 &&
                   ConfirmPassword != null && ConfirmPassword.Length > 0;
        }

        private async Task ChangePasswordAsync(string keyToChange)
        {
            if (!CanChangePasswordExecute(null)) return;

            string currentPlainText = ConvertToUnsecureString(CurrentPassword);
            string newPlainText = ConvertToUnsecureString(NewPassword);
            string confirmPlainText = ConvertToUnsecureString(ConfirmPassword);

            if (string.IsNullOrEmpty(currentPlainText) || string.IsNullOrEmpty(newPlainText) || string.IsNullOrEmpty(confirmPlainText))
            {
                StatusMessage = "현재 비밀번호, 새 비밀번호, 확인 비밀번호를 모두 입력하세요.";
                MessageBox.Show(StatusMessage, "입력 오류", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (newPlainText != confirmPlainText)
            {
                StatusMessage = "새 비밀번호와 확인 비밀번호가 일치하지 않습니다.";
                MessageBox.Show(StatusMessage, "입력 오류", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            // *** 신규: 비밀번호 규칙 검사 ***
            bool isValid = false;
            string ruleMessage = "";

            if (keyToChange == "NormalKey")
            {
                isValid = newPlainText.Length >= 4 && newPlainText.Any(char.IsLetter);
                ruleMessage = "일반 키는 4자리 이상이어야 하며, 반드시 영문자를 포함해야 합니다.";
            }
            else if (keyToChange == "MasterKey")
            {
                isValid = newPlainText.Length >= 5 && newPlainText.Any(char.IsLetter) && newPlainText.Any(char.IsDigit);
                ruleMessage = "마스터 키는 5자리 이상이어야 하며, 영문자와 숫자를 모두 포함해야 합니다.";
            }

            if (!isValid)
            {
                StatusMessage = ruleMessage;
                MessageBox.Show(StatusMessage, "비밀번호 규칙 오류", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }
            // --- 비밀번호 규칙 검사 끝 ---


            StatusMessage = $"{keyToChange} 변경 중...";
            PasswordChangeSuccess = false;
            try
            {
                var setting = await _context.AppSettings.FindAsync(keyToChange);
                if (setting == null)
                {
                    StatusMessage = $"설정 오류: 데이터베이스에서 '{keyToChange}' 설정을 찾을 수 없습니다.";
                    MessageBox.Show(StatusMessage, "오류", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }

                if (setting.SettingValue != currentPlainText)
                {
                    StatusMessage = "현재 비밀번호가 일치하지 않습니다.";
                    MessageBox.Show(StatusMessage, "인증 오류", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                setting.SettingValue = newPlainText;
                _context.Entry(setting).State = EntityState.Modified;
                int result = await _context.SaveChangesAsync();

                if (result > 0)
                {
                    StatusMessage = $"{keyToChange} 비밀번호가 성공적으로 변경되었습니다.";
                    MessageBox.Show(StatusMessage, "변경 완료", MessageBoxButton.OK, MessageBoxImage.Information);
                    PasswordChangeSuccess = true;
                    RequestClose?.Invoke(this, EventArgs.Empty);
                }
                else
                {
                    StatusMessage = $"{keyToChange} 비밀번호 변경 중 오류가 발생했습니다 (DB 반영 실패).";
                    MessageBox.Show(StatusMessage, "변경 실패", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (Exception ex)
            {
                StatusMessage = $"{keyToChange} 비밀번호 변경 중 오류 발생: {ex.Message}";
                if (!App.IsShuttingDown && !_disposed) MessageBox.Show($"{StatusMessage}\n\n{ex.ToString()}", "오류", MessageBoxButton.OK, MessageBoxImage.Error);
                else Debug.WriteLine($"종료 중 비밀번호 변경 오류 무시됨: {ex.ToString()}");
            }
            finally
            {
                RaiseCanExecuteChanged();
            }
        }

        private void RaiseCanExecuteChanged()
        {
             (ChangeMasterKeyCommand as RelayCommand)?.RaiseCanExecuteChanged();
             (ChangeNormalKeyCommand as RelayCommand)?.RaiseCanExecuteChanged();
        }

        private string ConvertToUnsecureString(SecureString securePassword)
        {
            if (securePassword == null) return string.Empty;
            IntPtr ptr = IntPtr.Zero;
            try { ptr = Marshal.SecureStringToGlobalAllocUnicode(securePassword); return Marshal.PtrToStringUni(ptr); }
            finally { Marshal.ZeroFreeGlobalAllocUnicode(ptr); }
        }

        #region IDisposable 구현
        protected virtual void Dispose(bool disposing) { if (!_disposed) { _disposed = true; if (disposing) { Debug.WriteLine("PasswordChangeViewModel Dispose 시작..."); try { _context?.Dispose(); } catch (Exception ex) { Debug.WriteLine($"!!! PasswordChangeViewModel DbContext Dispose 오류: {ex.Message}"); } Debug.WriteLine("PasswordChangeViewModel 리소스 해제 완료."); } } }
        public void Dispose() { Dispose(true); GC.SuppressFinalize(this); }
        #endregion
    }
}
```

**핵심 변경 사항:**

* **`ChangePasswordAsync` 메서드:**
    * 새 비밀번호와 확인 비밀번호가 일치하는지 검사한 후, `keyToChange` 값("MasterKey" 또는 "NormalKey")에 따라 새로운 비밀번호(`newPlainText`)가 규칙에 맞는지 검사하는 로직을 추가했습니다.
    * LINQ의 `Any()`와 `char.IsLetter`, `char.IsDigit`를 사용하여 조건을 확인합니다.
    * 규칙에 맞지 않으면 `StatusMessage`를 설정하고 `MessageBox`로 알린 후 저장을 중단합니다.