using System;
using System.Timers;
using ScreenRecorderLib;

namespace ScreenRecorderExample
{
    class Program
    {
        static Recorder _recorder;
        static Timer _timer;
        static int _fileCounter = 0;

        static void Main(string[] args)
        {
            // 종료 이벤트 핸들러 등록
            AppDomain.CurrentDomain.ProcessExit += OnProcessExit;

            // 1분마다 이벤트를 발생시키는 타이머 설정
            _timer = new Timer(60000);
            _timer.Elapsed += OnTimedEvent;
            _timer.AutoReset = true;
            _timer.Start();

            // 녹화 옵션 설정 (기본 설정 사용)
            RecorderOptions options = new RecorderOptions();

            // 녹화 시작
            _recorder = Recorder.CreateRecorder(options);
            _recorder.Record($"recording{_fileCounter}.mp4");

            Console.WriteLine("녹화 시작. 프로그램을 강제 종료하면 녹화가 중지됩니다.");
            
            // 무한 루프를 사용하여 프로그램이 계속 실행되도록 함
            while (true) { }
        }

        private static void OnProcessExit(object sender, EventArgs e)
        {
            // 프로세스 종료 시 녹화 중단
            _recorder.Stop();
            Console.WriteLine("녹화 중지.");
        }

        private static void OnTimedEvent(Object source, ElapsedEventArgs e)
        {
            // 현재 녹화 중단
            _recorder.Stop();

            // 파일명 변경
            _fileCounter++;
            string fileName = $"recording{_fileCounter}.mp4";

            // 다시 녹화 시작
            _recorder.Record(fileName);
            Console.WriteLine($"{fileName} 저장 시작.");
        }
    }
}
