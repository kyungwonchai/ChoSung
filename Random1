래는 요청하신 조건에 따라 VBA 코드를 작성한 것입니다. 이 코드는 주차2_시트라는 시트 변수를 사용하여 작업을 수행하며, D4부터 마지막 사용된 행까지 데이터를 처리하고 딕셔너리를 이용해 합산 값을 계산하고 병합된 셀 조건에 따라 결과를 기록합니다.

vba
코드 복사
Sub ProcessSheetData()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim cell As Range
    Dim mergeArea As Range
    Dim dict As Object
    Dim key As String
    Dim col As Integer
    Dim startRow As Long
    Dim b4Color As Long
    
    ' 주차2_시트 변수를 시트로 사용
    Set ws = 주차2_시트
    
    ' 마지막 사용된 행 계산
    lastRow = ws.Cells(ws.Rows.Count, "D").End(xlUp).Row
    
    ' B4의 배경색 가져오기
    b4Color = ws.Range("B4").Interior.Color
    
    ' 딕셔너리 초기화
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' D열의 각 셀 반복
    For Each cell In ws.Range("D4:D" & lastRow)
        ' 병합된 셀이 아닌 경우
        If Not cell.MergeCells Then
            ' 배경색이 희거나 투명한지 확인
            If cell.Interior.Color = xlNone Or cell.Interior.Color = RGB(255, 255, 255) Then
                ' 딕셔너리 초기화
                Set dict = CreateObject("Scripting.Dictionary")
            End If
            
            ' 값이 있는 경우 키 추출 및 합산 처리
            If Trim(cell.Value) <> "" Then
                key = GetKey(cell.Value)
                If Not dict.exists(key) Then
                    dict(key) = Array(0, 0, 0, 0, 0, 0) ' F~K 열 초기값
                End If
                
                ' F~K 열 값을 합산
                For col = 1 To 6
                    dict(key)(col - 1) = dict(key)(col - 1) + ws.Cells(cell.Row, 6 + col).Value
                Next col
            End If
        Else
            ' 병합된 셀이고 배경색이 B4와 같은 경우
            If cell.Interior.Color = b4Color Then
                Dim cValue As String
                cValue = ws.Cells(cell.Row, "C").Value
                
                ' C열 값이 키와 일치하는 경우
                If dict.exists(cValue) Then
                    For col = 1 To 6
                        ws.Cells(cell.Row, 6 + col).Value = dict(cValue)(col - 1)
                    Next col
                End If
            End If
        End If
    Next cell
    
    MsgBox "작업 완료!", vbInformation
End Sub

' 키를 추출하는 함수
Function GetKey(value As String) As String
    Dim i As Long
    Dim char As String
    Dim keyStart As Long
    Dim keyEnd As Long
    
    keyStart = 0
    keyEnd = InStr(1, value, "/") - 1 ' / 위치 전까지
    
    If keyEnd > 0 Then
        For i = keyEnd To 1 Step -1
            char = Mid(value, i, 1)
            ' 첫 번째 영어 문자를 발견한 위치
            If char Like "[A-Za-z]" Then
                keyStart = i
                Exit For
            End If
        Next i
    End If
    
    ' 키 추출
    If keyStart > 0 And keyEnd > 0 Then
        GetKey = Mid(value, keyStart, keyEnd - keyStart + 1)
    Else
        GetKey = "" ' 키가 없으면 빈 문자열 반환
    End If
End Function
코드 설명
GetKey 함수:

D열 셀의 값에서 /를 기준으로 첫 번째 영어 문자부터 / 앞까지 추출합니다.
배경색 확인 및 딕셔너리 초기화: