import os

PROJECT_NAME = "SmdEdgeCommander"
BASE_DIR = os.path.join(os.getcwd(), PROJECT_NAME)

# ==========================================
# 1. Project File (.csproj)
# ==========================================
content_csproj = f"""<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net6.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <UseWPF>true</UseWPF>
    <RootNamespace>{PROJECT_NAME}</RootNamespace>
    <AssemblyName>{PROJECT_NAME}</AssemblyName>
  </PropertyGroup>
</Project>
"""

# ==========================================
# 2. App.xaml
# ==========================================
content_app_xaml = """<Application x:Class="SmdEdgeCommander.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             StartupUri="MainWindow.xaml">
    <Application.Resources>
        <SolidColorBrush x:Key="BgDark" Color="#0F0F0F"/>
        <SolidColorBrush x:Key="NeonCyan" Color="#00F3FF"/>
        <SolidColorBrush x:Key="NeonPink" Color="#FF0055"/>
        <SolidColorBrush x:Key="GlassBlack" Color="#CC111111"/>
    </Application.Resources>
</Application>
"""

content_app_xaml_cs = f"""using System.Windows;
namespace {PROJECT_NAME} {{ public partial class App : Application {{ }} }}
"""

# ==========================================
# 3. Models (ShortcutItem.cs)
# ==========================================
content_model = """using System.ComponentModel;

namespace SmdEdgeCommander.Models
{
    public class ShortcutItem : INotifyPropertyChanged
    {
        private double _x;
        private double _y;
        private string _name;
        private string _path;

        public string Id { get; set; } = System.Guid.NewGuid().ToString();
        
        public string Name 
        { 
            get => _name; 
            set { _name = value; OnPropertyChanged(nameof(Name)); } 
        }

        public string Path 
        { 
            get => _path; 
            set { _path = value; OnPropertyChanged(nameof(Path)); } 
        }

        public double X 
        { 
            get => _x; 
            set { _x = value; OnPropertyChanged(nameof(X)); } 
        }

        public double Y 
        { 
            get => _y; 
            set { _y = value; OnPropertyChanged(nameof(Y)); } 
        }

        public event PropertyChangedEventHandler? PropertyChanged;
        protected void OnPropertyChanged(string name) => 
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(name));
    }
}
"""

# ==========================================
# 4. ViewModels (MainViewModel.cs)
# ==========================================
content_viewmodel = """using System;
using System.Collections.ObjectModel;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text.Json;
using System.Windows;
using System.Windows.Input;
using SmdEdgeCommander.Models;

namespace SmdEdgeCommander.ViewModels
{
    public class RelayCommand : ICommand
    {
        private readonly Action<object> _execute;
        public RelayCommand(Action<object> execute) => _execute = execute;
        public bool CanExecute(object? parameter) => true;
        public void Execute(object? parameter) => _execute(parameter!);
        public event EventHandler? CanExecuteChanged;
    }

    public class MainViewModel : System.ComponentModel.INotifyPropertyChanged
    {
        private const string CONFIG_FILE = "config.json";
        
        public ObservableCollection<ShortcutItem> Shortcuts { get; set; } = new();
        
        private bool _isEditMode;
        public bool IsEditMode 
        { 
            get => _isEditMode; 
            set { _isEditMode = value; OnPropertyChanged(nameof(IsEditMode)); SaveConfig(); } 
        }

        private bool _isTopMost = true;
        public bool IsTopMost
        {
            get => _isTopMost;
            set { _isTopMost = value; OnPropertyChanged(nameof(IsTopMost)); }
        }

        public ICommand AddCommand { get; }
        public ICommand RemoveCommand { get; }
        public ICommand SaveCommand { get; }
        public ICommand RunAllCommand { get; }
        public ICommand ExitCommand { get; }

        public MainViewModel()
        {
            LoadConfig();
            AddCommand = new RelayCommand(o => AddShortcut());
            RemoveCommand = new RelayCommand(o => RemoveShortcut(o as ShortcutItem));
            SaveCommand = new RelayCommand(o => SaveConfig());
            RunAllCommand = new RelayCommand(o => RunAll());
            ExitCommand = new RelayCommand(o => Application.Current.Shutdown());
        }

        private void AddShortcut()
        {
            Shortcuts.Add(new ShortcutItem { Name = "New App", Path = "cmd.exe", X = 100, Y = 100 });
        }

        private void RemoveShortcut(ShortcutItem? item)
        {
            if (item != null) Shortcuts.Remove(item);
        }

        public void RunAll()
        {
            foreach (var item in Shortcuts)
            {
                try { Process.Start(new ProcessStartInfo { FileName = item.Path, UseShellExecute = true }); }
                catch { /* Ignore errors for demo */ }
            }
        }

        public void SaveConfig()
        {
            try 
            {
                var json = JsonSerializer.Serialize(Shortcuts);
                File.WriteAllText(CONFIG_FILE, json);
            }
            catch (Exception ex) { MessageBox.Show("Save Error: " + ex.Message); }
        }

        private void LoadConfig()
        {
            if (File.Exists(CONFIG_FILE))
            {
                try
                {
                    var json = File.ReadAllText(CONFIG_FILE);
                    var list = JsonSerializer.Deserialize<ObservableCollection<ShortcutItem>>(json);
                    if (list != null)
                    {
                        Shortcuts.Clear();
                        foreach(var item in list) Shortcuts.Add(item);
                    }
                }
                catch { }
            }
        }

        public event System.ComponentModel.PropertyChangedEventHandler? PropertyChanged;
        protected void OnPropertyChanged(string name) => 
            PropertyChanged?.Invoke(this, new System.ComponentModel.PropertyChangedEventArgs(name));
    }
}
"""

# ==========================================
# 5. MainWindow.xaml (The UI)
# NO CANVAS used for positioning logic (Using Grid + RenderTransform)
# ==========================================
content_mainwindow_xaml = """<Window x:Class="SmdEdgeCommander.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:SmdEdgeCommander.ViewModels"
        Title="SMD Commander" WindowStyle="None" AllowsTransparency="True" Background="{x:Null}"
        Topmost="{Binding IsTopMost}" ShowInTaskbar="False" Loaded="Window_Loaded">
    
    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Border Background="#AA050505" BorderBrush="{StaticResource NeonCyan}" BorderThickness="1" CornerRadius="0">
        <Grid>
            <Path Data="M0,0 L100,0 M0,0 L0,100" Stroke="#222" StrokeThickness="1" Stretch="None" 
                  RenderTransformOrigin="0.5,0.5">
                <Path.Fill>
                    <DrawingBrush Viewport="0,0,50,50" ViewportUnits="Absolute" TileMode="Tile">
                        <DrawingBrush.Drawing>
                            <GeometryDrawing>
                                <GeometryDrawing.Geometry>
                                    <GeometryGroup>
                                        <LineGeometry StartPoint="0,0" EndPoint="50,0"/>
                                        <LineGeometry StartPoint="0,0" EndPoint="0,50"/>
                                    </GeometryGroup>
                                </GeometryDrawing.Geometry>
                                <GeometryDrawing.Pen>
                                    <Pen Brush="#22FFFFFF" Thickness="0.5"/>
                                </GeometryDrawing.Pen>
                            </GeometryDrawing>
                        </DrawingBrush.Drawing>
                    </DrawingBrush>
                </Path.Fill>
            </Path>

            <ItemsControl ItemsSource="{Binding Shortcuts}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Grid Background="Transparent" IsHitTestVisible="True" MouseRightButtonDown="Grid_MouseRightButtonDown"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="RenderTransform">
                            <Setter.Value>
                                <TranslateTransform X="{Binding X}" Y="{Binding Y}"/>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ItemsControl.ItemContainerStyle>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border x:Name="ItemBorder" Width="140" Height="60" CornerRadius="4" 
                                BorderBrush="{StaticResource NeonCyan}" BorderThickness="1" Background="#DD1E1E1E"
                                MouseLeftButtonDown="Item_MouseLeftButtonDown" 
                                MouseLeftButtonUp="Item_MouseLeftButtonUp"
                                MouseMove="Item_MouseMove">
                            <Grid>
                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding Name}" Foreground="White" FontWeight="Bold" HorizontalAlignment="Center"/>
                                    <TextBlock Text="{Binding Path}" Foreground="#888" FontSize="9" TextTrimming="CharacterEllipsis" MaxWidth="120" HorizontalAlignment="Center"/>
                                </StackPanel>
                                <Border Background="#AAFF0055" VerticalAlignment="Top" HorizontalAlignment="Right" 
                                        Visibility="{Binding DataContext.IsEditMode, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVis}}">
                                    <TextBlock Text="EDIT" FontSize="8" Foreground="White" Padding="2"/>
                                </Border>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="20">
                <ToggleButton IsChecked="{Binding IsEditMode}" Content="EDIT MODE" Width="100" Height="30" 
                              Background="#333" Foreground="{StaticResource NeonCyan}" BorderBrush="{StaticResource NeonCyan}"/>
                <Button Command="{Binding RunAllCommand}" Content="âš¡ RUN ALL" Width="100" Height="30" Margin="10,0,0,0" 
                        Background="{StaticResource NeonPink}" Foreground="White" FontWeight="Bold"/>
                <Button Command="{Binding ExitCommand}" Content="X" Width="30" Height="30" Margin="10,0,0,0" Background="Red" Foreground="White"/>
            </StackPanel>

            <Button Command="{Binding AddCommand}" Content="+ ADD SHORTCUT" Width="150" Height="40" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="20"
                    Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVis}}"
                    Background="{StaticResource NeonCyan}" Foreground="Black" FontWeight="Bold"/>

            <Grid x:Name="EditPopup" Visibility="Collapsed" Background="#CC000000">
                <Border Background="#1E1E1E" BorderBrush="{StaticResource NeonCyan}" BorderThickness="2" Width="400" Height="250" CornerRadius="10">
                    <StackPanel Margin="20">
                        <TextBlock Text="EDIT SHORTCUT" Foreground="{StaticResource NeonCyan}" FontWeight="Bold" FontSize="18" Margin="0,0,0,20"/>
                        <TextBlock Text="Name" Foreground="White"/>
                        <TextBox x:Name="TxtName" Background="#333" Foreground="White" Padding="5" Margin="0,5,0,10"/>
                        <TextBlock Text="Path / URL" Foreground="White"/>
                        <TextBox x:Name="TxtPath" Background="#333" Foreground="White" Padding="5" Margin="0,5,0,10"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                            <Button Content="DELETE" Click="BtnDelete_Click" Background="Red" Foreground="White" Width="80" Margin="0,0,10,0"/>
                            <Button Content="SAVE &amp; CLOSE" Click="BtnSave_Click" Background="{StaticResource NeonCyan}" Width="120"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>
    </Border>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </Window.Resources>
</Window>
"""

# ==========================================
# 6. MainWindow.xaml.cs (Logic for No-Canvas Dragging)
# ==========================================
content_mainwindow_xaml_cs = """using System;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using SmdEdgeCommander.Models;
using SmdEdgeCommander.ViewModels;

namespace SmdEdgeCommander
{
    public partial class MainWindow : Window
    {
        private bool _isDragging;
        private Point _startPoint;
        private ShortcutItem? _selectedItem;
        private ShortcutItem? _editingItem;

        public MainWindow()
        {
            InitializeComponent();
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            // Position Window: Exclude Top 100, Left 100
            this.Left = 100;
            this.Top = 100;
            this.Width = SystemParameters.PrimaryScreenWidth - 100;
            this.Height = SystemParameters.PrimaryScreenHeight - 100;
        }

        private void Grid_MouseRightButtonDown(object sender, MouseButtonEventArgs e)
        {
            // Background Right Click Logic if needed
        }

        // --- Drag & Drop Logic (Grid + RenderTransform) ---
        private void Item_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (DataContext is MainViewModel vm && !vm.IsEditMode)
            {
                // Run Mode: Execute
                if (sender is FrameworkElement fe && fe.DataContext is ShortcutItem item)
                {
                    try { System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo { FileName = item.Path, UseShellExecute = true }); }
                    catch { MessageBox.Show("Failed to launch: " + item.Path); }
                }
                return;
            }

            // Edit Mode: Start Drag or Open Edit
            if (e.ClickCount == 2)
            {
                // Double Click -> Open Edit Popup
                if (sender is FrameworkElement fe && fe.DataContext is ShortcutItem item)
                {
                    OpenEditPopup(item);
                }
            }
            else
            {
                // Single Click -> Start Drag
                _isDragging = true;
                _startPoint = e.GetPosition(this);
                if (sender is FrameworkElement fe)
                {
                    _selectedItem = fe.DataContext as ShortcutItem;
                    fe.CaptureMouse();
                }
            }
        }

        private void Item_MouseMove(object sender, MouseEventArgs e)
        {
            if (_isDragging && _selectedItem != null && sender is FrameworkElement fe)
            {
                var currentPoint = e.GetPosition(this);
                double diffX = currentPoint.X - _startPoint.X;
                double diffY = currentPoint.Y - _startPoint.Y;

                // Update Coordinates directly
                _selectedItem.X += diffX;
                _selectedItem.Y += diffY;

                _startPoint = currentPoint;
            }
        }

        private void Item_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)
        {
            if (_isDragging && sender is FrameworkElement fe)
            {
                _isDragging = false;
                _selectedItem = null;
                fe.ReleaseMouseCapture();
                
                // Save position on drop
                if (DataContext is MainViewModel vm) vm.SaveConfig();
            }
        }

        // --- Edit Popup Logic ---
        private void OpenEditPopup(ShortcutItem item)
        {
            _editingItem = item;
            TxtName.Text = item.Name;
            TxtPath.Text = item.Path;
            EditPopup.Visibility = Visibility.Visible;
        }

        private void BtnSave_Click(object sender, RoutedEventArgs e)
        {
            if (_editingItem != null)
            {
                _editingItem.Name = TxtName.Text;
                _editingItem.Path = TxtPath.Text;
                if (DataContext is MainViewModel vm) vm.SaveConfig();
            }
            EditPopup.Visibility = Visibility.Collapsed;
        }

        private void BtnDelete_Click(object sender, RoutedEventArgs e)
        {
             if (_editingItem != null && DataContext is MainViewModel vm)
             {
                 vm.RemoveCommand.Execute(_editingItem);
                 vm.SaveConfig();
             }
             EditPopup.Visibility = Visibility.Collapsed;
        }
    }
}
"""

def write_file(path, content):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content)

def create_project():
    if not os.path.exists(BASE_DIR): os.makedirs(BASE_DIR)
    
    write_file(os.path.join(BASE_DIR, f"{PROJECT_NAME}.csproj"), content_csproj)
    write_file(os.path.join(BASE_DIR, "App.xaml"), content_app_xaml)
    write_file(os.path.join(BASE_DIR, "App.xaml.cs"), content_app_xaml_cs)
    write_file(os.path.join(BASE_DIR, "Models", "ShortcutItem.cs"), content_model)
    write_file(os.path.join(BASE_DIR, "ViewModels", "MainViewModel.cs"), content_viewmodel)
    write_file(os.path.join(BASE_DIR, "MainWindow.xaml"), content_mainwindow_xaml)
    write_file(os.path.join(BASE_DIR, "MainWindow.xaml.cs"), content_mainwindow_xaml_cs)

if __name__ == "__main__":
    create_project()