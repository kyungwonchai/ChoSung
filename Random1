using System;
using System.Data.SqlClient;
using System.Drawing;
using System.IO;
using System.Windows;
using System.Windows.Forms;
using Aspose.Slides;
using MessageBox = System.Windows.MessageBox;

namespace PowerPointToImage
{
    public partial class MainWindow : Window
    {
        private string connectionString = "your_connection_string"; // MSSQL 연결 문자열을 여기에 입력하세요

        public MainWindow()
        {
            InitializeComponent();
        }

        private void ConvertToImage_Click(object sender, RoutedEventArgs e)
        {
            string pptxFilePath = "your_pptx_file_path.pptx";

            Presentation presentation = new Presentation(pptxFilePath);

            try
            {
                int imageWidth = (int)(presentation.SlideSize.Size.Width * 3); // 300% 크기로 설정
                int imageHeight = (int)(presentation.SlideSize.Size.Height * 3); // 300% 크기로 설정

                int slideIndex = 1;
                foreach (ISlide slide in presentation.Slides)
                {
                    using (Bitmap image = slide.GetThumbnail(imageWidth, imageHeight))
                    {
                        // 이미지를 바이트 배열로 변환
                        byte[] imageData = ConvertImageToByteArray(image);

                        // 데이터베이스에 이미지 업로드
                        UploadImageToDatabase(slideIndex, imageData);
                    }

                    slideIndex++;
                }

                MessageBox.Show("Conversion completed. Images are uploaded to the database.");
            }
            catch (Exception ex)
            {
                MessageBox.Show("An error occurred during conversion: " + ex.Message);
            }
            finally
            {
                if (presentation != null)
                {
                    presentation.Dispose();
                }
            }
        }

        private byte[] ConvertImageToByteArray(Bitmap image)
        {
            using (MemoryStream stream = new MemoryStream())
            {
                image.Save(stream, System.Drawing.Imaging.ImageFormat.Png);
                return stream.ToArray();
            }
        }

        private void UploadImageToDatabase(int slideIndex, byte[] imageData)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Open();

                using (SqlCommand command = connection.CreateCommand())
                {
                    command.CommandText = "INSERT INTO SlideImages (SlideIndex, ImageData) VALUES (@SlideIndex, @ImageData)";
                    command.Parameters.AddWithValue("@SlideIndex", slideIndex);
                    command.Parameters.AddWithValue("@ImageData", imageData);

                    command.ExecuteNonQuery();
                }
            }
        }
    }
}
