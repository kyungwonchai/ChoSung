해했어! 설명 아주 잘했어.

네 핵심 조건 정리하면:
ExcelData.time1 은 10분 단위로 나뉘어 있는 시계열 데이터다.

모델별, 군별(ACT2, ACT2BEST)로

각 10분 간격(time1 단위) 에서 0보다 크고 이상치(Q1~Q3 사이)만 남긴 상태에서 군별 최대값을 구하고,

그 **시간별 최대값들을 모아놓은 것 중에서 "전체 시간대의 최소값"**을 구해야 해.

즉, 시간단위별로 max, 그 max들의 min을 군별로 최종 뽑아야 함.

전체 로직 요약 흐름:
scss
코드 복사
[ExcelData 원본] 
   → 모델 필터링 (LastestModels)
   → 최근 5시간 + 모델 적용 (ExcelFiltered)
   → UNPIVOT → 이상치 제거 (Q1~Q3 범위)
   → 모델+군+시간별 max
   → 그 시간별 max 값들 중 min 구함
상세 주석 포함된 MSSQL 2014 쿼리:
sql
코드 복사
-- 1. 최신 모델만 추출 (라인 SMD_12 + 날짜 2025-03-28 기준)
WITH LastestModels AS (
    SELECT DISTINCT model1
    FROM dbo.ExcelData
    WHERE line1 = 'SMD_12'
      AND CAST(time1 AS DATE) = '2025-03-28'
),

-- 2. 최근 5시간 이내의 데이터 중 모델이 포함된 행만 선택
ExcelFiltered AS (
    SELECT
        E.time1,
        E.model1,
        E.line1,
        E.ACT2_1, E.ACT2_2, E.ACT2_3, E.ACT2_4,
        E.ACT2_5, E.ACT2_6, E.ACT2_7, E.ACT2_8,
        E.ACT2BEST_1, E.ACT2BEST_2, E.ACT2BEST_3, E.ACT2BEST_4,
        E.ACT2BEST_5, E.ACT2BEST_6, E.ACT2BEST_7, E.ACT2BEST_8
    FROM dbo.ExcelData E
    INNER JOIN LastestModels L ON E.model1 = L.model1
    WHERE E.time1 >= DATEADD(HOUR, -5, GETDATE())
),

-- 3. ACT2 및 ACT2BEST 컬럼을 행으로 변환 + 0보다 큰 값만
Unpivoted AS (
    SELECT
        model1,
        time1,
        ColName,
        Value
    FROM ExcelFiltered
    UNPIVOT (
        Value FOR ColName IN (
            ACT2_1, ACT2_2, ACT2_3, ACT2_4, ACT2_5, ACT2_6, ACT2_7, ACT2_8,
            ACT2BEST_1, ACT2BEST_2, ACT2BEST_3, ACT2BEST_4,
            ACT2BEST_5, ACT2BEST_6, ACT2BEST_7, ACT2BEST_8
        )
    ) AS Unpvt
    WHERE Value > 0
),

-- 4. 이상치 제거: 분위수 Q1~Q3 사이 값만 유지
WithQuantiles AS (
    SELECT
        model1,
        time1,
        ColName,
        Value,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY Value)
            OVER (PARTITION BY model1, ColName) AS Q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY Value)
            OVER (PARTITION BY model1, ColName) AS Q3
    FROM Unpivoted
),
Filtered AS (
    SELECT model1, time1, ColName, Value
    FROM WithQuantiles
    WHERE Value BETWEEN Q1 AND Q3
),

-- 5. 군 분류 (ACT2 or ACT2BEST) 추가
WithGroupType AS (
    SELECT *,
           CASE 
               WHEN ColName LIKE 'ACT2BEST_%' THEN 'ACT2BEST'
               WHEN ColName LIKE 'ACT2_%' THEN 'ACT2'
           END AS GroupType
    FROM Filtered
),

-- 6. 모델 + 군 + 시간대 별 최대값 계산
MaxPerGroupPerTime AS (
    SELECT
        model1,
        GroupType,
        time1,
        MAX(Value) AS MaxValuePerTime
    FROM WithGroupType
    GROUP BY model1, GroupType, time1
),

-- 7. 위에서 구한 시간대별 max 값들 중에서 전체 시간대의 최소값 찾기
FinalResult AS (
    SELECT
        model1,
        MAX(CASE WHEN GroupType = 'ACT2' THEN time1 END) AS MaxTime_ACT2,
        MIN(CASE WHEN GroupType = 'ACT2' THEN MaxValuePerTime END) AS MinOfMax_ACT2,
        MAX(CASE WHEN GroupType = 'ACT2BEST' THEN time1 END) AS MaxTime_ACT2BEST,
        MIN(CASE WHEN GroupType = 'ACT2BEST' THEN MaxValuePerTime END) AS MinOfMax_ACT2BEST
    FROM MaxPerGroupPerTime
    GROUP BY model1
)

-- 8. 결과 출력
SELECT *
FROM FinalResult
ORDER BY model1;
결과 예시:
model1	MaxTime_ACT2	MinOfMax_ACT2	MaxTime_ACT2BEST	MinOfMax_ACT2BEST
A100	2025-03-28 11:40	0.45	2025-03-28 11:40	0.39
이제 이 쿼리는 정확히 네가 말한

“시간 단위 최대 → 전체 시간대 중 최소”
를 잘 따르고 있어.
