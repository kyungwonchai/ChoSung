import os
import re

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ ì˜¤ë¥˜: 'runcline' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.")
    exit()

print("ğŸ”¥ AI Bridge v47: Ghost Variable Hunting & System Full Restore...")

# ---------------------------------------------------------
# 1ë‹¨ê³„: ì „ìˆ˜ ì¡°ì‚¬ ë° ì˜¤íƒ€ ìˆ˜ì • (Ghost Hunter)
# ---------------------------------------------------------
print("ğŸ” 1. ëª¨ë“  íŒŒì¼ì—ì„œ 'cline_ip' ì˜¤íƒ€ë¥¼ ì°¾ì•„ 'visitor_ip'ë¡œ ê°•ì œ ì¹˜í™˜í•©ë‹ˆë‹¤...")
for root, dirs, files in os.walk(base_dir):
    for file in files:
        if file.endswith(".py") or file.endswith(".html"):
            path = os.path.join(root, file)
            with open(path, "r", encoding="utf-8") as f:
                content = f.read()
            
            if "cline_ip" in content:
                print(f"   ã„´ [FIXED] ì˜¤íƒ€ ë°œê²¬ ë° ìˆ˜ì •: {path}")
                new_content = content.replace("cline_ip", "visitor_ip")
                with open(path, "w", encoding="utf-8") as f:
                    f.write(new_content)

# ---------------------------------------------------------
# 2ë‹¨ê³„: run_bridge.py (ë©”ì¸ íŒŒì¼) ê¹”ë”í•˜ê²Œ ë°€ì–´ë²„ë¦¬ê¸°
# ---------------------------------------------------------
print("ğŸš¿ 2. ë©”ì¸ ì—”íŠ¸ë¦¬ íŒŒì¼(run_bridge.py)ì„ í´ë¦° ìƒíƒœë¡œ ë³µêµ¬í•©ë‹ˆë‹¤...")
run_bridge_code = r"""from flask import Flask, render_template
from app.routes.api_routes import api_bp
from app.database import get_db_connection
import os

app = Flask(__name__, static_folder='app/static', template_folder='app/templates')
app.secret_key = 'kw_unreal_secret_key'

# ë¸”ë£¨í”„ë¦°íŠ¸ ë“±ë¡
app.register_blueprint(api_bp)

@app.route('/')
def index():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT * FROM cline_FolderIndex ORDER BY GroupName, DisplayName")
    projects = cursor.fetchall()
    
    cursor.execute("SELECT COUNT(*) as cnt FROM cline_TaskQueue")
    total_calls = cursor.fetchone()['cnt']
    conn.close()
    return render_template('index.html', projects=projects, total_calls=total_calls)

if __name__ == '__main__':
    # 0.0.0.0ìœ¼ë¡œ ì—´ì–´ì•¼ ì™¸ë¶€ ì ‘ì†ì´ ë©ë‹ˆë‹¤.
    app.run(host='0.0.0.0', port=5000, debug=True)
"""
with open(os.path.join(base_dir, "run_bridge.py"), "w", encoding="utf-8") as f:
    f.write(run_bridge_code)

# ---------------------------------------------------------
# 3ë‹¨ê³„: api_routes.py (ì§„ì…ë¡œ) ì™„ë²½ ì¬ê±´ì¶•
# ---------------------------------------------------------
print("ğŸ—ï¸ 3. API ì§„ì…ë¡œ(api_routes.py)ë¥¼ ë¬´ê²°ì  ìƒíƒœë¡œ ì¬ì„¤ì¹˜í•©ë‹ˆë‹¤...")
api_routes_code = r"""from flask import Blueprint, request, jsonify, abort
from app.database import get_db_connection
import subprocess, os, json, shlex, urllib.request, ssl, re, base64

api_bp = Blueprint('api', __name__)

# ==========================================
# ğŸ›¡ï¸ [IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸] - í˜•ë‹˜ ì•„ì´í”¼ë¥¼ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”
# ==========================================
IP_WHITELIST = ["127.0.0.1", "localhost", "192.168.0.10"] 

def get_visitor_ip():
    # ì‚¬ë‚´ í”„ë¡ì‹œ ë“±ì„ ê³ ë ¤í•œ IP ì¶”ì¶œ (ì˜¤íƒ€ ì ˆëŒ€ ì—†ìŒ)
    xf = request.headers.get('X-Forwarded-For')
    if xf: return xf.split(',')[0].strip()
    return request.remote_addr

@api_bp.before_app_request
def security_gate():
    if request.path.startswith('/static'): return
    
    # ë³€ìˆ˜ëª… í†µì¼: visitor_ip
    visitor_ip = get_visitor_ip()
    
    # í„°ë¯¸ë„ì— ëŒ€ë¬¸ì§ë§Œí•˜ê²Œ ì°ì–´ì¤ë‹ˆë‹¤.
    print(f"\nğŸ“¡ [ACCESS_LOG] IP: {visitor_ip} | PATH: {request.path}")

    if visitor_ip not in IP_WHITELIST:
        print(f"ğŸš« [BLOCKED] Unauthorized access from: {visitor_ip}")
        # ì ‘ì† ê±°ë¶€ ë©”ì‹œì§€ì— í˜„ì¬ ì•„ì´í”¼ë¥¼ ë³´ì—¬ì¤˜ì„œ ë°”ë¡œ ë¦¬ìŠ¤íŠ¸ì— ë„£ê²Œ í•¨
        abort(403, description=f"Unauthorized IP: {visitor_ip}")

# --- [RESTORED API LIST] ---
@api_bp.route('/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    g = cursor.fetchall()
    def gs(sql):
        cursor.execute(sql); r = cursor.fetchone()
        return {'cnt': r['Cnt'], 'dur': r['Dur']} if r else {'cnt': 0, 'dur': 0}
    d = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -1, GETDATE()) AND Status='Done'")
    w = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -7, GETDATE()) AND Status='Done'")
    m = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(month, -1, GETDATE()) AND Status='Done'")
    conn.close(); return jsonify({'groups': g, 'active': [], 'counts': {'day': d, 'week': w, 'month': m}})

@api_bp.route('/rules/deploy', methods=['POST'])
def deploy_rule():
    data = request.json
    p_name, p_path, r_id = data.get('project_name'), data.get('project_path'), data.get('rule_id')
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (r_id,))
    rule = cursor.fetchone()
    cursor.execute("SELECT IPAddress, Account FROM cline_FolderIndex WHERE FullPath=%s", (p_path,))
    tgt = cursor.fetchone()
    if not rule or not tgt: conn.close(); return jsonify({'status': 'error', 'message': 'Not found'})
    f_content = rule['RuleContent'].replace('{SUBJECT}', p_name).replace('{TARGET_PATH}', p_path.replace('\\', '/'))
    r_dir = os.path.join(p_path, ".clinerules").replace('\\', '/')
    r_file = os.path.join(r_dir, "absoluterule.md").replace('\\', '/')
    b64 = base64.b64encode(f_content.encode('utf-8')).decode('utf-8')
    if tgt['IPAddress'] in ['127.0.0.1', 'localhost']:
        os.makedirs(r_dir, exist_ok=True)
        with open(r_file, 'w', encoding='utf-8') as f: f.write(f_content)
        ok = True
    else:
        cmd = f"mkdir -p {shlex.quote(r_dir)} && echo '{b64}' | base64 -d > {shlex.quote(r_file)}"
        res = subprocess.run(['ssh', f"{tgt['Account']}@{tgt['IPAddress']}", cmd], capture_output=True, text=True)
        ok = (res.returncode == 0)
    if ok: cursor.execute("UPDATE cline_FolderIndex SET LastRuleName=%s WHERE FullPath=%s", (rule['RuleName'], p_path)); conn.commit()
    conn.close(); return jsonify({'status': 'success' if ok else 'error'})

@api_bp.route('/queue', methods=['GET', 'POST', 'DELETE'])
def handle_queue():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT TaskID, ProjectName, TaskContent, Status FROM cline_TaskQueue WHERE Status IN ('Pending', 'Processing')")
        r = cursor.fetchall(); conn.close(); return jsonify(r)
    if request.method == 'POST':
        d = request.json; cursor.execute("INSERT INTO cline_TaskQueue (ProjectName, ProjectPath, TaskContent) VALUES (%s, %s, %s)", (d['project'], d['path'], d['content']))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})
    return jsonify([])

@api_bp.route('/bookmarks', methods=['GET'])
def get_bookmarks():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True); cursor.execute("SELECT * FROM cline_WebBookmarks"); r = cursor.fetchall(); conn.close(); return jsonify(r)
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(api_routes_code)

print("\nâœ¨ [COMPLETE] ëª¨ë“  íŒŒì¼ì˜ ìœ ë ¹ ì˜¤íƒ€ë¥¼ ì œê±°í•˜ê³  ì‹œìŠ¤í…œì„ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤.")
print("ğŸ‘‰ ì´ì œ 'python3 run_bridge.py'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
print("ğŸ‘‰ ë§Œì•½ ì ‘ì†ì´ ê±°ë¶€ë˜ë©´ í„°ë¯¸ë„ì— ì°íˆëŠ” [ACCESS_LOG]ì˜ ì•„ì´í”¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.")