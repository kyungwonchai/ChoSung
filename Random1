unsupported operand type(s) for - : datetime.datetime and NoneType" 오류는 CFILETIME 필드가 None 값을 가질 때 발생합니다. 이를 방지하기 위해 데이터베이스 쿼리에서 CFILETIME이 None인지 확인하고 처리해야 합니다.

다음은 해당 오류를 방지하기 위해 app.py 파일을 수정한 예시입니다.

수정된 app.py 코드
python
코드 복사
from flask import Flask, render_template, jsonify
import pymssql
import datetime

app = Flask(__name__)

# MSSQL 데이터베이스 연결 설정
server = 'YOUR_SERVER'
database = 'YOUR_DATABASE'
username = 'YOUR_USERNAME'
password = 'YOUR_PASSWORD'

def get_data():
    conn = pymssql.connect(server=server, user=username, password=password, database=database)
    cursor = conn.cursor()
    query = '''
    SELECT CLine, CMachine, CPCBTEMP, CMASKTEMP, CHUMID, CSORDER, CPAPER, CSOLVENT, CFILETIME
    FROM Table_MaskCleaning2
    '''
    cursor.execute(query)
    rows = cursor.fetchall()
    conn.close()

    data = []
    now = datetime.datetime.now()

    for row in rows:
        CLine, CMachine, CPCBTEMP, CMASKTEMP, CHUMID, CSORDER, CPAPER, CSOLVENT, CFILETIME = row
        if CFILETIME is not None:
            diff_minutes = int((now - CFILETIME).total_seconds() / 60)
        else:
            diff_minutes = None
        data.append({
            'CLine': CLine,
            'CMachine': CMachine,
            'CPCBTEMP': CPCBTEMP,
            'CMASKTEMP': CMASKTEMP,
            'CHUMID': CHUMID,
            'CSORDER': CSORDER,
            'CPAPER': CPAPER,
            'CSOLVENT': CSOLVENT,
            'CFILETIME': CFILETIME,
            'DIFF': diff_minutes
        })

    return data

@app.route('/')
def index():
    data = get_data()
    return render_template('index.html', data=data)

@app.route('/refresh', methods=['GET'])
def refresh():
    data = get_data()
    return jsonify(data)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
HTML 템플릿 (변경 없음)
index.html 파일은 수정이 필요하지 않습니다. diff_minutes가 None일 때 특별한 처리가 필요하지 않다면 그대로 두어도 괜찮습니다.

변경된 부분 설명
CFILETIME 검사:
python
코드 복사
if CFILETIME is not None:
    diff_minutes = int((now - CFILETIME).total_seconds() / 60)
else:
    diff_minutes = None
CFILETIME이 None이 아닌지 확인하여 None인 경우 diff_minutes를 None으로 설정합니다.
전체 프로세스 요약
서비스 로그 확인:

bash
코드 복사
sudo journalctl -u flaskDMF1.service -b
서비스 파일 설정:

ini
코드 복사
[Unit]
Description=Gunicorn instance to serve my_flask_app
After=network.target

[Service]
User=yourusername
Group=www-data
WorkingDirectory=/home/yourusername/my_flask_app
Environment="PATH=/home/yourusername/my_flask_app/venv/bin"
ExecStart=/home/yourusername/my_flask_app/venv/bin/gunicorn --workers 3 --bind unix:/home/yourusername/my_flask_app/my_flask_app.sock -m 007 app:app
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
애플리케이션 테스트:

bash
코드 복사
source /home/yourusername/my_flask_app/venv/bin/activate
cd /home/yourusername/my_flask_app
gunicorn --bind 0.0.0.0:5000 app:app
서비스 재시작:

bash
코드 복사
sudo systemctl daemon-reload
sudo systemctl restart flaskDMF1.service
서비스 상태 확인:

bash
코드 복사
sudo systemctl status flaskDMF1.service
이 단계를 통해 문제를 해결하고 서비스를 안정적으로 실행할 수 있을 것입니다.






