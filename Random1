import os
import subprocess
import json
import urllib.request
import ssl

# ==========================================
# ğŸ‘‡ ì—¬ê¸° 3ê°œë§Œ ìˆ˜ì •í•˜ì„¸ìš”!
# ==========================================
GHE_ID = "ì‚¬ìš©ìID"            # ì˜ˆ: k.won
GHE_TOKEN = "ghp_xxxxxxxx"    # ì•„ê¹Œ ë°œê¸‰ë°›ì€ í† í°
PROJECT_NAME = "MyNewProject" # ë§Œë“¤ê³  ì‹¶ì€ í”„ë¡œì íŠ¸ ì´ë¦„ (ì˜ë¬¸)
# ==========================================

GHE_API_URL = "https://github.sec.samsung.net/api/v3/user/repos"
REPO_URL = f"https://github.sec.samsung.net/{GHE_ID}/{PROJECT_NAME}.git"

def run_cmd(cmd):
    """í„°ë¯¸ë„ ëª…ë ¹ì–´ ì‹¤í–‰ í•¨ìˆ˜"""
    try:
        subprocess.run(cmd, shell=True, check=True)
        print(f"âœ… ì„±ê³µ: {cmd}")
    except subprocess.CalledProcessError as e:
        print(f"âŒ ì‹¤íŒ¨: {cmd}\n{e}")
        # ì´ë¯¸ init ë˜ì–´ ìˆê±°ë‚˜ remoteê°€ ìˆëŠ” ê²½ìš° ë“±ì€ ë„˜ì–´ê°

def create_remote_repo():
    """1. ì‚¼ì„± ì„œë²„ì— ë°©(Repository) ë§Œë“¤ê¸° (API ì‚¬ìš©)"""
    print(f"\nğŸš€ [1ë‹¨ê³„] ì‚¼ì„± GHE ì„œë²„ì— '{PROJECT_NAME}' ë°© ìƒì„± ì¤‘...")
    
    data = json.dumps({"name": PROJECT_NAME, "private": True}).encode('utf-8')
    headers = {
        "Authorization": f"token {GHE_TOKEN}",
        "Content-Type": "application/json",
        "User-Agent": "Python-Script"
    }

    # ì‚¬ë‚´ë§ SSL ì—ëŸ¬ ë¬´ì‹œ ì„¤ì •
    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE

    req = urllib.request.Request(GHE_API_URL, data=data, headers=headers, method="POST")
    
    try:
        with urllib.request.urlopen(req, context=ctx) as response:
            if response.getcode() == 201:
                print("ğŸ‰ ì„œë²„ì— ë°© ìƒì„± ì™„ë£Œ!")
            else:
                print(f"âš ï¸ ì‘ë‹µ ì½”ë“œ: {response.getcode()}")
    except urllib.error.HTTPError as e:
        if e.code == 422:
            print("â„¹ï¸ ì•Œë¦¼: ì´ë¯¸ ì„œë²„ì— ë™ì¼í•œ ì´ë¦„ì˜ ë°©ì´ ì¡´ì¬í•©ë‹ˆë‹¤. (ê·¸ëƒ¥ ì§„í–‰í•¨)")
        else:
            print(f"âŒ ë°© ìƒì„± ì‹¤íŒ¨: {e}")
            exit()
    except Exception as e:
        print(f"âŒ ì—°ê²° ì‹¤íŒ¨: {e}")
        exit()

def init_and_push():
    """2. ë¡œì»¬ ê¹ƒ ì´ˆê¸°í™” ë° í‘¸ì‹œ"""
    print(f"\nğŸš€ [2ë‹¨ê³„] ë¡œì»¬ ì½”ë“œ ì—…ë¡œë“œ ì‹œì‘...")

    # 1. ê¹ƒ ì´ˆê¸°í™”
    if not os.path.exists(".git"):
        run_cmd("git init")
    
    # 2. SSL ê²€ì‚¬ ë„ê¸° & ìœ ì € ì„¤ì • (ì•ˆì „ë¹µ)
    run_cmd("git config http.sslVerify false")
    # ì•„ë˜ëŠ” í•„ìš”ì‹œ ì£¼ì„ í•´ì œ (ì´ë¯¸ ë˜ì–´ìˆìœ¼ë©´ íŒ¨ìŠ¤)
    # run_cmd(f"git config user.name '{GHE_ID}'")
    # run_cmd(f"git config user.email '{GHE_ID}@samsung.com'")

    # 3. íŒŒì¼ ë‹´ê¸°
    run_cmd("git add .")
    run_cmd('git commit -m "Auto Upload via Script"')

    # 4. ë¦¬ëª¨íŠ¸ ì—°ê²° (ê¸°ì¡´ê±° ìˆìœ¼ë©´ ì§€ìš°ê³  ë‹¤ì‹œ)
    run_cmd("git remote remove origin") 
    run_cmd(f"git remote add origin {REPO_URL}")

    # 5. í‘¸ì‹œ (í† í°ì„ URLì— ì‹¬ì–´ì„œ ë¹„ë°€ë²ˆí˜¸ ì•ˆ ë¬»ê²Œ í•¨)
    # ë³´ì•ˆìƒ URLì— í† í°ì„ ì‹¬ì–´ì„œ ê°•ì œ ì „ì†¡
    AUTH_REPO_URL = f"https://{GHE_ID}:{GHE_TOKEN}@github.sec.samsung.net/{GHE_ID}/{PROJECT_NAME}.git"
    
    print("ğŸš€ ì„œë²„ë¡œ ì „ì†¡ ì¤‘...")
    try:
        subprocess.run(f"git push -u {AUTH_REPO_URL} main", shell=True, check=True)
        print("\nâœ¨ [ì„±ê³µ] ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    except:
        print("\nâš ï¸ Main ë¸Œëœì¹˜ ì‹¤íŒ¨, Masterë¡œ ì¬ì‹œë„...")
        subprocess.run(f"git push -u {AUTH_REPO_URL} master", shell=True)

if __name__ == "__main__":
    create_remote_repo()
    init_and_push()