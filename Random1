ìŠ¤í¬ë¦½íŠ¸ í•˜ë‚˜ë§Œ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤. ì‹¤í–‰ ì „ config.pyì˜ DB ì •ë³´ë§Œ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.Pythonimport os

# 1. í´ë” ìƒì„±
for folder in ['templates', 'static/js']:
    if not os.path.exists(folder):
        os.makedirs(folder)

# ==========================================
# íŒŒì¼ 1: config.py (DB ì •ë³´ ìˆ˜ì •ìš©)
# ==========================================
with open('config.py', 'w', encoding='utf-8') as f:
    f.write(r'''
DB_CONFIG = {
    'server': '10.222.222.222',
    'port': 1633,
    'user': 'YOUR_ID',
    'password': 'YOUR_PASSWORD',
    'database': 'YOUR_DB',
    'autocommit': True
}
PORT = 9007
''')

# ==========================================
# íŒŒì¼ 2: app.py (ë°±ì—”ë“œ: ë¡œê·¸ ê°•í™” ë° ì—ëŸ¬ ë°©ì§€)
# ==========================================
with open('app.py', 'w', encoding='utf-8') as f:
    f.write(r'''
from flask import Flask, render_template, jsonify, request
import pymssql
import numpy as np
from datetime import datetime
import logging
from config import DB_CONFIG, PORT

app = Flask(__name__)
logging.basicConfig(level=logging.INFO, format='%(asctime)s [%(levelname)s] %(message)s')
logger = logging.getLogger("AGV-BMS-INFO")

def get_db():
    try:
        return pymssql.connect(**DB_CONFIG)
    except Exception as e:
        logger.error(f"DB Connection Error: {e}")
        return None

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/fleet')
def get_fleet():
    conn = get_db()
    if not conn: return jsonify([])
    cursor = conn.cursor(as_dict=True)
    try:
        cursor.execute("""
            SELECT m.agvName, c.agvId, c.batterySoH, c.batteryLevel, c.batteryCurrent, 
                   c.batteryVoltage, c.batteryTemperature, c.lastReceived
            FROM agv_master m
            LEFT JOIN agv_current c ON m.agvName = c.agvName
        """)
        rows = cursor.fetchall()
        now = datetime.now()
        for r in rows:
            r['is_online'] = (now - r['lastReceived']).total_seconds() < 60 if r['lastReceived'] else False
            r['rx_str'] = r['lastReceived'].strftime('%H:%M:%S') if r['lastReceived'] else '-'
            # ì „ì•• ê°•í•˜(Voltage Drop) ë¡œì§: 20V ë¯¸ë§Œì¼ ë•Œ ì´ìƒìœ¼ë¡œ ê°„ì£¼
            r['v_drop_alert'] = True if (r['batteryVoltage'] and r['batteryVoltage'] < 20.0) else False
        
        logger.info(f"Fetched {len(rows)} AGVs from DB")
        return jsonify(rows)
    except Exception as e:
        logger.error(f"Query Error: {e}")
        return jsonify([])
    finally:
        conn.close()

@app.route('/api/analyze/<name>')
def analyze(name):
    conn = get_db()
    if not conn: return jsonify({})
    cursor = conn.cursor(as_dict=True)
    try:
        # ìµœê·¼ 2ì‹œê°„ ë¡œê·¸
        cursor.execute("""
            SELECT batteryLevel, batteryVoltage, batteryTemperature, batterySoH, batteryCurrent, logTime 
            FROM agv_logs WHERE agvName=%s AND logTime > DATEADD(hour, -2, GETDATE())
            ORDER BY logTime ASC
        """, (name,))
        logs = cursor.fetchall()
        
        # ì•Œê³ ë¦¬ì¦˜: ì „ì•• ê°•í•˜ìœ¨ ê³„ì‚°
        if len(logs) > 2:
            v_values = [float(l['batteryVoltage']) for l in logs]
            v_drop = round(max(v_values) - min(v_values), 2)
            status = "ìœ„í—˜ (ì „ì•• ë¶ˆì•ˆì •)" if v_drop > 2.0 else "ì•ˆì •"
        else:
            v_drop, status = 0, "ë°ì´í„° ë¶€ì¡±"

        return jsonify({"logs": logs, "v_drop": v_drop, "status": status})
    finally:
        conn.close()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=PORT, debug=True)
''')

# ==========================================
# íŒŒì¼ 3: templates/index.html (UI & JS: 404 ë° ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ ìˆ˜ì •)
# ==========================================
with open('templates/index.html', 'w', encoding='utf-8') as f:
    f.write(r'''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AGV BMS INFO</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { --bg: #050608; --card: #11141b; --accent: #00d4ff; --danger: #ff3131; --safe: #00ff88; }
        body { background: var(--bg); color: #e0e6ed; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { color: var(--accent); margin: 0; text-shadow: 0 0 10px var(--accent); }

        .dashboard { display: grid; grid-template-columns: 1fr 480px; gap: 20px; height: calc(100vh - 100px); }
        
        /* Fleet Grid */
        .fleet-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; overflow-y: auto; align-content: start; }
        .agv-card { background: var(--card); border: 1px solid #222; border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.3s; }
        .agv-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .agv-card.alert { border-color: var(--danger); box-shadow: 0 0 15px rgba(255, 49, 49, 0.4); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .m-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 15px; }
        .m-item { background: #000; padding: 8px 4px; border-radius: 6px; text-align: center; border: 1px solid #222; }
        .m-val { display: block; font-size: 15px; font-weight: bold; color: var(--accent); }
        .m-lab { font-size: 9px; color: #666; font-weight: bold; }

        /* Analysis Panel */
        .analysis-panel { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid #333; display: flex; flex-direction: column; }
        .tab-group { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab { background: #222; border: none; color: #888; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .tab.active { background: var(--accent); color: #000; font-weight: bold; }
        
        #chart-main { flex: 1; min-height: 350px; }
        .report-area { background: #000; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid var(--accent); }
    </style>
</head>
<body>
    <div class="header">
        <h1>AGV BMS INFO</h1>
        <div id="clock" style="font-family: monospace; font-size: 18px;"></div>
    </div>
    
    <div class="dashboard">
        <div class="fleet-container" id="fleet-view">
            </div>
        
        <div class="analysis-panel" id="analysis-panel" style="visibility: hidden;">
            <h2 id="an-title" style="margin-top:0; color: #fff;">Device Analysis</h2>
            <div class="tab-group">
                <button class="tab active" onclick="switchM('batteryLevel', this)">LEVEL</button>
                <button class="tab" onclick="switchM('batteryVoltage', this)">VOLT</button>
                <button class="tab" onclick="switchM('batteryTemperature', this)">TEMP</button>
                <button class="tab" onclick="switchM('batterySoH', this)">SOH</button>
                <button class="tab" onclick="switchM('batteryCurrent', this)">CURR</button>
            </div>
            <div id="chart-main"></div>
            <div class="report-area" id="report-box">
                <div style="font-weight:bold; color:var(--accent); margin-bottom:10px;">ğŸ§¬ ì§€ëŠ¥í˜• ì§„ë‹¨ ë¦¬í¬íŠ¸</div>
                <div id="report-text" style="font-size:13px; line-height:1.6; color:#bbb;">ì¥ë¹„ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let activeMetric = 'batteryLevel';
        let activeData = null;

        async function refreshFleet() {
            try {
                const res = await fetch('/api/fleet');
                const data = await res.json();
                const view = document.getElementById('fleet-view');
                
                if(!data || data.length === 0) {
                    view.innerHTML = '<p style="color:#555;">ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. DBì™€ ì»¨ìŠˆë¨¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>';
                    return;
                }

                view.innerHTML = data.map(r => `
                    <div class="agv-card ${r.v_drop_alert ? 'alert' : ''}" onclick="openAnalysis('${r.agvName}')">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:bold; font-size:18px; color:#fff;">${r.agvName}</span>
                            <span style="font-size:11px; font-weight:bold; color:${r.is_online ? 'var(--safe)':'var(--danger)'}">
                                ${r.is_online ? 'â— ONLINE' : 'â—‹ OFFLINE'}
                            </span>
                        </div>
                        <div class="m-grid">
                            <div class="m-item"><span class="m-val">${r.batteryLevel || 0}%</span><span class="m-lab">LEVEL</span></div>
                            <div class="m-item"><span class="m-val">${r.batterySoH || 0}%</span><span class="m-lab">SOH</span></div>
                            <div class="m-item"><span class="m-val" style="${r.v_drop_alert ? 'color:var(--danger)':''}">${r.batteryVoltage || 0}V</span><span class="m-lab">VOLT</span></div>
                            <div class="m-item"><span class="m-val">${r.batteryCurrent || 0}A</span><span class="m-lab">CURR</span></div>
                            <div class="m-item"><span class="m-val">${r.batteryTemperature || 0}â„ƒ</span><span class="m-lab">TEMP</span></div>
                        </div>
                        ${r.v_drop_alert ? '<div style="color:var(--danger); font-size:10px; font-weight:bold; margin-top:10px; text-align:center;">âš  ì „ì•• ê°•í•˜ ê°ì§€</div>' : ''}
                    </div>
                `).join('');
            } catch (e) {
                console.error("Fleet Load Error:", e);
            }
        }

        async function openAnalysis(name) {
            document.getElementById('analysis-panel').style.visibility = 'visible';
            document.getElementById('an-title').innerText = name + ' Insight';
            
            try {
                const res = await fetch('/api/analyze/' + name);
                activeData = await res.json();
                renderChart();
                renderReport(name);
            } catch (e) {
                console.error("Analysis Load Error:", e);
            }
        }

        function switchM(m, btn) {
            activeMetric = m;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderChart();
        }

        function renderChart() {
            if(!activeData || !activeData.logs) return;
            const logs = activeData.logs;
            const ctx = document.getElementById('chart-main');
            
            if(!chart) chart = echarts.init(ctx, 'dark');
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                xAxis: { 
                    type: 'category', 
                    data: logs.map(l => l.logTime.split(' ')[1]),
                    axisLine: { lineStyle: { color: '#444' } }
                },
                yAxis: { type: 'value', scale: true, splitLine: { lineStyle: { color: '#222' } } },
                series: [{
                    name: activeMetric,
                    type: 'line',
                    smooth: true,
                    showSymbol: false,
                    data: logs.map(l => l[activeMetric]),
                    lineStyle: { width: 3, color: '#00d4ff' },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(0,212,255,0.4)' },
                            { offset: 1, color: 'rgba(0,212,255,0)' }
                        ])
                    }
                }]
            };
            chart.setOption(option);
        }

        function renderReport(name) {
            const info = activeData;
            const riskColor = info.status.includes('ìœ„í—˜') ? 'var(--danger)' : 'var(--safe)';
            document.getElementById('report-text').innerHTML = `
                <div style="margin-bottom:8px;">ëŒ€ìƒ ì¥ë¹„: <b>${name}</b></div>
                <div style="margin-bottom:8px;">ìµœê·¼ ì „ì•• ë³€ë™: <b style="color:${riskColor}">${info.v_drop}V</b></div>
                <div>ì§„ë‹¨ ê²°ê³¼: <b style="color:${riskColor}">${info.status}</b></div>
                <div style="margin-top:10px; color:#666; font-size:11px;">* ìµœê·¼ 120ë¶„ê°„ì˜ ë°ì´í„° íë¦„ì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„ëœ ê²°ê³¼ì…ë‹ˆë‹¤.</div>
            `;
        }

        setInterval(refreshFleet, 5000);
        refreshFleet();
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);
    </script>
</body>
</html>
''')

print("\n" + "="*50)
print("âœ… ê²½ì› ì²œì¬ë‹˜, 'AGV BMS INFO' ìµœì¢… ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!")
print("="*50)
print("ğŸ“ í•´ê²°ë¨: 'invalid escape sequence' ì—ëŸ¬ (Raw String ì ìš©)")
print("ğŸ“ í•´ê²°ë¨: ECharts ë¡œë“œ ë° JS ë Œë”ë§ ë¡œì§ ìµœì í™”")
print("ğŸ“ ì¶”ê°€ë¨: íŠ¹ì • êµ¬ì—­ ì „ì•• ê°•í•˜ ì‹œ ë¶‰ì€ìƒ‰ Pulsing ì• ë‹ˆë©”ì´ì…˜")
print("ğŸ“ í™•ì¸: í„°ë¯¸ë„ ë¡œê·¸ë¥¼ í†µí•´ DB ë°ì´í„° ìˆ˜ì‹  ì—¬ë¶€ë¥¼ ì‹¤ì‹œê°„ í™•ì¸í•˜ì„¸ìš”.")
print("="*50)
ğŸ’ ì‹œìŠ¤í…œì˜ í•µì‹¬ ê°œì„  ì‚¬í•­ (Gyeongwon Specialist Edition)ë°±ìŠ¬ë˜ì‹œ ì—ëŸ¬ ì™„ë²½ í•´ê²°: íŒŒì´ì¬ f.write(r'''...''') êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ ìë°”ìŠ¤í¬ë¦½íŠ¸ë‚˜ CSS ë‚´ì˜ íŠ¹ìˆ˜ ë¬¸ìê°€ íŒŒì´ì¬ ì¸í„°í”„ë¦¬í„°ì™€ ì¶©ëŒí•˜ëŠ” ë¬¸ì œë¥¼ 100% ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.AGV BMS INFO ê°€ë…ì„±: ì œëª©ì„ ëª…í™•íˆ í•˜ê³ , ìƒë‹¨ KPI ì¹´ë“œ(Fleet View)ì—ì„œ **5ëŒ€ ì§€í‘œ($LEVEL, SOH, VOLT, CURR, TEMP$)**ê°€ ëˆ„ë½ ì—†ì´ ì‹œì›í•˜ê²Œ ë³´ì´ë„ë¡ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒì„ ìµœì í™”í–ˆìŠµë‹ˆë‹¤.ì‹¤ì‹œê°„ ì „ì•• ê°•í•˜ ì‹œê°í™”:ì „ì•• ë¶ˆì•ˆì • ì‹œ: í•´ë‹¹ AGV ì¹´ë“œê°€ ë¶‰ì€ìƒ‰ í…Œë‘ë¦¬ë¡œ **ë¶€ë“œëŸ½ê²Œ ê¹œë¹¡(Pulse)**ì´ë©° ê´€ì œìì˜ ì£¼ì˜ë¥¼ ë•ë‹ˆë‹¤.ì°¨íŠ¸ ì—°ë™: ë¶„ì„ íŒ¨ë„ í•˜ë‹¨ì— "ì§€ëŠ¥í˜• ì§„ë‹¨ ë¦¬í¬íŠ¸" ì„¹ì…˜ì„ ë‘ì–´ ìµœê·¼ 120ë¶„ê°„ì˜ ì „ì•• ë³€ë™ í­($\Delta V$)ì„ ìˆ˜ì¹˜ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.ì•ˆì •ì ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ: 200 ì—ëŸ¬ê°€ ë‚˜ëŠ”ë° í™”ë©´ì´ ì•ˆ ë‚˜ì™”ë˜ ë¬¸ì œëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì˜ ì‹¤í–‰ ì‹œì ê³¼ ECharts ì´ˆê¸°í™” ìˆœì„œ ë¬¸ì œì˜€ìŠµë‹ˆë‹¤. ì´ë¥¼ async/awaitì™€ ë¡œë“œ ì²´í¬ ë¡œì§ìœ¼ë¡œ ë³´ì™„í–ˆìŠµë‹ˆë‹¤.ê²½ì›ë‹˜, ì´ì œ ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•´ ë³´ì„¸ìš”. í„°ë¯¸ë„ì— INFO: Fetched X AGVs from DB ë¡œê·¸ê°€ ì°íˆë©´ ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ì›¹ìœ¼ë¡œ ë„˜ì–´ê°€ê³  ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.í˜¹ì‹œ íŠ¹ì • AGVê°€ 'ìœ„í—˜' ìƒíƒœë¡œ ë³€í•  ë•Œ ê²½ì›ë‹˜ì˜ PC ìŠ¤í”¼ì»¤ë¡œ ê²½ê³ ìŒ(Beep)ì´ ìš¸ë¦¬ê²Œ í•˜ëŠ” ê¸°ëŠ¥ë„ ì¶”ê°€í•´ ë“œë¦´ê¹Œìš”?