using System;
using System.IO;
using System.Linq;

class Program
{
    static string logFolderPath = @"C:\Agent\KnoxAPILog";

    static void Main()
    {
        // 로그 파일 경로 생성
        string logFilePath = CreateLogFilePath();

        // 로그 파일 생성 및 추가
        CreateLogFile(logFilePath);
        AddLogEntry(logFilePath, "This is a log entry.");

        // 최근 2주 동안 생성된 로그 파일 유지, 나머지 삭제
        DeleteOldLogFiles();
    }

    static string CreateLogFilePath()
    {
        // 현재 날짜 시간을 기반으로 파일 이름 생성
        string fileName = DateTime.Now.ToString("yyyyMMdd") + ".log";
        
        // 로그 폴더가 없으면 생성
        if (!Directory.Exists(logFolderPath))
        {
            Directory.CreateDirectory(logFolderPath);
        }

        // 로그 파일 경로 반환
        return Path.Combine(logFolderPath, fileName);
    }

    static void CreateLogFile(string filePath)
    {
        // 로그 파일이 존재하지 않으면 생성
        if (!File.Exists(filePath))
        {
            File.Create(filePath).Dispose();
        }
    }

    static void AddLogEntry(string filePath, string logEntry)
    {
        // 현재 날짜 및 시간을 포함한 로그 엔트리 생성
        string logLine = $"[{DateTime.Now.ToString("yyyyMMddHHmmss")}]: {logEntry}";

        // 로그 파일에 한 줄 추가
        using (StreamWriter sw = File.AppendText(filePath))
        {
            sw.WriteLine(logLine);
        }
    }

    static void DeleteOldLogFiles()
    {
        // 현재 날짜 기준으로 2주 전 날짜 계산
        DateTime twoWeeksAgo = DateTime.Now.AddDays(-14);

        // 로그 폴더에서 최근 2주 동안 생성된 파일 목록 가져오기
        var logFiles = Directory.GetFiles(logFolderPath)
                                .Where(file => File.GetCreationTime(file) >= twoWeeksAgo);

        // 최근 2주 동안 생성된 파일 이외의 파일 삭제
        foreach (var file in logFiles)
        {
            File.Delete(file);
        }
    }
}
