// FILE_ID: ViewModels/HelpViewModel_20250411094000
using LockerManagementApp.Data;
using LockerManagementApp.Infrastructure;
using LockerManagementApp.Models;
using System;
using System.Data.Entity;
using System.Diagnostics;
using System.Linq;
using System.Runtime.InteropServices;
using System.Security;
using System.Threading;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;

namespace LockerManagementApp.ViewModels
{
    public class HelpViewModel : ViewModelBase, IDisposable
    {
        private readonly LockerDbContext _context;
        private readonly CancellationTokenSource _cts = new CancellationTokenSource();
        private bool _disposed = false;

        private string _authorityManagerNameDisplay;
        private string _systemManagerNameDisplay;
        private string _authorityManagerNameEdit;
        private string _systemManagerNameEdit;
        private SecureString _masterPasswordInput;
        private bool _isMasterVerified = false;
        private string _statusMessage;

        public string AuthorityManagerNameDisplay { get => _authorityManagerNameDisplay; private set => SetProperty(ref _authorityManagerNameDisplay, value); }
        public string SystemManagerNameDisplay { get => _systemManagerNameDisplay; private set => SetProperty(ref _systemManagerNameDisplay, value); }
        public string AuthorityManagerNameEdit { get => _authorityManagerNameEdit; set => SetProperty(ref _authorityManagerNameEdit, value); }
        public string SystemManagerNameEdit { get => _systemManagerNameEdit; set => SetProperty(ref _systemManagerNameEdit, value); }
        public SecureString MasterPasswordInput { get => _masterPasswordInput; set => SetProperty(ref _masterPasswordInput, value); }
        public bool IsMasterVerified { get => _isMasterVerified; private set { SetProperty(ref _isMasterVerified, value); RaiseCanExecuteChanged(); } } // CanExecute 갱신
        public string StatusMessage { get => _statusMessage; set => SetProperty(ref _statusMessage, value); }

        public ICommand LoadCommand { get; }
        public ICommand CheckMasterKeyCommand { get; }
        public ICommand SaveSettingsCommand { get; } // 이 이름이 맞습니다.

        public HelpViewModel()
        {
            try { _context = new LockerDbContext(); }
            catch (Exception ex) { if (!App.IsShuttingDown) MessageBox.Show($"[Help] DB 컨텍스트 생성 오류:\n{ex.ToString()}", "초기화 오류", MessageBoxButton.OK, MessageBoxImage.Error); else Debug.WriteLine($"종료 중 [Help] DB 컨텍스트 생성 오류 무시됨: {ex.Message}"); StatusMessage = "DB 연결 오류!"; LoadCommand = new RelayCommand(async _ => await LoadDataAsync(), _ => !_disposed); CheckMasterKeyCommand = new RelayCommand(async _ => await CheckMasterKeyAsync(), _ => !_disposed); SaveSettingsCommand = new RelayCommand(async _ => await SaveSettingsAsync(), _ => !_disposed && IsMasterVerified); return; }

            LoadCommand = new RelayCommand(async _ => await LoadDataAsync(), CanExecuteCommand);
            CheckMasterKeyCommand = new RelayCommand(async _ => await CheckMasterKeyAsync(), CanExecuteCommand);
            SaveSettingsCommand = new RelayCommand(async _ => await SaveSettingsAsync(), CanSaveSettingsExecute); // CanExecute 분리

            _ = LoadDataAsync();
        }

        private bool CanExecuteCommand(object parameter = null) => !_disposed && _context != null && !_cts.IsCancellationRequested;
        private bool CanSaveSettingsExecute(object parameter = null) => CanExecuteCommand(parameter) && IsMasterVerified; // 마스터 키 확인 시 활성화

        private async Task LoadDataAsync()
        {
            if (!CanExecuteCommand()) return;
            StatusMessage = "담당자 정보 로딩 중...";
            RaiseCanExecuteChanged();
            try
            {
                var settings = await _context.AppSettings
                                             .Where(s => s.SettingKey == "AuthorityManagerName" || s.SettingKey == "SystemManagerName")
                                             .AsNoTracking()
                                             .ToListAsync(_cts.Token);

                if (_cts.IsCancellationRequested || _disposed) return;

                AuthorityManagerNameDisplay = settings.FirstOrDefault(s => s.SettingKey == "AuthorityManagerName")?.SettingValue ?? "미지정";
                SystemManagerNameDisplay = settings.FirstOrDefault(s => s.SettingKey == "SystemManagerName")?.SettingValue ?? "미지정";
                AuthorityManagerNameEdit = AuthorityManagerNameDisplay;
                SystemManagerNameEdit = SystemManagerNameDisplay;
                StatusMessage = "담당자 정보 로드 완료.";
            }
            catch (OperationCanceledException) { Debug.WriteLine("LoadDataAsync (HelpVM) 작업 취소됨."); if (!_disposed) StatusMessage = "로딩 취소됨."; }
            catch (Exception ex) { StatusMessage = $"담당자 정보 로딩 오류: {ex.Message}"; if (!App.IsShuttingDown && !_disposed) MessageBox.Show($"{StatusMessage}\n\n{ex.ToString()}", "오류", MessageBoxButton.OK, MessageBoxImage.Error); }
            finally { RaiseCanExecuteChanged(); }
        }

        private async Task CheckMasterKeyAsync()
        {
            if (!CanExecuteCommand()) return;
            StatusMessage = "마스터 키 확인 중...";
            RaiseCanExecuteChanged();
            try
            {
                var masterKeySetting = await _context.AppSettings.AsNoTracking().FirstOrDefaultAsync(s => s.SettingKey == "MasterKey", _cts.Token);
                if (_cts.IsCancellationRequested || _disposed) return;
                if (masterKeySetting == null || string.IsNullOrEmpty(masterKeySetting.SettingValue)) { MessageBox.Show("데이터베이스에 마스터 키(MasterKey) 설정 없음.", "설정 오류", MessageBoxButton.OK, MessageBoxImage.Warning); StatusMessage = "마스터 키 설정 없음."; IsMasterVerified = false; return; }

                string plainPassword = ConvertToUnsecureString(MasterPasswordInput);
                if (plainPassword == masterKeySetting.SettingValue)
                {
                    IsMasterVerified = true;
                    StatusMessage = "마스터 키 확인 완료. 편집 가능.";
                    MessageBox.Show("마스터 키가 확인되었습니다.", "성공", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                else
                {
                    IsMasterVerified = false;
                    StatusMessage = "마스터 키가 일치하지 않습니다.";
                    MessageBox.Show(StatusMessage, "오류", MessageBoxButton.OK, MessageBoxImage.Warning);
                }
            }
            catch (OperationCanceledException) { Debug.WriteLine("CheckMasterKeyAsync 작업 취소됨."); StatusMessage = "확인 작업 취소됨."; }
            catch (Exception ex) { StatusMessage = $"마스터 키 확인 오류: {ex.Message}"; if (!App.IsShuttingDown && !_disposed) MessageBox.Show($"{StatusMessage}\n\n{ex.ToString()}", "오류", MessageBoxButton.OK, MessageBoxImage.Error); IsMasterVerified = false; }
            finally { RaiseCanExecuteChanged(); }
        }

        private async Task SaveSettingsAsync()
        {
            if (!CanSaveSettingsExecute()) return;
            StatusMessage = "담당자 정보 저장 중...";
            RaiseCanExecuteChanged();
            try
            {
                bool changed = false;
                var authSetting = await _context.AppSettings.FindAsync(_cts.Token, "AuthorityManagerName");
                if (authSetting == null) { authSetting = _context.AppSettings.Add(new AppSetting { SettingKey = "AuthorityManagerName" }); }
                if (authSetting.SettingValue != (AuthorityManagerNameEdit ?? "")) { authSetting.SettingValue = AuthorityManagerNameEdit ?? ""; changed = true; _context.Entry(authSetting).State = authSetting.SettingValue == "" ? EntityState.Added : EntityState.Modified; } // 상태 명시적 설정

                var sysSetting = await _context.AppSettings.FindAsync(_cts.Token, "SystemManagerName");
                if (sysSetting == null) { sysSetting = _context.AppSettings.Add(new AppSetting { SettingKey = "SystemManagerName" }); }
                if (sysSetting.SettingValue != (SystemManagerNameEdit ?? "")) { sysSetting.SettingValue = SystemManagerNameEdit ?? ""; changed = true; _context.Entry(sysSetting).State = sysSetting.SettingValue == "" ? EntityState.Added : EntityState.Modified; } // 상태 명시적 설정

                if (changed)
                {
                    int result = await _context.SaveChangesAsync(_cts.Token); // CancellationToken 전달
                    StatusMessage = $"담당자 정보 저장 완료 ({result}건).";
                    MessageBox.Show("담당자 정보가 저장되었습니다.", "저장 완료", MessageBoxButton.OK, MessageBoxImage.Information);
                    await LoadDataAsync(); // 저장 후 다시 로드하여 Display 업데이트
                }
                else { StatusMessage = "변경된 내용이 없어 저장하지 않았습니다."; }
            }
            catch (OperationCanceledException) { Debug.WriteLine("SaveSettingsAsync 작업 취소됨."); StatusMessage = "저장 작업 취소됨."; }
            catch (Exception ex) { StatusMessage = $"담당자 정보 저장 오류: {ex.Message}"; if (!App.IsShuttingDown && !_disposed) MessageBox.Show($"{StatusMessage}\n\n{ex.ToString()}", "오류", MessageBoxButton.OK, MessageBoxImage.Error); }
            finally { RaiseCanExecuteChanged(); }
        }

        private void RaiseCanExecuteChanged()
        {
            (LoadCommand as RelayCommand)?.RaiseCanExecuteChanged();
            (CheckMasterKeyCommand as RelayCommand)?.RaiseCanExecuteChanged();
            (SaveSettingsCommand as RelayCommand)?.RaiseCanExecuteChanged();
        }

        private string ConvertToUnsecureString(SecureString securePassword) { if (securePassword == null) return string.Empty; IntPtr ptr = IntPtr.Zero; try { ptr = Marshal.SecureStringToGlobalAllocUnicode(securePassword); return Marshal.PtrToStringUni(ptr); } finally { Marshal.ZeroFreeGlobalAllocUnicode(ptr); } }

        #region IDisposable 구현
        protected virtual void Dispose(bool disposing) { if (!_disposed) { _disposed = true; if (disposing) { Debug.WriteLine("HelpViewModel Dispose 시작..."); try { _cts?.Cancel(); } catch (Exception ex) { Debug.WriteLine($"!!! HelpVM CTS Cancel 오류: {ex.Message}"); } try { _cts?.Dispose(); } catch (Exception ex) { Debug.WriteLine($"!!! HelpVM CTS Dispose 오류: {ex.Message}"); } try { _context?.Dispose(); } catch (Exception ex) { Debug.WriteLine($"!!! HelpViewModel DbContext Dispose 오류: {ex.Message}"); } Debug.WriteLine("HelpViewModel 리소스 해제 완료."); } } }
        public void Dispose() { Dispose(true); GC.SuppressFinalize(this); }
        #endregion
    }
}
```

**핵심 변경 사항:**

* `SaveSettingsCommand` 속성 및 생성자에서의 초기화 코드가 올바르게 포함되어 있습니다.
* `CanSaveSettingsExecute` 메서드를 추가하여 `SaveSettingsCommand`의 실행 가능 조건을 명확히 했습니다 (`IsMasterVerified`가 true일 때만).
* `IsMasterVerified` 속성의 `set` 접근자에서 `RaiseCanExecuteChanged()`를 호출하여 마스터 키 확인 상태가 변경될 때 `SaveSettingsCommand`의 활성화 상태가 업데이트되도록 했습니다.
* `SaveSettingsAsync` 메서드에서 `FindAsync`로 설정을 찾은 후, 값이 변경되었을 때 `_context.Entry(setting).State = EntityState.Modified;` (또는 Added) 코드를 추가하여 변경 상태를 명시적으로 설정했습니다. (EF가 자동으로 감지하지 못하는 경우 대비)