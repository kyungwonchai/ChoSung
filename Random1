import os
import json
import logging
import numpy as np
from flask import Flask, render_template, jsonify, request
import pymssql
from datetime import datetime, timedelta

# ==========================================
# 1. ì‹œìŠ¤í…œ ì„¤ì • ë° ë¡œê¹…
# ==========================================
try:
    from config import DB_CONFIG, PORT, ADMIN_PASSWORD
except ImportError:
    # ì„¤ì • íŒŒì¼ì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê¸°ë³¸ê°’ (ê²½ì›ë‹˜ì˜ config.py ì‚¬ìš© ê¶Œì¥)
    DB_CONFIG = {'server': '10.222.222.222', 'port': 1633, 'user': 'ID', 'password': 'PW', 'database': 'DB'}
    PORT = 9007
    ADMIN_PASSWORD = "smd1234!"

app = Flask(__name__)
logging.basicConfig(level=logging.INFO, format='%(asctime)s [%(levelname)s] %(message)s')
logger = logging.getLogger("AGV-BMS-INFO")

def get_db_conn():
    try:
        return pymssql.connect(**DB_CONFIG)
    except Exception as e:
        logger.error(f"âŒ DB ì ‘ì† ì‹¤íŒ¨: {e}")
        return None

# ==========================================
# 2. ìµœì²¨ë‹¨ ì´ìƒ ì§•í›„ ê°ì§€ ì—”ì§„ (Statistical Drift Analysis)
# ==========================================
def run_anomaly_logic(logs):
    """
    ìµœê·¼ 2ì‹œê°„ì˜ ì‹œê³„ì—´ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ í†µê³„ì  ë³€ë™ì„±(Z-Score)ê³¼ 
    ê¸°ìš¸ê¸° ì´ìƒ(Voltage Drop)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    """
    if len(logs) < 10:
        return {"score": 0, "status": "ë°ì´í„° ìˆ˜ì§‘ ì¤‘", "color": "transparent"}

    # ì „ì•• ë° ë ˆë²¨ ë°ì´í„° ì¶”ì¶œ
    v_data = np.array([float(l['batteryVoltage']) for l in logs])
    l_data = np.array([float(l['batteryLevel']) for l in logs])
    
    # 1. ì „ì•• ê°•í•˜(Voltage Drop) ë¶„ì„
    # í‰ê·  ëŒ€ë¹„ ë§ˆì§€ë§‰ ì „ì••ì˜ í¸ì°¨ ê³„ì‚°
    v_mean = np.mean(v_data)
    v_std = np.std(v_data) if np.std(v_data) > 0 else 0.1
    z_score_v = abs((v_data[-1] - v_mean) / v_std)
    
    # 2. ë°©ì „ ì†ë„(Discharge Rate) ë¶„ì„
    # ì´ˆê¸°ê°’ ëŒ€ë¹„ ë§ˆì§€ë§‰ ê°’ì˜ ë³€í™”ëŸ‰ (2ì‹œê°„ ê¸°ì¤€)
    discharge_rate = l_data[0] - l_data[-1]
    
    score = (z_score_v * 15) + (discharge_rate * 2)
    
    status = "ì •ìƒ ìš´ì˜"
    color = "transparent"
    
    if score > 75:
        status = "ìœ„í—˜: ê¸‰ê²©í•œ ì „ì•• ê°•í•˜ ê°ì§€"
        color = "#ff3131"
    elif score > 45:
        status = "ì£¼ì˜: ì „ì•• ë¶ˆì•ˆì •/ë¶€í•˜ ì¦ê°€"
        color = "#f1c40f"

    return {"score": round(min(score, 100), 1), "status": status, "color": color}

# ==========================================
# 3. Flask API ë¼ìš°íŒ…
# ==========================================
@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/fleet')
def get_fleet():
    conn = get_db_conn()
    if not conn: return jsonify({"error": "DB_OFFLINE"}), 500
    cursor = conn.cursor(as_dict=True)
    cursor.execute("""
        SELECT m.agvName, c.agvId, c.batterySoH, c.batteryLevel, c.batteryCurrent, 
               c.batteryVoltage, c.batteryTemperature, c.lastReceived
        FROM agv_master m
        LEFT JOIN agv_current c ON m.agvName = c.agvName
    """)
    rows = cursor.fetchall()
    
    now = datetime.now()
    for r in rows:
        r['is_online'] = (now - r['lastReceived']).total_seconds() < 60 if r['lastReceived'] else False
        r['rx_str'] = r['lastReceived'].strftime('%H:%M:%S') if r['lastReceived'] else '-'
        # ì „ì•• ê°•í•˜ ë‹¨ìˆœ ì²´í¬ (ë¦¬ìŠ¤íŠ¸ ì‹œê°í™”ìš©)
        r['v_drop'] = True if (r['batteryVoltage'] and r['batteryVoltage'] < 20.0) else False
    
    conn.close()
    return jsonify(rows)

@app.route('/api/analyze/<name>')
def get_analysis(name):
    conn = get_db_conn()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("""
        SELECT batteryLevel, batteryVoltage, batteryTemperature, batterySoH, batteryCurrent, logTime 
        FROM agv_logs WHERE agvName=%s AND logTime > DATEADD(hour, -2, GETDATE())
        ORDER BY logTime ASC
    """, (name,))
    logs = cursor.fetchall()
    
    analysis = run_anomaly_logic(logs)
    conn.close()
    return jsonify({"logs": logs, "analysis": analysis})

# ==========================================
# 4. í”„ë¡ íŠ¸ì—”ë“œ (UI & Fixed JavaScript)
# ==========================================
if not os.path.exists('templates'): os.makedirs('templates')
with open('templates/index.html', 'w', encoding='utf-8') as f:
    f.write('''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AGV BMS INFO</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { --bg: #050608; --card: #11141b; --accent: #00d4ff; --danger: #ff3131; --safe: #00ff88; --warn: #f1c40f; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        .dashboard { display: grid; grid-template-columns: 1fr 480px; gap: 20px; height: calc(100vh - 80px); }
        
        /* AGV Grid */
        .fleet-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; overflow-y: auto; }
        .agv-card { background: var(--card); border: 1px solid #222; border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.3s; }
        .agv-card.alert { border-color: var(--danger); box-shadow: 0 0 15px rgba(255, 49, 49, 0.3); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .m-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 12px; }
        .m-item { background: #000; padding: 5px; border-radius: 4px; text-align: center; border: 1px solid #222; }
        .m-val { display: block; font-size: 14px; font-weight: bold; color: var(--accent); }
        .m-lab { font-size: 9px; color: #666; }

        /* Analysis Panel */
        .analysis-panel { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid #2d3748; display: flex; flex-direction: column; }
        .tab-group { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { background: #222; border: none; color: #888; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .tab.active { background: var(--accent); color: #000; font-weight: bold; }
        
        #chart-box { flex: 1; min-height: 300px; }
        .report { background: #000; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-top: 15px; }
    </style>
</head>
<body>
    <h1 style="color:var(--accent); text-shadow: 0 0 10px var(--accent); margin: 0 0 20px 0;">AGV BMS INFO <span style="font-size:12px; color:#444;">Intelligence Analytics</span></h1>
    
    <div class="dashboard">
        <div class="fleet-view" id="fleet-view"></div>
        
        <div class="analysis-panel" id="analysis-panel" style="visibility:hidden;">
            <h2 id="an-title" style="margin-top:0;">Analysis</h2>
            <div class="tab-group">
                <button class="tab active" onclick="changeM('batteryLevel', this)">LEVEL</button>
                <button class="tab" onclick="changeM('batterySoH', this)">SOH</button>
                <button class="tab" onclick="changeM('batteryVoltage', this)">VOLT</button>
                <button class="tab" onclick="changeM('batteryCurrent', this)">CURR</button>
                <button class="tab" onclick="changeM('batteryTemperature', this)">TEMP</button>
            </div>
            <div id="chart-box"></div>
            <div class="report" id="report-box">
                <div style="font-weight:bold; color:var(--accent); margin-bottom:8px;">ğŸ§¬ AI ì§„ë‹¨ ì•Œê³ ë¦¬ì¦˜ ë¦¬í¬íŠ¸</div>
                <div id="report-text" style="font-size:13px; line-height:1.5;"></div>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        let selectedMetric = 'batteryLevel';
        let activeData = null;

        async function updateFleet() {
            const res = await fetch('/api/fleet');
            const data = await res.json();
            const view = document.getElementById('fleet-view');
            
            view.innerHTML = data.map(r => `
                <div class="agv-card ${r.v_drop ? 'alert' : ''}" onclick="openAn('${r.agvName}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold; font-size:16px;">${r.agvName}</span>
                        <span style="font-size:10px; color:${r.is_online ? 'var(--safe)':'var(--danger)'}">${r.is_online ? 'ONLINE':'OFFLINE'}</span>
                    </div>
                    <div class="m-grid">
                        <div class="m-item"><span class="m-val">${r.batteryLevel}%</span><span class="m-lab">LVL</span></div>
                        <div class="m-item"><span class="m-val">${r.batterySoH}%</span><span class="m-lab">SOH</span></div>
                        <div class="m-item"><span class="m-val" style="${r.v_drop ? 'color:var(--danger)':''}">${r.batteryVoltage}V</span><span class="m-lab">VLT</span></div>
                        <div class="m-item"><span class="m-val">${r.batteryCurrent}A</span><span class="m-lab">CUR</span></div>
                        <div class="m-item"><span class="m-val">${r.batteryTemperature}â„ƒ</span><span class="m-lab">TMP</span></div>
                    </div>
                </div>
            `).join('');
        }

        async function openAn(name) {
            document.getElementById('analysis-panel').style.visibility = 'visible';
            document.getElementById('an-title').innerText = name + ' Insight';
            const res = await fetch('/api/analyze/' + name);
            activeData = await res.json();
            renderChart();
            renderReport();
        }

        function changeM(m, btn) {
            selectedMetric = m;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderChart();
        }

        function renderChart() {
            const logs = activeData.logs;
            if(!myChart) myChart = echarts.init(document.getElementById('chart-box'), 'dark');
            myChart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: logs.map(l => l.logTime.split(' ')[1]) },
                yAxis: { type: 'value', scale: true },
                series: [{
                    name: selectedMetric, type: 'line', smooth: true, data: logs.map(l => l[selectedMetric]),
                    lineStyle: { width: 3, color: '#00d4ff' }, areaStyle: { opacity: 0.1 }
                }]
            });
        }

        function renderReport() {
            const an = activeData.analysis;
            const rText = document.getElementById('report-text');
            // ì—ëŸ¬ ì›ì¸ì´ì—ˆë˜ var() ë¶€ë¶„ì— ë”°ì˜´í‘œë¥¼ ì •í™•íˆ ì¶”ê°€í•˜ì—¬ í•´ê²°
            const riskColor = an.score > 70 ? 'var(--danger)' : (an.score > 40 ? 'var(--warn)' : 'var(--safe)');
            
            rText.innerHTML = `
                <div style="margin-bottom:10px;">
                    <span style="display:inline-block; padding:2px 8px; border-radius:10px; background:${riskColor}; color:#000; font-weight:bold; font-size:11px; margin-right:10px;">
                        Risk Score: ${an.score}
                    </span>
                    <b style="color:${riskColor}">${an.status}</b>
                </div>
                <div style="color:#888;">ìµœê·¼ 2ì‹œê°„ì˜ ì „ì•• í¸ì°¨($\sigma$)ì™€ ë°©ì „ ê¸°ìš¸ê¸°ë¥¼ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤. 
                ì „ì•• ê°•í•˜ê°€ ê°ì§€ë˜ë©´ ì¦‰ì‹œ í•´ë‹¹ êµ¬ì—­ì˜ ì„¤ë¹„ ë¶€í•˜ë¥¼ ì ê²€í•˜ì‹­ì‹œì˜¤.</div>
            `;
        }

        setInterval(updateFleet, 5000);
        updateFleet();
    </script>
</body>
</html>
''')

print("\n" + "="*50)
print("âœ… ê²½ì›ë‹˜, 'AGV BMS INFO' ìµœì¢…ë³¸ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
print("="*50)
print("ğŸ“ ìˆ˜ì •ì‚¬í•­: Unexpected token 'var' ì—ëŸ¬ í•´ê²° (JS ë”°ì˜´í‘œ ìˆ˜ì •)")
print("ğŸ“ ìˆ˜ì •ì‚¬í•­: ì œëª© 'AGV BMS INFO'ë¡œ ë³€ê²½ ë° 5ê°œ ìˆ˜ì¹˜ ì‹œê°í™” ê°•í™”")
print("ğŸ“ ê¸°ëŠ¥: ì „ì•• ê°•í•˜ ì‹œ ë¶‰ì€ìƒ‰ ì ë©¸ ì•ŒëŒ ë° AI ë¶„ì„ ë¦¬í¬íŠ¸ íƒ‘ì¬")
print("="*50)