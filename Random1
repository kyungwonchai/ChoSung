. ë³´ë‚¸ ë©”ì‹œì§€ì™€ ë°›ì€ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ë¡œê·¸ë¡œ ë‚¨ê¸°ê¸°ë¥¼ ì›í•œë‹¤ë©´, ì •í™•íˆ ì´ë ‡ê²Œ í•˜ë©´ ë¼.

âœ… ëª©í‘œ
ë³´ë‚¸ ë©”ì‹œì§€ì™€ ë°›ì€ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ë¡œê·¸ë¡œ ë‚¨ê¸´ë‹¤.

ë¡œê·¸ëŠ” ë³„ë„ë¡œ ê´€ë¦¬í•˜ì—¬ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

ReceiveLoopAsync()ì—ì„œ ë°›ì€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ë©”ì‹œì§€ì™€ ë§¤ì¹­ ê°€ëŠ¥í•˜ê²Œ ë§Œë“ ë‹¤.

ğŸ”¥ í•´ê²° ë°©ë²•
ë³´ë‚¼ ë•Œë§ˆë‹¤ ìš”ì²­ ë©”ì‹œì§€ë¥¼ ConcurrentDictionaryì— ì €ì¥

ì‘ë‹µì„ ë°›ì„ ë•Œ, ë§¤ì¹­ëœ ìš”ì²­ì„ ì°¾ì•„ì„œ ë¡œê·¸ë¡œ ë‚¨ê¸°ê¸°

ëª¨ë“  ë¡œê·¸ë¥¼ LogMessage() í•¨ìˆ˜ë¡œ ê¸°ë¡í•˜ê¸°

ğŸ’¡ ì½”ë“œ (ë³´ë‚¸ ë©”ì‹œì§€ì™€ ë°›ì€ ë©”ì‹œì§€ ë¡œê·¸ ë‚¨ê¸°ê¸°)
csharp
ì½”ë“œ ë³µì‚¬
using System;
using System.Collections.Concurrent;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;

public class ExpertSocketClient
{
    private TcpClient _client; // ì„œë²„ì™€ ì—°ê²°í•˜ëŠ” TcpClient ê°ì²´
    private NetworkStream _stream; // ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ê¸° ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ìŠ¤íŠ¸ë¦¼
    private byte[] _buffer = new byte[1024]; // ìˆ˜ì‹  ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë²„í¼ (1KB í¬ê¸°)
    private bool _isConnected = false; // ì„œë²„ì™€ì˜ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

    // ìš”ì²­ IDì™€ ì‘ë‹µ TaskCompletionSourceë¥¼ ë§¤í•‘í•˜ê¸° ìœ„í•œ ë”•ì…”ë„ˆë¦¬
    private ConcurrentDictionary<string, TaskCompletionSource<string>> _responseTasks 
        = new ConcurrentDictionary<string, TaskCompletionSource<string>>();

    // ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ê¸°ë¡í•˜ê¸° ìœ„í•œ ë”•ì…”ë„ˆë¦¬ (ë§¤ì¹­ì„ ìœ„í•´ ì‚¬ìš©)
    private ConcurrentDictionary<string, string> _sentMessages = new ConcurrentDictionary<string, string>();

    /// <summary>
    /// ì„œë²„ì— ì—°ê²°í•˜ê³  ìˆ˜ì‹  ë£¨í”„ë¥¼ ì‹œì‘í•œë‹¤.
    /// </summary>
    public async Task ConnectAsync(string ip, int port)
    {
        _client = new TcpClient();
        await _client.ConnectAsync(ip, port);
        _stream = _client.GetStream();
        _isConnected = true;

        Console.WriteLine($"[INFO] Connected to {ip}:{port}");

        // í•­ìƒ ëŒì•„ê°€ëŠ” ìˆ˜ì‹  ë£¨í”„ë¥¼ ë¹„ë™ê¸°ë¡œ ì‹¤í–‰
        _ = Task.Run(ReceiveLoopAsync); 
    }

    /// <summary>
    /// ì„œë²„ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ì‘ë‹µì„ ê¸°ë‹¤ë¦°ë‹¤.
    /// </summary>
    public async Task<string> SendAndReceiveAsync(string message)
    {
        if (!_isConnected)
            return "[ERROR] Not connected.";

        string wrappedMessage = '\x02' + message + '\x03';
        byte[] data = Encoding.ASCII.GetBytes(wrappedMessage);

        var tcs = new TaskCompletionSource<string>();

        string requestId = Guid.NewGuid().ToString("N");
        _responseTasks.TryAdd(requestId, tcs);
        _sentMessages.TryAdd(requestId, message); // ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ê¸°ë¡

        await _stream.WriteAsync(data, 0, data.Length);
        LogMessage($"[SEND] {message}");

        string response = await tcs.Task;
        _responseTasks.TryRemove(requestId, out _);
        _sentMessages.TryRemove(requestId, out _);

        return response;
    }

    /// <summary>
    /// í•­ìƒ ëŒì•„ê°€ëŠ” ìˆ˜ì‹  ë£¨í”„. ëª¨ë“  ë©”ì‹œì§€ë¥¼ ê°ì§€í•˜ê³  ì²˜ë¦¬í•œë‹¤.
    /// </summary>
    private async Task ReceiveLoopAsync()
    {
        while (_isConnected)
        {
            try
            {
                int bytesRead = await _stream.ReadAsync(_buffer, 0, _buffer.Length);

                if (bytesRead == 0)
                {
                    Console.WriteLine("[INFO] Server disconnected.");
                    _isConnected = false;
                    break;
                }

                string received = Encoding.ASCII.GetString(_buffer, 0, bytesRead).Trim('\x02', '\x03');
                LogMessage($"[RECV] {received}");

                // ëª¨ë“  ìˆ˜ì‹  ì²˜ë¦¬ëŠ” ì—¬ê¸°ì„œ í•œë‹¤.
                if (received == "OP_CLEAR")
                {
                    HandleOpClear(); // ì„ ì œ ì‹ í˜¸ ê°ì§€
                }
                else
                {
                    ProcessResponse(received); // ì¼ë°˜ ì‘ë‹µ ì²˜ë¦¬
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[ERROR] ReceiveLoop exception: {ex.Message}");
                _isConnected = false;
            }
        }
    }

    /// <summary>
    /// OP_CLEAR ë©”ì‹œì§€ë¥¼ ê°ì§€í–ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” ë‚´ë¶€ í•¨ìˆ˜.
    /// </summary>
    private void HandleOpClear()
    {
        LogMessage("[INFO] OP_CLEAR ê°ì§€ë¨. ì´ˆê¸°í™” ì‘ì—… ì‹¤í–‰.");
    }

    /// <summary>
    /// ëª¨ë“  ì‘ë‹µ ë©”ì‹œì§€ì˜ ê²€ì¦ì„ ì²˜ë¦¬í•œë‹¤.
    /// </summary>
    private void ProcessResponse(string response)
    {
        if (ValidateResponse(response))
        {
            LogMessage($"[INFO] ìœ íš¨í•œ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬ë¨: {response}");
        }
        else
        {
            LogMessage($"[INFO] ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µ ë˜ëŠ” ê²€ì¦ ì‹¤íŒ¨: {response}");
        }
    }

    /// <summary>
    /// ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ê²€ì¦í•˜ëŠ” í•¨ìˆ˜.
    /// </summary>
    private bool ValidateResponse(string response)
    {
        if (response.StartsWith("1234"))
        {
            Handle1234Response(response);
            return true;
        }
        else if (response.StartsWith("555"))
        {
            Handle555Response(response);
            return true;
        }
        else if (response.StartsWith("OK"))
        {
            HandleOkResponse(response);
            return true;
        }

        return false;
    }

    /// <summary>
    /// 1234ë¡œ ì‹œì‘í•˜ëŠ” ì‘ë‹µ ì²˜ë¦¬
    /// </summary>
    private void Handle1234Response(string response)
    {
        LogMessage($"[INFO] 1234 ì‘ë‹µ ì²˜ë¦¬ ì™„ë£Œ: {response}");
    }

    /// <summary>
    /// 555ë¡œ ì‹œì‘í•˜ëŠ” ì‘ë‹µ ì²˜ë¦¬
    /// </summary>
    private void Handle555Response(string response)
    {
        LogMessage($"[INFO] 555 ì‘ë‹µ ì²˜ë¦¬ ì™„ë£Œ: {response}");
    }

    /// <summary>
    /// OKë¡œ ì‹œì‘í•˜ëŠ” ì‘ë‹µ ì²˜ë¦¬
    /// </summary>
    private void HandleOkResponse(string response)
    {
        LogMessage($"[INFO] OK ì‘ë‹µ ì²˜ë¦¬ ì™„ë£Œ: {response}");
    }

    /// <summary>
    /// ë©”ì‹œì§€ë¥¼ ê¸°ë¡í•˜ëŠ” í•¨ìˆ˜. (ì½˜ì†” ë˜ëŠ” íŒŒì¼ë¡œ ë¡œê·¸ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆìŒ)
    /// </summary>
    private void LogMessage(string message)
    {
        Console.WriteLine(message); // ì—¬ê¸°ì„œ íŒŒì¼ë¡œë„ ê¸°ë¡ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½í•  ìˆ˜ ìˆìŒ.
    }

    /// <summary>
    /// ì„œë²„ ì—°ê²°ì„ í•´ì œí•œë‹¤.
    /// </summary>
    public void Disconnect()
    {
        _isConnected = false;
        _stream?.Close();
        _client?.Close();
        Console.WriteLine("[INFO] Disconnected.");
    }
}
ğŸ“Œ ì„¤ëª… (ë¡œê·¸ ë‚¨ê¸°ê¸°)
ë³´ë‚¼ ë•Œ (SendAndReceiveAsync())

ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œ, LogMessage() í•¨ìˆ˜ë¡œ ê¸°ë¡ì„ ë‚¨ê¹€.

ë³´ë‚¸ ë©”ì‹œì§€ëŠ” _sentMessages ë”•ì…”ë„ˆë¦¬ì— ê¸°ë¡í•´ì„œ ë‚˜ì¤‘ì— ì¡°íšŒ ê°€ëŠ¥.

ë°›ì„ ë•Œ (ReceiveLoopAsync())

ë°›ì€ ë©”ì‹œì§€ëŠ” LogMessage() í•¨ìˆ˜ë¡œ ê¸°ë¡ì„ ë‚¨ê¹€.

ProcessResponse() ë˜ëŠ” HandleOpClear()ì—ì„œ ê¸°ë¡ í™•ì¸ ê°€ëŠ¥.

ë¡œê·¸ ê¸°ë¡ ë°©ì‹ (LogMessage())

í˜„ì¬ëŠ” Console.WriteLine()ìœ¼ë¡œ ê¸°ë¡í•˜ì§€ë§Œ, íŒŒì¼ë¡œ ê¸°ë¡í•˜ë„ë¡ ì‰½ê²Œ ë³€ê²½ ê°€ëŠ¥.

ğŸ’¯ ê²°ë¡ 
âœ… ë³´ë‚¸ ë©”ì‹œì§€ì™€ ë°›ì€ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ê¸°ë¡í•  ìˆ˜ ìˆìŒ.

âœ… ë³´ë‚¸ ë©”ì‹œì§€ëŠ” _sentMessagesë¡œ ì €ì¥ë˜ê¸° ë•Œë¬¸ì— ì–¸ì œë“ ì§€ í™•ì¸ ê°€ëŠ¥.

âœ… ë¡œê·¸ ê¸°ë¡ ë°©ì‹ì€ ì›í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŒ (íŒŒì¼ë¡œ ê¸°ë¡ ê°€ëŠ¥).