import os

# ==========================================
# í”„ë¡œì íŠ¸ ì„¤ì •
# ==========================================
PROJECT_NAME = "SmdEdgeLauncher"
BASE_DIR = os.path.join(os.getcwd(), PROJECT_NAME)

# ==========================================
# íŒŒì¼ ë‚´ìš© ì •ì˜
# ==========================================

# 1. CS Project File (.NET 6.0/8.0 í˜¸í™˜, WPF ì„¤ì •)
content_csproj = f"""<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net6.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <UseWPF>true</UseWPF>
    <RootNamespace>{PROJECT_NAME}</RootNamespace>
    <AssemblyName>{PROJECT_NAME}</AssemblyName>
  </PropertyGroup>

</Project>
"""

# 2. App.xaml (ì• í”Œë¦¬ì¼€ì´ì…˜ ë¦¬ì†ŒìŠ¤ ë° ìŠ¤íƒ€ì¼)
content_app_xaml = """<Application x:Class="SmdEdgeLauncher.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             StartupUri="MainWindow.xaml">
    <Application.Resources>
        <SolidColorBrush x:Key="AppBackground" Color="#1E1E1E"/>
        <SolidColorBrush x:Key="AppForeground" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="AppAccent" Color="#00ADB5"/>
        <SolidColorBrush x:Key="AppAccentHover" Color="#00FFF5"/>
        <SolidColorBrush x:Key="CardBackground" Color="#2D2D30"/>
        <SolidColorBrush x:Key="BorderBrush" Color="#3F3F46"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource CardBackground}"/>
            <Setter Property="Foreground" Value="{StaticResource AppAccent}"/>
            <Setter Property="BorderBrush" Value="{StaticResource AppAccent}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="5">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#3E3E42"/>
                                <Setter Property="Foreground" Value="{StaticResource AppAccentHover}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="{StaticResource AppAccent}"/>
                                <Setter Property="Foreground" Value="#1E1E1E"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Application.Resources>
</Application>
"""

# 3. App.xaml.cs
content_app_xaml_cs = """using System.Windows;

namespace SmdEdgeLauncher
{
    public partial class App : Application
    {
    }
}
"""

# 4. NativeMethods.cs (Win32 API ì—°ë™ - ì™¸ë¶€ ì°½ ì œì–´ìš©)
content_native_methods = """using System;
using System.Runtime.InteropServices;

namespace SmdEdgeLauncher.Services
{
    public static class NativeMethods
    {
        // ìœˆë„ìš° ìœ„ì¹˜ ë° í¬ê¸° ë³€ê²½ ìƒìˆ˜
        public static readonly IntPtr HWND_TOPMOST = new IntPtr(-1);
        public static readonly IntPtr HWND_NOTOPMOST = new IntPtr(-2);
        public const uint SWP_NOSIZE = 0x0001;
        public const uint SWP_NOMOVE = 0x0002;
        public const uint SWP_SHOWWINDOW = 0x0040;

        [DllImport("user32.dll", SetLastError = true)]
        public static extern bool SetWindowPos(IntPtr hWnd, IntPtr hWndInsertAfter, int X, int Y, int cx, int cy, uint uFlags);

        [DllImport("user32.dll", SetLastError = true)]
        public static extern IntPtr FindWindow(string lpClassName, string lpWindowName);

        [DllImport("user32.dll")]
        public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
        
        [DllImport("user32.dll")]
        public static extern bool SetForegroundWindow(IntPtr hWnd);

        // ì°½ ì œëª©ì˜ ì¼ë¶€ë¡œ í•¸ë“¤ì„ ì°¾ê¸° ìœ„í•œ ëŒ€ë¦¬ì ë° ë©”ì„œë“œ (ê°„ëµí™” ìœ„í•´ FindWindowë§Œ ì‚¬ìš©í•˜ê±°ë‚˜ í•„ìš”ì‹œ EnumWindows ì¶”ê°€ ê°€ëŠ¥)
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ Process.MainWindowHandleì„ ì‚¬ìš©í•  ê²ƒì´ë¯€ë¡œ ìƒëµí•©ë‹ˆë‹¤.
    }
}
"""

# 5. RelayCommand.cs (MVVM ëª…ë ¹ ì²˜ë¦¬)
content_relay_command = """using System;
using System.Windows.Input;

namespace SmdEdgeLauncher.Core
{
    public class RelayCommand : ICommand
    {
        private readonly Action<object> _execute;
        private readonly Predicate<object> _canExecute;

        public RelayCommand(Action<object> execute, Predicate<object> canExecute = null)
        {
            _execute = execute ?? throw new ArgumentNullException(nameof(execute));
            _canExecute = canExecute;
        }

        public bool CanExecute(object parameter) => _canExecute == null || _canExecute(parameter);
        public void Execute(object parameter) => _execute(parameter);
        public event EventHandler CanExecuteChanged
        {
            add { CommandManager.RequerySuggested += value; }
            remove { CommandManager.RequerySuggested -= value; }
        }
    }
}
"""

# 6. MainViewModel.cs (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
content_main_vm = """using System;
using System.Diagnostics;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using SmdEdgeLauncher.Core;
using SmdEdgeLauncher.Services;

namespace SmdEdgeLauncher.ViewModels
{
    public class MainViewModel : System.ComponentModel.INotifyPropertyChanged
    {
        // RDP ì ‘ì† ì •ë³´ (ì‚¬ìš©ì í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
        private const string PC1_IP = "192.168.0.101"; // ì˜ˆì‹œ
        private const string PC2_IP = "192.168.0.102"; // ì˜ˆì‹œ
        private const string NOTE_APP_URL = "https://keep.google.com"; // ì˜ˆì‹œ

        public ICommand LaunchAllCommand { get; }
        public ICommand ArrangeWindowsCommand { get; }
        public ICommand CloseAppCommand { get; }

        private bool _isLockedOnTop;
        public bool IsLockedOnTop
        {
            get => _isLockedOnTop;
            set
            {
                _isLockedOnTop = value;
                OnPropertyChanged(nameof(IsLockedOnTop));
                // ë·°ì—ì„œ ë°”ì¸ë”©ëœ Topmost ì†ì„±ì„ ì œì–´í•˜ê¸° ìœ„í•œ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° ìš©ë„
            }
        }

        private string _statusMessage;
        public string StatusMessage
        {
            get => _statusMessage;
            set { _statusMessage = value; OnPropertyChanged(nameof(StatusMessage)); }
        }

        public MainViewModel()
        {
            StatusMessage = "System Ready. Waiting for command...";
            IsLockedOnTop = true; // ê¸°ë³¸ê°’: í•­ìƒ ìœ„

            LaunchAllCommand = new RelayCommand(async (o) => await LaunchAndArrange());
            ArrangeWindowsCommand = new RelayCommand((o) => ArrangeExternalWindows());
            CloseAppCommand = new RelayCommand((o) => Application.Current.Shutdown());
        }

        private async Task LaunchAndArrange()
        {
            StatusMessage = "Launching applications...";

            // 1. ë…¸íŠ¸ ì•± (ì›¹) ì‹¤í–‰
            Process.Start(new ProcessStartInfo
            {
                FileName = NOTE_APP_URL,
                UseShellExecute = true
            });

            // 2. MSTSC ì‹¤í–‰ (PC1)
            Process.Start("mstsc", $"/v:{PC1_IP}");
            
            // 3. MSTSC ì‹¤í–‰ (PC2)
            Process.Start("mstsc", $"/v:{PC2_IP}");

            StatusMessage = "Apps launched. Waiting for windows to render...";
            
            // ì°½ì´ ëœ° ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°
            await Task.Delay(3000);

            ArrangeExternalWindows();
        }

        private void ArrangeExternalWindows()
        {
            StatusMessage = "Arranging external windows...";

            // ì£¼ì˜: ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì •í™•í•œ ì°½ ì œëª©ì´ë‚˜ í”„ë¡œì„¸ìŠ¤ IDë¡œ í•¸ë“¤ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œ ë¡œì§ì„ êµ¬í˜„í•©ë‹ˆë‹¤.
            
            // ì˜ˆ: Chrome ì°½ ì°¾ê¸° (FindWindow ë“± í™œìš© í•„ìš”, ì—¬ê¸°ì„œëŠ” ê°œë… êµ¬í˜„)
            // IntPtr browserHandle = NativeMethods.FindWindow("Chrome_WidgetWin_1", null);
            // if (browserHandle != IntPtr.Zero) 
            //    NativeMethods.SetWindowPos(browserHandle, IntPtr.Zero, 0, 0, 800, 1000, NativeMethods.SWP_SHOWWINDOW);

            StatusMessage = "Window arrangement complete.";
        }

        public event System.ComponentModel.PropertyChangedEventHandler PropertyChanged;
        protected void OnPropertyChanged(string name) => 
            PropertyChanged?.Invoke(this, new System.ComponentModel.PropertyChangedEventArgs(name));
    }
}
"""

# 7. MainWindow.xaml (UI ë””ìì¸)
content_mainwindow_xaml = """<Window x:Class="SmdEdgeLauncher.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:SmdEdgeLauncher.ViewModels"
        mc:Ignorable="d"
        Title="SMD Edge Commander" 
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Topmost="{Binding IsLockedOnTop}"
        ShowInTaskbar="False"
        Loaded="Window_Loaded">
    
    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Border Background="{StaticResource AppBackground}" 
            BorderBrush="{StaticResource AppAccent}" 
            BorderThickness="2" 
            CornerRadius="10"
            Opacity="0.95">
        
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <RowDefinition Height="*"/>    <RowDefinition Height="Auto"/> </Grid.RowDefinitions>

            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="SMD" Foreground="{StaticResource AppForeground}" FontSize="24" FontWeight="Bold"/>
                    <TextBlock Text=" EDGE" Foreground="{StaticResource AppAccent}" FontSize="24" FontWeight="Bold"/>
                    <TextBlock Text=" COMMANDER" Foreground="{StaticResource AppForeground}" FontSize="24" FontWeight="Light"/>
                </StackPanel>

                <Button Grid.Column="1" Command="{Binding CloseAppCommand}" Content="EXIT" Width="80" Background="#FF4444" BorderBrush="#FF4444" Foreground="White"/>
            </Grid>

            <Grid Grid.Row="1" Margin="0,20">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Text="CONTROL CENTER" Foreground="#888" FontSize="12" Margin="0,0,0,10"/>
                
                <WrapPanel Grid.Row="1" Orientation="Horizontal">
                    <Button Command="{Binding LaunchAllCommand}" Content="ğŸš€ LAUNCH ALL SYSTEM" Height="50" Width="200" Margin="0,0,10,10" FontSize="14"/>
                    <Button Command="{Binding ArrangeWindowsCommand}" Content="ğŸ”² RE-ARRANGE WINDOWS" Height="50" Width="200" Margin="0,0,10,10" FontSize="14"/>
                </WrapPanel>

                <Border Grid.Row="2" Background="#000000" BorderBrush="#333" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,20,0,0">
                    <TextBlock Text="{Binding StatusMessage}" Foreground="#00FF00" FontFamily="Consolas" TextWrapping="Wrap"/>
                </Border>
            </Grid>

            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                <CheckBox IsChecked="{Binding IsLockedOnTop}" Content="ALWAYS ON TOP (MONITORING)" Foreground="{StaticResource AppForeground}" VerticalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>
"""

# 8. MainWindow.xaml.cs (Code Behind - ìœ„ì¹˜ ê³„ì‚° ë° ê°•ì œ í¬ì»¤ìŠ¤ ë¡œì§)
content_mainwindow_xaml_cs = """using System;
using System.Windows;
using System.Windows.Threading;

namespace SmdEdgeLauncher
{
    public partial class MainWindow : Window
    {
        private DispatcherTimer _monitorTimer;

        public MainWindow()
        {
            InitializeComponent();
            InitializeMonitorTimer();
        }

        private void InitializeMonitorTimer()
        {
            // ìœˆë„ìš°ê°€ ìµœì†Œí™”ë˜ê±°ë‚˜ ê°€ë ¤ì§€ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ê°ì‹œ íƒ€ì´ë¨¸ (ì„ íƒì  ê¸°ëŠ¥)
            _monitorTimer = new DispatcherTimer();
            _monitorTimer.Interval = TimeSpan.FromSeconds(2);
            _monitorTimer.Tick += (s, e) => 
            {
                var vm = this.DataContext as ViewModels.MainViewModel;
                if (vm != null && vm.IsLockedOnTop)
                {
                    if (this.WindowState == WindowState.Minimized)
                    {
                        this.WindowState = WindowState.Normal;
                    }
                    this.Topmost = true; 
                    this.Activate();
                }
            };
            _monitorTimer.Start();
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            // í™”ë©´ í•´ìƒë„ ê°€ì ¸ì˜¤ê¸°
            double screenWidth = SystemParameters.PrimaryScreenWidth;
            double screenHeight = SystemParameters.PrimaryScreenHeight;

            // ì¢Œì¸¡ 100px, ìƒë‹¨ 100px ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì˜ì—­ ê³„ì‚°
            double targetLeft = 100;
            double targetTop = 100;
            double targetWidth = screenWidth - 100;
            double targetHeight = screenHeight - 100;

            // ìœˆë„ìš° ìœ„ì¹˜ ë° í¬ê¸° ì„¤ì •
            this.Left = targetLeft;
            this.Top = targetTop;
            this.Width = targetWidth;
            this.Height = targetHeight;
        }
    }
}
"""

# ==========================================
# íŒŒì¼ ìƒì„± ìœ í‹¸ë¦¬í‹°
# ==========================================
def write_file(path, content):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content)
    print(f"Created: {path}")

# ==========================================
# ë©”ì¸ ì‹¤í–‰
# ==========================================
def create_project():
    if not os.path.exists(BASE_DIR):
        os.makedirs(BASE_DIR)

    # í´ë” êµ¬ì¡° ìƒì„±
    folders = ["Core", "Services", "ViewModels"]
    for folder in folders:
        os.makedirs(os.path.join(BASE_DIR, folder), exist_ok=True)

    # íŒŒì¼ ìƒì„±
    write_file(os.path.join(BASE_DIR, f"{PROJECT_NAME}.csproj"), content_csproj)
    write_file(os.path.join(BASE_DIR, "App.xaml"), content_app_xaml)
    write_file(os.path.join(BASE_DIR, "App.xaml.cs"), content_app_xaml_cs)
    write_file(os.path.join(BASE_DIR, "MainWindow.xaml"), content_mainwindow_xaml)
    write_file(os.path.join(BASE_DIR, "MainWindow.xaml.cs"), content_mainwindow_xaml_cs)
    
    write_file(os.path.join(BASE_DIR, "Services", "NativeMethods.cs"), content_native_methods)
    write_file(os.path.join(BASE_DIR, "Core", "RelayCommand.cs"), content_relay_command)
    write_file(os.path.join(BASE_DIR, "ViewModels", "MainViewModel.cs"), content_main_vm)

    print("\n" + "="*50)
    print(f"âœ… Project '{PROJECT_NAME}' created successfully!")
    print("="*50)
    print("To run the application:")
    print(f"1. cd {PROJECT_NAME}")
    print("2. dotnet run")
    print("="*50)

if __name__ == "__main__":
    create_project()