using CefSharp.OffScreen;
using OpenCvSharp;
using System;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Threading.Tasks;

public class ChromiumVideoCapture
{
    private CefSharp.OffScreen.ChromiumWebBrowser webView;
    private bool isRecording = false;
    private readonly int width = 1920;
    private readonly int height = 1080;
    private const int frameRate = 4; // 비디오 재생 속도 초당 4프레임
    private const int captureInterval = 250; // 캡처 간격을 250ms로 설정 (초당 4장)

    public async Task StartCaptureAsync(string url)
    {
        // 오프스크린 브라우저 초기화
        webView = new CefSharp.OffScreen.ChromiumWebBrowser(url);
        webView.Size = new System.Drawing.Size(width, height);

        // 브라우저 로드 대기
        await webView.WaitForInitialLoadAsync();
        isRecording = true;

        while (isRecording)
        {
            await RecordForTenMinutesAsync(); // 10분마다 새 파일 생성 및 녹화
            CleanupOldFolders(); // 최대 5일 보관된 폴더 삭제
        }
    }

    private async Task RecordForTenMinutesAsync()
    {
        string folderPath = GetFolderPath();
        string videoPath = Path.Combine(folderPath, $"ACR_{DateTime.Now:yyMMdd_HHmmss}.avi");

        using (var videoWriter = new VideoWriter(videoPath, VideoWriter.Fourcc('M', 'J', 'P', 'G'), frameRate, new OpenCvSharp.Size(width, height), true))
        {
            DateTime endTime = DateTime.Now.AddMinutes(10);
            var stopwatch = new Stopwatch();

            while (DateTime.Now < endTime && isRecording)
            {
                stopwatch.Restart();

                var bitmap = await TakeScreenshotAsync(); // 프레임 캡처
                var frame = BitmapToMat(bitmap); // 프레임을 Mat 형식으로 변환

                if (!frame.Empty())
                {
                    videoWriter.Write(frame); // 프레임을 비디오에 저장
                    frame.Dispose();
                }
                else
                {
                    Console.WriteLine("프레임이 비어 있습니다. 캡처 실패.");
                }

                stopwatch.Stop();
                int elapsed = (int)stopwatch.ElapsedMilliseconds;
                int delay = captureInterval - elapsed;

                // 250ms 간격을 유지하기 위해 보정
                if (delay > 0)
                {
                    await Task.Delay(delay);
                }
            }
        }
    }

    private async Task<System.Drawing.Bitmap> TakeScreenshotAsync()
    {
        // 스크린샷을 비동기적으로 캡처합니다.
        var screenshot = await webView.CaptureScreenshotAsync();
        using (var memoryStream = new MemoryStream(screenshot))
        {
            return new System.Drawing.Bitmap(memoryStream);
        }
    }

    private Mat BitmapToMat(System.Drawing.Bitmap bitmap)
    {
        Mat mat = new Mat(bitmap.Height, bitmap.Width, MatType.CV_8UC3);
        for (int y = 0; y < bitmap.Height; y++)
        {
            for (int x = 0; x < bitmap.Width; x++)
            {
                System.Drawing.Color color = bitmap.GetPixel(x, y);
                mat.Set(y, x, new Vec3b(color.B, color.G, color.R));
            }
        }
        return mat;
    }

    private string GetFolderPath()
    {
        string dateFolder = DateTime.Now.ToString("yyyyMMdd");
        string baseFolder = @"D:\VideoRecords";
        string fullPath = Path.Combine(baseFolder, dateFolder);

        if (!Directory.Exists(fullPath))
        {
            Directory.CreateDirectory(fullPath);
        }

        return fullPath;
    }

    private void CleanupOldFolders()
    {
        string baseFolder = @"D:\VideoRecords";
        var directories = Directory.GetDirectories(baseFolder);

        foreach (var dir in directories)
        {
            DateTime dirDate;
            string folderName = new DirectoryInfo(dir).Name;

            if (DateTime.TryParseExact(folderName, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out dirDate))
            {
                if ((DateTime.Now - dirDate).TotalDays > 5)
                {
                    Directory.Delete(dir, true);
                }
            }
        }
    }

    public void StopCapture()
    {
        isRecording = false;
        webView?.Dispose();
    }
}
