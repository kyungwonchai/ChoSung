된 요구사항에 따라, SentValue의 좌측 14자 값을 컬럼으로 추가하고, 각 컬럼명에 "WDD"가 포함된 경우, 해당 컬럼의 셀 값으로는 SentValue의 20번째 문자부터 끝까지를 가져오도록 코드를 수정하겠습니다.

python
코드 복사
import os
import csv
from datetime import datetime

# Log file directory
log_directory = "c:/test"

# Dictionary to store unique SentValue prefixes
unique_prefixes = {}

# List to store the parsed log data
log_data = []

# Read all files in the directory
for filename in os.listdir(log_directory):
    if "commandqueue" in filename.lower():
        file_path = os.path.join(log_directory, filename)
        
        # Open and read the file
        with open(file_path, 'r', encoding='utf-8') as file:
            lines = file.readlines()
            for line in lines:
                # Split the line by '|'
                parts = line.strip().split('|')
                if len(parts) == 7:  # Only process if all required fields are present
                    # Extract the first 14 characters of SentValue as a prefix
                    prefix = parts[1][:14]
                    unique_prefixes[prefix] = None  # Store as a key for uniqueness
                    log_data.append(parts)

# Sort the unique prefixes alphabetically and convert to a list
sorted_prefixes = sorted(unique_prefixes.keys())

# Sort the log data by time (assuming the time format is consistent for sorting)
log_data.sort(key=lambda x: x[0])

# Prepare the output directory
output_directory = "c:/test/csv2"
os.makedirs(output_directory, exist_ok=True)

# Create the output file name with the current timestamp
timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
output_file = os.path.join(output_directory, f"{timestamp}_output.csv")

# Save the sorted data to a CSV file with dynamic columns based on SentValue prefixes
with open(output_file, 'w', newline='', encoding='utf-8') as csvfile:
    csvwriter = csv.writer(csvfile)
    
    # Write column headers
    headers = ["Time", "SentValue", "ResponseValue", "Result", "Result2", "Retry", "Speed"] + sorted_prefixes
    csvwriter.writerow(headers)
    
    # Write data rows
    for row in log_data:
        # Initialize row with existing columns
        data_row = row[:7]
        
        # Create a list for prefix columns, initialized to empty strings
        prefix_values = [''] * len(sorted_prefixes)
        
        # Find the prefix for the current SentValue and set its corresponding column
        current_prefix = row[1][:14]
        if current_prefix in sorted_prefixes:
            prefix_index = sorted_prefixes.index(current_prefix)
            # Determine the value to fill based on whether "WDD" is in the prefix
            if "WDD" in current_prefix:
                # Extract SentValue from the 20th character onward
                sent_value = row[1]
                extracted_value = sent_value[19:] if len(sent_value) >= 20 else ""
            else:
                # Extract the rightmost 7 characters of ResponseValue
                response_value = row[2]
                extracted_value = response_value[-7:] if len(response_value) >= 7 else response_value
            prefix_values[prefix_index] = extracted_value
        
        # Combine the base data with the prefix values
        full_row = data_row + prefix_values
        csvwriter.writerow(full_row)

print(f"CSV file has been saved as '{output_file}'.")
코드 설명
SentValue 컬럼의 고유 값 추출: SentValue의 좌측 14자 값을 고유 값으로 추출하여 알파벳 순으로 정렬된 컬럼으로 추가합니다.
WDD 포함 여부 확인 및 값 할당:
각 SentValue 컬럼의 셀 값은 SentValue의 20번째 문자부터 끝까지의 값을 사용하며, 해당 컬럼에 "WDD"가 포함된 경우에만 적용됩니다.
"WDD"가 포함되지 않은 경우, ResponseValue의 마지막 7자리를 셀 값으로 사용합니다.