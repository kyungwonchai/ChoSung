사용자가 겪고 있는 apt update 실패는 사내 프록시 환경에서 1) apt.conf 설정 꼬임, 2) 환경 변수 불일치, 3) SSL 인증서 검증 실패(MITM 프록시 특성) 가 복합적으로 작용했을 가능성이 큽니다.

요청하신 대로 백업 -> 기존 설정 초기화 -> 강력한 프록시 강제 적용 -> SSL 검증 우회 -> 연결 테스트까지 한 번에 수행하는 One-Shot Python 스크립트를 작성했습니다.

🛠️ 해결 스크립트: fix_apt_proxy.py
이 스크립트는 반드시 sudo 권한으로 실행해야 합니다. /etc/apt/ 디렉토리를 건드리기 때문입니다.

Python

import os
import sys
import shutil
import subprocess
import datetime

# ==========================================
# [설정 영역] 사용자 프록시 정보
# 포트가 있다면 :8080 처럼 뒤에 붙여주세요.
# 입력하신 정보: http://10.244.111.111
# ==========================================
PROXY_HOST = "10.244.111.111"
PROXY_PORT = ""  # 포트가 있다면 "8080" 처럼 문자열로 입력 (없으면 비워둠)
PROXY_PROTOCOL = "http"

# 전체 프록시 주소 조합
if PROXY_PORT:
    FULL_PROXY_URL = f"{PROXY_PROTOCOL}://{PROXY_HOST}:{PROXY_PORT}/"
else:
    FULL_PROXY_URL = f"{PROXY_PROTOCOL}://{PROXY_HOST}/"

def log(msg):
    print(f"[LOG] {msg}")

def run_command(cmd, shell=False):
    try:
        result = subprocess.run(cmd, shell=shell, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
        return True, result.stdout
    except subprocess.CalledProcessError as e:
        return False, e.stderr

def main():
    # 1. 루트 권한 확인
    if os.geteuid() != 0:
        print("❌ 이 스크립트는 sudo 권한으로 실행해야 합니다.")
        print("   사용법: sudo python3 fix_apt_proxy.py")
        sys.exit(1)

    log("🔍 시스템 진단 및 프록시 복구 시작...")
    log(f"   타겟 프록시: {FULL_PROXY_URL}")

    # 2. 기존 설정 백업 (/etc/apt/apt.conf 및 conf.d)
    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_dir = f"/etc/apt/backup_{timestamp}"
    
    if os.path.exists("/etc/apt/apt.conf"):
        os.makedirs(backup_dir, exist_ok=True)
        shutil.copy("/etc/apt/apt.conf", backup_dir)
        log(f"📦 기존 apt.conf를 {backup_dir}로 백업했습니다.")

    # 3. 충돌 가능성 있는 파일 정리 (apt.conf.d 내의 프록시 관련 파일)
    # 꼬여있는 설정을 방지하기 위해 99proxy 같은 파일이 있다면 백업 후 삭제
    proxy_configs = ["/etc/apt/apt.conf.d/99proxy", "/etc/apt/apt.conf.d/proxy.conf", "/etc/apt/apt.conf.d/01proxy"]
    for config in proxy_configs:
        if os.path.exists(config):
            shutil.move(config, f"{backup_dir}/{os.path.basename(config)}.bak")
            log(f"🧹 충돌 방지를 위해 {config} 파일을 치웠습니다.")

    # 4. 새 apt.conf 작성 (가장 강력한 강제 설정)
    # Acquire::https::Verify-Peer "false"; -> 사내 인증서 문제 해결의 핵심
    apt_conf_content = f"""
# Generated by Fix Script
Acquire::http::Proxy "{FULL_PROXY_URL}";
Acquire::https::Proxy "{FULL_PROXY_URL}";
Acquire::ftp::Proxy "{FULL_PROXY_URL}";
Acquire::http::Pipeline-Depth "0";
Acquire::http::No-Cache "true";
Acquire::BrokenProxy "true";
# 사내망 SSL/TLS 인증서 문제 무시 (보안상 권장은 아니나 업데이트 해결 우선)
Acquire::https::Verify-Peer "false";
Acquire::https::Verify-Host "false";
"""
    
    try:
        with open("/etc/apt/apt.conf", "w") as f:
            f.write(apt_conf_content)
        log("✅ /etc/apt/apt.conf 파일을 새로 작성했습니다.")
    except Exception as e:
        log(f"❌ 설정 파일 작성 실패: {e}")
        sys.exit(1)

    # 5. 환경 변수 일시적 주입 (현재 세션에서의 실행을 위해)
    os.environ["http_proxy"] = FULL_PROXY_URL
    os.environ["https_proxy"] = FULL_PROXY_URL
    os.environ["HTTP_PROXY"] = FULL_PROXY_URL
    os.environ["HTTPS_PROXY"] = FULL_PROXY_URL
    
    log("⚡ 현재 세션에 환경 변수를 주입했습니다.")

    # 6. 연결 테스트 (Google로 curl 시도 - 타임아웃 3초)
    log("📡 프록시 서버 연결 테스트 중...")
    success, output = run_command(f"curl -I --proxy {FULL_PROXY_URL} --connect-timeout 3 http://google.com", shell=True)
    if success:
        log("✅ 프록시를 통한 외부 연결이 확인되었습니다.")
    else:
        log("⚠️ [주의] 프록시 연결 테스트가 실패했습니다. IP나 포트를 다시 확인해보세요.")
        log(f"   에러 내용: {output.strip()}")
        # 연결이 안 되어도 apt 설정은 적용되었으므로 진행은 해봅니다.

    # 7. apt update 실행
    log("🚀 apt update를 실행합니다...")
    success, output = run_command("apt-get update", shell=True)

    if success:
        print("\n" + "="*40)
        print("🎉 성공! apt update가 정상적으로 완료되었습니다.")
        print("="*40)
    else:
        print("\n" + "="*40)
        print("❌ 실패. 여전히 문제가 있습니다.")
        print(f"오류 로그:\n{output}")
        print("="*40)
        print("Tip: 프록시 주소 뒤에 포트번호(예: 8080)가 빠진 것은 아닌지 확인하세요.")

if __name__ == "__main__":
    main()
📋 사용 방법
위 코드를 fix_apt_proxy.py라는 이름으로 저장합니다.

터미널에서 아래 명령어로 실행합니다.

Bash

sudo python3 fix_apt_proxy.py
💡 주요 처리 내용 (Logic)
설정 파일 완전 초기화 (/etc/apt/apt.conf): 기존에 사용자가 건드렸을지 모르는 설정을 백업 후 덮어씁니다.

SSL 검증 비활성화 (Verify-Peer "false"): 사내망 프록시는 보통 HTTPS 패킷을 까보기 위해 자체 인증서를 씁니다. 우분투에 해당 인증서가 없으면 막히는데, 이 옵션으로 그 검사를 강제 패스시킵니다.

Pipeline-Depth 0: 오래된 프록시 서버가 파이프라이닝 요청을 처리 못해 연결을 끊는 것을 방지합니다.

다음 단계: 혹시 스크립트 실행 후 Connect timeout이나 Connection refused가 뜬다면, 알려주신 IP(10.244.111.111) 뒤에 **포트 번호(예: 8080, 3128)**가 필요한지 전산팀 공지나 동료 PC 설정을 확인해봐야 합니다. 필요하면 스크립트 상단의 PROXY_PORT 변수만 수정해서 다시 돌리세요