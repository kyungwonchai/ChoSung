, ê·¸ëŸ¼ìš”! TableLuxPhonestatusLog í…Œì´ë¸”ì˜ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ê¹”ë”í•œ ì›¹ ëŒ€ì‹œë³´ë“œë¥¼ Streamlitì„ ì‚¬ìš©í•˜ì—¬ ìš°ë¶„íˆ¬ì— ê²Œì‹œí•˜ëŠ” ë°©ë²•ì„ ì•„ì£¼ ìƒì„¸í•˜ê²Œ ì•ˆë‚´í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

Streamlitì€ íŒŒì´ì¬(Python)ë§Œìœ¼ë¡œ ì•„ì£¼ ì‰½ê³  ë¹ ë¥´ê²Œ ë°ì´í„° ì‹œê°í™” ì›¹ ì•±ì„ ë§Œë“¤ ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ë„êµ¬ì…ë‹ˆë‹¤. ì•„ë˜ ìˆœì„œëŒ€ë¡œ ë”°ë¼ í•˜ì‹œë©´ ì „ë¬¸ê°€ ìˆ˜ì¤€ì˜ ëª¨ë‹ˆí„°ë§ í˜ì´ì§€ë¥¼ ë§Œë“œì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## 1ë‹¨ê³„: ìš°ë¶„íˆ¬ ì„œë²„ì— í•„ìˆ˜ í”„ë¡œê·¸ë¨ ì„¤ì¹˜í•˜ê¸°
ë¨¼ì €, Streamlitê³¼ MSSQLì„ ì—°ê²°í•˜ëŠ” ë° í•„ìš”í•œ í”„ë¡œê·¸ë¨ë“¤ì„ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

ìš°ë¶„íˆ¬ í„°ë¯¸ë„ì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”.

Bash

# 1. íŒŒì´ì¬ ë° íŒ¨í‚¤ì§€ ê´€ë¦¬ì(pip) ì„¤ì¹˜
sudo apt update
sudo apt install python3-pip -y

# 2. MSSQL ì—°ê²°ì„ ìœ„í•œ ODBC ë“œë¼ì´ë²„ ì„¤ì¹˜ (Microsoft ê³µì‹ ê°€ì´ë“œ)
# ì´ ê³¼ì •ì€ ë³µì¡í•´ ë³´ì´ì§€ë§Œ, ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ìˆœì„œëŒ€ë¡œ ë³µì‚¬/ë¶™ì—¬ë„£ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.
curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
sudo apt-get update
sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17
## 2ë‹¨ê³„: ëŒ€ì‹œë³´ë“œ í”„ë¡œì íŠ¸ ìƒì„± ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
ì´ì œ ëŒ€ì‹œë³´ë“œ ì›¹ ì•±ì„ ë§Œë“¤ í”„ë¡œì íŠ¸ í´ë”ë¥¼ ìƒì„±í•˜ê³  í•„ìš”í•œ íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.

ìš°ë¶„íˆ¬ í„°ë¯¸ë„ì—ì„œ ì•„ë˜ ì‘ì—…ì„ ì§„í–‰í•˜ì„¸ìš”.

Bash

# 1. 'dashboard' ë¼ëŠ” ì´ë¦„ì˜ í´ë”ë¥¼ ë§Œë“¤ê³  ê·¸ ì•ˆìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.
mkdir dashboard
cd dashboard

# 2. í•„ìš”í•œ íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ 3ê°œë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
# streamlit: ì›¹ ì•± í”„ë ˆì„ì›Œí¬
# pandas: ë°ì´í„° ì²˜ë¦¬ ë° ë¶„ì„ ë„êµ¬
# pyodbc: MSSQL ì—°ê²° ë“œë¼ì´ë²„
pip install streamlit pandas pyodbc
## 3ë‹¨ê³„: DB ì—°ê²° ì •ë³´ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ê¸° (secrets.toml)
DB ì ‘ì† ì •ë³´ë¥¼ ì½”ë“œì— ì§ì ‘ ë„£ëŠ” ê²ƒì€ ìœ„í—˜í•©ë‹ˆë‹¤. Streamlitì˜ secrets ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

dashboard í´ë” ì•ˆì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¡œ .streamlit í´ë”ì™€ secrets.toml íŒŒì¼ì„ ìƒì„±í•˜ê³  í¸ì§‘í•©ë‹ˆë‹¤.

Bash

mkdir .streamlit
nano .streamlit/secrets.toml
[ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ í„°ë¯¸ë„ì— ë¶™ì—¬ë„£ê¸°]
db_server, db_name ë“± ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ DB ì •ë³´ë¡œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.

Ini, TOML

# .streamlit/secrets.toml

[database]
driver = "ODBC Driver 17 for SQL Server"
server = "ë‚´ì„œë²„IP"
port = "1433"
name = "ë°ì´í„°ë² ì´ìŠ¤ì´ë¦„"
username = "ì‚¬ìš©ìID"
password = "ë¹„ë°€ë²ˆí˜¸"
[ë¶™ì—¬ë„£ê¸° í›„ ì €ì¥ ë° ì¢…ë£Œ]

Ctrl + X í‚¤ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.

Y í‚¤ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.

Enter í‚¤ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.

## 4ë‹¨ê³„: Streamlit ëŒ€ì‹œë³´ë“œ ì½”ë“œ ì‘ì„±í•˜ê¸° (dashboard.py)
ì´ì œ ì‹¤ì œ ì›¹ í˜ì´ì§€ë¥¼ ê·¸ë¦¬ëŠ” íŒŒì´ì¬ ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. ì´ ì½”ë“œëŠ” 10ì´ˆë§ˆë‹¤ DBì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ í™”ë©´ì„ ìë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.

dashboard í´ë” ì•ˆì—ì„œ nano í¸ì§‘ê¸°ë¡œ dashboard.py íŒŒì¼ì„ ë§Œë“¤ê³  ì•„ë˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.

Bash

nano dashboard.py
[ì•„ë˜ ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ í„°ë¯¸ë„ì— ë¶™ì—¬ë„£ê¸°]

Python

import streamlit as st
import pandas as pd
import pyodbc
import time
from datetime import datetime

# --- í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • ---
st.set_page_config(
    page_title="ì‹¤ì‹œê°„ ì¥ë¹„ ìƒíƒœ ëŒ€ì‹œë³´ë“œ",
    page_icon="ğŸ“¡",
    layout="wide", # ë„“ì€ ë ˆì´ì•„ì›ƒ ì‚¬ìš©
    initial_sidebar_state="collapsed" # ì‚¬ì´ë“œë°” ìˆ¨ê¸°ê¸°
)

# --- DB ì—°ê²° í•¨ìˆ˜ (Streamlit ìºì‹œ ê¸°ëŠ¥ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”) ---
@st.cache_resource(ttl=30) # 30ì´ˆ ë™ì•ˆ ì—°ê²° ì¬ì‚¬ìš©
def get_db_connection():
    # secrets.toml íŒŒì¼ì—ì„œ DB ì •ë³´ ì½ì–´ì˜¤ê¸°
    db = st.secrets["database"]
    connection_string = (
        f"DRIVER={{{db['driver']}}};"
        f"SERVER={db['server']},{db['port']};"
        f"DATABASE={db['name']};"
        f"UID={db['username']};"
        f"PWD={db['password']};"
    )
    return pyodbc.connect(connection_string)

# --- ë°ì´í„° ì¡°íšŒ í•¨ìˆ˜ ---
def fetch_latest_data():
    conn = get_db_connection()
    # ê° DeviceId ë³„ë¡œ ê°€ì¥ ìµœê·¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¿¼ë¦¬
    query = """
        WITH LatestEntries AS (
            SELECT *,
                   ROW_NUMBER() OVER(PARTITION BY DeviceId ORDER BY Timestamp DESC) as rn
            FROM TableLuxPhonestatusLog
        )
        SELECT DeviceId, BatteryLevel, BatteryTemp, IsCharging, ChargeType, BatteryHealth, ApTemp, Timestamp
        FROM LatestEntries
        WHERE rn = 1
        ORDER BY DeviceId;
    """
    df = pd.read_sql(query, conn)
    return df

# --- ëŒ€ì‹œë³´ë“œ UI ê·¸ë¦¬ê¸° ---
st.title("ğŸ“¡ ì‹¤ì‹œê°„ ì¥ë¹„ ìƒíƒœ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ")

# ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ì„ í‘œì‹œí•  ì˜ì—­
last_updated_placeholder = st.empty()

# ë°ì´í„°ë¥¼ í‘œì‹œí•  ë©”ì¸ ì˜ì—­
main_placeholder = st.empty()

# --- 10ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ ë£¨í”„ ---
while True:
    try:
        # ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        df = fetch_latest_data()
        
        # ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
        now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        last_updated_placeholder.text(f"ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {now}")

        # main_placeholder ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ UIë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
        with main_placeholder.container():
            # ì¥ë¹„ë³„ë¡œ ì„¹ì…˜ì„ ë‚˜ëˆ„ì–´ í‘œì‹œ
            for index, row in df.iterrows():
                st.markdown(f"### ğŸ“² ì¥ë¹„ ID: `{row['DeviceId']}`")
                
                # 3ê°œì˜ ì»¬ëŸ¼ìœ¼ë¡œ ë‚˜ëˆ„ì–´ í•µì‹¬ ì •ë³´ í‘œì‹œ
                col1, col2, col3 = st.columns(3)
                col1.metric("ë°°í„°ë¦¬ ì”ëŸ‰ (%)", f"{row['BatteryLevel']}%")
                col2.metric("ë°°í„°ë¦¬ ì˜¨ë„ (Â°C)", f"{row['BatteryTemp']:.1f}Â°C")
                col3.metric("AP ì˜¨ë„ (Â°C)", f"{row['ApTemp']:.1f}Â°C")
                
                # ìƒì„¸ ì •ë³´ í…Œì´ë¸”
                st.subheader("ìƒì„¸ ì •ë³´")
                # ë³´ê¸° ì¢‹ê²Œ ë°ì´í„°ë¥¼ ì¬êµ¬ì„±
                detail_data = {
                    "í•­ëª©": ["ì¶©ì „ ìƒíƒœ", "ì¶©ì „ ë°©ì‹", "ë°°í„°ë¦¬ ê±´ê°• ìƒíƒœ", "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸"],
                    "ê°’": [
                        "âš¡ ì¶©ì „ ì¤‘" if row['IsCharging'] else "ğŸ”‹ ë°©ì „ ì¤‘",
                        row['ChargeType'],
                        row['BatteryHealth'],
                        row['Timestamp'].strftime('%Y-%m-%d %H:%M:%S')
                    ]
                }
                st.table(pd.DataFrame(detail_data).set_index("í•­ëª©"))
                st.markdown("---") # êµ¬ë¶„ì„ 

    except Exception as e:
        st.error(f"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

    # 10ì´ˆ ëŒ€ê¸°
    time.sleep(10)
[ë¶™ì—¬ë„£ê¸° í›„ ì €ì¥ ë° ì¢…ë£Œ]

Ctrl + X í‚¤ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.

Y í‚¤ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.

Enter í‚¤ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.

## 5ë‹¨ê³„: ëŒ€ì‹œë³´ë“œ ì‹¤í–‰ ë° ì›¹ìœ¼ë¡œ ê²Œì‹œí•˜ê¸°
ì´ì œ ë§Œë“  ëŒ€ì‹œë³´ë“œë¥¼ ì›¹ì— ê²Œì‹œí•˜ì—¬ ì–´ë””ì„œë“  ì ‘ì†í•  ìˆ˜ ìˆê²Œ ë§Œë“­ë‹ˆë‹¤. ì´ì „ì— ì‚¬ìš©í•˜ì…¨ë˜ **pm2**ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

ìš°ë¶„íˆ¬ í„°ë¯¸ë„ì—ì„œ ì•„ë˜ ì‘ì—…ì„ ì§„í–‰í•˜ì„¸ìš”.

Bash

# 1. ë°©í™”ë²½ì—ì„œ Streamlitì´ ì‚¬ìš©í•˜ëŠ” 8501ë²ˆ í¬íŠ¸ë¥¼ ì—´ì–´ì¤ë‹ˆë‹¤.
sudo ufw allow 8501

# 2. pm2ë¥¼ ì´ìš©í•´ ëŒ€ì‹œë³´ë“œ ì•±ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.
# 'streamlit-dashboard' ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ dashboard.pyë¥¼ ì‹¤í–‰
pm2 start streamlit -- run dashboard.py --name streamlit-dashboard

# 3. í˜„ì¬ pm2 ì‘ì—… ëª©ë¡ì„ ì €ì¥í•˜ì—¬ ì„œë²„ ì¬ë¶€íŒ… ì‹œì—ë„ ìë™ ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤.
pm2 save
ëª¨ë“  ì‘ì—…ì´ ëë‚¬ìŠµë‹ˆë‹¤!

ì´ì œ PCë‚˜ íœ´ëŒ€í°ì˜ ì›¹ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì— ì•„ë˜ì™€ ê°™ì´ ì…ë ¥í•˜ë©´, ì§ì ‘ ë§Œë“œì‹  ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œì— ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.