using System;
using System.Drawing;
using System.Runtime.InteropServices;
using System.Windows.Forms;

public class CaptureWindow
{
    [DllImport("user32.dll")]
    public static extern IntPtr GetWindowRect(IntPtr hWnd, ref RECT rect);

    [DllImport("gdi32.dll")]
    public static extern bool BitBlt(IntPtr hdcDest, int xDest, int yDest, int wDest, int hDest, IntPtr hdcSource, int xSrc, int ySrc, int rop);

    [DllImport("user32.dll")]
    public static extern IntPtr GetDC(IntPtr hWnd);

    [DllImport("user32.dll")]
    public static extern int ReleaseDC(IntPtr hWnd, IntPtr hDC);

    public struct RECT
    {
        public int Left;
        public int Top;
        public int Right;
        public int Bottom;
    }
    
    public static Bitmap Capture(IntPtr hWnd)
    {
        RECT rect = new RECT();
        GetWindowRect(hWnd, ref rect);
        int width = rect.Right - rect.Left;
        int height = rect.Bottom - rect.Top;

        Bitmap bmp = new Bitmap(width, height);
        Graphics g = Graphics.FromImage(bmp);
        IntPtr hdcBitmap = g.GetHdc();
        IntPtr hdcWindow = GetDC(hWnd);

        BitBlt(hdcBitmap, 0, 0, width, height, hdcWindow, 0, 0, 0x00CC0020);

        g.ReleaseHdc(hdcBitmap);
        ReleaseDC(hWnd, hdcWindow);
        return bmp;
    }
}

public class MainForm : Form
{
    public MainForm()
    {
        Button btn = new Button();
        btn.Text = "Capture";
        btn.Click += Btn_Click;
        Controls.Add(btn);
    }

    private void Btn_Click(object sender, EventArgs e)
    {
        IntPtr hWnd = this.Handle; // 대상 윈도우 핸들
        Bitmap bmp = CaptureWindow.Capture(hWnd);
        bmp.Save(@"C:\agent\capture.png");
    }

    static void Main()
    {
        Application.Run(new MainForm());
    }
}
