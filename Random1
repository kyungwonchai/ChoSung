from flask import Flask, request, jsonify, send_file
import pymssql
import io

app = Flask(__name__)

def save_to_db(password, image):
    conn = pymssql.connect(server='서버명', user='사용자명', password='비밀번호', database='데이터베이스명', port='포트번호')
    cursor = conn.cursor()

    # 프로시저1에 맞게 변경하십시오.
    cursor.execute("EXEC 프로시저1 %s, %s", (password, image.read()))
    conn.commit()

@app.route('/upload', methods=['POST'])
def upload():
    password = request.form['password']
    image = request.files['image']
    save_to_db(password, image)

    return '', 204

def get_images_from_db(password):
    conn = pymssql.connect(server='서버명', user='사용자명', password='비밀번호', database='데이터베이스명', port='포트번호')
    cursor = conn.cursor()

    cursor.execute("SELECT image_name FROM Table1 WHERE password = %s ORDER BY image_input_time DESC", password)
    rows = cursor.fetchall()

    return [dict(name=row.image_name) for row in rows]

@app.route('/images', methods=['GET'])
def get_images():
    password = request.args.get('password')
    images = get_images_from_db(password)

    return jsonify(images)

def get_image_from_db(image_name):
    conn = pymssql.connect(server='서버명', user='사용자명', password='비밀번호', database='데이터베이스명', port='포트번호')
    cursor = conn.cursor()

    cursor.execute("SELECT image FROM Table1 WHERE image_name = %s", image_name)
    row = cursor.fetchone()

    if row is not None:
        return io.BytesIO(row.image)

    return None

@app.route('/image/<string:image_name>', methods=['GET'])
def get_image(image_name):
    image = get_image_from_db(image_name)

    if image is None:
        return '', 404

    return send_file(image, mimetype='image/jpeg')
