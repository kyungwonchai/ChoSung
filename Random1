using System;
using System.Collections.Generic;
using System.IO;
using System.Net.Sockets;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace RouterMiddleACRService
{
    public class LogService
    {
        private static LogService _instance;
        private readonly string _logDirectory;
        private TcpClient _tcpClient;
        private NetworkStream _networkStream;
        private string _serverIp = "127.0.0.1"; // 메인 UI 서버 IP
        private int _serverPort = 9000; // 메인 UI 서버 포트
        private CancellationTokenSource _cancellationTokenSource;
        private bool _isConnected = false;
        private Queue<string> _logQueue = new Queue<string>(); // 로그 메시지 큐

        public static LogService Instance
        {
            get
            {
                if (_instance == null)
                {
                    _instance = new LogService();
                }
                return _instance;
            }
        }

        private LogService()
        {
            _logDirectory = Path.Combine("C:\\Logs", "RouterMiddleACRService", DateTime.Now.ToString("yyyyMM"));
            Directory.CreateDirectory(_logDirectory);
        }

        public void Start()
        {
            _cancellationTokenSource = new CancellationTokenSource();
            Task.Run(() => ConnectToServer(_cancellationTokenSource.Token)); // 서버 연결을 시작
        }

        public void Stop()
        {
            _cancellationTokenSource.Cancel();
            _networkStream?.Close();
            _tcpClient?.Close();
        }

        private async Task ConnectToServer(CancellationToken cancellationToken)
        {
            while (!cancellationToken.IsCancellationRequested)
            {
                if (!_isConnected)
                {
                    try
                    {
                        _tcpClient = new TcpClient();
                        await _tcpClient.ConnectAsync(_serverIp, _serverPort); // 서버에 연결
                        _networkStream = _tcpClient.GetStream();
                        _isConnected = true;
                        Console.WriteLine("Connected to main UI server.");
                        
                        // 재연결 후 로그 큐에 저장된 메시지 전송
                        await SendQueuedLogs();
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error connecting to server: {ex.Message}");
                        _isConnected = false;
                        await Task.Delay(5000); // 5초 후 재연결 시도
                    }
                }
                else
                {
                    await Task.Delay(1000); // 연결이 되어 있을 때 1초마다 상태 체크
                }
            }
        }

        public void LogMessage(string message)
        {
            try
            {
                string logEntry = $"{DateTime.Now:yyyy-MM-dd HH:mm:ss} - {message}";
                string logFilePath = Path.Combine(_logDirectory, $"{DateTime.Now:yyyyMMdd}_ServiceLog.txt");

                File.AppendAllText(logFilePath, logEntry + Environment.NewLine);

                if (_isConnected && _tcpClient != null && _tcpClient.Connected)
                {
                    SendLogMessage(logEntry); // 연결된 경우 바로 전송
                }
                else
                {
                    _logQueue.Enqueue(logEntry); // 연결되지 않은 경우 로그 큐에 저장
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error logging message: {ex.Message}");
            }
        }

        private async Task SendLogMessage(string message)
        {
            try
            {
                if (_networkStream != null)
                {
                    byte[] data = Encoding.UTF8.GetBytes(message);
                    await _networkStream.WriteAsync(data, 0, data.Length); // 메시지 전송
                    Console.WriteLine("Log message sent to main UI server.");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error sending log message: {ex.Message}");
                _isConnected = false; // 전송 실패 시 연결 끊김으로 처리
            }
        }

        private async Task SendQueuedLogs()
        {
            while (_logQueue.Count > 0 && _isConnected)
            {
                var logMessage = _logQueue.Dequeue();
                await SendLogMessage(logMessage); // 큐에 저장된 로그 메시지 전송
            }
        }
    }
}
