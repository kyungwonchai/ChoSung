MSSQL 2014 프로시저 생성 코드
📌 특정 라인의 최근 날짜에 있는 모델(중복 없이) 목록을 가져오고,
📌 각 모델별 최근 10개 데이터에서 각 컬럼의 최소값을 조회
✅ 🔹 1. 프로시저 생성 (MSSQL 2014)
sql
코드 복사
CREATE PROCEDURE Get_Min_Data_By_Recent_Models
    @라인명 NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @최신날짜 DATE;

    -- 📌 특정 라인의 가장 최신 날짜 가져오기
    SELECT TOP 1 @최신날짜 = CAST(time1 AS DATE)
    FROM dbo.ExcelData
    WHERE 라인 = @라인명
    ORDER BY time1 DESC;

    -- 📌 특정 라인의 해당 날짜에 등록된 유니크한 모델 목록 조회
    WITH LatestModels AS (
        SELECT DISTINCT 모델
        FROM dbo.ExcelData
        WHERE 라인 = @라인명 AND CAST(time1 AS DATE) = @최신날짜
    )

    -- 📌 각 모델별 최근 10개 데이터 중 각 컬럼의 최소값 조회
    SELECT 
        e.모델,
        MAX(e.time1) AS 최신시간,
        ISNULL(MIN(CASE WHEN BCT1_1 >= 1 THEN BCT1_1 ELSE NULL END), 0) AS BCT1_1,
        ISNULL(MIN(CASE WHEN BCT1_2 >= 1 THEN BCT1_2 ELSE NULL END), 0) AS BCT1_2,
        ISNULL(MIN(CASE WHEN BCT1_3 >= 1 THEN BCT1_3 ELSE NULL END), 0) AS BCT1_3,
        ISNULL(MIN(CASE WHEN BCT1_4 >= 1 THEN BCT1_4 ELSE NULL END), 0) AS BCT1_4,
        ISNULL(MIN(CASE WHEN BCT1_5 >= 1 THEN BCT1_5 ELSE NULL END), 0) AS BCT1_5,
        ISNULL(MIN(CASE WHEN BCT1_6 >= 1 THEN BCT1_6 ELSE NULL END), 0) AS BCT1_6,
        ISNULL(MIN(CASE WHEN BCT1_7 >= 1 THEN BCT1_7 ELSE NULL END), 0) AS BCT1_7,
        ISNULL(MIN(CASE WHEN BCT1_8 >= 1 THEN BCT1_8 ELSE NULL END), 0) AS BCT1_8,

        ISNULL(MIN(CASE WHEN TCT1_1 >= 1 THEN TCT1_1 ELSE NULL END), 0) AS TCT1_1,
        ISNULL(MIN(CASE WHEN TCT1_2 >= 1 THEN TCT1_2 ELSE NULL END), 0) AS TCT1_2,
        ISNULL(MIN(CASE WHEN TCT1_3 >= 1 THEN TCT1_3 ELSE NULL END), 0) AS TCT1_3,
        ISNULL(MIN(CASE WHEN TCT1_4 >= 1 THEN TCT1_4 ELSE NULL END), 0) AS TCT1_4,
        ISNULL(MIN(CASE WHEN TCT1_5 >= 1 THEN TCT1_5 ELSE NULL END), 0) AS TCT1_5,
        ISNULL(MIN(CASE WHEN TCT1_6 >= 1 THEN TCT1_6 ELSE NULL END), 0) AS TCT1_6,
        ISNULL(MIN(CASE WHEN TCT1_7 >= 1 THEN TCT1_7 ELSE NULL END), 0) AS TCT1_7,
        ISNULL(MIN(CASE WHEN TCT1_8 >= 1 THEN TCT1_8 ELSE NULL END), 0) AS TCT1_8

    FROM dbo.ExcelData e
    INNER JOIN LatestModels lm ON e.모델 = lm.모델
    WHERE e.라인 = @라인명 
        AND CAST(e.time1 AS DATE) = @최신날짜
    GROUP BY e.모델;
END;
✅ 🔹 2. 프로시저 실행 방법
sql
코드 복사
EXEC Get_Min_Data_By_Recent_Models @라인명 = 'L1';
✅ 🔹 3. 프로시저 설명
특정 라인의 최신 날짜(time1의 날짜)를 조회
해당 날짜에 포함된 모델 목록(중복 제거)을 가져옴
각 모델별 최근 10개 데이터에서 각 컬럼(BCT1_1 ~ TCT1_8)의 최소값을 계산
모델별 최신 시간(MAX(time1)) 포함
✅ Streamlit에서 프로시저 호출하여 표시
python
코드 복사
import streamlit as st
import pymssql
import pandas as pd

# 📌 MSSQL 연결 설정
DB_CONFIG = {
    "server": "서버주소",
    "user": "사용자명",
    "password": "비밀번호",
    "database": "DB이름"
}

# 📌 특정 라인의 최신 날짜 모델별 최소값 조회
def get_recent_models_min_data(line_name):
    conn = pymssql.connect(**DB_CONFIG)
    cursor = conn.cursor(as_dict=True)

    cursor.execute("EXEC Get_Min_Data_By_Recent_Models %s", (line_name,))
    data = cursor.fetchall()
    conn.close()

    return data

# 📌 라인 목록 가져오기
def get_lines():
    conn = pymssql.connect(**DB_CONFIG)
    cursor = conn.cursor()
    cursor.execute("SELECT DISTINCT 라인 FROM ExcelData ORDER BY 라인")
    lines = [row[0] for row in cursor.fetchall()]
    conn.close()
    return lines

# 📌 Streamlit UI
st.title("라인별 모델 데이터 조회")

# 📌 라인 선택
lines = get_lines()
selected_line = st.sidebar.selectbox("라인 선택", lines)

# 📌 데이터 조회
if selected_line:
    data = get_recent_models_min_data(selected_line)

    if data:
        df = pd.DataFrame(data)
        st.table(df)
    else:
        st.warning("해당 라인에 대한 데이터가 없습니다.")
✅ 설치 및 실행
bash
코드 복사
pip install streamlit pymssql pandas
streamlit run app.py
✅ 출력 예시
모델	최신시간	1호기	2호기	3호기	4호기	5호기	6호기	7호기	8호기
A100	2025-03-18 14:10	9	4	6	7	10	4	7	6