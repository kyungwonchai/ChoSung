SELECT 
    rp.partcode,
    rp.partcount,
    rp.lastupdate,
    SUM(CASE WHEN pm.inout_value = 'in' THEN pm.inout_count 
             WHEN pm.inout_value = 'incancel' THEN -pm.inout_count 
             ELSE 0 END) AS total_in,
    SUM(CASE WHEN pm.inout_value = 'out' THEN -pm.inout_count 
             WHEN pm.inout_value = 'outcancel' THEN pm.inout_count 
             ELSE 0 END) AS total_out
FROM 
    smd.tbl_repare_part_remain rp
JOIN 
    smd.tbl_repare_partmanage pm ON rp.partcode = pm.partcode
WHERE 
    pm.inputdate >= DATE_SUB(CURDATE(), INTERVAL DAYOFWEEK(CURDATE())-1 DAY)
    AND pm.inputdate < DATE_ADD(DATE_SUB(CURDATE(), INTERVAL DAYOFWEEK(CURDATE())-1 DAY), INTERVAL 7 DAY)
GROUP BY 
    rp.partcode, rp.partcount, rp.lastupdate;
