ì´ì œ ë³´ë‚¸ ë©”ì‹œì§€(SendAndReceiveAsync())ê°€ ìˆìœ¼ë©´ ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬í•˜ê³ , ì—†ë‹¤ë©´ ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬í•˜ë„ë¡ ì™„ë²½íˆ ìˆ˜ì •í• ê²Œ.

âœ… ëª©í‘œ
SendAndReceiveAsync()ë¡œ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ìˆëŠ” ê²½ìš° â†’ ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬.

SendAndReceiveAsync()ë¡œ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì—†ëŠ” ê²½ìš° â†’ ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬.

ReceiveLoopAsync()ì—ì„œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ê°ì§€í•˜ê³  ì •í™•íˆ ë¶„ê¸° ì²˜ë¦¬.

ğŸ”¥ ì½”ë“œ ìˆ˜ì • (ì „ì²´ ì½”ë“œ)
csharp
ì½”ë“œ ë³µì‚¬
using System;
using System.Collections.Concurrent;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;

public class ExpertSocketClient
{
    private TcpClient _client; // ì„œë²„ì™€ ì—°ê²°í•˜ëŠ” TcpClient ê°ì²´
    private NetworkStream _stream; // ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ê¸° ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ìŠ¤íŠ¸ë¦¼
    private byte[] _buffer = new byte[1024]; // ìˆ˜ì‹  ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë²„í¼ (1KB í¬ê¸°)
    private bool _isConnected = false; // ì„œë²„ì™€ì˜ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

    // ìš”ì²­ IDì™€ ì‘ë‹µ TaskCompletionSourceë¥¼ ë§¤í•‘í•˜ê¸° ìœ„í•œ ë”•ì…”ë„ˆë¦¬
    private ConcurrentDictionary<string, TaskCompletionSource<string>> _responseTasks 
        = new ConcurrentDictionary<string, TaskCompletionSource<string>>();

    // ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ê¸°ë¡í•˜ê¸° ìœ„í•œ ë”•ì…”ë„ˆë¦¬ (ë§¤ì¹­ì„ ìœ„í•´ ì‚¬ìš©)
    private ConcurrentDictionary<string, string> _sentMessages = new ConcurrentDictionary<string, string>();

    /// <summary>
    /// ì„œë²„ì— ì—°ê²°í•˜ê³  ìˆ˜ì‹  ë£¨í”„ë¥¼ ì‹œì‘í•œë‹¤.
    /// </summary>
    public async Task ConnectAsync(string ip, int port)
    {
        _client = new TcpClient();
        await _client.ConnectAsync(ip, port);
        _stream = _client.GetStream();
        _isConnected = true;

        Console.WriteLine($"[INFO] Connected to {ip}:{port}");

        // í•­ìƒ ëŒì•„ê°€ëŠ” ìˆ˜ì‹  ë£¨í”„ë¥¼ ë¹„ë™ê¸°ë¡œ ì‹¤í–‰
        _ = Task.Run(ReceiveLoopAsync); 
    }

    /// <summary>
    /// ì„œë²„ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ì‘ë‹µì„ ê¸°ë‹¤ë¦°ë‹¤.
    /// </summary>
    public async Task<string> SendAndReceiveAsync(string message)
    {
        if (!_isConnected)
            return "[ERROR] Not connected.";

        string wrappedMessage = '\x02' + message + '\x03';
        byte[] data = Encoding.ASCII.GetBytes(wrappedMessage);

        var tcs = new TaskCompletionSource<string>();

        // ê³ ìœ í•œ ìš”ì²­ ID ìƒì„±
        string requestId = Guid.NewGuid().ToString("N");

        // ë³´ë‚¸ ë©”ì‹œì§€ì™€ ìš”ì²­ IDë¥¼ ë§¤ì¹­í•˜ì—¬ ì €ì¥
        _responseTasks.TryAdd(requestId, tcs);
        _sentMessages.TryAdd(requestId, message); 

        // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
        await _stream.WriteAsync(data, 0, data.Length);
        LogMessage($"[SEND] [{requestId}] {message}");

        // ì‘ë‹µì„ ê¸°ë‹¤ë¦¼
        string response = await tcs.Task;
        _responseTasks.TryRemove(requestId, out _);
        _sentMessages.TryRemove(requestId, out _);

        return response;
    }

    /// <summary>
    /// í•­ìƒ ëŒì•„ê°€ëŠ” ìˆ˜ì‹  ë£¨í”„. ëª¨ë“  ë©”ì‹œì§€ë¥¼ ê°ì§€í•˜ê³  ì²˜ë¦¬í•œë‹¤.
    /// </summary>
    private async Task ReceiveLoopAsync()
    {
        while (_isConnected)
        {
            try
            {
                int bytesRead = await _stream.ReadAsync(_buffer, 0, _buffer.Length);

                if (bytesRead == 0)
                {
                    Console.WriteLine("[INFO] Server disconnected.");
                    _isConnected = false;
                    break;
                }

                // ë°›ì€ ë©”ì‹œì§€ ë³€í™˜
                string received = Encoding.ASCII.GetString(_buffer, 0, bytesRead).Trim('\x02', '\x03');
                LogMessage($"[RECV] {received}");

                bool matched = false;

                // ì‘ë‹µ ë§¤ì¹­ ê²€ì‚¬
                foreach (var key in _responseTasks.Keys)
                {
                    if (_responseTasks.TryRemove(key, out var tcs))
                    {
                        if (_sentMessages.TryGetValue(key, out var sentMessage))
                        {
                            LogMessage($"[MATCHED] Sent: {sentMessage} | Received: {received}");
                            matched = true;
                            tcs.SetResult(received); // ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬
                            break;
                        }
                    }
                }

                // ë³´ë‚¸ ë©”ì‹œì§€ë¡œ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬
                if (!matched)
                {
                    LogMessage($"[NOTICE] ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬ë¨: {received}");
                    HandlePreemptiveSignal(received); // ì„ ì œ ì‹ í˜¸ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[ERROR] ReceiveLoop exception: {ex.Message}");
                _isConnected = false;
            }
        }
    }

    /// <summary>
    /// ì„ ì œ ì‹ í˜¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ (ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì—†ì„ ë•Œ í˜¸ì¶œë¨)
    /// </summary>
    private void HandlePreemptiveSignal(string message)
    {
        Console.WriteLine($"[PREEMPTIVE] ì²˜ë¦¬ëœ ì„ ì œ ì‹ í˜¸: {message}");
        // ì¶”ê°€ë¡œ ì›í•˜ëŠ” ì²˜ë¦¬ë¥¼ ì—¬ê¸°ì„œ ì‘ì„±
    }

    /// <summary>
    /// ë©”ì‹œì§€ë¥¼ ê¸°ë¡í•˜ëŠ” í•¨ìˆ˜. (ì½˜ì†” ë˜ëŠ” íŒŒì¼ë¡œ ë¡œê·¸ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆìŒ)
    /// </summary>
    private void LogMessage(string message)
    {
        Console.WriteLine(message);
    }

    /// <summary>
    /// ì„œë²„ ì—°ê²°ì„ í•´ì œí•œë‹¤.
    /// </summary>
    public void Disconnect()
    {
        _isConnected = false;
        _stream?.Close();
        _client?.Close();
        Console.WriteLine("[INFO] Disconnected.");
    }
}
ğŸ“Œ ì½”ë“œ ì„¤ëª… (ì™„ë²½íˆ ì´í•´ì‹œí‚¤ê¸°)
ì¼ë°˜ ì‘ë‹µ ì²˜ë¦¬ (SendAndReceiveAsync())

ìš”ì²­ IDë¥¼ ìƒì„±í•˜ê³  _sentMessagesì— ê¸°ë¡.

_responseTasksë¡œ ì‘ë‹µì„ ë¹„ë™ê¸°ë¡œ ê¸°ë‹¤ë¦¼.

ì„ ì œ ì‹ í˜¸ ì²˜ë¦¬ (ReceiveLoopAsync())

ë°›ì€ ë©”ì‹œì§€ê°€ _responseTasksì— ë“±ë¡ëœ ìš”ì²­ IDë¡œ ë§¤ì¹­ë˜ë©´ ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬.

ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ë©”ì‹œì§€ëŠ” ëª¨ë‘ ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬ (HandlePreemptiveSignal()).

ë¡œê·¸ ê¸°ë¡ (LogMessage())

ë³´ë‚¸ ë©”ì‹œì§€, ë°›ì€ ë©”ì‹œì§€, ë§¤ì¹­ ì—¬ë¶€ë¥¼ ëª¨ë‘ ê¸°ë¡.

ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬ëœ ë©”ì‹œì§€ë„ ë³„ë„ë¡œ ê¸°ë¡.

ğŸ’¯ ê²°ë¡ 
âœ… ë³´ë‚¸ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬.

âœ… ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬.

âœ… ëª¨ë“  ë©”ì‹œì§€ ë¡œê·¸ë¡œ í™•ì¸ ê°€ëŠ¥.
