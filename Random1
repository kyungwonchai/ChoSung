가한 WPF XAML 코드와 C# 코드입니다. 이 버튼을 클릭하면 해당 콤보박스의 선택이 제거되고, 연결된 포트가 닫히며, 콤보박스의 텍스트 색상이 기본 색상(검정색)으로 돌아갑니다.

1. XAML (MainWindow.xaml)
xml
코드 복사
<Window x:Class="ComPortScanner.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="COM Port Scanner" Height="500" Width="700">
    <Grid>
        <TextBlock Text="스캐너 포트:" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10,10,0,0"/>
        <ComboBox Name="ScannerPortComboBox" HorizontalAlignment="Left" VerticalAlignment="Top" Width="200" Margin="100,10,0,0" SelectionChanged="ScannerPortComboBox_SelectionChanged"/>
        <Button Content="X" HorizontalAlignment="Left" VerticalAlignment="Top" Width="25" Margin="310,10,0,0" Click="ClearScannerPortSelection_Click"/>

        <TextBlock Text="보낼 포트 1:" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10,50,0,0"/>
        <ComboBox Name="TargetPortComboBox1" HorizontalAlignment="Left" VerticalAlignment="Top" Width="200" Margin="100,50,0,0" SelectionChanged="TargetPortComboBox_SelectionChanged"/>
        <Button Content="X" HorizontalAlignment="Left" VerticalAlignment="Top" Width="25" Margin="310,50,0,0" Click="ClearTargetPortSelection_Click"/>

        <TextBlock Text="보낼 포트 2:" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10,90,0,0"/>
        <ComboBox Name="TargetPortComboBox2" HorizontalAlignment="Left" VerticalAlignment="Top" Width="200" Margin="100,90,0,0" SelectionChanged="TargetPortComboBox_SelectionChanged"/>
        <Button Content="X" HorizontalAlignment="Left" VerticalAlignment="Top" Width="25" Margin="310,90,0,0" Click="ClearTargetPortSelection_Click"/>

        <TextBlock Text="보낼 포트 3:" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10,130,0,0"/>
        <ComboBox Name="TargetPortComboBox3" HorizontalAlignment="Left" VerticalAlignment="Top" Width="200" Margin="100,130,0,0" SelectionChanged="TargetPortComboBox_SelectionChanged"/>
        <Button Content="X" HorizontalAlignment="Left" VerticalAlignment="Top" Width="25" Margin="310,130,0,0" Click="ClearTargetPortSelection_Click"/>

        <TextBlock Text="보낼 포트 4:" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10,170,0,0"/>
        <ComboBox Name="TargetPortComboBox4" HorizontalAlignment="Left" VerticalAlignment="Top" Width="200" Margin="100,170,0,0" SelectionChanged="TargetPortComboBox_SelectionChanged"/>
        <Button Content="X" HorizontalAlignment="Left" VerticalAlignment="Top" Width="25" Margin="310,170,0,0" Click="ClearTargetPortSelection_Click"/>

        <TextBlock Text="보낼 포트 5:" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10,210,0,0"/>
        <ComboBox Name="TargetPortComboBox5" HorizontalAlignment="Left" VerticalAlignment="Top" Width="200" Margin="100,210,0,0" SelectionChanged="TargetPortComboBox_SelectionChanged"/>
        <Button Content="X" HorizontalAlignment="Left" VerticalAlignment="Top" Width="25" Margin="310,210,0,0" Click="ClearTargetPortSelection_Click"/>

        <Button Content="Refresh Ports" HorizontalAlignment="Left" VerticalAlignment="Top" Width="100" Margin="350,10,0,0" Click="RefreshPorts_Click"/>

        <TextBox Name="DataTextBox" HorizontalAlignment="Left" VerticalAlignment="Top" Width="420" Height="50" Margin="10,250,0,0"/>
        <Button Content="Send Data" HorizontalAlignment="Left" VerticalAlignment="Top" Width="100" Margin="440,250,0,0" Click="SendData_Click"/>
        <TextBlock Name="StatusTextBlock" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10,310,0,0" Width="500" Height="30" Text="Status: Not Connected"/>

        <!-- 로그 표시용 ListBox -->
        <ListBox Name="LogListBox" HorizontalAlignment="Left" VerticalAlignment="Top" Width="560" Height="150" Margin="10,350,0,0"/>
    </Grid>
</Window>
2. C# (MainWindow.xaml.cs)
csharp
코드 복사
using System;
using System.Collections.Generic;
using System.IO.Ports;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;

namespace ComPortScanner
{
    public partial class MainWindow : Window
    {
        private SerialPort _scannerPort; // 스캐너가 연결된 시리얼 포트 객체
        private SerialPort[] _targetPorts = new SerialPort[5]; // 데이터를 전송할 최대 5개의 포트
        private const int MaxLogCount = 100; // 로그 표시의 최대 개수
        private const string SettingsFilePath = @"C:\agent\scanvaluetran\settings.config"; // 설정 파일 경로
        private Configuration config;

        public MainWindow()
        {
            InitializeComponent();
            try
            {
                EnsureSettingsFileExists(); // 설정 파일이 존재하지 않으면 생성
                LoadConfiguration(); // 설정 파일을 불러옴
                LoadLastUsedPorts(); // 마지막으로 사용된 포트 설정 불러오기
                RefreshPorts(); // 포트 목록 갱신
            }
            catch (Exception ex)
            {
                LogMessage($"프로그램 초기화 실패: {ex.Message}");
                MessageBox.Show($"프로그램 초기화 중 오류가 발생했습니다: {ex.Message}", "오류", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void EnsureSettingsFileExists()
        {
            try
            {
                // 설정 파일이 있는 디렉토리가 없으면 생성
                string directory = System.IO.Path.GetDirectoryName(SettingsFilePath);
                if (!System.IO.Directory.Exists(directory))
                {
                    System.IO.Directory.CreateDirectory(directory);
                }

                // 설정 파일이 없으면 생성
                if (!System.IO.File.Exists(SettingsFilePath))
                {
                    var configFileMap = new System.Configuration.ExeConfigurationFileMap { ExeConfigFilename = SettingsFilePath };
                    Configuration config = System.Configuration.ConfigurationManager.OpenMappedExeConfiguration(configFileMap, System.Configuration.ConfigurationUserLevel.None);

                    config.Save(System.Configuration.ConfigurationSaveMode.Full);
                }
            }
            catch (Exception ex)
            {
                LogMessage($"설정 파일 생성 중 오류 발생: {ex.Message}");
                MessageBox.Show($"설정 파일 생성 중 오류가 발생했습니다: {ex.Message}", "오류", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void LoadConfiguration()
        {
            try
            {
                var configFileMap = new System.Configuration.ExeConfigurationFileMap { ExeConfigFilename = SettingsFilePath };
                config = System.Configuration.ConfigurationManager.OpenMappedExeConfiguration(configFileMap, System.Configuration.ConfigurationUserLevel.None);
            }
            catch (Exception ex)
            {
                LogMessage($"설정 파일 불러오기 중 오류 발생: {ex.Message}");
                MessageBox.Show($"설정 파일 불러오기 중 오류가 발생했습니다: {ex.Message}", "오류", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void LoadLastUsedPorts()
        {
            // 스캐너 포트 불러오기
            string lastUsedScannerPort = GetSetting("LastUsedScannerPort");
            if (!string.IsNullOrEmpty(lastUsedScannerPort) && SerialPort.GetPortNames().Contains(lastUsedScannerPort))
            {
                ScannerPortComboBox.SelectedItem = lastUsedScannerPort;
                OpenPort(ref _scannerPort, lastUsedScannerPort, ScannerPortComboBox);
            }
            else
            {
                LogMessage("마지막으로 사용한 스캐너 포트를 찾을 수 없거나 포트가 존재하지 않습니다.");
            }

            // 보낼 포트 불러오기 (최대 5개)
            for (int i = 0; i < _targetPorts.Length; i++)
            {
                string key = $"LastUsedTargetPort{i + 1}";
                string lastUsedTargetPort = GetSetting(key);
                ComboBox targetComboBox = GetTargetPortComboBox(i);

                if (!string.IsNullOrEmpty(lastUsedTargetPort) && SerialPort.GetPortNames().Contains(lastUsedTargetPort))
                {
                    targetComboBox.SelectedItem = lastUsedTargetPort;
                    OpenPort(ref _targetPorts[i], lastUsedTargetPort, targetComboBox);
                }
                else
                {
                    LogMessage($"마지막으로 사용한 보낼 포트 {i + 1}를 찾을 수 없거나 포트가 존재하지 않습니다.");
                }
            }
        }

        private string GetSetting(string key)
        {
            if (config.AppSettings.Settings[key] == null)
            {
                config.AppSettings.Settings.Add(key, string.Empty);
                config.Save(System.Configuration.ConfigurationSaveMode.Modified);
            }
            return config.AppSettings.Settings[key].Value;
        }

        private void SaveSetting(string key, string value)
        {
            if (config.AppSettings.Settings[key] != null)
            {
                config.AppSettings.Settings[key].Value = value;
            }
            else
            {
                config.AppSettings.Settings.Add(key, value);
            }
            config.Save(System.Configuration.ConfigurationSaveMode.Modified);
        }

        private void RefreshPorts()
        {
            try
            {
                // 현재 사용 가능한 COM 포트 목록을 모든 ComboBox에 업데이트
                var portNames = SerialPort.GetPortNames();
                ScannerPortComboBox.ItemsSource = portNames;
                TargetPortComboBox1.ItemsSource = portNames;
                TargetPortComboBox2.ItemsSource = portNames;
                TargetPortComboBox3.ItemsSource = portNames;
                TargetPortComboBox4.ItemsSource = portNames;
                TargetPortComboBox5.ItemsSource = portNames;

                LogMessage("COM 포트 목록이 갱신되었습니다.");
            }
            catch (Exception ex)
            {
                LogMessage($"포트 목록 갱신 중 오류 발생: {ex.Message}");
                MessageBox.Show($"포트 목록 갱신 중 오류가 발생했습니다: {ex.Message}", "오류", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void RefreshPorts_Click(object sender, RoutedEventArgs e)
        {
            RefreshPorts();
        }

        private void OpenPort(ref SerialPort serialPort, string portName, ComboBox comboBox)
        {
            try
            {
                // 이미 포트가 열려 있는 경우 닫고 새 포트를 엽니다.
                if (serialPort != null && serialPort.IsOpen)
                {
                    serialPort.Close();
                }

                // 선택된 포트로 시리얼 포트를 설정하고 엽니다.
                serialPort = new SerialPort(portName, 9600, Parity.None, 8, StopBits.One);
                serialPort.Open();
                comboBox.Foreground = Brushes.Blue; // 정상적으로 열렸을 때 파란색 표시
                LogMessage($"포트 {portName}가 열렸습니다.");

                // 포트가 스캐너 포트인지 확인하고, 해당 키로 저장
                if (comboBox == ScannerPortComboBox)
                {
                    SaveSetting("LastUsedScannerPort", portName);
                }
                else
                {
                    int index = GetTargetPortComboBoxIndex(comboBox);
                    SaveSetting($"LastUsedTargetPort{index + 1}", portName);
                }
            }
            catch (Exception ex)
            {
                comboBox.Foreground = Brushes.Red; // 포트를 열지 못했을 때 빨간색 표시
                LogMessage($"포트 {portName}를 여는 데 실패했습니다: {ex.Message}");
            }
        }

        private void ClosePort(ref SerialPort serialPort, ComboBox comboBox)
        {
            try
            {
                if (serialPort != null && serialPort.IsOpen)
                {
                    serialPort.Close();
                    comboBox.Foreground = Brushes.Black; // 포트가 닫혔을 때 텍스트 색상 초기화
                    LogMessage($"포트 {serialPort.PortName}가 닫혔습니다.");
                }
            }
            catch (Exception ex)
            {
                LogMessage($"포트를 닫는 중 오류가 발생했습니다: {ex.Message}");
            }
        }

        private void ScannerPortComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (ScannerPortComboBox.SelectedItem != null)
            {
                string selectedPort = ScannerPortComboBox.SelectedItem.ToString();
                OpenPort(ref _scannerPort, selectedPort, ScannerPortComboBox);
            }
        }

        private void TargetPortComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            ComboBox comboBox = (ComboBox)sender;
            int index = GetTargetPortComboBoxIndex(comboBox);

            if (comboBox.SelectedItem != null)
            {
                string selectedPort = comboBox.SelectedItem.ToString();
                OpenPort(ref _targetPorts[index], selectedPort, comboBox);
            }
        }

        private int GetTargetPortComboBoxIndex(ComboBox comboBox)
        {
            // 각 ComboBox에 대해 인덱스를 반환
            if (comboBox == TargetPortComboBox1) return 0;
            if (comboBox == TargetPortComboBox2) return 1;
            if (comboBox == TargetPortComboBox3) return 2;
            if (comboBox == TargetPortComboBox4) return 3;
            if (comboBox == TargetPortComboBox5) return 4;
            return -1;
        }

        private ComboBox GetTargetPortComboBox(int index)
        {
            // 인덱스에 따라 ComboBox를 반환
            switch (index)
            {
                case 0: return TargetPortComboBox1;
                case 1: return TargetPortComboBox2;
                case 2: return TargetPortComboBox3;
                case 3: return TargetPortComboBox4;
                case 4: return TargetPortComboBox5;
                default: return null;
            }
        }

        private void ClearScannerPortSelection_Click(object sender, RoutedEventArgs e)
        {
            // 스캐너 포트 선택 취소
            ScannerPortComboBox.SelectedItem = null;
            ClosePort(ref _scannerPort, ScannerPortComboBox);
        }

        private void ClearTargetPortSelection_Click(object sender, RoutedEventArgs e)
        {
            // 보낼 포트 선택 취소
            Button button = (Button)sender;
            int index = -1;
            if (button == TargetPortComboBox1) index = 0;
            else if (button == TargetPortComboBox2) index = 1;
            else if (button == TargetPortComboBox3) index = 2;
            else if (button == TargetPortComboBox4) index = 3;
            else if (button == TargetPortComboBox5) index = 4;

            if (index >= 0)
            {
                var comboBox = GetTargetPortComboBox(index);
                comboBox.SelectedItem = null;
                ClosePort(ref _targetPorts[index], comboBox);
            }
        }

        private void SendData_Click(object sender, RoutedEventArgs e)
        {
            if (_scannerPort != null && _scannerPort.IsOpen)
            {
                try
                {
                    string data = DataTextBox.Text;
                    _scannerPort.WriteLine(data); // 데이터를 스캐너 포트로 전송
                    LogMessage($"스캐너 포트로 데이터 전송: {data}");

                    // 특정 조건이 충족되면 데이터를 다른 포트로 전달
                    for (int i = 0; i < _targetPorts.Length; i++)
                    {
                        if (_targetPorts[i] != null && _targetPorts[i].IsOpen && ShouldForwardData(data))
                        {
                            _targetPorts[i].WriteLine(data);
                            LogMessage($"데이터가 {_targetPorts[i].PortName}로 전달되었습니다: {data}");
                        }
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"데이터 전송 실패: {ex.Message}", "오류", MessageBoxButton.OK, MessageBoxImage.Error);
                    LogMessage($"데이터 전송 실패: {ex.Message}");
                }
            }
            else
            {
                MessageBox.Show("스캐너 포트가 열려 있지 않습니다. 먼저 스캐너 포트를 여세요.", "경고", MessageBoxButton.OK, MessageBoxImage.Warning);
                LogMessage("데이터 전송 실패: 스캐너 포트가 열려 있지 않습니다.");
            }
        }

        private bool ShouldForwardData(string data)
        {
            // 예시 조건: 데이터에 "FORWARD"가 포함된 경우에만 다른 포트로 전송
            // 이 조건을 필요에 따라 수정 가능
            return data.Contains("FORWARD");
        }

        private void LogMessage(string message)
        {
            // 현재 시간을 로그에 추가
            string timestamp = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            LogListBox.Items.Add($"{timestamp} - {message}");

            // 로그의 개수가 최대치를 넘으면 첫 번째 로그를 삭제
            if (LogListBox.Items.Count > MaxLogCount)
            {
                LogListBox.Items.RemoveAt(0);
            }
        }
    }
}
3. 코드 설명
주요 변경 사항
선택 취소 버튼 추가: 각 포트 선택 콤보박스 옆에 선택 취소 버튼(X)이 추가되었습니다.
선택 취소 기능 구현: 선택 취소 버튼을 클릭하면 해당 포트가 닫히고, 콤보박스의 선택이 취소되며, 텍스트 색상이 기본 색상(검정색)으로 변경됩니다.
사용 방법
포트 선택 및 연결: 스캐너 포트와 보낼 포트를 각각 선택하면 자동으로 연결됩니다. 포트가 정상적으로 열렸는지 확인하기 위해 콤보박스의 텍스트 색상을 확인합니다.
선택 취소: 각 콤보박스 옆의 "X" 버튼을 클릭하면 선택된 포트가 취소되고, 연결이 해제됩니다.
데이터 전송: DataTextBox에 데이터를 입력하고 "Send Data" 버튼을 클릭하면, 선택된 스캐너 포트로 데이터가 전송됩니다. 특정 조건이 만족되면 다른 포트로도 데이터가 전달됩니다.
로그 확인: 모든 동작 및 에러는 ListBox에 기록되므로, 프로그램의 상태를 쉽게 모니터링할 수 있습니다.
이제 각 포트에 대한 선택을 쉽게 취소할 수 있으며, 취소된 포트는 자동으로 닫힙니다. 추가적인 질문이나 기능 요청이 있으면 언제든지 말씀해 주세