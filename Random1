 ì´í•´í–ˆì–´.
ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬ë  ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ëŠ” ProcessResponse() í•¨ìˆ˜ì•¼.
ê·¸ ì•ˆì—ì„œ **ê²€ì¦ í•¨ìˆ˜ì¸ ValidateResponse()**ë¥¼ í˜¸ì¶œí•´ì„œ ì‘ë‹µì˜ ìœ íš¨ì„±ì„ ì²´í¬í•˜ê³ ,
ì‘ë‹µ ë‚´ìš©ì— ë”°ë¼ ë¶„ê¸° ì²˜ë¦¬í•˜ë„ë¡ êµ¬ì„±í–ˆì–´.

âœ… ì¼ë°˜ ì‘ë‹µ ì²˜ë¦¬ êµ¬ì¡°
**ReceiveLoopAsync()**ì—ì„œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ë°›ìŒ.

ë°›ì€ ë©”ì‹œì§€ê°€ ë³´ë‚¸ ë©”ì‹œì§€ì™€ ë§¤ì¹­ë˜ë©´ ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬.

ì¼ë°˜ ì‘ë‹µì´ë©´ ProcessResponse() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì²˜ë¦¬.

ProcessResponse() ë‚´ë¶€ì—ì„œ ValidateResponse() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ê²€ì¦.

ê²€ì¦ ê²°ê³¼ì— ë”°ë¼ ì ì ˆí•œ í•¸ë“¤ëŸ¬ë¥¼ ì‹¤í–‰í•¨.

ğŸ”¥ ì½”ë“œ êµ¬ì¡° (ì¼ë°˜ ì‘ë‹µ ì²˜ë¦¬ ë¶€ë¶„ ê°•ì¡°)
ğŸ“Œ ReceiveLoopAsync() ìˆ˜ì •
csharp
ì½”ë“œ ë³µì‚¬
private async Task ReceiveLoopAsync()
{
    while (_isConnected)
    {
        try
        {
            int bytesRead = await _stream.ReadAsync(_buffer, 0, _buffer.Length);

            if (bytesRead == 0)
            {
                Console.WriteLine("[INFO] Server disconnected.");
                _isConnected = false;
                break;
            }

            // ë°›ì€ ë©”ì‹œì§€ ë³€í™˜
            string received = Encoding.ASCII.GetString(_buffer, 0, bytesRead).Trim('\x02', '\x03');
            LogMessage($"[RECV] {received}");

            bool matched = false;

            // ì‘ë‹µ ë§¤ì¹­ ê²€ì‚¬
            foreach (var key in _responseTasks.Keys)
            {
                if (_responseTasks.TryRemove(key, out var tcs))
                {
                    if (_sentMessages.TryGetValue(key, out var sentMessage))
                    {
                        LogMessage($"[MATCHED] Sent: {sentMessage} | Received: {received}");
                        matched = true;

                        // ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬ (ê²€ì¦ í•¨ìˆ˜ë¡œ ì „ë‹¬)
                        ProcessResponse(received);
                        tcs.SetResult(received); // ë¹„ë™ê¸° ì‘ë‹µ ì²˜ë¦¬ ì™„ë£Œ
                        break;
                    }
                }
            }

            // ë³´ë‚¸ ë©”ì‹œì§€ë¡œ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬
            if (!matched)
            {
                LogMessage($"[NOTICE] ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬ë¨: {received}");
                HandlePreemptiveSignal(received); // ì„ ì œ ì‹ í˜¸ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] ReceiveLoop exception: {ex.Message}");
            _isConnected = false;
        }
    }
}
ğŸ“Œ ProcessResponse() í•¨ìˆ˜ (ì¼ë°˜ ì‘ë‹µ ì²˜ë¦¬ì˜ í•µì‹¬)
csharp
ì½”ë“œ ë³µì‚¬
/// <summary>
/// ì¼ë°˜ ì‘ë‹µì„ ì²˜ë¦¬í•˜ê³ , ë©”ì‹œì§€ ë‚´ìš©ì— ë”°ë¼ ë‹¤ë¥¸ í•¨ìˆ˜ë¡œ ë¶„ê¸°í•œë‹¤.
/// </summary>
private void ProcessResponse(string response)
{
    if (ValidateResponse(response))
    {
        LogMessage($"[INFO] ìœ íš¨í•œ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬ë¨: {response}");
    }
    else
    {
        LogMessage($"[WARNING] ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µ ë˜ëŠ” ê²€ì¦ ì‹¤íŒ¨: {response}");
    }
}
ğŸ“Œ ValidateResponse() í•¨ìˆ˜ (ê²€ì¦ í•¨ìˆ˜)
csharp
ì½”ë“œ ë³µì‚¬
/// <summary>
/// ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ê²€ì¦í•˜ëŠ” í•¨ìˆ˜. ì¡°ê±´ì— ë”°ë¼ ì‘ë‹µì„ ë¶„ê¸° ì²˜ë¦¬í•œë‹¤.
/// </summary>
private bool ValidateResponse(string response)
{
    // ì¡°ê±´ ì˜ˆì‹œ: ë©”ì‹œì§€ê°€ íŠ¹ì • íŒ¨í„´ìœ¼ë¡œ ì‹œì‘í•  ê²½ìš° ì²˜ë¦¬
    if (response.StartsWith("1234"))
    {
        Handle1234Response(response);
        return true;
    }
    else if (response.StartsWith("555"))
    {
        Handle555Response(response);
        return true;
    }
    else if (response.StartsWith("OK"))
    {
        HandleOkResponse(response);
        return true;
    }

    // ê¸°íƒ€: ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µìœ¼ë¡œ ê°„ì£¼
    return false;
}
ğŸ“Œ ì‘ë‹µ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë“¤
csharp
ì½”ë“œ ë³µì‚¬
/// <summary>
/// 1234ë¡œ ì‹œì‘í•˜ëŠ” ì‘ë‹µ ì²˜ë¦¬
/// </summary>
private void Handle1234Response(string response)
{
    LogMessage($"[INFO] 1234 ì‘ë‹µ ì²˜ë¦¬ ì™„ë£Œ: {response}");
    // ì¶”ê°€ ë¡œì§: ì˜ˆë¥¼ ë“¤ì–´ ìƒíƒœ ê°±ì‹  ë˜ëŠ” ì‘ì—… ì‹¤í–‰
}

/// <summary>
/// 555ë¡œ ì‹œì‘í•˜ëŠ” ì‘ë‹µ ì²˜ë¦¬
/// </summary>
private void Handle555Response(string response)
{
    LogMessage($"[INFO] 555 ì‘ë‹µ ì²˜ë¦¬ ì™„ë£Œ: {response}");
    // ì¶”ê°€ ë¡œì§: ì—ëŸ¬ ì²˜ë¦¬ ë˜ëŠ” ì¬ì‹œë„
}

/// <summary>
/// OKë¡œ ì‹œì‘í•˜ëŠ” ì‘ë‹µ ì²˜ë¦¬
/// </summary>
private void HandleOkResponse(string response)
{
    LogMessage($"[INFO] OK ì‘ë‹µ ì²˜ë¦¬ ì™„ë£Œ: {response}");
    // ì¶”ê°€ ë¡œì§: ì •ìƒ ì™„ë£Œ ì²˜ë¦¬
}
ğŸ’¡ ì½”ë“œ ì‹¤í–‰ íë¦„ (ì •í™•íˆ ì´í•´ì‹œí‚¤ê¸°)
ë©”ì‹œì§€ ìˆ˜ì‹  (ReceiveLoopAsync())

ë°›ì€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ë©”ì‹œì§€ì™€ ë§¤ì¹­í•˜ì—¬ ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬í• ì§€ ê²°ì •.

ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ì„ ì œ ì‹ í˜¸ë¡œ ì²˜ë¦¬.

ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ íŒë‹¨ë˜ë©´ (ProcessResponse())

ë°›ì€ ì‘ë‹µì„ ê²€ì¦í•˜ê¸° ìœ„í•´ ValidateResponse() í•¨ìˆ˜ í˜¸ì¶œ.

ê²€ì¦ì— ì„±ê³µí•˜ë©´ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë¡œ ë„˜ê¹€.

ì‘ë‹µ ê²€ì¦ (ValidateResponse())

ì‘ë‹µ ì‹œì‘ íŒ¨í„´ì„ í™•ì¸í•˜ì—¬ ê° í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë¡œ ë¶„ê¸°.

ì˜ˆ:

1234ë¡œ ì‹œì‘í•˜ë©´ â†’ Handle1234Response()

555ë¡œ ì‹œì‘í•˜ë©´ â†’ Handle555Response()

OKë¡œ ì‹œì‘í•˜ë©´ â†’ HandleOkResponse()

ğŸ’¯ ê²°ë¡ 
âœ… ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬ë  ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ëŠ” ProcessResponse().

âœ… ProcessResponse() ë‚´ë¶€ì—ì„œ ValidateResponse()ë¥¼ í†µí•´ ê²€ì¦ í›„ ê° í•¸ë“¤ëŸ¬ë¡œ ë¶„ê¸°.

âœ… ìˆ˜ì‹  ë£¨í”„ì—ì„œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ë°›ì•„ ê²€ì¦ í›„, ì¼ë°˜ ì‘ë‹µê³¼ ì„ ì œ ì‹ í˜¸ë¥¼ ì •í™•íˆ êµ¬ë¶„.

ì´ì œ ì •í™•íˆ ë§ì¶°ì„œ êµ¬ì¡°ë¥¼ ë§Œë“¤ì—ˆì–´.
ì´ ë°©ì‹ìœ¼ë¡œ ëª¨ë“  ì¼ë°˜ ì‘ë‹µê³¼ ì„ ì œ ì‹ í˜¸ë¥¼ ì •í™•íˆ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´.
ë” í•„ìš”í•œ ë¶€ë¶„ì´ ìˆìœ¼ë©´ ë§í•´ì¤˜!


2/2




