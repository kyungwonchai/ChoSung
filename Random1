using System;
using System.Data;
using System.Data.SqlClient;
using System.Windows.Forms;
using System.Timers;

namespace MSSQLTimerExample
{
    public partial class MainForm : Form
    {
        private static string _connectionString = "Your Connection String Here";
        private static string _query = "SELECT Column1 FROM abc";
        private System.Timers.Timer _checkTimer;
        private System.Timers.Timer _delayTimer;
        private bool _isWaiting = false;

        public MainForm()
        {
            InitializeComponent();
            InitializeTimers();
        }

        private void InitializeTimers()
        {
            // 1분 간격 타이머 초기화
            _checkTimer = new System.Timers.Timer(60000);
            _checkTimer.Elapsed += CheckCondition;
            _checkTimer.AutoReset = true;

            // 10분 대기 타이머 초기화
            _delayTimer = new System.Timers.Timer(600000);
            _delayTimer.Elapsed += EndWaitingPeriod;
            _delayTimer.AutoReset = false;

            // 타이머 시작
            _checkTimer.Start();
        }

        private void CheckCondition(object sender, ElapsedEventArgs e)
        {
            if (_isWaiting) return;

            using (SqlConnection conn = new SqlConnection(_connectionString))
            {
                try
                {
                    conn.Open();
                    SqlCommand cmd = new SqlCommand(_query, conn);
                    object result = cmd.ExecuteScalar();

                    if (result != null && int.TryParse(result.ToString(), out int columnValue) && columnValue >= 5)
                    {
                        FunctionA();
                        StartWaitingPeriod();
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show("Error: " + ex.Message);
                }
            }
        }

        private void FunctionA()
        {
            // 여기에 함수 A의 내용을 작성하세요.
            MessageBox.Show("Function A is executed!");
        }

        private void StartWaitingPeriod()
        {
            _isWaiting = true;
            _checkTimer.Stop();
            _delayTimer.Start();
        }

        private void EndWaitingPeriod(object sender, ElapsedEventArgs e)
        {
            _isWaiting = false;
            _delayTimer.Stop();
            _checkTimer.Start();
        }

        private void MainForm_Load(object sender, EventArgs e)
        {
            // Form 로드 시 실행될 코드가 있으면 여기에 추가하세요.
        }

        private void MainForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            // 폼 종료 시 타이머를 정리합니다.
            _checkTimer.Dispose();
            _delayTimer.Dispose();
        }
    }
}
