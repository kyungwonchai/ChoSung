// MainActivity.kt íŒŒì¼ì˜ ì´ ë¶€ë¶„ì„ êµì²´í•˜ì„¸ìš”

    /**
     * ê³µìœ  í´ë”ì˜ PDF ëª©ë¡ì—ì„œ 'ë¼ì¸' ëª©ë¡ì„ ì¶”ì¶œí•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
     */
    private suspend fun showLineSelectionDialog() {
        try {
            val allFiles = listSmbFiles()
            // --- ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„ ì‹œì‘ ---
            // íŒŒì¼ëª…ì—ì„œ ë¼ì¸ ì´ë¦„ ì¶”ì¶œ í›„, ìˆ«ì ë¶€ë¶„ì„ 2ìë¦¬ë¡œ ì •ê·œí™”
            val lineNames = allFiles
                .mapNotNull { it.name.split('_').firstOrNull() }
                .map { line ->
                    // ì •ê·œì‹ì„ ì‚¬ìš©í•´ ë¼ì¸ ì´ë¦„ì—ì„œ ìˆ«ì ë¶€ë¶„ê³¼ ë¬¸ì ë¶€ë¶„ì„ ë¶„ë¦¬
                    val regex = "(\\d+)(.*)".toRegex()
                    val matchResult = regex.find(line)
                    if (matchResult != null) {
                        val (number, text) = matchResult.destructured
                        // ìˆ«ì ë¶€ë¶„ì„ 2ìë¦¬ ë¬¸ìì—´ë¡œ í¬ë§·íŒ… (ì˜ˆ: "1" -> "01")
                        String.format("%02d%s", number.toInt(), text)
                    } else {
                        line // ìˆ«ì ë¶€ë¶„ì´ ì—†ëŠ” ê²½ìš°ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    }
                }
                .distinct() // ì¤‘ë³µ ì œê±°
                .sorted()   // ì •ë ¬

            // --- ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„ ë ---

            if (lineNames.isEmpty()) {
                withContext(Dispatchers.Main) { Toast.makeText(this@MainActivity, "PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", Toast.LENGTH_SHORT).show() }
                return
            }

            withContext(Dispatchers.Main) {
                AlertDialog.Builder(this@MainActivity)
                    .setTitle("ë¼ì¸ ì„ íƒ")
                    .setItems(lineNames.toTypedArray()) { _, which ->
                        val selectedLine = lineNames[which]
                        prefs.edit().putString(KEY_LAST_LINE, selectedLine).apply()
                        lifecycleScope.launch(Dispatchers.IO) {
                            showReelListDialog(selectedLine, allFiles)
                        }
                    }
                    .show()
            }
        } catch (e: Exception) {
            Log.e("SmbTask", "ë¼ì¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨", e)
            withContext(Dispatchers.Main) {
                Toast.makeText(this@MainActivity, "ë¼ì¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${e.message}", Toast.LENGTH_LONG).show()
            }
        }
    }

    /**
     * ì„ íƒëœ ë¼ì¸ì— í•´ë‹¹í•˜ëŠ” PDF íŒŒì¼ ëª©ë¡ì„ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ë³´ì—¬ì¤ë‹ˆë‹¤.
     * ê°€ì¥ ìµœì‹  íŒŒì¼ì€ íŒŒë€ìƒ‰ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸ë©ë‹ˆë‹¤.
     */
    private suspend fun showReelListDialog(selectedLine: String, allFiles: List<SmbFile>) {
        // --- ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„ ì‹œì‘ ---
        // í•„í„°ë§ ì‹œ, ì •ê·œí™”ëœ ì´ë¦„(01)ê³¼ ì •ê·œí™”ë˜ì§€ ì•Šì€ ì´ë¦„(1)ì„ ëª¨ë‘ ê³ ë ¤
        val normalizedLine = selectedLine.removePrefix("0")
        val filesInLine = allFiles
            .filter { it.name.startsWith("${selectedLine}_") || it.name.startsWith("${normalizedLine}_") }
            .sortedByDescending { it.lastModified() }
        // --- ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„ ë ---

        if (filesInLine.isEmpty()) {
            withContext(Dispatchers.Main) { Toast.makeText(this@MainActivity, "ì„ íƒí•œ ë¼ì¸ì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.", Toast.LENGTH_SHORT).show() }
            return
        }

        // í‘œì‹œí•  íŒŒì¼ ì´ë¦„ ëª©ë¡ ìƒì„± (ë¼ì¸ëª…, .pdf ì œê±°)
        val displayNames = filesInLine.map {
            it.name.removePrefix("${selectedLine}_").removePrefix("${normalizedLine}_").removeSuffix(".pdf")
        }

        withContext(Dispatchers.Main) {
            val adapter = ArrayAdapter<SpannableString>(this@MainActivity, android.R.layout.simple_list_item_1)
            displayNames.forEachIndexed { index, name ->
                val spannable = SpannableString(name)
                if (index == 0) { // ì²« ë²ˆì§¸ í•­ëª©(ìµœì‹ )
                    spannable.setSpan(ForegroundColorSpan(ContextCompat.getColor(this@MainActivity, android.R.color.holo_blue_dark)), 0, name.length, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE)
                }
                adapter.add(spannable)
            }

            AlertDialog.Builder(this@MainActivity)
                .setTitle("ë¦´ë¦¬ìŠ¤íŠ¸ ì„ íƒ ($selectedLine)")
                .setAdapter(adapter) { _, which ->
                    val selectedFile = filesInLine[which]
                    lifecycleScope.launch(Dispatchers.IO) {
                        loadPdfFromSmbFile(selectedFile)
                    }
                }
                .show()