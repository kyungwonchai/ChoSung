using System;
using System.Data;
using System.Data.SqlClient;

class Program
{
    static void Main()
    {
        // Connection strings for both databases
        string connectionString1 = "your_connection_string_for_instance_1";
        string connectionString2 = "your_connection_string_for_instance_2";

        // Step 1: Get data from view_eff (TBL1)
        DataTable TBL1 = new DataTable();
        using (SqlConnection connection1 = new SqlConnection(connectionString1))
        {
            string query1 = "SELECT 모델, BOT삽입수, TOP삽입수, 연배열, 모델효율 FROM view_eff";
            using (SqlCommand command1 = new SqlCommand(query1, connection1))
            {
                connection1.Open();
                using (SqlDataAdapter adapter1 = new SqlDataAdapter(command1))
                {
                    adapter1.Fill(TBL1);
                }
            }
        }

        // Step 2: Get data from 모델정보_조장 (TBL2)
        DataTable TBL2 = new DataTable();
        using (SqlConnection connection2 = new SqlConnection(connectionString2))
        {
            string query2 = "SELECT 모델명, BOT삽입수, TOP삽입수, 연배열, 모델효율 FROM 모델정보_조장";
            using (SqlCommand command2 = new SqlCommand(query2, connection2))
            {
                connection2.Open();
                using (SqlDataAdapter adapter2 = new SqlDataAdapter(command2))
                {
                    adapter2.Fill(TBL2);
                }
            }
        }

        // Step 3: Update TBL2's 모델효율 with values from TBL1 if conditions match
        using (SqlConnection connection2 = new SqlConnection(connectionString2))
        {
            connection2.Open();
            using (SqlTransaction transaction = connection2.BeginTransaction())
            {
                try
                {
                    foreach (DataRow row1 in TBL1.Rows)
                    {
                        string model1 = row1["모델"].ToString();
                        int botInsertCount1 = Convert.ToInt32(row1["BOT삽입수"]);
                        int topInsertCount1 = Convert.ToInt32(row1["TOP삽입수"]);
                        int arrayYear1 = Convert.ToInt32(row1["연배열"]);
                        decimal modelEfficiency1 = Convert.ToDecimal(row1["모델효율"]);

                        foreach (DataRow row2 in TBL2.Rows)
                        {
                            string model2 = row2["모델명"].ToString();
                            int botInsertCount2 = Convert.ToInt32(row2["BOT삽입수"]);
                            int topInsertCount2 = Convert.ToInt32(row2["TOP삽입수"]);
                            int arrayYear2 = Convert.ToInt32(row2["연배열"]);

                            if (model2.Contains(model1) && botInsertCount1 == botInsertCount2 && topInsertCount1 == topInsertCount2 && arrayYear1 == arrayYear2)
                            {
                                string updateQuery = "UPDATE 모델정보_조장 SET 모델효율 = @모델효율 WHERE 모델명 = @모델명 AND BOT삽입수 = @BOT삽입수 AND TOP삽입수 = @TOP삽입수 AND 연배열 = @연배열";
                                using (SqlCommand updateCommand = new SqlCommand(updateQuery, connection2, transaction))
                                {
                                    updateCommand.Parameters.AddWithValue("@모델효율", modelEfficiency1);
                                    updateCommand.Parameters.AddWithValue("@모델명", model2);
                                    updateCommand.Parameters.AddWithValue("@BOT삽입수", botInsertCount2);
                                    updateCommand.Parameters.AddWithValue("@TOP삽입수", topInsertCount2);
                                    updateCommand.Parameters.AddWithValue("@연배열", arrayYear2);
                                    updateCommand.ExecuteNonQuery();
                                }
                            }
                        }
                    }

                    // Commit the transaction
                    transaction.Commit();
                }
                catch (Exception ex)
                {
                    // Rollback the transaction if any error occurs
                    transaction.Rollback();
                    Console.WriteLine("Error: " + ex.Message);
                }
            }
        }

        Console.WriteLine("Update completed successfully.");
    }
}
