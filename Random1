import os

# app.py ì½”ë“œë¥¼ ìƒˆë¡œ ì‘ì„± (ìœˆë„ìš° ê²½ë¡œ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€)
new_app_code = r"""from flask import Flask, render_template, request, jsonify
import pymssql
import subprocess
import os
import socket
import platform

app = Flask(__name__)

# ================= CONFIGURATION =================
DB_HOST = '192.168.0.10'
DB_USER = 'sa'
DB_PASSWORD = 'password'
DB_NAME = 'MyDatabase'
# =================================================

def get_db_connection():
    return pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)

def get_local_ip():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        s.connect(('10.255.255.255', 1))
        IP = s.getsockname()[0]
    except Exception:
        IP = '127.0.0.1'
    finally:
        s.close()
    return IP

@app.route('/')
def index():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT IPAddress, Account, DisplayName, FullPath, CONVERT(VARCHAR, LastUpdated, 120) as LastUpdated FROM FolderIndex ORDER BY LastUpdated DESC")
    rows = cursor.fetchall()
    conn.close()
    return render_template('index.html', folders=rows)

@app.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    target_ip = data.get('ip')
    user = data.get('account')
    path = data.get('path')

    local_ip = get_local_ip()
    mode_msg = ""
    cmd = []
    
    # [í•µì‹¬ ìˆ˜ì • ì‚¬í•­]
    # ê²½ë¡œì— ì—­ìŠ¬ë˜ì‹œ(\)ê°€ ìˆê±°ë‚˜ ì½œë¡ (:)ì´ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ "ìœˆë„ìš° ë¡œì»¬ í”„ë¡œì íŠ¸"ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
    # ì´ ê²½ìš° SSHë‚˜ ë³µì¡í•œ ì˜µì…˜ ì—†ì´ ì•„ì£¼ ì‹¬í”Œí•˜ê²Œ ì‹¤í–‰í•©ë‹ˆë‹¤.
    is_windows_path = ('\\' in path) or (':' in path)

    if is_windows_path:
        # ìœˆë„ìš°: ê·¸ëƒ¥ ìƒˆ ì°½ìœ¼ë¡œ ê²½ë¡œ ì—´ê¸° (íŒŒë¼ë¯¸í„° ìµœì†Œí™”)
        cmd = ['code', '--new-window', path]
        mode_msg = "Windows Local (Direct)"
        
        # ìœˆë„ìš°ì—ì„œëŠ” í™˜ê²½ë³€ìˆ˜ ì„¤ì • ë¶ˆí•„ìš”, ë°”ë¡œ ì‹¤í–‰
        try:
            subprocess.Popen(cmd, shell=True) # shell=Trueê°€ ìœˆë„ìš°ì—ì„œ ëª…ë ¹ ì¸ì‹ì— ìœ ë¦¬í•¨
            return jsonify({'status': 'success', 'message': f'[{mode_msg}] Opening {path}'})
        except Exception as e:
            return jsonify({'status': 'error', 'message': str(e)}), 500

    else:
        # ë¦¬ëˆ…ìŠ¤ (ìš°ë¶„íˆ¬) ë¡œì§
        cmd = ['code', '--no-sandbox', '--new-window']
        
        if target_ip == local_ip or target_ip in ['127.0.0.1', 'localhost']:
            cmd.append(path)
            mode_msg = "Linux Local"
        else:
            remote_arg = f"ssh-remote+{user}@{target_ip}"
            cmd.extend(['--remote', remote_arg, path])
            mode_msg = "Linux SSH"

        try:
            # ë¦¬ëˆ…ìŠ¤ëŠ” DISPLAY í™˜ê²½ë³€ìˆ˜ê°€ í•„ìˆ˜
            my_env = os.environ.copy()
            if 'DISPLAY' not in my_env:
                my_env['DISPLAY'] = ':0'

            subprocess.Popen(cmd, env=my_env)
            return jsonify({'status': 'success', 'message': f'[{mode_msg}] Opening on {target_ip}'})
        except Exception as e:
            return jsonify({'status': 'error', 'message': str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
"""

def update_app_final():
    target_path = os.path.join("NetworkFolderIndexer", "app.py")
    
    if not os.path.exists("NetworkFolderIndexer"):
        print("âŒ ì˜¤ë¥˜: í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    with open(target_path, "w", encoding="utf-8") as f:
        f.write(new_app_code)
        
    print(f"âœ… ìµœì¢… ìˆ˜ì • ì™„ë£Œ: {target_path}")
    print("ğŸ‘‰ ìœˆë„ìš° ê²½ë¡œëŠ” ì´ì œ SSH ì—†ì´ 'code ê²½ë¡œ' ëª…ë ¹ì–´ë¡œ ë°”ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.")

if __name__ == "__main__":
    update_app_final()