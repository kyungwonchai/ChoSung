using DevExpress.XtraEditors;
using DevExpress.XtraGrid;
using DevExpress.XtraGrid.Views.Grid;
using DevExpress.XtraPrinting;
using System;
using System.IO;
using System.Windows.Forms;

namespace WinFormsApp
{
    public partial class MainForm : XtraForm
    {
        private GridControl gridControl;
        private GridView gridView;

        public MainForm()
        {
            InitializeComponent();
        }

        private void MainForm_Load(object sender, EventArgs e)
        {
            // GridControl과 GridView 초기화
            gridControl = new GridControl();
            gridView = new GridView(gridControl);
            gridControl.MainView = gridView;
            gridControl.ViewCollection.Add(gridView);
            gridView.GridControl = gridControl;

            // 예시 데이터 설정
            gridView.Columns.AddField("Name").Visible = true;
            gridView.Columns.AddField("Age").Visible = true;
            gridView.Columns.AddField("Address").Visible = true;
            gridView.Columns.AddField("Email").Visible = true;

            // 데이터 바인딩
            gridControl.DataSource = GetDataSource();

            // GridControl에 컨텍스트 메뉴 추가
            gridControl.ContextMenuStrip = new ContextMenuStrip();
            gridControl.ContextMenuStrip.Opening += ContextMenuStrip_Opening;

            // 컨트롤 배치
            LayoutControls();
        }

        private void LayoutControls()
        {
            // GridControl을 MainForm에 추가
            gridControl.Dock = DockStyle.Fill;
            Controls.Add(gridControl);
        }

        private void ContextMenuStrip_Opening(object sender, System.ComponentModel.CancelEventArgs e)
        {
            ContextMenuStrip contextMenuStrip = (ContextMenuStrip)sender;
            contextMenuStrip.Items.Clear();

            // 내보내기 메뉴 아이템 추가
            ToolStripMenuItem exportMenuItem = new ToolStripMenuItem("Export to Excel");
            exportMenuItem.Click += ExportMenuItem_Click;
            contextMenuStrip.Items.Add(exportMenuItem);
        }

        private void ExportMenuItem_Click(object sender, EventArgs e)
        {
            // 선택한 GridView를 엑셀로 내보내기
            SaveFileDialog saveFileDialog = new SaveFileDialog();
            saveFileDialog.Filter = "Excel files|*.xlsx";
            if (saveFileDialog.ShowDialog() == DialogResult.OK)
            {
                XlsxExportOptionsEx options = new XlsxExportOptionsEx();
                options.ExportType = ExportType.WYSIWYG;
                options.ShowGridLines = true;

                using (FileStream stream = new FileStream(saveFileDialog.FileName, FileMode.Create))
                {
                    gridView.ExportToXlsx(stream, options);
                }

                XtraMessageBox.Show("Export completed!", "Export", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private object GetDataSource()
        {
            // 예시 데이터 소스 반환
            // 실제 데이터를 가져와서 바인딩하는 로직으로 대체해야 합니다.
            return new[]
            {
                new { Name = "John Doe", Age = 30, Address = "123 Main St", Email = "john@example.com" },
                new { Name = "Jane Smith", Age = 25, Address = "456 Elm St", Email = "jane@example.com" },
                new { Name = "Mike Johnson", Age = 40, Address = "789 Oak St", Email = "mike@example.com" }
            };
        }
    }
}
