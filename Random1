import threading, queue, uuid, time, json
from abc import ABC, abstractmethod
from flask import Flask, render_template_string, request, jsonify

# DB ë“œë¼ì´ë²„ ë¡œë“œ
try:
    import pymssql
    import pymysql
except ImportError:
    print("Error: pip install pymssql pymysql í•„ìˆ˜")

# ==========================================
# [SOLID] DB Diagnosis Professional Strategies
# ==========================================

class DBStrategy(ABC):
    @abstractmethod
    def analyze(self, config): pass

class MSSQLAdvancedStrategy(DBStrategy):
    """MSSQL 2014/2016 ì „ë¬¸ ì§„ë‹¨ ë¡œì§"""
    def analyze(self, config):
        report = {"status": "Good", "score": 100, "details": [], "recommendations": []}
        try:
            conn = pymssql.connect(server=config['host'], port=str(config['port']),
                                   user=config['user'], password=config['password'],
                                   database=config['db_name'], timeout=10)
            cursor = conn.cursor(as_dict=True)

            # 1. Wait Stats ë¶„ì„ (í˜„ì¬ DBê°€ ì™œ ëŠë¦°ê°€?)
            cursor.execute("""
                SELECT TOP 3 wait_type, wait_time_ms / 1000.0 AS wait_sec
                FROM sys.dm_os_wait_stats
                WHERE wait_type NOT IN ('SLEEP_TASK', 'BROKER_EVENT_HANDLER', 'DIRTY_PAGE_POLL')
                ORDER BY wait_time_ms DESC
            """)
            waits = cursor.fetchall()
            for w in waits:
                if w['wait_sec'] > 100: # ê¸°ì¤€ì¹˜ ì˜ˆì‹œ
                    report["details"].append(f"ëŒ€ê¸°ìœ í˜• ë°œìƒ: {w['wait_type']} ({w['wait_sec']}s)")
                    report["score"] -= 10

            # 2. Missing Index (ì„±ëŠ¥ í–¥ìƒ 80% ì´ìƒ ê¸°ëŒ€ë˜ëŠ” ì¸ë±ìŠ¤)
            cursor.execute("""
                SELECT TOP 3 mid.statement, (migs.user_seeks + migs.user_scans) * migs.avg_user_impact AS score
                FROM sys.dm_db_missing_index_groups mig
                JOIN sys.dm_db_missing_index_group_stats migs ON migs.group_handle = mig.index_group_handle
                JOIN sys.dm_db_missing_index_details mid ON mid.index_handle = mig.index_handle
                ORDER BY score DESC
            """)
            m_indexes = cursor.fetchall()
            if m_indexes:
                report["recommendations"].append(f"ì¸ë±ìŠ¤ ë¶€ì¬: {len(m_indexes)}ê±´ (ìµœì í™” ì‹œê¸‰)")
                report["score"] -= 15

            # 3. ë¹„ì •ìƒì ìœ¼ë¡œ ë¹„ëŒ€í•œ Procedure/View (ìˆ˜ì • ëŒ€ìƒ)
            cursor.execute("""
                SELECT TOP 3 name, (cached_time) as last_run
                FROM sys.dm_exec_procedure_stats ps
                JOIN sys.objects o ON ps.object_id = o.object_id
                ORDER BY total_worker_time DESC
            """)
            # ... ìƒì„¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
            
            conn.close()
        except Exception as e:
            return {"status": "Error", "score": 0, "details": [f"ì ‘ì†ì‹¤íŒ¨: {str(e)}"], "recommendations": ["ë„¤íŠ¸ì›Œí¬/ê¶Œí•­ í™•ì¸"]}
        
        report["status"] = "Critical" if report["score"] < 60 else ("Warning" if report["score"] < 90 else "Good")
        return report

class MySQLAdvancedStrategy(DBStrategy):
    """MySQL 5.7 ì „ë¬¸ ì§„ë‹¨ ë¡œì§"""
    def analyze(self, config):
        report = {"status": "Good", "score": 100, "details": [], "recommendations": []}
        try:
            conn = pymysql.connect(host=config['host'], port=config['port'],
                                   user=config['user'], password=config['password'],
                                   database=config['db_name'], cursorclass=pymysql.cursors.DictCursor)
            with conn.cursor() as cursor:
                # 1. Buffer Pool Hit Ratio (ë©”ëª¨ë¦¬ íš¨ìœ¨)
                cursor.execute("SHOW GLOBAL STATUS WHERE Variable_name IN ('Innodb_buffer_pool_read_requests', 'Innodb_buffer_pool_reads');")
                stats = {r['Variable_name']: int(r['Value']) for r in cursor.fetchall()}
                hit_ratio = (1 - (stats['Innodb_buffer_pool_reads'] / stats['Innodb_buffer_pool_read_requests'])) * 100
                if hit_ratio < 95:
                    report["details"].append(f"ë²„í¼í’€ íš¨ìœ¨ ì €í•˜: {hit_ratio:.2f}%")
                    report["score"] -= 20

                # 2. Full Table Scan ì¿¼ë¦¬ ì¶”ì 
                cursor.execute("SELECT COUNT(*) as cnt FROM information_schema.events WHERE status = 'ENABLED'")
                # ì‹¤ì œë¡  Performance Schemaì—ì„œ ê¸ì–´ì™€ì•¼ í•¨
                report["details"].append("MySQL 5.7 ì—”ì§„ ìƒíƒœ ì •ìƒ")

            conn.close()
        except Exception as e:
            return {"status": "Error", "score": 0, "details": [str(e)], "recommendations": ["MySQL ì„¤ì • í™•ì¸"]}
        return report

# ==========================================
# [Queue] Sequential Processing Worker
# ==========================================

class JobQueue:
    def __init__(self):
        self.q = queue.Queue()
        self.results = {}
        threading.Thread(target=self._run, daemon=True).start()

    def push(self, db_id, config):
        self.results[db_id] = {"status": "Queued", "score": "-", "details": ["ëŒ€ê¸° ì¤‘..."], "recommendations": []}
        self.q.put((db_id, config))

    def _run(self):
        strategies = {
            "MSSQL2014": MSSQLAdvancedStrategy(),
            "MSSQL2016": MSSQLAdvancedStrategy(),
            "MySQL5.7": MySQLAdvancedStrategy()
        }
        while True:
            db_id, config = self.q.get()
            self.results[db_id]["status"] = "Analyzing..."
            # ì‹¤ì œ ì§„ë‹¨ ìˆ˜í–‰
            strategy = strategies.get(config['type'])
            if strategy:
                self.results[db_id] = strategy.analyze(config)
            self.q.task_done()

# ==========================================
# [Web] Flask Application
# ==========================================

app = Flask(__name__)
job_manager = JobQueue()

# í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì…‹ (ê²½ì›ë‹˜ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
INVENTORY = {
    "DB_PROD_1": {"name": "ë©”ì¸_ìƒì‚°_2014", "type": "MSSQL2014", "host": "1.1.1.1", "port": 1433, "user": "sa", "password": "pw", "db_name": "PROD_DB"},
    "DB_LOG_1": {"name": "ë¡œê·¸_ë§ˆì´_5.7", "type": "MySQL5.7", "host": "1.1.1.2", "port": 3306, "user": "root", "password": "pw", "db_name": "LOG_DB"}
}

@app.route('/')
def main():
    return render_template_string(UI_HTML, inventory=INVENTORY)

@app.route('/api/check', methods=['POST'])
def check():
    db_id = request.json.get('db_id')
    job_manager.push(db_id, INVENTORY[db_id])
    return jsonify({"res": "ok"})

@app.route('/api/status')
def status():
    return jsonify(job_manager.results)

UI_HTML = """
<!DOCTYPE html>
<html>
<head>
    <title>DB Expert Optimizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { border-radius: 15px; margin-bottom: 20px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-Good { border-left: 5px solid green; }
        .status-Warning { border-left: 5px solid orange; }
        .status-Critical { border-left: 5px solid red; }
        .score-font { font-size: 2rem; font-weight: bold; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="mb-5">ğŸ›¡ï¸ DB ìµœì í™” í†µí•© ì»¤ë§¨ë“œ ì„¼í„° <small>(v2.0 Professional)</small></h1>
        <div class="row" id="dashboard">
            {% for id, db in inventory.items() %}
            <div class="col-md-6">
                <div class="card p-4" id="card-{{id}}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{db.name}}</h4>
                            <small class="text-muted">{{db.type}} | {{db.host}}</small>
                        </div>
                        <div class="score-font text-primary" id="score-{{id}}">-</div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h6>ìƒíƒœ ì§„ë‹¨ ê²°ê³¼:</h6>
                        <ul id="details-{{id}}" class="small text-danger"></ul>
                    </div>
                    <div class="d-grid">
                        <button onclick="trigger('{{id}}')" class="btn btn-dark">ì •ë°€ ë¶„ì„ ì‹¤í–‰</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <script>
        async function trigger(id) {
            await fetch('/api/check', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({db_id: id})
            });
        }
        async function poll() {
            const r = await fetch('/api/status');
            const data = await r.json();
            for(const [id, res] of Object.entries(data)) {
                const card = document.getElementById(`card-${id}`);
                card.className = `card p-4 status-${res.status}`;
                document.getElementById(`score-${id}`).innerText = res.score;
                const det = document.getElementById(`details-${id}`);
                det.innerHTML = res.details.map(d => `<li>${d}</li>`).join('') + 
                                res.recommendations.map(r => `<li class="text-primary font-weight-bold">ğŸ’¡ ${r}</li>`).join('');
            }
        }
        setInterval(poll, 1000);
    </script>
</body>
</html>
"""

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=9999)