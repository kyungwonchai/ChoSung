안녕하세요. MS SQL Server 2014 환경에서 line1 컬럼과 tb1 컬럼을 기준으로 중복된 데이터를 정리하고, 각 중복 그룹 내에서 inputtime1 컬럼 값이 가장 최신인 행만 남기고 나머지 오래된 행들을 삭제하는 방법을 문의하셨습니다.

이를 위해 ROW_NUMBER() 함수와 CTE(Common Table Expression)를 사용하는 것이 일반적이고 효율적인 방법입니다. 아래 쿼리를 사용해 보세요.

주의: 데이터 삭제는 되돌릴 수 없는 작업이므로, 실행 전에 반드시 데이터를 백업하시고, DELETE 대신 SELECT *를 사용하여 어떤 행이 삭제될지 먼저 확인하는 것이 좋습니다.

SQL

-- 실제 테이블 이름으로 'YourTableName'을 변경해주세요.
DECLARE @YourTableName NVARCHAR(128) = 'YourTableName'; -- 여기에 실제 테이블 이름을 입력하세요.

-- 1. 삭제 대상 확인 (SELECT 문) - 안전을 위해 먼저 실행하여 확인하세요.
PRINT N'삭제될 행들을 확인합니다:';
WITH RowNumCTE AS (
    SELECT
        -- 테이블에 기본 키(Primary Key)가 있다면 함께 선택하는 것이 좋습니다. (예: YourPrimaryKeyColumn)
        *, -- 모든 컬럼 선택 또는 필요한 컬럼만 선택
        ROW_NUMBER() OVER(PARTITION BY line1, tb1 ORDER BY inputtime1 DESC) as rn
    FROM
        YourTableName -- 실제 테이블 이름으로 변경
)
SELECT *
FROM RowNumCTE
WHERE rn > 1;


-- 2. 실제 삭제 실행 (DELETE 문) - 위 SELECT 결과가 예상과 동일할 때 실행하세요.
PRINT N'중복 행 삭제를 시작합니다...';
BEGIN TRANSACTION; -- 트랜잭션 시작 (필요시 롤백 가능)

BEGIN TRY
    WITH RowNumCTE AS (
        SELECT
            -- DELETE 문에서는 삭제 대상 행을 식별하기 위한 컬럼만 필요할 수 있습니다.
            -- ROW_NUMBER() 계산에 필요한 컬럼들은 필수입니다.
            ROW_NUMBER() OVER(PARTITION BY line1, tb1 ORDER BY inputtime1 DESC) as rn
        FROM
            YourTableName -- 실제 테이블 이름으로 변경
    )
    DELETE FROM RowNumCTE
    WHERE rn > 1;

    PRINT N'중복 행 삭제 완료.';
    COMMIT TRANSACTION; -- 변경 사항 확정

END TRY
BEGIN CATCH
    PRINT N'오류 발생: ' + ERROR_MESSAGE();
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION; -- 오류 발생 시 롤백
    PRINT N'작업이 롤백되었습니다.';
END CATCH;

쿼리 설명:

WITH RowNumCTE AS (...): CTE(Common Table Expression)를 정의합니다. CTE는 쿼리 내에서 임시로 사용하는 명명된 결과 집합입니다.
ROW_NUMBER() OVER(PARTITION BY line1, tb1 ORDER BY inputtime1 DESC) as rn:
PARTITION BY line1, tb1: line1 컬럼과 tb1 컬럼의 값이 같은 행들을 하나의 그룹으로 묶습니다.
ORDER BY inputtime1 DESC: 각 그룹 내에서 inputtime1 컬럼 값을 기준으로 내림차순 정렬합니다 (최신 날짜가 먼저 오도록).
ROW_NUMBER(): 정렬된 순서대로 각 행에 1부터 시작하는 고유한 번호(rn)를 할당합니다. 즉, 각 그룹에서 inputtime1이 가장 최신인 행은 rn 값이 1이 됩니다.
SELECT * FROM RowNumCTE WHERE rn > 1;: 확인 단계에서는 rn 값이 1보다 큰 행들, 즉 각 그룹 내에서 가장 최신 행을 제외한 나머지 중복 행들을 선택하여 보여줍니다.
DELETE FROM RowNumCTE WHERE rn > 1;: 실제 삭제 단계에서는 rn 값이 1보다 큰 행들 (중복 행들 중 오래된 행들)을 삭제합니다. CTE를 대상으로 DELETE를 실행하면 원본 테이블(YourTableName)의 해당 행이 삭제됩니다.
BEGIN TRANSACTION, COMMIT TRANSACTION, ROLLBACK TRANSACTION: 데이터 무결성을 위해 트랜잭션을 사용했습니다. 삭제 작업이 성공하면 COMMIT으로 변경 사항을 영구 저장하고, 중간에 오류가 발생하면 ROLLBACK으로 작업을 취소하여 원래 상태로 되돌립니다.
실행 순서:

YourTableName을 실제 테이블 이름으로 변경합니다.
먼저 SELECT 문 (삭제 대상 확인 부분)을 실행하여 어떤 행들이 삭제될지 확인합니다.