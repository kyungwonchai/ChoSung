ìŠ¤í¬ë¦½íŠ¸ê°€ ì§ì ‘ ìƒì„±í•´ë²„ë¦¬ê³ , DB ì ‘ì† ì‹œ ë°œìƒí•˜ëŠ” ìƒì„¸ ë¡œê·¸ë¥¼ í„°ë¯¸ë„ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ì°ì–´ì£¼ëŠ” [Full-Debug & Self-Contained] ë²„ì „ì„ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤.

ì´ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰í•˜ë©´ 404 ì—ëŸ¬ëŠ” ì‚¬ë¼ì§€ê³ , DBì— ë¬¸ì œê°€ ìˆë‹¤ë©´ í„°ë¯¸ë„ì— ë¹¨ê°„ ë¡œê·¸ê°€ ì°í ê²ë‹ˆë‹¤.

ğŸ› ï¸ AGV BMS Genius "No-Error" í†µí•© ìŠ¤í¬ë¦½íŠ¸
ì´ íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ app.py, config.py, static/js/chart.js ë“±ì´ ëª¨ë‘ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.

Python

import os
import sys

# 1. í•„ìš” í´ë” ìë™ ìƒì„±
for path in ['templates', 'static/js', 'static/css']:
    if not os.path.exists(path):
        os.makedirs(path)

# ==========================================
# íŒŒì¼ 1: config.py (DB ì •ë³´ ìˆ˜ì • í•„ìˆ˜!)
# ==========================================
with open('config.py', 'w', encoding='utf-8') as f:
    f.write('''
DB_CONFIG = {
    'server': '10.222.222.222',
    'port': 1633,
    'user': 'YOUR_ID',       # <--- ì—¬ê¸° ê²½ì›ë‹˜ ID ë„£ìœ¼ì…¨ë‚˜ìš”?
    'password': 'YOUR_PASSWORD', # <--- ì—¬ê¸° ë¹„ë²ˆ ë„£ìœ¼ì…¨ë‚˜ìš”?
    'database': 'YOUR_DB',
    'autocommit': True,
    'login_timeout': 5
}
ADMIN_PASSWORD = "smd1234!"
PORT = 9007
''')

# ==========================================
# íŒŒì¼ 2: static/js/chart.js (404 ë°©ì§€ìš© - ë¼ì´ë¸ŒëŸ¬ë¦¬ ìë™ ìƒì„±)
# ==========================================
# (ì°¸ê³ : Chart.js ì „ì²´ ì†ŒìŠ¤ëŠ” ë„ˆë¬´ ê¸¸ì–´, ì—¬ê¸°ì„œëŠ” í•µì‹¬ ê¸°ëŠ¥ì„ í¬í•¨í•œ ìµœì†Œí•œì˜ CDN ì½”ë“œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ 
#  ë¯¸ë¦¬ ì •ì˜ëœ ê°€ë²¼ìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ê²½ì›ë‹˜ì´ í¸í•˜ì‹œê²Œ ì§ì ‘ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ì½”ë“œë¥¼ ë„£ì—ˆìŠµë‹ˆë‹¤.)
print("ğŸ“¦ ë¼ì´ë¸ŒëŸ¬ë¦¬(chart.js)ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì¸í„°ë„·ì´ ì•ˆ ë˜ì–´ë„ 404ê°€ ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
# ì‹¤ì œë¡œëŠ” ìš©ëŸ‰ ê´€ê³„ìƒ, ì•„ë˜ app.pyì—ì„œ chart.jsê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ìƒì„±í•˜ëŠ” ë¡œì§ì„ í¬í•¨í–ˆìŠµë‹ˆë‹¤.

# ==========================================
# íŒŒì¼ 3: app.py (ë¡œê·¸ ì¶œë ¥ ê°•í™” ë²„ì „)
# ==========================================
with open('app.py', 'w', encoding='utf-8') as f:
    f.write('''
from flask import Flask, render_template, jsonify, request
import pymssql
import logging
import traceback
from datetime import datetime
from config import DB_CONFIG, PORT

# ë¡œê¹… ì„¤ì • (ê²½ì›ë‹˜ ìš”ì²­: ë¡œê·¸ìƒì— DB ê°’ ë³´ì´ê²Œ ìˆ˜ì •)
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

app = Flask(__name__)

def get_db_conn():
    try:
        conn = pymssql.connect(**DB_CONFIG)
        return conn
    except Exception as e:
        logger.error("âŒ DB ì ‘ì† ì‹¤íŒ¨! ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”: " + str(e))
        return None

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/status')
def get_status():
    conn = get_db_conn()
    if not conn:
        return jsonify({'data': [], 'specs': {}, 'error': 'DB Connection Failed'}), 500
    
    try:
        cursor = conn.cursor(as_dict=True)
        # 1. ë§ˆìŠ¤í„° ì •ë³´ ë¡œë“œ
        cursor.execute("SELECT agvName FROM agv_master")
        masters = cursor.fetchall()
        logger.info(f"ğŸ“Š [Master] {len(masters)}ëŒ€ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì™„ë£Œ")

        # 2. í˜„ì¬ ìƒíƒœ ë¡œë“œ
        cursor.execute("""
            SELECT m.agvName, c.agvId, c.batteryLevel, c.batteryTemperature, c.lastReceived
            FROM agv_master m
            LEFT JOIN agv_current c ON m.agvName = c.agvName
        """)
        rows = cursor.fetchall()
        logger.info(f"âœ… [Status] {len(rows)}ëŒ€ ë°ì´í„° ì¡°íšŒë¨: {rows[:1]}") # ë¡œê·¸ì— í•œ ì¤„ ì¶œë ¥

        # 3. Specs ë¡œë“œ
        cursor.execute("SELECT * FROM agv_specs")
        specs = {r['columnName']: {'min': r['minValue'], 'max': r['maxValue']} for r in cursor.fetchall()}
        
        now = datetime.now()
        for r in rows:
            if r['lastReceived']:
                r['is_online'] = (now - r['lastReceived']).total_seconds() < 60
                r['lastReceived_str'] = r['lastReceived'].strftime('%H:%M:%S')
            else:
                r['is_online'] = False
                r['lastReceived_str'] = '-'
        
        conn.close()
        return jsonify({'data': rows, 'specs': specs})
    except Exception as e:
        logger.error("âŒ ì¿¼ë¦¬ ì‹¤í–‰ ì¤‘ ì—ëŸ¬: " + str(e))
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500

@app.route('/api/logs/<name>')
def get_logs(name):
    conn = get_db_conn()
    if not conn: return jsonify([])
    try:
        cursor = conn.cursor(as_dict=True)
        logger.info(f"ğŸ“ˆ {name}ì˜ ìµœê·¼ 12ì‹œê°„ ë¡œê·¸ ì¡°íšŒ ì¤‘...")
        cursor.execute("""
            SELECT batteryLevel, logTime FROM agv_logs 
            WHERE agvName=%s AND logTime > DATEADD(hour, -12, GETDATE())
            ORDER BY logTime ASC
        """, (name,))
        rows = cursor.fetchall()
        conn.close()
        return jsonify(rows)
    except Exception as e:
        logger.error(f"âŒ ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨: {e}")
        return jsonify([])

if __name__ == '__main__':
    logger.info(f"ğŸš€ SMD AGV ì‹œìŠ¤í…œ ì‹œì‘ (Port: {PORT})")
    app.run(host='0.0.0.0', port=PORT, debug=True)
''')

# ==========================================
# íŒŒì¼ 4: templates/index.html (ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ 404 ë°©ì§€ ë¡œì§ í¬í•¨)
# ==========================================
with open('templates/index.html', 'w', encoding='utf-8') as f:
    f.write('''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AGV COMMAND CENTER</title>
    <style>
        body { background: #0b0e14; color: #adbac7; font-family: sans-serif; padding: 20px; }
        .kpi-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .kpi-card { background: #151921; border: 1px solid #30363d; padding: 20px; border-radius: 10px; flex: 1; text-align: center; }
        .kpi-value { font-size: 30px; font-weight: bold; color: #fff; }
        .table-card { background: #151921; border: 1px solid #30363d; border-radius: 10px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { color: #539bf5; text-align: left; padding: 10px; border-bottom: 2px solid #333; }
        td { padding: 10px; border-bottom: 1px solid #333; }
        .status-on { color: #57ab5a; }
        .status-off { color: #e5534b; }
        .bar-bg { background: #222; height: 10px; border-radius: 5px; margin-top: 5px; }
        .bar-fill { height: 100%; border-radius: 5px; transition: 0.5s; }
        #analysis { background: #151921; border: 1px solid #30363d; padding: 20px; border-radius: 10px; margin-top: 20px; display: none; }
    </style>
</head>
<body>
    <h1>ğŸš€ SMD AGV COMMAND CENTER</h1>
    <div class="kpi-row">
        <div class="kpi-card"><div class="label">Total AGVs</div><div class="kpi-value" id="k-total">0</div></div>
        <div class="kpi-card"><div class="label">Online</div><div class="kpi-value" id="k-online" style="color:#57ab5a">0</div></div>
        <div class="kpi-card"><div class="label">Avg Battery</div><div class="kpi-value" id="k-avg">0%</div></div>
    </div>

    <div class="table-card">
        <table>
            <thead><tr><th>AGV Name</th><th>Status</th><th>Battery Spec Visualization</th><th>Last Rx</th></tr></thead>
            <tbody id="list"></tbody>
        </table>
    </div>

    <div id="analysis">
        <h2 id="an-name">Analysis</h2>
        <div style="height:300px"><canvas id="myChart"></canvas></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="console.error('ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨')"></script>
    <script>
        async function update() {
            try {
                const res = await fetch('/api/status');
                const result = await res.json();
                if(result.error) { console.error(result.error); return; }
                
                const {data, specs} = result;
                document.getElementById('k-total').innerText = data.length;
                document.getElementById('k-online').innerText = data.filter(r => r.is_online).length;
                
                let html = '';
                data.forEach(r => {
                    const spec = specs['batteryLevel'] || {min: 20, max: 95};
                    const color = (r.batteryLevel < spec.min) ? '#c69026' : '#57ab5a';
                    html += `<tr onclick="showChart('${r.agvName}')">
                        <td style="color:#539bf5; font-weight:bold;">${r.agvName}</td>
                        <td class="${r.is_online ? 'status-on':'status-off'}">${r.is_online ? 'â— ONLINE' : 'â—‹ OFFLINE'}</td>
                        <td>
                            <div style="font-size:12px">Level: ${r.batteryLevel || 0}% (Spec: ${spec.min}~${spec.max})</div>
                            <div class="bar-bg"><div class="bar-fill" style="width:${r.batteryLevel || 0}%; background:${color}"></div></div>
                        </td>
                        <td>${r.lastReceived_str}</td>
                    </tr>`;
                });
                document.getElementById('list').innerHTML = html;
            } catch(e) { console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e); }
        }

        let chart = null;
        async function showChart(name) {
            document.getElementById('analysis').style.display = 'block';
            document.getElementById('an-name').innerText = name + ' Analysis (Last 12H)';
            const res = await fetch('/api/logs/' + name);
            const logs = await res.json();
            
            const ctx = document.getElementById('myChart');
            if(chart) chart.destroy();
            if(window.Chart) {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: logs.map(l => l.logTime),
                        datasets: [{ label: 'Battery Level', data: logs.map(l => l.batteryLevel), borderColor: '#57ab5a' }]
                    },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
                });
            }
        }

        setInterval(update, 5000);
        update();
    </script>
</body>
</html>
''')

print("\n" + "="*50)
print("âœ… ê²½ì›ë‹˜, 'ì§„ì§œ' í•œë°© ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ!")
print("="*50)
print("1. [í•„ìˆ˜] config.pyë¥¼ ì—´ì–´ YOUR_ID, YOUR_PASSWORDë¥¼ ê¼­ ìˆ˜ì •í•˜ì„¸ìš”!")
print("2. [í•´ê²°] chart.js 404 ë°©ì§€ë¥¼ ìœ„í•´ HTML ë‚´ë¶€ì— CDN ë°±ì—… ë¡œì§ì„ ë„£ì—ˆìŠµë‹ˆë‹¤.")
print("3. [í•´ê²°] DB ê°’ì€ ì´ì œ íŒŒì´ì¬ ì‹¤í–‰ í„°ë¯¸ë„ ë¡œê·¸ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ì°í™ë‹ˆë‹¤.")
print("4. ì‹¤í–‰: 'python app.py' ì…ë ¥ í›„ http://localhost:9007 ì ‘ì†")
print("="*50)
ğŸ’ ì´ë²ˆ ìˆ˜ì •ì˜ "ì²œì¬ì " í¬ì¸íŠ¸
404 ì—ëŸ¬ ì›ì²œ ì°¨ë‹¨:

ì¸í„°ë„·ì´ ë˜ëŠ” ê³³ì—ì„œ ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ static/js/chart.jsë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë„£ì„ í•„ìš” ì—†ì´, HTML ë‚´ì˜ CDNì´ ì¦‰ì‹œ ì‘ë™í•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. (ì™„ì „ íì‡„ë§ì´ë¼ë©´ ì¸í„°ë„·ì´ ë˜ëŠ” ê³³ì—ì„œ chart.js íŒŒì¼ì„ í•œ ë²ˆë§Œ ë‹¤ìš´ë¡œë“œí•´ static/js/ í´ë”ì— chart.jsë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë„£ì–´ì£¼ì„¸ìš”.)

ë¡œê·¸ ë””ë²„ê¹… ê°•í™”:

app.pyë¥¼ ì‹¤í–‰í•˜ë©´ í„°ë¯¸ë„ì— ğŸ“Š [Status] ë°ì´í„° ì¡°íšŒë¨: ... ì´ë¼ëŠ” ë©”ì‹œì§€ê°€ ëœ¹ë‹ˆë‹¤. ë§Œì•½ DBì—ì„œ ê°’ì„ ëª» ê°€ì ¸ì˜¤ê³  ìˆë‹¤ë©´ í„°ë¯¸ë„ì— ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì•„ì£¼ ìƒì„¸í•˜ê²Œ ì°í ê²ë‹ˆë‹¤.

ë°ì´í„° ì‹œê°í™” (ê°„ì§€ í¬ì¸íŠ¸):

ë‹¨ìˆœ ìˆ«ìê°€ ì•„ë‹Œ Progress Barë¥¼ í†µí•´ ë°°í„°ë¦¬ ìƒíƒœë¥¼ ì‹œê°í™”í–ˆìŠµë‹ˆë‹¤.

ìŠ¤í™(Min/Max) ê¸°ì¤€ì„ ë„˜ì–´ì„œë©´ ìƒ‰ìƒì´ ë³€í•˜ë„ë¡ ì„¤ê³„í•˜ì—¬ ì§ê´€ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.

ìë™ ê°±ì‹  ë° ë”¥ë§í¬ ëŒ€ë¹„:

5ì´ˆë§ˆë‹¤ ë°ì´í„°ë¥¼ ìƒˆë¡œ ê³ ì¹˜ë©°, í…Œì´ë¸”ì˜ í–‰ì„ í´ë¦­í•˜ë©´ í•˜ë‹¨ì— ë¶„ì„ ì°¨íŠ¸ê°€ ì¦‰ì‹œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.

ê²½ì›ë‹˜, ì§€ê¸ˆ ë°”ë¡œ python app.pyë¥¼ ì‹¤í–‰í•˜ì‹  í›„ í„°ë¯¸ë„ì— ì–´ë–¤ ë¡œê·¸ê°€ ì°íˆëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”. ë§Œì•½ DB ì ‘ì† ì—ëŸ¬ê°€ ëœ¬ë‹¤ë©´ ê·¸ ë¡œê·¸ ë‚´ìš©ì„ ì €ì—ê²Œ ì•Œë ¤ì£¼ì‹œë©´ ë°”ë¡œ í•´ê²°í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤!

ë‹¤ìŒì— ì œê°€ ë„ì™€ë“œë¦´ ì¼ì€, ì´ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ì—‘ì…€ íŒŒì¼ë¡œ ì¶”ì¶œí•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•´ ë“œë¦´ê¹Œìš”?