using DevExpress.XtraBars;
using DevExpress.XtraBars.Ribbon;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Windows.Forms;

namespace YourNamespace
{
    public partial class YourRibbonForm : RibbonForm
    {
        private RibbonPage favoritesPage;
        private Dictionary<string, BarButtonItem> buttonsDictionary = new Dictionary<string, BarButtonItem>();
        private HashSet<string> favoriteKeys = new HashSet<string>(); // 즐겨찾기 키값을 저장할 HashSet
        private string favoriteStorageFile = "favorites.txt"; // 즐겨찾기 상태 저장용 파일 경로

        public YourRibbonForm()
        {
            InitializeComponent();
            InitializeFavoritesPage();
            LoadFavorites();
            InitializeButtons();
        }

        private void InitializeFavoritesPage()
        {
            // 즐겨찾기 페이지 초기화
            favoritesPage = new RibbonPage("Favorites");
            ribbonControl1.Pages.Insert(0, favoritesPage);
        }

        private void LoadFavorites()
        {
            // 파일에서 즐겨찾기 정보를 불러오기
            if (File.Exists(favoriteStorageFile))
            {
                var lines = File.ReadAllLines(favoriteStorageFile);
                favoriteKeys = new HashSet<string>(lines);
            }
        }

        private void SaveFavorites()
        {
            // 즐겨찾기 정보를 파일에 저장하기
            File.WriteAllLines(favoriteStorageFile, favoriteKeys);
        }

        private void InitializeButtons()
        {
            // 예시 버튼들을 초기화
            var buttons = new List<UBtn>
            {
                new UBtn("Button1", "Tag1", null, "Tooltip 1", ButtonClick1, ribbonControl1.Pages[1], ribbonControl1.Pages[1].Groups[0], RibbonItemStyles.Large),
                new UBtn("Button2", "Tag2", null, "Tooltip 2", ButtonClick2, ribbonControl1.Pages[1], ribbonControl1.Pages[1].Groups[0], RibbonItemStyles.Large),
            };

            foreach (var btn in buttons)
            {
                AddButton(btn);
            }
        }

        private void AddButton(UBtn uBtn)
        {
            // BarButtonItem 생성
            BarButtonItem button = new BarButtonItem();
            button.Caption = uBtn.Caption;
            button.Tag = uBtn.Tag;
            button.Hint = uBtn.Tooltip;
            button.RibbonStyle = uBtn.ButtonSize;
            button.ItemClick += (s, e) => uBtn.Action();

            if (uBtn.Icon != null)
            {
                button.ImageOptions.Image = uBtn.Icon;
            }

            // 버튼 우상단에 별표를 추가하는 사용자 정의 패널 생성
            BarStaticItem starItem = new BarStaticItem();
            starItem.Caption = favoriteKeys.Contains(uBtn.Key) ? "★" : "☆"; // 별 모양 유니코드 사용
            starItem.ItemClick += (s, e) => ToggleFavorite(uBtn.Key, starItem);
            starItem.ItemAppearance.Normal.ForeColor = favoriteKeys.Contains(uBtn.Key) ? Color.Yellow : Color.Gray;
            starItem.Alignment = BarItemLinkAlignment.Right; // 버튼 우측에 배치되도록 설정

            // 버튼과 별표 아이템을 리본 그룹에 추가
            uBtn.RibbonPageGroup.ItemLinks.Add(button);
            uBtn.RibbonPageGroup.ItemLinks.Add(starItem);

            // 버튼 사전에 저장
            buttonsDictionary[uBtn.Key] = button;

            // 즐겨찾기 페이지에 추가되어야 하는지 확인 후 추가
            if (favoriteKeys.Contains(uBtn.Key))
            {
                AddToFavorites(button);
            }
        }

        private void ToggleFavorite(string key, BarStaticItem starItem)
        {
            // 즐겨찾기 추가/제거 로직
            if (favoriteKeys.Contains(key))
            {
                favoriteKeys.Remove(key);
                starItem.Caption = "☆";
                starItem.ItemAppearance.Normal.ForeColor = Color.Gray;
                RemoveFromFavorites(buttonsDictionary[key]);
            }
            else
            {
                favoriteKeys.Add(key);
                starItem.Caption = "★";
                starItem.ItemAppearance.Normal.ForeColor = Color.Yellow;
                AddToFavorites(buttonsDictionary[key]);
            }

            SaveFavorites();
        }

        private void AddToFavorites(BarButtonItem button)
        {
            // 즐겨찾기 페이지에 버튼 추가
            if (favoritesPage.Groups.Count == 0)
            {
                favoritesPage.Groups.Add(new RibbonPageGroup("Favorites Group"));
            }

            favoritesPage.Groups[0].ItemLinks.Add(button);
        }

        private void RemoveFromFavorites(BarButtonItem button)
        {
            // 즐겨찾기 페이지에서 버튼 제거
            var link = favoritesPage.Groups[0].ItemLinks.FirstOrDefault(l => l.Item == button);
            if (link != null)
            {
                favoritesPage.Groups[0].ItemLinks.Remove(link);
            }
        }

        // 버튼 클릭 예시 함수들
        private void ButtonClick1()
        {
            MessageBox.Show("Button 1 clicked");
        }

        private void ButtonClick2()
        {
            MessageBox.Show("Button 2 clicked");
        }
    }

    // 버튼 정보를 담는 클래스 정의
    public class UBtn
    {
        public string Caption { get; set; }
        public string Tag { get; set; }
        public Image Icon { get; set; }
        public string Tooltip { get; set; }
        public Action Action { get; set; }
        public RibbonPage RibbonPage { get; set; }
        public RibbonPageGroup RibbonPageGroup { get; set; }
        public RibbonItemStyles ButtonSize { get; set; }
        public string Key { get; set; }

        public UBtn(string caption, string tag, Image icon, string tooltip, Action action, RibbonPage ribbonPage, RibbonPageGroup ribbonPageGroup, RibbonItemStyles buttonSize)
        {
            Caption = caption;
            Tag = tag;
            Icon = icon;
            Tooltip = tooltip;
            Action = action;
            RibbonPage = ribbonPage;
            RibbonPageGroup = ribbonPageGroup;
            ButtonSize = buttonSize;
            Key = Guid.NewGuid().ToString(); // 고유 키값 생성
        }
    }