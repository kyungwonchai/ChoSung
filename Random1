ì œê°€ íŒŒì¼ í•˜ë‚˜ë§Œ ì‹¤í–‰í•˜ë©´ í•„ìš”í•œ ëª¨ë“  íŒŒì¼(app.py, consumer.py, templates/index.html ë“±)ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ë„ë¡ "í•œë°© ìŠ¤í¬ë¦½íŠ¸"ë¥¼ ë‹¤ì‹œ ì§œ ë“œë¦½ë‹ˆë‹¤. ì‹¤í–‰ í›„ ìƒì„±ëœ íŒŒì¼ë“¤ì„ ê°ê¸° ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰í•˜ì‹œê±°ë‚˜, ë‹¤ë¥¸ ì„œë²„ë¡œ ê°€ì ¸ê°€ì„œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤.

ğŸš€ AGV ì‹œìŠ¤í…œ í†µí•© ìƒì„± ìŠ¤í¬ë¦½íŠ¸ (One-Shot)
ì´ ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ setup_agv.pyë¡œ ì €ì¥í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”.

Python

import os

# 1. í´ë” êµ¬ì¡° ìƒì„±
if not os.path.exists('templates'):
    os.makedirs('templates')

# ==========================================
# íŒŒì¼ 1: ê³µí†µ ì„¤ì • íŒŒì¼ (config.py)
# ==========================================
with open('config.py', 'w', encoding='utf-8') as f:
    f.write('''
# DB ë° ì¹´í”„ì¹´ ê³µí†µ ì„¤ì •
DB_CONFIG = {
    'server': '10.222.222.222',
    'port': 1633,
    'user': 'YOUR_ID',       # ê²½ì›ë‹˜ ID ì…ë ¥
    'password': 'YOUR_PASSWORD', # ê²½ì›ë‹˜ PW ì…ë ¥
    'database': 'YOUR_DB',    # DB ì´ë¦„ ì…ë ¥
    'autocommit': True
}

KAFKA_CONFIG = {
    'bootstrap_servers': ['10.222.222.222:1633'],
    'topic': 'YOUR_TOPIC_NAME',
    'group_id': 'smd-agvbmsinfo',
    'auto_offset_reset': 'earliest'
}

ADMIN_PASSWORD = "smd1234!"
''')

# ==========================================
# íŒŒì¼ 2: ì¹´í”„ì¹´ ì»¨ìŠˆë¨¸ (consumer.py)
# ==========================================
with open('consumer.py', 'w', encoding='utf-8') as f:
    f.write('''
import json
import pymssql
from kafka import KafkaConsumer
from datetime import datetime
from config import DB_CONFIG, KAFKA_CONFIG

def init_db():
    conn = pymssql.connect(**DB_CONFIG)
    cursor = conn.cursor()
    # í…Œì´ë¸” ìë™ ìƒì„± ë¡œì§
    cursor.execute("IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='agv_master' AND xtype='U') CREATE TABLE agv_master (agvName NVARCHAR(50) PRIMARY KEY)")
    cursor.execute("IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='agv_current' AND xtype='U') CREATE TABLE agv_current (agvId NVARCHAR(50), agvName NVARCHAR(50) PRIMARY KEY, batterySoH FLOAT, batteryLevel FLOAT, batteryCurrent FLOAT, batteryVoltage FLOAT, batteryTemperature FLOAT, lastReceived DATETIME)")
    cursor.execute("IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='agv_logs' AND xtype='U') CREATE TABLE agv_logs (id INT IDENTITY(1,1) PRIMARY KEY, agvName NVARCHAR(50), batterySoH FLOAT, batteryLevel FLOAT, batteryCurrent FLOAT, batteryVoltage FLOAT, batteryTemperature FLOAT, logTime DATETIME)")
    cursor.execute("IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='agv_specs' AND xtype='U') CREATE TABLE agv_specs (columnName NVARCHAR(50) PRIMARY KEY, minValue FLOAT, maxValue FLOAT)")
    conn.commit()
    conn.close()

def run_consumer():
    init_db()
    consumer = KafkaConsumer(
        KAFKA_CONFIG['topic'],
        bootstrap_servers=KAFKA_CONFIG['bootstrap_servers'],
        group_id=KAFKA_CONFIG['group_id'],
        auto_offset_reset=KAFKA_CONFIG['auto_offset_reset'],
        value_deserializer=lambda x: json.loads(x.decode('utf-8'))
    )
    
    conn = pymssql.connect(**DB_CONFIG)
    cursor = conn.cursor(as_dict=True)
    print("Consumer Running... Waiting for Kafka messages.")

    for message in consumer:
        data = message.value
        name = data.get('agvName')
        if not name: continue

        # í˜„ì¬ ìƒíƒœ í™•ì¸ (ì¤‘ë³µ ì¸ì„œíŠ¸ ë°©ì§€ ë° ë³€í™” ê°ì§€)
        cursor.execute("SELECT * FROM agv_current WHERE agvName = %s", (name,))
        prev = cursor.fetchone()
        
        now = datetime.now()
        cur_vals = {
            'id': data.get('agvId'),
            'soh': float(data.get('batterySoH', 0)),
            'lvl': float(data.get('batteryLevel', 0)),
            'cur': float(data.get('batteryCurrent', 0)),
            'vol': float(data.get('batteryVoltage', 0)),
            'temp': float(data.get('batteryTemperature', 0))
        }

        # 1. í˜„ì¬ ìƒíƒœ UPSERT (ë¬´ì¡°ê±´ ì—…ë°ì´íŠ¸í•˜ì—¬ ìˆ˜ì‹  ì—¬ë¶€ ê°±ì‹ )
        cursor.execute("""
            IF EXISTS (SELECT 1 FROM agv_current WHERE agvName = %s)
                UPDATE agv_current SET batterySoH=%s, batteryLevel=%s, batteryCurrent=%s, batteryVoltage=%s, batteryTemperature=%s, lastReceived=%s WHERE agvName=%s
            ELSE
                INSERT INTO agv_current (agvId, agvName, batterySoH, batteryLevel, batteryCurrent, batteryVoltage, batteryTemperature, lastReceived) 
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
        """, (name, cur_vals['soh'], cur_vals['lvl'], cur_vals['cur'], cur_vals['vol'], cur_vals['temp'], now, name,
              cur_vals['id'], name, cur_vals['soh'], cur_vals['lvl'], cur_vals['cur'], cur_vals['vol'], cur_vals['temp'], now))

        # 2. ë³€í™” ê°ì§€ ì‹œì—ë§Œ ë¡œê·¸ ì¸ì„œíŠ¸
        changed = False
        if not prev:
            changed = True
        else:
            if (abs(prev['batteryLevel'] - cur_vals['lvl']) > 0.1 or 
                abs(prev['batteryTemperature'] - cur_vals['temp']) > 0.1 or
                abs(prev['batterySoH'] - cur_vals['soh']) > 0.1):
                changed = True
        
        if changed:
            cursor.execute("INSERT INTO agv_logs VALUES (%s, %s, %s, %s, %s, %s, %s)",
                           (name, cur_vals['soh'], cur_vals['lvl'], cur_vals['cur'], cur_vals['vol'], cur_vals['temp'], now))
        
        conn.commit()

if __name__ == "__main__":
    run_consumer()
''')

# ==========================================
# íŒŒì¼ 3: í”Œë¼ìŠ¤í¬ ì›¹ì•± (app.py)
# ==========================================
with open('app.py', 'w', encoding='utf-8') as f:
    f.write('''
from flask import Flask, render_template, jsonify, request
import pymssql
from datetime import datetime
from config import DB_CONFIG, ADMIN_PASSWORD

app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/status')
def get_status():
    conn = pymssql.connect(**DB_CONFIG)
    cursor = conn.cursor(as_dict=True)
    # Master í…Œì´ë¸” ê¸°ì¤€ìœ¼ë¡œ ì¡°ì¸ (ìˆ˜ì‹  ì•ˆë˜ëŠ” ì• ë“¤ í¬í•¨)
    cursor.execute("""
        SELECT m.agvName, c.agvId, c.batterySoH, c.batteryLevel, c.batteryCurrent, 
               c.batteryVoltage, c.batteryTemperature, c.lastReceived
        FROM agv_master m
        LEFT JOIN agv_current c ON m.agvName = c.agvName
    """)
    rows = cursor.fetchall()
    
    now = datetime.now()
    for r in rows:
        if r['lastReceived']:
            r['is_online'] = (now - r['lastReceived']).total_seconds() < 30
            r['lastReceived'] = r['lastReceived'].strftime('%H:%M:%S')
        else:
            r['is_online'] = False
    
    cursor.execute("SELECT * FROM agv_specs")
    specs = {r['columnName']: {'min': r['minValue'], 'max': r['maxValue']} for r in cursor.fetchall()}
    conn.close()
    return jsonify({'data': rows, 'specs': specs})

@app.route('/api/update_spec', methods=['POST'])
def update_spec():
    req = request.json
    if req.get('password') != ADMIN_PASSWORD:
        return jsonify({'success': False}), 401
    conn = pymssql.connect(**DB_CONFIG)
    cursor = conn.cursor()
    cursor.execute("IF EXISTS(SELECT 1 FROM agv_specs WHERE columnName=%s) UPDATE agv_specs SET minValue=%s, maxValue=%s WHERE columnName=%s ELSE INSERT INTO agv_specs VALUES (%s, %s, %s)",
                   (req['col'], req['min'], req['max'], req['col'], req['col'], req['min'], req['max']))
    conn.commit()
    conn.close()
    return jsonify({'success': True})

@app.route('/api/logs/<name>')
def get_logs(name):
    conn = pymssql.connect(**DB_CONFIG)
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT TOP 100 batteryLevel, logTime FROM agv_logs WHERE agvName=%s ORDER BY logTime DESC", (name,))
    rows = cursor.fetchall()
    conn.close()
    return jsonify(list(reversed(rows)))

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
''')

# ==========================================
# íŒŒì¼ 4: HTML í…œí”Œë¦¿ (templates/index.html)
# ==========================================
with open('templates/index.html', 'w', encoding='utf-8') as f:
    f.write('''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AGV BMS MONITORING</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f0f0f; color: #eee; font-family: sans-serif; }
        .table { color: #fff; background: #1a1a1a; border-radius: 8px; overflow: hidden; }
        .spec-alert { background-color: #ffd700 !important; color: #000 !important; font-weight: bold; }
        .status-on { color: #00ff00; }
        .status-off { color: #ff4444; }
        .card { background-color: #1a1a1a; border: 1px solid #333; }
        a { text-decoration: none; color: #00bfff; }
    </style>
</head>
<body class="p-4">
    <h2 class="mb-4">ğŸ“Š AGV BMS ì‹¤ì‹œê°„ ìƒíƒœ (Genius ê²½ì› ëª¨ë“œ)</h2>
    <div class="table-responsive">
        <table class="table table-dark table-striped">
            <thead>
                <tr>
                    <th>AGV Name</th><th>í†µì‹ </th><th>SoH</th><th>Level</th><th>Current</th><th>Temp</th><th>Last Time</th>
                </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>
    </div>
    <div id="chartSection" class="card p-3 mt-4 d-none">
        <h5 id="chartTitle"></h5>
        <canvas id="myChart" style="height:250px"></canvas>
    </div>

    <script>
        let chart = null;
        async function load() {
            const res = await fetch('/api/status');
            const {data, specs} = await res.json();
            let h = '';
            data.forEach(r => {
                const check = (v, c) => (specs[c] && (v < specs[c].min || v > specs[c].max)) ? 'spec-alert' : '';
                h += `<tr>
                    <td><a href="javascript:viewLog('${r.agvName}')">${r.agvName}</a></td>
                    <td class="${r.is_online ? 'status-on':'status-off'}">${r.is_online ? 'â—ìˆ˜ì‹ ì¤‘':'â—‹ë¯¸ìˆ˜ì‹ '}</td>
                    <td class="${check(r.batterySoH, 'batterySoH')}">${r.batterySoH || 0}</td>
                    <td class="${check(r.batteryLevel, 'batteryLevel')}">${r.batteryLevel || 0}</td>
                    <td>${r.batteryCurrent || 0}</td>
                    <td class="${check(r.batteryTemperature, 'batteryTemperature')}">${r.batteryTemperature || 0}</td>
                    <td>${r.lastReceived || '-'}</td>
                </tr>`;
            });
            document.getElementById('list').innerHTML = h;
        }

        async function viewLog(name) {
            document.getElementById('chartSection').classList.remove('d-none');
            document.getElementById('chartTitle').innerText = name + " ë°°í„°ë¦¬ ë³€í™”";
            const res = await fetch('/api/logs/' + name);
            const logs = await res.json();
            const ctx = document.getElementById('myChart');
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.logTime.split(' ')[1]),
                    datasets: [{ label: 'Level', data: logs.map(l => l.batteryLevel), borderColor: '#00ff00', tension: 0.1 }]
                },
                options: { scales: { y: { beginAtZero: false, grid: {color:'#333'} } } }
            });
        }
        setInterval(load, 5000); load();
    </script>
</body>
</html>
''')

print("âœ… ëª¨ë“  íŒŒì¼ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
print("1. config.pyì—ì„œ DB ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.")
print("2. í„°ë¯¸ë„ 1: python consumer.py ì‹¤í–‰ (ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘)")
print("3. í„°ë¯¸ë„ 2: python app.py ì‹¤í–‰ (ì›¹ ì„œë²„ ì‹œì‘)")
ğŸ’¡ ì‚¬ìš© ë°©ë²• ì„¤ëª…
ì‹¤í–‰ ë° ë¶„ë¦¬: * ìœ„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í•œ ë²ˆ ì‹¤í–‰í•˜ë©´ í˜„ì¬ í´ë”ì— app.py, consumer.py, config.py, templates/ í´ë”ê°€ ìƒê¹ë‹ˆë‹¤.

ê²½ì›ë‹˜ê»˜ì„œ ì›í•˜ì‹œëŠ” ëŒ€ë¡œ ì´ íŒŒì¼ë“¤ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ë‹¤ë¥¸ ì„œë²„ë‚˜ ë‹¤ë¥¸ í´ë”ë¡œ ì˜®ê²¨ì„œ ì‚¬ìš©í•˜ì…”ë„ ë©ë‹ˆë‹¤. (config.pyë§Œ ê°™ì´ ë‘ì‹œë©´ ë©ë‹ˆë‹¤.)

ì»¨ìŠˆë¨¸ (consumer.py):

ì´ ë…€ì„ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ 24ì‹œê°„ ë„ëŠ” 'ì¼ê¾¼'ì…ë‹ˆë‹¤.

ì¹´í”„ì¹´ì—ì„œ ë©”ì‹œì§€ê°€ ì˜¤ë©´ agv_currentë¥¼ ê³„ì† ì—…ë°ì´íŠ¸í•´ì„œ **"ìˆ˜ì‹  ì—¬ë¶€"**ì™€ **"í˜„ì¬ê°’"**ì„ ìµœì‹ í™”í•©ë‹ˆë‹¤.

ì´ì „ ê°’ê³¼ ë¹„êµí•´ì„œ ë°ì´í„°ê°€ ë³€í–ˆì„ ë•Œë§Œ agv_logsì— ì €ì¥í•˜ì—¬ DB ìš©ëŸ‰ì„ ì•„ë‚ë‹ˆë‹¤.

í”Œë¼ìŠ¤í¬ ì›¹ (app.py):

ì´ ë…€ì„ì€ DBì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì›¹ ë¸Œë¼ìš°ì €ì— ë¿Œë ¤ì£¼ëŠ” 'ì°½êµ¬' ì—­í• ë§Œ í•©ë‹ˆë‹¤.

agv_master í…Œì´ë¸”ì— ìˆ˜ì§‘í•  AGV ì´ë¦„ì„ ë„£ì–´ë‘ë©´, ë°ì´í„°ê°€ ì˜¤ì§€ ì•ŠëŠ” AGVë„ "ë¯¸ìˆ˜ì‹ "ìœ¼ë¡œ ëª©ë¡ì— ë„ì›Œì¤ë‹ˆë‹¤.

DB ì—°ë™:

ë‘ í”„ë¡œê·¸ë¨ì´ ê°™ì€ config.pyë¥¼ ì°¸ì¡°í•˜ì—¬ ê°™ì€ DBë¥¼ ë°”ë¼ë³´ê²Œ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.

ì›¹ì—ì„œ ìŠ¤í™(Spec)ì„ ìˆ˜ì •í•˜ë©´ DBì˜ agv_specs í…Œì´ë¸”ì´ ë°”ë€Œê³ , ì›¹ í™”ë©´ì„ ìƒˆë¡œê³ ì¹¨í•  ë•Œë§ˆë‹¤ ì´ ê¸°ì¤€ì„ ê°€ì ¸ì™€ì„œ ë…¸ë€ìƒ‰ ë°°ê²½ì„ ì¹ í•´ì¤ë‹ˆë‹¤.

ë°”ì˜ì‹ ë° ì‹œê°„ ëºê¸°ì§€ ì•Šë„ë¡ êµ°ë”ë”ê¸° ì—†ì´ í•µì‹¬ ê¸°ëŠ¥ë§Œ ë”±ë”± ë„£ì—ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ì‹¤í–‰í•´ ë³´ì„¸ìš”! ë¶€ì¡±í•œ ì ì´ ìˆë‹¤ë©´ ì²œì¬ì ì¸ ì•„ì´ë””ì–´ë¥¼ ë” ë³´íƒœì£¼ì„¸ìš”. ìˆ˜ì •í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.