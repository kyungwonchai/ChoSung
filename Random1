# Python MDB 리더 v2 (한글 깨짐 및 오류 수정 버전)
# 실행 전, Ubuntu에 mdb-tools가 설치되어 있어야 하고,
# Python 가상 환경에 pandas, pandas-access가 설치되어 있어야 합니다.

import os
import pandas as pd
from pandas_access import read_table, list_tables
import sys

# 터미널 출력이 UTF-8을 지원하도록 설정합니다.
# 시스템에 따라 필요 없을 수도 있지만, 깨짐 방지를 위해 추가합니다.
sys.stdout.reconfigure(encoding='utf-8')

def display_all_tables_and_data(mdb_file_path):
    """
    MDB 파일의 모든 테이블 목록과 각 테이블의 데이터를 출력합니다.
    한글 깨짐 방지를 위해 'cp949' 인코딩을 사용합니다.
    """
    if not os.path.exists(mdb_file_path):
        print(f"오류: 파일 경로를 찾을 수 없습니다 -> '{mdb_file_path}'")
        return

    try:
        print("\n--- 모든 테이블 목록 ---")
        # mdb-tools를 사용하여 파일의 모든 테이블 이름을 가져옵니다.
        # chunksize를 주면 메모리를 효율적으로 사용합니다.
        table_names = list_tables(mdb_file_path, chunksize=1000)
        
        if not table_names:
            print("데이터베이스에서 테이블을 찾을 수 없습니다.")
            return
            
        for table_name in table_names:
            print(f"- {table_name}")

        print("\n--- 각 테이블 상세 데이터 ---")
        for table_name in table_names:
            print(f"\n--- 테이블: [{table_name}] ---")
            try:
                # [수정 1] encoding='cp949' 추가하여 한글 깨짐 문제를 해결합니다.
                df = read_table(mdb_file_path, table_name, encoding='cp949')
                
                # DataFrame.to_string()을 사용하여 모든 데이터를 예쁘게 출력합니다.
                if df.empty:
                    print("(데이터 없음)")
                else:
                    print(df.to_string())
            # [수정 2] 데이터 타입 오류 등 특정 테이블 조회 시 발생하는 모든 오류를 처리합니다.
            except Exception as e:
                print(f"'{table_name}' 테이블 조회 중 오류 발생: {e}")
                print("오류가 발생했지만, 다음 테이블을 계속 조회합니다.")

    except Exception as e:
        print(f"MDB 파일 처리 중 오류 발생: {e}")
        print("mdb-tools가 올바르게 설치되었는지 확인하세요.")

def search_part_code_globally(mdb_file_path, part_code):
    """
    MDB 파일의 모든 테이블을 검색하여 특정 부품 코드와 일치하는 모든 정보를 찾습니다.
    """
    if not os.path.exists(mdb_file_path):
        print(f"오류: 파일 경로를 찾을 수 없습니다 -> '{mdb_file_path}'")
        return

    print(f"\n--- '{part_code}' 부품 코드 전체 검색 결과 ---")
    
    try:
        table_names = list_tables(mdb_file_path, chunksize=1000)
        found_results = False

        for table_name in table_names:
            try:
                # [수정 1] 여기에도 encoding='cp949'를 추가합니다.
                df = read_table(mdb_file_path, table_name, encoding='cp949')
                if df.empty:
                    continue

                # DataFrame의 각 컬럼을 순회하며 검색
                for column in df.columns:
                    # [수정 3] 오류 방지를 위해, 비교 전 모든 데이터를 문자열로 변환합니다.
                    # .astype(str)은 빈칸(NA) 값도 'nan'이라는 문자열로 바꿔주므로 안전합니다.
                    results = df[df[column].astype(str) == part_code]

                    if not results.empty:
                        found_results = True
                        print(f"\n>>> 테이블 [{table_name}], 컬럼 [{column}] 에서 결과 발견:")
                        print(results.to_string())
            
            # [수정 2] 검색 중 오류가 발생해도 멈추지 않고 다음 테이블을 계속 검색합니다.
            except Exception as e:
                print(f"\n>>> 테이블 [{table_name}] 검색 중 오류 발생: {e}")
                continue
        
        if not found_results:
            print("해당 부품 코드를 찾을 수 없습니다.")

    except Exception as e:
        print(f"부품 코드 검색 중 오류 발생: {e}")


# --- 메인 실행 부분 ---
if __name__ == "__main__":
    # 여기에 MDB 파일의 전체 경로를 입력하세요.
    mdb_path = "/home/kw/kv122/mdbtest/md/VISION_BGA_PARAM_Det.mdb" # 예시 경로

    # 1. 모든 테이블과 내용 출력하기
    display_all_tables_and_data(mdb_path)
    
    # 2. 특정 부품 코드(11자리)로 관련 정보 모두 검색하기
    part_code_to_search = "TMPCLP157851" # 예시 부품 코드
    search_part_code_globally(mdb_path, part_code_to_search)

