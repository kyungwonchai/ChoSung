@startuml
!theme plain
title PRO 파일 분류기 처리 흐름

actor 사용자 as User
participant "ProFileProcessorForm" as Form
participant "파일 시스템" as FS

User -> Form: "파일 처리 시작" 버튼 클릭
activate Form

Form -> Form: ProcessAllMachineFolders(dataPath) 호출
activate Form #LightBlue

loop Machine 1~8
    Form -> Form: 다음 Machine 폴더 처리 시작\n(예: "MachineX")
    
    Form -> FS: "MachineX/Stage1" 경로의\n모든 .PRO 파일 요청
    activate FS
    FS --> Form: 파일 이름으로 정렬된\nproFiles 목록 반환
    deactivate FS

    alt machineName == "Machine4"
        Form -> Form: ProcessMachine4(stage1Path, proFiles)
        activate Form #CornflowerBlue
        loop 각 proFile 처리
            Form -> FS: proFile 읽기
            FS --> Form: fileContent 반환
            Form -> Form: targetLane = 2로 결정
            Form -> Form: ModifyAndMoveProFile(..., targetLane)
            note right: Lane=2로 수정 후\nLane2 폴더로 이동
            Form -> FS: 수정된 내용으로 파일 덮어쓰기
            Form -> FS: "Lane2" 폴더로 파일 이동
        end
        deactivate Form

    else machineName == "Machine5"
        Form -> Form: ProcessMachine5(stage1Path, proFiles)
        activate Form #LightGreen
        loop 각 proFile 처리 (previousTakeUpValue 추적)
            Form -> FS: proFile 읽기
            FS --> Form: fileContent 반환
            Form -> Form: "[TakeUp.Unit]" 섹션 파싱\ncurrentTakeUpValue 추출
            Form -> Form: previousTakeUpValue와 비교하여\ntargetLane 결정 (1 또는 2)
            Form -> Form: ModifyAndMoveProFile(..., targetLane)
            note right: Lane 값 수정 후\nLane1 또는 Lane2로 이동
            Form -> FS: 수정된 내용으로 파일 덮어쓰기
            Form -> FS: "Lane{targetLane}" 폴더로 파일 이동
            Form -> Form: previousTakeUpValue = currentTakeUpValue
        end
        deactivate Form

    else General Machines (1,2,3,6,7,8)
        Form -> Form: ProcessGeneralMachines(stage1Path, proFiles)
        activate Form #LightSalmon
        loop 각 proFile 처리
            Form -> FS: proFile 읽기
            FS --> Form: fileContent 반환
            Form -> Form: "[TakeUp.Unit]" 섹션 파싱\n('1,' 또는 '2,'로 시작하는 라인 확인)
            Form -> Form: targetLane 결정 (1 또는 2)
            Form -> Form: ModifyAndMoveProFile(..., targetLane)
            note right: Lane 값 수정 후\nLane1 또는 Lane2로 이동
            Form -> FS: 수정된 내용으로 파일 덮어쓰기
            Form -> FS: "Lane{targetLane}" 폴더로 파일 이동
        end
        deactivate Form
    end
end

deactivate Form
Form -> User: "모든 작업 완료" 로그 표시
deactivate Form