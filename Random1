ì•„. ì´ë²ˆì—ëŠ” ì§„ì§œ ì™„ë²½í•˜ê²Œ ì „ë¬¸ì ì¸ ë¹„ë™ê¸° êµ¬ì¡°ë¡œ ë§Œë“¤ì–´ì¤„ê²Œ.

ëª©í‘œ ìš”ì•½
ğŸ” ìš”êµ¬ ì‚¬í•­
ì „ì†¡í•œ ë©”ì‹œì§€ì— ëŒ€í•œ ì‘ë‹µì€ ë°˜ë“œì‹œ ë‚´ê°€ ë³´ë‚¸ í•¨ìˆ˜ì—ì„œ ê°€ì ¸ê°€ì•¼ í•¨

ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œ ë³´ë‚´ëŠ” ë©”ì‹œì§€ì™€ ì„œë¡œ ì¶©ëŒ ì—†ì´ ì²˜ë¦¬í•´ì•¼ í•¨

OP_CLEARì²˜ëŸ¼ ì„œë²„ê°€ ë¨¼ì € ë³´ë‚´ëŠ” ë©”ì‹œì§€ëŠ” í•­ìƒ ë³„ë„ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨

ì™„ë²½í•˜ê²Œ ë¹„ë™ê¸°ì ì´ê³  ì•ˆì „í•œ êµ¬ì¡°ë¡œ êµ¬í˜„í•  ê²ƒ

í•µì‹¬ ê°œë…
ìš”ì²­ë§ˆë‹¤ ê³ ìœ  IDë¥¼ ë¶€ì—¬ â†’ ì‘ë‹µì„ êµ¬ë¶„í•  ìˆ˜ ìˆê²Œ í•¨

Dictionaryë¡œ ìš”ì²­ì„ ì¶”ì  (ConcurrentDictionary ì‚¬ìš©)

í•­ìƒ ëŒê³  ìˆëŠ” ìˆ˜ì‹  ë£¨í”„ â†’ ì„ ì œ ì‹ í˜¸(OP_CLEAR)ë„ ì•ˆì „í•˜ê²Œ ìˆ˜ì‹ 

TaskCompletionSourceë¡œ ë¹„ë™ê¸° ì‘ë‹µ ì²˜ë¦¬ â†’ ì‘ë‹µì„ ì•ˆì „í•˜ê²Œ ë¹„ë™ê¸°ë¡œ ë°›ê¸°

ë¹„ë™ê¸° Taskë¡œ ì‘ë‹µ ëŒ€ê¸° â†’ ì‘ë‹µ ì¶©ëŒ ë°©ì§€

ì„œë²„ ì„ ì œ ë©”ì‹œì§€(OP_CLEAR) ì „ìš© ì²˜ë¦¬ê¸° ì œê³µ

ì „ë¬¸ê°€ ì½”ë“œ (ì£¼ì„ ë§¤ìš° ìƒì„¸í•˜ê²Œ)
csharp
ì½”ë“œ ë³µì‚¬
using System;
using System.Collections.Concurrent;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;

public class ExpertSocketClient
{
    private TcpClient _client;
    private NetworkStream _stream;
    private byte[] _buffer = new byte[1024];
    private bool _isConnected = false;

    // ìš”ì²­ IDì™€ í•´ë‹¹ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” TaskCompletionSource ë§¤í•‘
    private ConcurrentDictionary<string, TaskCompletionSource<string>> _pendingRequests 
        = new ConcurrentDictionary<string, TaskCompletionSource<string>>();

    /// <summary>
    /// ì„œë²„ì™€ ì—°ê²°í•˜ê³ , ìˆ˜ì‹  ë£¨í”„ë¥¼ ì‹œì‘í•œë‹¤.
    /// </summary>
    public async Task ConnectAsync(string ip, int port)
    {
        _client = new TcpClient();
        await _client.ConnectAsync(ip, port);
        _stream = _client.GetStream();
        _isConnected = true;

        Console.WriteLine($"[INFO] Connected to {ip}:{port}");

        // í•­ìƒ ëŒì•„ê°€ëŠ” ìˆ˜ì‹  ë£¨í”„ë¥¼ ë¹„ë™ê¸°ë¡œ ì‹œì‘
        _ = Task.Run(ReceiveLoopAsync);
    }

    /// <summary>
    /// ë¹„ë™ê¸°ë¡œ ëª…ë ¹ì„ ë³´ë‚´ê³ , í•´ë‹¹ ëª…ë ¹ì— ëŒ€í•œ ì‘ë‹µì„ ê¸°ë‹¤ë¦°ë‹¤.
    /// </summary>
    public async Task<string> SendAndReceiveAsync(string command)
    {
        if (!_isConnected) return "[ERROR] Not connected.";

        // 1. ìš”ì²­ë§ˆë‹¤ ê³ ìœ í•œ ID ìƒì„±
        string requestId = Guid.NewGuid().ToString("N").Substring(0, 8);

        // 2. IDë¥¼ í¬í•¨í•œ ë©”ì‹œì§€ ìƒì„±
        string fullMessage = $"REQ:{requestId}:{command}";
        string wrappedMessage = '\x02' + fullMessage + '\x03';
        byte[] data = Encoding.ASCII.GetBytes(wrappedMessage);

        // 3. TaskCompletionSource ìƒì„±í•˜ì—¬ ëŒ€ê¸° ì¤€ë¹„
        var tcs = new TaskCompletionSource<string>();
        _pendingRequests.TryAdd(requestId, tcs);

        // 4. ë©”ì‹œì§€ ì „ì†¡
        await _stream.WriteAsync(data, 0, data.Length);
        Console.WriteLine($"[SEND] {fullMessage}");

        // 5. ì‘ë‹µì„ ë¹„ë™ê¸°ë¡œ ëŒ€ê¸° (íƒ€ì„ì•„ì›ƒ êµ¬í˜„ ê°€ëŠ¥)
        string response = await tcs.Task;
        return response;
    }

    /// <summary>
    /// í•­ìƒ ëŒê³  ìˆëŠ” ìˆ˜ì‹  ë£¨í”„.
    /// ìˆ˜ì‹ ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³ , ì‘ë‹µê³¼ ì„œë²„ ì„ ì œ ë©”ì‹œì§€ë¥¼ êµ¬ë¶„í•œë‹¤.
    /// </summary>
    private async Task ReceiveLoopAsync()
    {
        while (_isConnected)
        {
            try
            {
                int bytesRead = await _stream.ReadAsync(_buffer, 0, _buffer.Length);
                if (bytesRead == 0)
                {
                    Console.WriteLine("[INFO] Server disconnected.");
                    _isConnected = false;
                    break;
                }

                string received = Encoding.ASCII.GetString(_buffer, 0, bytesRead).Trim('\x02', '\x03');
                Console.WriteLine($"[RECV] {received}");

                // ë©”ì‹œì§€ êµ¬ë¶„ (ì‘ë‹µ ë©”ì‹œì§€ VS ì„ ì œ ë©”ì‹œì§€)
                if (received.StartsWith("RES:"))
                {
                    ProcessResponse(received);
                }
                else if (received == "OP_CLEAR")
                {
                    ProcessOpClear();
                }
                else
                {
                    Console.WriteLine($"[WARN] Unknown message format: {received}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[ERROR] ReceiveLoop exception: {ex.Message}");
                _isConnected = false;
            }
        }
    }

    /// <summary>
    /// ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•œë‹¤. (ìš”ì²­ ID ê¸°ë°˜)
    /// </summary>
    private void ProcessResponse(string message)
    {
        // ë©”ì‹œì§€ í˜•ì‹: "RES:ID:Actual_Response"
        var parts = message.Split(':', 3); // ìµœëŒ€ 3ê°œë¡œ ë¶„ë¦¬

        if (parts.Length < 3) return; // í˜•ì‹ ì˜¤ë¥˜ ë°©ì§€

        string requestId = parts[1];
        string responseContent = parts[2];

        if (_pendingRequests.TryRemove(requestId, out var tcs))
        {
            tcs.SetResult(responseContent); // ì‘ë‹µì„ ëŒ€ê¸° ì¤‘ì¸ Taskì— ì „ë‹¬
        }
        else
        {
            Console.WriteLine($"[ERROR] Unexpected response ID: {requestId}");
        }
    }

    /// <summary>
    /// ì„œë²„ì˜ ì„ ì œ ë©”ì‹œì§€(OP_CLEAR) ì²˜ë¦¬
    /// </summary>
    private void ProcessOpClear()
    {
        Console.WriteLine("[EVENT] OP_CLEAR received. Processing it separately.");
        // TODO: í•„ìš”í•œ ë¡œì§ ì¶”ê°€ (ì˜ˆ: ìƒíƒœ ì´ˆê¸°í™”, UI ê°±ì‹  ë“±)
    }

    /// <summary>
    /// ì—°ê²° í•´ì œ
    /// </summary>
    public void Disconnect()
    {
        _isConnected = false;
        _stream?.Close();
        _client?.Close();
        Console.WriteLine("[INFO] Disconnected.");
    }
}
ì„¤ëª… ìš”ì•½
ì„œë²„ì™€ ì—°ê²° í›„ â†’ í•­ìƒ ëŒê³  ìˆëŠ” ReceiveLoopAsync() ì‹œì‘

ëª¨ë“  ë©”ì‹œì§€ëŠ” ìˆ˜ì‹  ë£¨í”„ì—ì„œ ì²˜ë¦¬

ì‘ë‹µ(RES:ID:Response)ì€ ìš”ì²­ IDì™€ ë§¤ì¹­í•˜ì—¬ ë¹„ë™ê¸° ì‘ë‹µ ì²˜ë¦¬

ì„ ì œ ë©”ì‹œì§€(OP_CLEAR)ëŠ” ë³„ë„ë¡œ ì²˜ë¦¬

ì‚¬ìš© ì˜ˆì œ
csharp
ì½”ë“œ ë³µì‚¬
class Program
{
    static async Task Main(string[] args)
    {
        var client = new ExpertSocketClient();
        await client.ConnectAsync("10.22.22.22", 2400);

        // ëª…ë ¹ì„ ë³´ëƒ„ (ë¹„ë™ê¸°ë¡œ ì‘ë‹µ ë°›ê¸°)
        var response1 = await client.SendAndReceiveAsync("STATUS");
        Console.WriteLine($"ì‘ë‹µ1: {response1}");

        var response2 = await client.SendAndReceiveAsync("RESET");
        Console.WriteLine($"ì‘ë‹µ2: {response2}");

        Console.ReadLine(); // í”„ë¡œê·¸ë¨ ì¢…ë£Œ ë°©ì§€
        client.Disconnect();
    }
}
ì •ë¦¬
âœ… ì‘ë‹µ ì¶©ëŒ ë¬¸ì œ í•´ê²° (ID ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬)

âœ… ì„œë²„ ì„ ì œ ë©”ì‹œì§€ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ (OP_CLEAR)

âœ… ì™„ì „íˆ ë¹„ë™ê¸°ì ìœ¼ë¡œ êµ¬ì„±
