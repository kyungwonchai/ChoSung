using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using Microsoft.ML;
using Microsoft.ML.Data;

namespace SMDFileCleaner
{
    public class MLModelBuilder
    {
        private readonly MLContext _mlContext;
        private ITransformer _model;
        private List<FileRecord> _fileDataList;

        public MLModelBuilder()
        {
            _mlContext = new MLContext();
            _fileDataList = new List<FileRecord>();
        }

        public void TrainModel(List<FileRecord> fileData)
        {
            try
            {
                _fileDataList = fileData;
                var data = _mlContext.Data.LoadFromEnumerable(fileData);
                var pipeline = _mlContext.Transforms.Concatenate("Features", nameof(FileRecord.Hour), nameof(FileRecord.DayOfWeek))
                    .Append(_mlContext.Clustering.Trainers.KMeans("Features", numberOfClusters: 2));

                _model = pipeline.Fit(data);
            }
            catch (Exception ex)
            {
                throw new ApplicationException("Failed to train model.", ex);
            }
        }

        public bool Predict(FileInfo fileInfo)
        {
            try
            {
                if (_model == null)
                {
                    throw new InvalidOperationException("Model is not trained.");
                }

                var fileData = new FileRecord
                {
                    Hour = fileInfo.CreationTime.Hour,
                    DayOfWeek = (int)fileInfo.CreationTime.DayOfWeek
                };

                var predictionEngine = _mlContext.Model.CreatePredictionEngine<FileRecord, FilePrediction>(_model);
                var prediction = predictionEngine.Predict(fileData);

                return prediction.PredictedClusterId == 1; // Cluster 1 is considered as regularly generated files
            }
            catch (Exception ex)
            {
                throw new ApplicationException("Failed to predict file classification.", ex);
            }
        }

        public string GetCurrentPatterns()
        {
            try
            {
                var patternGroups = _fileDataList.GroupBy(f => new { f.Hour, f.DayOfWeek })
                    .Select(g => new { g.Key.Hour, g.Key.DayOfWeek, Count = g.Count() })
                    .OrderByDescending(g => g.Count);

                return string.Join(", ", patternGroups.Select(g => $"Hour: {g.Hour}, Day: {g.DayOfWeek}, Count: {g.Count}"));
            }
            catch (Exception ex)
            {
                throw new ApplicationException("Failed to get current patterns.", ex);
            }
        }
    }

    public class FileRecord
    {
        public float Hour { get; set; }
        public float DayOfWeek { get; set; }
    }

    public class FilePrediction
    {
        [ColumnName("PredictedLabel")]
        public uint PredictedClusterId { get; set; }
    }
}
