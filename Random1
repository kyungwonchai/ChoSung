/ í•„ìš”í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤
using LockerManagementApp.Data;
using LockerManagementApp.Models;
using LockerManagementApp.Infrastructure;
using LockerManagementApp.Views; // MasterDataWindow ì°¸ì¡° ìœ„í•´ ì¶”ê°€
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Configuration;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Linq;
using System.Security;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using System.Runtime.InteropServices;

namespace LockerManagementApp.ViewModels
{
    /// <summary>
    /// ë©”ì¸ ViewModel (ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ì°½ ì—´ê¸° ê¸°ëŠ¥ ì¶”ê°€)
    /// </summary>
    public class MainViewModel : ViewModelBase, IDisposable
    {
        private LockerDbContext _context; // MainViewModelì—ì„œ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” DbContext (ì‚¬ë¬¼í•¨ ê´€ë¦¬ìš©)
        private ObservableCollection<LockerAssignment> _lockerAssignments;
        private LockerAssignment _selectedAssignment;
        private string _statusBarText = "ì¤€ë¹„ ì™„ë£Œ";
        private string _currentAdmin = "í™ê¸¸ë™A";

        private SecureString _masterPasswordInput;
        private bool _isMasterModeEnabled = false; // ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€

        // ì½¤ë³´ë°•ìŠ¤ìš© ë§ˆìŠ¤í„° ë°ì´í„° ëª©ë¡
        private ObservableCollection<LockerType> _allLockerTypes;
        private ObservableCollection<Floor> _allFloors;
        private ObservableCollection<Zone> _allZones;
        private ObservableCollection<SubPart> _allSubParts;
        private ObservableCollection<Administrator> _allAdministrators;

        // ìì‹ ViewModel ì œê±° (LogViewModelë„ ì œê±° - í•„ìš” ì‹œ ë‹¤ì‹œ ì¶”ê°€)
        // public MasterDataViewModel MasterDataVM { get; private set; }
        // public LogViewModel LogVM { get; private set; }

        #region Public Properties
        public ObservableCollection<LockerAssignment> LockerAssignments { get => _lockerAssignments; set => SetProperty(ref _lockerAssignments, value); }
        public LockerAssignment SelectedAssignment { get => _selectedAssignment; set { if (SetProperty(ref _selectedAssignment, value)) { ((RelayCommand)DeleteCommand).RaiseCanExecuteChanged(); ((RelayCommand)ClearAssignmentCommand).RaiseCanExecuteChanged(); } } }
        public string StatusBarText { get => _statusBarText; set => SetProperty(ref _statusBarText, value); }
        public SecureString MasterPasswordInput { get => _masterPasswordInput; set => SetProperty(ref _masterPasswordInput, value); }
        public bool IsMasterModeEnabled { get => _isMasterModeEnabled; set => SetProperty(ref _isMasterModeEnabled, value); } // ë²„íŠ¼ Visibility ë°”ì¸ë”©ìš©
        public ObservableCollection<LockerType> AllLockerTypes { get => _allLockerTypes; set => SetProperty(ref _allLockerTypes, value); }
        public ObservableCollection<Floor> AllFloors { get => _allFloors; set => SetProperty(ref _allFloors, value); }
        public ObservableCollection<Zone> AllZones { get => _allZones; set => SetProperty(ref _allZones, value); }
        public ObservableCollection<SubPart> AllSubParts { get => _allSubParts; set => SetProperty(ref _allSubParts, value); }
        public ObservableCollection<Administrator> AllAdministrators { get => _allAdministrators; set => SetProperty(ref _allAdministrators, value); }
        #endregion

        #region Commands
        public ICommand LoadDataCommand { get; }
        public ICommand SaveChangesCommand { get; } // ì‚¬ë¬¼í•¨ ëª©ë¡ ì €ì¥ìš©
        public ICommand AddNewCommand { get; }
        public ICommand DeleteCommand { get; }
        public ICommand ClearAssignmentCommand { get; }
        public ICommand CheckMasterPasswordCommand { get; }
        public ICommand RefreshMasterDataCommand { get; } // ì½¤ë³´ë°•ìŠ¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ìš©
        public ICommand OpenMasterDataWindowCommand { get; } // *** ì‹ ê·œ ì»¤ë§¨ë“œ ***
        #endregion

        public MainViewModel()
        {
            try { _context = new LockerDbContext(); }
            catch (Exception ex) { MessageBox.Show($"DB ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜:\n{ex.ToString()}", "ì´ˆê¸°í™” ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); StatusBarText = "DB ì—°ê²° ì˜¤ë¥˜!"; return; }

            _lockerAssignments = new ObservableCollection<LockerAssignment>();
            _allLockerTypes = new ObservableCollection<LockerType>();
            _allFloors = new ObservableCollection<Floor>();
            _allZones = new ObservableCollection<Zone>();
            _allSubParts = new ObservableCollection<SubPart>();
            _allAdministrators = new ObservableCollection<Administrator>();

            // ìì‹ ViewModel ìƒì„± ì œê±°
            // MasterDataVM = new MasterDataViewModel();
            // LogVM = new LogViewModel();

            LoadDataCommand = new RelayCommand(async _ => await LoadInitialDataAsync());
            SaveChangesCommand = new RelayCommand(async _ => await SaveChangesAsync());
            AddNewCommand = new RelayCommand(AddNewLocker);
            DeleteCommand = new RelayCommand(async _ => await DeleteSelectedAsync(), _ => SelectedAssignment != null);
            ClearAssignmentCommand = new RelayCommand(ClearSelectedAssignment, _ => SelectedAssignment != null && SelectedAssignment.IsAssigned);
            CheckMasterPasswordCommand = new RelayCommand(CheckMasterPassword);
            RefreshMasterDataCommand = new RelayCommand(async _ => await LoadMasterDataAsync());
            // *** ì‹ ê·œ ì»¤ë§¨ë“œ ì´ˆê¸°í™” ***
            OpenMasterDataWindowCommand = new RelayCommand(OpenMasterDataWindow);

            if (_context != null) { _ = LoadInitialDataAsync(); }
        }

        // --- ë°ì´í„° ë¡œë”© ë©”ì„œë“œ (ì´ì „ê³¼ ë™ì¼) ---
        private async Task LoadInitialDataAsync() { await LoadMasterDataAsync(); await LoadAssignmentsAsync(); }
        private async Task LoadAssignmentsAsync() { if (_context == null) return; StatusBarText = "ì‚¬ë¬¼í•¨ ëª©ë¡ ë¡œë”© ì¤‘..."; try { var assignments = await _context.LockerAssignments.OrderBy(l => l.Floor).ThenBy(l => l.Zone).ThenBy(l => l.SpecificLocation).ToListAsync(); LockerAssignments = new ObservableCollection<LockerAssignment>(assignments); StatusBarText = $"ì´ {LockerAssignments.Count}ê°œ ë¡œë“œ ì™„ë£Œ."; } catch (Exception ex) { HandleGenericException("ì‚¬ë¬¼í•¨ ëª©ë¡ ë¡œë”©", ex); } }
        private async Task LoadMasterDataAsync() { if (_context == null) return; StatusBarText = "ë§ˆìŠ¤í„° ë°ì´í„°(ì½¤ë³´ë°•ìŠ¤ìš©) ë¡œë”© ì¤‘..."; try { AllLockerTypes = new ObservableCollection<LockerType>(await _context.LockerTypes.OrderBy(t => t.Name).AsNoTracking().ToListAsync()); AllFloors = new ObservableCollection<Floor>(await _context.Floors.OrderBy(f => f.Name).AsNoTracking().ToListAsync()); AllZones = new ObservableCollection<Zone>(await _context.Zones.OrderBy(z => z.Name).AsNoTracking().ToListAsync()); AllSubParts = new ObservableCollection<SubPart>(await _context.SubParts.OrderBy(p => p.Name).AsNoTracking().ToListAsync()); AllAdministrators = new ObservableCollection<Administrator>(await _context.Administrators.OrderBy(a => a.Name).AsNoTracking().ToListAsync()); StatusBarText = "ë§ˆìŠ¤í„° ë°ì´í„°(ì½¤ë³´ë°•ìŠ¤ìš©) ë¡œë“œ ì™„ë£Œ."; } catch (InvalidOperationException ioEx) when (ioEx.Message.Contains("DataReader")) { HandleGenericException("ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”© (DataReader ì¶©ëŒ ê°€ëŠ¥ì„±)", ioEx); MessageBox.Show("ë°ì´í„° ë¡œë”© ì¤‘ ì¶©ëŒ ë°œìƒ. App.config ì—°ê²° ë¬¸ìì—´ì— MultipleActiveResultSets=True; ì˜µì…˜ í™•ì¸ ë˜ëŠ” ì¬ì‹œë„.", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); } catch (Exception ex) { HandleGenericException("ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”©", ex); } }

        /// <summary>
        /// ë§ˆìŠ¤í„° í‚¤ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë¡œì§ (IsMasterModeEnabled ì„¤ì •)
        /// </summary>
        private void CheckMasterPassword(object parameter) { try { string storedMasterKey = ConfigurationManager.AppSettings["MasterKey"]; if (string.IsNullOrEmpty(storedMasterKey)) { MessageBox.Show("App.configì— ë§ˆìŠ¤í„° í‚¤(MasterKey) ì—†ìŒ.", "ì„¤ì • ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); return; } string plainPassword = ConvertToUnsecureString(MasterPasswordInput); if (plainPassword == storedMasterKey) { IsMasterModeEnabled = true; /* ìƒíƒœ ë³€ê²½ */ MessageBox.Show("ë§ˆìŠ¤í„° í‚¤ í™•ì¸ ì™„ë£Œ.", "ì„±ê³µ", MessageBoxButton.OK, MessageBoxImage.Information); } else { IsMasterModeEnabled = false; /* ìƒíƒœ ë³€ê²½ */ MessageBox.Show("ë§ˆìŠ¤í„° í‚¤ ë¶ˆì¼ì¹˜.", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } } catch (ConfigurationErrorsException confEx) { MessageBox.Show($"ì„¤ì • íŒŒì¼ ì˜¤ë¥˜:\n{confEx.Message}", "ì„¤ì • ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } catch (Exception ex) { MessageBox.Show($"ë§ˆìŠ¤í„° í‚¤ í™•ì¸ ì˜¤ë¥˜: {ex.Message}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } }

        /// <summary>
        /// ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ì°½ì„ ì—¬ëŠ” ë©”ì„œë“œ
        /// </summary>
        private void OpenMasterDataWindow(object parameter)
        {
            try
            {
                // ìƒˆ MasterDataViewModel ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ìì²´ DbContext ì‚¬ìš©)
                var masterDataVM = new MasterDataViewModel();

                // ìƒˆ MasterDataWindow ìƒì„±
                var masterDataWindow = new MasterDataWindow
                {
                    DataContext = masterDataVM, // ViewModelì„ DataContextë¡œ ì„¤ì •
                    Owner = Application.Current.MainWindow // ë¶€ëª¨ ì°½ ì„¤ì • (ì„ íƒ ì‚¬í•­)
                };

                // ëª¨ë‹¬ ëŒ€í™” ìƒìë¡œ ì°½ í‘œì‹œ
                masterDataWindow.ShowDialog();

                // ë§ˆìŠ¤í„° ë°ì´í„° ì°½ì´ ë‹«íŒ í›„, ë©”ì¸ ìœˆë„ìš°ì˜ ì½¤ë³´ë°•ìŠ¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                // (ë§ˆìŠ¤í„° ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                _ = LoadMasterDataAsync();

                // MasterDataViewModel ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (IDisposable êµ¬í˜„ ì‹œ)
                masterDataVM.Dispose(); // ëª…ì‹œì  í˜¸ì¶œ ë˜ëŠ” Windowì˜ Closing ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
            }
            catch (Exception ex)
            {
                MessageBox.Show($"ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ì°½ ì—´ê¸° ì˜¤ë¥˜:\n{ex.ToString()}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }


        #region CRUD ë° ê¸°íƒ€ ë©”ì„œë“œ (ì´ì „ê³¼ ë™ì¼ - ìì‹ ì˜ _context ì‚¬ìš©)
        private async Task SaveChangesAsync() { if (_context == null) return; StatusBarText = "ë³€ê²½ ì‚¬í•­ ì €ì¥ ì¤‘..."; List<DbEntityEntry> allChangedEntriesForRollback = _context.ChangeTracker.Entries().Where(e => e.State != EntityState.Unchanged).ToList(); try { var changedLockerEntries = _context.ChangeTracker.Entries<LockerAssignment>().Where(e => e.State == EntityState.Added || e.State == EntityState.Modified).ToList(); var allItemsToCheck = LockerAssignments.ToList(); var duplicates = allItemsToCheck.GroupBy(l => new { l.Floor, l.Zone, l.SpecificLocation }).Where(g => g.Count() > 1).Select(g => g.Key); if (duplicates.Any()) { MessageBox.Show($"ì €ì¥ ë¶ˆê°€: ì¤‘ë³µ ìœ„ì¹˜ ë°œê²¬ - {string.Join(", ", duplicates.Select(d => $"{d.Floor}-{d.Zone}-{d.SpecificLocation}"))}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Warning); RollbackChanges(allChangedEntriesForRollback); return; } foreach(var entry in changedLockerEntries) { entry.Entity.Administrator = _currentAdmin; } int changedCount = await _context.SaveChangesAsync(); StatusBarText = $"ì„±ê³µì ìœ¼ë¡œ {changedCount}ê°œ ì €ì¥ë¨."; } catch (DbUpdateException dbEx) { HandleDbUpdateException(dbEx); RollbackChanges(allChangedEntriesForRollback); } catch (Exception ex) { HandleGenericException("ì €ì¥", ex); RollbackChanges(allChangedEntriesForRollback); } }
        private void RollbackChanges(IEnumerable<DbEntityEntry> changedEntries) { if (_context == null || changedEntries == null) return; foreach (var entry in changedEntries.ToList()) { switch (entry.State) { case EntityState.Modified: entry.CurrentValues.SetValues(entry.OriginalValues); entry.State = EntityState.Unchanged; break; case EntityState.Added: entry.State = EntityState.Detached; if (entry.Entity is LockerAssignment addedEntity && LockerAssignments.Contains(addedEntity)) LockerAssignments.Remove(addedEntity); break; case EntityState.Deleted: entry.State = EntityState.Unchanged; break; } } StatusBarText = "ë³€ê²½ ë¡¤ë°±ë¨."; }
        private void AddNewLocker(object parameter) { if (_context == null) return; var newAssignment = new LockerAssignment { LockerType = AllLockerTypes.FirstOrDefault()?.Name ?? "ê°œì¸ì‚¬ë¬¼í•¨", Floor = AllFloors.FirstOrDefault()?.Name ?? "1", Zone = AllZones.FirstOrDefault()?.Name ?? "A", SpecificLocation = "ìƒˆ ìœ„ì¹˜-" + Guid.NewGuid().ToString("N").Substring(0, 4), Administrator = _currentAdmin, LastUpdated = DateTime.Now }; LockerAssignments.Add(newAssignment); _context.LockerAssignments.Add(newAssignment); SelectedAssignment = newAssignment; StatusBarText = "ìƒˆ ì‚¬ë¬¼í•¨ ì¶”ê°€ë¨. ì €ì¥ í•„ìš”."; }
        private async Task DeleteSelectedAsync() { if (_context == null || SelectedAssignment == null) return; if (MessageBox.Show($"'{SelectedAssignment.Floor}-{SelectedAssignment.Zone}-{SelectedAssignment.SpecificLocation}' ì‚­ì œ?", "í™•ì¸", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.Yes) { StatusBarText = "ì‚­ì œ ì¤‘..."; List<DbEntityEntry> changesForRollback = _context.ChangeTracker.Entries().Where(e => e.State != EntityState.Unchanged).ToList(); try { var assignmentToDelete = SelectedAssignment; var entry = _context.Entry(assignmentToDelete); if (entry.State == EntityState.Detached) { _context.LockerAssignments.Attach(assignmentToDelete); } _context.LockerAssignments.Remove(assignmentToDelete); int changedCount = await _context.SaveChangesAsync(); LockerAssignments.Remove(assignmentToDelete); SelectedAssignment = null; StatusBarText = $"ì„±ê³µì ìœ¼ë¡œ {changedCount}ê°œ ì‚­ì œë¨."; } catch (DbUpdateException dbEx) { HandleDbUpdateException(dbEx); RollbackChanges(changesForRollback); await LoadAssignmentsAsync(); } catch (Exception ex) { HandleGenericException("ì‚­ì œ", ex); RollbackChanges(changesForRollback); await LoadAssignmentsAsync(); } } }
        private void ClearSelectedAssignment(object parameter) { if (_context == null || SelectedAssignment == null) return; SelectedAssignment.UserName = null; SelectedAssignment.KnoxId = null; SelectedAssignment.SubPart = null; _context.Entry(SelectedAssignment).State = EntityState.Modified; SelectedAssignment.Administrator = _currentAdmin; StatusBarText = "ë°°ì • í•´ì œë¨. ì €ì¥ í•„ìš”."; }
        #endregion

        #region Helper Methods
        private void HandleGenericException(string operation, Exception ex) { StatusBarText = $"{operation} ì˜¤ë¥˜: {ex.Message}"; MessageBox.Show($"{operation} ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n{ex.ToString()}", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); }
        private void HandleDbUpdateException(DbUpdateException dbEx) { var innerExMsg = dbEx.InnerException?.InnerException?.Message ?? dbEx.InnerException?.Message ?? dbEx.Message; StatusBarText = $"DB ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: {innerExMsg}"; MessageBox.Show($"DB ì‘ì—… ì˜¤ë¥˜:\n{innerExMsg}\n\n{dbEx.ToString()}", "DB ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); try { foreach(var entry in dbEx.Entries) { entry.Reload(); } } catch { /* Reload ì‹¤íŒ¨ ë¬´ì‹œ */ } }
        private string ConvertToUnsecureString(SecureString securePassword) { if (securePassword == null) return string.Empty; IntPtr ptr = IntPtr.Zero; try { ptr = Marshal.SecureStringToGlobalAllocUnicode(securePassword); return Marshal.PtrToStringUni(ptr); } finally { Marshal.ZeroFreeGlobalAllocUnicode(ptr); } }
        #endregion

        #region IDisposable êµ¬í˜„ (ìì‹ ì˜ DbContext í•´ì œ)
        private bool disposed = false;
        protected virtual void Dispose(bool disposing) { if (!disposed) { if (disposing) { _context?.Dispose(); /* ìì‹ VM Dispose ì œê±° */ } disposed = true; } }
        public void Dispose() { Dispose(true); GC.SuppressFinalize(this); }
        #endregion
    }
}
3. Views/MasterDataWindow.xaml (ì‹ ê·œ íŒŒì¼)

ì´ íŒŒì¼ì€ Views í´ë”ì— ìƒˆë¡œ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤. ë‚´ìš©ì€ ì´ì „ì— MainWindow.xamlì˜ "ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬" íƒ­ì— ìˆë˜ UI ìš”ì†Œë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ë²„íŠ¼ ë“±ì˜ IsEnabled ë°”ì¸ë”©ì€ ì œê±°í•©ë‹ˆë‹¤ (ì´ ì°½ì€ ë§ˆìŠ¤í„° ëª¨ë“œì¼ ë•Œë§Œ ì—´ë¦¬ë¯€ë¡œ í•­ìƒ í™œì„±í™”).

XML

<dx:ThemedWindow
    x:Class="LockerManagementApp.Views.MasterDataWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:dx="http://schemas.devexpress.com/winfx/2008/xaml/core"
    xmlns:dxg="http://schemas.devexpress.com/winfx/2008/xaml/grid"
    xmlns:dxe="http://schemas.devexpress.com/winfx/2008/xaml/editors"
    xmlns:dxlc="http://schemas.devexpress.com/winfx/2008/xaml/layoutcontrol"
    xmlns:viewmodels="clr-namespace:LockerManagementApp.ViewModels"
    xmlns:models="clr-namespace:LockerManagementApp.Models"
    mc:Ignorable="d"
    Title="ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬" Height="600" Width="800"
    WindowStartupLocation="CenterOwner" ShowInTaskbar="False"
    Closing="MasterDataWindow_Closing">
    <Grid Margin="5">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <RowDefinition Height="*"/>    <RowDefinition Height="Auto"/> </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,5">
            <Button Content="ğŸ’¾ ë³€ê²½ ì‚¬í•­ ì €ì¥" Command="{Binding SaveChangesCommand}" Margin="3"/>
            <Button Content="ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨" Command="{Binding LoadAllMasterDataCommand}" Margin="3"/>
            <TextBlock Text="{Binding StatusMessage}" Margin="10,0,0,0" VerticalAlignment="Center" Foreground="Gray"/>
        </StackPanel>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <dxlc:LayoutControl Orientation="Vertical">
                <dxlc:LayoutGroup Header="ì‚¬ë¬¼í•¨ ì¢…ë¥˜" View="GroupBox" Orientation="Vertical" IsCollapsible="True" IsCollapsed="False">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                        <Button Content="ì¢…ë¥˜ ì¶”ê°€" Command="{Binding AddItemCommand}" CommandParameter="LockerType" Margin="0,0,5,0"/>
                        <Button Content="ì„ íƒ ì‚­ì œ" Command="{Binding DeleteItemCommand}"/>
                    </StackPanel>
                    <dxg:GridControl ItemsSource="{Binding LockerTypes}" SelectedItem="{Binding SelectedItem, Mode=TwoWay}" Height="150" MaxHeight="200">
                        <dxg:GridControl.View>
                            <dxg:TableView AllowEditing="True" NewItemRowPosition="None"/>
                        </dxg:GridControl.View>
                        <dxg:GridControl.Columns> <dxg:GridColumn FieldName="Name" Header="ì¢…ë¥˜ ì´ë¦„"/> </dxg:GridControl.Columns>
                    </dxg:GridControl>
                </dxlc:LayoutGroup>

                <dxlc:LayoutGroup Header="ì¸µ" View="GroupBox" Orientation="Vertical" IsCollapsible="True" IsCollapsed="True">
                     <StackPanel Orientation="Horizontal" Margin="0,0,0,5"> <Button Content="ì¸µ ì¶”ê°€" Command="{Binding AddItemCommand}" CommandParameter="Floor" Margin="0,0,5,0"/> <Button Content="ì„ íƒ ì‚­ì œ" Command="{Binding DeleteItemCommand}" /> </StackPanel>
                     <dxg:GridControl ItemsSource="{Binding Floors}" SelectedItem="{Binding SelectedItem, Mode=TwoWay}" Height="150" MaxHeight="200"> <dxg:GridControl.View><dxg:TableView AllowEditing="True" NewItemRowPosition="None"/></dxg:GridControl.View> <dxg:GridControl.Columns> <dxg:GridColumn FieldName="Name" Header="ì¸µ ì´ë¦„"/> </dxg:GridControl.Columns> </dxg:GridControl>
                </dxlc:LayoutGroup>

                <dxlc:LayoutGroup Header="êµ¬ì—­" View="GroupBox" Orientation="Vertical" IsCollapsible="True" IsCollapsed="True">
                     <StackPanel Orientation="Horizontal" Margin="0,0,0,5"> <Button Content="êµ¬ì—­ ì¶”ê°€" Command="{Binding AddItemCommand}" CommandParameter="Zone" Margin="0,0,5,0"/> <Button Content="ì„ íƒ ì‚­ì œ" Command="{Binding DeleteItemCommand}" /> </StackPanel>
                     <dxg:GridControl ItemsSource="{Binding Zones}" SelectedItem="{Binding SelectedItem, Mode=TwoWay}" Height="150" MaxHeight="200"> <dxg:GridControl.View><dxg:TableView AllowEditing="True" NewItemRowPosition="None"/></dxg:GridControl.View> <dxg:GridControl.Columns> <dxg:GridColumn FieldName="Name" Header="êµ¬ì—­ ì´ë¦„"/> </dxg:GridControl.Columns> </dxg:GridControl>
                </dxlc:LayoutGroup>

                <dxlc:LayoutGroup Header="ì†ŒíŒŒíŠ¸" View="GroupBox" Orientation="Vertical" IsCollapsible="True" IsCollapsed="True">
                     <StackPanel Orientation="Horizontal" Margin="0,0,0,5"> <Button Content="ì†ŒíŒŒíŠ¸ ì¶”ê°€" Command="{Binding AddItemCommand}" CommandParameter="SubPart" Margin="0,0,5,0"/> <Button Content="ì„ íƒ ì‚­ì œ" Command="{Binding DeleteItemCommand}" /> </StackPanel>
                     <dxg:GridControl ItemsSource="{Binding SubParts}" SelectedItem="{Binding SelectedItem, Mode=TwoWay}" Height="150" MaxHeight="200"> <dxg:GridControl.View><dxg:TableView AllowEditing="True" NewItemRowPosition="None"/></dxg:GridControl.View> <dxg:GridControl.Columns> <dxg:GridColumn FieldName="Name" Header="ì†ŒíŒŒíŠ¸ ì´ë¦„"/> </dxg:GridControl.Columns> </dxg:GridControl>
                </dxlc:LayoutGroup>

                <dxlc:LayoutGroup Header="ê´€ë¦¬ì" View="GroupBox" Orientation="Vertical" IsCollapsible="True" IsCollapsed="True">
                     <StackPanel Orientation="Horizontal" Margin="0,0,0,5"> <Button Content="ê´€ë¦¬ì ì¶”ê°€" Command="{Binding AddItemCommand}" CommandParameter="Administrator" Margin="0,0,5,0"/> <Button Content="ì„ íƒ ì‚­ì œ" Command="{Binding DeleteItemCommand}" /> </StackPanel>
                     <dxg:GridControl ItemsSource="{Binding Administrators}" SelectedItem="{Binding SelectedItem, Mode=TwoWay}" Height="150" MaxHeight="200"> <dxg:GridControl.View><dxg:TableView AllowEditing="True" NewItemRowPosition="None"/></dxg:GridControl.View> <dxg:GridControl.Columns> <dxg:GridColumn FieldName="Name" Header="ê´€ë¦¬ì ì´ë¦„"/> </dxg:GridControl.Columns> </dxg:GridControl>
                </dxlc:LayoutGroup>

            </dxlc:LayoutControl>
        </ScrollViewer>

        <Button Grid.Row="2" Content="ë‹«ê¸°" Width="80" HorizontalAlignment="Right" Margin="0,10,0,0" Click="CloseButton_Click"/>

    </Grid>
</dx:ThemedWindow>
í•µì‹¬ ë³€ê²½ ì‚¬í•­ ìš”ì•½:

ViewModel ë¶„ë¦¬: ê° ViewModel(MainViewModel, MasterDataViewModel, LogViewModel)ì´ ë…ë¦½ì ì¸ DbContext ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.
MainViewModel:
MasterDataViewModel, LogViewModel ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì†ì„±ìœ¼ë¡œ ê°€ì§€ì§€ë§Œ DbContextë¥¼ ì „ë‹¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
OpenMasterDataWindowCommandë¥¼ ì¶”ê°€í•˜ì—¬ MasterDataWindowë¥¼ ìƒì„±í•˜ê³  ShowDialog()ë¡œ ì—½ë‹ˆë‹¤. ì°½ì´ ë‹«íˆë©´ ì½¤ë³´ë°•ìŠ¤ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
Dispose ë©”ì„œë“œëŠ” ìì‹ ì˜ DbContextë§Œ í•´ì œí•©ë‹ˆë‹¤.
MasterDataViewModel, LogViewModel:
ìƒì„±ìì—ì„œ DbContextë¥¼ ì§ì ‘ ìƒì„±í•©ë‹ˆë‹¤.
IDisposableì„ êµ¬í˜„í•˜ì—¬ ìì‹ ì˜ DbContextë¥¼ í•´ì œí•©ë‹ˆë‹¤.
MasterDataViewModelì—ì„œ IsMasterModeEnabled ì†ì„± ë° ê´€ë ¨ í™•ì¸ ë¡œì§ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤ (ì°½ ìì²´ê°€ ê¶Œí•œ í™•ì¸ í›„ ì—´ë¦¬ë¯€ë¡œ).
MainWindow.xaml:
TabControlì„ ì œê±°í•˜ê³  "ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬" ë²„íŠ¼ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
ë²„íŠ¼ì˜ Visibilityë¥¼ MainViewModel.IsMasterModeEnabledì— ë°”ì¸ë”©í–ˆìŠµë‹ˆë‹¤.
MasterDataWindow.xaml (ì‹ ê·œ):
ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ë¥¼ ìœ„í•œ UI ìš”ì†Œë“¤ì„ í¬í•¨í•˜ëŠ” ìƒˆ ì°½ì…ë‹ˆë‹¤.
ë‚´ë¶€ ì»¨íŠ¸ë¡¤ë“¤ì€ í•­ìƒ í™œì„±í™” ìƒíƒœì…ë‹ˆë‹¤ (IsEnabled, AllowEditing ë°”ì¸ë”© ì œê±°).
ë‹¤ìŒ ë‹¨ê³„ë¡œ MasterDataWindow.xaml.cs íŒŒì¼ì„ ìƒì„±í•˜ê³ , MasterDataWindow.xamlì— ì¶”ê°€í•œ "ë‹«ê¸°" ë²„íŠ¼(CloseButton_Click)ì— ëŒ€í•œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ì œ 4,5,6ë²ˆ íŒŒì¼ì£¼ì‹­ì‹œì˜¤^^




ìƒê°í•˜ëŠ” ê³¼ì • í‘œì‹œ
ë„¤, ìš”ì²­í•˜ì‹  ëŒ€ë¡œ 4, 5, 6ë²ˆì§¸ íŒŒì¼ì— í•´ë‹¹í•˜ëŠ” ì½”ë“œë¥¼ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ìˆ˜ì •/ì¶”ê°€ë  íŒŒì¼ ëª©ë¡:

Views/MainWindow.xaml (ì´ì „ ë‹¨ê³„ì—ì„œ ì œê³µ)
ViewModels/MainViewModel.cs (ì´ì „ ë‹¨ê³„ì—ì„œ ì œê³µ)
Views/MasterDataWindow.xaml (ì´ì „ ë‹¨ê³„ì—ì„œ ì œê³µ)
Views/MasterDataWindow.xaml.cs (ì‹ ê·œ) <--- ì§€ê¸ˆ ì œê³µ
ViewModels/MasterDataViewModel.cs (ìˆ˜ì •) <--- ì§€ê¸ˆ ì œê³µ
Infrastructure/BooleanToVisibilityConverter.cs (ì‹ ê·œ/í•„ìˆ˜) <--- ì§€ê¸ˆ ì œê³µ
4. Views/MasterDataWindow.xaml.cs (ì‹ ê·œ)

ìƒˆë¡œ ì¶”ê°€í•œ MasterDataWindow.xaml íŒŒì¼ì— ëŒ€í•œ ì½”ë“œ ë¹„í•˜ì¸ë“œ íŒŒì¼ì…ë‹ˆë‹¤. ì°½ì„ ë‹«ëŠ” ë²„íŠ¼ ë¡œì§ê³¼, ì°½ì´ ë‹«í ë•Œ MasterDataViewModelì˜ ë¦¬ì†ŒìŠ¤(DbContext)ë¥¼ ì •ë¦¬í•˜ëŠ” ë¡œì§ì„ í¬í•¨í•©ë‹ˆë‹¤.

C#

using DevExpress.Xpf.Core; // ThemedWindow ì‚¬ìš©
using LockerManagementApp.ViewModels; // MasterDataViewModel ì°¸ì¡°
using System;
using System.ComponentModel; // CancelEventArgs ì‚¬ìš©
using System.Windows;

namespace LockerManagementApp.Views
{
    /// <summary>
    /// MasterDataWindow.xamlì— ëŒ€í•œ ìƒí˜¸ ì‘ìš© ë…¼ë¦¬
    /// </summary>
    public partial class MasterDataWindow : ThemedWindow
    {
        public MasterDataWindow()
        {
            InitializeComponent();
            // í…Œë§ˆ ì„¤ì • ë“± í•„ìš” ì‹œ ì¶”ê°€
            // ApplicationThemeHelper.ApplicationThemeName = Theme.Office2019ColorfulName;
        }

        // DataContextë¥¼ MasterDataViewModel íƒ€ì…ìœ¼ë¡œ ìºìŠ¤íŒ…í•˜ëŠ” í¸ì˜ ì†ì„±
        private MasterDataViewModel ViewModel => DataContext as MasterDataViewModel;

        /// <summary>
        /// "ë‹«ê¸°" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        /// </summary>
        private void CloseButton_Click(object sender, RoutedEventArgs e)
        {
            this.Close(); // í˜„ì¬ ì°½ì„ ë‹«ìŠµë‹ˆë‹¤.
        }

        /// <summary>
        /// ì°½ì´ ë‹«íˆê¸° ì „ì— í˜¸ì¶œë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        /// </summary>
        private void MasterDataWindow_Closing(object sender, CancelEventArgs e)
        {
            // DataContextë¡œ ì„¤ì •ëœ ViewModelì´ IDisposableì„ êµ¬í˜„í–ˆë‹¤ë©´ Dispose í˜¸ì¶œ
            if (ViewModel is IDisposable disposableViewModel)
            {
                try
                {
                    disposableViewModel.Dispose(); // ViewModelì˜ ë¦¬ì†ŒìŠ¤(DbContext) ì •ë¦¬
                }
                catch (Exception ex)
                {
                    // Dispose ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œê·¸ ê¸°ë¡ ë“± (ì„ íƒ ì‚¬í•­)
                    System.Diagnostics.Debug.WriteLine($"MasterDataViewModel Dispose ì˜¤ë¥˜: {ex.Message}");
                }
            }
        }
    }
}
5. ViewModels/MasterDataViewModel.cs (ìˆ˜ì •)

IsMasterModeEnabled ì†ì„± ë° ê´€ë ¨ ë¡œì§(CanExecute ë“±ì—ì„œì˜ í™•ì¸)ì„ ì œê±°í•©ë‹ˆë‹¤. ì´ ì°½ì€ ë§ˆìŠ¤í„° í‚¤ í™•ì¸ í›„ì—ë§Œ ì—´ë¦¬ë¯€ë¡œ ë‚´ë¶€ëŠ” í•­ìƒ í™œì„±í™” ìƒíƒœë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
C#

using LockerManagementApp.Data;
using LockerManagementApp.Models;
using LockerManagementApp.Infrastructure;
using System;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using System.Collections.Generic;
using System.Diagnostics;

namespace LockerManagementApp.ViewModels
{
    /// <summary>
    /// ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ViewModel (IsMasterModeEnabled ê´€ë ¨ ë¡œì§ ì œê±°)
    /// </summary>
    public class MasterDataViewModel : ViewModelBase, IDisposable
    {
        private readonly LockerDbContext _context;

        #region Observable Collections & Properties
        public ObservableCollection<LockerType> LockerTypes { get; set; }
        public ObservableCollection<Floor> Floors { get; set; }
        public ObservableCollection<Zone> Zones { get; set; }
        public ObservableCollection<SubPart> SubParts { get; set; }
        public ObservableCollection<Administrator> Administrators { get; set; }
        private object _selectedItem;
        public object SelectedItem { get => _selectedItem; set { if (SetProperty(ref _selectedItem, value)) RaiseCanExecuteChanged(); } } // CanExecute ê°±ì‹ 
        private string _statusMessage;
        public string StatusMessage { get => _statusMessage; set => SetProperty(ref _statusMessage, value); }

        // *** IsMasterModeEnabled ì†ì„± ì œê±°ë¨ ***
        // private bool _isMasterModeEnabled = false;
        // public bool IsMasterModeEnabled { ... }

        #endregion

        #region Commands
        public ICommand LoadAllMasterDataCommand { get; }
        public ICommand AddItemCommand { get; }
        public ICommand DeleteItemCommand { get; }
        public ICommand SaveChangesCommand { get; }
        #endregion

        public MasterDataViewModel()
        {
            try { _context = new LockerDbContext(); }
            catch (Exception ex) { MessageBox.Show($"[MasterData] DB ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜:\n{ex.ToString()}", "ì´ˆê¸°í™” ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); StatusMessage = "[MasterData] DB ì—°ê²° ì˜¤ë¥˜!"; LockerTypes = new ObservableCollection<LockerType>(); Floors = new ObservableCollection<Floor>(); Zones = new ObservableCollection<Zone>(); SubParts = new ObservableCollection<SubPart>(); Administrators = new ObservableCollection<Administrator>(); LoadAllMasterDataCommand = new RelayCommand(_ => { }, _ => false); AddItemCommand = new RelayCommand(_ => { }, _ => false); DeleteItemCommand = new RelayCommand(_ => { }, _ => false); SaveChangesCommand = new RelayCommand(_ => { }, _ => false); return; }

            LockerTypes = new ObservableCollection<LockerType>(); Floors = new ObservableCollection<Floor>(); Zones = new ObservableCollection<Zone>(); SubParts = new ObservableCollection<SubPart>(); Administrators = new ObservableCollection<Administrator>();

            // Command ì´ˆê¸°í™” (CanExecuteì—ì„œ IsMasterModeEnabled ì¡°ê±´ ì œê±°)
            LoadAllMasterDataCommand = new RelayCommand(async _ => await LoadAllMasterDataAsync());
            AddItemCommand = new RelayCommand(AddItem, CanAddItemExecute);
            DeleteItemCommand = new RelayCommand(DeleteItem, CanDeleteItemExecute);
            SaveChangesCommand = new RelayCommand(async _ => await SaveMasterDataChangesAsync(), CanSaveChangesExecute); // ì €ì¥ ê°€ëŠ¥ ì¡°ê±´ì€ ë³€ê²½ ì—¬ë¶€ë§Œ í™•ì¸

            if (_context != null) { _ = LoadAllMasterDataAsync(); }
        }

        #region Data Loading and CRUD Methods
        public async Task LoadAllMasterDataAsync() { if (_context == null) return; StatusMessage = "ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”© ì¤‘..."; try { var lockerTypes = await _context.LockerTypes.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); LockerTypes.Clear(); lockerTypes.ForEach(LockerTypes.Add); var floors = await _context.Floors.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); Floors.Clear(); floors.ForEach(Floors.Add); var zones = await _context.Zones.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); Zones.Clear(); zones.ForEach(Zones.Add); var subParts = await _context.SubParts.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); SubParts.Clear(); subParts.ForEach(SubParts.Add); var administrators = await _context.Administrators.OrderBy(x => x.Name).AsNoTracking().ToListAsync(); Administrators.Clear(); administrators.ForEach(Administrators.Add); StatusMessage = "ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë“œ ì™„ë£Œ."; } catch (Exception ex) { StatusMessage = $"ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: {ex.Message}"; MessageBox.Show(StatusMessage, "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } }

        // *** ìˆ˜ì •ëœ ë¶€ë¶„: CanExecute ë©”ì„œë“œì—ì„œ IsMasterModeEnabled ì¡°ê±´ ì œê±° ***
        private bool CanAddItemExecute(object parameter) => _context != null && parameter is string category && !string.IsNullOrEmpty(category);
        private bool CanDeleteItemExecute(object parameter) => _context != null && SelectedItem != null; // ì„ íƒëœ í•­ëª©ì´ ìˆì„ ë•Œë§Œ ì‚­ì œ ê°€ëŠ¥
        private bool CanSaveChangesExecute(object parameter) => _context != null && _context.ChangeTracker.HasChanges(); // ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì €ì¥ ê°€ëŠ¥

        private void AddItem(object parameter)
        {
            // IsMasterModeEnabled í™•ì¸ ì œê±°
            if (_context == null) return;
            if (parameter is string category) { try { object newItem = null; switch (category.ToLower()) { case "lockertype": newItem = _context.LockerTypes.Add(new LockerType { Name = "ìƒˆ ì¢…ë¥˜" }); LockerTypes.Add((LockerType)newItem); break; case "floor": newItem = _context.Floors.Add(new Floor { Name = "ìƒˆ ì¸µ" }); Floors.Add((Floor)newItem); break; case "zone": newItem = _context.Zones.Add(new Zone { Name = "ìƒˆ êµ¬ì—­" }); Zones.Add((Zone)newItem); break; case "subpart": newItem = _context.SubParts.Add(new SubPart { Name = "ìƒˆ ì†ŒíŒŒíŠ¸" }); SubParts.Add((SubPart)newItem); break; case "administrator": newItem = _context.Administrators.Add(new Administrator { Name = "ìƒˆ ê´€ë¦¬ì" }); Administrators.Add((Administrator)newItem); break; default: MessageBox.Show("ì•Œ ìˆ˜ ì—†ëŠ” ì¹´í…Œê³ ë¦¬.", "ì˜¤ë¥˜"); return; } SelectedItem = newItem; StatusMessage = "ìƒˆ í•­ëª© ì¶”ê°€ë¨. ì €ì¥ í•„ìš”."; RaiseCanExecuteChanged(); } catch (Exception ex) { StatusMessage = $"í•­ëª© ì¶”ê°€ ì˜¤ë¥˜: {ex.Message}"; MessageBox.Show(StatusMessage, "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); } }
        }

        private void DeleteItem(object parameter)
        {
            // IsMasterModeEnabled í™•ì¸ ì œê±°
            if (_context == null || SelectedItem == null) return;
            string itemName = GetItemName(SelectedItem); if (itemName == null) return; string confirmMessage = $"'{itemName}' ì‚­ì œ?"; if (HasAssociatedAssignments(SelectedItem, itemName)) { confirmMessage += "\n\nê²½ê³ : ì‚¬ìš© ì¤‘ì¸ ì‚¬ë¬¼í•¨ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤!"; } if (MessageBox.Show(confirmMessage, "ì‚­ì œ í™•ì¸", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.Yes) { try { object entityToDelete = null; if (SelectedItem is LockerType lt) entityToDelete = lt; else if (SelectedItem is Floor f) entityToDelete = f; else if (SelectedItem is Zone z) entityToDelete = z; else if (SelectedItem is SubPart sp) entityToDelete = sp; else if (SelectedItem is Administrator ad) entityToDelete = ad; else return; var entry = _context.Entry(entityToDelete); if (entry.State == EntityState.Detached) _context.Set(entityToDelete.GetType()).Attach(entityToDelete); entry.State = EntityState.Deleted; if (SelectedItem is LockerType lt1) LockerTypes.Remove(lt1); else if (SelectedItem is Floor f1) Floors.Remove(f1); else if (SelectedItem is Zone z1) Zones.Remove(z1); else if (SelectedItem is SubPart sp1) SubParts.Remove(sp1); else if (SelectedItem is Administrator ad1) Administrators.Remove(ad1); SelectedItem = null; StatusMessage = "í•­ëª© ì‚­ì œ ëŒ€ê¸° ì¤‘. ì €ì¥ í•„ìš”."; RaiseCanExecuteChanged(); } catch (Exception ex) { StatusMessage = $"í•­ëª© ì‚­ì œ ì˜¤ë¥˜: {ex.Message}"; MessageBox.Show(StatusMessage, "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); _ = LoadAllMasterDataAsync(); } }
        }

        private string GetItemName(object item) { return item?.GetType().GetProperty("Name")?.GetValue(item)?.ToString(); }
        private bool HasAssociatedAssignments(object item, string itemName) { if (_context == null || item == null || string.IsNullOrEmpty(itemName)) return false; try { if (item is LockerType) return _context.LockerAssignments.Any(a => a.LockerType == itemName); if (item is Floor) return _context.LockerAssignments.Any(a => a.Floor == itemName); if (item is Zone) return _context.LockerAssignments.Any(a => a.Zone == itemName); if (item is SubPart) return _context.LockerAssignments.Any(a => a.SubPart == itemName); if (item is Administrator) return _context.LockerAssignments.Any(a => a.Administrator == itemName); } catch (Exception ex) { Debug.WriteLine($"ì—°ê´€ ë°ì´í„° í™•ì¸ ì˜¤ë¥˜: {ex.Message}"); return true; } return false; }

        /// <summary>
        /// ë§ˆìŠ¤í„° ë°ì´í„° ë³€ê²½ ì‚¬í•­ ì €ì¥ (ì—°ì‡„ ì—…ë°ì´íŠ¸ í¬í•¨) - ë§ˆìŠ¤í„° ëª¨ë“œ í™•ì¸ ì œê±°
        /// </summary>
        private async Task SaveMasterDataChangesAsync()
        {
            // IsMasterModeEnabled í™•ì¸ ì œê±°
            if (_context == null || !CanSaveChangesExecute(null)) // ë³€ê²½ ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
            {
                StatusMessage = "ì €ì¥í•  ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            StatusMessage = "ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥ ì¤‘...";
            List<DbEntityEntry> changesForRollback = _context.ChangeTracker.Entries().Where(e => e.State != EntityState.Unchanged).ToList();

            using (var transaction = _context.Database.BeginTransaction()) { try { Debug.WriteLine("ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥ ì‹œì‘ - íŠ¸ëœì­ì…˜ ì‹œì‘ë¨."); var modifiedNameEntries = _context.ChangeTracker.Entries().Where(e => e.State == EntityState.Modified && (e.Entity is LockerType || e.Entity is Floor || e.Entity is Zone || e.Entity is SubPart || e.Entity is Administrator)).Select(e => new { Entry = e, EntityType = e.Entity.GetType(), OriginalName = e.OriginalValues["Name"]?.ToString(), CurrentName = e.CurrentValues["Name"]?.ToString() }).Where(x => x.OriginalName != null && x.CurrentName != null && x.OriginalName != x.CurrentName).ToList(); Debug.WriteLine($"ì´ë¦„ ë³€ê²½ ê°ì§€ëœ ë§ˆìŠ¤í„° ë°ì´í„° ìˆ˜: {modifiedNameEntries.Count}"); foreach (var modified in modifiedNameEntries) { StatusMessage = $"'{modified.OriginalName}' -> '{modified.CurrentName}' ì—°ì‡„ ì—…ë°ì´íŠ¸ ì¤‘..."; Debug.WriteLine($"ì—°ì‡„ ì—…ë°ì´íŠ¸ ì‹œë„: Type={modified.EntityType.Name}, Original='{modified.OriginalName}', New='{modified.CurrentName}'"); int updatedCount = 0; string updateSql = ""; string targetColumn = ""; if (modified.EntityType == typeof(LockerType)) targetColumn = "LockerType"; else if (modified.EntityType == typeof(Floor)) targetColumn = "Floor"; else if (modified.EntityType == typeof(Zone)) targetColumn = "Zone"; else if (modified.EntityType == typeof(SubPart)) targetColumn = "SubPart"; else if (modified.EntityType == typeof(Administrator)) targetColumn = "Administrator"; if (!string.IsNullOrEmpty(targetColumn)) { updateSql = $"UPDATE LockerAssignments SET [{targetColumn}] = {{0}} WHERE [{targetColumn}] = {{1}}"; try { updatedCount = await _context.Database.ExecuteSqlCommandAsync(updateSql, modified.CurrentName, modified.OriginalName); StatusMessage = $"'{modified.OriginalName}' -> '{modified.CurrentName}' ({updatedCount}ê°œ ì—…ë°ì´íŠ¸ ì™„ë£Œ)."; Debug.WriteLine($"  SQL ì‹¤í–‰ ì„±ê³µ: {updateSql} | Params: '{modified.CurrentName}', '{modified.OriginalName}' | Rows Affected: {updatedCount}"); } catch (Exception sqlEx) { Debug.WriteLine($"*** ì—°ì‡„ ì—…ë°ì´íŠ¸ SQL ì‹¤í–‰ ì˜¤ë¥˜! SQL: {updateSql}, Params: '{modified.CurrentName}', '{modified.OriginalName}'\n*** ì˜¤ë¥˜: {sqlEx.ToString()}"); StatusMessage = $"'{modified.OriginalName}' ì—°ì‡„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!"; throw; } } else { Debug.WriteLine($"  ê²½ê³ : ì—”í‹°í‹° íƒ€ì… '{modified.EntityType.Name}'ì— ëŒ€í•œ ëŒ€ìƒ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); } } Debug.WriteLine("ë§ˆìŠ¤í„° ë°ì´í„° ë³€ê²½ ì‚¬í•­ ì €ì¥ ì‹œë„ (SaveChangesAsync)..."); int masterDataChanges = await _context.SaveChangesAsync(); Debug.WriteLine($"ë§ˆìŠ¤í„° ë°ì´í„° SaveChanges ì™„ë£Œ. ë³€ê²½ ê±´ìˆ˜: {masterDataChanges}"); transaction.Commit(); Debug.WriteLine("íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì™„ë£Œ."); StatusMessage = $"ë§ˆìŠ¤í„° ë°ì´í„° ë³€ê²½ ì‚¬í•­ ({masterDataChanges}ê±´) ë° ì—°ì‡„ ì—…ë°ì´íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."; } catch (Exception ex) { Debug.WriteLine($"*** ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ! íŠ¸ëœì­ì…˜ ë¡¤ë°± ì‹œë„...\n*** ì˜¤ë¥˜: {ex.ToString()}"); try { transaction.Rollback(); Debug.WriteLine("íŠ¸ëœì­ì…˜ ë¡¤ë°± ì™„ë£Œ."); } catch (Exception rollbackEx) { Debug.WriteLine($"*** íŠ¸ëœì­ì…˜ ë¡¤ë°± ì¤‘ ì˜¤ë¥˜ ë°œìƒ!\n*** ì˜¤ë¥˜: {rollbackEx.ToString()}"); } StatusMessage = $"ë§ˆìŠ¤í„° ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}"; MessageBox.Show($"{StatusMessage}\n\nìì„¸í•œ ë‚´ìš©ì€ ì¶œë ¥ ì°½ì„ í™•ì¸í•˜ì„¸ìš”.", "ì €ì¥ ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error); RollbackMasterDataChanges(changesForRollback); } } await LoadAllMasterDataAsync(); RaiseCanExecuteChanged(); // ì €ì¥ í›„ CanExecute ìƒíƒœ ê°±ì‹ 
        }
        private void RollbackMasterDataChanges(List<DbEntityEntry> changedEntries) { if (_context == null || changedEntries == null) return; foreach (var entry in changedEntries) { switch (entry.State) { case EntityState.Modified: try { entry.Reload(); } catch { entry.State = EntityState.Unchanged; } break; case EntityState.Added: entry.State = EntityState.Detached; break; case EntityState.Deleted: entry.State = EntityState.Unchanged; break; } } StatusMessage = "ë§ˆìŠ¤í„° ë°ì´í„° ë³€ê²½ ë¡¤ë°±ë¨."; _ = LoadAllMasterDataAsync(); }
        #endregion

        /// <summary>
        /// ëª¨ë“  Commandì˜ CanExecute ìƒíƒœë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
        /// </summary>
        private void RaiseCanExecuteChanged()
        {
            (AddItemCommand as RelayCommand)?.RaiseCanExecuteChanged();
            (DeleteItemCommand as RelayCommand)?.RaiseCanExecuteChanged();
            (SaveChangesCommand as RelayCommand)?.RaiseCanExecuteChanged();
        }

        #region IDisposable êµ¬í˜„
        private bool disposed = false;
        protected virtual void Dispose(bool disposing) { if (!disposed) { if (disposing) { _context?.Dispose(); } disposed = true; } }
        public void Dispose() { Dispose(true); GC.SuppressFinalize(this); }
        #endregion
    }
}
6. Infrastructure/BooleanToVisibilityConverter.cs (ì‹ ê·œ/í•„ìˆ˜) Â  

MainWindow.xamlì—ì„œ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ ë²„íŠ¼ì˜ Visibilityë¥¼ ì œì–´í•˜ê¸° ìœ„í•´ ì´ ì»¨ë²„í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤. Infrastructure í´ë”ì— ì´ íŒŒì¼ì„ ì¶”ê°€í•˜ì„¸ìš”.

C#

using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace LockerManagementApp.Infrastructure
{
    /// <summary>
    /// bool ê°’ì„ Visibility ê°’ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” WPF IValueConverter ì…ë‹ˆë‹¤.
    /// true -> Visibility.Visible
    /// false -> Visibility.Collapsed
    /// </summary>
    [ValueConversion(typeof(bool), typeof(Visibility))]
    public class BooleanToVisibilityConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is bool boolValue)
            {
                return boolValue ? Visibility.Visible : Visibility.Collapsed;
            }
            return Visibility.Collapsed;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
ì´ì œ ì´ íŒŒì¼ë“¤ì„ í”„ë¡œì íŠ¸ì— ì ìš©í•˜ê³  ë‹¤ì‹œ ë¹Œë“œí•˜ì—¬ ì‹¤í–‰í•´ ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤. ë§ˆìŠ¤í„° í‚¤ë¥¼ í™•ì¸í•˜ë©´ "ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬" ë²„íŠ¼ì´ ë‚˜íƒ€ë‚˜ê³ , ì´ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìƒˆ ì°½ì´ ì—´ë¦¬ë©°, í•´ë‹¹ ì°½ ë‚´ë¶€ì˜ ì»¨íŠ¸ë¡¤ë“¤ì€ í•­ìƒ í™œì„±í™”ëœ ìƒíƒœì¼ ê²ƒì…ë‹ˆë‹¤.


ì†ŒìŠ¤ ë° ê´€ë ¨ ì½˜í…ì¸ 
github.com
github.com
stackoverflow.com
stackoverflow.com
www.gokhan-gokalp.com
www.gokhan-gokalp.com
github.com
github.com
stackoverflow.com
stackoverflow.com

ë‚´ê°€ ì´ê³¼ì œ ì¤‘ê°„ì ê²€ì„ í•´ë³´ë ¤ê³ í•´ìš” ëª¨ë“ íŒŒì¼êµ¬ì¡°.ì´ë¦„ë§Œ ì ì–´ì£¼ì„¸ìš”




ìƒê°í•˜ëŠ” ê³¼ì • í‘œì‹œ
ë„¤, ì•Œê² ìŠµë‹ˆë‹¤. í˜„ì¬ê¹Œì§€ ì‘ì—…í•œ .NET Framework 4.8 ê¸°ë°˜ WPF ì‚¬ë¬¼í•¨ ê´€ë¦¬ í”„ë¡œê·¸ë¨ì˜ ì „ì²´ íŒŒì¼ êµ¬ì¡° ë° ì´ë¦„ ëª©ë¡ì„ ì •ë¦¬í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
í”„ë¡œì íŠ¸ íŒŒì¼ êµ¬ì¡° ëª©ë¡
4ì›” 8, 7:27 PM

ì—´ê¸°

MasterDataWindow.xaml ì´ê±° ì „ì²´ì½”ë“œ ë‹¤ì‹œì¤˜ë³´ì„¸ìš”




ìƒê°í•˜ëŠ” ê³¼ì • í‘œì‹œ
ë„¤, ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ë¥¼ ìœ„í•œ ë³„ë„ ì°½ì˜ XAML ì½”ë“œì¸ MasterDataWindow.xaml íŒŒì¼ ì „ì²´ë¥¼ ë‹¤ì‹œ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ì´ ì°½ì€ ë§ˆìŠ¤í„° í‚¤ í™•ì¸ í›„ì—ë§Œ ì—´ë¦¬ë¯€ë¡œ, ë‚´ë¶€ì˜ ì»¨íŠ¸ë¡¤(ë²„íŠ¼, ê·¸ë¦¬ë“œ í¸ì§‘ ë“±)ì€ í•­ìƒ í™œì„±í™”ëœ ìƒíƒœë¥¼ ê°€ì •í•˜ê³  IsEnabled ì´ë‚˜ AllowEditing ê´€ë ¨ ë°”ì¸ë”©ì€ ì œê±°í–ˆìŠµë‹ˆë‹¤. (Commandì˜ CanExecute ë¡œì§ì—ì„œ ì‹¤ì œ ì‹¤í–‰ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.)
Views/MasterDataWindow.xaml (ìµœì¢…)
4ì›” 9, 7:41 AM

ì—´ê¸°






Canvas

GeminiëŠ” ì¸ë¬¼ ë“±ì— ê´€í•œ ì •ë³´ ì œê³µ ì‹œ ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìœ¼ë‹ˆ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ì„¸ìš”. ê°œì¸ ì •ë³´ ë³´í˜¸ ë° Gemini