;WITH RankedDecreases AS (
    SELECT
        ipadd1,
        partition1,
        DateRecorded,
        DecreaseAmount,
        RANK() OVER (PARTITION BY DateRecorded ORDER BY DecreaseAmount) AS Rank
    FROM HDDLogs
),
TopRankedHDD AS (
    SELECT
        ipadd1,
        partition1,
        COUNT(*) AS DaysWithTop10Rank
    FROM RankedDecreases
    WHERE Rank <= 10
    GROUP BY ipadd1, partition1
),
HDDStatistics AS (
    SELECT
        ipadd1,
        partition1,
        AVG(CAST(DecreaseAmount AS FLOAT)) AS AvgDecrease,
        STDEV(CAST(DecreaseAmount AS FLOAT)) AS StdDevDecrease
    FROM HDDLogs
    GROUP BY ipadd1, partition1
),
CVData AS (
    SELECT
        ipadd1,
        partition1,
        StdDevDecrease / NULLIF(AvgDecrease, 0) AS CoefficientOfVariation
    FROM HDDStatistics
)
SELECT 
    a.ipadd1,
    a.partition1,
    a.DaysWithTop10Rank,
    c.CoefficientOfVariation
FROM TopRankedHDD a
JOIN CVData c ON a.ipadd1 = c.ipadd1 AND a.partition1 = c.partition1
ORDER BY a.DaysWithTop10Rank DESC;
