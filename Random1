전 이해했어!
최종 결과는 다음처럼 나오기를 원하는 거지:

model1	MaxCol_ACT2	MaxVal_ACT2	MaxCol_ACT2BEST	MaxVal_ACT2BEST
A100	ACT2_5	0.58	ACT2BEST_2	0.51
즉, ACT2 계열 중에서 최댓값의 컬럼명과 그 값, 그리고
ACT2BEST 계열 중에서 최댓값의 컬럼명과 그 값을 모델별로 뽑아줘야 해.

최종 쿼리 (요구사항 반영):
sql
코드 복사
WITH LastestModels AS (
    SELECT DISTINCT model1
    FROM dbo.ExcelData
    WHERE line1 = 'SMD_12'
      AND CAST(time1 AS DATE) = '2025-03-28'
),
ExcelFiltered AS (
    SELECT
        E.time1,
        E.model1,
        E.line1,
        E.ACT2_1, E.ACT2_2, E.ACT2_3, E.ACT2_4,
        E.ACT2_5, E.ACT2_6, E.ACT2_7, E.ACT2_8,
        E.ACT2BEST_1, E.ACT2BEST_2, E.ACT2BEST_3, E.ACT2BEST_4,
        E.ACT2BEST_5, E.ACT2BEST_6, E.ACT2BEST_7, E.ACT2BEST_8
    FROM dbo.ExcelData E
    INNER JOIN LastestModels L ON E.model1 = L.model1
    WHERE E.time1 >= DATEADD(HOUR, -5, GETDATE())
),
Unpivoted AS (
    SELECT
        model1,
        ColName,
        Value
    FROM ExcelFiltered
    UNPIVOT (
        Value FOR ColName IN (
            ACT2_1, ACT2_2, ACT2_3, ACT2_4, ACT2_5, ACT2_6, ACT2_7, ACT2_8,
            ACT2BEST_1, ACT2BEST_2, ACT2BEST_3, ACT2BEST_4,
            ACT2BEST_5, ACT2BEST_6, ACT2BEST_7, ACT2BEST_8
        )
    ) AS Unpvt
    WHERE Value > 0
),
WithQuantiles AS (
    SELECT
        model1,
        ColName,
        Value,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q3
    FROM Unpivoted
),
FilteredByIQR AS (
    SELECT model1, ColName, Value
    FROM WithQuantiles
    WHERE Value BETWEEN Q1 AND Q3
),
MinByCol AS (
    SELECT
        model1,
        ColName,
        MIN(Value) AS MinValueWithoutOutliers
    FROM FilteredByIQR
    GROUP BY model1, ColName
),
RankedMax AS (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY model1 ORDER BY 
               CASE WHEN ColName LIKE 'ACT2_%' THEN MinValueWithoutOutliers ELSE NULL END DESC) AS RN_ACT2,
           ROW_NUMBER() OVER (PARTITION BY model1 ORDER BY 
               CASE WHEN ColName LIKE 'ACT2BEST_%' THEN MinValueWithoutOutliers ELSE NULL END DESC) AS RN_ACT2BEST
    FROM MinByCol
),
FinalGrouped AS (
    SELECT model1,
        MAX(CASE WHEN RN_ACT2 = 1 AND ColName LIKE 'ACT2_%' THEN ColName END) AS MaxCol_ACT2,
        MAX(CASE WHEN RN_ACT2 = 1 AND ColName LIKE 'ACT2_%' THEN MinValueWithoutOutliers END) AS MaxVal_ACT2,
        MAX(CASE WHEN RN_ACT2BEST = 1 AND ColName LIKE 'ACT2BEST_%' THEN ColName END) AS MaxCol_ACT2BEST,
        MAX(CASE WHEN RN_ACT2BEST = 1 AND ColName LIKE 'ACT2BEST_%' THEN MinValueWithoutOutliers END) AS MaxVal_ACT2BEST
    FROM RankedMax
    GROUP BY model1
)
SELECT *
FROM FinalGrouped
ORDER BY model1;
결과 컬럼 설명:
model1: 모델명

MaxCol_ACT2: ACT2 그룹에서 가장 큰 값을 가진 컬럼 이름

MaxVal_ACT2: ACT2 그룹의 가장 큰 값

MaxCol_ACT2BEST: ACT2BEST 그룹에서 가장 큰 값을 가진 컬럼 이름

MaxVal_ACT2BEST: ACT2BEST 그룹의 가장 큰 값
