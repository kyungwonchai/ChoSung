import os
import sys

# 프로젝트 설정
PROJECT_NAME = "my_wordbook"
UPLOAD_FOLDER = "uploads"
DB_NAME = "wordbook.db"

# 플라스크 앱 (app.py) 소스코드
APP_PY_CONTENT = """
import os
import sqlite3
import datetime
import random
import uuid
from flask import Flask, render_template, request, jsonify, send_from_directory, g

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = 'uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024
DATABASE = 'wordbook.db'

def get_db():
    db = getattr(g, '_database', None)
    if db is None:
        db = g._database = sqlite3.connect(DATABASE)
        db.row_factory = sqlite3.Row
    return db

@app.teardown_appcontext
def close_connection(exception):
    db = getattr(g, '_database', None)
    if db is not None:
        db.close()

def init_db():
    with app.app_context():
        db = get_db()
        db.execute('''
            CREATE TABLE IF NOT EXISTS cards (
                id TEXT PRIMARY KEY,
                type TEXT NOT NULL,
                content TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                views INTEGER DEFAULT 0,
                next_review DATE DEFAULT NULL,
                scale REAL DEFAULT 1.0
            )
        ''')
        db.execute('''
            CREATE TABLE IF NOT EXISTS stats (
                date DATE PRIMARY KEY,
                count INTEGER DEFAULT 0
            )
        ''')
        # 혹시 모를 마이그레이션 (scale 컬럼)
        try:
            db.execute('ALTER TABLE cards ADD COLUMN scale REAL DEFAULT 1.0')
        except sqlite3.OperationalError:
            pass
        db.commit()

# --- 라우트 ---

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/uploads/<filename>')
def uploaded_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@app.route('/api/cards', methods=['GET'])
def get_cards():
    mode = request.args.get('mode', 'all')
    sort_by = request.args.get('sort', 'random')
    
    db = get_db()
    query = "SELECT * FROM cards"
    args = []
    
    if mode == 'study':
        today = datetime.date.today().isoformat()
        query += " WHERE next_review IS NULL OR next_review <= ?"
        args.append(today)
        
    if sort_by == 'date':
        query += " ORDER BY created_at DESC"
    else:
        query += " ORDER BY RANDOM()"

    cursor = db.execute(query, args)
    cards = [dict(row) for row in cursor.fetchall()]
    return jsonify(cards)

@app.route('/api/cards', methods=['POST'])
def add_card():
    db = get_db()
    card_id = str(uuid.uuid4())
    
    if 'image' in request.files:
        file = request.files['image']
        if file.filename != '':
            ext = os.path.splitext(file.filename)[1]
            filename = f"{card_id}{ext}"
            filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
            file.save(filepath)
            db.execute('INSERT INTO cards (id, type, content, scale) VALUES (?, ?, ?, ?)',
                       (card_id, 'image', filename, 1.0))
            db.commit()
            return jsonify({'success': True})

    data = request.form
    if 'text' in data and data['text'].strip():
        db.execute('INSERT INTO cards (id, type, content, scale) VALUES (?, ?, ?, ?)',
                   (card_id, 'text', data['text'], 1.0))
        db.commit()
        return jsonify({'success': True})
        
    return jsonify({'success': False}), 400

# [삭제 기능 추가]
@app.route('/api/cards/<card_id>', methods=['DELETE'])
def delete_card(card_id):
    db = get_db()
    
    # 1. 파일 삭제를 위해 정보 조회
    cursor = db.execute('SELECT type, content FROM cards WHERE id = ?', (card_id,))
    row = cursor.fetchone()
    
    if row:
        # 이미지 파일이면 실제 파일도 삭제
        if row['type'] == 'image':
            file_path = os.path.join(app.config['UPLOAD_FOLDER'], row['content'])
            if os.path.exists(file_path):
                os.remove(file_path)
        
        # 2. DB 삭제
        db.execute('DELETE FROM cards WHERE id = ?', (card_id,))
        db.commit()
        return jsonify({'success': True})
    
    return jsonify({'success': False, 'msg': 'Card not found'}), 404

@app.route('/api/cards/<card_id>/view', methods=['POST'])
def view_card(card_id):
    db = get_db()
    today = datetime.date.today().isoformat()
    db.execute('UPDATE cards SET views = views + 1 WHERE id = ?', (card_id,))
    db.execute('''
        INSERT INTO stats (date, count) VALUES (?, 1)
        ON CONFLICT(date) DO UPDATE SET count = count + 1
    ''', (today,))
    db.commit()
    return jsonify({'success': True})

@app.route('/api/cards/<card_id>/hide', methods=['POST'])
def hide_card(card_id):
    days = int(request.json.get('days', 0))
    next_date = None
    if days > 0:
        next_date = (datetime.date.today() + datetime.timedelta(days=days)).isoformat()
    
    db = get_db()
    db.execute('UPDATE cards SET next_review = ? WHERE id = ?', (next_date, card_id))
    db.commit()
    return jsonify({'success': True, 'next_review': next_date})

@app.route('/api/cards/<card_id>/scale', methods=['POST'])
def update_scale(card_id):
    scale = float(request.json.get('scale', 1.0))
    db = get_db()
    db.execute('UPDATE cards SET scale = ? WHERE id = ?', (scale, card_id))
    db.commit()
    return jsonify({'success': True})

@app.route('/api/stats', methods=['GET'])
def get_stats():
    db = get_db()
    cursor = db.execute('SELECT * FROM stats ORDER BY date DESC LIMIT 30')
    stats = [dict(row) for row in cursor.fetchall()]
    return jsonify(stats)

if __name__ == '__main__':
    if not os.path.exists(app.config['UPLOAD_FOLDER']):
        os.makedirs(app.config['UPLOAD_FOLDER'])
    init_db()
    # [포트 변경] 9500
    app.run(host='0.0.0.0', port=9500, debug=True)
"""

INDEX_HTML_CONTENT = """
<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G-Wordbook 9500</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#121212',
                        cardbg: '#1e1e1e',
                        accent: '#00d084',
                        danger: '#ff4444'
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 모바일 브라우저 주소창 대응 100dvh 사용 */
        body { 
            background-color: #121212; 
            color: #ffffff; 
            overflow: hidden; 
            touch-action: manipulation;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
        }
        
        .card-wrapper {
            flex-grow: 1;
            width: 100%;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; perspective: 1000px;
            position: relative;
        }
        
        .card-content-box {
            transition: transform 0.1s ease-out;
            transform-origin: center center;
            max-width: 90%; max-height: 80%; /* 하단 UI 공간 확보를 위해 높이 줄임 */
            display: flex; align-items: center; justify-content: center;
        }
        .content-image { max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .content-text { font-size: 1.6rem; font-weight: bold; line-height: 1.6; white-space: pre-wrap; text-align: center; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #00d084; cursor: pointer; margin-top: -10px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #555; border-radius: 2px; }

        /* 하단바 안전영역 확보 */
        .safe-area-pb {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
    </style>
</head>
<body>

    <!-- 상단 헤더 -->
    <header class="flex justify-between items-center p-3 bg-cardbg border-b border-gray-800 z-20 shrink-0 h-14">
        <div class="flex items-center space-x-2">
            <h1 class="text-lg font-bold text-accent tracking-tighter">GENIUS</h1>
            <span id="cardCounter" class="text-xs text-gray-400 bg-gray-800 px-2 py-1 rounded-full">0/0</span>
        </div>
        <div class="flex space-x-2">
            <!-- 전체화면 버튼 -->
            <button onclick="toggleFullScreen()" class="text-gray-400 hover:text-white px-2">
                <i class="fa-solid fa-expand"></i>
            </button>
            <button onclick="toggleEditMode()" id="editBtn" class="text-sm px-3 py-1 rounded bg-gray-700 text-gray-300 transition-colors">
                <i class="fa-solid fa-pen"></i> 편집
            </button>
            <button onclick="toggleMode()" id="modeBtn" class="text-sm px-3 py-1 rounded bg-gray-700 w-16">전체</button>
        </div>
    </header>

    <!-- 메인 영역 -->
    <main class="flex-grow relative w-full flex flex-col overflow-hidden bg-darkbg" id="mainArea">
        
        <!-- 숨김 해제 알림 -->
        <div id="hiddenStatus" class="absolute top-2 left-0 w-full z-10 flex justify-center hidden">
            <button onclick="resetSchedule()" class="bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg opacity-90 animate-pulse">
                <i class="fa-solid fa-eye-slash"></i> 숨김 해제
            </button>
        </div>

        <!-- 카드 표시 영역 -->
        <div class="card-wrapper" id="cardArea">
            <div id="loading" class="text-gray-500">로딩중...</div>
            <div id="emptyMsg" class="hidden text-gray-500 flex flex-col items-center">
                <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
                <span>카드가 없습니다.</span>
            </div>
            
            <div id="zoomTarget" class="card-content-box hidden">
                <!-- JS 주입 -->
            </div>
        </div>

        <!-- 편집 모드 컨트롤러 (오버레이) -->
        <div id="editControls" class="absolute bottom-0 left-0 w-full px-6 pt-4 pb-6 bg-black bg-opacity-90 z-40 hidden flex flex-col items-center border-t border-gray-700 transform transition-transform duration-300 translate-y-full safe-area-pb">
            
            <div class="w-full flex justify-between items-center mb-4">
                <div class="text-sm text-gray-300 w-full">
                    <div class="flex justify-between mb-1">
                        <span>크기 조절</span>
                        <span id="scaleValue" class="text-accent font-bold">100%</span>
                    </div>
                    <input type="range" id="zoomSlider" min="0.5" max="3.0" step="0.1" value="1.0" class="w-full" oninput="onSliderChange(this.value)">
                </div>
            </div>

            <!-- 삭제 버튼 (편집 모드에서만 보임) -->
            <button onclick="deleteCurrentCard()" class="w-full py-3 bg-red-900/50 text-red-400 border border-red-800 rounded-lg hover:bg-red-900 transition-colors flex items-center justify-center gap-2">
                <i class="fa-solid fa-trash-can"></i> 이 카드 영구 삭제
            </button>
        </div>
    </main>

    <!-- 하단 액션바 (SRS) - 편집모드일때는 숨김 -->
    <div id="srsBar" class="p-2 bg-cardbg flex justify-around border-t border-gray-800 z-20 shrink-0 transition-opacity duration-200">
        <button onclick="deferCardWithConfirm(3)" class="flex flex-col items-center text-xs text-blue-400 p-2 rounded w-1/4">
            <i class="fa-solid fa-clock mb-1 text-lg"></i> 3일
        </button>
        <button onclick="deferCardWithConfirm(7)" class="flex flex-col items-center text-xs text-green-400 p-2 rounded w-1/4">
            <i class="fa-solid fa-calendar-week mb-1 text-lg"></i> 7일
        </button>
        <button onclick="deferCardWithConfirm(12)" class="flex flex-col items-center text-xs text-yellow-400 p-2 rounded w-1/4">
            <i class="fa-solid fa-calendar-days mb-1 text-lg"></i> 12일
        </button>
        <button onclick="deferCardWithConfirm(30)" class="flex flex-col items-center text-xs text-red-400 p-2 rounded w-1/4">
            <i class="fa-solid fa-calendar mb-1 text-lg"></i> 30일
        </button>
    </div>

    <!-- 네비게이션 (높이 확보) -->
    <nav class="bg-black flex justify-between items-center z-30 shrink-0 safe-area-pb h-20 px-4 relative">
        <button onclick="prevCard()" class="text-gray-400 active:text-white w-20 h-full flex items-center justify-start"><i class="fa-solid fa-chevron-left text-3xl"></i></button>
        
        <!-- 추가 버튼 -->
        <div class="absolute left-1/2 -top-6 transform -translate-x-1/2">
            <button onclick="openAddModal()" class="bg-accent text-black rounded-full w-16 h-16 flex items-center justify-center shadow-lg border-4 border-darkbg active:scale-95 transition-transform">
                <i class="fa-solid fa-plus text-3xl"></i>
            </button>
        </div>

        <button onclick="nextCard()" class="text-gray-400 active:text-white w-20 h-full flex items-center justify-end"><i class="fa-solid fa-chevron-right text-3xl"></i></button>
        
        <button onclick="openStatsModal()" class="absolute right-4 bottom-20 text-gray-500 bg-black/50 p-2 rounded-full"><i class="fa-solid fa-chart-simple"></i></button>
    </nav>

    <!-- 모달들 (동일) -->
    <div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4">
        <div class="bg-cardbg rounded-xl p-6 w-full max-w-md border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-accent">카드 추가</h2>
            <div id="pasteArea" contenteditable="true" class="w-full h-40 bg-gray-800 rounded border border-gray-600 p-4 focus:border-accent outline-none flex items-center justify-center text-gray-400 mb-4 transition-colors">
                터치 후 붙여넣기...
            </div>
            <div id="previewArea" class="hidden mb-4 p-2 bg-black rounded text-center border border-gray-700 relative">
                <button onclick="resetPastePreview()" class="absolute top-2 right-2 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                <img id="imgPreview" class="max-h-40 mx-auto hidden object-contain">
                <p id="textPreview" class="text-white text-lg hidden text-center p-4"></p>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeAddModal()" class="px-5 py-2 bg-gray-700 rounded text-sm">취소</button>
                <button onclick="saveContent()" id="saveBtn" class="px-5 py-2 bg-accent text-black rounded text-sm font-bold disabled:opacity-50" disabled>저장</button>
            </div>
        </div>
    </div>

    <div id="statsModal" class="hidden fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4">
        <div class="bg-cardbg rounded-xl w-full h-3/4 max-w-lg p-4 flex flex-col relative">
            <button onclick="closeStatsModal()" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-xmark fa-xl"></i></button>
            <h2 class="text-xl font-bold mb-6 text-center">월간 학습량</h2>
            <div class="flex-grow relative">
                <canvas id="statsChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let cards = [];
        let currentIndex = 0;
        let viewMode = 'all'; 
        let sortMode = 'random';
        let isEditMode = false;
        
        let pendingImage = null;
        let pendingText = '';

        window.onload = function() {
            fetchCards();
            setupPasteHandler();
            setupTouchSwipe();
        };

        // --- Core ---
        async function fetchCards() {
            try {
                const res = await fetch(`/api/cards?mode=${viewMode}&sort=${sortMode}`);
                cards = await res.json();
                if (currentIndex >= cards.length) currentIndex = 0;
                renderCard();
                updateCounter();
            } catch (e) { console.error(e); }
        }

        function renderCard() {
            const zoomTarget = document.getElementById('zoomTarget');
            const loading = document.getElementById('loading');
            const emptyMsg = document.getElementById('emptyMsg');
            const hiddenStatus = document.getElementById('hiddenStatus');
            const slider = document.getElementById('zoomSlider');

            if (isEditMode) toggleEditMode(false); // 카드 바뀌면 편집모드 끔

            loading.classList.add('hidden');
            
            if (cards.length === 0) {
                zoomTarget.classList.add('hidden');
                emptyMsg.classList.remove('hidden');
                hiddenStatus.classList.add('hidden');
                return;
            }

            emptyMsg.classList.add('hidden');
            zoomTarget.classList.remove('hidden');

            const card = cards[currentIndex];
            
            zoomTarget.innerHTML = '';
            if (card.type === 'image') {
                const img = document.createElement('img');
                img.src = `/uploads/${card.content}`;
                img.className = 'content-image';
                zoomTarget.appendChild(img);
            } else {
                const p = document.createElement('div');
                p.innerText = card.content;
                p.className = 'content-text';
                zoomTarget.appendChild(p);
            }

            const savedScale = card.scale || 1.0;
            zoomTarget.style.transform = `scale(${savedScale})`;
            slider.value = savedScale;
            document.getElementById('scaleValue').innerText = Math.round(savedScale*100) + '%';
            
            const today = new Date().toISOString().split('T')[0];
            if (card.next_review && card.next_review > today) {
                hiddenStatus.classList.remove('hidden');
            } else {
                hiddenStatus.classList.add('hidden');
            }

            fetch(`/api/cards/${card.id}/view`, { method: 'POST' });
        }

        // --- Edit Mode & Delete ---
        function toggleEditMode(forceState) {
            const btn = document.getElementById('editBtn');
            const controls = document.getElementById('editControls');
            const srsBar = document.getElementById('srsBar');
            
            if (typeof forceState !== 'undefined') isEditMode = forceState;
            else isEditMode = !isEditMode;

            if (isEditMode) {
                btn.classList.add('bg-accent', 'text-black', 'font-bold');
                btn.classList.remove('bg-gray-700', 'text-gray-300');
                controls.classList.remove('hidden', 'translate-y-full');
                srsBar.classList.add('opacity-0', 'pointer-events-none'); // SRS바 숨김
            } else {
                btn.classList.remove('bg-accent', 'text-black', 'font-bold');
                btn.classList.add('bg-gray-700', 'text-gray-300');
                controls.classList.add('hidden', 'translate-y-full');
                srsBar.classList.remove('opacity-0', 'pointer-events-none'); // SRS바 복구
                saveCurrentScale();
            }
        }

        // [삭제 기능]
        async function deleteCurrentCard() {
            if (cards.length === 0) return;
            // 실수 방지 1회 확인
            if (!confirm("정말 이 단어카드를 삭제하시겠습니까?\\n(복구할 수 없습니다)")) return;
            
            const card = cards[currentIndex];
            try {
                const res = await fetch(`/api/cards/${card.id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    toggleEditMode(false); // 편집모드 끄기
                    await fetchCards(); // 목록 새로고침
                } else {
                    alert("삭제 실패");
                }
            } catch(e) { console.error(e); alert("오류 발생"); }
        }

        function onSliderChange(val) {
            const zoomTarget = document.getElementById('zoomTarget');
            zoomTarget.style.transform = `scale(${val})`;
            document.getElementById('scaleValue').innerText = Math.round(val * 100) + '%';
        }

        async function saveCurrentScale() {
            if (cards.length === 0) return;
            const card = cards[currentIndex];
            const slider = document.getElementById('zoomSlider');
            const newScale = parseFloat(slider.value);
            card.scale = newScale;
            await fetch(`/api/cards/${card.id}/scale`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scale: newScale })
            });
        }

        // --- SRS & Navigation ---
        function deferCardWithConfirm(days) {
            if (cards.length === 0) return;
            if (confirm(`${days}일 동안 숨기시겠습니까?`)) {
                deferCard(days);
            }
        }

        async function deferCard(days) {
            const card = cards[currentIndex];
            await fetch(`/api/cards/${card.id}/hide`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days: days })
            });
            if (viewMode === 'study') {
                cards.splice(currentIndex, 1);
                if (currentIndex >= cards.length) currentIndex = 0;
                renderCard();
                updateCounter();
            } else {
                card.next_review = getFutureDate(days);
                nextCard();
            }
        }

        async function resetSchedule() {
            if (confirm("다시 학습 대기열로 복귀시키시겠습니까?")) {
                const card = cards[currentIndex];
                await fetch(`/api/cards/${card.id}/hide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: 0 })
                });
                card.next_review = null;
                renderCard();
            }
        }

        function getFutureDate(days) {
            const d = new Date(); d.setDate(d.getDate() + days);
            return d.toISOString().split('T')[0];
        }

        function nextCard() {
            if (cards.length === 0) return;
            currentIndex = (currentIndex + 1) % cards.length;
            renderCard();
            updateCounter();
        }

        function prevCard() {
            if (cards.length === 0) return;
            currentIndex = (currentIndex - 1 + cards.length) % cards.length;
            renderCard();
            updateCounter();
        }

        function updateCounter() {
            document.getElementById('cardCounter').innerText = cards.length > 0 ? `${currentIndex + 1}/${cards.length}` : '0/0';
        }

        // --- FullScreen ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => {
                    console.log(e);
                });
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // --- Utils ---
        function toggleMode() {
            viewMode = viewMode === 'all' ? 'study' : 'all';
            const btn = document.getElementById('modeBtn');
            btn.innerText = viewMode === 'all' ? '전체' : '암기';
            btn.className = viewMode === 'all' ? 'text-sm px-3 py-1 rounded bg-gray-700 w-16' : 'text-sm px-3 py-1 rounded bg-accent text-black font-bold w-16';
            fetchCards();
        }
        function toggleSort() { /* 생략 - 랜덤기본 */ fetchCards(); } // 소스엔 없지만 기능 유지

        function setupTouchSwipe() {
            let startX = 0;
            const area = document.getElementById('mainArea'); // 범위 확대
            area.addEventListener('touchstart', e => startX = e.changedTouches[0].screenX);
            area.addEventListener('touchend', e => {
                const endX = e.changedTouches[0].screenX;
                if (!isEditMode) {
                    if (endX < startX - 50) nextCard();
                    if (endX > startX + 50) prevCard();
                }
            });
        }

        function openAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
            const pasteArea = document.getElementById('pasteArea');
            pasteArea.innerText = "터치 후 붙여넣기...";
            pasteArea.focus();
            resetPastePreview();
        }
        function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }
        
        function setupPasteHandler() {
            const area = document.getElementById('pasteArea');
            area.addEventListener('paste', e => {
                e.preventDefault();
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                let hasImg = false;
                for (let i=0; i<items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const blob = items[i].getAsFile();
                        const reader = new FileReader();
                        reader.onload = ev => showPreview(ev.target.result, 'image');
                        reader.readAsDataURL(blob);
                        pendingImage = blob; hasImg = true; break;
                    }
                }
                if (!hasImg) {
                    const txt = e.clipboardData.getData('text');
                    if (txt) { showPreview(txt, 'text'); pendingText = txt; }
                }
            });
        }
        function showPreview(content, type) {
            document.getElementById('pasteArea').classList.add('hidden');
            document.getElementById('previewArea').classList.remove('hidden');
            document.getElementById('saveBtn').disabled = false;
            if (type === 'image') {
                document.getElementById('imgPreview').src = content;
                document.getElementById('imgPreview').classList.remove('hidden');
                document.getElementById('textPreview').classList.add('hidden');
            } else {
                document.getElementById('textPreview').innerText = content;
                document.getElementById('textPreview').classList.remove('hidden');
                document.getElementById('imgPreview').classList.add('hidden');
            }
        }
        function resetPastePreview() {
            document.getElementById('pasteArea').classList.remove('hidden');
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('saveBtn').disabled = true;
            pendingImage = null; pendingText = '';
        }
        async function saveContent() {
            const fd = new FormData();
            if (pendingImage) fd.append('image', pendingImage, 'paste.png');
            else if (pendingText) fd.append('text', pendingText);
            else return;
            await fetch('/api/cards', { method: 'POST', body: fd });
            closeAddModal(); fetchCards();
        }
        async function openStatsModal() {
            document.getElementById('statsModal').classList.remove('hidden');
            const res = await fetch('/api/stats');
            renderChart(await res.json());
        }
        function closeStatsModal() { document.getElementById('statsModal').classList.add('hidden'); }
        let myChart = null;
        function renderChart(data) {
            const ctx = document.getElementById('statsChart').getContext('2d');
            data.sort((a,b) => new Date(a.date) - new Date(b.date));
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: data.map(d=>d.date.substring(5)), datasets: [{ label: 'View Count', data: data.map(d=>d.count), backgroundColor: '#00d084' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: {color:'#333'} }, x: {grid:{color:'#333'}} } }
            });
        }
    </script>
</body>
</html>
"""

def create_project():
    if not os.path.exists(PROJECT_NAME):
        os.makedirs(PROJECT_NAME)
    
    upload_path = os.path.join(PROJECT_NAME, UPLOAD_FOLDER)
    if not os.path.exists(upload_path):
        os.makedirs(upload_path)
    
    templates_path = os.path.join(PROJECT_NAME, 'templates')
    if not os.path.exists(templates_path):
        os.makedirs(templates_path)

    with open(os.path.join(PROJECT_NAME, 'app.py'), 'w', encoding='utf-8') as f:
        f.write(APP_PY_CONTENT)

    with open(os.path.join(templates_path, 'index.html'), 'w', encoding='utf-8') as f:
        f.write(INDEX_HTML_CONTENT)

    print("="*40)
    print(f" [천재 경원님의 단어장 업데이트 완료]")
    print(f" 포트 변경됨: 9500")
    print("="*40)
    print(f"1. 폴더 이동: cd {PROJECT_NAME}")
    print("2. 실행: python app.py")
    print("3. 접속: http://[IP주소]:9500")

if __name__ == '__main__':
    create_project()