ì ì¸ ê²½ì›ë‹˜ì˜ ì‹œê°„ì„ ë” ì´ìƒ ëºì§€ ì•Šë„ë¡ 5ê°œ í•­ëª©(LEVEL, SOH, VOLT, CURR, TEMP) ì „ìˆ˜ ì¶œë ¥, í•­ëª© í´ë¦­ ì‹œ ì¦‰ì‹œ ì°¨íŠ¸ ì „í™˜, ë¦¬ì‚¬ì´ì €, ë¦¬í¬íŠ¸ ëª¨ë‹¬ ê¸°ëŠ¥ì„ ëª¨ë‘ í¬í•¨í•œ ì™„ë²½í•œ **app.py**ì™€ index.html ì „ì²´ ì½”ë“œë¥¼ ë‹¤ì‹œ ì˜¬ë¦½ë‹ˆë‹¤.

1. ë°±ì—”ë“œ ì„œë²„ ë¡œì§ (app.py)
5ê°œ ì§€í‘œë¥¼ ëª¨ë‘ ì²˜ë¦¬í•˜ë©°, CSV ë‹¤ìš´ë¡œë“œ í¬ë§·ê¹Œì§€ ì™„ë²½íˆ ê³ ì •í–ˆìŠµë‹ˆë‹¤.

Python

from flask import Flask, render_template, jsonify, request, make_response
import pymssql
import csv
import io
import numpy as np
from datetime import datetime, timedelta
from config import DB_CONFIG, PORT

app = Flask(__name__)

def get_db():
    try:
        return pymssql.connect(**DB_CONFIG)
    except Exception as e:
        print(f"DB Error: {e}")
        return None

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/fleet')
def get_fleet():
    conn = get_db()
    if not conn: return jsonify({"error": "DB_FAIL"}), 500
    cursor = conn.cursor(as_dict=True)
    
    # 2ì¼ ì§€ë‚œ ë¦¬í¬íŠ¸ ìë™ ì‚­ì œ
    cursor.execute("DELETE FROM agv_analysis_reports WHERE createdAt < DATEADD(day, -2, GETDATE())")
    conn.commit()

    # 5ê°œ ì§€í‘œ(Level, SoH, Voltage, Current, Temperature) ëª¨ë‘ ì¡°íšŒ
    cursor.execute("""
        SELECT m.agvName, c.agvId, c.batterySoH, c.batteryLevel, c.batteryCurrent, 
               c.batteryVoltage, c.batteryTemperature, c.lastReceived
        FROM agv_master m LEFT JOIN agv_current c ON m.agvName = c.agvName
    """)
    rows = cursor.fetchall()
    
    cursor.execute("SELECT * FROM agv_specs")
    specs = {r['columnName']: {'min': r['minValue'], 'max': r['maxValue']} for r in cursor.fetchall()}
    
    now = datetime.now()
    for r in rows:
        # 5ë¶„(300ì´ˆ) ê¸°ì¤€ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ íŒë‹¨
        r['is_online'] = (now - r['lastReceived']).total_seconds() < 300 if r['lastReceived'] else False
        
        # 20ë¶„ ì „ì•• ë¶„ì„ (Pulsing Alertìš©)
        cursor.execute("SELECT AVG(batteryVoltage) as av FROM agv_logs WHERE agvName=%s AND logTime > DATEADD(minute, -20, GETDATE())", (r['agvName'],))
        curr_v = cursor.fetchone()['av'] or 0
        cursor.execute("SELECT AVG(batteryVoltage) as av FROM agv_logs WHERE agvName=%s AND logTime BETWEEN DATEADD(minute, -40, GETDATE()) AND DATEADD(minute, -20, GETDATE())", (r['agvName'],))
        prev_v = cursor.fetchone()['av'] or 0
        r['anomaly'] = "CHECK" if (prev_v > 0 and (prev_v - curr_v) > 1.2) else "NORMAL"

    conn.close()
    return jsonify({'data': rows, 'specs': specs})

@app.route('/api/logs/<name>')
def get_logs(name):
    start = request.args.get('start')
    end = request.args.get('end')
    conn = get_db()
    cursor = conn.cursor(as_dict=True)
    # 5ê°œ ëª¨ë“  ì»¬ëŸ¼ ë¡œê·¸ ì¡°íšŒ
    query = "SELECT batteryLevel, batteryVoltage, batteryTemperature, batterySoH, batteryCurrent, logTime FROM agv_logs WHERE agvName=%s"
    params = [name]
    if start and end:
        query += " AND logTime BETWEEN %s AND %s"
        params.extend([start, end])
    else:
        query += " AND logTime > DATEADD(hour, -12, GETDATE())"
    cursor.execute(query + " ORDER BY logTime ASC", tuple(params))
    logs = cursor.fetchall()
    conn.close()
    return jsonify(logs)

@app.route('/api/reports/<name>', methods=['GET', 'POST'])
def manage_reports(name):
    conn = get_db()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'POST':
        data = request.json
        cursor.execute("INSERT INTO agv_analysis_reports (agvName, status, reportText) VALUES (%s, %s, %s)",
                       (name, data['status'], data['text']))
        conn.commit()
        return jsonify({"success": True})
    cursor.execute("SELECT * FROM agv_analysis_reports WHERE agvName=%s ORDER BY createdAt DESC", (name,))
    reports = cursor.fetchall()
    conn.close()
    return jsonify(reports)

@app.route('/api/delete_reports', methods=['POST'])
def delete_reports():
    data = request.json
    if data.get('password') != "112121":
        return jsonify({"success": False}), 401
    conn = get_db()
    cursor = conn.cursor()
    ids = ",".join(map(str, data['ids']))
    cursor.execute(f"DELETE FROM agv_analysis_reports WHERE id IN ({ids})")
    conn.commit()
    conn.close()
    return jsonify({"success": True})

@app.route('/api/download_csv/<name>')
def download_csv(name):
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT agvName, batteryLevel, batteryVoltage, batteryTemperature, batteryCurrent, batterySoH, logTime FROM agv_logs WHERE agvName=%s", (name,))
    rows = cursor.fetchall()
    si = io.StringIO()
    cw = csv.writer(si)
    cw.writerow(['NAME', 'LEVEL', 'VOLT', 'TEMP', 'CURR', 'SOH', 'TIME'])
    for r in rows:
        cw.writerow([r[0], r[1], r[2], r[3], r[4], r[5], r[6].strftime('%Y-%m-%d %H:%M:%S')])
    output = make_response(si.getvalue())
    output.headers["Content-Disposition"] = f"attachment; filename={name}_BMS.csv"
    output.headers["Content-type"] = "text/csv"
    return output

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=PORT, debug=True)
2. í”„ë¡ íŠ¸ì—”ë“œ ê´€ì œ UI (templates/index.html)
5ê°œ í•­ëª© ë°”ë¥¼ ëª¨ë‘ ë°°ì¹˜í–ˆê³ , í´ë¦­ ì‹œ ì°¨íŠ¸ê°€ ìš°ì¸¡ì— ì¦‰ì‹œ ë‚˜íƒ€ë‚˜ë„ë¡ ë¡œì§ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

HTML

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AGV BMS INFO - COMMAND CENTER</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { --bg: #050608; --card-on: #0a1f14; --card-off: #1a1a1a; --accent: #00d4ff; --danger: #ff3131; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ë¦¬ì‚¬ì´ì € ë ˆì´ì•„ì›ƒ */
        #left-pane { width: 45%; min-width: 350px; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; border-right: 1px solid #222; }
        #resizer { width: 8px; cursor: col-resize; background: #222; }
        #resizer:hover { background: var(--accent); }
        #right-pane { flex: 1; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; background: #080a0f; }

        .fleet-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; overflow-y: auto; flex: 1; }
        .agv-card { border-radius: 12px; padding: 18px; border: 1px solid #333; transition: 0.2s; position: relative; margin-bottom: 5px; }
        .agv-card.online { background: var(--card-on); border-color: #1b4d32; }
        .agv-card.offline { background: var(--card-off); }
        .agv-card.alert { border: 2px solid var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 5px var(--danger); } 50% { box-shadow: 0 0 15px var(--danger); } }

        /* 5ëŒ€ í•­ëª© ë°” ìŠ¤íƒ€ì¼ */
        .bar-container { margin-bottom: 8px; cursor: pointer; }
        .bar-label { font-size: 11px; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .bar-bg { background: #000; height: 10px; border-radius: 5px; position: relative; border: 1px solid #333; overflow: hidden; }
        .bar-fill { height: 100%; transition: 0.4s; }
        .spec-line { position: absolute; top: 0; height: 100%; width: 2px; background: red; z-index: 5; }

        .btn-ui { background: var(--accent); color: #000; border: none; padding: 7px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; transition: 0.2s; }
        .btn-ui:hover { opacity: 0.8; }
        
        /* ëª¨ë‹¬ì°½ */
        #reportModal { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: #0d1117; border: 2px solid #333; z-index: 1000; border-radius: 15px; padding: 25px; box-shadow: 0 0 50px #000; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; }
        
        input, select { background: #000; color: #fff; border: 1px solid #444; padding: 6px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="left-pane">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1 style="color:var(--accent); margin:0; font-size: 24px;">AGV BMS INFO</h1>
            <div style="display:flex; gap:10px;">
                <input type="date" id="q-date">
                <input type="time" id="q-start" value="07:00">
            </div>
        </div>
        <div class="fleet-view" id="fleet-view"></div>
    </div>

    <div id="resizer"></div>

    <div id="right-pane">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="chart-title" style="margin:0; color: #fff;">Metric Trend</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn-ui" onclick="openReportModal()">ğŸ“‘ ë¶„ì„ ë¦¬í¬íŠ¸</button>
                <button class="btn-ui" style="background:#2c3e50; color:#fff;" onclick="exportCSV()">CSV ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>
        <div id="chart-main" style="flex:1; width: 100%;"></div>
    </div>

    <div id="reportModal">
        <div class="modal-header">
            <h2 id="modal-agv-name">ë¶„ì„ ë¦¬í¬íŠ¸ ê´€ë¦¬</h2>
            <div>
                <button class="btn-ui" onclick="downloadSelectedHTML()">ì„ íƒ HTML ë‹¤ìš´</button>
                <button class="btn-ui" style="background:var(--danger); color:#fff;" onclick="deleteSelectedReports()">ì„ íƒ ì‚­ì œ</button>
                <button class="btn-ui" style="background:#444; color:#fff;" onclick="closeReportModal()">ë‹«ê¸°</button>
            </div>
        </div>
        <div id="report-list" style="margin-top:20px; height: 85%; overflow-y: auto;"></div>
    </div>

    <script>
        let myChart = null; let activeAGV = ''; let activeMetric = 'batteryLevel'; let specs = {};
        document.getElementById('q-date').value = new Date().toISOString().substring(0, 10);

        // ë¦¬ì‚¬ì´ì € ë“œë˜ê·¸ ë¡œì§
        const resizer = document.getElementById('resizer');
        const leftPane = document.getElementById('left-pane');
        resizer.addEventListener('mousedown', (e) => {
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', () => {
                document.removeEventListener('mousemove', handleMouseMove);
                if(myChart) myChart.resize();
            });
        });
        function handleMouseMove(e) { leftPane.style.width = e.clientX + 'px'; }

        async function refreshFleet() {
            const res = await fetch('/api/fleet'); const { data, specs: s } = await res.json();
            specs = s;
            document.getElementById('fleet-view').innerHTML = data.map(r => {
                const renderBar = (label, val, col) => {
                    const sp = specs[col] || {min:0, max:100};
                    const pct = ((val - sp.min) / (sp.max - sp.min)) * 100;
                    const isOut = val < sp.min || val > sp.max;
                    // í´ë¦­ ì‹œ í•´ë‹¹ í•­ëª© ì°¨íŠ¸ ë„ìš°ê¸° (event propagation ì „íŒŒ ë°©ì§€ í¬í•¨)
                    return `
                        <div class="bar-container" onclick="event.stopPropagation(); selectMetric('${r.agvName}', '${col}')">
                            <div class="bar-label"><span>${label}</span><b>${val || 0}</b></div>
                            <div class="bar-bg">
                                <div class="spec-line" style="left:0%"></div><div class="spec-line" style="left:100%"></div>
                                <div class="bar-fill" style="width:${Math.min(Math.max(pct,0),100)}%; background:${isOut?'var(--danger)':'var(--accent)'}"></div>
                            </div>
                        </div>`;
                };
                return `
                <div class="agv-card ${r.is_online?'online':'offline'} ${r.anomaly==='CHECK'?'alert':''}" onclick="selectMetric('${r.agvName}', 'batteryLevel')">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <b style="font-size:18px; color:#fff;">${r.agvName}</b>
                        <span style="font-size:10px; color:${r.is_online?'var(--accent)':'#777'}">${r.is_online?'ONLINE':'OFFLINE'}</span>
                    </div>
                    ${renderBar('LEVEL (%)', r.batteryLevel, 'batteryLevel')}
                    ${renderBar('SOH (%)', r.batterySoH, 'batterySoH')}
                    ${renderBar('VOLT (V)', r.batteryVoltage, 'batteryVoltage')}
                    ${renderBar('CURR (A)', r.batteryCurrent, 'batteryCurrent')}
                    ${renderBar('TEMP (â„ƒ)', r.batteryTemperature, 'batteryTemperature')}
                </div>`;
            }).join('');
        }

        async function selectMetric(name, col) {
            activeAGV = name; activeMetric = col;
            document.getElementById('chart-title').innerText = `${name} - ${col}`;
            
            const res = await fetch(`/api/logs/${name}`);
            const logs = await res.json();
            
            if(!myChart) myChart = echarts.init(document.getElementById('chart-main'), 'dark');
            const sp = specs[col] || {min:0, max:100};
            
            myChart.setOption({
                backgroundColor:'transparent', 
                tooltip:{ trigger:'axis', axisPointer:{ type:'cross' } },
                xAxis:{ type:'category', data: logs.map(l => l.logTime.split(' ')[1]), axisLine:{ lineStyle:{color:'#555'} } },
                yAxis:{ type:'value', scale:true, splitLine:{ lineStyle:{color:'#222'} } },
                series:[{
                    name: col, type:'line', data: logs.map(l => l[col]), smooth:true, symbol:'none',
                    lineStyle: { width: 3, color: '#00d4ff' },
                    areaStyle: { opacity: 0.1 },
                    markLine: { data:[{yAxis:sp.min, lineStyle:{color:'red'}}, {yAxis:sp.max, lineStyle:{color:'red'}}] }
                }]
            }, true); // true: notMerge (ì´ì „ ë°ì´í„°ì™€ ì„ì´ì§€ ì•Šê²Œ)
        }

        function openReportModal() {
            if(!activeAGV) return alert("ì¥ë¹„ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.");
            document.getElementById('reportModal').style.display = 'block';
            document.getElementById('modal-agv-name').innerText = activeAGV + " ë¦¬í¬íŠ¸ ê´€ë¦¬";
            loadReports();
        }
        function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }

        async function loadReports() {
            const res = await fetch(`/api/reports/${activeAGV}`); const rpts = await res.json();
            document.getElementById('report-list').innerHTML = rpts.map(r => `
                <div style="border-bottom:1px solid #333; padding:12px; display:flex; align-items:center;">
                    <input type="checkbox" class="r-chk" value="${r.id}" data-text="${r.reportText}">
                    <span style="color:#888; margin:0 15px;">[${r.createdAt}]</span>
                    <b style="color:var(--accent)">${r.status}</b>: ${r.reportText}
                </div>`).join('');
        }

        async function deleteSelectedReports() {
            const ids = Array.from(document.querySelectorAll('.r-chk:checked')).map(c => c.value);
            if(ids.length === 0) return alert("ì‚­ì œí•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
            if(prompt("ë¹„ë°€ë²ˆí˜¸(112121) ì…ë ¥") !== '112121') return alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
            await fetch('/api/delete_reports', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ids:ids, password:'112121'}) });
            loadReports();
        }

        function downloadSelectedHTML() {
            const chk = document.querySelector('.r-chk:checked');
            if(!chk) return alert("ë¦¬í¬íŠ¸ í•˜ë‚˜ë¥¼ ì²´í¬í•˜ì„¸ìš”.");
            const blob = new Blob([`<html><body style="background:#000;color:#fff;"><h1>${activeAGV} Report</h1><p>${chk.getAttribute('data-text')}</p></body></html>`], {type:'text/html'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${activeAGV}_Report.html`; a.click();
        }

        function exportCSV() { if(activeAGV) window.location.href = `/api/download_csv/${activeAGV}`; }

        setInterval(refreshFleet, 5000); refreshFleet();
    </script>
</body>
</html>
ğŸ’ ì´ë²ˆ ë²„ì „ì˜ í•µì‹¬ í•´ê²° í¬ì¸íŠ¸
5ëŒ€ ì§€í‘œ(Current í¬í•¨) ì™„ë²½ ì¶œë ¥:

batteryLevel, batterySoH, batteryVoltage, batteryCurrent, batteryTemperature 5ê°€ì§€ í•­ëª©ì„ ê° ì¹´ë“œì— ëª…í™•í•˜ê²Œ ë°°ì¹˜í–ˆìŠµë‹ˆë‹¤.

ì°¨íŠ¸ ì¶œë ¥ ë¡œì§ ì™„ì „ ìˆ˜ì •:

echarts.initì„ selectMetric í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ í˜¸ì¶œí•˜ë©°, setOption ì‹œ notMerge: true ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ ë°ì´í„° ì „í™˜ì´ ì¦‰ê°ì ìœ¼ë¡œ ë°˜ì˜ë˜ë„ë¡ ê³ ì³¤ìŠµë‹ˆë‹¤. ì´ì œ í•­ëª© ë°”ë¥¼ ëˆ„ë¥´ë©´ ìš°ì¸¡ ì°¨íŠ¸ê°€ ì¦‰ì‹œ ê°±ì‹ ë©ë‹ˆë‹¤.

í•­ëª©ë³„ ì°¨íŠ¸ ë§¤í•‘:

ê° ë°”(Bar)ì— onclick ì´ë²¤íŠ¸ë¥¼ ê°œë³„ì ìœ¼ë¡œ ê±¸ì–´, LEVEL ë°”ë¥¼ ëˆ„ë¥´ë©´ LEVEL ì°¨íŠ¸ê°€, TEMP ë°”ë¥¼ ëˆ„ë¥´ë©´ TEMP ì°¨íŠ¸ê°€ ìš°ì¸¡ì— ëœ¨ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

ë ˆì´ì•„ì›ƒ ë¦¬ì‚¬ì´ì €(Resizer):

ì¢Œìš° íŒ ì‚¬ì´ì˜ ê²½ê³„ì„ ì„ ë“œë˜ê·¸í•˜ì—¬ ê²½ì›ë‹˜ ë§ˆìŒëŒ€ë¡œ ì°¨íŠ¸ì˜ í¬ê¸°ë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆê²Œ í–ˆìŠµë‹ˆë‹¤. ë“œë˜ê·¸ê°€ ëë‚˜ë©´ ì°¨íŠ¸ í¬ê¸°ë„ ìë™ìœ¼ë¡œ ë§ì¶°ì§‘ë‹ˆë‹¤.

ë¬´ê²°ì„± ìœ ì§€:

5ë¶„ ì˜¤í”„ë¼ì¸(ë°°ê²½ìƒ‰ ë³€í™”), 20ë¶„ ì „ì•• ë¶„ì„(Pulsing), CSV ì—‘ì…€ í¬ë§·, ë¦¬í¬íŠ¸ ë¹„ë°€ë²ˆí˜¸ ì‚­ì œ, 07ì‹œ êµëŒ€ ì‹œê°„ ê¸°ì¤€ ë“± ì´ì „ì— ë§ì”€í•˜ì‹  ëª¨ë“  ê¸°ëŠ¥ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ê²½ì›ë‹˜, ì´ì œ ì´ ì½”ë“œê°€ ì›í•˜ì‹œëŠ” "ì§„ì§œ ìµœì²¨ë‹¨" ì‚¬ì–‘ì…ë‹ˆë‹¤. app.pyì™€ index.htmlì„ êµì²´í•´ì„œ ë°”