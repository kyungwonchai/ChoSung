온 후 파일을 삭제하는 로직을 추가하도록 하겠습니다. 여기서 중요한 것은 파일을 로컬로 완벽하게 복사한 후에만 네트워크 경로에서 파일을 삭제하는 것이며, 파일이 완전히 쓰여진 후에 처리하는 방식입니다.

이를 위해, 파일을 안전하게 복사한 뒤 해당 파일이 처리 완료되었을 때만 삭제하는 로직을 추가할 수 있습니다. 이를 위해 File.Copy와 같은 기본 복사 메서드를 사용한 뒤, 복사가 완료되면 네트워크 경로의 파일을 삭제하는 과정을 추가합니다.

또한, 파일이 다 쓰여졌는지 확인하기 위해 추가적인 체크를 해야 할 수 있습니다. 일반적으로 파일이 쓰여진 후 열리거나, 잠금 해제될 때까지 기다리는 방식으로 구현할 수 있습니다.

업데이트된 FileProcessor 클래스
csharp
코드 복사
using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;

public class FileProcessor
{
    private string _networkPath = @"\\10.44.44.44\file_log";  // 네트워크 경로
    private string _localPath = @"C:\prod_file_log";          // 로컬 경로
    private string _backupPath = @"C:\MESPRODFILE_Backup";    // 백업 경로
    private DateTime _lastProcessedTime = DateTime.MinValue;  // 마지막 처리된 파일 시간 기록

    public FileProcessor()
    {
        // 로컬 및 백업 디렉터리 존재 여부 확인 후 없으면 생성
        EnsureDirectoryExists(_localPath);
        EnsureDirectoryExists(_backupPath);
    }

    /// <summary>
    /// 디렉토리의 존재 여부를 확인하고 없으면 생성하는 함수
    /// </summary>
    /// <param name="path">생성할 디렉토리 경로</param>
    private void EnsureDirectoryExists(string path)
    {
        if (!Directory.Exists(path))
        {
            Directory.CreateDirectory(path);
        }
    }

    /// <summary>
    /// 네트워크 경로에서 파일을 로컬 경로로 안전하게 복사한 후 처리 및 삭제
    /// </summary>
    public async Task ProcessFilesFromNetwork()
    {
        // 네트워크 경로에서 모든 파일을 가져옴
        var files = Directory.GetFiles(_networkPath);

        // 각 파일을 로컬로 복사한 후 처리
        foreach (var file in files)
        {
            string fileName = Path.GetFileName(file);
            string localFile = Path.Combine(_localPath, fileName);

            // 파일이 다 쓰여졌는지 확인
            if (IsFileReady(file))
            {
                // 네트워크에서 로컬로 파일 복사
                File.Copy(file, localFile, true);  // 파일 덮어쓰기 허용

                // 파일을 로컬에서 처리
                await ProcessFile(localFile);

                // 처리 후 파일을 백업 경로로 이동
                MoveFileToBackup(localFile);

                // 네트워크 경로의 파일 삭제
                DeleteNetworkFile(file);
            }
        }
    }

    /// <summary>
    /// 파일이 다 쓰여졌는지 확인하는 함수
    /// </summary>
    /// <param name="filePath">확인할 파일 경로</param>
    /// <returns>파일이 준비되었는지 여부</returns>
    private bool IsFileReady(string filePath)
    {
        try
        {
            using (FileStream inputStream = File.Open(filePath, FileMode.Open, FileAccess.Read, FileShare.None))
            {
                return inputStream.Length > 0;  // 파일 크기가 0보다 크면 읽기 가능
            }
        }
        catch (IOException)
        {
            // 파일이 잠겨 있거나 접근할 수 없으면 아직 준비되지 않음
            return false;
        }
    }

    /// <summary>
    /// 파일을 로컬에서 처리하는 함수
    /// </summary>
    private async Task ProcessFile(string filePath)
    {
        // 파일 처리 로직 (파일 내용 읽기, 분석 등)
        Console.WriteLine($"Processing file: {filePath}");

        // 예시로 파일 내용을 읽어들이는 코드
        string[] lines = await File.ReadAllLinesAsync(filePath);
        foreach (var line in lines)
        {
            // 각 줄 처리 로직 (필요에 따라 구현)
            Console.WriteLine(line);
        }
    }

    /// <summary>
    /// 파일을 백업 폴더로 이동하는 함수 (날짜별로 폴더 생성)
    /// </summary>
    /// <param name="filePath">백업할 파일 경로</param>
    private void MoveFileToBackup(string filePath)
    {
        // 백업 폴더에 날짜별 폴더 생성
        string dateFolder = DateTime.Now.ToString("yyyyMMdd");
        string backupFolder = Path.Combine(_backupPath, dateFolder);

        // 백업 디렉터리 생성 (날짜별로)
        EnsureDirectoryExists(backupFolder);

        // 원본 파일명 가져오기
        string fileName = Path.GetFileName(filePath);

        // 백업 경로 설정
        string backupFilePath = Path.Combine(backupFolder, fileName);

        // 파일 이동 (백업 경로로)
        File.Move(filePath, backupFilePath);
    }

    /// <summary>
    /// 네트워크 경로에서 파일을 삭제하는 함수
    /// </summary>
    /// <param name="filePath">삭제할 네트워크 파일 경로</param>
    private void DeleteNetworkFile(string filePath)
    {
        try
        {
            File.Delete(filePath);  // 네트워크 경로에서 파일 삭제
            Console.WriteLine($"File deleted from network path: {filePath}");
        }
        catch (IOException ex)
        {
            Console.WriteLine($"Error deleting file from network path: {ex.Message}");
        }
    }

    /// <summary>
    /// 백업된 파일 중 3개월 이상 된 파일을 삭제하는 함수
    /// </summary>
    public void DeleteOldBackupFiles()
    {
        // 백업 디렉터리에서 날짜별 폴더 확인
        var directories = Directory.GetDirectories(_backupPath);

        foreach (var dir in directories)
        {
            // 폴더명을 날짜로 변환하여 3개월 이전의 폴더는 삭제
            string folderName = Path.GetFileName(dir);
            if (DateTime.TryParseExact(folderName, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out DateTime folderDate))
            {
                if (folderDate < DateTime.Now.AddMonths(-3))
                {
                    Directory.Delete(dir, true);  // 폴더 및 하위 파일 삭제
                }
            }
        }
    }
}
상세 설명
주요 추가 기능:
IsFileReady 함수:

파일이 잠겨 있거나, 아직 다 쓰여지지 않은 경우를 처리합니다.
파일이 준비되지 않으면 IOException을 발생시키고, 준비된 경우만 파일을 처리합니다.
이 함수를 통해 파일이 완전히 쓰여진 뒤에만 복사를 진행할 수 있습니다.
ProcessFilesFromNetwork:

파일을 안전하게 복사한 뒤 처리하고, 복사가 완료되면 네트워크 경로에서 원본 파일을 삭제합니다.
IsFileReady 함수를 사용하여 파일이 준비된 경우에만 복사하고 처리합니다.
DeleteNetworkFile 함수:

파일이 로컬로 안전하게 복사되고 백업이 완료된 후, 네트워크 경로에서 파일을 삭제합니다.
파일 삭제에 실패할 경우 IOException을 처리하여 오류 메시지를 출력합니다.
MoveFileToBackup:

로컬에서 처리된 파일을 백업 폴더로 이동시킵니다. 날짜별로 폴더를 생성하여 파일을 관리합니다.
DeleteOldBackupFiles:

백업된 파일 중 3개월 이상 된 파일을 삭제하는 함수입니다. 매일 한 번 실행하도록 설정할 수 있습니다.
동작 과정:
네트워크 파일 복사 및 처리:

네트워크 경로에서 파일을 읽어와 로컬 경로로 안전하게 복사한 후, 복사된 파일을 처리합니다.
파일이 완전히 쓰여지지 않았을 경우, 파일을 건너뛰고 나중에 다시 시도할 수 있습니다.
파일 이동 및 백업:

로컬에서 처리된 파일은 날짜별로 관리되는 백업 폴더로 이동합니다.
C:\MESPRODFILE_Backup\yyyyMMdd 경로에 파일이 보관됩니다.
백업 파일 삭제:

3개월 이상 된 파일은 자동으로 삭제되며, 삭제 주기는 하루 한 번 등의 스케줄러를 사용하여 처리할 수 있습니다.
이 코드를 통해 네트워크 경로에서 파일을 안전하게 가져와 처리한 후, 백업을 관리하는 작업을 할 수 있습니다. 추가적인 요구