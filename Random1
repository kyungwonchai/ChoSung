ë„¤, ì•Œê² ìŠµë‹ˆë‹¤. "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì ìš©í•´ë„ ëª¨ë“  ì‚¬ëŒì´ ë‹¤ ë³¼ ìˆ˜ ìˆë‹¤"ëŠ” ë§ì”€ì€, ê²Œì‹œê¸€ì„ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸í•˜ë„ë¡ ì„¤ì •í–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³ , ì‹¤ì œë¡œ ê¸€ì„ ë³¼ ë•Œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¬»ëŠ” ê³¼ì • ì—†ì´ ë°”ë¡œ ë‚´ìš©ì´ ë³´ì¸ë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.

ì´ëŠ” app.pyì˜ view_post ë¼ìš°íŠ¸ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  ê·¸ì— ë”°ë¼ ë‚´ìš©ì„ ë³´ì—¬ì£¼ê±°ë‚˜ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì„ ë³´ì—¬ì£¼ëŠ” ë¡œì§ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šê±°ë‚˜, í˜¹ì€ ê²Œì‹œê¸€ì„ ì €ì¥í•  ë•Œ is_password_protected í”Œë˜ê·¸ë‚˜ password_hashê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì˜¬ë°”ë¥´ê²Œ ì €ì¥ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì¼ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤.

ë‹¤ìŒ íŒŒì¼ë“¤ì˜ ì „ì²´ ì½”ë“œë¥¼ ë‹¤ì‹œ í•œë²ˆ ì ê²€í•˜ê³ , ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ ë¡œì§ì„ í™•ì‹¤í•˜ê²Œ ìˆ˜ì •í•˜ì—¬ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ì¤‘ìš”: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì— is_password_protected í•„ë“œê°€ ì´ë¯¸ ì¶”ê°€ë˜ì–´ ìˆê³ , models.pyëŠ” ì´ì „ ë‹µë³€ì˜ ë‚´ìš©ê³¼ ë™ì¼í•˜ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤. ë§Œì•½ models.pyê°€ ì´ì „ ë²„ì „ì´ë¼ë©´, ì´ì „ì— ì•ˆë‚´í•´ ë“œë¦° password_hashì™€ is_password_protected í•„ë“œê°€ í¬í•¨ëœ models.pyë¡œ ë¨¼ì € ì—…ë°ì´íŠ¸í•˜ì‹œê³ , board.db íŒŒì¼ì„ ì‚­ì œ í›„ ì•±ì„ ì¬ì‹œì‘í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒˆë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

1. app.py ìˆ˜ì • (ê²Œì‹œê¸€ ë³´ê¸°, ìƒì„±, ìˆ˜ì • ë¡œì§ ì¤‘ì )

view_post ë¼ìš°íŠ¸ì—ì„œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë¡œì§ì„ ëª…í™•íˆ í•˜ê³ , new_postì™€ edit_postì—ì„œ ë¹„ë°€ë²ˆí˜¸ ê´€ë ¨ ì •ë³´ë¥¼ ì •í™•íˆ ì €ì¥í•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.

Python

import os
import uuid
import re
from functools import wraps
from datetime import datetime, timezone, timedelta

from flask import (
    Flask, render_template, request, redirect, url_for, flash, session, jsonify, abort
)
from werkzeug.utils import secure_filename

# --- ì‚¬ìš©ì ì •ì˜ ëª¨ë“ˆ ì„í¬íŠ¸ ---
try:
    from config import Config
except ImportError:
    print("CRITICAL: config.py not found or Config class cannot be imported.")
    class Config:
        SECRET_KEY = os.environ.get('SECRET_KEY') or 'a_very_strong_default_secret_key_for_dev_only_change_me'
        SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or 'sqlite:///board.db'
        SQLALCHEMY_TRACK_MODIFICATIONS = False
        ADMIN_PASSWORD = os.environ.get('ADMIN_PASSWORD') or 'kkkwww'
        UPLOAD_FOLDER = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'static/uploads')
        ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}
        MAX_CONTENT_LENGTH = 5000 * 1024 * 1024
try:
    from models import db, Post, Category
except ImportError:
    print("CRITICAL: models.py not found or db, Post, Category cannot be imported.")
    db = None; Post = None; Category = None

app = Flask(__name__)
app.config.from_object(Config)

if db: db.init_app(app)

upload_folder_path = app.config.get('UPLOAD_FOLDER', os.path.join(os.path.abspath(os.path.dirname(__file__)), 'static/uploads_fallback'))
if not os.path.exists(upload_folder_path):
    try:
        os.makedirs(upload_folder_path)
    except OSError as e:
        app.logger.error(f"Error creating upload folder {upload_folder_path}: {e}")

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in app.config.get('ALLOWED_EXTENSIONS', {'png', 'jpg', 'jpeg', 'gif'})

# --- ì¸ì¦ ê´€ë ¨ ---
def is_admin_logged_in():
    return session.get('is_admin_logged_in', False)

@app.context_processor
def inject_admin_status_and_global_vars():
    all_cats = []
    if Category:
        try: all_cats = Category.query.order_by(Category.name).all()
        except Exception as e: app.logger.error(f"Error fetching categories: {e}")
    return dict(is_admin=is_admin_logged_in(), now=datetime.now(timezone.utc), all_categories=all_cats)

def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not is_admin_logged_in():
            flash('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning')
            return redirect(url_for('login', next=request.url))
        return f(*args, **kwargs)
    return decorated_function

@app.route('/login', methods=['GET', 'POST'])
def login():
    if is_admin_logged_in(): return redirect(url_for('index'))
    if request.method == 'POST':
        password = request.form.get('password')
        if password == app.config['ADMIN_PASSWORD']:
            session['is_admin_logged_in'] = True
            session.permanent = True
            app.permanent_session_lifetime = timedelta(days=7)
            flash('ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
            return redirect(request.args.get('next') or url_for('index'))
        else:
            flash('ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.', 'danger')
    return render_template('login.html')

@app.route('/logout')
def logout():
    session.pop('is_admin_logged_in', None)
    flash('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info')
    return redirect(url_for('index'))

# --- ê²Œì‹œíŒ ë¼ìš°íŠ¸ ---
@app.route('/')
def index():
    if not Post:
        flash("ê²Œì‹œê¸€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "danger")
        return render_template('index.html', posts_pagination=None, current_category=None)
    page = request.args.get('page', 1, type=int)
    posts_pagination = Post.query.order_by(Post.timestamp.desc()).paginate(page=page, per_page=10, error_out=False)
    return render_template('index.html', posts_pagination=posts_pagination, current_category=None)

@app.route('/post/<string:slug>', methods=['GET', 'POST'])
def view_post(slug):
    if not Post: abort(500, description="Post model not available.")
    
    post_instance = Post.query.filter_by(slug=slug).first_or_404()
    session_key_for_post_unlock = f'unlocked_post_{post_instance.id}'
    is_unlocked_in_session = session.get(session_key_for_post_unlock, False)

    if post_instance.is_password_protected: # 1. ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸ëœ ê¸€ì¸ê°€?
        if is_unlocked_in_session: # 2. ì„¸ì…˜ì— ì´ë¯¸ ì´ ê¸€ì— ëŒ€í•œ ì ê¸ˆ í•´ì œ ì •ë³´ê°€ ìˆëŠ”ê°€?
            # ë³´í˜¸ëœ ê¸€ì´ì§€ë§Œ ì´ë¯¸ ì ê¸ˆ í•´ì œë¨ -> ë‚´ìš© í‘œì‹œ
            return render_template('view_post.html', post=post_instance, show_password_form=False)
        else:
            # ë³´í˜¸ëœ ê¸€ì´ê³  ì•„ì§ ì ê¸ˆ í•´ì œ ì•ˆë¨ -> ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì²˜ë¦¬ ë˜ëŠ” í¼ í‘œì‹œ
            if request.method == 'POST':
                submitted_password = request.form.get('post_password_view')
                if post_instance.check_password(submitted_password):
                    session[session_key_for_post_unlock] = True # ì ê¸ˆ í•´ì œ!
                    flash('ë¹„ë°€ë²ˆí˜¸ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
                    return redirect(url_for('view_post', slug=post_instance.slug)) # GETìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                else:
                    flash('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'danger')
                    # ë¹„ë°€ë²ˆí˜¸ í‹€ë ¸ìœ¼ë¯€ë¡œ ë‹¤ì‹œ ë¹„ë°€ë²ˆí˜¸ í¼ ë³´ì—¬ì¤Œ
                    return render_template('view_post.html', post=post_instance, show_password_form=True)
            
            # GET ìš”ì²­ ì‹œ (ë˜ëŠ” POSTì—ì„œ ë¹„ë°€ë²ˆí˜¸ í‹€ë ¸ì„ ë•Œ ë‹¤ì‹œ í¼ ë¡œë“œ - ì‹¤ì œë¡œëŠ” ìœ„ì—ì„œ ì²˜ë¦¬ë¨)
            # ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ ë³´ì—¬ì¤Œ
            return render_template('view_post.html', post=post_instance, show_password_form=True)
    else:
        # ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸ë˜ì§€ ì•Šì€ ê¸€ -> ë°”ë¡œ ë‚´ìš© í‘œì‹œ
        return render_template('view_post.html', post=post_instance, show_password_form=False)


@app.route('/new', methods=['GET', 'POST'])
@admin_required
def new_post():
    # ... (ì¹´í…Œê³ ë¦¬ ë¡œë“œ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼) ...
    cats = []
    if Category:
        try: cats = Category.query.order_by(Category.name).all()
        except Exception as e: app.logger.error(f"Error fetching categories: {e}")

    if request.method == 'POST':
        title = request.form.get('title')
        content = request.form.get('content')
        category_id_str = request.form.get('category_id')
        
        is_protected_from_form = request.form.get('is_password_protected_checkbox') == 'y'
        password_from_form = request.form.get('post_password_input')

        if not title or not content:
            flash('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning')
            return render_template('edit_post.html', title=title, content=content, categories=cats, post=None, selected_category_id=category_id_str)

        processed_category_id = int(category_id_str) if category_id_str and category_id_str.isdigit() else None

        try:
            if not Post: raise Exception("Post model is not available.")

            new_post_obj = Post(title=title, content=content, category_id=processed_category_id) # ê¸°ë³¸ ê°ì²´ ìƒì„±
            
            if is_protected_from_form:
                if password_from_form: # ë³´í˜¸ ì²´í¬ & ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ë¨
                    new_post_obj.set_password(password_from_form)
                    # new_post_obj.is_password_protected = True # set_passwordì—ì„œ ì²˜ë¦¬ë¨
                else: # ë³´í˜¸ ì²´í¬ëŠ” í–ˆìœ¼ë‚˜ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì•ˆ í•¨ (ìƒˆ ê¸€ì´ë¯€ë¡œ)
                    flash('ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸ë¥¼ ì„ íƒí–ˆì§€ë§Œ, ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë³´í˜¸ë˜ì§€ ì•Šì€ ê¸€ë¡œ ì €ì¥ë©ë‹ˆë‹¤.', 'warning')
                    new_post_obj.is_password_protected = False # ëª…ì‹œì ìœ¼ë¡œ ë³´í˜¸ í•´ì œ
                    new_post_obj.password_hash = None
            else: # ë³´í˜¸ ì²´í¬ ì•ˆ í•¨
                new_post_obj.is_password_protected = False
                new_post_obj.password_hash = None
            
            db.session.add(new_post_obj)
            db.session.commit()
            flash('ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
            return redirect(url_for('view_post', slug=new_post_obj.slug))
        except Exception as e:
            db.session.rollback()
            app.logger.error(f"Error creating post: {e}")
            flash(f'ê²Œì‹œê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜: {str(e)}', 'danger')
            return render_template('edit_post.html', title=title, content=content, categories=cats, post=None, selected_category_id=category_id_str)

    return render_template('edit_post.html', categories=cats, post=None, selected_category_id=None)


@app.route('/edit/<string:slug>', methods=['GET', 'POST'])
@admin_required
def edit_post(slug):
    # ... (ì¹´í…Œê³ ë¦¬ ë¡œë“œ ë¡œì§ ë° post_to_edit ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ì€ ì´ì „ê³¼ ë™ì¼) ...
    if not Post or not Category: abort(500)
    post_to_edit = Post.query.filter_by(slug=slug).first_or_404()
    cats = []
    try: cats = Category.query.order_by(Category.name).all()
    except Exception as e: app.logger.error(f"Error fetching categories: {e}")
    
    selected_category_id = str(post_to_edit.category_id) if post_to_edit.category_id is not None else ""
    
    if request.method == 'POST':
        original_title = post_to_edit.title
        post_to_edit.title = request.form.get('title')
        post_to_edit.content = request.form.get('content')
        category_id_str = request.form.get('category_id')
        selected_category_id = category_id_str

        is_protected_from_form = request.form.get('is_password_protected_checkbox') == 'y'
        password_from_form = request.form.get('post_password_input')

        if not post_to_edit.title or not post_to_edit.content:
            flash('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning')
            return render_template('edit_post.html', post=post_to_edit, categories=cats, title=post_to_edit.title, content=post_to_edit.content, selected_category_id=selected_category_id)

        processed_category_id = int(category_id_str) if category_id_str and category_id_str.isdigit() else None
        post_to_edit.category_id = processed_category_id

        if is_protected_from_form:
            post_to_edit.is_password_protected = True # ì¼ë‹¨ ë³´í˜¸ ìƒíƒœë¡œ ì„¤ì •
            if password_from_form: # ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì—ˆë‹¤ë©´ ë³€ê²½/ì„¤ì •
                post_to_edit.set_password(password_from_form)
            # else: ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì•ˆ í–ˆìœ¼ë©´ ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ìœ ì§€ (set_password í˜¸ì¶œ ì•ˆ í•¨)
            #       ë‹¨, ì´ ê²½ìš° ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ì—ˆë‹¤ë©´, is_password_protectedëŠ” Trueì´ì§€ë§Œ password_hashëŠ” Noneì¸ ìƒíƒœê°€ ë¨.
            #       ì´ëŸ° ìƒíƒœë¥¼ ë°©ì§€í•˜ë ¤ë©´, ë³´í˜¸ ì²´í¬ & ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì—†ìŒ & ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ì—†ìŒ -> ë³´í˜¸ í•´ì œ ë˜ëŠ” ê²½ê³  í•„ìš”
            elif not post_to_edit.password_hash: # ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì—†ê³ , ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ë„ ì—†ëŠ”ë° ë³´í˜¸ ì²´í¬í•œ ê²½ìš°
                 flash('ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ë¥¼ ì„ íƒí–ˆì§€ë§Œ, ì„¤ì •í•  ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë³´í˜¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'warning')
                 post_to_edit.is_password_protected = False # ë³´í˜¸ í•´ì œ
                 post_to_edit.password_hash = None # ëª…ì‹œì  í•´ì œ
            # (ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ê°€ ìˆê³ , ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ìœ ì§€ë¨)
        else: # ë³´í˜¸ ì²´í¬ í•´ì œ
            post_to_edit.is_password_protected = False
            post_to_edit.password_hash = None # ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ì œê±°
            
        if original_title != post_to_edit.title:
            post_to_edit.slug = post_to_edit._generate_unique_slug(post_to_edit.title)
        post_to_edit.timestamp = datetime.now(timezone.utc)
        
        try:
            db.session.commit()
            flash('ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
            return redirect(url_for('view_post', slug=post_to_edit.slug))
        except Exception as e:
            db.session.rollback()
            app.logger.error(f"Error editing post {slug}: {e}")
            flash(f'ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜: {str(e)}', 'danger')
            return render_template('edit_post.html', post=post_to_edit, categories=cats, title=post_to_edit.title, content=post_to_edit.content, selected_category_id=selected_category_id)

    return render_template('edit_post.html', post=post_to_edit, categories=cats, title=post_to_edit.title, content=post_to_edit.content, selected_category_id=selected_category_id)

# ... (delete_post, upload_image, ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ë¼ìš°íŠ¸, ì‹¤í–‰ ë¶€ë¶„ ë“±ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) ...
# ì•„ë˜ëŠ” ìƒëµëœ ë‚˜ë¨¸ì§€ ë¶€ë¶„ë“¤ì˜ ì‹œì‘ê³¼ ëì…ë‹ˆë‹¤. ì´ ì‚¬ì´ì— ìˆëŠ” ì½”ë“œëŠ” ì´ì „ ë‹µë³€ì˜ ë‚´ìš©ì„ ì‚¬ìš©í•˜ì„¸ìš”.

@app.route('/delete/<string:slug>', methods=['POST'])
@admin_required
def delete_post(slug):
    # ... (ì´ì „ ì½”ë“œ ë³µì‚¬) ...
    if not Post: abort(500)
    post_to_delete = Post.query.filter_by(slug=slug).first_or_404()
    try:
        db.session.delete(post_to_delete)
        db.session.commit()
        flash('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
    except Exception as e:
        db.session.rollback()
        app.logger.error(f"Error deleting post {slug}: {e}")
        flash(f'ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}', 'danger')
    return redirect(url_for('index'))


@app.route('/upload_image', methods=['POST'])
@admin_required
def upload_image():
    # ... (ì´ì „ ì½”ë“œ ë³µì‚¬) ...
    if 'file' not in request.files: return jsonify({'error': {'message': 'No file part in the request'}}), 400
    file = request.files['file']
    if file.filename == '': return jsonify({'error': {'message': 'No file selected for uploading'}}), 400
    if file and allowed_file(file.filename):
        original_filename = secure_filename(file.filename); filename_prefix = str(uuid.uuid4())[:8]
        base, ext = os.path.splitext(original_filename); safe_base = re.sub(r'[^\w-]', '', base)[:50]
        filename = f"{filename_prefix}_{safe_base}{ext}"; counter = 1; temp_filename_to_check = filename
        upload_path = app.config.get('UPLOAD_FOLDER', './static/uploads_fallback')
        final_filepath = os.path.join(upload_path, temp_filename_to_check)
        while os.path.exists(final_filepath):
            temp_filename_to_check = f"{filename_prefix}_{safe_base}_{counter}{ext}"
            final_filepath = os.path.join(upload_path, temp_filename_to_check); counter += 1
        filename = temp_filename_to_check
        try:
            file.save(final_filepath); image_url = url_for('static', filename=f'uploads/{filename}') 
            return jsonify({'location': image_url})
        except Exception as e:
            app.logger.error(f"Image upload failed: {e}, filepath: {final_filepath}")
            return jsonify({'error': {'message': f'Image upload failed: {str(e)}'}}), 500
    else: return jsonify({'error': {'message': f'Allowed file types are {app.config.get("ALLOWED_EXTENSIONS", set())}'}}), 400

@app.route('/admin/categories') # ì´í•˜ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ë¼ìš°íŠ¸ëŠ” ì´ì „ê³¼ ë™ì¼
@admin_required
def admin_categories(): return render_template('admin_categories.html')

@app.route('/admin/category/new', methods=['GET', 'POST'])
@admin_required
def new_category():
    # ... (ì´ì „ ì½”ë“œ ë³µì‚¬) ...
    if not Category: abort(500)
    if request.method == 'POST':
        name = request.form.get('name')
        if not name: flash('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning')
        else:
            try:
                if Category.query.filter_by(name=name).first(): flash('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ ì´ë¦„ì…ë‹ˆë‹¤.', 'warning')
                else:
                    category = Category(name=name); db.session.add(category); db.session.commit()
                    flash(f'ì¹´í…Œê³ ë¦¬ "{name}" ì¶”ê°€ ì™„ë£Œ.', 'success'); return redirect(url_for('admin_categories'))
            except Exception as e:
                db.session.rollback(); app.logger.error(f"Error creating category: {e}"); flash(f'ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì˜¤ë¥˜: {str(e)}', 'danger')
        return render_template('edit_category.html', category_name=name, category=None)
    return render_template('edit_category.html', category=None, category_name='')


@app.route('/admin/category/edit/<int:category_id>', methods=['GET', 'POST'])
@admin_required
def edit_category(category_id):
    # ... (ì´ì „ ì½”ë“œ ë³µì‚¬) ...
    if not Category: abort(500)
    category_to_edit = Category.query.get_or_404(category_id); category_name_for_form = category_to_edit.name
    if request.method == 'POST':
        new_name = request.form.get('name'); category_name_for_form = new_name
        if not new_name: flash('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning')
        elif new_name == category_to_edit.name: flash('ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'info'); return redirect(url_for('admin_categories'))
        else:
            try:
                if Category.query.filter(Category.name == new_name, Category.id != category_id).first(): flash('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ ì´ë¦„ì…ë‹ˆë‹¤.', 'warning')
                else:
                    original_name = category_to_edit.name; category_to_edit.name = new_name
                    category_to_edit.slug = category_to_edit._generate_unique_slug(new_name); db.session.commit()
                    flash(f'ì¹´í…Œê³ ë¦¬ "{original_name}"ì´ "{new_name}"(ìœ¼)ë¡œ ìˆ˜ì • ì™„ë£Œ.', 'success'); return redirect(url_for('admin_categories'))
            except Exception as e:
                db.session.rollback(); app.logger.error(f"Error editing category: {e}"); flash(f'ì¹´í…Œê³ ë¦¬ ìˆ˜ì • ì˜¤ë¥˜: {str(e)}', 'danger')
        return render_template('edit_category.html', category=category_to_edit, category_name=category_name_for_form)
    return render_template('edit_category.html', category=category_to_edit, category_name=category_name_for_form)

@app.route('/admin/category/delete/<int:category_id>', methods=['POST'])
@admin_required
def delete_category(category_id):
    # ... (ì´ì „ ì½”ë“œ ë³µì‚¬) ...
    if not Category: abort(500)
    category_to_delete = Category.query.get_or_404(category_id)
    if category_to_delete.posts_in_category.count() > 0:
        flash(f'ì¹´í…Œê³ ë¦¬ "{category_to_delete.name}"ì— ì†í•œ ê²Œì‹œê¸€ì´ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger'); return redirect(url_for('admin_categories'))
    try:
        db.session.delete(category_to_delete); db.session.commit(); flash(f'ì¹´í…Œê³ ë¦¬ "{category_to_delete.name}" ì‚­ì œ ì™„ë£Œ.', 'success')
    except Exception as e:
        db.session.rollback(); app.logger.error(f"Error deleting category: {e}"); flash(f'ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì˜¤ë¥˜: {str(e)}', 'danger')
    return redirect(url_for('admin_categories'))

@app.route('/category/<string:slug>')
def posts_by_category(slug):
    # ... (ì´ì „ ì½”ë“œ ë³µì‚¬) ...
    if not Category or not Post: abort(500)
    category = Category.query.filter_by(slug=slug).first_or_404(); page = request.args.get('page', 1, type=int)
    posts_pagination = category.posts_in_category.order_by(Post.timestamp.desc()).paginate(page=page, per_page=10, error_out=False)
    return render_template('index.html', posts_pagination=posts_pagination, current_category=category)

@app.cli.command('init-db')
def init_db_cli_command():
    if db is None: print("DB not initialized."); return
    with app.app_context(): db.drop_all(); db.create_all()
    print('Initialized the database.')

_db_initialized_flag = False
@app.before_request
def ensure_tables_exist():
    global _db_initialized_flag
    if not _db_initialized_flag and db is not None:
        with app.app_context(): db.create_all()
        _db_initialized_flag = True

@app.route('/debug_config_check')
def debug_config_check():
    max_size = app.config.get('MAX_CONTENT_LENGTH')
    if max_size is None: return "MAX_CONTENT_LENGTH is not set."
    is_5gb = (max_size == 5000 * 1024 * 1024)
    return f"MAX_CONTENT_LENGTH: {max_size} bytes. Is this 5GB? {is_5gb}"

if __name__ == '__main__':
    if db is not None:
        with app.app_context(): db.create_all() 
    app.run(host='10.244.122.25', port=8099, debug=True, threaded=True)
app.py ë³€ê²½ ì‚¬í•­ ìš”ì•½:

new_post ë° edit_post ë¼ìš°íŠ¸:
is_password_protected_checkbox (ì²´í¬ë°•ìŠ¤)ì™€ post_password_input (ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ)ì˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
ìƒˆ ê¸€ ì‘ì„± ì‹œ: "ë³´í˜¸" ì²´í¬ + ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œì—ë§Œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. "ë³´í˜¸" ì²´í¬ + ë¹„ë°€ë²ˆí˜¸ ë¯¸ì…ë ¥ ì‹œ ê²½ê³  í›„ ë³´í˜¸ í•´ì œ ìƒíƒœë¡œ ì €ì¥í•©ë‹ˆë‹¤.
ê¸€ ìˆ˜ì • ì‹œ:
"ë³´í˜¸" ì²´í¬ + ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ -> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½/ì„¤ì •.
"ë³´í˜¸" ì²´í¬ + ë¹„ë°€ë²ˆí˜¸ ë¯¸ì…ë ¥ + ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ì—†ìŒ -> ê²½ê³  í›„ ë³´í˜¸ í•´ì œ.
"ë³´í˜¸" ì²´í¬ + ë¹„ë°€ë²ˆí˜¸ ë¯¸ì…ë ¥ + ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ìˆìŒ -> ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ìœ ì§€ (ì´ ë¡œì§ì„ ëª…í™•íˆ í•˜ê¸° ìœ„í•´, set_password í˜¸ì¶œì„ if password_from_form: ì¡°ê±´ ì•ˆìœ¼ë¡œ ë„£ê³ , ê¸°ì¡´ í•´ì‹œê°€ ìˆëŠ” ê²½ìš°ëŠ” ë³„ë„ ì²˜ë¦¬í•˜ì§€ ì•Šì•„ ìœ ì§€ë˜ë„ë¡ í•©ë‹ˆë‹¤. í˜¹ì€ ëª…ì‹œì ìœ¼ë¡œ post_to_edit.password_hashë¥¼ ê±´ë“œë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤). ìœ„ ì½”ë“œì—ì„œëŠ” elif not post_to_edit.password_hash: ì¡°ê±´ì„ ì¶”ê°€í•˜ì—¬ ì´ ê²½ìš°ë¥¼ ëª…í™•íˆ í–ˆìŠµë‹ˆë‹¤.
"ë³´í˜¸" ì²´í¬ í•´ì œ ì‹œ -> ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ í•´ì œ (í•´ì‹œê°’ Noneìœ¼ë¡œ).
view_post ë¼ìš°íŠ¸:
ê²Œì‹œê¸€ì´ is_password_protected Trueì´ê³ , ì„¸ì…˜ì— unlocked_post_{id}ê°€ ì—†ìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤ (show_password_form=True).
ë¹„ë°€ë²ˆí˜¸ í¼ì—ì„œ POST ìš”ì²­ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ê°€ ì œì¶œë˜ë©´, post_instance.check_password()ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
ì„±ê³µí•˜ë©´ ì„¸ì…˜ì— unlocked_post_{id} = Trueë¡œ ê¸°ë¡í•˜ê³ , ê°™ì€ í˜ì´ì§€ë¡œ GET ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì—¬ ê¸€ ë‚´ìš©ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
ì‹¤íŒ¨í•˜ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ flashí•˜ê³  ë‹¤ì‹œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
ë³´í˜¸ë˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ì ê¸ˆ í•´ì œëœ ê¸€ì€ ë°”ë¡œ ë‚´ìš©ì„ ë³´ì—¬ì¤ë‹ˆë‹¤ (show_password_form=False).
2. templates/view_post.html ìˆ˜ì •

ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ê³¼ ì‹¤ì œ ê¸€ ë‚´ìš©ì„ ì¡°ê±´ë¶€ë¡œ í‘œì‹œí•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.

templates/view_post.html (ìµœì¢… ìˆ˜ì •ë³¸)

HTML

{% extends "base.html" %}

{% block title %}{{ post.title }} - ë‚˜ì˜ ê²Œì‹œíŒ{% endblock %}

{% block content %}
{# base.htmlì—ì„œ col-md-9 ì•ˆìœ¼ë¡œ ì´ë™í–ˆìœ¼ë¯€ë¡œ, ì´ divëŠ” í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ. ë ˆì´ì•„ì›ƒì— ë”°ë¼ ì¡°ì ˆ. #}
{# <div class="container mt-4"> #}

    {% if show_password_form %}
        {# --- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ --- #}
        <div class="password-form-container mt-4 p-4 border rounded bg-light">
            <h4 class="mb-3">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h4>
            <p>ì´ ê²Œì‹œê¸€ì€ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ë³´ì‹œë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <form method="POST" action="{{ url_for('view_post', slug=post.slug) }}">
                <div class="form-group">
                    <label for="post_password_view_input">ë¹„ë°€ë²ˆí˜¸:</label>
                    <input type="password" class="form-control" id="post_password_view_input" name="post_password_view" required autofocus>
                </div>
                <button type="submit" class="btn btn-primary">í™•ì¸</button>
                <a href="{{ url_for('index') }}" class="btn btn-link">ëª©ë¡ìœ¼ë¡œ</a>
            </form>
        </div>
        {# --- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ ë --- #}
    {% else %}
        {# --- ì‹¤ì œ ê²Œì‹œê¸€ ë‚´ìš© --- #}
        <article>
            <header class="mb-4">
                <h1>{{ post.title }}</h1>
                <div class="text-muted">
                    <small>
                        ì‘ì„±ì¼: {{ post.timestamp.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}
                        {% if post.category %}
                            | ì¹´í…Œê³ ë¦¬: <a href="{{ url_for('posts_by_category', slug=post.category.slug) }}">{{ post.category.name }}</a>
                        {% endif %}
                        {% if post.is_password_protected %}
                            | <span class="text-danger">ë¹„ë°€ê¸€</span>
                        {% endif %}
                    </small>
                </div>
                {% if is_admin %}
                    <div class="mt-2">
                        <a href="{{ url_for('edit_post', slug=post.slug) }}" class="btn btn-sm btn-secondary">ìˆ˜ì •</a>
                        <form action="{{ url_for('delete_post', slug=post.slug) }}" method="POST" class="d-inline" onsubmit="return confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            <button type="submit" class="btn btn-sm btn-danger">ì‚­ì œ</button>
                        </form>
                    </div>
                {% endif %}
            </header>
            <section class="post-content">
                {{ post.content | safe }}
            </section>
        </article>
        <hr>
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary mt-3">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        {# --- ì‹¤ì œ ê²Œì‹œê¸€ ë‚´ìš© ë --- #}
    {% endif %}

{# </div> #}
{% endblock %}
view_post.html ë³€ê²½ ì‚¬í•­ ìš”ì•½:

app.pyì˜ view_post ë¼ìš°íŠ¸ì—ì„œ ì „ë‹¬ëœ show_password_form ë³€ìˆ˜ ê°’ì— ë”°ë¼ ë¶„ê¸°í•©ë‹ˆë‹¤.
show_password_formì´ Trueì´ë©´: ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ì„ í‘œì‹œí•©ë‹ˆë‹¤. ì´ í¼ì€ í˜„ì¬ view_post URLë¡œ POST ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. ì…ë ¥ í•„ë“œì˜ nameì€ post_password_viewì…ë‹ˆë‹¤.
show_password_formì´ Falseì´ë©´: ê¸°ì¡´ì²˜ëŸ¼ ê²Œì‹œê¸€ì˜ ì œëª©, ë‚´ìš© ë“±ì„ í‘œì‹œí•©ë‹ˆë‹¤. ê²Œì‹œê¸€ ì •ë³´ì— "ë¹„ë°€ê¸€" í‘œì‹œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
3. templates/index.html ìˆ˜ì • (ì„ íƒ ì‚¬í•­ - ë¹„ë°€ê¸€ í‘œì‹œ)

ëª©ë¡ì—ì„œ ë¹„ë°€ê¸€ì„ì„ ì•„ì´ì½˜ ë“±ìœ¼ë¡œ í‘œì‹œí•´ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

HTML

{# ... index.htmlì˜ ê²Œì‹œê¸€ ë£¨í”„ ë¶€ë¶„ ... #}
<small class="text-muted">
    ì‘ì„±ì¼: {{ post_item.timestamp.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}
    {% if post_item.category %}
        | ì¹´í…Œê³ ë¦¬: <a href="{{ url_for('posts_by_category', slug=post_item.category.slug) }}">{{ post_item.category.name }}</a>
    {% endif %}
    {# --- ë¹„ë°€ê¸€ í‘œì‹œ ì¶”ê°€ --- #}
    {% if post_item.is_password_protected %}
        | <span class="text-danger" title="ë¹„ë°€ê¸€">ğŸ”’</span>
    {% endif %}
    {# --- ë¹„ë°€ê¸€ í‘œì‹œ ì¶”ê°€ ë --- #}
</small>
{# ... #}
ìµœì¢… ì ê²€ ë° í…ŒìŠ¤íŠ¸:

ìœ„ì— ì œê³µëœ app.py ì „ì²´ ì½”ë“œì™€ templates/view_post.html ì „ì²´ ì½”ë“œë¡œ í•´ë‹¹ íŒŒì¼ì„ ì™„ì „íˆ êµì²´í•©ë‹ˆë‹¤.
models.pyì™€ templates/edit_post.html íŒŒì¼ì´ ì´ì „ ë‹µë³€ë“¤ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ê¸°ëŠ¥ì„ ìœ„í•´ ìˆ˜ì •ëœ ìµœì‹  ë²„ì „ì¸ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•©ë‹ˆë‹¤.
ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë‹¤ì‹œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤ (board.db íŒŒì¼ ì‚­ì œ í›„ ì•± ì¬ì‹œì‘). ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ ìˆì—ˆìœ¼ë¯€ë¡œ í•„ìˆ˜ì…ë‹ˆë‹¤.
ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¬ì‹œì‘í•©ë‹ˆë‹¤.
ë‹¤ìŒ ì‹œë‚˜ë¦¬ì˜¤ë“¤ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤:
ê¸€ ì‘ì„±: "ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸" ì²´í¬ + ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ì €ì¥.
ê¸€ ë³´ê¸° (ë³´í˜¸ëœ ê¸€):
ì²˜ìŒ ì ‘ì† ì‹œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì´ ëœ¨ëŠ”ì§€ í™•ì¸.
í‹€ë¦° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ ë° ë‹¤ì‹œ ì…ë ¥ì°½ ëœ¨ëŠ”ì§€ í™•ì¸.
ë§ëŠ” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ ê¸€ ë‚´ìš©ì´ ë³´ì´ê³ , "ë¹„ë°€ë²ˆí˜¸ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ ëœ¨ëŠ”ì§€ í™•ì¸.
í•œë²ˆ ì¸ì¦ í›„ ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œ ë‹¤ì‹œ í•´ë‹¹ ê¸€ ì ‘ì† ì‹œ ë°”ë¡œ ë‚´ìš©ì´ ë³´ì´ëŠ”ì§€ í™•ì¸ (ì„¸ì…˜ ìœ ì§€).
ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë‚˜ ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ì ‘ì† ì‹œ ë‹¤ì‹œ ë¹„ë°€ë²ˆí˜¸ ë¬»ëŠ”ì§€ í™•ì¸.
ê¸€ ìˆ˜ì • (ë³´í˜¸ëœ ê¸€):
"ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸" ì²´í¬ ìœ ì§€ + ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì•ˆ í•¨ -> ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸.
"ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸" ì²´í¬ ìœ ì§€ + ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ë˜ëŠ”ì§€ í™•ì¸.
"ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸" ì²´í¬ í•´ì œ -> ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ í•´ì œë˜ëŠ”ì§€ í™•ì¸.
ë³´í˜¸ë˜ì§€ ì•Šì€ ê¸€ ë³´ê¸°: ë°”ë¡œ ë‚´ìš©ì´ ë³´ì´ëŠ”ì§€ í™•ì¸.
ì´ ìˆ˜ì •ëœ ì½”ë“œë“¤ë¡œ ì‚¬ìš©ìë‹˜ê»˜ì„œ ì›í•˜ì‹œëŠ” "ê¸€ë§ˆë‹¤ í•„ìš”ì‹œ ë¹„ë°€ë²ˆí˜¸ ì ìš©" ê¸°ëŠ¥ì´ ì œëŒ€ë¡œ ë™ì‘í•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤. ë‹¤ì‹œ í•œë²ˆ, ì´ì „ ê³¼ì •ì—ì„œì˜ í˜¼ë€ê³¼ ë¶ˆí¸ì— ëŒ€í•´ ì‚¬ê³¼ë“œë¦½ë‹ˆë‹¤.

