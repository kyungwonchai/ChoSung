import os

# --- ì„¤ì • ê°’ ---
# ì•ˆë“œë¡œì´ë“œ í”„ë¡œì íŠ¸ì˜ íŒ¨í‚¤ì§€ ì´ë¦„ì„ ì •í™•í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.
# ì˜ˆ: com.example.mypdfviewer
PACKAGE_NAME = "com.example.mypdfviewer"
# --- ì„¤ì • ë ---

# íŒ¨í‚¤ì§€ ì´ë¦„ì„ í´ë” ê²½ë¡œë¡œ ë³€í™˜
package_path = os.path.join('app', 'src', 'main', 'java', *PACKAGE_NAME.split('.'))

# 1. build.gradle.kts (Module :app) íŒŒì¼ ë‚´ìš©
# Kotlin DSL(.kts) ë¬¸ë²•ì— ë§ê²Œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
build_gradle_content = """
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
}

android {
    namespace = "{package_name}"
    compileSdk = 34

    defaultConfig {
        applicationId = "{package_name}"
        minSdk = 24
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }
    kotlinOptions {
        jvmTarget = "1.8"
    }
    // ë·° ë°”ì¸ë”© í™œì„±í™”
    buildFeatures {
        viewBinding = true
    }
}

dependencies {
    implementation("androidx.core:core-ktx:1.13.1")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("com.google.android.material:material:1.11.0")
    implementation("androidx.constraintlayout:constraintlayout:2.1.4")
    testImplementation("junit:junit:4.13.2")
    androidTestImplementation("androidx.test.ext:junit:1.1.5")
    androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")

    // PDF ë·°ì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬
    implementation("com.github.barteksc:android-pdf-viewer:3.2.0-beta.1")

    // ë„¤íŠ¸ì›Œí¬ ê³µìœ  í´ë”(SMB) ì ‘ê·¼ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
    implementation("org.smbj:jcifs-ng:2.1.10")

    // ì½”í‹€ë¦° ì½”ë£¨í‹´ (ë¹„ë™ê¸° ë„¤íŠ¸ì›Œí¬ ì‘ì—…ì„ ìœ„í•¨)
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.7.0")
}
""".replace("{package_name}", PACKAGE_NAME)

# 2. AndroidManifest.xml íŒŒì¼ ë‚´ìš© (ì´ì „ê³¼ ë™ì¼)
manifest_content = """
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <!-- ì¸í„°ë„· ë° ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ì ‘ê·¼ ê¶Œí•œ ì¶”ê°€ -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <application
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.MyPdfViewer"
        tools:targetApi="31">
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
"""

# 3. activity_main.xml (ë ˆì´ì•„ì›ƒ) íŒŒì¼ ë‚´ìš© (ì´ì „ê³¼ ë™ì¼)
layout_content = """
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    tools:context=".MainActivity">

    <!-- ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ (í•­ìƒ ë³´ì´ë„ë¡ ê³ ì •) -->
    <HorizontalScrollView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:background="#F0F0F0"
        android:scrollbars="none">

        <LinearLayout
            android:id="@+id/pageButtonContainer"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            android:paddingStart="8dp"
            android:paddingEnd="8dp"/>
    </HorizontalScrollView>

    <!-- ë¡œë”© ì¤‘ í‘œì‹œë  í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
    <ProgressBar
        android:id="@+id/progressBar"
        style="?android:attr/progressBarStyle"
        android:layout_width="wrap_content"
        android:layout_height="0dp"
        android:layout_gravity="center"
        android:layout_weight="1"
        android:visibility="gone" />

    <!-- PDFë¥¼ í‘œì‹œí•  ë·° -->
    <com.github.barteksc.pdfviewer.PDFView
        android:id="@+id/pdfView"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"/>

</LinearLayout>
"""

# 4. MainActivity.kt íŒŒì¼ ë‚´ìš© (ì´ì „ê³¼ ë™ì¼, íŒ¨í‚¤ì§€ëª…ë§Œ ìˆ˜ì •)
main_activity_content = """
package {package_name}

import android.os.Bundle
import android.util.Log
import android.view.View
import android.widget.Button
import android.widget.LinearLayout
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import com.github.barteksc.pdfviewer.util.FitPolicy
import {package_name}.databinding.ActivityMainBinding
import jcifs.smb.NtlmPasswordAuthenticator
import jcifs.smb.SmbFile
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.File
import java.io.FileOutputStream

class MainActivity : AppCompatActivity() {

    // ë·° ë°”ì¸ë”©ì„ ìœ„í•œ ë³€ìˆ˜ ì„ ì–¸
    private lateinit var binding: ActivityMainBinding

    // --- ê³µìœ  í´ë” ì„¤ì • (ì¤‘ìš”: ì´ ë¶€ë¶„ì„ ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”) ---
    private val smbDomain = "" // ë„ë©”ì¸ (ì—†ìœ¼ë©´ ë¹„ì›Œë‘ì„¸ìš”)
    private val smbUsername = "Your_Username" // ê³µìœ  í´ë” ì ‘ì† ì•„ì´ë””
    private val smbPassword = "Your_Password" // ê³µìœ  í´ë” ì ‘ì† ë¹„ë°€ë²ˆí˜¸
    private val smbIpAddress = "192.168.0.100" // ê³µìœ  í´ë” ì„œë²„ì˜ IP ì£¼ì†Œ
    private val sharedFolderName = "SharedDocs" // ê³µìœ  í´ë” ì´ë¦„
    private val pdfFileName = "document.pdf" // ì—´ê³ ì í•˜ëŠ” PDF íŒŒì¼ ì´ë¦„
    // --- ì„¤ì • ë ---

    // ì´ í˜ì´ì§€(ë²„íŠ¼) ìˆ˜
    private val totalPageCount = 16

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        // ë·° ë°”ì¸ë”© ì´ˆê¸°í™”
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        // í˜ì´ì§€ ì´ë™ ë²„íŠ¼ ìƒì„±
        createPageNavigationButtons()

        // ê³µìœ  í´ë”ì—ì„œ PDF íŒŒì¼ ë¡œë“œ ì‹œì‘
        loadPdfFromSharedFolder()
    }

    /**
     * ê³µìœ  í´ë”ì—ì„œ PDF íŒŒì¼ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤.
     */
    private fun loadPdfFromSharedFolder() {
        binding.progressBar.visibility = View.VISIBLE
        binding.pdfView.visibility = View.GONE

        // ì½”ë£¨í‹´ì„ ì‚¬ìš©í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë„¤íŠ¸ì›Œí¬ ì‘ì—… ìˆ˜í–‰
        lifecycleScope.launch {
            val localFile = downloadSmbFile()
            if (localFile != null) {
                displayPdfFromFile(localFile)
            } else {
                binding.progressBar.visibility = View.GONE
                Toast.makeText(this@MainActivity, "PDF íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", Toast.LENGTH_LONG).show()
            }
        }
    }

    /**
     * SMB/CIFS í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ ê³µìœ  í´ë”ì˜ íŒŒì¼ì„ ì•± ë‚´ë¶€ ì €ì¥ì†Œë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
     * @return ë‹¤ìš´ë¡œë“œ ì„±ê³µ ì‹œ File ê°ì²´, ì‹¤íŒ¨ ì‹œ null
     */
    private suspend fun downloadSmbFile(): File? = withContext(Dispatchers.IO) {
        try {
            // smb://{IPì£¼ì†Œ}/{ê³µìœ í´ë”ëª…}/{íŒŒì¼ëª…} í˜•ì‹ì˜ ê²½ë¡œ ìƒì„±
            val smbUrl = "smb://$smbIpAddress/$sharedFolderName/$pdfFileName"

            // ì¸ì¦ ì •ë³´ ìƒì„±
            val auth = NtlmPasswordAuthenticator(smbDomain, smbUsername, smbPassword)

            // SmbFile ê°ì²´ ìƒì„±
            val smbFile = SmbFile(smbUrl, auth)

            // ì•± ë‚´ë¶€ ìºì‹œ ë””ë ‰í† ë¦¬ì— ì„ì‹œ íŒŒì¼ ìƒì„±
            val localFile = File(cacheDir, pdfFileName)
            
            // íŒŒì¼ ë³µì‚¬ (ë‹¤ìš´ë¡œë“œ)
            smbFile.inputStream.use { input ->
                FileOutputStream(localFile).use { output ->
                    input.copyTo(output)
                }
            }
            Log.d("SmbTest", "íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ: ${"$"}{localFile.path}")
            return@withContext localFile

        } catch (e: Exception) {
            Log.e("SmbTest", "SMB íŒŒì¼ ì ‘ê·¼ ì˜¤ë¥˜", e)
            // UI ìŠ¤ë ˆë“œì—ì„œ Toast ë©”ì‹œì§€ í‘œì‹œ
            withContext(Dispatchers.Main) {
                Toast.makeText(applicationContext, "ì˜¤ë¥˜: ${"$"}{e.message}", Toast.LENGTH_LONG).show()
            }
            return@withContext null
        }
    }

    /**
     * ë¡œì»¬ íŒŒì¼ ê²½ë¡œì˜ PDFë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
     * @param file í‘œì‹œí•  PDF íŒŒì¼ ê°ì²´
     */
    private fun displayPdfFromFile(file: File) {
        binding.progressBar.visibility = View.GONE
        binding.pdfView.visibility = View.VISIBLE

        binding.pdfView.fromFile(file)
            .enableSwipe(true) // ìŠ¤ì™€ì´í”„ë¡œ í˜ì´ì§€ ë„˜ê¸°ê¸° í™œì„±í™”
            .swipeHorizontal(false) // ìˆ˜ì§ ìŠ¤í¬ë¡¤
            .enableDoubletap(true) // ë”ë¸”íƒ­ìœ¼ë¡œ í™•ëŒ€/ì¶•ì†Œ í™œì„±í™”
            .defaultPage(0) // ì´ˆê¸° í˜ì´ì§€ ì„¤ì • (0ë¶€í„° ì‹œì‘)
            .pageFitPolicy(FitPolicy.WIDTH) // í˜ì´ì§€ë¥¼ í™”ë©´ ë„ˆë¹„ì— ë§ì¶¤
            .load()
    }

    /**
     * ìƒë‹¨ì— 16ê°œì˜ í˜ì´ì§€ ì´ë™ ë²„íŠ¼ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ê³  í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
     */
    private fun createPageNavigationButtons() {
        for (i in 1..totalPageCount) {
            val pageButton = Button(this).apply {
                text = i.toString()
                layoutParams = LinearLayout.LayoutParams(
                    LinearLayout.LayoutParams.WRAP_CONTENT,
                    LinearLayout.LayoutParams.WRAP_CONTENT
                )
                setOnClickListener {
                    // í˜ì´ì§€ ë²ˆí˜¸ëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ (i - 1)ë¡œ ì „ë‹¬
                    binding.pdfView.jumpTo(i - 1, true)
                }
            }
            // ìƒì„±ëœ ë²„íŠ¼ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            binding.pageButtonContainer.addView(pageButton)
        }
    }
}
""".replace("{package_name}", PACKAGE_NAME)

# íŒŒì¼ ìƒì„± ë° ì“°ê¸° í•¨ìˆ˜
def write_file(path, content):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, 'w', encoding='utf-8') as f:
        f.write(content)
    print(f"âœ… íŒŒì¼ ìƒì„± ì™„ë£Œ: {path}")

# --- ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ---
print("ğŸš€ ì•ˆë“œë¡œì´ë“œ í”„ë¡œì íŠ¸ íŒŒì¼ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤... (KTS ë²„ì „)")

# íŒŒì¼ ê²½ë¡œ ì •ì˜
build_gradle_path = os.path.join('app', 'build.gradle.kts') # .ktsë¡œ ë³€ê²½
manifest_path = os.path.join('app', 'src', 'main', 'AndroidManifest.xml')
layout_path = os.path.join('app', 'src', 'main', 'res', 'layout', 'activity_main.xml')
main_activity_path = os.path.join(package_path, 'MainActivity.kt')

# íŒŒì¼ ìƒì„±
write_file(build_gradle_path, build_gradle_content)
write_file(manifest_path, manifest_content)
write_file(layout_path, layout_content)
write_file(main_activity_path, main_activity_content)

print("\nğŸ‰ ëª¨ë“  íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±(ë®ì–´ì“°ê¸°)ë˜ì—ˆìŠµë‹ˆë‹¤!")
print("   - ì•ˆë“œë¡œì´ë“œ ìŠ¤íŠœë””ì˜¤ ìš°ì¸¡ ìƒë‹¨ì˜ ì½”ë¼ë¦¬ ëª¨ì–‘ ì•„ì´ì½˜(Sync Project with Gradle Files)ì„ ëˆŒëŸ¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.")
print("   - MainActivity.kt íŒŒì¼ì˜ ê³µìœ  í´ë” ì„¤ì • ë¶€ë¶„ì„ ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ê¼­ ìˆ˜ì •í•´ì£¼ì„¸ìš”.")