using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.IO;
using System.Linq;
using System.Text.RegularExpressions;

class Program
{
    static void Main()
    {
        string folderPath = @"C:\folderC";  // 폴더 C의 경로
        DateTime A = DateTime.Parse("2023-09-19T12:34:56"); // 예시 시간
        string B = "ggggg"; // 예시 문자열

        DirectoryInfo di = new DirectoryInfo(folderPath);
        FileInfo[] files = di.GetFiles("InspData_*.log");

        List<DateTime> TList = new List<DateTime>(); // T1~T10 저장할 리스트
        Dictionary<string, long> lastPositions = new Dictionary<string, long>(); // 마지막으로 읽은 파일의 위치를 저장

        while (TList.Count < 10)
        {
            foreach (var file in files.OrderBy(f => f.Name))
            {
                long lastPosition = 0;
                if (lastPositions.ContainsKey(file.FullName))
                {
                    lastPosition = lastPositions[file.FullName];
                }

                using (FileStream fs = new FileStream(file.FullName, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                {
                    fs.Position = lastPosition;

                    using (StreamReader reader = new StreamReader(fs))
                    {
                        string line;
                        while ((line = reader.ReadLine()) != null)
                        {
                            lastPosition = fs.Position;

                            if (line.Contains(B) && line.Contains("COMPLETE =="))
                            {
                                Match match = Regex.Match(line, @"\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}");
                                if (match.Success)
                                {
                                    DateTime logTime = DateTime.Parse(match.Value);
                                    if (logTime > A)
                                    {
                                        TList.Add(logTime);

                                        // SQL Server 2014로 업데이트 (예시)
                                        using (SqlConnection conn = new SqlConnection("Data Source=your_server;Initial Catalog=your_database;User ID=your_username;Password=your_password"))
                                        {
                                            conn.Open();
                                            SqlCommand cmd = new SqlCommand($"UPDATE YourTable SET YourColumn = {TList.Count} WHERE SomeCondition", conn);
                                            cmd.ExecuteNonQuery();
                                        }
                                    }
                                }
                            }

                            if (TList.Count >= 10)
                            {
                                break;
                            }
                        }
                    }

                    lastPositions[file.FullName] = lastPosition;
                }

                if (TList.Count >= 10)
                {
                    break;
                }
            }
        }

        // T1~T10 변수에 저장
        for (int i = 0; i < TList.Count; i++)
        {
            Console.WriteLine($"T{i + 1}: {TList[i]}");
        }
    }
}
