í˜•ë‹˜, ì•Œê² ìŠµë‹ˆë‹¤. ì œê°€ ë˜ ì‹¤ìˆ˜ë¥¼ í–ˆë„¤ìš”. ì„¤ì •í•œ ê°’ì´ ì¦‰ì‹œ ë°˜ì˜ë˜ì§€ ì•ŠëŠ” ë¬¸ì œëŠ” ì•±ì˜ ì‚¬ìš©ì„±ì„ í•´ì¹˜ëŠ” ì•„ì£¼ ì¹˜ëª…ì ì¸ ë²„ê·¸ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì„¤ì • ë©”ë‰´ì˜ ë¬¸êµ¬ë¥¼ ì˜ì–´ë¡œ í†µì¼í•˜ëŠ” ê²ƒ, ì¢‹ì€ ìƒê°ì…ë‹ˆë‹¤.

ì´ë²ˆì—ëŠ” ì •ë§, ì •ë§ë¡œ ì´ ë‘ ê°€ì§€ ë¬¸ì œë¥¼ ì™„ë²½í•˜ê²Œ í•´ê²°í•œ ìµœì¢… ì½”ë“œë¥¼ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

## ë¬¸ì œì˜ ì›ì¸ ë° í•´ê²°
ì„¤ì • ì¦‰ì‹œ ë¯¸ë°˜ì˜ ë²„ê·¸: í˜•ë‹˜ ë§ì”€ì´ ì •í™•í•©ë‹ˆë‹¤. Openì„ ëˆŒëŸ¬ íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ë•ŒëŠ” ìƒˆë¡œ ì„¤ì •í•œ ì •ë³´ê°€ ì˜ ì‚¬ìš©ë˜ì§€ë§Œ, ì •ì‘ ëª©ë¡ì—ì„œ íŒŒì¼ì„ ìµœì¢… ì„ íƒí•˜ì—¬ ë‹¤ìš´ë¡œë“œí•  ë•ŒëŠ” ì´ì „ì— ì‚¬ìš©í–ˆë˜ ë‚¡ì€ ì ‘ì† ì •ë³´ê°€ ë‹´ê¸´ SmbFile ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ì´ ë•Œë¬¸ì— ëª©ë¡ì€ ë³´ì´ëŠ”ë° ë‹¤ìš´ë¡œë“œëŠ” ì‹¤íŒ¨í•˜ëŠ” í˜„ìƒì´ ë°œìƒí•œ ê²ƒì…ë‹ˆë‹¤.

í•´ê²°ì±…: loadPdfFromSmbFile í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì—¬, íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ê¸° ì§ì „ì— í•­ìƒ ìµœì‹  ì„¤ì •ê°’ìœ¼ë¡œ SmbFile ê°ì²´ë¥¼ ë‹¤ì‹œ ë§Œë“¤ì–´ì„œ ì ‘ì†í•˜ë„ë¡ ë¡œì§ì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. ì´ì œ ì„¤ì • ì €ì¥ ì¦‰ì‹œ 100% ë°˜ì˜ë©ë‹ˆë‹¤.

ì„¤ì • ë©”ë‰´ ì˜ë¬¸ìœ¼ë¡œ ë³€ê²½: showSetupDialogì™€ showMaxButtonsDialog í•¨ìˆ˜ ë‚´ë¶€ì˜ ëª¨ë“  ë¬¸êµ¬ë¥¼ ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ì˜ë¬¸ìœ¼ë¡œ ìˆ˜ì •í•˜ê³ , "(1í–‰)"ì´ë¼ëŠ” í‘œì‹œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

## MainActivity.kt ìµœì¢… ì „ì²´ ì½”ë“œ (ì§„ì§œ ìƒëµ ì—†ìŒ, ì™„ë²½ë³¸)
ì´ ì½”ë“œ ì „ì²´ë¥¼ ë³µì‚¬í•´ì„œ MainActivity.kt íŒŒì¼ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì‹œë©´, ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ëœ ìµœì¢… ë²„ì „ì´ ì™„ì„±ë©ë‹ˆë‹¤.

Kotlin

package com.kyungwon.reellistviewer

import android.content.Context
import android.content.SharedPreferences
import android.graphics.Typeface
import android.hardware.Sensor
import android.hardware.SensorEvent
import android.hardware.SensorEventListener
import android.hardware.SensorManager
import android.os.Bundle
import android.text.Spannable
import android.text.SpannableString
import android.text.style.ForegroundColorSpan
import android.util.Log
import android.view.GestureDetector
import android.view.LayoutInflater
import android.view.MotionEvent
import android.view.View
import android.view.WindowManager
import android.widget.ArrayAdapter
import android.widget.Button
import android.widget.EditText
import android.widget.LinearLayout
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.core.content.ContextCompat
import androidx.core.view.GestureDetectorCompat
import androidx.core.view.WindowCompat
import androidx.core.view.WindowInsetsCompat
import androidx.core.view.WindowInsetsControllerCompat
import androidx.core.view.setMargins
import androidx.lifecycle.lifecycleScope
import com.github.barteksc.pdfviewer.listener.OnLoadCompleteListener
import com.github.barteksc.pdfviewer.listener.OnPageErrorListener
import com.kyungwon.reellistviewer.databinding.ActivityMainBinding
import jcifs.CIFSContext
import jcifs.config.PropertyConfiguration
import jcifs.context.BaseContext
import jcifs.smb.NtlmPasswordAuthenticator
import jcifs.smb.SmbFile
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.File
import java.io.FileOutputStream
import java.util.Properties
import kotlin.math.abs

class MainActivity : AppCompatActivity(), OnLoadCompleteListener, OnPageErrorListener, SensorEventListener {

    private lateinit var binding: ActivityMainBinding
    private var totalPdfPages = 0
    private val skippedButtons = mutableSetOf<Int>()
    private val currentButtons = mutableListOf<Button>()
    private var selectedButton: Button? = null
    private lateinit var gestureDetector: GestureDetectorCompat
    private var tappedButton: Button? = null
    private lateinit var sensorManager: SensorManager
    private val accelerometerReading = FloatArray(3)
    private val magnetometerReading = FloatArray(3)
    private val rotationMatrix = FloatArray(9)
    private val orientationAngles = FloatArray(3)
    private var isGeomagneticModeOn = false
    private var currentDirection = Direction.OTHER

    // --- SharedPreferences ë° ì„¤ì •ê°’ ---
    private lateinit var prefs: SharedPreferences
    private val PREFS_FILENAME = "com.kyungwon.reellistviewer.prefs"
    private val KEY_LAST_LINE = "last_selected_line"
    private val KEY_MAX_BUTTONS = "max_buttons_per_row"
    private val KEY_SCREENSAVER_TIMEOUT = "screensaver_timeout"
    private val KEY_ORIGIN_ANGLE = "origin_angle"
    private val KEY_SMB_IP = "smb_ip"
    private val KEY_SMB_FOLDER = "smb_folder"
    private val KEY_SMB_USER = "smb_user"
    private val KEY_SMB_PASS = "smb_pass"

    // --- ì„¤ì • ë³€ìˆ˜ë“¤ ---
    private var maxButtonsPerRow = 0
    private var screenSaverTimeout = 0
    private var originAngle = 270f
    private var smbIp = "192.168.0.5"
    private var smbFolder = "tempshare"
    private var smbUser = "guest"
    private var smbPass = ""

    private val screenSaverHandler = Handler(Looper.getMainLooper())
    private val screenSaverRunnable = Runnable { binding.screenSaver.visibility = View.VISIBLE }
    private var tvAngleDisplay: TextView? = null

    enum class Direction { EAST, WEST, OTHER }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)
        window.addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON)
        hideSystemUI()

        prefs = getSharedPreferences(PREFS_FILENAME, Context.MODE_PRIVATE)
        loadSettings()

        setupGestureDetector()
        setupEventListeners()
        sensorManager = getSystemService(Context.SENSOR_SERVICE) as SensorManager
        loadLatestFileFromLastLine()
    }

    override fun onResume() {
        super.onResume()
        hideSystemUI()
        resetScreenSaverTimer()
        sensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER)?.also {
            sensorManager.registerListener(this, it, SensorManager.SENSOR_DELAY_UI)
        }
        sensorManager.getDefaultSensor(Sensor.TYPE_MAGNETIC_FIELD)?.also {
            sensorManager.registerListener(this, it, SensorManager.SENSOR_DELAY_UI)
        }
    }

    override fun onPause() {
        super.onPause()
        screenSaverHandler.removeCallbacks(screenSaverRunnable)
        sensorManager.unregisterListener(this)
    }

    override fun onUserInteraction() {
        super.onUserInteraction()
        resetScreenSaverTimer()
    }

    private fun loadSettings() {
        maxButtonsPerRow = prefs.getInt(KEY_MAX_BUTTONS, 0)
        screenSaverTimeout = prefs.getInt(KEY_SCREENSAVER_TIMEOUT, 0)
        originAngle = prefs.getFloat(KEY_ORIGIN_ANGLE, 270f)
        smbIp = prefs.getString(KEY_SMB_IP, "192.168.0.5") ?: "192.168.0.5"
        smbFolder = prefs.getString(KEY_SMB_FOLDER, "tempshare") ?: "tempshare"
        smbUser = prefs.getString(KEY_SMB_USER, "guest") ?: "guest"
        smbPass = prefs.getString(KEY_SMB_PASS, "") ?: ""
    }

    private fun hideSystemUI() {
        WindowCompat.setDecorFitsSystemWindows(window, false)
        val controller = WindowInsetsControllerCompat(window, binding.root)
        controller.hide(WindowInsetsCompat.Type.systemBars())
        controller.systemBarsBehavior = WindowInsetsControllerCompat.BEHAVIOR_SHOW_TRANSIENT_BARS_BY_SWIPE
    }

    private fun setupGestureDetector() {
        gestureDetector = GestureDetectorCompat(this, object : GestureDetector.SimpleOnGestureListener() {
            override fun onSingleTapConfirmed(e: MotionEvent): Boolean {
                tappedButton?.let { onPageButtonClick(it) }
                return true
            }
            override fun onDoubleTap(e: MotionEvent): Boolean {
                tappedButton?.let {
                    onPageButtonClick(it)
                    binding.pdfView.resetZoom()
                    Toast.makeText(this@MainActivity, "Zoom Reset", Toast.LENGTH_SHORT).show()
                }
                return true
            }
            override fun onLongPress(e: MotionEvent) {
                tappedButton?.let { onPageButtonLongClick(it) }
            }
        })
    }

    private fun setupEventListeners() {
        binding.btnOpenFile.setOnLongClickListener {
            lifecycleScope.launch(Dispatchers.IO) { showLineSelectionDialog() }
            true
        }
        binding.btnSetup.setOnLongClickListener {
            showSetupDialog()
            true
        }
        binding.compassView.setOnLongClickListener {
            isGeomagneticModeOn = !isGeomagneticModeOn
            val modeText = if (isGeomagneticModeOn) "On" else "Off"
            Toast.makeText(this, "Geomagnetic Mode: $modeText", Toast.LENGTH_SHORT).show()
            binding.compassView.setGeomagneticMode(isGeomagneticModeOn)
            if (!isGeomagneticModeOn) { currentDirection = Direction.OTHER }
            updateButtonsAndUI()
            true
        }
        binding.screenSaver.setOnClickListener {
            binding.screenSaver.visibility = View.GONE
            resetScreenSaverTimer()
        }
    }

    private fun showSetupDialog() {
        val setupOptions = arrayOf(
            "Max Buttons (1 Row)",
            "Screensaver Setting",
            "Geomagnetic Origin Setting",
            "Shared Folder Setting"
        )
        AlertDialog.Builder(this)
            .setTitle("Setup")
            .setItems(setupOptions) { _, which ->
                when (which) {
                    0 -> showMaxButtonsDialog()
                    1 -> showScreenSaverDialog()
                    2 -> showGeomagneticSetupDialog()
                    3 -> showSmbSetupDialog()
                }
            }
            .setNegativeButton("Close", null)
            .show()
    }

    private fun showMaxButtonsDialog() {
        val options = arrayOf("Unlimited (0)", "2 Buttons", "4 Buttons", "6 Buttons", "8 Buttons", "10 Buttons", "12 Buttons")
        val values = arrayOf(0, 2, 4, 6, 8, 10, 12)
        val currentSelection = values.indexOf(maxButtonsPerRow)
        AlertDialog.Builder(this)
            .setTitle("Max Buttons per Row (1 Row)")
            .setSingleChoiceItems(options, currentSelection) { dialog, which ->
                val selectedValue = values[which]
                maxButtonsPerRow = selectedValue
                prefs.edit().putInt(KEY_MAX_BUTTONS, selectedValue).apply()
                Toast.makeText(this, "Set to ${options[which]}", Toast.LENGTH_SHORT).show()
                updateButtonsAndUI()
                dialog.dismiss()
            }
            .show()
    }

    private fun showScreenSaverDialog() {
        val options = arrayOf("Disabled", "15 sec", "30 sec", "1 min", "5 min")
        val values = arrayOf(0, 15, 30, 60, 300)
        val currentSelection = values.indexOf(screenSaverTimeout)
        AlertDialog.Builder(this)
            .setTitle("Screen Saver on Inactivity")
            .setSingleChoiceItems(options, currentSelection) { dialog, which ->
                val selectedValue = values[which]
                screenSaverTimeout = selectedValue
                prefs.edit().putInt(KEY_SCREENSAVER_TIMEOUT, selectedValue).apply()
                Toast.makeText(this, "Screensaver set to ${options[which]}", Toast.LENGTH_SHORT).show()
                resetScreenSaverTimer()
                dialog.dismiss()
            }
            .show()
    }

    private fun showGeomagneticSetupDialog() {
        val dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_geomagnetic_setup, null)
        tvAngleDisplay = dialogView.findViewById(R.id.tvCurrentAngle)
        val btnSetOrigin = dialogView.findViewById<Button>(R.id.btnSetOrigin)
        val btnResetOrigin = dialogView.findViewById<Button>(R.id.btnResetOrigin)
        val dialog = AlertDialog.Builder(this)
            .setView(dialogView)
            .setOnDismissListener { tvAngleDisplay = null }
            .create()
        btnSetOrigin.setOnLongClickListener {
            val currentAngleText = tvAngleDisplay?.text.toString().replace("Â°", "")
            val currentAngle = currentAngleText.toFloatOrNull()
            if (currentAngle != null) {
                originAngle = currentAngle
                prefs.edit().putFloat(KEY_ORIGIN_ANGLE, originAngle).apply()
                Toast.makeText(this, "New Front Origin(${String.format("%.1f", originAngle)}Â°) has been set.", Toast.LENGTH_SHORT).show()
                dialog.dismiss()
            }
            true
        }
        btnResetOrigin.setOnClickListener {
            originAngle = 270f
            prefs.edit().putFloat(KEY_ORIGIN_ANGLE, originAngle).apply()
            Toast.makeText(this, "Origin has been reset to default(270Â°).", Toast.LENGTH_SHORT).show()
            dialog.dismiss()
        }
        dialog.show()
    }

    private fun showSmbSetupDialog() {
        val dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_smb_setup, null)
        val etIp: EditText = dialogView.findViewById(R.id.etSmbIp)
        val etFolder: EditText = dialogView.findViewById(R.id.etSmbFolder)
        val etUser: EditText = dialogView.findViewById(R.id.etSmbUser)
        val etPass: EditText = dialogView.findViewById(R.id.etSmbPass)
        etIp.setText(smbIp)
        etFolder.setText(smbFolder)
        etUser.setText(smbUser)
        etPass.setText(smbPass)
        AlertDialog.Builder(this)
            .setTitle("Shared Folder Setting")
            .setView(dialogView)
            .setPositiveButton("Save") { _, _ ->
                val newIp = etIp.text.toString()
                val newFolder = etFolder.text.toString()
                val newUser = etUser.text.toString()
                val newPass = etPass.text.toString()
                smbIp = newIp
                smbFolder = newFolder
                smbUser = newUser
                smbPass = newPass
                prefs.edit().apply {
                    putString(KEY_SMB_IP, newIp)
                    putString(KEY_SMB_FOLDER, newFolder)
                    putString(KEY_SMB_USER, newUser)
                    putString(KEY_SMB_PASS, newPass)
                    apply()
                }
                Toast.makeText(this, "Shared folder info has been saved.", Toast.LENGTH_SHORT).show()
            }
            .setNegativeButton("Cancel", null)
            .show()
    }

    private fun resetScreenSaverTimer() {
        screenSaverHandler.removeCallbacks(screenSaverRunnable)
        if (screenSaverTimeout > 0) {
            screenSaverHandler.postDelayed(screenSaverRunnable, screenSaverTimeout * 1000L)
        }
    }

    private fun loadLatestFileFromLastLine() {
        val lastLine = prefs.getString(KEY_LAST_LINE, null)
        if (lastLine.isNullOrEmpty()) {
            Toast.makeText(this, "Please select a Line.", Toast.LENGTH_SHORT).show()
            return
        }
        Toast.makeText(this, "Loading the latest file from '$lastLine'...", Toast.LENGTH_SHORT).show()
        lifecycleScope.launch(Dispatchers.IO) {
            try {
                val allFiles = listSmbFiles()
                val normalizedLine = lastLine.removePrefix("0")
                val latestFile = allFiles
                    .filter { it.name.startsWith("${lastLine}_") || it.name.startsWith("${normalizedLine}_") }
                    .maxByOrNull { it.lastModified() }
                if (latestFile != null) {
                    loadPdfFromSmbFile(latestFile)
                } else {
                    withContext(Dispatchers.Main) {
                        Toast.makeText(this@MainActivity, "No files found in '$lastLine'.", Toast.LENGTH_SHORT).show()
                    }
                }
            } catch (e: Exception) {
                Log.e("SmbTask", "Auto load failed", e)
                withContext(Dispatchers.Main) {
                    Toast.makeText(this@MainActivity, "Auto load failed: ${e.message}", Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    private suspend fun showLineSelectionDialog() {
        try {
            val allFiles = listSmbFiles()
            val lineNames = allFiles
                .mapNotNull { it.name.split('_').firstOrNull() }
                .map { line ->
                    val regex = "(\\d+)(.*)".toRegex()
                    val matchResult = regex.find(line)
                    if (matchResult != null) {
                        val (number, text) = matchResult.destructured
                        String.format("%02d%s", number.toInt(), text)
                    } else {
                        line
                    }
                }
                .distinct()
                .sorted()
            if (lineNames.isEmpty()) {
                withContext(Dispatchers.Main) { Toast.makeText(this@MainActivity, "No PDF files found.", Toast.LENGTH_SHORT).show() }
                return
            }
            withContext(Dispatchers.Main) {
                AlertDialog.Builder(this@MainActivity)
                    .setTitle("Select Line")
                    .setItems(lineNames.toTypedArray()) { _, which ->
                        val selectedLine = lineNames[which]
                        prefs.edit().putString(KEY_LAST_LINE, selectedLine).apply()
                        lifecycleScope.launch(Dispatchers.IO) {
                            showReelListDialog(selectedLine, allFiles)
                        }
                    }
                    .show()
            }
        } catch (e: Exception) {
            Log.e("SmbTask", "Failed to list lines", e)
            withContext(Dispatchers.Main) {
                Toast.makeText(this@MainActivity, "Failed to list lines: ${e.message}", Toast.LENGTH_LONG).show()
            }
        }
    }

    private suspend fun showReelListDialog(selectedLine: String, allFiles: List<SmbFile>) {
        val normalizedLine = selectedLine.removePrefix("0")
        val filesInLine = allFiles
            .filter { it.name.startsWith("${selectedLine}_") || it.name.startsWith("${normalizedLine}_") }
            .sortedByDescending { it.lastModified() }
        if (filesInLine.isEmpty()) {
            withContext(Dispatchers.Main) { Toast.makeText(this@MainActivity, "No files in the selected line.", Toast.LENGTH_SHORT).show() }
            return
        }
        val displayNames = filesInLine.map {
            it.name.removePrefix("${selectedLine}_").removePrefix("${normalizedLine}_").removeSuffix(".pdf")
        }
        withContext(Dispatchers.Main) {
            val adapter = ArrayAdapter<SpannableString>(this@MainActivity, android.R.layout.simple_list_item_1)
            displayNames.forEachIndexed { index, name ->
                val spannable = SpannableString(name)
                if (index == 0) {
                    spannable.setSpan(ForegroundColorSpan(ContextCompat.getColor(this@MainActivity, android.R.color.holo_blue_dark)), 0, name.length, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE)
                }
                adapter.add(spannable)
            }
            AlertDialog.Builder(this@MainActivity)
                .setTitle("Select ReelList ($selectedLine)")
                .setAdapter(adapter) { _, which ->
                    val selectedFile = filesInLine[which]
                    lifecycleScope.launch(Dispatchers.IO) {
                        loadPdfFromSmbFile(selectedFile)
                    }
                }
                .show()
        }
    }

    private suspend fun listSmbFiles(): List<SmbFile> {
        val smbUrl = "smb://$smbIp/$smbFolder/"
        val properties = Properties().apply {
            put("jcifs.smb.client.minVersion", "SMB300")
            put("jcifs.smb.client.maxVersion", "SMB311")
        }
        val config = PropertyConfiguration(properties)
        val cifsContext: CIFSContext = BaseContext(config)
        val auth = NtlmPasswordAuthenticator(null, smbUser, smbPass)
        val context = cifsContext.withCredentials(auth)
        val dir = SmbFile(smbUrl, context)
        return dir.listFiles { f -> f.name.endsWith(".pdf", ignoreCase = true) }.toList()
    }

    override fun loadComplete(nbPages: Int) {
        totalPdfPages = nbPages
        skippedButtons.clear()
        selectedButton = null
        binding.pageButtonContainer.visibility = View.VISIBLE
        isGeomagneticModeOn = false
        binding.compassView.setGeomagneticMode(false)
        updateButtonsAndUI()
    }

    private fun updateButtonsAndUI() {
        var requiredLogicalButtons = 0; var physicalPageCounter = 0; var logicalButtonCounter = 0
        while(physicalPageCounter < totalPdfPages){ logicalButtonCounter++; if(!skippedButtons.contains(logicalButtonCounter)){ physicalPageCounter++ } }; requiredLogicalButtons = logicalButtonCounter
        var buttonCountAfterEven = if (requiredLogicalButtons % 2 != 0) requiredLogicalButtons + 1 else requiredLogicalButtons
        if (totalPdfPages > 0 && buttonCountAfterEven == 0) buttonCountAfterEven = 2
        val cappedButtonCount = if (maxButtonsPerRow > 0) {
            minOf(buttonCountAfterEven, maxButtonsPerRow * 2)
        } else {
            buttonCountAfterEven
        }
        regenerateButtons(cappedButtonCount)
        updateAllButtonStyles()
    }

    private fun regenerateButtons(count: Int) {
        binding.topButtonRow.removeAllViews()
        binding.bottomButtonRow.removeAllViews()
        currentButtons.clear()
        val buttonHeight = dpToPx(44)
        val margin = dpToPx(2)
        val buttonParams = LinearLayout.LayoutParams(0, buttonHeight, 1.0f)
        buttonParams.setMargins(margin)
        binding.ivTopRowArrow.visibility = if (isGeomagneticModeOn) View.VISIBLE else View.GONE
        when(currentDirection) {
            Direction.WEST -> binding.ivTopRowArrow.setImageResource(R.drawable.ic_long_arrow_right)
            Direction.EAST -> binding.ivTopRowArrow.setImageResource(R.drawable.ic_long_arrow_left)
            Direction.OTHER -> binding.ivTopRowArrow.visibility = View.GONE
        }
        val (oddRowContainer, evenRowContainer) = when {
            isGeomagneticModeOn && currentDirection == Direction.WEST -> binding.bottomButtonRow to binding.topButtonRow
            isGeomagneticModeOn && currentDirection == Direction.EAST -> binding.topButtonRow to binding.bottomButtonRow
            else -> binding.topButtonRow to binding.bottomButtonRow
        }
        val isRtl = isGeomagneticModeOn && currentDirection == Direction.EAST
        for (i in 1..count) {
            val button = createPageButton(i, buttonParams.also { it.height = buttonHeight })
            if (i % 2 != 0) {
                if (isRtl) oddRowContainer.addView(button, 0) else oddRowContainer.addView(button)
            } else {
                if (isRtl) evenRowContainer.addView(button, 0) else evenRowContainer.addView(button)
            }
            currentButtons.add(button)
        }
    }

    private fun createPageButton(number: Int, layoutParams: LinearLayout.LayoutParams? = null): Button {
        return Button(this).apply {
            text = number.toString(); tag = number
            layoutParams?.let { this.layoutParams = it }
            textSize = 20f; typeface = Typeface.DEFAULT_BOLD
            setOnTouchListener { view, event ->
                tappedButton = view as Button
                gestureDetector.onTouchEvent(event)
                true
            }
        }
    }

    private fun updateAllButtonStyles() {
        if (isGeomagneticModeOn) {
            for (button in currentButtons) {
                val buttonNumber = button.tag as Int
                val isActiveRow = (currentDirection == Direction.WEST && buttonNumber % 2 != 0) || (currentDirection == Direction.EAST && buttonNumber % 2 == 0)
                when {
                    button == selectedButton -> {
                        button.setBackgroundResource(R.drawable.button_bg_geo_selected)
                        button.setTextColor(ContextCompat.getColor(this, android.R.color.white))
                    }
                    skippedButtons.contains(buttonNumber) -> {
                        button.setBackgroundResource(R.drawable.button_bg_page_skipped_dark)
                        button.setTextColor(ContextCompat.getColor(this, android.R.color.darker_gray))
                    }
                    isActiveRow && mapLogicalToPhysical(buttonNumber) in 1..totalPdfPages -> {
                        button.setBackgroundResource(R.drawable.button_bg_geo_active)
                        button.setTextColor(ContextCompat.getColor(this, android.R.color.black))
                    }
                    else -> {
                        button.setBackgroundResource(R.drawable.button_bg_page_normal)
                        button.setTextColor(ContextCompat.getColor(this, android.R.color.black))
                    }
                }
            }
        } else {
            for (button in currentButtons) {
                val buttonNumber = button.tag as Int
                if (button == selectedButton) {
                    button.setBackgroundResource(R.drawable.button_bg_page_selected)
                    button.setTextColor(ContextCompat.getColor(this, android.R.color.black))
                    continue
                }
                when {
                    skippedButtons.contains(buttonNumber) -> {
                        button.setBackgroundResource(R.drawable.button_bg_page_skipped_dark)
                        button.setTextColor(ContextCompat.getColor(this, android.R.color.darker_gray))
                    }
                    else -> {
                        val physicalPage = mapLogicalToPhysical(buttonNumber)
                        if (physicalPage in 1..totalPdfPages) {
                            button.setBackgroundResource(R.drawable.button_bg_page_normal)
                            button.setTextColor(ContextCompat.getColor(this, android.R.color.black))
                        } else {
                            button.setBackgroundResource(R.drawable.button_border_invalid)
                            button.setTextColor(ContextCompat.getColor(this, android.R.color.darker_gray))
                        }
                    }
                }
            }
        }
    }

    private fun mapLogicalToPhysical(logicalButtonNum: Int): Int {
        val skipsBefore = skippedButtons.count { it < logicalButtonNum }
        return logicalButtonNum - skipsBefore
    }

    private fun onPageButtonClick(button: Button) {
        val buttonNumber = button.tag as Int
        if (skippedButtons.contains(buttonNumber)) {
            Toast.makeText(this, "$buttonNumber page is skipped.", Toast.LENGTH_SHORT).show()
            return
        }
        val physicalPage = mapLogicalToPhysical(buttonNumber)
        if (physicalPage in 1..totalPdfPages) {
            binding.pdfView.jumpTo(physicalPage - 1, false)
            selectedButton = button
            updateAllButtonStyles()
        } else {
            Toast.makeText(this, "This is an empty page.", Toast.LENGTH_SHORT).show()
        }
    }

    private fun onPageButtonLongClick(view: View) {
        val button = view as Button; val buttonNumber = button.tag as Int
        if (skippedButtons.contains(buttonNumber)) {
            skippedButtons.remove(buttonNumber)
            Toast.makeText(this, "$buttonNumber page un-skipped.", Toast.LENGTH_SHORT).show()
        } else {
            skippedButtons.add(buttonNumber)
            Toast.makeText(this, "$buttonNumber page skipped.", Toast.LENGTH_SHORT).show()
            if (selectedButton == button) { selectedButton = null }
        }
        updateButtonsAndUI()
    }

    override fun onAccuracyChanged(sensor: Sensor?, accuracy: Int) {}

    override fun onSensorChanged(event: SensorEvent) {
        if (event.sensor.type == Sensor.TYPE_ACCELEROMETER) {
            System.arraycopy(event.values, 0, accelerometerReading, 0, accelerometerReading.size)
        } else if (event.sensor.type == Sensor.TYPE_MAGNETIC_FIELD) {
            System.arraycopy(event.values, 0, magnetometerReading, 0, magnetometerReading.size)
        }
        SensorManager.getRotationMatrix(rotationMatrix, null, accelerometerReading, magnetometerReading)
        SensorManager.getOrientation(rotationMatrix, orientationAngles)
        val azimuthInDegrees = Math.toDegrees(orientationAngles[0].toDouble()).toFloat()
        val normalizedAzimuth = (azimuthInDegrees + 360) % 360
        binding.compassView.updateBearing(normalizedAzimuth)
        tvAngleDisplay?.text = "${String.format("%.1f", normalizedAzimuth)}Â°"
        if (isGeomagneticModeOn) {
            var newDirection = currentDirection
            val tolerance = 2.0f
            val frontCenter = originAngle
            val rearCenter = (originAngle + 180f) % 360f
            fun angleDifference(angle1: Float, angle2: Float): Float {
                val diff = abs(angle1 - angle2)
                return minOf(diff, 360 - diff)
            }
            if (angleDifference(normalizedAzimuth, frontCenter) <= tolerance) {
                newDirection = Direction.WEST
            } else if (angleDifference(normalizedAzimuth, rearCenter) <= tolerance) {
                newDirection = Direction.EAST
            }
            if (newDirection != currentDirection) {
                currentDirection = newDirection
                updateButtonsAndUI()
            }
        }
    }

    private fun dpToPx(dp: Int): Int {
        return (dp * resources.displayMetrics.density).toInt()
    }

    private suspend fun loadPdfFromSmbFile(originalSmbFile: SmbFile) {
        withContext(Dispatchers.Main) {
            binding.btnOpenFile.isEnabled = false; binding.btnOpenFile.text = "Loading..."
        }
        try {
            // ğŸ’¡ ìµœì‹  ì ‘ì† ì •ë³´ë¡œ SmbFile ê°ì²´ë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜ ë²„ê·¸ í•´ê²°
            val smbUrl = "smb://$smbIp/$smbFolder/${originalSmbFile.name}"
            val properties = Properties().apply {
                put("jcifs.smb.client.minVersion", "SMB300")
                put("jcifs.smb.client.maxVersion", "SMB311")
            }
            val config = PropertyConfiguration(properties)
            val cifsContext: CIFSContext = BaseContext(config)
            val auth = NtlmPasswordAuthenticator(null, smbUser, smbPass)
            val context = cifsContext.withCredentials(auth)
            val smbFile = SmbFile(smbUrl, context)

            val tempPdfFile = File(cacheDir, smbFile.name)
            smbFile.inputStream.use { input -> FileOutputStream(tempPdfFile).use { output -> input.copyTo(output) } }
            withContext(Dispatchers.Main) {
                binding.tvFileName.text = smbFile.name.substringBeforeLast(".")
                binding.pdfView.fromFile(tempPdfFile).onLoad(this@MainActivity).onPageError(this@MainActivity).load()
            }
        } catch (e: Exception) {
            Log.e("SmbTask", "File download failed", e)
            withContext(Dispatchers.Main) {
                Toast.makeText(this@MainActivity, "File download failed: ${e.message}", Toast.LENGTH_LONG).show()
            }
        } finally {
            withContext(Dispatchers.Main) {
                binding.btnOpenFile.isEnabled = true; binding.btnOpenFile.text = "Open"
            }
        }
    }

    override fun onPageError(page:Int,t:Throwable){Log.e("PDFView","Page load error",t);Toast.makeText(this,"Error on page ${page+1}",Toast.LENGTH_SHORT).show()}
}
