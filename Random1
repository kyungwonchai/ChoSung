것은 일반적으로 네트워크와 시간 관련 작업을 조합하는 경우입니다. NTP(Network Time Protocol) 서버는 정확한 시간을 제공하여 시스템 시간을 정확하게 유지하는 데 사용됩니다.

아래는 C#을 사용하여 NTP 서버에서 시간을 가져오고 로컬 시스템 시간을 업데이트하는 간단한 예제 코드입니다. 이 코드는 NTP 서버에 요청을 보내고 응답을 받아 시스템 시간을 설정하는 기능을 담고 있습니다.

csharp
코드 복사
using System;
using System.Net;
using System.Net.Sockets;

public class NtpClient
{
    public static DateTime GetNetworkTime(string ntpServer)
    {
        var ntpData = new byte[48];
        ntpData[0] = 0x1B; // NTP Request Indicator

        var addresses = Dns.GetHostEntry(ntpServer).AddressList;
        var ipEndPoint = new IPEndPoint(addresses[0], 123); // NTP uses port 123
        using (var socket = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp))
        {
            socket.Connect(ipEndPoint);
            socket.Send(ntpData);
            socket.Receive(ntpData);
            socket.Close();
        }

        ulong intPart = BitConverter.ToUInt32(ntpData, 43);
        ulong fractPart = BitConverter.ToUInt32(ntpData, 47);
        
        intPart = SwapEndianness(intPart);
        fractPart = SwapEndianness(fractPart);
        
        var milliseconds = (intPart * 1000) + ((fractPart * 1000) / 0x100000000L);
        
        // NTP timestamp is seconds since 1900; Unix timestamp is seconds since 1970
        var networkDateTime = (new DateTime(1900, 1, 1)).AddMilliseconds((long)milliseconds);
        return networkDateTime.AddHours(9); // Adjust time zone if necessary (example: +9 for KST)
    }

    static uint SwapEndianness(ulong x)
    {
        return (uint) (((x & 0x000000ff) << 24) +
                       ((x & 0x0000ff00) << 8) +
                       ((x & 0x00ff0000) >> 8) +
                       ((x & 0xff000000) >> 24));
    }
}

class Program
{
    static void Main()
    {
        DateTime networkTime = NtpClient.GetNetworkTime("time.windows.com"); // Use an NTP server
        Console.WriteLine("Current Network Time: " + networkTime.ToString());
        
        // To set local machine time, you need administrative privileges
    }
}
코드 설명
NTP 요청 보내기: NtpClient 클래스는 NTP 서버에 UDP 요청을 보내어 시간 정보를 요청합니다.
시간 계산: 서버로부터 받은 타임스탬프를 사용하여 현재 날짜와 시간을 계산합니다. 타임스탬프는 1900년부터의 초로 표현되어 있으며, 이를 1970년부터의 초로 변환하여 DateTime 객체를 생성합니다.
시간대 조정: 코드에서는 예를 들어 한국 표준시간(KST)을 위해 9시간을 추가합니다.
