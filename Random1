아래는 모든 단계에 아주 상세한 주석을 추가한 전체 SQL 쿼리야.
이 쿼리는 MSSQL 2014 기준이고, 네가 요청한 요구사항에 맞춰서 model1 기준으로

ACT2_1~8 그룹의 이상치 제외 후 최댓값과 해당 컬럼명

ACT2BEST_1~8 그룹의 이상치 제외 후 최댓값과 해당 컬럼명

을 구해주는 쿼리야. 꼼꼼하게 주석 달아놨으니 검토하기 쉬울 거야.

sql
코드 복사
-- 1. 라인명 'SMD_12'이고, 날짜가 2025-03-28인 데이터에서 사용된 모델만 추출
WITH LastestModels AS (
    SELECT DISTINCT model1
    FROM dbo.ExcelData
    WHERE line1 = 'SMD_12'
      AND CAST(time1 AS DATE) = '2025-03-28'
),

-- 2. 최근 5시간 이내 데이터 중 위 모델들에 해당하는 데이터만 필터링
ExcelFiltered AS (
    SELECT
        -- 필요한 컬럼만 명시적으로 선택 (중복 에러 방지)
        E.time1,
        E.model1,
        E.line1,
        E.ACT2_1, E.ACT2_2, E.ACT2_3, E.ACT2_4,
        E.ACT2_5, E.ACT2_6, E.ACT2_7, E.ACT2_8,
        E.ACT2BEST_1, E.ACT2BEST_2, E.ACT2BEST_3, E.ACT2BEST_4,
        E.ACT2BEST_5, E.ACT2BEST_6, E.ACT2BEST_7, E.ACT2BEST_8
    FROM dbo.ExcelData E
    INNER JOIN LastestModels L ON E.model1 = L.model1
    WHERE E.time1 >= DATEADD(HOUR, -5, GETDATE())
),

-- 3. 16개 컬럼(ACT2_1~8, ACT2BEST_1~8)을 행으로 변환 (UNPIVOT)
--    행마다 (model1, ColName, Value) 구조가 됨
Unpivoted AS (
    SELECT
        model1,
        ColName,
        Value
    FROM ExcelFiltered
    UNPIVOT (
        Value FOR ColName IN (
            ACT2_1, ACT2_2, ACT2_3, ACT2_4, ACT2_5, ACT2_6, ACT2_7, ACT2_8,
            ACT2BEST_1, ACT2BEST_2, ACT2BEST_3, ACT2BEST_4,
            ACT2BEST_5, ACT2BEST_6, ACT2BEST_7, ACT2BEST_8
        )
    ) AS Unpvt
    -- 0보다 큰 값만 대상으로 함
    WHERE Value > 0
),

-- 4. 분위수 계산 (1사분위수 Q1, 3사분위수 Q3)
--    model1 + ColName 그룹별로 계산됨
WithQuantiles AS (
    SELECT
        model1,
        ColName,
        Value,
        -- 25% 위치 값 (Q1)
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q1,
        -- 75% 위치 값 (Q3)
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY Value) OVER (PARTITION BY model1, ColName) AS Q3
    FROM Unpivoted
),

-- 5. 이상치 제거 (Q1 ~ Q3 사이 값만 유지)
FilteredByIQR AS (
    SELECT model1, ColName, Value
    FROM WithQuantiles
    WHERE Value BETWEEN Q1 AND Q3
),

-- 6. 각 model1 + ColName 조합에서 이상치 제외 후 최솟값 계산
MinByCol AS (
    SELECT
        model1,
        ColName,
        MIN(Value) AS MinValueWithoutOutliers
    FROM FilteredByIQR
    GROUP BY model1, ColName
),

-- 7. model1별로 그룹을 나눠서 ACT2, ACT2BEST 각각에서 최댓값 찾기 위한 순위 부여
--    RN_ACT2, RN_ACT2BEST = 1 인 항목이 최댓값 보유 컬럼임
RankedMax AS (
    SELECT *,
           -- ACT2 그룹에서 최댓값에 해당하는 순번 (내림차순)
           ROW_NUMBER() OVER (
               PARTITION BY model1 
               ORDER BY 
                   CASE WHEN ColName LIKE 'ACT2_%' THEN MinValueWithoutOutliers ELSE NULL END DESC
           ) AS RN_ACT2,

           -- ACT2BEST 그룹에서 최댓값에 해당하는 순번
           ROW_NUMBER() OVER (
               PARTITION BY model1 
               ORDER BY 
                   CASE WHEN ColName LIKE 'ACT2BEST_%' THEN MinValueWithoutOutliers ELSE NULL END DESC
           ) AS RN_ACT2BEST
    FROM MinByCol
),

-- 8. 순위가 1인 컬럼만 뽑아서 컬럼명과 최댓값 함께 선택
FinalGrouped AS (
    SELECT 
        model1,

        -- ACT2 최댓값의 컬럼명
        MAX(CASE 
                WHEN RN_ACT2 = 1 AND ColName LIKE 'ACT2_%' THEN ColName 
            END) AS MaxCol_ACT2,

        -- ACT2 최댓값
        MAX(CASE 
                WHEN RN_ACT2 = 1 AND ColName LIKE 'ACT2_%' THEN MinValueWithoutOutliers 
            END) AS MaxVal_ACT2,

        -- ACT2BEST 최댓값의 컬럼명
        MAX(CASE 
                WHEN RN_ACT2BEST = 1 AND ColName LIKE 'ACT2BEST_%' THEN ColName 
            END) AS MaxCol_ACT2BEST,

        -- ACT2BEST 최댓값
        MAX(CASE 
                WHEN RN_ACT2BEST = 1 AND ColName LIKE 'ACT2BEST_%' THEN MinValueWithoutOutliers 
            END) AS MaxVal_ACT2BEST

    FROM RankedMax
    GROUP BY model1
)

-- 9. 최종 결과 출력
SELECT *
FROM FinalGrouped
ORDER BY model1;
최종 결과 예시
model1	MaxCol_ACT2	MaxVal_ACT2	MaxCol_ACT2BEST	MaxVal_ACT2BEST
A100	ACT2_5	0.58	ACT2BEST_2	0.51
B200	ACT2_4	0.63	ACT2BEST_3	0.55
필요하다면:

평균값/중앙값도 추가할 수 있고,

ACT3 같이 다른 그룹도 확장 가능하고,

라인명, 날짜 같이도 붙일 수 있어.