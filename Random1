using DevExpress.XtraPivotGrid;

// PivotGridControl 생성
PivotGridControl pivotGrid = new PivotGridControl();

// PivotGrid 설정
pivotGrid.BeginUpdate();
pivotGrid.DataSource = table_rpa_runlog; // 테이블 조회 결과를 바인딩

PivotGridField fieldDate = new PivotGridField();
fieldDate.FieldName = "rpastart"; // 날짜 필드
fieldDate.Caption = "날짜";
fieldDate.Area = PivotArea.RowArea;
fieldDate.GroupInterval = PivotGroupInterval.Date; // 날짜별 그룹화
pivotGrid.Fields.Add(fieldDate);

PivotGridField fieldTotalCount = new PivotGridField();
fieldTotalCount.FieldName = "mailok"; // 총 횟수 필드
fieldTotalCount.Caption = "총 횟수";
fieldTotalCount.Area = PivotArea.DataArea;
fieldTotalCount.SummaryType = PivotSummaryType.Count;
pivotGrid.Fields.Add(fieldTotalCount);

PivotGridField fieldSuccessCount = new PivotGridField();
fieldSuccessCount.FieldName = "mailok"; // 성공 횟수 필드
fieldSuccessCount.Caption = "성공 횟수";
fieldSuccessCount.Area = PivotArea.DataArea;
fieldSuccessCount.SummaryType = PivotSummaryType.Count;
fieldSuccessCount.FilterValues.Add(true); // 성공인 경우 필터링
pivotGrid.Fields.Add(fieldSuccessCount);

PivotGridField fieldSuccessRate = new PivotGridField();
fieldSuccessRate.Caption = "성공율";
fieldSuccessRate.Area = PivotArea.DataArea;
fieldSuccessRate.SummaryType = PivotSummaryType.Custom; // 사용자 정의 집계
fieldSuccessRate.CustomTotalSummary += (sender, e) =>
{
    if (e.DataField == fieldSuccessRate)
    {
        int totalCount = 0;
        int successCount = 0;
        for (int i = 0; i < e.RowFieldValues.Length; i++)
        {
            PivotFieldValueEventArgs rowField = e.RowFieldValues[i];
            PivotFieldValueEventArgs colField = e.ColumnFieldValues[i];
            if (rowField.Value != null && colField.Value != null)
            {
                totalCount += Convert.ToInt32(pivotGrid.GetCellValue(e.DataField, rowField, colField, null));
                successCount += Convert.ToInt32(pivotGrid.GetCellValue(fieldSuccessCount, rowField, colField, null));
            }
        }
        if (totalCount > 0)
        {
            e.CustomValue = (double)successCount / totalCount; // 성공율 계산
        }
    }
};
pivotGrid.Fields.Add(fieldSuccessRate);

pivotGrid.EndUpdate();
