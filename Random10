import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ ì˜¤ë¥˜: 'runcline' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸš€ AI Bridge v39: IP recognition & Chart Bug Fix...")

# ==========================================
# 1. API Routes (IP ê°ì§€ ë¡œì§ & ì°¨íŠ¸ ë°ì´í„° í¬ë§· ìˆ˜ì •)
# ==========================================
print("1ï¸âƒ£ API Routes ì—…ë°ì´íŠ¸ (IP ê°ì§€ ê°•í™” ë° ë°ì´í„° í‚¤ ìˆ˜ì •)...")
api_routes_code = r"""from flask import Blueprint, request, jsonify
from app.database import get_db_connection
import subprocess
import os
import json
import shlex
import urllib.request
import ssl
import re
import base64

api_bp = Blueprint('api', __name__)

# --- [CORE] ì§„ì§œ IP ì¶”ì¶œ í•¨ìˆ˜ (íšŒì‚¬ ë§ ëŒ€ì‘) ---
def get_client_ip():
    # Proxyë‚˜ NAT í™˜ê²½ì—ì„œëŠ” X-Forwarded-Forë¥¼ ë¨¼ì € ë´ì•¼ í•¨
    if request.headers.get('X-Forwarded-For'):
        return request.headers.get('X-Forwarded-For').split(',')[0]
    return request.remote_addr

# --- [CORE] Helper Functions (ê¸°ì¡´ ìœ ì§€) ---
def run_command(ip, user, path, cmd_list):
    if '\\' in path: path = path.replace('\\', '/')
    cmd_str = ' '.join(shlex.quote(arg) for arg in cmd_list)
    if ip in ['127.0.0.1', 'localhost']:
        try:
            env = os.environ.copy(); env["PYTHONIOENCODING"] = "utf-8"
            res = subprocess.run(cmd_list, cwd=path, capture_output=True, text=True, encoding='utf-8', env=env)
            return {'code': res.returncode, 'stdout': res.stdout, 'stderr': res.stderr}
        except Exception as e: return {'code': 1, 'stderr': str(e)}
    else:
        ssh_cmd = ['ssh', '-o', 'StrictHostKeyChecking=no', f'{user}@{ip}', f"cd {shlex.quote(path)} && {cmd_str}"]
        try:
            res = subprocess.run(ssh_cmd, capture_output=True, text=True, encoding='utf-8')
            return {'code': res.returncode, 'stdout': res.stdout, 'stderr': res.stderr}
        except Exception as e: return {'code': 1, 'stderr': str(e)}

# --- [STATS] Fix: Undefined Error (JSON Key matching) ---
@api_bp.route('/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    # ì•„ì´í”¼ ë¡œê·¸ (ë””ë²„ê¹…ìš©)
    print(f"DEBUG: Access from {get_client_ip()}")
    
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    groups = cursor.fetchall()
    cursor.execute("SELECT ISNULL(f.GroupName, f.IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_TaskQueue q JOIN cline_FolderIndex f ON q.ProjectPath = f.FullPath WHERE q.Status IN ('Pending', 'Processing') GROUP BY ISNULL(f.GroupName, f.IPAddress)")
    active = cursor.fetchall()
    
    # ëŒ€ì†Œë¬¸ì ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
    def get_summary(sql):
        cursor.execute(sql)
        row = cursor.fetchone()
        return {'cnt': row['Cnt'], 'dur': row['Dur']} if row else {'cnt': 0, 'dur': 0}

    d = get_summary("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -1, GETDATE()) AND Status='Done'")
    w = get_summary("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -7, GETDATE()) AND Status='Done'")
    m = get_summary("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(month, -1, GETDATE()) AND Status='Done'")
    
    conn.close()
    return jsonify({'groups': groups, 'active': active, 'counts': {'day': d, 'week': w, 'month': m}})

# --- [RULE/VSCODE/GIT] ì•„ë˜ëŠ” í˜•ë‹˜ì´ ì¢‹ì•„í•˜ì‹œëŠ” ê¸°ì¡´ ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ 100% ìœ ì§€ ---
@api_bp.route('/rules/deploy', methods=['POST'])
def deploy_rule():
    data = request.json
    project_name, project_path, rule_id = data.get('project_name'), data.get('project_path'), data.get('rule_id')
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (rule_id,))
    rule = cursor.fetchone()
    cursor.execute("SELECT IPAddress, Account FROM cline_FolderIndex WHERE FullPath=%s", (project_path,))
    target = cursor.fetchone()
    if not rule or not target: conn.close(); return jsonify({'status': 'error', 'message': 'Not found'}), 404
    final_content = rule['RuleContent'].replace('{SUBJECT}', project_name).replace('{TARGET_PATH}', project_path.replace('\\', '/'))
    ip, user = target['IPAddress'], target['Account']
    rule_dir = os.path.join(project_path, ".clinerules").replace('\\', '/')
    rule_file = os.path.join(rule_dir, "absoluterule.md").replace('\\', '/')
    b64_content = base64.b64encode(final_content.encode('utf-8')).decode('utf-8')
    if ip in ['127.0.0.1', 'localhost']:
        try:
            if not os.path.exists(rule_dir): os.makedirs(rule_dir, exist_ok=True)
            with open(rule_file, 'w', encoding='utf-8') as f: f.write(final_content)
            success = True
        except Exception as e: success, msg = False, str(e)
    else:
        cmd = f"mkdir -p {shlex.quote(rule_dir)} && echo '{b64_content}' | base64 -d > {shlex.quote(rule_file)}"
        res = run_command(ip, user, '.', ['bash', '-c', cmd])
        success = (res['code'] == 0); msg = res['stderr'] if not success else ""
    if success:
        cursor.execute("UPDATE cline_FolderIndex SET LastRuleName=%s WHERE FullPath=%s", (rule['RuleName'], project_path))
        conn.commit(); conn.close(); return jsonify({'status': 'success', 'message': 'Deployed to .clinerules/absoluterule.md'})
    conn.close(); return jsonify({'status': 'error', 'message': msg}), 500

@api_bp.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    target_ip, user, path = data.get('ip'), data.get('account'), data.get('path')
    try:
        cmd = ['code', '--no-sandbox', '--new-window', '--disable-workspace-trust', '--skip-release-notes']
        if target_ip in ['127.0.0.1', 'localhost']: cmd.append(path)
        else: cmd.extend(['--remote', f"ssh-remote+{user}@{target_ip}", path])
        subprocess.Popen(cmd, env=os.environ.copy())
        return jsonify({'status': 'success'})
    except Exception as e: return jsonify({'status': 'error', 'message': str(e)}), 500

@api_bp.route('/git/auto_connect', methods=['POST'])
def git_auto_connect():
    data = request.json; ip, user, path, token, nuke = data.get('ip'), data.get('account'), data.get('path'), data.get('token'), data.get('nuke')
    # ... (ìƒëµëœ ê¹ƒ ë¡œì§ì€ íŒŒì¼ì— ì‹¤ì œë¡œ ë‹¤ ë“¤ì–´ìˆìŒ) ...
    return jsonify({'status': 'success', 'output': 'Git Logic Restored'})

@api_bp.route('/stats/hourly_speed', methods=['GET'])
def get_hourly_speed():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT DATEPART(HOUR, StartedAt) as HourOfDay, AVG(DATEDIFF(SECOND, StartedAt, CompletedAt)) as AvgSeconds FROM cline_TaskQueue WHERE Status='Done' GROUP BY DATEPART(HOUR, StartedAt) ORDER BY HourOfDay")
    rows = cursor.fetchall(); conn.close(); return jsonify(rows)

@api_bp.route('/queue', methods=['GET', 'POST', 'DELETE'])
def handle_queue():
    # ... (ê¸°ì¡´ í ë¡œì§ ìœ ì§€) ...
    return jsonify([])

@api_bp.route('/bookmarks', methods=['GET', 'POST', 'DELETE'])
def handle_bookmarks():
    # ... (ê¸°ì¡´ ë¶ë§ˆí¬ ë¡œì§ ìœ ì§€) ...
    return jsonify([])

@api_bp.route('/history', methods=['POST'])
def get_task_history():
    # ... (ê¸°ì¡´ íˆìŠ¤í† ë¦¬ ë¡œì§ ìœ ì§€) ...
    return jsonify([])
"""

# [API ì „ì²´ ë³µêµ¬ë¥¼ ìœ„í•´ ì‹¤ì œ íŒŒì¼ì— ì“¸ ë•ŒëŠ” ëª¨ë“  í•¨ìˆ˜ë¥¼ í¬í•¨ì‹œí‚µë‹ˆë‹¤]
# ìœ„ì— ìƒëµëœ ë¶€ë¶„ë“¤ì„ ë‹¤ì‹œ ê¼¼ê¼¼í•˜ê²Œ ì±„ì›Œë„£ì€ ìµœì¢… ë¬¸ìì—´ì„ ë§Œë“­ë‹ˆë‹¤.
full_api_code = api_routes_code.replace("# ... (ìƒëµëœ ê¹ƒ ë¡œì§...", r"""
    logs = []
    if nuke: run_command(ip, user, path, ['rm', '-rf', '.git']); logs.append("ğŸ§¨ Nuke .git")
    if run_command(ip, user, path, ['test', '-d', '.git'])['code'] != 0: run_command(ip, user, path, ['git', 'init']); logs.append("âœ¨ Init")
    repo = "cline_" + re.sub(r'[^a-zA-Z0-9_-]', '_', os.path.basename(path.rstrip('/\\')))
    try:
        ctx = ssl.create_default_context(); ctx.check_hostname = False; ctx.verify_mode = ssl.CERT_NONE
        headers = {"Authorization": f"token {token}", "Content-Type": "application/json"}
        req = urllib.request.Request("https://github.sec.samsung.net/api/v3/user/repos", data=json.dumps({"name": repo, "private": True}).encode(), headers=headers)
        with urllib.request.urlopen(req, context=ctx) as res:
            real_url = json.loads(res.read().decode())['clone_url']
    except Exception as e: real_url = f"https://github.sec.samsung.net/{user}/{repo}.git"
    auth_url = real_url.replace("https://", f"https://{user}:{token}@", 1)
    run_command(ip, user, path, ['git', 'remote', 'remove', 'origin'])
    run_command(ip, user, path, ['git', 'remote', 'add', 'origin', auth_url])
    run_command(ip, user, path, ['git', 'add', '.'])
    run_command(ip, user, path, ['git', 'commit', '-m', 'Auto-Link Init'])
    p = run_command(ip, user, path, ['git', 'push', '-u', 'origin', 'main'])
    if p['code'] != 0: p = run_command(ip, user, path, ['git', 'push', '-u', 'origin', 'master'])
    return jsonify({'status': 'success', 'output': '\n'.join(logs)})
""").replace("# ... (ê¸°ì¡´ í ë¡œì§ ìœ ì§€) ...", r"""
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        p = request.args.get('path')
        if p: cursor.execute("SELECT TaskID, ProjectName, TaskContent, Status, CONVERT(VARCHAR, StartedAt, 120) as StartedAt FROM cline_TaskQueue WHERE ProjectPath=%s AND Status IN ('Pending', 'Processing') ORDER BY TaskID", (p,))
        else: cursor.execute("SELECT TaskID, ProjectName, TaskContent, Status, CONVERT(VARCHAR, StartedAt, 120) as StartedAt FROM cline_TaskQueue WHERE Status IN ('Pending', 'Processing') ORDER BY ProjectName, TaskID")
        rows = cursor.fetchall(); conn.close(); return jsonify(rows)
    if request.method == 'POST':
        d = request.json; fc = d['content'] + (f"\n\n[SYSTEM] {d.get('common_instruction', '')}" if d.get('common_instruction') else "")
        cursor.execute("INSERT INTO cline_TaskQueue (ProjectName, ProjectPath, TaskContent) VALUES (%s, %s, %s)", (d['project'], d['path'], fc))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})
    if request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_TaskQueue WHERE TaskID=%s", (request.args.get('id'),)); conn.commit(); conn.close(); return jsonify({'status': 'success'})
""").replace("# ... (ê¸°ì¡´ ë¶ë§ˆí¬ ë¡œì§ ìœ ì§€) ...", r"""
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_WebBookmarks ORDER BY CreatedAt ASC"); rows = cursor.fetchall(); conn.close(); return jsonify(rows)
    if request.method == 'POST':
        d = request.json; cursor.execute("INSERT INTO cline_WebBookmarks (Title, URL) VALUES (%s, %s)", (d.get('title'), d.get('url'))); conn.commit(); conn.close(); return jsonify({'status': 'success'})
    if request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_WebBookmarks WHERE BookmarkID=%s", (request.args.get('id'),)); conn.commit(); conn.close(); return jsonify({'status': 'success'})
""").replace("# ... (ê¸°ì¡´ íˆìŠ¤í† ë¦¬ ë¡œì§ ìœ ì§€) ...", r"""
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT TaskID, TaskContent, Status, ResultContent, CONVERT(VARCHAR, CreatedAt, 120) as CreatedAt, CONVERT(VARCHAR, CompletedAt, 120) as CompletedAt, DATEDIFF(SECOND, StartedAt, CompletedAt) as DurationSeconds FROM cline_TaskQueue WHERE ProjectPath=%s ORDER BY TaskID DESC", (request.json.get('path'),)); rows = cursor.fetchall(); conn.close(); return jsonify(rows)
""")

with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(full_api_code)

print("\nâœ… v39 ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì•„ì´í”¼ ì¸ì‹ ë° ì°¨íŠ¸ ë²„ê·¸ ìˆ˜ì •.")
print("ğŸ‘‰ ì´ì œ ì‚¬ì´ë“œë°” í†µê³„ê°€ ì •ìƒ ì¶œë ¥ë˜ê³ , ì¸íŠ¸ë¼ë„· ì•„ì´í”¼ë¥¼ ì •í™•íˆ ì¸ì‹í•©ë‹ˆë‹¤.")