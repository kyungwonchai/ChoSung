import os
import pymssql

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ ì˜¤ë¥˜: í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# ====================================================
# 1. API Routes ì—…ë°ì´íŠ¸ (ë£°ì— ë§ëŠ” ì „ìš© ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€)
# ====================================================
# ë£°ì˜ ìš”êµ¬ì‚¬í•­:
# - POST /api/agent/next -> {"status": "ok", "command": ...} ë°˜í™˜
# - POST /api/agent/result -> DBì— ê²°ê³¼ ì €ì¥
# ====================================================

api_routes_code = r"""from flask import Blueprint, request, jsonify
from app.database import get_db_connection
from app.services.ssh_service import send_rule_via_ssh
import subprocess
import os
import datetime

api_bp = Blueprint('api', __name__)

# [ì„¤ì •] ë¸Œë¦¿ì§€ API ì£¼ì†Œ
BRIDGE_API_URL = "http://192.168.0.10:9111"

# --- [NEW] Agent Protocol Routes (ë£° í˜¸í™˜ìš©) ---

@api_bp.route('/agent/next', methods=['POST'])
def agent_next_task():
    """
    ë£°: STEP 1: FETCH
    ì—ì´ì „íŠ¸ê°€ { "subject": "{SUBJECT}" } ë¥¼ ë³´ë‚´ë©´
    Pending ìƒíƒœì¸ ì‘ì—…ì„ í•˜ë‚˜ êº¼ë‚´ì„œ í• ë‹¹í•¨.
    """
    data = request.json
    project_name = data.get('subject')
    
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    # 1. í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ Pending ì‘ì—… ì¤‘ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ 1ê°œ ì¡°íšŒ
    cursor.execute(\"\"\"
        SELECT TOP 1 TaskID, TaskContent 
        FROM TaskQueue 
        WHERE ProjectName=%s AND Status='Pending'
        ORDER BY TaskID ASC
    \"\"\", (project_name,))
    
    task = cursor.fetchone()
    
    if task:
        # 2. ìƒíƒœë¥¼ Processingìœ¼ë¡œ ë³€ê²½ (ì¤‘ë³µ í• ë‹¹ ë°©ì§€)
        cursor.execute("UPDATE TaskQueue SET Status='Processing', StartedAt=GETDATE() WHERE TaskID=%s", (task['TaskID'],))
        conn.commit()
        conn.close()
        
        # ë£° í¬ë§·ì— ë§ì¶° ë°˜í™˜
        return jsonify({
            "status": "ok",
            "log_id": task['TaskID'],
            "command": task['TaskContent']
        })
    else:
        conn.close()
        return jsonify({"status": "wait"})

@api_bp.route('/agent/result', methods=['POST'])
def agent_submit_result():
    """
    ë£°: STEP 3: SUBMIT REPORT
    ì—ì´ì „íŠ¸ê°€ { "subject": "...", "log_id": ..., "result": "..." } ë¥¼ ë³´ëƒ„
    """
    data = request.json
    task_id = data.get('log_id')
    result_content = data.get('result')
    
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # ì‘ì—… ì™„ë£Œ ì²˜ë¦¬ ë° ê²°ê³¼ ì €ì¥
    cursor.execute(\"\"\"
        UPDATE TaskQueue 
        SET Status='Done', CompletedAt=GETDATE(), ResultContent=%s 
        WHERE TaskID=%s
    \"\"\", (result_content, task_id))
    
    # í”„ë¡œì íŠ¸ í†µê³„ ê°±ì‹  (ë§ˆì§€ë§‰ í™œë™ ì‹œê°„)
    project_name = data.get('subject')
    if project_name:
        cursor.execute("UPDATE FolderIndex SET LastTaskDate=GETDATE() WHERE DisplayName=%s", (project_name,))

    conn.commit()
    conn.close()
    
    return jsonify({"status": "received"})

# --- ê¸°ì¡´ Routes ìœ ì§€ ---

@api_bp.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    target_ip = data.get('ip')
    user = data.get('account')
    path = data.get('path')
    cmd = ['code', '--no-sandbox', '--new-window']
    remote_arg = f"ssh-remote+{user}@{target_ip}"
    cmd.extend(['--remote', remote_arg, path])
    try:
        env = os.environ.copy()
        if 'DISPLAY' not in env: env['DISPLAY'] = ':0'
        subprocess.Popen(cmd, env=env)
        return jsonify({'status': 'success'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

@api_bp.route('/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, 'No Group') as GroupName, COUNT(*) as Cnt FROM FolderIndex GROUP BY ISNULL(GroupName, 'No Group')")
    group_counts = cursor.fetchall()
    cursor.execute("SELECT ISNULL(f.GroupName, 'No Group') as GroupName, COUNT(*) as Cnt FROM TaskQueue q JOIN FolderIndex f ON q.ProjectName = f.DisplayName WHERE q.Status IN ('Pending', 'Processing') GROUP BY ISNULL(f.GroupName, 'No Group')")
    active_counts = cursor.fetchall()
    conn.close()
    return jsonify({'groups': group_counts, 'active': active_counts})

@api_bp.route('/rules', methods=['GET', 'POST'])
def handle_rules():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM ProjectRules ORDER BY RuleID DESC")
        rules = cursor.fetchall()
        conn.close()
        return jsonify(rules)
    if request.method == 'POST':
        data = request.json
        cursor.execute("INSERT INTO ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", (data['name'], data['content']))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

@api_bp.route('/rules/deploy', methods=['POST'])
def deploy_rule():
    data = request.json
    project_name = data.get('project_name')
    rule_id = data.get('rule_id')
    
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    cursor.execute("SELECT RuleContent FROM ProjectRules WHERE RuleID=%s", (rule_id,))
    rule_row = cursor.fetchone()
    
    cursor.execute("SELECT IPAddress, Account, FullPath FROM FolderIndex WHERE DisplayName=%s", (project_name,))
    target = cursor.fetchone()
    
    if not rule_row or not target:
        conn.close()
        return jsonify({'status': 'error', 'message': 'Not found'}), 404
        
    # [Templating] ë£° ë³€ìˆ˜ ì¹˜í™˜ (ì‚¬ìš©ì ìš”ì²­ì‚¬í•­ ë°˜ì˜)
    # {SUBJECT} -> project_name
    # {SERVER_URL} -> BRIDGE_API_URL
    # {VENV} -> 'python' (ê¸°ë³¸ê°’)
    
    final_content = rule_row['RuleContent']
    final_content = final_content.replace('{SUBJECT}', project_name)
    final_content = final_content.replace('{SERVER_URL}', BRIDGE_API_URL)
    final_content = final_content.replace('{VENV}', 'python') # ê°€ìƒí™˜ê²½ì€ ê¸°ë³¸ pythonìœ¼ë¡œ ë§¤í•‘
    
    # ìœˆë„ìš°/ë¦¬ëˆ…ìŠ¤ ê²½ë¡œ í˜¸í™˜ ì²˜ë¦¬
    final_content = final_content.replace('{TARGET_PATH}', target['FullPath'].replace('\\', '/'))

    success, msg = send_rule_via_ssh(target['IPAddress'], target['Account'], final_content, target['FullPath'])
    
    if success:
        cursor.execute("UPDATE FolderIndex SET LastRuleContent=%s WHERE DisplayName=%s", (final_content, project_name))
        conn.commit()
        
    conn.close()
    return jsonify({'status': 'success' if success else 'error', 'message': msg})

@api_bp.route('/memos/<project_name>', methods=['GET', 'POST'])
def handle_memo(project_name):
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT MemoContent FROM ProjectMemos WHERE ProjectName=%s", (project_name,))
        row = cursor.fetchone()
        conn.close()
        return jsonify({'content': row['MemoContent'] if row else ''})
    if request.method == 'POST':
        content = request.json.get('content')
        sql = "MERGE ProjectMemos AS target USING (SELECT %s as PName) AS source ON (target.ProjectName = source.PName) WHEN MATCHED THEN UPDATE SET MemoContent = %s, UpdatedAt = GETDATE() WHEN NOT MATCHED THEN INSERT (ProjectName, MemoContent) VALUES (%s, %s);"
        cursor.execute(sql, (project_name, content, project_name, content))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

@api_bp.route('/queue', methods=['GET', 'POST'])
def handle_queue():
    # ê¸°ì¡´ APIë„ í˜¸í™˜ì„± ìœ„í•´ ìœ ì§€
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        p_name = request.args.get('project')
        cursor.execute("SELECT * FROM TaskQueue WHERE ProjectName=%s AND Status IN ('Pending', 'Processing') ORDER BY TaskID", (p_name,))
        rows = cursor.fetchall()
        conn.close()
        return jsonify(rows)
    if request.method == 'POST':
        data = request.json
        p_name = data.get('project')
        content = data.get('content')
        cursor.execute("INSERT INTO TaskQueue (ProjectName, TaskContent) VALUES (%s, %s)", (p_name, content))
        cursor.execute("UPDATE FolderIndex SET TaskCount = TaskCount + 1, LastTaskDate = GETDATE() WHERE DisplayName=%s", (p_name,))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})
"""

with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(api_routes_code)
print("1ï¸âƒ£ API Routes ì—…ë°ì´íŠ¸ ì™„ë£Œ (/agent/next, /agent/result ì¶”ê°€)")


# ====================================================
# 2. DB ì—…ë°ì´íŠ¸ (ResultContent ì»¬ëŸ¼ ì¶”ê°€)
# ====================================================
print("2ï¸âƒ£ DB ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ ë° ë£° ë“±ë¡ ì¤‘...")

# ì‚¬ìš©ìë‹˜ì´ ì£¼ì‹  ì „ì„¤ì˜ ë£° ì›ë¬¸
legendary_rule = """# [SYSTEM PERSONA: INTELLIGENT WORKER & REPORTER]
You are an autonomous worker for project "{SUBJECT}".
Your goal is not just to "run" commands, but to **PERFORM TASKS** and **GENERATE A DETAILED REPORT**.

# [CONFIGURATION]
- Server: {SERVER_URL}
- Project Name: {SUBJECT}
- Virtual Env: {VENV}
- **Report File**: `task_report.md` (You must CREATE this file every turn)

# [MANDATORY WORKFLOW]
When triggered by **"go"**, **"do"**, or **"ê³ "**:

## STEP 1: FETCH
1. POST `{SERVER_URL}/api/agent/next` with `{"subject": "{SUBJECT}"}`.
2. If `{"status": "wait"}`, print "Waiting..." and STOP.
3. If `{"status": "ok", "log_id": <ID>, "command": "<INSTRUCTION>"}`:
   - **<INSTRUCTION>** is your task. It can be a shell command OR a natural language request (e.g., "Create a Flask app").

## STEP 2: PERFORM & DOCUMENT (CRITICAL)
You must decide how to handle the `<INSTRUCTION>`:

### CASE A: It is a System Command (e.g., `python worker.py`, `ls -al`)
1. Execute the command.
2. **CAPTURE** stdout and stderr.
3. **WRITE** the output into `task_report.md`. (Overwrite `>`).

### CASE B: It is a Request (e.g., "Make a Hello World Flask app")
1. **PERFORM** the task (Create files, edit code, etc.).
2. **WRITE A REPORT** into `task_report.md`.
   - The report MUST include:
     - What files were created/modified.
     - A summary of the action taken.
     - **Result Verification**: (e.g., "Created app.py. Content snippet: ...").
   - **DO NOT** just write "Done". Write the EVIDENCE.

## STEP 3: SUBMIT REPORT
1. Read the content of `task_report.md` (Ensure UTF-8).
2. If the file is empty or missing, write "[Error: No report generated]" and read it.
3. Send POST to `{SERVER_URL}/api/agent/result`.
   - Payload:
     ```json
     {
       "subject": "{SUBJECT}",
       "log_id": <ID>,
       "result": "<CONTENT_OF_TASK_REPORT_MD>"
     }
     ```

# [RULES OF ENGAGEMENT]
1. **NO LAZINESS**: If the user asks for code, the result sent to the server MUST contain the code or a confirmation of file creation, NOT just the user's prompt.
2. **NO ECHO**: Do NOT echo the user's command back as the result.
3. **FILE BASED**: Always write to `task_report.md` first, then read it to send the API request.
"""

DB_HOST = '192.168.0.10'
DB_USER = 'sa'
DB_PASSWORD = 'password'
DB_NAME = 'MyDatabase'

try:
    conn = pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)
    cursor = conn.cursor()
    
    # 1. TaskQueue í…Œì´ë¸”ì— ê²°ê³¼ ì €ì¥ìš© ì»¬ëŸ¼ ì¶”ê°€ (ì—†ìœ¼ë©´)
    try:
        cursor.execute("ALTER TABLE TaskQueue ADD ResultContent NVARCHAR(MAX) NULL")
        conn.commit()
        print("   - TaskQueue í…Œì´ë¸”ì— 'ResultContent' ì»¬ëŸ¼ ì¶”ê°€ë¨.")
    except:
        print("   - 'ResultContent' ì»¬ëŸ¼ì€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")

    # 2. ì „ì„¤ì˜ ë£° ì—…ë°ì´íŠ¸
    rule_name = "Auto-Agent Protocol (Go/Do)"
    
    cursor.execute("SELECT Count(*) FROM ProjectRules WHERE RuleName = %s", (rule_name,))
    if cursor.fetchone()[0] == 0:
        cursor.execute("INSERT INTO ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", 
                       (rule_name, legendary_rule))
    else:
        cursor.execute("UPDATE ProjectRules SET RuleContent = %s WHERE RuleName = %s", 
                       (legendary_rule, rule_name))
    
    conn.commit()
    conn.close()
    print("âœ… DB ì‘ì—… ì™„ë£Œ: ë£°ì´ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")

except Exception as e:
    print(f"âš ï¸ DB ì—°ê²° ì‹¤íŒ¨: {e}")
    # ì¿¼ë¦¬ ì¶œë ¥
    safe_rule = legendary_rule.replace("'", "''")
    print("\n[ìˆ˜ë™ SQL ì‹¤í–‰ í•„ìš”]")
    print(f"UPDATE ProjectRules SET RuleContent = N'{safe_rule}' WHERE RuleName = 'Auto-Agent Protocol (Go/Do)';")

print("\nğŸš€ ì‹œìŠ¤í…œ ë³µêµ¬ ì™„ë£Œ.")
print("ğŸ‘‰ ì´ì œ ì—ì´ì „íŠ¸ëŠ” '/api/agent/next'ë¡œ ì¼ì„ ë°›ê³ , 'task_report.md'ë¥¼ ì‘ì„±í•œ ë’¤, '/api/agent/result'ë¡œ ê²°ê³¼ë¥¼ ë³´ê³ í•©ë‹ˆë‹¤.")
print("ğŸ‘‰ 'python3 runcline/run_bridge.py'ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”!")