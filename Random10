import os
import sys

# ==========================================
# [설정] 프로젝트 폴더명
# ==========================================
PROJECT_DIR = "smdlibllm"

def create_file(path, content):
    full_path = os.path.join(PROJECT_DIR, path)
    os.makedirs(os.path.dirname(full_path), exist_ok=True)
    with open(full_path, "w", encoding="utf-8") as f:
        f.write(content.strip())
    print(f"[생성] {full_path}")

def main():
    if not os.path.exists(PROJECT_DIR):
        os.makedirs(PROJECT_DIR)

    # ---------------------------------------------------------
    # 1. requirements.txt
    # ---------------------------------------------------------
    create_file("requirements.txt", """
flask
requests
python-dotenv
pandas
""")

    # ---------------------------------------------------------
    # 2. .env (사용자 환경 설정 - 수정 필요)
    # ---------------------------------------------------------
    create_file(".env", """
# [시스템 설정]
FLASK_PORT=5000
DEBUG_MODE=True

# [프록시 설정 - 필요시 입력, 없으면 비워둠]
HTTP_PROXY=
HTTPS_PROXY=
# 인증서 검증 무시하려면 False, 파일 경로가 있다면 경로 입력
REQUESTS_CA_BUNDLE=False

# [커스텀 LLM API 설정]
# 경원님의 API 키 (x-api-key 헤더에 들어갈 값)
LLM_API_KEY=your-secret-api-key-here

# LLM 엔드포인트 URL (여러 개면 콤마 , 로 구분)
# 예: http://10.10.10.5:8080/v1/run,http://10.10.10.6:8080/v1/run
LLM_API_URLS=http://your-custom-llm-url.com/run
""")

    # ---------------------------------------------------------
    # 3. data/data.txt (엑셀 복붙용 더미 데이터)
    # ---------------------------------------------------------
    create_file("data/data.txt", """
PartCode\tData1\tData2\tData3\tData4
2222-001424\t100nF\t16V\tSamsung\t0.8mm
2222-001425\t10uF\t10V\tMurata\t1.2mm
3333-555555\tResistor\t10k\tYageo\t0402
""")

    # ---------------------------------------------------------
    # 4. src/__init__.py
    # ---------------------------------------------------------
    create_file("src/__init__.py", "")

    # ---------------------------------------------------------
    # 5. src/config.py
    # ---------------------------------------------------------
    create_file("src/config.py", """
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    PORT = int(os.getenv("FLASK_PORT", 5000))
    DEBUG = os.getenv("DEBUG_MODE", "False") == "True"

    # 프록시
    PROXIES = {}
    if os.getenv("HTTP_PROXY"): PROXIES['http'] = os.getenv("HTTP_PROXY")
    if os.getenv("HTTPS_PROXY"): PROXIES['https'] = os.getenv("HTTPS_PROXY")

    CA_BUNDLE = os.getenv("REQUESTS_CA_BUNDLE", "False")
    if CA_BUNDLE.lower() == "false": CA_BUNDLE = False

    # LLM 설정
    LLM_API_KEY = os.getenv("LLM_API_KEY", "")
    LLM_URLS = [url.strip() for url in os.getenv("LLM_API_URLS", "").split(',') if url.strip()]
""")

    # ---------------------------------------------------------
    # 6. src/retriever.py (1열 Key 매칭 로직)
    # ---------------------------------------------------------
    create_file("src/retriever.py", """
import pandas as pd

class LocalRetriever:
    def __init__(self, data_path):
        self.data_path = data_path
        self.df = None
        self.load_data()

    def load_data(self):
        try:
            # 헤더가 있든 없든 0번째 행을 헤더로 인식하되, 우리는 인덱스로 접근할 것임
            self.df = pd.read_csv(self.data_path, sep='\\t', dtype=str)
            self.df.fillna('', inplace=True)
            print(f"[System] 데이터 로드: {len(self.df)} 라인")
        except Exception as e:
            print(f"[Error] 데이터 로드 실패: {e}")
            self.df = pd.DataFrame()

    def search(self, query):
        if self.df.empty: return ""

        query = query.strip()
        results = []
        
        # 1열(Key)의 이름을 몰라도 iloc[:, 0]으로 접근
        # 사용자가 질문에 부품코드를 섞어 썼을 테니, 데이터의 키가 질문에 포함되어 있는지 확인
        
        found_row = None
        
        # 데이터가 많을 경우 이 부분은 최적화가 필요할 수 있으나, 사내 서버용으론 OK
        for idx, row in self.df.iterrows():
            # 1열의 값 (Part Code)
            part_key = str(row.iloc[0]).strip()
            
            # 부품 코드가 질문에 들어있으면 빙고 (대소문자 무시)
            if len(part_key) > 3 and part_key.lower() in query.lower():
                found_row = row
                break
        
        if found_row is not None:
            # 찾은 행의 모든 컬럼 데이터를 문자열로 합침
            # 컬럼명: 값 형태가 아니라 그냥 값들의 나열이어도 LLM이 해석함
            row_str = " | ".join([f"{val}" for val in found_row.values])
            return f"부품상세정보: {row_str}"
            
        return "데이터 파일에 해당 부품 코드가 없습니다."
""")

    # ---------------------------------------------------------
    # 7. src/llm_client.py (Curl 포맷 수정됨)
    # ---------------------------------------------------------
    create_file("src/llm_client.py", """
import requests
import json
import itertools
from .config import Config

class CustomLLMClient:
    def __init__(self):
        self.url_cycle = itertools.cycle(Config.LLM_URLS) if Config.LLM_URLS else None

    def ask(self, context, user_question):
        if not self.url_cycle:
            return "오류: .env 파일에 LLM URL이 설정되지 않았습니다."

        # RAG 프롬프트 구성
        final_input = f"참고자료(Data):\\n{context}\\n\\n질문(Question):\\n{user_question}\\n\\n지시: 위 참고자료를 보고 질문에 답해줘."

        # 요청 데이터 (경원님 요청 포맷)
        payload = {
            "input_type": "chat",
            "output_type": "chat",
            "input_value": final_input
        }

        # 헤더 설정 (x-api-key)
        headers = {
            "Content-Type": "application/json",
            "x-api-key": Config.LLM_API_KEY
        }

        target_url = next(self.url_cycle)

        try:
            print(f"[요청] URL: {target_url}")
            response = requests.post(
                target_url,
                headers=headers,
                json=payload,
                proxies=Config.PROXIES,
                verify=Config.CA_BUNDLE,
                timeout=60
            )
            response.raise_for_status()
            
            # 응답 처리
            # 출력이 단순 텍스트인지 JSON인지 모르므로 일단 JSON 시도 후 텍스트 반환
            try:
                res_json = response.json()
                # 응답 포맷을 모르니 덤프해서 보여주거나, 특정 필드가 있다면 수정 필요
                # 보통 output_value 같은 키로 올 가능성이 높음. 
                # 여기선 전체를 문자열로 리턴하여 확인 가능하게 함.
                return str(res_json) 
            except:
                return response.text

        except Exception as e:
            return f"통신 에러: {str(e)}"
""")

    # ---------------------------------------------------------
    # 8. app.py (웹 서버)
    # ---------------------------------------------------------
    create_file("app.py", """
from flask import Flask, request, jsonify, render_template_string
from src.config import Config
from src.retriever import LocalRetriever
from src.llm_client import CustomLLMClient
import os

app = Flask(__name__)

# 데이터 로드
DATA_FILE = os.path.join("data", "data.txt")
retriever = LocalRetriever(DATA_FILE)
llm_client = CustomLLMClient()

@app.route('/')
def index():
    return render_template_string('''
        <h3>SMD Parts Agent (Custom LLM)</h3>
        <form onsubmit="return false;">
            <input type="text" id="q" style="width:300px;" placeholder="부품코드 포함해서 질문...">
            <button onclick="send()">전송</button>
        </form>
        <pre id="res" style="background:#eee; padding:10px; margin-top:10px;"></pre>
        <script>
            async function send() {
                const q = document.getElementById('q').value;
                document.getElementById('res').innerText = "조회 및 생성 중...";
                const res = await fetch('/chat', {
                    method:'POST', 
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({query:q})
                });
                const data = await res.json();
                document.getElementById('res').innerText = data.answer;
            }
        </script>
    ''')

@app.route('/chat', methods=['POST'])
def chat_endpoint():
    req = request.json
    query = req.get('query', '')
    
    # 1. 엑셀 데이터 검색 (1열 키 매칭)
    context = retriever.search(query)
    
    # 2. 커스텀 LLM 호출
    if "없습니다" in context:
        # 데이터가 없으면 그냥 질문만 던질지, 없다고 할지 결정. 여기선 그냥 던짐.
        answer = llm_client.ask("관련 부품 데이터 없음", query)
    else:
        answer = llm_client.ask(context, query)
        
    return jsonify({"answer": answer, "context": context})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=Config.PORT, debug=Config.DEBUG)
""")

    print("\\n[설치 완료] smdlibllm 폴더가 생성되었습니다.")
    print("---------------------------------------------------")
    print("1. cd smdlibllm")
    print("2. pip install -r requirements.txt")
    print("3. .env 파일 열어서 LLM_API_URLS, LLM_API_KEY 입력")
    print("4. data/data.txt 에 엑셀 내용 붙여넣기 (1열은 무조건 부품코드여야 함)")
    print("5. python app.py 실행")
    print("---------------------------------------------------")

if __name__ == "__main__":
    main()