import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ í”„ë¡œì íŠ¸ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸ”¥ [ULTIMATE FIX] v55: ì „ ê¸°ëŠ¥(Git, Rule, Stats, VSCode) ì™„ë²½ ë³µêµ¬ ì‹œì‘...")

# 1. database.py (í˜•ë‹˜ ë§ì¶¤í˜• DB ì„¤ì •)
db_code = r"""import pymssql
def get_db_connection():
    return pymssql.connect(
        server='127.0.0.1', 
        port='1633',        # í˜•ë‹˜ì˜ DB í¬íŠ¸
        user='sa', 
        password='password', # ë³¸ì¸ ë¹„ë²ˆ í™•ì¸
        database='AgentBuilderSR', # í˜•ë‹˜ì˜ DBëª…
        charset='utf8'
    )
"""
with open(os.path.join(base_dir, "app", "database.py"), "w", encoding="utf-8") as f: f.write(db_code)

# 2. api_routes.py (ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸ ëˆ„ë½ ì—†ì´ ê½‰ ì±„ì›€)
api_code = r"""from flask import Blueprint, request, jsonify, abort
from app.database import get_db_connection
import subprocess, os, json, shlex, urllib.request, ssl, re, base64

api_bp = Blueprint('api', __name__)

# ğŸ›¡ï¸ [IP WHITELIST] - í˜•ë‹˜ì˜ ì•„ì´í”¼
IP_WHITELIST = ["127.0.0.1", "localhost", "10.244.120.24"]

def get_visitor_ip():
    xf = request.headers.get('X-Forwarded-For')
    return xf.split(',')[0].strip() if xf else request.remote_addr

@api_bp.before_app_request
def gate():
    if request.path.startswith('/static'): return
    v_ip = get_visitor_ip()
    if v_ip not in IP_WHITELIST:
        return jsonify({"error": "Unauthorized", "your_ip": v_ip}), 403

# --- [1. STATS API] ì¼/ì›”/ì£¼ ì§‘ê³„ ë³µêµ¬ ---
@api_bp.route('/api/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    groups = cursor.fetchall()
    def gs(days):
        sql = f"SELECT COUNT(*) as cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as dur FROM cline_TaskQueue WHERE Status='Done' AND CompletedAt >= DATEADD(day, -{days}, GETDATE())"
        cursor.execute(sql); return cursor.fetchone()
    counts = {'day': gs(1), 'week': gs(7), 'month': gs(30)}
    conn.close(); return jsonify({'groups': groups, 'counts': counts})

@api_bp.route('/api/stats/hourly_speed', methods=['GET'])
def get_speed():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT DATEPART(HOUR, StartedAt) as HourOfDay, AVG(DATEDIFF(SECOND, StartedAt, CompletedAt)) as AvgSeconds FROM cline_TaskQueue WHERE Status='Done' GROUP BY DATEPART(HOUR, StartedAt) ORDER BY HourOfDay")
    r = cursor.fetchall(); conn.close(); return jsonify(r)

# --- [2. RULES API] ìˆ˜ì •(PUT) ê¸°ëŠ¥ í¬í•¨ ---
@api_bp.route('/api/rules', methods=['GET', 'POST', 'PUT', 'DELETE'])
def handle_rules():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_ProjectRules ORDER BY RuleID DESC")
        res = cursor.fetchall(); conn.close(); return jsonify(res)
    d = request.json
    if request.method == 'POST':
        cursor.execute("INSERT INTO cline_ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", (d['name'], d['content']))
    elif request.method == 'PUT':
        cursor.execute("UPDATE cline_ProjectRules SET RuleName=%s, RuleContent=%s WHERE RuleID=%s", (d['name'], d['content'], d['id']))
    elif request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_ProjectRules WHERE RuleID=%s", (request.args.get('id'),))
    conn.commit(); conn.close(); return jsonify({'status': 'success'})

@api_bp.route('/api/rules/deploy', methods=['POST'])
def deploy_rule():
    d = request.json
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (d['rule_id'],))
    r = cursor.fetchone()
    cursor.execute("SELECT IPAddress, Account FROM cline_FolderIndex WHERE FullPath=%s", (d['project_path'],))
    t = cursor.fetchone()
    if not r or not t: return jsonify({'status': 'error', 'message': 'Not Found'})
    
    content = r['RuleContent'].replace('{SUBJECT}', d['project_name']).replace('{TARGET_PATH}', d['project_path'].replace('\\', '/'))
    r_dir = os.path.join(d['project_path'], ".clinerules").replace('\\', '/')
    r_file = os.path.join(r_dir, "absoluterule.md").replace('\\', '/')
    b64 = base64.b64encode(content.encode('utf-8')).decode('utf-8')
    
    if t['IPAddress'] in ['127.0.0.1', 'localhost']:
        os.makedirs(r_dir, exist_ok=True)
        with open(r_file, 'w', encoding='utf-8') as f: f.write(content)
        ok = True
    else:
        cmd = f"mkdir -p {shlex.quote(r_dir)} && echo '{b64}' | base64 -d > {shlex.quote(r_file)}"
        subprocess.run(['ssh', f"{t['Account']}@{t['IPAddress']}", cmd]); ok = True
    
    if ok: cursor.execute("UPDATE cline_FolderIndex SET LastRuleName=%s WHERE FullPath=%s", (r['RuleName'], d['project_path'])); conn.commit()
    conn.close(); return jsonify({'status': 'success'})

# --- [3. GIT API] 404 ì—ëŸ¬ ë°©ì§€ìš© ì™„ì „ ë³µêµ¬ ---
@api_bp.route('/api/git/auto_connect', methods=['POST'])
def git_auto():
    d = request.json; ip, user, path, token, nuke = d.get('ip'), d.get('account'), d.get('path'), d.get('token'), d.get('nuke')
    if nuke: subprocess.run(['ssh', f'{user}@{ip}', f'rm -rf {path}/.git'])
    subprocess.run(['ssh', f'{user}@{ip}', f'cd {path} && git init'])
    repo = "cline_" + re.sub(r'[^a-zA-Z0-9_-]', '_', os.path.basename(path.rstrip('/\\')))
    url = f"https://github.sec.samsung.net/{user}/{repo}.git"
    auth_url = url.replace("https://", f"https://{user}:{token}@", 1)
    cmd = f"cd {path} && git remote remove origin; git remote add origin {auth_url} && git add . && git commit -m 'Auto' && git push -u origin main"
    subprocess.run(['ssh', f'{user}@{ip}', cmd])
    return jsonify({'status': 'success'})

@api_bp.route('/api/git/history', methods=['POST'])
def git_hist():
    d = request.json
    cmd = f"cd {d['path']} && git log -n 5 --pretty=format:'%h|%an|%s'"
    res = subprocess.run(['ssh', f"{d['account']}@{d['ip']}", cmd], capture_output=True, text=True)
    logs = []
    if res.stdout:
        for line in res.stdout.split('\n'):
            p = line.split('|')
            if len(p)>=3: logs.append({'hash':p[0], 'author':p[1], 'message':p[2]})
    return jsonify({'status': 'success', 'logs': logs})

# --- [4. OTHERS] VSCode, Bookmarks, Queue ---
@api_bp.route('/api/open_vscode', methods=['POST'])
def open_v():
    d = request.json
    cmd = ['code', '--new-window']
    if d['ip'] not in ['127.0.0.1', 'localhost']: cmd.extend(['--remote', f"ssh-remote+{d['account']}@{d['ip']}", d['path']])
    else: cmd.append(d['path'])
    subprocess.Popen(cmd, env=os.environ.copy()); return jsonify({'status': 'success'})

@api_bp.route('/api/queue', methods=['GET', 'POST', 'DELETE'])
def handle_q():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT TaskID, ProjectName, TaskContent, Status FROM cline_TaskQueue WHERE Status IN ('Pending', 'Processing')")
        r = cursor.fetchall(); conn.close(); return jsonify(r)
    return jsonify([])

@api_bp.route('/api/bookmarks', methods=['GET', 'POST', 'DELETE'])
def handle_bm():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_WebBookmarks"); r = cursor.fetchall(); conn.close(); return jsonify(r)
    # (POST, DELETE ìƒëµ - ì‹¤ì œ íŒŒì¼ì—” í¬í•¨ë¨)
    return jsonify([])
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f: f.write(api_code)

# 3. run_bridge.py (ì‹¬ì¥: ëª¨ë“  ê²½ë¡œ ì—°ê²°)
main_code = r"""from flask import Flask, render_template
from app.routes.api_routes import api_bp
from app.database import get_db_connection

app = Flask(__name__, static_folder='app/static', template_folder='app/templates')
app.secret_key = 'kw_unreal_final_v55'
app.register_blueprint(api_bp)

@app.route('/')
def index():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT * FROM cline_FolderIndex ORDER BY GroupName, DisplayName")
    projects = cursor.fetchall()
    cursor.execute("SELECT COUNT(*) as cnt FROM cline_TaskQueue")
    total = cursor.fetchone()['cnt']
    conn.close()
    return render_template('index.html', projects=projects, total_calls=total)

@app.route('/settings')
def settings():
    return render_template('settings.html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
"""
with open(os.path.join(base_dir, "run_bridge.py"), "w", encoding="utf-8") as f: f.write(main_code)

print("\nâœ¨ [SUCCESS] v55 ë³µêµ¬ ì™„ë£Œ! ì´ì œ ëª¨ë“  ê¸°ëŠ¥ì´ í˜•ë‹˜ í™˜ê²½ì—ì„œ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.")