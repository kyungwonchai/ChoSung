ë ¥" ê¸°ëŠ¥ì´ ëª¨ë‘ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ğŸ› ï¸ í”„ë¡œì íŠ¸ ìƒì„± ë° ì ìš© ë°©ë²• (3ë‹¨ê³„)
Visual Studioë¥¼ ì‹¤í–‰í•˜ê³  **[ìƒˆ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°]**ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.

**"WPF ì•±(.NET Framework)"**ì„ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•˜ê³ , í”„ë¡œì íŠ¸ ì´ë¦„ì„ ProjectScannerë¡œ ë§Œë“­ë‹ˆë‹¤. (í”„ë ˆì„ì›Œí¬ëŠ” .NET Framework 4.8 ê¶Œì¥)

ìƒì„±ëœ í”„ë¡œì íŠ¸ì˜ **MainWindow.xaml**ê³¼ MainWindow.xaml.cs íŒŒì¼ ë‚´ìš©ì„ ì•„ë˜ ì½”ë“œë¡œ ì „ì²´ ë®ì–´ì“°ê¸° í•˜ì„¸ìš”.

1. MainWindow.xaml (ë””ìì¸)
ì‹¬í”Œí•œ ë‹¤í¬ í…Œë§ˆ UIì…ë‹ˆë‹¤.

XML
<Window x:Class="ProjectScanner.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Project Scanner (Windows Service Mode)" Height="500" Width="700"
        Background="#1E1E1E" Loaded="Window_Loaded">
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Margin="0,0,0,15">
            <TextBlock Text="Windows Solution Scanner" FontSize="20" FontWeight="Bold" Foreground="#007ACC"/>
            <TextBlock Text="ì§€ì •ëœ ê²½ë¡œì—ì„œ .slnì„ íƒìƒ‰í•˜ì—¬ DBì— ì—…ë¡œë“œí•©ë‹ˆë‹¤." Foreground="#AAAAAA" Margin="0,5,0,0"/>
            <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                <TextBlock Text="Status: " Foreground="#DDDDDD" FontWeight="Bold"/>
                <TextBlock x:Name="txtStatus" Text="Ready" Foreground="#4CAF50" FontWeight="Bold"/>
            </StackPanel>
        </StackPanel>

        <TextBox x:Name="txtLog" Grid.Row="1" Background="#252526" Foreground="#D4D4D4" 
                 FontFamily="Consolas" FontSize="12" IsReadOnly="True" 
                 VerticalScrollBarVisibility="Auto" TextWrapping="Wrap" Padding="5"/>

        <Button x:Name="btnForceScan" Grid.Row="2" Content="ì¦‰ì‹œ ìŠ¤ìº” (Force Scan)" 
                Height="35" Margin="0,15,0,0" Background="#007ACC" Foreground="White" 
                FontWeight="Bold" BorderThickness="0" Click="btnForceScan_Click"/>
    </Grid>
</Window>
2. MainWindow.xaml.cs (ë¡œì§)
í•µì‹¬ ë¡œì§ì´ ëª¨ë‘ ë“¤ì–´ìˆìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ DB_XXX ë³€ìˆ˜ì™€ TargetPathsë¥¼ ë³¸ì¸ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.

C#
using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Sockets;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Threading;

namespace ProjectScanner
{
    public partial class MainWindow : Window
    {
        // ================= CONFIGURATION =================
        private const string DB_SERVER = "192.168.0.10";
        private const string DB_USER = "sa";
        private const string DB_PASS = "password";
        private const string DB_NAME = "MyDatabase";

        // ìŠ¤ìº”í•  ëŒ€ìƒ ê²½ë¡œë“¤
        private readonly List<string> TargetPaths = new List<string>
        {
            @"C:\Users\User\Source\Repos",
            @"D:\Projects",
            @"C:\Work"
        };

        private const string PROJECT_PREFIX = "WIN_PRJ_"; // DB ì €ì¥ì‹œ ì ‘ë‘ì–´
        private const int SCAN_INTERVAL_MINUTES = 10;     // ìë™ ìŠ¤ìº” ì£¼ê¸° (ë¶„)
        // =================================================

        private DispatcherTimer _timer;
        private bool _isScanning = false;

        public MainWindow()
        {
            InitializeComponent();
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            Log("í”„ë¡œê·¸ë¨ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");
            
            // 1. íƒ€ì´ë¨¸ ì„¤ì • (10ë¶„ë§ˆë‹¤ ì‹¤í–‰)
            _timer = new DispatcherTimer();
            _timer.Interval = TimeSpan.FromMinutes(SCAN_INTERVAL_MINUTES);
            _timer.Tick += (s, args) => RunScanAsync();
            _timer.Start();

            // 2. ì¼œì§€ìë§ˆì 1íšŒ ì‹¤í–‰
            RunScanAsync();
        }

        private void btnForceScan_Click(object sender, RoutedEventArgs e)
        {
            RunScanAsync();
        }

        private async void RunScanAsync()
        {
            if (_isScanning) return;
            _isScanning = true;

            txtStatus.Text = "Scanning...";
            Log("=== ìŠ¤ìº” ì‹œì‘ ===");

            await Task.Run(() =>
            {
                try
                {
                    string localIp = GetLocalIPAddress();
                    string currentUser = Environment.UserName;

                    foreach (var path in TargetPaths)
                    {
                        if (Directory.Exists(path))
                        {
                            Log($"ê²½ë¡œ íƒìƒ‰ ì¤‘: {path}");
                            ScanDirectoryRecursive(path, localIp, currentUser);
                        }
                        else
                        {
                            Dispatcher.Invoke(() => Log($"[ê²½ê³ ] ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: {path}"));
                        }
                    }
                }
                catch (Exception ex)
                {
                    Dispatcher.Invoke(() => Log($"[ì¹˜ëª…ì  ì˜¤ë¥˜] {ex.Message}"));
                }
            });

            Log($"=== ìŠ¤ìº” ì™„ë£Œ. ë‹¤ìŒ ìŠ¤ìº”: {SCAN_INTERVAL_MINUTES}ë¶„ í›„ ===");
            txtStatus.Text = "Idle (Waiting...)";
            _isScanning = false;
        }

        // í•µì‹¬: ì¬ê·€ íƒìƒ‰ ë¡œì§ (sln ë°œê²¬ ì‹œ í•˜ìœ„ íƒìƒ‰ ì¤‘ë‹¨)
        private void ScanDirectoryRecursive(string currentPath, string ip, string user)
        {
            try
            {
                // 1. í˜„ì¬ í´ë”ì— .sln íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
                // GetFilesëŠ” ë§¤ìš° ë¹ ë¦…ë‹ˆë‹¤.
                var slnFiles = Directory.GetFiles(currentPath, "*.sln");

                if (slnFiles.Length > 0)
                {
                    // ë°œê²¬! -> DBì— ì—…ë¡œë“œí•˜ê³  ì´ ê°€ì§€(Branch)ëŠ” íƒìƒ‰ ì¢…ë£Œ
                    string folderName = new DirectoryInfo(currentPath).Name;
                    string displayName = $"{PROJECT_PREFIX}{folderName}";

                    UpdateDatabase(ip, user, displayName, currentPath);
                    return; // <--- [ì¤‘ìš”] í•˜ìœ„ í´ë” íƒìƒ‰ ì•ˆ í•¨ (ìµœì í™”)
                }

                // 2. ë°œê²¬ë˜ì§€ ì•Šì•˜ìœ¼ë©´ í•˜ìœ„ í´ë”ë¡œ ê³„ì† ì§„ì…
                var subDirs = Directory.GetDirectories(currentPath);
                foreach (var dir in subDirs)
                {
                    ScanDirectoryRecursive(dir, ip, user);
                }
            }
            catch (UnauthorizedAccessException)
            {
                // ê¶Œí•œ ì—†ëŠ” í´ë”ëŠ” ì¡°ìš©íˆ ìŠ¤í‚µ
            }
            catch (Exception ex)
            {
                Dispatcher.Invoke(() => Log($"[Error] {currentPath}: {ex.Message}"));
            }
        }

        private void UpdateDatabase(string ip, string user, string displayName, string fullPath)
        {
            string connStr = $"Server={DB_SERVER};Database={DB_NAME};User Id={DB_USER};Password={DB_PASS};";
            
            // MSSQL MERGE ì¿¼ë¦¬ (ì—†ìœ¼ë©´ Insert, ìˆìœ¼ë©´ Update)
            string query = @"
                MERGE FolderIndex AS target
                USING (SELECT @IP as IP, @Path as Path) AS source
                ON (target.IPAddress = source.IP AND target.FullPath = source.Path)
                WHEN MATCHED THEN
                    UPDATE SET DisplayName = @Name, Account = @User, LastUpdated = GETDATE()
                WHEN NOT MATCHED THEN
                    INSERT (IPAddress, Account, DisplayName, FullPath, LastUpdated)
                    VALUES (@IP, @User, @Name, @Path, GETDATE());";

            try
            {
                using (SqlConnection conn = new SqlConnection(connStr))
                {
                    conn.Open();
                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@IP", ip);
                        cmd.Parameters.AddWithValue("@Path", fullPath);
                        cmd.Parameters.AddWithValue("@Name", displayName);
                        cmd.Parameters.AddWithValue("@User", user);

                        cmd.ExecuteNonQuery();
                    }
                }
                Dispatcher.Invoke(() => Log($"  âœ… DB ì €ì¥ë¨: {displayName}"));
            }
            catch (Exception ex)
            {
                Dispatcher.Invoke(() => Log($"  âŒ DB ì €ì¥ ì‹¤íŒ¨ ({displayName}): {ex.Message}"));
            }
        }

        private string GetLocalIPAddress()
        {
            try
            {
                using (Socket socket = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, 0))
                {
                    socket.Connect("8.8.8.8", 65530);
                    IPEndPoint endPoint = socket.LocalEndPoint as IPEndPoint;
                    return endPoint.Address.ToString();
                }
            }
            catch
            {
                return "127.0.0.1";
            }
        }

        private void Log(string msg)
        {
            // UI ìŠ¤ë ˆë“œì—ì„œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰
            string timestamp = DateTime.Now.ToString("HH:mm:ss");
            string formattedMsg = $"[{timestamp}] {msg}";

            if (txtLog.Dispatcher.CheckAccess())
            {
                txtLog.AppendText(formattedMsg + Environment.NewLine);
                txtLog.ScrollToEnd();
            }
            else
            {
                txtLog.Dispatcher.Invoke(() =>
                {
                    txtLog.AppendText(formattedMsg + Environment.NewLine);
                    txtLog.ScrollToEnd();
                });
            }
        }
    }
}
âœ… ì´ ì½”ë“œì˜ í•µì‹¬ í¬ì¸íŠ¸
ë¹„ë™ê¸° ì²˜ë¦¬ (Task.Run): ìŠ¤ìº” ë¡œì§ì´ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ëŒì•„ê°€ë¯€ë¡œ, ìŠ¤ìº” ì¤‘ì—ë„ ìœˆë„ìš° ì°½ì´ ë©ˆì¶”ì§€(Not Responding) ì•ŠìŠµë‹ˆë‹¤.

ìµœì í™”ëœ íƒìƒ‰ (return): ScanDirectoryRecursive í•¨ìˆ˜ë¥¼ ë³´ë©´ .slnì„ ì°¾ì•˜ì„ ë•Œ returnì„ í˜¸ì¶œí•˜ì—¬ ë” ê¹Šì€ í•˜ìœ„ í´ë” íƒìƒ‰ì„ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.

Visual Studio í˜¸í™˜: ë³„ë„ì˜ NuGet íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì—†ì´, ê¸°ë³¸ .NET Framework ê¸°ëŠ¥ë§Œìœ¼ë¡œ System.Data.SqlClientë¥¼ ì‚¬ìš©í•˜ì—¬ DBì— ë¶™ìŠµë‹ˆë‹¤.

ìë™í™”: ì‹¤í–‰í•´ë‘ë©´ 10ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ë•ë‹ˆ