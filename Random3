import os
import pymssql

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ ì˜¤ë¥˜: 'runcline' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸš€ AI Bridge v5: Multi-Project Path Support Update...")

# DB ì •ë³´
DB_HOST = '192.168.0.10'
DB_USER = 'sa'
DB_PASSWORD = 'password'
DB_NAME = 'MyDatabase'

# ==========================================
# 1. DB Migration (ì»¬ëŸ¼ ì¶”ê°€)
#    - ì´ë¦„ì€ ê°™ê³  ê²½ë¡œë§Œ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ êµ¬ë¶„ì„ ìœ„í•´
#    - TaskQueue, ProjectMemosì— 'ProjectPath' ì¶”ê°€
# ==========================================
print("1ï¸âƒ£ DB ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ (ProjectPath ì»¬ëŸ¼ ì¶”ê°€)...")
try:
    conn = pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)
    cursor = conn.cursor()
    
    # 1. TaskQueueì— ProjectPath ì¶”ê°€
    try:
        cursor.execute("ALTER TABLE cline_TaskQueue ADD ProjectPath NVARCHAR(500)")
        conn.commit()
        print("   âœ… cline_TaskQueue: ProjectPath ì»¬ëŸ¼ ì¶”ê°€ë¨")
    except:
        print("   â„¹ï¸ cline_TaskQueue: ProjectPath ì´ë¯¸ ì¡´ì¬í•¨")

    # 2. ProjectMemosì— ProjectPath ì¶”ê°€
    try:
        cursor.execute("ALTER TABLE cline_ProjectMemos ADD ProjectPath NVARCHAR(500)")
        conn.commit()
        print("   âœ… cline_ProjectMemos: ProjectPath ì»¬ëŸ¼ ì¶”ê°€ë¨")
    except:
        print("   â„¹ï¸ cline_ProjectMemos: ProjectPath ì´ë¯¸ ì¡´ì¬í•¨")

    conn.close()

except Exception as e:
    print(f"âš ï¸ DB ì‘ì—… ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œí•˜ê³  ì§„í–‰): {e}")


# ==========================================
# 2. Main Routes (app/routes/main_routes.py)
#    - SQL Join ì¡°ê±´ì„ ì´ë¦„(DisplayName) -> ê²½ë¡œ(FullPath)ë¡œ ë³€ê²½
# ==========================================
print("2ï¸âƒ£ Main Routes ì—…ë°ì´íŠ¸ (ê²½ë¡œ ê¸°ì¤€ Join)...")

main_routes_code = r"""from flask import Blueprint, render_template
from app.database import get_db_connection, clean_path

main_bp = Blueprint('main', __name__)

@main_bp.route('/')
def index():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    # [í•µì‹¬ ë³€ê²½]
    # JOIN ì¡°ê±´ì„ f.FullPath = q.ProjectPath ë¡œ ë³€ê²½í•˜ì—¬ ê²½ë¡œê°€ ë‹¤ë¥´ë©´ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ë¡œ ì¸ì‹í•˜ê²Œ í•¨
    # ë©”ëª¨(m) ë˜í•œ f.FullPath = m.ProjectPath ë¡œ ì¡°ì¸
    # SQLì€ ì ˆëŒ€ í•œ ì¤„ ìœ ì§€
    query = "SELECT f.IPAddress, f.Account, f.DisplayName, f.FullPath, ISNULL(f.GroupName, f.IPAddress) as GroupName, f.TaskCount, CONVERT(VARCHAR, f.LastTaskDate, 120) as LastTaskDate, f.LastRuleContent, CASE WHEN q.TaskID IS NOT NULL THEN 1 ELSE 0 END as IsQueued, CASE WHEN m.MemoContent IS NOT NULL AND LEN(CAST(m.MemoContent AS NVARCHAR(MAX))) > 0 THEN 1 ELSE 0 END as HasMemo FROM cline_FolderIndex f LEFT JOIN cline_TaskQueue q ON f.FullPath = q.ProjectPath AND q.Status IN ('Pending', 'Processing') LEFT JOIN cline_ProjectMemos m ON f.FullPath = m.ProjectPath ORDER BY f.LastTaskDate DESC, f.DisplayName ASC"
    
    cursor.execute(query)
    rows = cursor.fetchall()
    
    for row in rows:
        row['FullPath'] = clean_path(row['FullPath'])
        
    cursor.execute("SELECT SUM(TaskCount) as TotalCalls FROM cline_FolderIndex")
    stats = cursor.fetchone()
    total_calls = stats['TotalCalls'] if stats['TotalCalls'] else 0

    conn.close()
    return render_template('index.html', projects=rows, total_calls=total_calls)

@main_bp.route('/settings')
def settings():
    return render_template('settings.html')
"""
with open(os.path.join(base_dir, "app", "routes", "main_routes.py"), "w", encoding="utf-8") as f:
    f.write(main_routes_code)


# ==========================================
# 3. API Routes (app/routes/api_routes.py)
#    - ëª¨ë“  ë¡œì§ì„ 'FullPath' ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½
# ==========================================
print("3ï¸âƒ£ API Routes ì—…ë°ì´íŠ¸ (Path íŒŒë¼ë¯¸í„° í•„ìˆ˜í™”)...")

api_routes_code = r"""from flask import Blueprint, request, jsonify
from app.database import get_db_connection
from app.services.ssh_service import send_rule_via_ssh
import subprocess
import os

api_bp = Blueprint('api', __name__)
BRIDGE_API_URL = "http://192.168.0.10:9111"

@api_bp.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    target_ip = data.get('ip')
    user = data.get('account')
    path = data.get('path')
    cmd = ['code', '--no-sandbox', '--new-window']
    remote_arg = f"ssh-remote+{user}@{target_ip}"
    cmd.extend(['--remote', remote_arg, path])
    try:
        env = os.environ.copy()
        if 'DISPLAY' not in env: env['DISPLAY'] = ':0'
        subprocess.Popen(cmd, env=env)
        return jsonify({'status': 'success'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

@api_bp.route('/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    group_counts = cursor.fetchall()
    cursor.execute("SELECT ISNULL(f.GroupName, f.IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_TaskQueue q JOIN cline_FolderIndex f ON q.ProjectPath = f.FullPath WHERE q.Status IN ('Pending', 'Processing') GROUP BY ISNULL(f.GroupName, f.IPAddress)")
    active_counts = cursor.fetchall()
    conn.close()
    return jsonify({'groups': group_counts, 'active': active_counts})

@api_bp.route('/rules', methods=['GET', 'POST'])
def handle_rules():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_ProjectRules ORDER BY RuleID DESC")
        rules = cursor.fetchall()
        conn.close()
        return jsonify(rules)
    if request.method == 'POST':
        data = request.json
        cursor.execute("INSERT INTO cline_ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", (data['name'], data['content']))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

@api_bp.route('/rules/<int:rule_id>', methods=['PUT', 'DELETE'])
def modify_rule(rule_id):
    conn = get_db_connection()
    cursor = conn.cursor()
    if request.method == 'PUT':
        data = request.json
        cursor.execute("UPDATE cline_ProjectRules SET RuleName=%s, RuleContent=%s WHERE RuleID=%s", (data['name'], data['content'], rule_id))
    elif request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_ProjectRules WHERE RuleID=%s", (rule_id,))
    conn.commit()
    conn.close()
    return jsonify({'status': 'success'})

@api_bp.route('/rules/deploy', methods=['POST'])
def deploy_rule():
    data = request.json
    project_name = data.get('project_name')
    project_path = data.get('project_path') # [ì¤‘ìš”] ê²½ë¡œ ìˆ˜ì‹ 
    rule_id = data.get('rule_id')
    
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    cursor.execute("SELECT RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (rule_id,))
    rule_row = cursor.fetchone()
    
    # [ì¤‘ìš”] FullPathë¡œ ì •í™•í•œ íƒ€ê²Ÿ ì¡°íšŒ
    cursor.execute("SELECT IPAddress, Account, FullPath FROM cline_FolderIndex WHERE FullPath=%s", (project_path,))
    target = cursor.fetchone()
    
    if not rule_row or not target:
        conn.close()
        return jsonify({'status': 'error', 'message': 'Not found'}), 404
        
    final_content = rule_row['RuleContent']
    # í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜
    final_content = final_content.replace('{{PROJECT_NAME}}', project_name)
    final_content = final_content.replace('{{API_URL}}', BRIDGE_API_URL)
    final_content = final_content.replace('{{TARGET_IP}}', target['IPAddress'])
    final_content = final_content.replace('{{TARGET_PATH}}', target['FullPath']) # ìœˆë„ìš°/ë¦¬ëˆ…ìŠ¤ ì›ë³¸ ê²½ë¡œ
    
    # í˜¸í™˜ì„± ì¹˜í™˜
    final_content = final_content.replace('{SUBJECT}', project_name)
    final_content = final_content.replace('{SERVER_URL}', BRIDGE_API_URL)
    final_content = final_content.replace('{TARGET_PATH}', target['FullPath'].replace('\\', '/'))
    
    success, msg = send_rule_via_ssh(target['IPAddress'], target['Account'], final_content, target['FullPath'])
    if success:
        cursor.execute("UPDATE cline_FolderIndex SET LastRuleContent=%s WHERE FullPath=%s", (final_content, target['FullPath']))
        conn.commit()
    conn.close()
    return jsonify({'status': 'success' if success else 'error', 'message': msg})

@api_bp.route('/memos', methods=['POST']) # URL ë‹¨ìˆœí™”
def handle_memo_post():
    data = request.json
    p_name = data.get('project')
    p_path = data.get('path') # [ì¤‘ìš”] ê²½ë¡œ ê¸°ì¤€
    content = data.get('content')
    
    conn = get_db_connection()
    cursor = conn.cursor()
    # ê²½ë¡œ(ProjectPath)ë¥¼ Keyë¡œ Merge
    sql = "MERGE cline_ProjectMemos AS target USING (SELECT %s as PPath, %s as PName) AS source ON (target.ProjectPath = source.PPath) WHEN MATCHED THEN UPDATE SET MemoContent = %s, UpdatedAt = GETDATE() WHEN NOT MATCHED THEN INSERT (ProjectName, ProjectPath, MemoContent) VALUES (%s, %s, %s);"
    cursor.execute(sql, (p_path, p_name, content, p_name, p_path, content))
    conn.commit()
    conn.close()
    return jsonify({'status': 'success'})

@api_bp.route('/memos/get', methods=['POST']) # GET ëŒ€ì‹  POSTë¡œ ê²½ë¡œ ì „ë‹¬ (íŠ¹ìˆ˜ë¬¸ì ì´ìŠˆ ë°©ì§€)
def handle_memo_get():
    data = request.json
    p_path = data.get('path')
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT MemoContent FROM cline_ProjectMemos WHERE ProjectPath=%s", (p_path,))
    row = cursor.fetchone()
    conn.close()
    return jsonify({'content': row['MemoContent'] if row else ''})

@api_bp.route('/queue', methods=['GET', 'POST', 'DELETE'])
def handle_queue():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        p_path = request.args.get('path') # ì´ë¦„ ëŒ€ì‹  ê²½ë¡œë¡œ ì¡°íšŒ
        cursor.execute("SELECT * FROM cline_TaskQueue WHERE ProjectPath=%s AND Status IN ('Pending', 'Processing') ORDER BY TaskID", (p_path,))
        rows = cursor.fetchall()
        conn.close()
        return jsonify(rows)
    if request.method == 'POST':
        data = request.json
        p_name = data.get('project')
        p_path = data.get('path') # ê²½ë¡œ ì €ì¥
        content = data.get('content')
        cursor.execute("INSERT INTO cline_TaskQueue (ProjectName, ProjectPath, TaskContent) VALUES (%s, %s, %s)", (p_name, p_path, content))
        cursor.execute("UPDATE cline_FolderIndex SET TaskCount = TaskCount + 1, LastTaskDate = GETDATE() WHERE FullPath=%s", (p_path,))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})
    if request.method == 'DELETE':
        task_id = request.args.get('id')
        cursor.execute("DELETE FROM cline_TaskQueue WHERE TaskID=%s", (task_id,))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

@api_bp.route('/agent/next', methods=['POST'])
def agent_next_task():
    data = request.json
    # [ì¤‘ìš”] ì—ì´ì „íŠ¸ê°€ ìš”ì²­ ì‹œ 'path'ë¥¼ ë³´ë‚´ë©´ ë² ìŠ¤íŠ¸ì§€ë§Œ, 
    # ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•´ subject(ì´ë¦„)ë§Œ ì˜¤ë©´ ì´ë¦„ìœ¼ë¡œ ì°¾ë˜, 
    # ë§Œì•½ ì—ì´ì „íŠ¸ê°€ pathë„ ë³´ë‚´ì£¼ë©´(v2) pathë¡œ ì •í™•íˆ ì°¾ìŒ.
    project_name = data.get('subject')
    # í˜„ ë‹¨ê³„ì—ì„œëŠ” ë£°ì—ì„œ {SUBJECT}ë§Œ ì£¼ê³  ìˆìœ¼ë¯€ë¡œ ì´ë¦„ìœ¼ë¡œ ì°¾ì„ ìˆ˜ë°–ì— ì—†ìŒ.
    # ë‹¨, ë£°ì—ì„œ {TARGET_PATH}ë¥¼ ê°™ì´ ì¤˜ì„œ ì—ì´ì „íŠ¸ê°€ ìš”ì²­ì— í¬í•¨í•˜ê²Œ í•˜ë©´ ì™„ë²½í•¨.
    # ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ì´ë¦„ ë§¤ì¹­ ìœ ì§€ (ì¶”í›„ ì—ì´ì „íŠ¸ ë¡œì§ ê³ ë„í™” ê°€ëŠ¥)
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    # ì´ë¦„ìœ¼ë¡œ ì°¾ë˜, ProjectPathê°€ NULLì´ ì•„ë‹Œ ìµœì‹ ì‘ì—… ìš°ì„ 
    cursor.execute("SELECT TOP 1 TaskID, TaskContent, ProjectPath FROM cline_TaskQueue WHERE ProjectName=%s AND Status='Pending' ORDER BY TaskID ASC", (project_name,))
    task = cursor.fetchone()
    
    if task:
        cursor.execute("UPDATE cline_TaskQueue SET Status='Processing', StartedAt=GETDATE() WHERE TaskID=%s", (task['TaskID'],))
        conn.commit()
        conn.close()
        # [ì¤‘ìš”] ì—ì´ì „íŠ¸ì—ê²Œ ìˆ˜í–‰í•  ê²½ë¡œ(Path)ë¥¼ ì•Œë ¤ì¤„ ìˆ˜ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ì»¤ë§¨ë“œ ì•ì— 'cd ê²½ë¡œ &&' ë¶™ì—¬ì¤„ ìˆ˜ë„ ìˆìŒ
        return jsonify({"status": "ok", "log_id": task['TaskID'], "command": task['TaskContent'], "path": task['ProjectPath']})
    else:
        conn.close()
        return jsonify({"status": "wait"})

@api_bp.route('/agent/result', methods=['POST'])
def agent_submit_result():
    data = request.json
    task_id = data.get('log_id')
    result_content = data.get('result')
    project_name = data.get('subject')
    
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("UPDATE cline_TaskQueue SET Status='Done', CompletedAt=GETDATE(), ResultContent=%s WHERE TaskID=%s", (result_content, task_id))
    
    # í†µê³„ ì—…ë°ì´íŠ¸ (ì´ë¦„ ê¸°ì¤€)
    if project_name:
        cursor.execute("UPDATE cline_FolderIndex SET LastTaskDate=GETDATE() WHERE DisplayName=%s", (project_name,))
    conn.commit()
    conn.close()
    return jsonify({"status": "received"})
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(api_routes_code)


# ==========================================
# 4. Index HTML (app/templates/index.html)
#    - View ë²„íŠ¼ ì‚­ì œ
#    - ì´ë¦„ ì•„ë˜ ê²½ë¡œ(ë…¸ë€ìƒ‰) í‘œì‹œ
#    - JS í•¨ìˆ˜ë“¤ì´ Pathë¥¼ ì¸ìë¡œ ë°›ë„ë¡ ìˆ˜ì •
# ==========================================
print("4ï¸âƒ£ Index HTML ì—…ë°ì´íŠ¸ (UI ë””ìì¸ ë³€ê²½)...")

index_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>AI Bridge v5</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .table-dark { --bs-table-bg: #1e1e1e; }
        .table-hover tbody tr:hover { filter: brightness(1.2); transition: 0.2s; cursor: default; }
        .bg-active-job { background-color: #0f3d24 !important; color: #e8f5e9; border-left: 4px solid #00e676; }
        .bg-memo-exists { background-color: #0d3d52 !important; color: #e0f7fa; border-left: 4px solid #00bcd4; }
        .sticky-sidebar { position: sticky; top: 20px; height: calc(100vh - 40px); overflow-y: auto; }
        .stats-box { background: #252526; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
        .action-btns { display: flex; gap: 6px; flex-wrap: nowrap; }
        .modal-content { background-color: #252526; border: 1px solid #444; }
        
        /* [UI í•µì‹¬] ê²½ë¡œ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .project-path {
            font-size: 0.8rem;
            color: #ffc107 !important; /* ë…¸ë€ìƒ‰ */
            display: block;
            margin-top: 2px;
            font-family: monospace;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary py-3">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-warning" href="#"><i class="bi bi-robot"></i> CLINE BRIDGE v5</a>
            <div class="d-flex align-items-center gap-4 w-50">
                <input type="text" id="globalSearch" class="form-control bg-dark text-white border-secondary" placeholder="ğŸ” Search..." onkeyup="filterTable()">
            </div>
            <div class="d-flex align-items-center">
                <span class="me-3">Calls: <span class="fw-bold text-success">{{ total_calls }}</span></span>
                <a href="/settings" class="btn btn-outline-light btn-sm"><i class="bi bi-gear-fill"></i> Settings</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-2">
                <div class="sticky-sidebar">
                    <div class="stats-box">
                        <h6 class="text-secondary"><i class="bi bi-grid-fill"></i> Groups</h6>
                        <div id="groupStats" class="mt-2 small">Loading...</div>
                    </div>
                    <div class="stats-box">
                        <h6 class="text-secondary"><i class="bi bi-lightning-fill"></i> Active Queues</h6>
                        <div id="activeStats" class="mt-2 small text-warning">None</div>
                    </div>
                </div>
            </div>

            <div class="col-md-10">
                <table class="table table-dark table-hover align-middle shadow-sm" id="projectTable">
                    <thead>
                        <tr class="text-secondary text-uppercase small">
                            <th>Group</th>
                            <th>Project & Path</th> <th>Last Active</th>
                            <th>Calls</th>
                            <th style="min-width: 280px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in projects %}
                        <tr class="{{ 'bg-active-job' if p.IsQueued else ('bg-memo-exists' if p.HasMemo else '') }}">
                            <td><span class="badge bg-secondary opacity-50">{{ p.GroupName }}</span></td>
                            <td>
                                <div class="fw-bold text-white" style="font-size: 1.05rem;">{{ p.DisplayName }}</div>
                                <div class="project-path">{{ p.FullPath }}</div>
                            </td>
                            <td class="small opacity-75">{{ p.LastTaskDate }}</td>
                            <td class="fw-bold opacity-75">{{ p.TaskCount }}</td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn btn-primary btn-sm" onclick="openVsCode('{{ p.IPAddress }}', '{{ p.Account }}', '{{ p.FullPath }}')" title="Code"><i class="bi bi-code-slash"></i></button>
                                    <button class="btn btn-success btn-sm" onclick="openTaskModal('{{ p.DisplayName }}', '{{ p.FullPath }}')" title="Task"><i class="bi bi-plus-lg"></i> Task</button>
                                    <button class="btn btn-info btn-sm" onclick="openRuleModal('{{ p.DisplayName }}', '{{ p.FullPath }}')" title="Rule"><i class="bi bi-send"></i> Rule</button>
                                    <button class="btn btn-secondary btn-sm" onclick="openMemoModal('{{ p.DisplayName }}', '{{ p.FullPath }}')" title="Memo"><i class="bi bi-sticky"></i></button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Task Manager - <span id="modalProjectName" class="text-warning"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-secondary mb-2">Queue</h6>
                    <ul class="list-group bg-dark mb-4" id="currentQueueList"></ul>
                    <div class="form-group">
                        <textarea class="form-control bg-dark text-white border-secondary" id="taskContent" rows="3" placeholder="Command..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary"><button class="btn btn-success" onclick="submitTask()">Add</button></div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="ruleModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Deploy Rule</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Project: <span id="ruleProjectName" class="fw-bold"></span></p><select class="form-select bg-dark text-white mb-2" id="ruleSelect"></select></div><div class="modal-footer"><button class="btn btn-info" onclick="deployRule()">Deploy</button></div></div></div></div>
    <div class="modal fade" id="memoModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Memo</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea class="form-control bg-dark text-white" id="memoContent" rows="10"></textarea></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveMemo()">Save</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global Vars
        let currentProject = '';
        let currentPath = ''; // [ì¤‘ìš”] ê²½ë¡œ ì €ì¥ìš© ë³€ìˆ˜ ì¶”ê°€
        
        const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
        const ruleModal = new bootstrap.Modal(document.getElementById('ruleModal'));
        const memoModal = new bootstrap.Modal(document.getElementById('memoModal'));

        document.addEventListener('DOMContentLoaded', () => { updateDashboardStats(); setInterval(updateDashboardStats, 5000); });

        function filterTable() {
            const input = document.getElementById('globalSearch').value.toUpperCase();
            const tr = document.getElementById('projectTable').getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                let txt = tr[i].textContent || tr[i].innerText;
                tr[i].style.display = txt.toUpperCase().indexOf(input) > -1 ? "" : "none";
            }
        }

        function updateDashboardStats() {
            fetch('/api/stats/dashboard').then(r => r.json()).then(data => {
                document.getElementById('groupStats').innerHTML = data.groups.map(g => `<div class="d-flex justify-content-between"><span>${g.GroupName}</span> <span class="badge bg-dark border">${g.Cnt}</span></div>`).join('');
                document.getElementById('activeStats').innerHTML = data.active.length ? data.active.map(a => `<div class="d-flex justify-content-between"><span>${a.GroupName}</span> <span class="badge bg-warning text-dark">${a.Cnt}</span></div>`).join('') : 'None';
            });
        }

        // --- Task Functions (Path ê¸°ë°˜) ---
        function openTaskModal(name, path) {
            currentProject = name;
            currentPath = path;
            document.getElementById('modalProjectName').innerText = name;
            document.getElementById('taskContent').value = ''; 
            loadQueue(path); // ê²½ë¡œë¡œ ì¡°íšŒ
            taskModal.show();
        }

        function loadQueue(path) {
            // íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬ë¥¼ ìœ„í•´ encodeURIComponent ì‚¬ìš©
            fetch(`/api/queue?path=${encodeURIComponent(path)}`).then(r => r.json()).then(tasks => {
                const list = document.getElementById('currentQueueList');
                list.innerHTML = tasks.length ? tasks.map(t => `
                    <li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center">
                        <div><span class="badge bg-warning text-dark me-2">${t.Status}</span> ${t.TaskContent.substring(0, 50)}...</div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${t.TaskID})"><i class="bi bi-trash"></i></button>
                    </li>`).join('') : '<li class="list-group-item bg-dark text-secondary text-center">Empty</li>';
            });
        }

        function submitTask() {
            const content = document.getElementById('taskContent').value;
            if(!content) return;
            fetch('/api/queue', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({project: currentProject, path: currentPath, content}) 
            }).then(() => {
                document.getElementById('taskContent').value = '';
                loadQueue(currentPath);
                updateDashboardStats();
            });
        }
        
        function deleteTask(id) {
            if(!confirm('Delete?')) return;
            fetch(`/api/queue?id=${id}`, { method: 'DELETE' }).then(() => loadQueue(currentPath));
        }

        // --- Other Actions ---
        function openVsCode(ip, account, path) {
            fetch('/api/open_vscode', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ip, account, path}) });
        }

        function openRuleModal(name, path) {
            currentProject = name;
            currentPath = path;
            document.getElementById('ruleProjectName').innerText = name;
            fetch('/api/rules').then(r => r.json()).then(rules => {
                document.getElementById('ruleSelect').innerHTML = rules.map(r => `<option value="${r.RuleID}">${r.RuleName}</option>`).join('');
                ruleModal.show();
            });
        }

        function deployRule() {
            const ruleId = document.getElementById('ruleSelect').value;
            fetch('/api/rules/deploy', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({project_name: currentProject, project_path: currentPath, rule_id: ruleId}) 
            }).then(r => r.json()).then(res => { alert(res.message); ruleModal.hide(); });
        }

        function openMemoModal(name, path) {
            currentProject = name;
            currentPath = path;
            // GET ë°©ì‹ ëŒ€ì‹  POSTë¡œ Path ì „ë‹¬ (ê²½ë¡œ ë‚´ ìŠ¬ë˜ì‹œ ë“± íŠ¹ìˆ˜ë¬¸ì ì•ˆì „ ì²˜ë¦¬)
            fetch('/api/memos/get', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: currentPath})
            }).then(r => r.json()).then(d => {
                document.getElementById('memoContent').value = d.content;
                memoModal.show();
            });
        }

        function saveMemo() {
            const content = document.getElementById('memoContent').value;
            fetch('/api/memos', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({project: currentProject, path: currentPath, content}) 
            }).then(() => { memoModal.hide(); location.reload(); });
        }
    </script>
</body>
</html>
"""
with open(os.path.join(base_dir, "app", "templates", "index.html"), "w", encoding="utf-8") as f:
    f.write(index_html)


print("\nâœ… v5 ì—…ë°ì´íŠ¸ ì™„ë£Œ!")
print("1. DB: Task/Memo í…Œì´ë¸”ì— ProjectPath ì¶”ê°€ë¨.")
print("2. ë¡œì§: ì´ë¦„ì´ ê°™ì•„ë„ 'ê²½ë¡œ'ê°€ ë‹¤ë¥´ë©´ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ë¡œ ì¸ì‹.")
print("3. UI: View ë²„íŠ¼ ì‚­ì œ -> ì´ë¦„ ì•„ë˜ì— ë…¸ë€ìƒ‰ìœ¼ë¡œ ì „ì²´ ê²½ë¡œ í‘œì‹œ.")
print("ğŸ‘‰ 'python3 runcline/run_bridge.py' ì‹¤í–‰í•˜ì„¸ìš”.")