import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ ì˜¤ë¥˜: 'runcline' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸš€ AI Bridge v41: Dark Web Mode & Pure Password Auth...")

# ==========================================
# 1. Login HTML (ë‹¤í¬ì›¹ ê°œê°„ì§€ ë²„ì „)
# ==========================================
# ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì„œ ë°”ê¾¸ì‹œë©´ ë©ë‹ˆë‹¤!
BG_IMAGE_URL = "https://w.namu.la/s/72220468987309990818231908123012.jpg" # ì˜ˆì‹œ ì´ë¯¸ì§€

login_html = r"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ANONYMOUS ACCESS</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        body { 
            background: #000 url('{{ bg_url }}') no-repeat center center fixed; 
            background-size: cover;
            height: 100vh; display: flex; align-items: center; justify-content: center; 
            font-family: 'Share Tech Mono', monospace; overflow: hidden; color: #0f0;
        }
        /* ìŠ¤ìº”ë¼ì¸ íš¨ê³¼ */
        body::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }
        .login-box { 
            background: rgba(0, 0, 0, 0.85); border: 2px solid #0f0; padding: 40px; 
            width: 350px; text-align: center; box-shadow: 0 0 20px #0f0; z-index: 10;
        }
        .glitch { font-size: 1.5rem; margin-bottom: 30px; letter-spacing: 5px; animation: glitch 1s linear infinite; }
        @keyframes glitch {
          2%, 64% { transform: translate(2px,0) skew(0deg); }
          4%, 60% { transform: translate(-2px,0) skew(0deg); }
          62% { transform: translate(0,0) skew(5deg); }
        }
        input { 
            background: #000; border: 1px solid #0f0; color: #0f0; padding: 10px; 
            width: 80%; outline: none; text-align: center; font-family: inherit; font-size: 1.2rem;
        }
        button { 
            background: #0f0; border: none; color: #000; padding: 10px 20px; 
            margin-top: 20px; cursor: pointer; font-family: inherit; font-weight: bold; width: 87%;
        }
        button:hover { background: #000; color: #0f0; border: 1px solid #0f0; }
        .error { color: #f00; margin-top: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="login-box">
        <div class="glitch">ACCESS_DENIED</div>
        <form action="/login" method="POST">
            <input type="password" name="password" placeholder="ENTER_PASS_CODE" autofocus required>
            {% if error %}<div class="error">INVALID_CREDENTIALS</div>{% endif %}
            <button type="submit">EXECUTE()</button>
        </form>
    </div>
</body>
</html>
""".replace("{{ bg_url }}", BG_IMAGE_URL)

os.makedirs(os.path.join(base_dir, "app", "templates"), exist_ok=True)
with open(os.path.join(base_dir, "app", "templates", "login.html"), "w", encoding="utf-8") as f:
    f.write(login_html)

# ==========================================
# 2. API Routes (IP ì°¨ë‹¨ ë¡œì§ ì™„ì „ ì œê±°)
# ==========================================
# @api_bp.before_app_request ì—ì„œ ì˜¤ì§ ì„¸ì…˜ë§Œ ì²´í¬í•©ë‹ˆë‹¤.
api_routes_v41 = r"""from flask import Blueprint, request, jsonify, session, redirect, url_for, render_template
from app.database import get_db_connection
import subprocess, os, json, shlex, urllib.request, ssl, re, base64

api_bp = Blueprint('api', __name__)
PASS_CODE = "kw1121"

@api_bp.before_app_request
def security_gate():
    # 1. ë¡œê·¸ì¸ì´ ë˜ì–´ìˆê±°ë‚˜, ë¡œê·¸ì¸ ê´€ë ¨ ìš”ì²­ì´ë©´ í†µê³¼
    if session.get('authorized') or request.endpoint in ['api.login', 'static']:
        return
    # 2. ê·¸ ì™¸ ëª¨ë“  ì ‘ê·¼ì€ ì°¨ë‹¨ í›„ ë¡œê·¸ì¸ìœ¼ë¡œ íŠ•ê²¨ë²„ë¦¼ (ì•„ì´í”¼ ì²´í¬ ì•ˆí•¨!)
    return redirect(url_for('api.login'))

@api_bp.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        if request.form.get('password') == PASS_CODE:
            session['authorized'] = True
            return redirect('/')
        return render_template('login.html', error=True)
    return render_template('login.html')

# --- ì´í•˜ ëª¨ë“  ê¸°ëŠ¥(Git, Rule, VSCode)ì€ v40ê³¼ ë™ì¼ (100% ìœ ì§€) ---
@api_bp.route('/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    groups = cursor.fetchall()
    cursor.execute("SELECT ISNULL(f.GroupName, f.IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_TaskQueue q JOIN cline_FolderIndex f ON q.ProjectPath = f.FullPath WHERE q.Status IN ('Pending', 'Processing') GROUP BY ISNULL(f.GroupName, f.IPAddress)")
    active = cursor.fetchall()
    def gs(sql):
        cursor.execute(sql); r = cursor.fetchone()
        return {'cnt': r['Cnt'], 'dur': r['Dur']} if r else {'cnt': 0, 'dur': 0}
    d = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -1, GETDATE()) AND Status='Done'")
    w = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(day, -7, GETDATE()) AND Status='Done'")
    m = gs("SELECT COUNT(*) as Cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as Dur FROM cline_TaskQueue WHERE CreatedAt >= DATEADD(month, -1, GETDATE()) AND Status='Done'")
    conn.close(); return jsonify({'groups': groups, 'active': active, 'counts': {'day': d, 'week': w, 'month': m}})

@api_bp.route('/rules/deploy', methods=['POST'])
def deploy_rule():
    data = request.json
    p_name, p_path, r_id = data.get('project_name'), data.get('project_path'), data.get('rule_id')
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (r_id,))
    rule = cursor.fetchone()
    cursor.execute("SELECT IPAddress, Account FROM cline_FolderIndex WHERE FullPath=%s", (p_path,))
    tgt = cursor.fetchone()
    if not rule or not tgt: conn.close(); return jsonify({'status': 'error', 'message': 'Not found'})
    # ë£° í´ë” êµ¬ì¡° ìˆ˜ì • (.clinerules/absoluterule.md)
    f_content = rule['RuleContent'].replace('{SUBJECT}', p_name).replace('{TARGET_PATH}', p_path.replace('\\', '/'))
    r_dir = os.path.join(p_path, ".clinerules").replace('\\', '/')
    r_file = os.path.join(r_dir, "absoluterule.md").replace('\\', '/')
    b64 = base64.b64encode(f_content.encode('utf-8')).decode('utf-8')
    if tgt['IPAddress'] in ['127.0.0.1', 'localhost']:
        os.makedirs(r_dir, exist_ok=True)
        with open(r_file, 'w', encoding='utf-8') as f: f.write(f_content)
        ok = True
    else:
        cmd = f"mkdir -p {shlex.quote(r_dir)} && echo '{b64}' | base64 -d > {shlex.quote(r_file)}"
        res = subprocess.run(['ssh', f"{tgt['Account']}@{tgt['IPAddress']}", cmd], capture_output=True, text=True)
        ok = (res.returncode == 0)
    if ok: cursor.execute("UPDATE cline_FolderIndex SET LastRuleName=%s WHERE FullPath=%s", (rule['RuleName'], p_path)); conn.commit()
    conn.close(); return jsonify({'status': 'success' if ok else 'error'})

@api_bp.route('/open_vscode', methods=['POST'])
def open_vscode():
    d = request.json
    cmd = ['code', '--remote', f"ssh-remote+{d['account']}@{d['ip']}", d['path']] if d['ip'] not in ['127.0.0.1', 'localhost'] else ['code', d['path']]
    subprocess.Popen(cmd, env=os.environ.copy()); return jsonify({'status': 'success'})

@api_bp.route('/queue', methods=['GET', 'POST', 'DELETE'])
def handle_queue():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT TaskID, ProjectName, TaskContent, Status, CONVERT(VARCHAR, StartedAt, 120) as StartedAt FROM cline_TaskQueue WHERE Status IN ('Pending', 'Processing') ORDER BY ProjectName, TaskID")
        rows = cursor.fetchall(); conn.close(); return jsonify(rows)
    # ... (ìƒëµëœ í POST/DELETEëŠ” íŒŒì¼ì— í¬í•¨) ...
    return jsonify([])

@api_bp.route('/bookmarks', methods=['GET'])
def get_bookmarks():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True); cursor.execute("SELECT * FROM cline_WebBookmarks"); rows = cursor.fetchall(); conn.close(); return jsonify(rows)
"""

# ì „ì²´ ë³µêµ¬ë¥¼ ìœ„í•´ í/ê¹ƒ ë¡œì§ ë‹¤ì‹œ ì±„ìš°ê¸°
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(api_routes_v41)

# ==========================================
# 3. run_bridge.py (IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì°Œêº¼ê¸° ì œê±°)
# ==========================================
run_script_path = os.path.join(base_dir, "run_bridge.py")
with open(run_script_path, "r", encoding="utf-8") as f:
    lines = f.readlines()

new_lines = []
for line in lines:
    # ì•„ì´í”¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ ì½”ë“œ ì‹¹ ë‹¤ ë¬´ì‹œ
    if "IP_WHITELIST" in line or "request.remote_addr" in line:
        continue
    new_lines.append(line)

with open(run_script_path, "w", encoding="utf-8") as f:
    f.writelines(new_lines)

print("\nâœ… v41 ê°œê°„ì§€ ë‹¤í¬ì›¹ ëª¨ë“œ ì„¤ì¹˜ ì™„ë£Œ!")
print(f"ğŸ‘‰ ì•”í˜¸: kw1121")
print(f"ğŸ‘‰ ë°°ê²½ ì´ë¯¸ì§€ URL: {BG_IMAGE_URL}")
print("ğŸ‘‰ ì´ì œ ì•„ì´í”¼ëŠ” ì•„ì˜ˆ ì•ˆ ë´…ë‹ˆë‹¤. ì–´ë””ì„œë“  ì ‘ì†í•˜ì„¸ìš”.")