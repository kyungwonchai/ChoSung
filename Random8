ë˜ ì½”ë“œëŠ” í•´ë‹¹ ë²„ê·¸ë¥¼ ìˆ˜ì •í•œ ì™„ì „í•œ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. ì´ê²ƒë§Œ ë‹¤ì‹œ í•œ ë²ˆ ì‹¤í–‰í•´ ì£¼ì‹œë©´ ì¦‰ì‹œ í•´ê²°ë©ë‹ˆë‹¤.

fix_app.py
(ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ NetworkFolderIndexer/app.pyê°€ ì •ìƒì ì¸ ì½”ë“œë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.)

Python

import os

# app.pyì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì—¬ ë‹¤ì‹œ ì‘ì„±í•©ë‹ˆë‹¤.
# ìˆ˜ì •ì‚¬í•­: else ë¸”ë¡(ì›ê²© ì ‘ì†)ì—ì„œ mode_msg ë³€ìˆ˜ ì •ì˜ ì¶”ê°€

new_app_code = r"""from flask import Flask, render_template, request, jsonify
import pymssql
import subprocess
import os
import socket

app = Flask(__name__)

# ================= CONFIGURATION =================
DB_HOST = '192.168.0.10'
DB_USER = 'sa'
DB_PASSWORD = 'password'
DB_NAME = 'MyDatabase'
# =================================================

def get_db_connection():
    return pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)

def get_local_ip():
    """í˜„ì¬ PCì˜ IP ì£¼ì†Œë¥¼ í™•ì¸í•©ë‹ˆë‹¤."""
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        # ì™¸ë¶€ë§ì— ì—°ê²° ì‹œë„ (ì‹¤ì œ íŒ¨í‚· ì „ì†¡ X)í•˜ì—¬ IP í™•ì¸
        s.connect(('10.255.255.255', 1))
        IP = s.getsockname()[0]
    except Exception:
        IP = '127.0.0.1'
    finally:
        s.close()
    return IP

@app.route('/')
def index():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT IPAddress, Account, DisplayName, FullPath, CONVERT(VARCHAR, LastUpdated, 120) as LastUpdated FROM FolderIndex ORDER BY LastUpdated DESC")
    rows = cursor.fetchall()
    conn.close()
    return render_template('index.html', folders=rows)

@app.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    target_ip = data.get('ip')
    user = data.get('account')
    path = data.get('path')

    local_ip = get_local_ip()
    
    # ê¸°ë³¸ ëª…ë ¹ì–´: ìƒŒë“œë°•ìŠ¤ í•´ì œ, ìƒˆ ì°½ ê°•ì œ
    cmd = ['code', '--no-sandbox', '--new-window']
    mode_msg = "" # ë³€ìˆ˜ ì´ˆê¸°í™”

    # ë¡œì»¬ vs ì›ê²© íŒë‹¨
    if target_ip == local_ip or target_ip in ['127.0.0.1', 'localhost']:
        print(f"Adding Local Path: {path}")
        cmd.append(path)
        mode_msg = "Local Direct"
    else:
        # ì›ê²©ì§€ì¸ ê²½ìš° SSH Remote ì‚¬ìš©
        remote_arg = f"ssh-remote+{user}@{target_ip}"
        print(f"Adding Remote Path: {remote_arg} {path}")
        cmd.extend(['--remote', remote_arg, path])
        mode_msg = "Remote SSH" # <--- [ìˆ˜ì •ë¨] ì´ ë¶€ë¶„ì´ ë¹ ì ¸ì„œ ì—ëŸ¬ê°€ ë‚¬ì—ˆìŠµë‹ˆë‹¤.

    try:
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (DISPLAY=:0 ê°•ì œ)
        my_env = os.environ.copy()
        if 'DISPLAY' not in my_env:
            my_env['DISPLAY'] = ':0'

        # ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¡œ VS Code ì‹¤í–‰
        subprocess.Popen(cmd, env=my_env)
        
        return jsonify({
            'status': 'success', 
            'message': f'[{mode_msg}] Opening {path} on {target_ip}'
        })
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
"""

def fix_app():
    target_path = os.path.join("NetworkFolderIndexer", "app.py")
    
    if not os.path.exists("NetworkFolderIndexer"):
        print("âŒ ì˜¤ë¥˜: 'NetworkFolderIndexer' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    with open(target_path, "w", encoding="utf-8") as f:
        f.write(new_app_code)
        
    print(f"âœ… ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ: {target_path}")
    print("ğŸ‘‰ ë‹¤ì‹œ 'python3 app.py'ë¥¼ ì‹¤í–‰í•´ ë³´ì„¸ìš”.")

if __name__ == "__main__":
    fix_app()