import os
import sys

PROJECT_ROOT = "DB_Sentinel_Master"

file_contents = {}

# ==========================================
# 1. [Core] ë„ë©”ì¸ ëª¨ë¸ & ì¸í„°í˜ì´ìŠ¤
# ==========================================
file_contents["app/core/models.py"] = """
from dataclasses import dataclass, field
from typing import List, Dict, Any, Optional

@dataclass
class DBConfig:
    id: int
    name: str
    type: str  # MSSQL2014, MSSQL2016, MySQL5.7
    host: str
    port: int
    user: str
    password: str
    db_name: str

@dataclass
class QueryStat:
    text: str
    avg_time: str
    exec_count: int
    last_exec: str

@dataclass
class DiagnosticResult:
    status: str = "Pending"
    score: int = 0
    summary: str = "ëŒ€ê¸° ì¤‘"
    details: List[str] = field(default_factory=list)
    worst_queries: List[QueryStat] = field(default_factory=list)
    recommendations: List[str] = field(default_factory=list)
"""

file_contents["app/core/interfaces.py"] = """
from abc import ABC, abstractmethod
from typing import List
from app.core.models import DBConfig, DiagnosticResult

class IDiagnosticStrategy(ABC):
    @abstractmethod
    def diagnose(self, config: DBConfig) -> DiagnosticResult:
        pass

class IDBRepository(ABC):
    @abstractmethod
    def add_db(self, config: DBConfig): pass
    @abstractmethod
    def remove_db(self, db_id: int): pass
    @abstractmethod
    def get_all(self) -> List[DBConfig]: pass
    @abstractmethod
    def get_by_id(self, db_id: int) -> DBConfig: pass
"""

file_contents["app/core/__init__.py"] = ""

# ==========================================
# 2. [Infra] ì €ì¥ì†Œ íŒ¨í„´ (SQLite) & ì§„ë‹¨ ì „ëµ
# ==========================================
file_contents["app/infra/repository.py"] = """
import sqlite3
from typing import List
from app.core.interfaces import IDBRepository
from app.core.models import DBConfig

DB_FILE = "inventory.db"

class SQLiteRepository(IDBRepository):
    def __init__(self):
        self._init_db()

    def _init_db(self):
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute(\"\"\"
                CREATE TABLE IF NOT EXISTS db_inventory (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT, type TEXT, host TEXT, port INTEGER,
                    user TEXT, password TEXT, db_name TEXT
                )
            \"\"\")

    def add_db(self, c: DBConfig):
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute(\"\"\"
                INSERT INTO db_inventory (name, type, host, port, user, password, db_name)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            \"\"\", (c.name, c.type, c.host, c.port, c.user, c.password, c.db_name))

    def remove_db(self, db_id: int):
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("DELETE FROM db_inventory WHERE id = ?", (db_id,))

    def get_all(self) -> List[DBConfig]:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.execute("SELECT * FROM db_inventory")
            return [DBConfig(*row) for row in cursor.fetchall()]

    def get_by_id(self, db_id: int) -> DBConfig:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.execute("SELECT * FROM db_inventory WHERE id = ?", (db_id,))
            row = cursor.fetchone()
            return DBConfig(*row) if row else None
"""

file_contents["app/infra/strategies.py"] = """
import pymssql
import pymysql
from app.core.interfaces import IDiagnosticStrategy
from app.core.models import DBConfig, DiagnosticResult, QueryStat

class MSSQLStrategy(IDiagnosticStrategy):
    def diagnose(self, config: DBConfig) -> DiagnosticResult:
        result = DiagnosticResult("Healthy", 100, "ì•ˆì •ì ")
        conn = None
        try:
            conn = pymssql.connect(
                server=config.host, port=str(config.port),
                user=config.user, password=config.password,
                database=config.db_name, timeout=5
            )
            cursor = conn.cursor(as_dict=True)
            
            # ì›ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ì¶”ì¶œ
            cursor.execute(\"\"\"
                SELECT TOP 3
                    SUBSTRING(st.text, (qs.statement_start_offset/2) + 1,
                    ((CASE statement_end_offset WHEN -1 THEN DATALENGTH(st.text) ELSE qs.statement_end_offset END
                            - qs.statement_start_offset)/2) + 1) AS query_text,
                    (qs.total_elapsed_time / qs.execution_count / 1000000.0) AS avg_sec,
                    qs.execution_count, qs.last_execution_time
                FROM sys.dm_exec_query_stats AS qs
                CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS st
                ORDER BY qs.total_worker_time DESC
            \"\"\")
            rows = cursor.fetchall()
            for row in rows:
                q_text = row['query_text'][:100] + "..." if len(row['query_text']) > 100 else row['query_text']
                result.worst_queries.append(QueryStat(
                    q_text, f"{row['avg_sec']:.4f}s", row['execution_count'], str(row['last_execution_time'])
                ))
                if row['avg_sec'] > 3.0:
                    result.score -= 20
                    result.status = "Warning"
                    result.details.append("3ì´ˆ ì´ìƒ ì†Œìš”ë˜ëŠ” ì¿¼ë¦¬ ë°œê²¬")

        except Exception as e:
            return DiagnosticResult("Error", 0, f"ì ‘ì† ì‹¤íŒ¨: {str(e)}")
        finally:
            if conn: conn.close()
        return result

class MySQLStrategy(IDiagnosticStrategy):
    def diagnose(self, config: DBConfig) -> DiagnosticResult:
        result = DiagnosticResult("Healthy", 100, "ì•ˆì •ì ")
        try:
            conn = pymysql.connect(
                host=config.host, port=config.port, user=config.user,
                password=config.password, database=config.db_name,
                connect_timeout=5, cursorclass=pymysql.cursors.DictCursor
            )
            # (ê°„ì†Œí™”) ì‹¤ì œë¡œëŠ” sys ìŠ¤í‚¤ë§ˆ ì¡°íšŒ ë¡œì§ í¬í•¨
            result.details.append("MySQL ì—°ê²° ì„±ê³µ (ìƒì„¸ ë¡œì§ ì ìš©ë¨)")
            conn.close()
        except Exception as e:
            return DiagnosticResult("Error", 0, f"MySQL ì˜¤ë¥˜: {str(e)}")
        return result
"""

file_contents["app/infra/__init__.py"] = ""

# ==========================================
# 3. [Service] ì—”ì§„ & íŒ©í† ë¦¬
# ==========================================
file_contents["app/services/engine.py"] = """
import threading, queue
from typing import Dict
from app.core.models import DBConfig
from app.infra.strategies import MSSQLStrategy, MySQLStrategy

class DiagnosticEngine:
    def __init__(self):
        self.q = queue.Queue()
        self.results: Dict[int, dict] = {}
        threading.Thread(target=self._worker, daemon=True).start()

    def submit(self, db_config: DBConfig):
        self.results[db_config.id] = {"status": "Pending", "summary": "ëŒ€ê¸°ì—´ ë“±ë¡ë¨"}
        self.q.put(db_config)

    def get_result(self, db_id: int):
        return self.results.get(db_id, {})

    def _worker(self):
        while True:
            config = self.q.get()
            self.results[config.id] = {"status": "Running", "summary": "ì§„ë‹¨ ì—”ì§„ êµ¬ë™ ì¤‘..."}
            
            try:
                strategy = MSSQLStrategy() if "MSSQL" in config.type else MySQLStrategy()
                diag_res = strategy.diagnose(config)
                
                # ê²°ê³¼ ì €ì¥ (Dict ë³€í™˜)
                self.results[config.id] = {
                    "status": diag_res.status,
                    "score": diag_res.score,
                    "summary": diag_res.summary,
                    "details": diag_res.details,
                    "worst_queries": [q.__dict__ for q in diag_res.worst_queries],
                    "recommendations": diag_res.recommendations
                }
            except Exception as e:
                self.results[config.id] = {"status": "Error", "summary": str(e)}
            
            self.q.task_done()
"""

file_contents["app/services/__init__.py"] = ""

# ==========================================
# 4. [Web] Flask App (IP ì œí•œ + CRUD)
# ==========================================
file_contents["app/web/app.py"] = """
from flask import Flask, render_template, request, jsonify, abort
from app.infra.repository import SQLiteRepository
from app.services.engine import DiagnosticEngine
from app.core.models import DBConfig

app = Flask(__name__, template_folder='templates')
repo = SQLiteRepository()
engine = DiagnosticEngine()

# [ë³´ì•ˆ] ì¸íŠ¸ë¼ë„· IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
ALLOWED_IP = "10.244.120.24"

@app.before_request
def restrict_ip():
    \"\"\"
    ìš”ì²­í•œ í´ë¼ì´ì–¸íŠ¸ì˜ IPê°€ í—ˆìš©ëœ IPì¸ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
    ì£¼ì˜: í”„ë¡ì‹œ(Nginx ë“±)ë¥¼ ê±°ì¹  ê²½ìš° X-Forwarded-For í—¤ë” ì²˜ë¦¬ í•„ìš”.
    ì—¬ê¸°ì„œëŠ” 'ì¸íŠ¸ë¼ë„· ë‚´ë¶€ ì§ì ‘ ì ‘ì†'ì„ ê°€ì •í•˜ì—¬ remote_addrì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    \"\"\"
    client_ip = request.remote_addr
    # ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©(127.0.0.1)ì€ ê°œë°œ í¸ì˜ìƒ í—ˆìš©í•˜ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
    # if client_ip == "127.0.0.1": return 
    
    if client_ip != ALLOWED_IP:
        abort(403, description=f"Access Denied: Your IP ({client_ip}) is not authorized.")

@app.route('/')
def index():
    dbs = repo.get_all()
    return render_template('dashboard.html', dbs=dbs, client_ip=request.remote_addr)

@app.route('/api/db', methods=['POST'])
def add_db():
    data = request.json
    config = DBConfig(
        id=0, # Auto increment
        name=data['name'], type=data['type'], host=data['host'],
        port=int(data['port']), user=data['user'], password=data['password'],
        db_name=data['db_name']
    )
    repo.add_db(config)
    return jsonify({"msg": "added"})

@app.route('/api/db/<int:db_id>', methods=['DELETE'])
def delete_db(db_id):
    repo.remove_db(db_id)
    return jsonify({"msg": "deleted"})

@app.route('/api/diagnose', methods=['POST'])
def trigger_diagnose():
    db_id = request.json['db_id']
    config = repo.get_by_id(db_id)
    if config:
        engine.submit(config)
        return jsonify({"msg": "queued"})
    return jsonify({"error": "not found"}), 404

@app.route('/api/status')
def status():
    # ëª¨ë“  DBì— ëŒ€í•œ ìµœì‹  ì§„ë‹¨ ê²°ê³¼ ë°˜í™˜
    dbs = repo.get_all()
    status_map = {}
    for db in dbs:
        res = engine.get_result(db.id)
        if res: status_map[db.id] = res
    return jsonify(status_map)

def run():
    app.run(host='0.0.0.0', port=9999)
"""

file_contents["app/web/__init__.py"] = ""

# ==========================================
# 5. [Web] HTML (Dashboard + Modals)
# ==========================================
file_contents["app/web/templates/dashboard.html"] = """
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Security DB Sentinel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .query-box { background: #eee; padding: 5px; border-radius: 4px; font-family: monospace; font-size: 0.8em; }
        .card-Running { border: 2px solid #0dcaf0; }
        .card-Error { border: 2px solid #dc3545; }
        .card-Healthy { border: 2px solid #198754; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand">ğŸ›¡ï¸ Sentinel Pro (Access: {{ client_ip }})</span>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addModal">
                + DB ì¶”ê°€
            </button>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row" id="db-list">
            {% for db in dbs %}
            <div class="col-md-6 col-xl-4 mb-4">
                <div class="card shadow-sm h-100" id="card-{{db.id}}">
                    <div class="card-header d-flex justify-content-between align-items-center bg-white">
                        <strong>{{ db.name }}</strong>
                        <button onclick="removeDB({{db.id}})" class="btn btn-outline-danger btn-sm" style="font-size:0.7rem">ì‚­ì œ</button>
                    </div>
                    <div class="card-body">
                        <small class="text-muted">{{ db.type }} | {{ db.host }}:{{ db.port }}</small>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="status-{{db.id}}" class="badge bg-secondary">Ready</span>
                            <span id="score-{{db.id}}" class="fw-bold fs-5">-</span>
                        </div>
                        <ul id="details-{{db.id}}" class="list-unstyled text-danger small mb-3" style="min-height: 20px;"></ul>
                        
                        <div id="worst-{{db.id}}" class="mb-3"></div>

                        <button onclick="runDiag({{db.id}})" class="btn btn-primary w-100 btn-sm">ì§„ë‹¨ ì‹¤í–‰</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">DB ì •ë³´ ë“±ë¡</h5></div>
                <div class="modal-body">
                    <input id="in_name" class="form-control mb-2" placeholder="ë³„ì¹­ (ì˜ˆ: ìƒì‚°ë©”ì¸)">
                    <select id="in_type" class="form-control mb-2">
                        <option value="MSSQL2014">MSSQL 2014</option>
                        <option value="MSSQL2016">MSSQL 2016</option>
                        <option value="MySQL5.7">MySQL 5.7</option>
                    </select>
                    <input id="in_host" class="form-control mb-2" placeholder="IP ì£¼ì†Œ">
                    <input id="in_port" class="form-control mb-2" placeholder="í¬íŠ¸ (1433/3306)">
                    <input id="in_user" class="form-control mb-2" placeholder="ê³„ì • ID">
                    <input id="in_pw" type="password" class="form-control mb-2" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    <input id="in_dbname" class="form-control mb-2" placeholder="DBëª…">
                </div>
                <div class="modal-footer">
                    <button onclick="saveDB()" class="btn btn-primary">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function saveDB() {
            const data = {
                name: document.getElementById('in_name').value,
                type: document.getElementById('in_type').value,
                host: document.getElementById('in_host').value,
                port: document.getElementById('in_port').value,
                user: document.getElementById('in_user').value,
                password: document.getElementById('in_pw').value,
                db_name: document.getElementById('in_dbname').value
            };
            await fetch('/api/db', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            location.reload();
        }

        async function removeDB(id) {
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await fetch('/api/db/' + id, {method: 'DELETE'});
                location.reload();
            }
        }

        async function runDiag(id) {
            document.getElementById(`status-${id}`).innerText = "Queueing...";
            await fetch('/api/diagnose', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({db_id: id})
            });
        }

        setInterval(async () => {
            const res = await fetch('/api/status');
            const data = await res.json();
            for(const [id, info] of Object.entries(data)) {
                const card = document.getElementById(`card-${id}`);
                if(card) card.className = `card shadow-sm h-100 card-${info.status}`;
                
                document.getElementById(`status-${id}`).innerText = info.status;
                document.getElementById(`score-${id}`).innerText = info.score ? info.score + "ì " : "-";
                
                const details = document.getElementById(`details-${id}`);
                details.innerHTML = info.details.slice(0, 3).map(d => `<li>âš ï¸ ${d}</li>`).join('');

                const worst = document.getElementById(`worst-${id}`);
                if (info.worst_queries && info.worst_queries.length > 0) {
                    const q = info.worst_queries[0];
                    worst.innerHTML = `<div class="query-box text-break">Top Bad: ${q.text}<br><span class="text-danger fw-bold">${q.avg_time}</span></div>`;
                }
            }
        }, 1500);
    </script>
</body>
</html>
"""

# ==========================================
# 6. [Entry] ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
# ==========================================
file_contents["run_sentinel.py"] = """
import sys, os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from app.web.app import run

if __name__ == "__main__":
    print("===========================================")
    print("   ğŸ›¡ï¸ DB Sentinel Pro (Secure Edition)")
    print("   - Intranet Only: 10.244.120.24")
    print("   - SQLite Repository Enabled")
    print("===========================================")
    try:
        import flask, pymssql, pymysql
        run()
    except ImportError:
        print("Error: pip install flask pymssql pymysql")
"""

def create_project():
    if not os.path.exists(PROJECT_ROOT): os.makedirs(PROJECT_ROOT)
    for path, content in file_contents.items():
        full_path = os.path.join(PROJECT_ROOT, path)
        os.makedirs(os.path.dirname(full_path), exist_ok=True)
        with open(full_path, "w", encoding="utf-8") as f: f.write(content.strip())
    print(f"âœ… í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ! 'cd {PROJECT_ROOT}' -> 'python run_sentinel.py'")

if __name__ == "__main__":
    create_project()