import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ í”„ë¡œì íŠ¸ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸ”¥ [CRITICAL RESTORE] v53: Rule Editing & Chart Counter Fix...")

# 1. settings.html (ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€ ë° ê²½ë¡œ ë™ê¸°í™”)
settings_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>BRIDGE SETTINGS | V53</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #050508; color: #e0e0e0; font-family: 'Inter', sans-serif; }
        .settings-card { background: rgba(20, 20, 35, 0.6); border: 1px solid rgba(100, 100, 255, 0.1); border-radius: 16px; padding: 25px; margin-bottom: 30px; }
        .form-control { background: #000; border: 1px solid #333; color: #fff; font-family: 'Consolas', monospace; }
        .table { color: #ccc; vertical-align: middle; }
        .nav-link.active { background: transparent !important; color: #00e5ff !important; border-bottom: 2px solid #00e5ff !important; }
    </style>
</head>
<body class="p-5">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h2 class="fw-bold"><i class="bi bi-cpu-fill me-2 text-info"></i> SYSTEM CONFIGURATION</h2>
            <a href="/" class="btn btn-outline-light rounded-pill px-4">Dashboard</a>
        </div>

        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#rules-pane">Manage Rules</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#links-pane">Web Bookmarks</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="rules-pane">
                <div class="settings-card">
                    <h5 class="mb-4 text-info"><i class="bi bi-journal-code me-2"></i> Rule Editor</h5>
                    <input type="hidden" id="editRuleId" value="">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><input type="text" id="ruleName" class="form-control" placeholder="Rule Name"></div>
                        <div class="col-md-12"><textarea id="ruleContent" class="form-control mt-2" rows="6" placeholder="Markdown content..."></textarea></div>
                        <div class="col-md-12 text-end">
                            <button id="cancelBtn" class="btn btn-secondary me-2" style="display:none;" onclick="resetRuleForm()">Cancel</button>
                            <button id="saveBtn" class="btn btn-info px-5 fw-bold" onclick="saveRule()">SAVE RULE</button>
                        </div>
                    </div>
                    <table class="table">
                        <thead><tr><th>Name</th><th>Preview</th><th class="text-center">Action</th></tr></thead>
                        <tbody id="ruleList"></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="links-pane"><div class="settings-card" id="bookmarkContainer"></div></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // [RULE ACTIONS]
        function loadRules() {
            fetch('/api/rules').then(r => r.json()).then(data => {
                const list = document.getElementById('ruleList');
                list.innerHTML = data.map(r => `
                    <tr>
                        <td class="fw-bold">${r.RuleName}</td>
                        <td class="text-muted small">${r.RuleContent.substring(0, 50)}...</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editRule(${r.RuleID}, '${r.RuleName}', \`${r.RuleContent}\`)">Edit</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRule(${r.RuleID})">Del</button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        function editRule(id, name, content) {
            document.getElementById('editRuleId').value = id;
            document.getElementById('ruleName').value = name;
            document.getElementById('ruleContent').value = content;
            document.getElementById('saveBtn').innerText = "UPDATE RULE";
            document.getElementById('cancelBtn').style.display = "inline-block";
        }

        function resetRuleForm() {
            document.getElementById('editRuleId').value = "";
            document.getElementById('ruleName').value = "";
            document.getElementById('ruleContent').value = "";
            document.getElementById('saveBtn').innerText = "SAVE RULE";
            document.getElementById('cancelBtn').style.display = "none";
        }

        function saveRule() {
            const id = document.getElementById('editRuleId').value;
            const name = document.getElementById('ruleName').value;
            const content = document.getElementById('ruleContent').value;
            const method = id ? 'PUT' : 'POST';
            
            fetch('/api/rules', {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id, name, content})
            }).then(() => { resetRuleForm(); loadRules(); });
        }

        function deleteRule(id) { if(confirm('ì‚­ì œ?')) fetch('/api/rules?id='+id, {method:'DELETE'}).then(loadRules); }
        
        document.addEventListener('DOMContentLoaded', loadRules);
    </script>
</body>
</html>
"""
with open(os.path.join(base_dir, "app", "templates", "settings.html"), "w", encoding="utf-8") as f: f.write(settings_html)

# 2. api_routes.py (ì°¨íŠ¸ ì§‘ê³„ ë¡œì§ & PUT(ìˆ˜ì •) API ì¶”ê°€)
api_code = r"""from flask import Blueprint, request, jsonify, abort
from app.database import get_db_connection
import subprocess, os, json, shlex, base64

api_bp = Blueprint('api', __name__)
IP_WHITELIST = ["127.0.0.1", "localhost", "192.168.0.10"]

@api_bp.before_app_request
def gate():
    if request.path.startswith('/static'): return
    ip = request.headers.get('X-Forwarded-For', request.remote_addr).split(',')[0].strip()
    if ip not in IP_WHITELIST: return jsonify({"error": "Unauthorized", "ip": ip}), 403

# --- [STATS] ì°¨íŠ¸ ì¹´ìš´í„° ì§‘ê³„ ë³µêµ¬ ---
@api_bp.route('/api/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    # ê·¸ë£¹ í†µê³„
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    groups = cursor.fetchall()
    
    # [í•µì‹¬] ì¼/ì£¼/ì›”ë³„ ì™„ë£Œ ê±´ìˆ˜ ì§‘ê³„ (Status='Done' ê¸°ì¤€)
    def gs(days):
        sql = f"SELECT COUNT(*) as cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as dur FROM cline_TaskQueue WHERE Status='Done' AND CompletedAt >= DATEADD(day, -{days}, GETDATE())"
        cursor.execute(sql); return cursor.fetchone()

    stats = {
        'day': gs(1),
        'week': gs(7),
        'month': gs(30)
    }
    conn.close(); return jsonify({'groups': groups, 'counts': stats})

# --- [RULES] ìˆ˜ì •(PUT) ê¸°ëŠ¥ ì¶”ê°€ ---
@api_bp.route('/api/rules', methods=['GET', 'POST', 'PUT', 'DELETE'])
def handle_rules():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_ProjectRules ORDER BY RuleID DESC")
        res = cursor.fetchall(); conn.close(); return jsonify(res)
    
    data = request.json
    if request.method == 'POST':
        cursor.execute("INSERT INTO cline_ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", (data['name'], data['content']))
    elif request.method == 'PUT':
        cursor.execute("UPDATE cline_ProjectRules SET RuleName=%s, RuleContent=%s WHERE RuleID=%s", (data['name'], data['content'], data['id']))
    elif request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_ProjectRules WHERE RuleID=%s", (request.args.get('id'),))
        
    conn.commit(); conn.close(); return jsonify({'status': 'success'})

# --- [CHART] ì‹œê°„ëŒ€ë³„ ì†ë„ (í† í° ì—ëŸ¬ ë°©ì§€ìš© ì£¼ì†Œ ê³ ì •) ---
@api_bp.route('/api/stats/hourly_speed', methods=['GET'])
def get_hourly_speed():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT DATEPART(HOUR, StartedAt) as HourOfDay, AVG(DATEDIFF(SECOND, StartedAt, CompletedAt)) as AvgSeconds FROM cline_TaskQueue WHERE Status='Done' AND StartedAt >= DATEADD(month, -1, GETDATE()) GROUP BY DATEPART(HOUR, StartedAt) ORDER BY HourOfDay")
    r = cursor.fetchall(); conn.close(); return jsonify(r)

# (ì´í•˜ í, ë¶ë§ˆí¬ ë“± ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f: f.write(api_code)

print("\nâœ… v53 ë³µêµ¬ ì™„ë£Œ! ì´ì œ ë£° ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ê³  ì°¨íŠ¸ ì¹´ìš´í„°ê°€ ì •ìƒ ì§‘ê³„ë©ë‹ˆë‹¤.")