import os

# app.py ì½”ë“œë¥¼ ìƒˆë¡œ ì‘ì„± 
# í•µì‹¬ ìˆ˜ì •: ìœˆë„ìš° ê²½ë¡œì˜ ë°±ìŠ¬ë˜ì‹œ(\)ë¥¼ ìŠ¬ë˜ì‹œ(/)ë¡œ ì¹˜í™˜í•˜ì—¬ ì „ë‹¬

new_app_code = r"""from flask import Flask, render_template, request, jsonify
import pymssql
import subprocess
import os
import socket

app = Flask(__name__)

# ================= CONFIGURATION =================
DB_HOST = '192.168.0.10'
DB_USER = 'sa'
DB_PASSWORD = 'password'
DB_NAME = 'MyDatabase'
# =================================================

def get_db_connection():
    return pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)

def get_local_ip():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        s.connect(('10.255.255.255', 1))
        IP = s.getsockname()[0]
    except Exception:
        IP = '127.0.0.1'
    finally:
        s.close()
    return IP

def clean_str(s):
    """Null Byte ë° ê³µë°± ì œê±°"""
    if s:
        return s.replace('\x00', '').strip()
    return ""

@app.route('/')
def index():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT IPAddress, Account, DisplayName, FullPath, CONVERT(VARCHAR, LastUpdated, 120) as LastUpdated FROM FolderIndex ORDER BY LastUpdated DESC")
    rows = cursor.fetchall()
    conn.close()
    return render_template('index.html', folders=rows)

@app.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    
    target_ip = clean_str(data.get('ip'))
    user = clean_str(data.get('account'))
    path = clean_str(data.get('path'))

    # [í•µì‹¬ ìˆ˜ì •] ìœˆë„ìš° ê²½ë¡œ(\)ê°€ ë“¤ì–´ì˜¤ë©´ ë¦¬ëˆ…ìŠ¤ì—ì„œ ì•ˆì „í•œ ìŠ¬ë˜ì‹œ(/)ë¡œ ë³€ê²½
    # ì˜ˆ: "C:\Projects\App" -> "C:/Projects/App"
    # ì´ë ‡ê²Œ í•˜ë©´ ë¦¬ëˆ…ìŠ¤ê°€ ë°±ìŠ¬ë˜ì‹œë¥¼ ë¨¹ì–´ë²„ë¦¬ëŠ” ë¬¸ì œ í•´ê²°ë¨
    if '\\' in path:
        path = path.replace('\\', '/')

    local_ip = get_local_ip()
    cmd = ['code', '--no-sandbox', '--new-window']
    mode_msg = ""

    # ë‚´ IPê°€ ì•„ë‹ˆë©´ ë¬´ì¡°ê±´ SSH (ìœˆë„ìš°/ë¦¬ëˆ…ìŠ¤ ë¶ˆë¬¸)
    if target_ip == local_ip or target_ip in ['127.0.0.1', 'localhost']:
        cmd.append(path)
        mode_msg = "Local Direct"
    else:
        # Remote SSH
        remote_arg = f"ssh-remote+{user}@{target_ip}"
        cmd.extend(['--remote', remote_arg, path])
        mode_msg = "Remote SSH"

    try:
        my_env = os.environ.copy()
        if 'DISPLAY' not in my_env:
            my_env['DISPLAY'] = ':0'

        print(f"Executing: {cmd}") # ë¡œê·¸ í™•ì¸ìš©
        subprocess.Popen(cmd, env=my_env)
        
        return jsonify({
            'status': 'success', 
            'message': f'[{mode_msg}] Opening {path} on {target_ip}'
        })
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e).replace('\x00', '')}), 500

if __name__ == '__main__':
    print("ğŸš€ RunCline Server starting on port 1633...")
    app.run(host='0.0.0.0', port=1633, debug=True)
"""

def fix_backslash():
    base_dir = "runcline"
    target_path = os.path.join(base_dir, "app.py")
    
    if not os.path.exists(base_dir):
        print(f"âŒ ì˜¤ë¥˜: '{base_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    with open(target_path, "w", encoding="utf-8") as f:
        f.write(new_app_code)
        
    print(f"âœ… ìˆ˜ì • ì™„ë£Œ: {target_path}")
    print("ğŸ‘‰ ì´ì œ ìœˆë„ìš° ê²½ë¡œ(C:\\...)ê°€ C:/... í˜•íƒœë¡œ ë³€í™˜ë˜ì–´ ì•ˆì „í•˜ê²Œ ì‹¤í–‰ë©ë‹ˆë‹¤.")

if __name__ == "__main__":
    fix_backslash()