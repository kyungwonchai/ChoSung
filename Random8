import os
import socket
import pymssql
import datetime
import time
import glob

# ================= CONFIGURATION =================
# DB ì ‘ì† ì •ë³´ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ë§ì¶”ì„¸ìš”)
DB_HOST = '192.168.0.10'
DB_USER = 'sa'
DB_PASSWORD = 'password'
DB_NAME = 'MyDatabase'

# ìœˆë„ìš° ìŠ¤ìº” ëŒ€ìƒ ê²½ë¡œ (r'' ë¬¸ìì—´ ì‚¬ìš© ê¶Œì¥)
TARGET_PATHS = [
    r'C:\Users\User\Source\Repos',
    r'D:\Projects',
    r'C:\Work'
]

# ì ‘ë‘ì–´ ì„¤ì • (ìœˆë„ìš°ìš© êµ¬ë¶„ì„ ìœ„í•´ ì„¤ì •)
PREFIX = "WIN_PRJ_" 

# ë°˜ë³µ ì£¼ê¸° (ì´ˆ ë‹¨ìœ„, 10ë¶„ = 600ì´ˆ)
INTERVAL_SECONDS = 600
# =================================================

def get_ip_address():
    """í˜„ì¬ PCì˜ IPë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        s.connect(('10.255.255.255', 1))
        IP = s.getsockname()[0]
    except Exception:
        IP = '127.0.0.1'
    finally:
        s.close()
    return IP

def has_build_artifacts(folder_path):
    """
    í•´ë‹¹ í´ë” í•˜ìœ„ì— ì‹¤ì œ ë¹Œë“œëœ í”ì (.dll, .exe)ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    ì£¼ë¡œ bin ë˜ëŠ” obj í´ë” ë‚´ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
    """
    # ì²´í¬í•  í™•ì¥ì ëª©ë¡
    build_extensions = {'.dll', '.exe'}
    
    # ë„ˆë¬´ ê¹Šê²Œ ë“¤ì–´ê°€ì§€ ì•Šë„ë¡ ì œí•œí•˜ê±°ë‚˜, íŠ¹ì • í´ë”ë§Œ ë³¼ ìˆ˜ë„ ìˆì§€ë§Œ
    # ì—¬ê¸°ì„œëŠ” í•˜ìœ„ ëª¨ë“  í´ë” ì¤‘ bin/objê°€ í¬í•¨ëœ ê²½ë¡œì˜ íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤.
    for root, dirs, files in os.walk(folder_path):
        # ê²½ë¡œì— bin ë˜ëŠ” objê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ)
        lower_root = root.lower()
        if 'bin' in lower_root or 'obj' in lower_root:
            for file in files:
                _, ext = os.path.splitext(file)
                if ext.lower() in build_extensions:
                    return True # ë¹Œë“œ í”ì  ë°œê²¬ ì¦‰ì‹œ True ë°˜í™˜
    return False

def scan_and_update():
    current_ip = get_ip_address()
    current_user = os.getenv('USERNAME') # WindowsëŠ” USERNAME í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
    
    conn = None
    try:
        print(f"[{datetime.datetime.now()}] ğŸ” ìŠ¤ìº” ì‹œì‘ ({current_ip})...")
        conn = pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)
        cursor = conn.cursor()

        valid_folders = []

        for base_path in TARGET_PATHS:
            if not os.path.exists(base_path):
                print(f"  âš ï¸ ê²½ë¡œ ì—†ìŒ: {base_path}")
                continue

            # os.walkë¡œ í•˜ìœ„ í´ë” íƒìƒ‰
            for root, dirs, files in os.walk(base_path):
                # 1. .sln íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
                has_sln = any(f.endswith('.sln') for f in files)
                
                if has_sln:
                    # 2. ë¹Œë“œ í”ì (dll, exe)ì´ í•˜ìœ„ì— ìˆëŠ”ì§€ ê²€ì¦
                    if has_build_artifacts(root):
                        folder_name = os.path.basename(root)
                        display_name = f"{PREFIX}{folder_name}"
                        
                        # DBì— ë„£ì„ ì¤€ë¹„
                        valid_folders.append((display_name, root))
                        print(f"  âœ… ë°œê²¬: {display_name} -> {root}")
                        
                        # DB Update (MERGE)
                        sql = """
                        MERGE FolderIndex AS target
                        USING (SELECT %s as IP, %s as Path) AS source
                        ON (target.IPAddress = source.IP AND target.FullPath = source.Path)
                        WHEN MATCHED THEN
                            UPDATE SET DisplayName = %s, Account = %s, LastUpdated = GETDATE()
                        WHEN NOT MATCHED THEN
                            INSERT (IPAddress, Account, DisplayName, FullPath, LastUpdated)
                            VALUES (%s, %s, %s, %s, GETDATE());
                        """
                        cursor.execute(sql, (
                            current_ip, root,           # Source
                            display_name, current_user, # Update
                            current_ip, current_user, display_name, root # Insert
                        ))
        
        conn.commit()
        print(f"[{datetime.datetime.now()}] âœ¨ ì—…ë°ì´íŠ¸ ì™„ë£Œ. (ë°œê²¬ëœ í”„ë¡œì íŠ¸: {len(valid_folders)}ê°œ)")
        print(f"â³ {INTERVAL_SECONDS/60}ë¶„ ëŒ€ê¸° ì¤‘...")

    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
    finally:
        if conn: conn.close()

if __name__ == "__main__":
    print("ğŸš€ ìœˆë„ìš° í”„ë¡œì íŠ¸ ìŠ¤ìºë„ˆ ê°€ë™ (Ctrl+Cë¡œ ì¢…ë£Œ)")
    while True:
        scan_and_update()
        time.sleep(INTERVAL_SECONDS)