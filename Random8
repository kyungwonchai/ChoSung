import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ ì˜¤ë¥˜: 'runcline' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

print("ğŸš€ AI Bridge v20: IP Whitelist Middleware Update...")

# ==========================================
# run_bridge.py (ì‹¤í–‰ íŒŒì¼ êµì²´)
# ==========================================
run_bridge_code = r"""from flask import Flask, request, abort, render_template_string
from app.routes.main_routes import main_bp
from app.routes.api_routes import api_bp
import logging

# Flask ì•± ì´ˆê¸°í™”
app = Flask(__name__, template_folder='app/templates', static_folder='app/static')

# [í•µì‹¬] í—ˆìš©í•  IP ëª©ë¡ (í˜•ë‹˜ì´ ë¶€ë¥´ì‹  ê·¸ ë…€ì„ë“¤)
ALLOWED_IPS = ['10.244.122.222', '10.244.122.223', '127.0.0.1', 'localhost']

# ë¡œê¹… ë„ê¸° (ì§€ì €ë¶„í•œê±° ì‹«ìœ¼ë‹ˆê¹Œ)
log = logging.getLogger('werkzeug')
log.setLevel(logging.ERROR)

@app.before_request
def limit_remote_addr():
    # 1. ì ‘ì†ì IP í™•ì¸
    client_ip = request.remote_addr
    
    # 2. IP ê²€ì‚¬ (ë¦¬ìŠ¤íŠ¸ì— ì—†ìœ¼ë©´ ë°”ë¡œ ì»·)
    if client_ip not in ALLOWED_IPS:
        print(f"ğŸš« [ì°¨ë‹¨ë¨] ì ‘ê·¼ ì‹œë„ IP: {client_ip}")
        
        # 3. ì°¨ë‹¨ í™”ë©´ (ê°„ì§€ë‚˜ê²Œ ë¸”ë™ ìŠ¤í¬ë¦°)
        return render_template_string('''
            <!DOCTYPE html>
            <html>
            <body style="background-color: #000; color: #ff0000; display: flex; 
                         justify-content: center; align-items: center; height: 100vh; 
                         font-family: monospace; flex-direction: column;">
                <h1 style="font-size: 3rem;">ACCESS DENIED</h1>
                <p>Your IP ({{ ip }}) is not authorized.</p>
                <p>UNREAL BRIDGE SECURITY</p>
            </body>
            </html>
        ''', ip=client_ip), 403

# ë¸”ë£¨í”„ë¦°íŠ¸ ë“±ë¡
app.register_blueprint(main_bp)
app.register_blueprint(api_bp, url_prefix='/api')

if __name__ == '__main__':
    print(f"ğŸ”¥ UNREAL BRIDGE v20 Started...")
    print(f"ğŸ”’ Allowed IPs Only: {ALLOWED_IPS}")
    # 0.0.0.0ìœ¼ë¡œ ì—´ì–´ì•¼ ì™¸ë¶€ì—ì„œ ì ‘ì† ì‹œë„ë¼ë„ í•  ìˆ˜ ìˆìŒ
    app.run(host='0.0.0.0', port=9111, debug=True)
"""

with open(os.path.join(base_dir, "run_bridge.py"), "w", encoding="utf-8") as f:
    f.write(run_bridge_code)

print("\nâœ… IP ì œí•œ ì„¤ì • ì™„ë£Œ!")
print("1. í—ˆìš© IP: 10.244.122.222, 10.244.122.223 (ê·¸ë¦¬ê³  ë¡œì»¬í˜¸ìŠ¤íŠ¸)")
print("2. ê·¸ ì™¸ IP: ê²€ì€ í™”ë©´ì— 'ACCESS DENIED' ì¶œë ¥ë¨.")
print("ğŸ‘‰ 'python3 runcline/run_bridge.py' ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”!")