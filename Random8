import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print(f"âŒ ì˜¤ë¥˜: '{base_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# ==========================================
# SSH Service ìˆ˜ì • (SFTP Batch Mode ì ìš©)
# ==========================================
# íŠ¹ì§•:
# 1. SSH mkdirê³¼ SCPë¥¼ ë”°ë¡œ ì“°ì§€ ì•Šê³ , SFTP ëª…ë ¹ì–´ í•˜ë‚˜ë¡œ ì²˜ë¦¬
# 2. SFTPëŠ” ê²½ë¡œ(ê³µë°±, í•œê¸€ ë“±)ë¥¼ í›¨ì”¬ ì˜ ì²˜ë¦¬í•¨
# 3. ìœˆë„ìš° ê²½ë¡œ(C:/...) í˜¸í™˜ì„± ê°•í™” (/C:/... í¬ë§· ì‚¬ìš©)
# ==========================================

ssh_service_code = r"""import subprocess
import os

def send_rule_via_ssh(ip, account, rule_content, project_path):
    sftp_batch_file = f"sftp_cmds_{ip}.txt"
    temp_rule_file = f"temp_rule_{ip}.md"
    
    try:
        # 1. ê²½ë¡œ ì •ê·œí™” (ìœˆë„ìš° ì—­ìŠ¬ë˜ì‹œ -> ìŠ¬ë˜ì‹œ)
        if '\\' in project_path:
            project_path = project_path.replace('\\', '/')
            
        # 2. SFTPìš© ì ˆëŒ€ ê²½ë¡œ í¬ë§· ë³€í™˜
        # ìœˆë„ìš° OpenSSH SFTPëŠ” ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš© ì‹œ '/C:/Path' í˜•íƒœë¥¼ ê°€ì¥ ì„ í˜¸í•©ë‹ˆë‹¤.
        # ë“œë¼ì´ë¸Œ ë¬¸ì(C:)ë¡œ ì‹œì‘í•˜ë©´ ì•ì— ìŠ¬ë˜ì‹œ(/)ë¥¼ ë¶™ì—¬ì¤ë‹ˆë‹¤.
        if len(project_path) > 1 and project_path[1] == ':':
            if not project_path.startswith('/'):
                project_path = '/' + project_path
        
        target_dir = f"{project_path}/.clinerules"
        target_file = f"{target_dir}/absoluterule.md"
        
        # 3. ë¡œì»¬ì— ë£° íŒŒì¼ ìƒì„±
        with open(temp_rule_file, 'w', encoding='utf-8') as f:
            f.write(rule_content)
            
        # 4. SFTP ë°°ì¹˜ íŒŒì¼ ìƒì„±
        # -mkdir : í´ë” ìƒì„± (ì•ì— -ë¥¼ ë¶™ì´ë©´ ì´ë¯¸ ìˆì–´ë„ ì—ëŸ¬ ë¬´ì‹œí•˜ê³  ì§„í–‰ë¨)
        # put : íŒŒì¼ ì „ì†¡
        with open(sftp_batch_file, 'w', encoding='utf-8') as f:
            f.write(f'-mkdir "{target_dir}"\n')
            f.write(f'put "{temp_rule_file}" "{target_file}"\n')
            f.write('bye\n')
            
        # 5. SFTP ì‹¤í–‰
        # -b : ë°°ì¹˜ íŒŒì¼ ëª¨ë“œ
        # -o StrictHostKeyChecking=no : SSH í‚¤ í™•ì¸ ìƒëµ
        cmd = ['sftp', '-o', 'StrictHostKeyChecking=no', '-b', sftp_batch_file, f'{account}@{ip}']
        
        # ì‹¤í–‰ ê²°ê³¼ í™•ì¸
        subprocess.check_call(cmd)
            
        return True, "Rule deployed successfully (SFTP)"
        
    except subprocess.CalledProcessError as e:
        return False, f"SFTP Transfer Failed (Exit Code {e.returncode}). Check path or permissions."
    except Exception as e:
        return False, f"Error: {str(e)}"
        
    finally:
        # ì²­ì†Œ (ì„ì‹œ íŒŒì¼ ì‚­ì œ)
        if os.path.exists(temp_rule_file):
            os.remove(temp_rule_file)
        if os.path.exists(sftp_batch_file):
            os.remove(sftp_batch_file)
"""

target_file = os.path.join(base_dir, "app", "services", "ssh_service.py")
with open(target_file, "w", encoding="utf-8") as f:
    f.write(ssh_service_code)

print("âœ… SFTP ë°©ì‹ íŒ¨ì¹˜ ì™„ë£Œ!")
print("ğŸ‘‰ ì´ì œ 'mkdir' ì—ëŸ¬ë‚˜ 'scp' ê²½ë¡œ ë¬¸ì œ ì—†ì´ ì „ì†¡ë  ê²ƒì…ë‹ˆë‹¤.")
print("ğŸ‘‰ SFTPëŠ” ìœˆë„ìš° ê²½ë¡œ ì•ì— ìŠ¬ë˜ì‹œë¥¼ ë¶™ì—¬(/C:/...) í˜¸í™˜ì„±ì„ ê·¹ëŒ€í™”í–ˆìŠµë‹ˆë‹¤.")
print("ğŸ‘‰ ë‹¤ì‹œ ì‹¤í–‰: python3 runcline/run_bridge.py")