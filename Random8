import os

# === í”„ë¡œì íŠ¸ ë£¨íŠ¸ ===
ROOT = "diag_final"

# === íŒŒì¼ ì •ì˜ ===
files = {}

# 1. ì‹¤í–‰ íŒŒì¼
files[f"{ROOT}/run.py"] = r"""
from app import create_app
app = create_app()
if __name__ == '__main__':
    print("ğŸš€ ì§„ë‹¨ ì‹œìŠ¤í…œ ê°€ë™: http://0.0.0.0:5000")
    app.run(host='0.0.0.0', port=5000, debug=True)
"""

# 2. í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬
files[f"{ROOT}/requirements.txt"] = r"""
flask
pymysql
pymssql
psutil
"""

# 3. App Init
files[f"{ROOT}/app/__init__.py"] = r"""
from flask import Flask
def create_app():
    app = Flask(__name__)
    from app.web.routes import web_bp
    app.register_blueprint(web_bp)
    return app
"""

# 4. Config (ì„¤ì •)
files[f"{ROOT}/app/config.py"] = r"""
class Config:
    # [ì„¤ì •] ì•„ë˜ ì •ë³´ë¥¼ ì‹¤ì œ DB ì •ë³´ë¡œ ìˆ˜ì • í›„ ì‹¤í–‰í•˜ì„¸ìš”.
    MSSQL = {'server': 'localhost', 'user': 'sa', 'password': 'your_password', 'database': 'master'}
    MYSQL = {'host': 'localhost', 'user': 'root', 'password': 'your_password', 'charset': 'utf8mb4'}
"""

# 5. Logger (HTML í¬ë§¤í„°)
files[f"{ROOT}/app/core/logger.py"] = r"""
import datetime
class HtmlLogger:
    @staticmethod
    def log(msg, level="INFO"):
        ts = datetime.datetime.now().strftime("%H:%M:%S")
        colors = {"INFO":"#ccc", "OK":"#0f0", "WARN":"#fa0", "ERROR":"#f44", "HEADER":"#0cf"}
        c = colors.get(level, "#ccc")
        return f'<div style="color:{c}; font-family:monospace; margin:2px;">[{ts}] {msg}</div>\n'
    @staticmethod
    def table(data):
        if not data: return '<div style="color:#666; margin-left:10px;">ë°ì´í„° ì—†ìŒ</div>'
        h = data[0].keys()
        html = '<table style="width:98%; border-collapse:collapse; border:1px solid #444; font-size:12px; margin:5px auto;">'
        html += '<thead style="background:#333; color:#fff;"><tr>' + ''.join([f'<th style="border:1px solid #555; padding:5px;">{k}</th>' for k in h]) + '</tr></thead><tbody>'
        for row in data:
            html += '<tr style="background:#1e1e1e;">' + ''.join([f'<td style="border:1px solid #555; padding:5px; color:#ccc;">{str(v)[:100]}</td>' for v in row.values()]) + '</tr>'
        html += '</tbody></table>'
        return html
"""

# 6. Base Diagnostic
files[f"{ROOT}/app/diagnostics/base.py"] = r"""
from app.core.logger import HtmlLogger
class BaseDiagnostic:
    def __init__(self): self.logger = HtmlLogger()
    def run(self): pass
"""

# ======================================================================================
# 7. MSSQL Checks (ì—¬ê¸°ì— ê¸´ ì¿¼ë¦¬ë¥¼ ì „ë¶€ í•œ ì¤„ë¡œ ë„£ì—ˆìŠµë‹ˆë‹¤)
# ======================================================================================
files[f"{ROOT}/app/diagnostics/mssql_checks.py"] = r"""
import pymssql
import traceback
from app.config import Config
from app.diagnostics.base import BaseDiagnostic

class MSSQLDiagnostic(BaseDiagnostic):
    def get_conn(self): return pymssql.connect(**Config.MSSQL)

    def run(self):
        yield self.logger.log("=== [MSSQL] ì •ë°€ ì§„ë‹¨ ì‹œì‘ ===", "HEADER")
        conn = None
        try:
            conn = self.get_conn()
            cursor = conn.cursor(as_dict=True)
            
            # [1] CPU ê³¼ì ìœ  ì¿¼ë¦¬ TOP 10 (í•œ ì¤„ ë³€í™˜ ì™„ë£Œ)
            yield self.logger.log("1. CPU ê³¼ë¶€í•˜ ìœ ë°œ ì¿¼ë¦¬ TOP 10", "WARN")
            q_cpu = "SELECT TOP 10 SUBSTRING(qt.text, (qs.statement_start_offset/2)+1, ((CASE qs.statement_end_offset WHEN -1 THEN DATALENGTH(qt.text) ELSE qs.statement_end_offset END - qs.statement_start_offset)/2) + 1) AS [Query], qs.execution_count AS [Execs], qs.total_worker_time/1000 AS [TotalCPU_ms], (qs.total_worker_time/qs.execution_count)/1000 AS [AvgCPU_ms], qs.last_execution_time FROM sys.dm_exec_query_stats qs CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) qt ORDER BY qs.total_worker_time DESC"
            cursor.execute(q_cpu)
            yield self.logger.table(cursor.fetchall())

            # [2] í˜„ì¬ Blocking/Deadlock ì„¸ì…˜ (í•œ ì¤„ ë³€í™˜ ì™„ë£Œ)
            yield self.logger.log("2. í˜„ì¬ ë¸”ë¡œí‚¹(Lock) ë°œìƒ ì„¸ì…˜ ì¶”ì ", "ERROR")
            q_lock = "SELECT spid, blocked, status, loginame, hostname, cmd, wait_time, lastwaittype, program_name FROM sys.sysprocesses WHERE blocked > 0 OR spid IN (SELECT blocked FROM sys.sysprocesses)"
            cursor.execute(q_lock)
            yield self.logger.table(cursor.fetchall())

            # [3] ëˆ„ë½ ì¸ë±ìŠ¤ ì¶”ì²œ (í•œ ì¤„ ë³€í™˜ ì™„ë£Œ)
            yield self.logger.log("3. ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ëˆ„ë½ ì¸ë±ìŠ¤ ì œì•ˆ", "WARN")
            q_missing = "SELECT TOP 10 d.statement AS [Table], ROUND(s.avg_total_user_cost * s.avg_user_impact * (s.user_seeks + s.user_scans),0) AS [ImpactScore], mid.equality_columns, mid.included_columns FROM sys.dm_db_missing_index_group_stats s INNER JOIN sys.dm_db_missing_index_groups g ON s.group_handle = g.index_group_handle INNER JOIN sys.dm_db_missing_index_details mid ON mid.index_handle = g.index_handle ORDER BY [ImpactScore] DESC"
            cursor.execute(q_missing)
            yield self.logger.table(cursor.fetchall())

            # [4] í…Œì´ë¸”ë³„ ìš©ëŸ‰ TOP 20 (í•œ ì¤„ ë³€í™˜ ì™„ë£Œ)
            yield self.logger.log("4. ë””ìŠ¤í¬ ìš©ëŸ‰ ìƒìœ„ í…Œì´ë¸” TOP 20", "INFO")
            # ì°¸ê³ : ì´ ì¿¼ë¦¬ëŠ” í˜„ì¬ ì ‘ì†ëœ DB ê¸°ì¤€ì…ë‹ˆë‹¤. masterì—ì„œëŠ” ê²°ê³¼ê°€ ì ì„ ìˆ˜ ìˆìŒ.
            q_size = "SELECT TOP 20 t.NAME AS [Table], p.rows AS [Rows], SUM(a.total_pages) * 8 / 1024 AS [Total_MB], SUM(a.used_pages) * 8 / 1024 AS [Used_MB] FROM sys.tables t INNER JOIN sys.indexes i ON t.OBJECT_ID = i.object_id INNER JOIN sys.partitions p ON i.object_id = p.OBJECT_ID AND i.index_id = p.index_id INNER JOIN sys.allocation_units a ON p.partition_id = a.container_id WHERE t.is_ms_shipped = 0 AND i.OBJECT_ID > 255 GROUP BY t.Name, p.Rows ORDER BY [Total_MB] DESC"
            try:
                cursor.execute(q_size)
                yield self.logger.table(cursor.fetchall())
            except:
                yield self.logger.log("ë§ˆìŠ¤í„° DBì—ì„œëŠ” í…Œì´ë¸” í¬ê¸° ì¡°íšŒê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ê°œë³„ DB ì„ íƒ í•„ìš”)", "WARN")

            # [5] DB íŒŒì¼ ì‚¬ìš©ëŸ‰ (í•œ ì¤„ ë³€í™˜ ì™„ë£Œ)
            yield self.logger.log("5. ë°ì´í„°ë² ì´ìŠ¤ë³„ íŒŒì¼ í¬ê¸°", "INFO")
            q_files = "SELECT d.name AS [DB_Name], ROUND(SUM(mf.size) * 8 / 1024, 0) AS [Size_MB] FROM sys.master_files mf JOIN sys.databases d ON mf.database_id = d.database_id GROUP BY d.name ORDER BY [Size_MB] DESC"
            cursor.execute(q_files)
            yield self.logger.table(cursor.fetchall())

        except Exception:
            yield self.logger.log(f"MSSQL Error: {traceback.format_exc()}", "ERROR")
        finally:
            if conn: conn.close()
"""

# ======================================================================================
# 8. MySQL Checks (ê¸´ ì¿¼ë¦¬ í•œ ì¤„ íƒ‘ì¬ ì™„ë£Œ)
# ======================================================================================
files[f"{ROOT}/app/diagnostics/mysql_checks.py"] = r"""
import pymysql
import traceback
from app.config import Config
from app.diagnostics.base import BaseDiagnostic

class MySQLDiagnostic(BaseDiagnostic):
    def get_conn(self): return pymysql.connect(cursorclass=pymysql.cursors.DictCursor, **Config.MYSQL)

    def run(self):
        yield self.logger.log("=== [MySQL] ì •ë°€ ì§„ë‹¨ ì‹œì‘ ===", "HEADER")
        conn = None
        try:
            conn = self.get_conn()
            cursor = conn.cursor()
            
            # [1] í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì¿¼ë¦¬ (Processlist) - í•œ ì¤„
            yield self.logger.log("1. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì¿¼ë¦¬ (Processlist)", "WARN")
            cursor.execute("SELECT id, user, host, db, command, time, state, info FROM information_schema.processlist WHERE command != 'Sleep' ORDER BY time DESC LIMIT 20")
            yield self.logger.table(cursor.fetchall())

            # [2] í…Œì´ë¸” ìš©ëŸ‰ TOP 20 - í•œ ì¤„
            yield self.logger.log("2. ìš©ëŸ‰ ìƒìœ„ í…Œì´ë¸” TOP 20", "INFO")
            q_size = "SELECT table_schema AS [DB], table_name AS [Table], round(((data_length + index_length) / 1024 / 1024), 2) AS [Size_MB], table_rows AS [Rows] FROM information_schema.TABLES WHERE table_schema NOT IN ('information_schema', 'mysql', 'performance_schema', 'sys') ORDER BY (data_length + index_length) DESC LIMIT 20"
            cursor.execute(q_size)
            yield self.logger.table(cursor.fetchall())
            
            # [3] í˜¸ìŠ¤íŠ¸ë³„ ì ‘ì† í†µê³„ - í•œ ì¤„
            yield self.logger.log("3. í˜¸ìŠ¤íŠ¸ë³„ ì ‘ì† í†µê³„ (Connection Count)", "INFO")
            cursor.execute("SELECT substring_index(host, ':', 1) as IP, count(*) as Count FROM information_schema.processlist GROUP BY IP ORDER BY Count DESC")
            yield self.logger.table(cursor.fetchall())

            # [4] ì—”ì§„ ìƒíƒœ ìš”ì•½ - í•œ ì¤„
            yield self.logger.log("4. ì£¼ìš” Status ë³€ìˆ˜ í™•ì¸", "OK")
            cursor.execute("SHOW GLOBAL STATUS WHERE Variable_name IN ('Aborted_connects', 'Threads_connected', 'Threads_running', 'Slow_queries', 'Uptime')")
            yield self.logger.table(cursor.fetchall())

        except Exception:
            yield self.logger.log(f"MySQL Error: {traceback.format_exc()}", "ERROR")
        finally:
            if conn: conn.close()
"""

# 9. System Checks
files[f"{ROOT}/app/diagnostics/system_checks.py"] = r"""
import psutil
from app.diagnostics.base import BaseDiagnostic
class SystemDiagnostic(BaseDiagnostic):
    def run(self):
        yield self.logger.log("=== [HOST] ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì ê²€ ===", "HEADER")
        yield self.logger.log(f"CPU: {psutil.cpu_percent(interval=1)}% / RAM: {psutil.virtual_memory().percent}% / Disk: {psutil.disk_usage('/').percent}%", "INFO")
        yield self.logger.log("Top 5 Processes (CPU)", "WARN")
        procs = sorted([p.info for p in psutil.process_iter(['pid', 'name', 'cpu_percent']) if p.info['cpu_percent']], key=lambda x: x['cpu_percent'], reverse=True)[:5]
        yield self.logger.table(procs)
"""

# 10. Routes (Strategy Pattern ì ìš©)
files[f"{ROOT}/app/web/routes.py"] = r"""
from flask import Blueprint, render_template, Response, stream_with_context
from app.diagnostics.mssql_checks import MSSQLDiagnostic
from app.diagnostics.mysql_checks import MySQLDiagnostic
from app.diagnostics.system_checks import SystemDiagnostic

web_bp = Blueprint('web', __name__)

@web_bp.route('/')
def index(): return render_template('index.html')

@web_bp.route('/run/<mode>')
def run_diag(mode):
    def generate():
        diags = []
        if mode == 'all': diags = [SystemDiagnostic(), MSSQLDiagnostic(), MySQLDiagnostic()]
        elif mode == 'mssql': diags = [MSSQLDiagnostic()]
        elif mode == 'mysql': diags = [MySQLDiagnostic()]
        elif mode == 'system': diags = [SystemDiagnostic()]
        
        for d in diags:
            yield from d.run()
            yield "<br>"
        yield '<div style="color:#0f0; font-weight:bold;">âœ¨ ì§„ë‹¨ ì™„ë£Œ</div>'
    return Response(stream_with_context(generate()), mimetype='text/html')
"""

# 11. HTML Template
files[f"{ROOT}/app/templates/index.html"] = r"""
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body{background:#111; color:#eee; font-family:sans-serif; margin:0; display:flex; height:100vh;}
        .side{width:200px; background:#222; padding:20px; border-right:1px solid #444;}
        .main{flex:1; padding:20px; background:#000; overflow:hidden; display:flex; flex-direction:column;}
        button{width:100%; padding:15px; background:#333; color:#fff; border:1px solid #555; margin-bottom:10px; cursor:pointer;}
        button:hover{background:#444; border-color:#0cf;}
        #log{flex:1; border:1px solid #333; padding:10px; overflow-y:auto; font-family:monospace; background:#050505;}
    </style>
</head>
<body>
    <div class="side">
        <h2 style="color:#0cf">DIAG PRO</h2>
        <button onclick="go('all')">ALL SCAN</button>
        <button onclick="go('mssql')">MSSQL</button>
        <button onclick="go('mysql')">MySQL</button>
        <button onclick="go('system')">HOST</button>
    </div>
    <div class="main">
        <div id="log">Ready...</div>
    </div>
    <script>
        async function go(m){
            const l=document.getElementById('log'); l.innerHTML='Loading...';
            const res=await fetch('/run/'+m); const r=res.body.getReader(); const d=new TextDecoder();
            l.innerHTML='';
            while(true){ const {done,value}=await r.read(); if(done)break; l.innerHTML+=d.decode(value); l.scrollTop=l.scrollHeight; }
        }
    </script>
</body>
</html>
"""

# === íŒŒì¼ ìƒì„± ===
for p, c in files.items():
    d = os.path.dirname(p)
    if d and not os.path.exists(d): os.makedirs(d)
    with open(p, "w", encoding="utf-8") as f: f.write(c.strip())
    print(f"Created: {p}")

print("\nâœ… ì™„ë£Œ. ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•˜ì‹­ì‹œì˜¤:")
print(f"1. cd {ROOT}")
print("2. pip install -r requirements.txt")
print("3. app/config.py ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • (í•„ìˆ˜)")
print("4. python run.py")