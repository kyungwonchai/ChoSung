import os
import sys

# ==============================================================================
# EffBoost Project Installer
# Generates a production-grade folder structure adhering to SOLID principles.
# ==============================================================================

PROJECT_ROOT = "EffBoost_Project"

# íŒŒì¼ ë‚´ìš© ì •ì˜
files = {}

# 1. Config & Environment (.env)
files[".env"] = """# [EffBoost Configuration]
# Security: Do not commit this file.
API_KEY=

# Agent Endpoints
URL_GENERAL=
URL_UBUNTU=
URL_SQL=
URL_REASON=
"""

files["config.py"] = """import os
from dotenv import load_dotenv

# Load .env file
load_dotenv()

class Config:
    API_KEY = os.getenv("API_KEY", "")
    AGENTS = {
        "GENERAL": os.getenv("URL_GENERAL", ""),
        "UBUNTU": os.getenv("URL_UBUNTU", ""),
        "SQL": os.getenv("URL_SQL", ""),
        "REASON": os.getenv("URL_REASON", "")
    }
    DB_PATH = os.path.join(os.path.dirname(__file__), "storage.db")
"""

# 2. Main Entry Point (run.py)
files["run.py"] = """from app import create_app

app = create_app()

if __name__ == "__main__":
    print("="*60)
    print(" ðŸš€ EffBoost Enterprise Server Running on Port 9345")
    print("    Architecture: Layered (Controller-Service-Repository)")
    print("="*60)
    app.run(host='0.0.0.0', port=9345, debug=True)
"""

# 3. App Factory (app/__init__.py)
files["app/__init__.py"] = """from flask import Flask

def create_app():
    app = Flask(__name__)
    
    # Register Blueprints (Controller Layer)
    from app.routes.main_routes import main_bp
    app.register_blueprint(main_bp)
    
    return app
"""

# 4. Domain Layer - Repository (app/repositories/memory_repo.py)
files["app/repositories/memory_repo.py"] = """import sqlite3
from config import Config

class MemoryRepository:
    def __init__(self):
        self.db_path = Config.DB_PATH
        self._init_db()

    def _get_conn(self):
        return sqlite3.connect(self.db_path, check_same_thread=False)

    def _init_db(self):
        with self._get_conn() as conn:
            conn.execute('''
                CREATE TABLE IF NOT EXISTS notes (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    content TEXT,
                    tag TEXT DEFAULT 'General',
                    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            ''')

    def save(self, content: str, tag: str = "Memo"):
        with self._get_conn() as conn:
            conn.execute('INSERT INTO notes (content, tag) VALUES (?, ?)', (content, tag))

    def search(self, query: str, limit: int = 3) -> list:
        keywords = query.split()
        if not keywords: return []
        
        sql = "SELECT content FROM notes WHERE " + " OR ".join(["content LIKE ?"] * len(keywords))
        params = [f"%{k}%" for k in keywords]
        
        with self._get_conn() as conn:
            cursor = conn.execute(sql + f" ORDER BY id DESC LIMIT {limit}", params)
            return [r[0] for r in cursor.fetchall()]
"""

# 5. Infrastructure Layer - Strategies (app/strategies/base_strategy.py)
files["app/strategies/base_strategy.py"] = """from abc import ABC, abstractmethod

class AgentStrategy(ABC):
    @abstractmethod
    def execute(self, prompt: str, context: str) -> str:
        pass
"""

# 6. Infrastructure Layer - Implementation (app/strategies/samsung_agent.py)
files["app/strategies/samsung_agent.py"] = """import requests
from config import Config
from app.strategies.base_strategy import AgentStrategy

class SamsungAgent(AgentStrategy):
    def __init__(self, endpoint_url: str, name: str):
        self.endpoint = endpoint_url
        self.name = name
        self.api_key = Config.API_KEY

    def execute(self, prompt: str, context: str) -> str:
        if not self.endpoint or not self.api_key:
            return f"âš ï¸ Configuration Error: Check .env for {self.name} URL and API Key."

        final_input = f"Context:\\n{context}\\n\\nTask: {prompt}" if context else prompt

        payload = {
            "input_type": "chat",
            "output_type": "chat",
            "input_value": final_input
        }
        headers = {
            "Content-Type": "application/json",
            "x-api-key": self.api_key
        }

        try:
            # Timeout 45s for stability
            response = requests.post(self.endpoint, json=payload, headers=headers, timeout=45)
            response.raise_for_status()
            return self._parse_json(response.json())
        except Exception as e:
            return f"Error ({self.name}): {str(e)}"

    def _parse_json(self, data):
        # Strict parsing logic for LangFlow structure
        try:
            return data["outputs"][0]["outputs"]["results"]["message"]["text"]
        except (KeyError, IndexError, TypeError):
            return f"Parsing Failed. Raw: {str(data)[:100]}..."
"""

# 7. Service Layer - Orchestrator (app/services/orchestrator.py)
files["app/services/orchestrator.py"] = """import re
from app.repositories.memory_repo import MemoryRepository
from app.strategies.samsung_agent import SamsungAgent
from config import Config

class OrchestratorService:
    def __init__(self):
        self.repo = MemoryRepository()
        self.agents = {
            "GENERAL": SamsungAgent(Config.AGENTS["GENERAL"], "Assistant"),
            "UBUNTU": SamsungAgent(Config.AGENTS["UBUNTU"], "Linux Expert"),
            "SQL": SamsungAgent(Config.AGENTS["SQL"], "SQL Expert"),
            "REASON": SamsungAgent(Config.AGENTS["REASON"], "Analyst"),
        }

    def process_request(self, user_msg: str) -> dict:
        # 1. System Command (Save)
        if user_msg.startswith(("/save", "/memo", "/ì €ìž¥")):
            content = re.sub(r'^(/save|/memo|/ì €ìž¥)\s*', '', user_msg)
            self.repo.save(content)
            return {"type": "sys", "msg": "âœ… Saved to secure memory.", "agent": "SYSTEM"}

        # 2. Intent Router (Rule-based)
        intent = self._route_intent(user_msg)
        
        # 3. RAG Retrieval
        context_data = self.repo.search(user_msg)
        context_str = "\\n".join(context_data)

        # 4. Execution Strategy
        agent = self.agents.get(intent, self.agents["GENERAL"])
        response_text = agent.execute(user_msg, context_str)

        return {
            "type": "chat",
            "msg": response_text,
            "agent": agent.name,
            "refs": context_data
        }

    def _route_intent(self, msg: str) -> str:
        msg_lower = msg.lower()
        if any(x in msg_lower for x in ['ubuntu', 'linux', 'bash', 'terminal']): return "UBUNTU"
        if any(x in msg_lower for x in ['sql', 'query', 'database', 'join']): return "SQL"
        if any(x in msg_lower for x in ['plan', 'reason', 'analyze', 'why']): return "REASON"
        return "GENERAL"
"""

# 8. Controller Layer - Routes (app/routes/main_routes.py)
files["app/routes/main_routes.py"] = """from flask import Blueprint, render_template, request, jsonify
from app.services.orchestrator import OrchestratorService

main_bp = Blueprint('main', __name__)
orchestrator = OrchestratorService()

@main_bp.route('/')
def index():
    return render_template('index.html')

@main_bp.route('/chat', methods=['POST'])
def chat():
    data = request.json
    user_msg = data.get('msg', '')
    if not user_msg:
        return jsonify({"error": "Empty message"}), 400
    
    result = orchestrator.process_request(user_msg)
    return jsonify(result)
"""

# 9. Presentation Layer - UI (app/templates/index.html)
files["app/templates/index.html"] = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EffBoost Workspace</title>
    <style>
        :root { --bg-primary: #1e1e1e; --bg-secondary: #252526; --text-main: #d4d4d4; --accent: #007acc; --border: #3e3e42; }
        body { margin: 0; background-color: var(--bg-primary); color: var(--text-main); font-family: 'Segoe UI', monospace; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .app-frame { width: 100%; max-width: 1000px; display: flex; flex-direction: column; background: var(--bg-secondary); border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
        header { padding: 15px 20px; background: #2d2d2d; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 16px; font-weight: 600; color: #fff; letter-spacing: 1px; }
        .status { width: 8px; height: 8px; background-color: #4caf50; border-radius: 50%; box-shadow: 0 0 5px #4caf50; }
        .chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 16px; border-radius: 4px; max-width: 85%; font-size: 14px; line-height: 1.6; }
        .msg-user { align-self: flex-end; background-color: #0e639c; color: white; }
        .msg-bot { align-self: flex-start; background-color: #333333; border: 1px solid var(--border); }
        .agent-label { font-size: 10px; color: #9cdcfe; margin-bottom: 5px; display: block; font-weight: bold; text-transform: uppercase; }
        .ref-box { margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-left: 2px solid #dcdcaa; font-size: 11px; color: #dcdcaa; }
        pre { background: #111; padding: 10px; border: 1px solid #444; overflow-x: auto; font-family: 'Consolas', monospace; color: #ce9178; }
        code { font-family: 'Consolas', monospace; }
        .input-zone { padding: 20px; background: #2d2d2d; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; background: #3c3c3c; border: 1px solid #3c3c3c; color: white; border-radius: 2px; outline: none; font-family: inherit; }
        input:focus { border-color: var(--accent); }
        button { padding: 0 25px; background: var(--accent); color: white; border: none; border-radius: 2px; cursor: pointer; font-weight: 600; }
        button:hover { background: #0062a3; }
    </style>
</head>
<body>
    <div class="app-frame">
        <header><h1>EffBoost :: Integrated Workspace</h1><div class="status" title="System Ready"></div></header>
        <div class="chat-container" id="chatBox">
            <div class="message msg-bot"><span class="agent-label">SYSTEM</span>Welcome. Architecture loaded.<br>Use <code>/save</code> to persist data locally.</div>
        </div>
        <div class="input-zone">
            <input type="text" id="userInput" placeholder="Execute command..." autocomplete="off">
            <button onclick="send()">RUN</button>
        </div>
    </div>
    <script>
        const input = document.getElementById('userInput');
        const box = document.getElementById('chatBox');
        input.addEventListener('keypress', (e) => { if(e.key === 'Enter') send(); });
        async function send() {
            const text = input.value.trim();
            if (!text) return;
            box.innerHTML += `<div class="message msg-user">${esc(text)}</div>`;
            input.value = ''; box.scrollTop = box.scrollHeight;
            try {
                const res = await fetch('/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({msg: text}) });
                const data = await res.json();
                let content = fmt(data.msg);
                if (data.refs && data.refs.length > 0) content += `<div class="ref-box">ðŸ“š RAG Context Loaded (${data.refs.length} items)</div>`;
                box.innerHTML += `<div class="message msg-bot"><span class="agent-label">${data.agent}</span>${content}</div>`;
            } catch (err) { box.innerHTML += `<div class="message msg-bot" style="color:#f48771">Connection Error</div>`; }
            box.scrollTop = box.scrollHeight;
        }
        function esc(t) { return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function fmt(t) { return t.replace(/\\n/g, '<br>').replace(/```([\\s\\S]*?)```/g, '<pre><code>$1</code></pre>'); }
    </script>
</body>
</html>
"""

# ==============================================================================
# Installer Execution Logic
# ==============================================================================
def install():
    print(f"ðŸ”¨ Initializing Project in './{PROJECT_ROOT}'...")
    
    if not os.path.exists(PROJECT_ROOT):
        os.makedirs(PROJECT_ROOT)

    for filepath, content in files.items():
        full_path = os.path.join(PROJECT_ROOT, filepath)
        directory = os.path.dirname(full_path)
        
        if directory and not os.path.exists(directory):
            os.makedirs(directory)
            
        with open(full_path, "w", encoding="utf-8") as f:
            f.write(content)
            print(f"   [+] Created: {filepath}")

    print("\nâœ… Installation Complete.")
    print(f"ðŸ‘‰ Step 1: cd {PROJECT_ROOT}")
    print("ðŸ‘‰ Step 2: pip install flask requests python-dotenv")
    print("ðŸ‘‰ Step 3: Edit .env file with your API Keys")
    print("ðŸ‘‰ Step 4: python run.py")

if __name__ == "__main__":
    install()