import os

# app.py ì½”ë“œë¥¼ ìƒˆë¡œ ì‘ì„± (Null Byte ì œê±° + í¬íŠ¸ 1633 + í´ë”ëª… runcline ë°˜ì˜)
new_app_code = r"""from flask import Flask, render_template, request, jsonify
import pymssql
import subprocess
import os
import socket
import platform

app = Flask(__name__)

# ================= CONFIGURATION =================
DB_HOST = '192.168.0.10'
DB_USER = 'sa'
DB_PASSWORD = 'password'
DB_NAME = 'MyDatabase'
# =================================================

def get_db_connection():
    return pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)

def get_local_ip():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        s.connect(('10.255.255.255', 1))
        IP = s.getsockname()[0]
    except Exception:
        IP = '127.0.0.1'
    finally:
        s.close()
    return IP

@app.route('/')
def index():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    # DBì—ì„œ ê°€ì ¸ì˜¬ ë•Œë¶€í„° Null Byteê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜í•´ì•¼ í•˜ì§€ë§Œ,
    # ë³´í†µì€ subprocess ì‹¤í–‰ ì§ì „ì— ì§€ìš°ëŠ” ê²Œ í™•ì‹¤í•©ë‹ˆë‹¤.
    cursor.execute("SELECT IPAddress, Account, DisplayName, FullPath, CONVERT(VARCHAR, LastUpdated, 120) as LastUpdated FROM FolderIndex ORDER BY LastUpdated DESC")
    rows = cursor.fetchall()
    conn.close()
    return render_template('index.html', folders=rows)

def clean_str(s):
    """ë¬¸ìì—´ì— í¬í•¨ëœ Null Byte(\x00)ì™€ ì•ë’¤ ê³µë°±ì„ ì œê±°í•©ë‹ˆë‹¤."""
    if s:
        return s.replace('\x00', '').strip()
    return ""

@app.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    
    # [í•µì‹¬ ìˆ˜ì •] Null Byte (\x00) ì œê±° ë¡œì§ ì¶”ê°€
    target_ip = clean_str(data.get('ip'))
    user = clean_str(data.get('account'))
    path = clean_str(data.get('path'))

    local_ip = get_local_ip()
    mode_msg = ""
    cmd = []
    
    # ìœˆë„ìš° ê²½ë¡œ íŒë‹¨ (ì—­ìŠ¬ë˜ì‹œë‚˜ ì½œë¡  í¬í•¨ ì‹œ)
    is_windows_path = ('\\' in path) or (':' in path)

    if is_windows_path:
        # ìœˆë„ìš°: ë‹¨ìˆœ ì‹¤í–‰
        cmd = ['code', '--new-window', path]
        mode_msg = "Windows Local (Direct)"
        
        try:
            subprocess.Popen(cmd, shell=True)
            return jsonify({'status': 'success', 'message': f'[{mode_msg}] Opening {path}'})
        except Exception as e:
            return jsonify({'status': 'error', 'message': str(e)}), 500

    else:
        # ë¦¬ëˆ…ìŠ¤ (ìš°ë¶„íˆ¬) ë¡œì§
        cmd = ['code', '--no-sandbox', '--new-window']
        
        if target_ip == local_ip or target_ip in ['127.0.0.1', 'localhost']:
            cmd.append(path)
            mode_msg = "Linux Local"
        else:
            remote_arg = f"ssh-remote+{user}@{target_ip}"
            cmd.extend(['--remote', remote_arg, path])
            mode_msg = "Linux SSH"

        try:
            # ë¦¬ëˆ…ìŠ¤ëŠ” DISPLAY í™˜ê²½ë³€ìˆ˜ í•„ìˆ˜
            my_env = os.environ.copy()
            if 'DISPLAY' not in my_env:
                my_env['DISPLAY'] = ':0'

            subprocess.Popen(cmd, env=my_env)
            return jsonify({'status': 'success', 'message': f'[{mode_msg}] Opening on {target_ip}'})
        except Exception as e:
            # ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œë„ null byteê°€ ìˆìœ¼ë©´ 500 ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìœ¼ë‹ˆ ì²˜ë¦¬
            return jsonify({'status': 'error', 'message': str(e).replace('\x00', '')}), 500

if __name__ == '__main__':
    # ìš”ì²­í•˜ì‹  í¬íŠ¸ 1633ìœ¼ë¡œ ë³€ê²½
    print("ğŸš€ Server starting on port 1633...")
    app.run(host='0.0.0.0', port=1633, debug=True)
"""

def update_runcline_app():
    # í´ë”ëª… ìˆ˜ì •: runcline
    base_dir = "runcline"
    target_path = os.path.join(base_dir, "app.py")
    
    # í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„± (í˜¹ì‹œ ëª¨ë¥´ë‹ˆ)
    if not os.path.exists(base_dir):
        try:
            os.makedirs(base_dir)
            print(f"ğŸ“ '{base_dir}' í´ë”ê°€ ì—†ì–´ì„œ ìƒˆë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.")
        except OSError:
            print(f"âŒ ì˜¤ë¥˜: '{base_dir}' í´ë”ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return

    with open(target_path, "w", encoding="utf-8") as f:
        f.write(new_app_code)
        
    print(f"âœ… ìˆ˜ì • ì™„ë£Œ: {target_path}")
    print("ğŸ‘‰ Null Byte ì œê±° ë¡œì§ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.")
    print("ğŸ‘‰ í¬íŠ¸ê°€ 1633ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
    print(f"ğŸ‘‰ ì‹¤í–‰ ëª…ë ¹: python3 {base_dir}/app.py")

if __name__ == "__main__":
    update_runcline_app()