import os
import subprocess
import json
import urllib.request
import ssl
import sys

# ==========================================
# ğŸ‘‡ ì•„ê¹Œë‘ ë˜‘ê°™ì´ ì…ë ¥í•˜ì„¸ìš” (í‹€ë¦¬ë©´ ì•ˆë¨)
# ==========================================
GHE_ID = "ì‚¬ìš©ìID"            
GHE_TOKEN = "ghp_xxxxxxxx"    
PROJECT_NAME = "MyNewProject" 
# ==========================================

def run_cmd(cmd):
    try:
        subprocess.run(cmd, shell=True, check=True)
    except subprocess.CalledProcessError as e:
        print(f"âŒ ëª…ë ¹ì–´ ì‹¤íŒ¨: {cmd}\n{e}")
        sys.exit(1)

def get_real_repo_url():
    """ì„œë²„ì— ë§Œë“¤ì–´ì§„ 'ì§„ì§œ ì£¼ì†Œ'ë¥¼ ë¬¼ì–´ë³´ëŠ” í•¨ìˆ˜"""
    print(f"ğŸ” [1ë‹¨ê³„] ì„œë²„ì— ë§Œë“¤ì–´ì§„ '{PROJECT_NAME}'ì˜ ì§„ì§œ ì£¼ì†Œ ì¡°íšŒ ì¤‘...")
    
    api_url = f"https://github.sec.samsung.net/api/v3/repos/{GHE_ID}/{PROJECT_NAME}"
    
    headers = {
        "Authorization": f"token {GHE_TOKEN}",
        "User-Agent": "Python-Script"
    }
    
    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE

    try:
        req = urllib.request.Request(api_url, headers=headers)
        with urllib.request.urlopen(req, context=ctx) as response:
            data = json.loads(response.read().decode())
            # ì„œë²„ê°€ ì£¼ëŠ” ì§„ì§œ ì£¼ì†Œ (ì˜ˆ: https://github.sec.../user/repo.git)
            real_url = data.get("clone_url")
            print(f"âœ… ì°¾ì•˜ë‹¤! ì§„ì§œ ì£¼ì†Œ: {real_url}")
            return real_url
            
    except Exception as e:
        print(f"âŒ ë°©ì„ ëª» ì°¾ê² ìŠµë‹ˆë‹¤. ë°© ì´ë¦„ì´ '{PROJECT_NAME}' ë§ìŠµë‹ˆê¹Œ?")
        print(f"ì—ëŸ¬ ë‚´ìš©: {e}")
        sys.exit(1)

def push_to_server(real_url):
    """ì§„ì§œ ì£¼ì†Œì— í† í° ì‹¬ì–´ì„œ ë°œì‚¬"""
    print(f"\nğŸš€ [2ë‹¨ê³„] ì—…ë¡œë“œ ì‹œì‘...")

    # 1. URLì— í† í° ì‹¬ê¸° (https://ID:TOKEN@ì£¼ì†Œ...)
    # clone_urlì€ ë³´í†µ https://github.sec... í˜•íƒœì„
    auth_url = real_url.replace("https://", f"https://{GHE_ID}:{GHE_TOKEN}@", 1)

    # 2. ê¸°ì¡´ ì—°ê²° ëŠê³  ì¬ì—°ê²°
    subprocess.run("git remote remove origin", shell=True, stderr=subprocess.DEVNULL)
    run_cmd(f"git remote add origin {auth_url}")

    # 3. í˜„ì¬ ë¸Œëœì¹˜ ì´ë¦„ ì°¾ê¸° (mainì¸ì§€ masterì¸ì§€)
    try:
        branch = subprocess.check_output("git branch --show-current", shell=True).decode().strip()
        if not branch: branch = "main" # ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’
    except:
        branch = "main"

    print(f"ğŸ‘‰ í˜„ì¬ ë¸Œëœì¹˜: {branch}")

    # 4. SSL ë¬´ì‹œí•˜ê³  í‘¸ì‹œ
    run_cmd("git config http.sslVerify false")
    
    # ì»¤ë°‹ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ í‘¸ì‹œê°€ ì•ˆë˜ë¯€ë¡œ ì²´í¬
    try:
        run_cmd(f"git push -u origin {branch}")
        print("\nğŸ‰ [ì„±ê³µ] ì—…ë¡œë“œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ì›¹ì—ì„œ í™•ì¸í•˜ì„¸ìš”.")
    except:
        print("\nâš ï¸ í‘¸ì‹œ ì‹¤íŒ¨. ë¡œì»¬ì— ì»¤ë°‹ëœ íŒŒì¼ì´ ì—†ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.")
        print("ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì§ì ‘ ì³ë³´ì„¸ìš”:")
        print("git add .")
        print('git commit -m "init"')
        print(f"git push -u origin {branch}")

if __name__ == "__main__":
    if not os.path.exists(".git"):
        print("âŒ í˜„ì¬ í´ë”ì— .gitì´ ì—†ìŠµë‹ˆë‹¤. 'git init' ë¨¼ì € í•˜ì„¸ìš”.")
    else:
        target_url = get_real_repo_url()
        push_to_server(target_url)