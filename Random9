import os

# === í”„ë¡œì íŠ¸ ì´ë¦„: DB Inspector ===
ROOT = "db_inspector"

files = {}

# 1. ë©”ì¸ ì‹¤í–‰ íŒŒì¼ (Flask App)
# - ì„¤ì • íŒŒì¼ ì—†ìŒ. ìš”ì²­ ì˜¬ ë•Œë§ˆë‹¤ í™”ë©´ì—ì„œ ì…ë ¥ë°›ì€ ì •ë³´ë¡œ ì ‘ì†í•¨.
files[f"{ROOT}/app.py"] = r"""
from flask import Flask, render_template, request, Response, stream_with_context
import pymysql
import pymssql
import traceback
import datetime

app = Flask(__name__)

# === [ìœ í‹¸] HTML ë¡œê·¸ í¬ë§¤í„° ===
def log(msg, level="INFO"):
    ts = datetime.datetime.now().strftime("%H:%M:%S")
    colors = {"INFO":"#ccc", "OK":"#0f0", "WARN":"#fa0", "ERROR":"#f44", "HEADER":"#0cf"}
    c = colors.get(level, "#ccc")
    return f'<div style="color:{c}; font-family:monospace; margin:2px;">[{ts}] {msg}</div>\n'

def table(data):
    if not data: return '<div style="color:#666; margin-left:10px;">ë°ì´í„° ì—†ìŒ</div>'
    h = data[0].keys()
    html = '<table style="width:98%; border-collapse:collapse; border:1px solid #444; font-size:12px; margin:5px auto;">'
    html += '<thead style="background:#333; color:#fff;"><tr>' + ''.join([f'<th style="border:1px solid #555; padding:5px;">{k}</th>' for k in h]) + '</tr></thead><tbody>'
    for row in data:
        html += '<tr style="background:#1e1e1e;">' + ''.join([f'<td style="border:1px solid #555; padding:5px; color:#ccc;">{str(v)[:100]}</td>' for v in row.values()]) + '</tr>'
    html += '</tbody></table>'
    return html

# === [ë¼ìš°íŠ¸] ë©”ì¸ í™”ë©´ ===
@app.route('/')
def index():
    return render_template('index.html')

# === [ë¼ìš°íŠ¸] ì§„ë‹¨ ì‹¤í–‰ (POSTë¡œ ì ‘ì†ì •ë³´ ë°›ìŒ) ===
@app.route('/scan', methods=['POST'])
def scan():
    # í™”ë©´ì—ì„œ ì…ë ¥ë°›ì€ ì ‘ì† ì •ë³´
    db_type = request.form.get('db_type')
    host = request.form.get('host')
    port = int(request.form.get('port'))
    user = request.form.get('user')
    password = request.form.get('password')
    db_name = request.form.get('db_name', 'master') # MSSQL default

    def generate():
        yield log(f"ğŸš€ [{db_type.upper()}] {host}:{port} ì ‘ì† ì‹œë„ ì¤‘...", "HEADER")
        
        conn = None
        try:
            # === 1. MSSQL ì§„ë‹¨ ë¡œì§ ===
            if db_type == 'mssql':
                conn = pymssql.connect(server=host, port=port, user=user, password=password, database=db_name)
                cursor = conn.cursor(as_dict=True)
                yield log("ì ‘ì† ì„±ê³µ! ì •ë°€ ì§„ë‹¨ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œì‘...", "OK")

                # (1) ì•…ì„± ì¿¼ë¦¬ TOP 10
                yield log("1. CPU ê³¼ë¶€í•˜ ìœ ë°œ ì•…ì„± ì¿¼ë¦¬ TOP 10", "WARN")
                cursor.execute("SELECT TOP 10 SUBSTRING(qt.text, (qs.statement_start_offset/2)+1, ((CASE qs.statement_end_offset WHEN -1 THEN DATALENGTH(qt.text) ELSE qs.statement_end_offset END - qs.statement_start_offset)/2) + 1) AS [Query], qs.execution_count AS [Execs], qs.total_worker_time/1000 AS [TotalCPU_ms], qs.last_execution_time FROM sys.dm_exec_query_stats qs CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) qt ORDER BY qs.total_worker_time DESC")
                yield table(cursor.fetchall())

                # (2) ë¸”ë¡œí‚¹ ì„¸ì…˜
                yield log("2. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë¸”ë¡œí‚¹(Lock) ì„¸ì…˜ ì¶”ì ", "ERROR")
                cursor.execute("SELECT spid, blocked, status, loginame, hostname, cmd, wait_time FROM sys.sysprocesses WHERE blocked > 0 OR spid IN (SELECT blocked FROM sys.sysprocesses)")
                yield table(cursor.fetchall())

                # (3) ëˆ„ë½ ì¸ë±ìŠ¤
                yield log("3. ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ëˆ„ë½ ì¸ë±ìŠ¤ ì¶”ì²œ", "WARN")
                cursor.execute("SELECT TOP 10 d.statement AS [Table], ROUND(s.avg_total_user_cost * s.avg_user_impact * (s.user_seeks + s.user_scans),0) AS [Score], mid.equality_columns FROM sys.dm_db_missing_index_group_stats s JOIN sys.dm_db_missing_index_groups g ON s.group_handle = g.index_group_handle JOIN sys.dm_db_missing_index_details mid ON mid.index_handle = g.index_handle ORDER BY [Score] DESC")
                yield table(cursor.fetchall())

                # (4) íŒŒì¼ ìš©ëŸ‰
                yield log("4. DB íŒŒì¼ë³„ ìš©ëŸ‰ ì ê²€", "INFO")
                cursor.execute("SELECT d.name AS [DB], ROUND(SUM(mf.size) * 8 / 1024, 0) AS [SizeMB] FROM sys.master_files mf JOIN sys.databases d ON mf.database_id = d.database_id GROUP BY d.name ORDER BY [SizeMB] DESC")
                yield table(cursor.fetchall())

            # === 2. MySQL ì§„ë‹¨ ë¡œì§ ===
            elif db_type == 'mysql':
                conn = pymysql.connect(host=host, port=port, user=user, password=password, charset='utf8mb4', cursorclass=pymysql.cursors.DictCursor)
                cursor = conn.cursor()
                yield log("ì ‘ì† ì„±ê³µ! ì •ë°€ ì§„ë‹¨ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œì‘...", "OK")

                # (1) í”„ë¡œì„¸ìŠ¤ ë¦¬ìŠ¤íŠ¸
                yield log("1. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì¿¼ë¦¬ (Processlist)", "WARN")
                cursor.execute("SELECT id, user, host, db, command, time, state, info FROM information_schema.processlist WHERE command != 'Sleep' ORDER BY time DESC LIMIT 20")
                yield table(cursor.fetchall())

                # (2) í…Œì´ë¸” ìš©ëŸ‰
                yield log("2. ìš©ëŸ‰ ìƒìœ„ í…Œì´ë¸” TOP 20", "INFO")
                cursor.execute("SELECT table_schema AS [DB], table_name AS [Table], round(((data_length + index_length) / 1024 / 1024), 2) AS [SizeMB], table_rows FROM information_schema.TABLES WHERE table_schema NOT IN ('information_schema', 'mysql', 'performance_schema', 'sys') ORDER BY (data_length + index_length) DESC LIMIT 20")
                yield table(cursor.fetchall())

                # (3) ìƒíƒœ ë³€ìˆ˜
                yield log("3. ì£¼ìš” DB ìƒíƒœ ë³€ìˆ˜", "OK")
                cursor.execute("SHOW GLOBAL STATUS WHERE Variable_name IN ('Aborted_connects', 'Threads_connected', 'Threads_running', 'Slow_queries', 'Uptime')")
                yield table(cursor.fetchall())

            yield log("âœ¨ ëª¨ë“  ì§„ë‹¨ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "HEADER")

        except Exception as e:
            yield log(f"â›” ì—°ê²°/ì§„ë‹¨ ì‹¤íŒ¨: {str(e)}", "ERROR")
            yield log(traceback.format_exc(), "ERROR")
        finally:
            if conn: conn.close()

    return Response(stream_with_context(generate()), mimetype='text/html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
"""

# 2. UI í…œí”Œë¦¿ (templates/index.html)
# - ì—¬ê¸°ì„œ ì ‘ì† ì •ë³´ë¥¼ ì…ë ¥ë°›ìŠµë‹ˆë‹¤.
files[f"{ROOT}/templates/index.html"] = r"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DB Remote Inspector</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: sans-serif; display: flex; height: 100vh; margin: 0; }
        .sidebar { width: 300px; background: #1e1e1e; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; gap: 15px; }
        .main { flex: 1; background: #000; padding: 20px; display: flex; flex-direction: column; }
        
        input, select, button { width: 100%; padding: 10px; background: #2d2d2d; border: 1px solid #444; color: #fff; box-sizing: border-box; margin-top: 5px; }
        label { font-size: 12px; color: #aaa; font-weight: bold; }
        button { background: #007acc; border-color: #005f9e; cursor: pointer; font-weight: bold; margin-top: 20px; }
        button:hover { background: #0098ff; }
        
        #log { flex: 1; border: 1px solid #333; padding: 10px; overflow-y: auto; font-family: monospace; background: #080808; }
        h2 { margin: 0 0 20px 0; color: #fff; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Target DB Info</h2>
        <form id="diagForm" onsubmit="return false;">
            
            <label>Database Type</label>
            <select name="db_type" id="db_type" onchange="toggleDbFields()">
                <option value="mssql">MSSQL (SQL Server)</option>
                <option value="mysql">MySQL / MariaDB</option>
            </select>

            <label>Host IP</label>
            <input type="text" name="host" value="localhost" placeholder="127.0.0.1">

            <label>Port</label>
            <input type="number" name="port" id="port" value="1433">

            <label>User ID</label>
            <input type="text" name="user" value="sa" placeholder="username">

            <label>Password</label>
            <input type="password" name="password" value="" placeholder="password">

            <div id="mssql_fields">
                <label>Initial DB (MSSQL Only)</label>
                <input type="text" name="db_name" value="master">
            </div>

            <button onclick="startDiag()">Connect & Diagnose</button>
        </form>
    </div>

    <div class="main">
        <div id="log">
            <div style="color:#007acc; text-align:center; margin-top:20%;">
                <h3>DB ì ‘ì† ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì§„ë‹¨ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</h3>
            </div>
        </div>
    </div>

    <script>
        function toggleDbFields() {
            const type = document.getElementById('db_type').value;
            document.getElementById('port').value = (type === 'mssql') ? 1433 : 3306;
            document.getElementById('mssql_fields').style.display = (type === 'mssql') ? 'block' : 'none';
        }

        async function startDiag() {
            const log = document.getElementById('log');
            const form = document.getElementById('diagForm');
            const formData = new FormData(form);

            log.innerHTML = `<div style="color:cyan">--- [System] ì ‘ì† ì‹œë„ ì¤‘... ---</div>`;
            
            try {
                const response = await fetch('/scan', { method: 'POST', body: formData });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                log.innerHTML = ''; // Clear previous log
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    log.innerHTML += decoder.decode(value);
                    log.scrollTop = log.scrollHeight;
                }
            } catch (err) {
                log.innerHTML += `<div style="color:red">[Error] í†µì‹  ì‹¤íŒ¨: ${err}</div>`;
            }
        }
    </script>
</body>
</html>
"""

# === ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ìƒì„± ===
for path, content in files.items():
    dir_name = os.path.dirname(path)
    if dir_name and not os.path.exists(dir_name):
        os.makedirs(dir_name)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content.strip())
    print(f"âœ… Created: {path}")

print("\n" + "="*50)
print("ì´ì œ ì„¤ì • íŒŒì¼ ìˆ˜ì •í•  í•„ìš” ì—†ìŠµë‹ˆë‹¤.")
print("1. í´ë” ì´ë™: cd db_inspector")
print("2. íŒ¨í‚¤ì§€ ì„¤ì¹˜: pip install flask pymysql pymssql")
print("3. ì‹¤í–‰: python app.py")
print("4. ë¸Œë¼ìš°ì €(http://localhost:5000)ë¥¼ ì—´ë©´ ì…ë ¥ì°½ì´ ë‚˜ì˜µë‹ˆë‹¤.")
print("="*50)