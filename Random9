import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("‚ùå ÌîÑÎ°úÏ†ùÌä∏ Ìè¥ÎçîÍ∞Ä ÏóÜÏäµÎãàÎã§.")
    exit()

print("üöÄ AI Bridge v54: Absolute Restoration with Technical Specifics...")

# 1. database.py (ÌòïÎãòÏù¥ Ï£ºÏã† 1633 Ìè¨Ìä∏ Î∞è AgentBuilderSR Î∞òÏòÅ)
db_code = r"""import pymssql
def get_db_connection():
    return pymssql.connect(
        server='127.0.0.1', # Î°úÏª¨ DB Í∏∞Ï§Ä (ÌïÑÏöîÏãú ÏàòÏ†ï)
        port='1633',        # ÌòïÎãòÏù¥ Ï£ºÏã† Ìè¨Ìä∏
        user='sa', 
        password='password', # Î≥∏Ïù∏ ÎπÑÎ≤à ÌôïÏù∏
        database='AgentBuilderSR', # ÌòïÎãòÏù¥ Ï£ºÏã† DBÎ™Ö
        charset='utf8'
    )
"""
with open(os.path.join(base_dir, "app", "database.py"), "w", encoding="utf-8") as f: f.write(db_code)

# 2. api_routes.py (IP ÌôîÏù¥Ìä∏Î¶¨Ïä§Ìä∏ 10.244.120.24 Ï†ÅÏö© Î∞è Î™®Îì† API Î≥µÍµ¨)
api_code = r"""from flask import Blueprint, request, jsonify, abort
from app.database import get_db_connection
import subprocess, os, json, shlex, base64

api_bp = Blueprint('api', __name__)

# üõ°Ô∏è [IP WHITELIST] - ÌòïÎãòÏù¥ Ï£ºÏã† ÏïÑÏù¥Ìîº
IP_WHITELIST = ["127.0.0.1", "localhost", "10.244.120.24"]

@api_bp.before_app_request
def gate():
    if request.path.startswith('/static'): return
    ip = request.headers.get('X-Forwarded-For', request.remote_addr).split(',')[0].strip()
    if ip not in IP_WHITELIST:
        return jsonify({"error": "Unauthorized", "ip": ip}), 403

# --- [STATS] ÏßëÍ≥Ñ Í∏∞Îä• Î≥µÍµ¨ ---
@api_bp.route('/api/stats/dashboard', methods=['GET'])
def get_dash():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    groups = cursor.fetchall()
    def gs(days):
        sql = f"SELECT COUNT(*) as cnt, ISNULL(SUM(DATEDIFF(SECOND, StartedAt, CompletedAt)), 0) as dur FROM cline_TaskQueue WHERE Status='Done' AND CompletedAt >= DATEADD(day, -{days}, GETDATE())"
        cursor.execute(sql); return cursor.fetchone()
    stats = {'day': gs(1), 'week': gs(7), 'month': gs(30)}
    conn.close(); return jsonify({'groups': groups, 'counts': stats})

# --- [RULES] ÏàòÏ†ï(PUT) Î∞è Í¥ÄÎ¶¨ Î≥µÍµ¨ ---
@api_bp.route('/api/rules', methods=['GET', 'POST', 'PUT', 'DELETE'])
def handle_rules():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_ProjectRules ORDER BY RuleID DESC")
        res = cursor.fetchall(); conn.close(); return jsonify(res)
    d = request.json
    if request.method == 'POST':
        cursor.execute("INSERT INTO cline_ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", (d['name'], d['content']))
    elif request.method == 'PUT':
        cursor.execute("UPDATE cline_ProjectRules SET RuleName=%s, RuleContent=%s WHERE RuleID=%s", (d['name'], d['content'], d['id']))
    elif request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_ProjectRules WHERE RuleID=%s", (request.args.get('id'),))
    conn.commit(); conn.close(); return jsonify({'status': 'success'})

# --- [LINKS] Ïõπ Ï£ºÏÜå Í¥ÄÎ¶¨ Î≥µÍµ¨ ---
@api_bp.route('/api/bookmarks', methods=['GET', 'POST', 'DELETE'])
def handle_bm():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_WebBookmarks ORDER BY CreatedAt ASC")
        res = cursor.fetchall(); conn.close(); return jsonify(res)
    if request.method == 'POST':
        d = request.json
        cursor.execute("INSERT INTO cline_WebBookmarks (Title, URL) VALUES (%s, %s)", (d['title'], d['url']))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})
    if request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_WebBookmarks WHERE BookmarkID=%s", (request.args.get('id'),))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})

# --- [SYSTEM] VSCode, Queue, History ---
@api_bp.route('/api/open_vscode', methods=['POST'])
def open_v():
    d = request.json
    cmd = ['code', '--new-window']
    if d['ip'] not in ['127.0.0.1', 'localhost']: cmd.extend(['--remote', f"ssh-remote+{d['account']}@{d['ip']}", d['path']])
    else: cmd.append(d['path'])
    subprocess.Popen(cmd, env=os.environ.copy()); return jsonify({'status': 'success'})

@api_bp.route('/api/queue', methods=['GET', 'POST', 'DELETE'])
def handle_q():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT TaskID, ProjectName, TaskContent, Status, CONVERT(VARCHAR, StartedAt, 120) as StartedAt FROM cline_TaskQueue WHERE Status IN ('Pending', 'Processing')")
        r = cursor.fetchall(); conn.close(); return jsonify(r)
    # (POST, DELETE logic Ïú†ÏßÄ)
    return jsonify([])

@api_bp.route('/api/history', methods=['POST'])
def get_hist():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT TaskID, TaskContent, Status, ResultContent, CONVERT(VARCHAR, CreatedAt, 120) as CreatedAt FROM cline_TaskQueue WHERE ProjectPath=%s ORDER BY TaskID DESC", (request.json.get('path'),)); r = cursor.fetchall(); conn.close(); return jsonify(r)
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f: f.write(api_code)

# 3. settings.html (Î£∞ ÏàòÏ†ï & ÎßÅÌÅ¨ Í¥ÄÎ¶¨ UI ÏôÑÏ†Ñ ÌÜµÌï©)
settings_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head><meta charset="UTF-8"><title>Settings</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"></head>
<body class="bg-dark text-white p-5">
    <div class="container">
        <div class="d-flex justify-content-between mb-4"><h2>‚öôÔ∏è System Config</h2><a href="/" class="btn btn-outline-light">Dashboard</a></div>
        
        <div class="card bg-black border-secondary p-4 mb-4">
            <h5 class="text-info">Rule Manager</h5>
            <input type="hidden" id="editRuleId">
            <input type="text" id="ruleName" class="form-control bg-dark text-white mb-2" placeholder="Rule Name">
            <textarea id="ruleContent" class="form-control bg-dark text-white mb-2" rows="5" placeholder="Content..."></textarea>
            <div class="text-end"><button class="btn btn-info fw-bold" onclick="saveRule()">Save Rule</button></div>
            <table class="table table-dark mt-3" id="ruleTable"><tbody></tbody></table>
        </div>

        <div class="card bg-black border-secondary p-4">
            <h5 class="text-warning">Web Links</h5>
            <div class="d-flex gap-2 mb-3"><input type="text" id="bmTitle" class="form-control bg-dark text-white" placeholder="Title"><input type="text" id="bmUrl" class="form-control bg-dark text-white" placeholder="URL"><button class="btn btn-warning" onclick="addBookmark()">Add</button></div>
            <table class="table table-dark" id="bmTable"><tbody></tbody></table>
        </div>
    </div>
    <script>
        function loadAll() {
            fetch('/api/rules').then(r=>r.json()).then(data=>{ document.getElementById('ruleTable').innerHTML = data.map(r=>`<tr><td>${r.RuleName}</td><td><button class="btn btn-sm btn-outline-warning" onclick="editRule(${r.RuleID},'${r.RuleName}',\`${r.RuleContent}\`)">Edit</button><button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteRule(${r.RuleID})">Del</button></td></tr>`).join(''); });
            fetch('/api/bookmarks').then(r=>r.json()).then(data=>{ document.getElementById('bmTable').innerHTML = data.map(b=>`<tr><td>${b.Title}</td><td>${b.URL}</td><td><button class="btn btn-sm btn-outline-danger" onclick="deleteBookmark(${b.BookmarkID})">Del</button></td></tr>`).join(''); });
        }
        function editRule(id,n,c){ document.getElementById('editRuleId').value=id; document.getElementById('ruleName').value=n; document.getElementById('ruleContent').value=c; }
        function saveRule(){
            const id=document.getElementById('editRuleId').value, n=document.getElementById('ruleName').value, c=document.getElementById('ruleContent').value;
            fetch('/api/rules', { method: id?'PUT':'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id, name:n, content:c}) }).then(()=>{ location.reload(); });
        }
        function deleteRule(id){ fetch('/api/rules?id='+id, {method:'DELETE'}).then(()=>loadAll()); }
        function addBookmark(){ fetch('/api/bookmarks', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title:document.getElementById('bmTitle').value, url:document.getElementById('bmUrl').value})}).then(()=>loadAll()); }
        function deleteBookmark(id){ fetch('/api/bookmarks?id='+id, {method:'DELETE'}).then(()=>loadAll()); }
        document.addEventListener('DOMContentLoaded', loadAll);
    </script>
</body></html>
"""
with open(os.path.join(base_dir, "app", "templates", "settings.html"), "w", encoding="utf-8") as f: f.write(settings_html)

print("\n‚ú® v54 ÏôÑÎ≤Ω Î≥µÍµ¨ ÏôÑÎ£å! Ïù¥Ï†ú Î™®Îì† Í∏∞Îä•Ïù¥ ÌòïÎãò ÏïÑÏù¥ÌîºÏôÄ DB ÌôòÍ≤ΩÏóêÏÑú ÎèåÏïÑÍ∞ëÎãàÎã§.")