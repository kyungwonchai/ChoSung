import os
import pymssql

# ==========================================
# 1. API Route ìˆ˜ì • (ë™ì  ë³€ìˆ˜ ì¹˜í™˜ ë¡œì§ ì¶”ê°€)
# ==========================================
# í•µì‹¬: ì‚¬ìš©ìê°€ ì„ íƒí•œ ë£° í…ìŠ¤íŠ¸ ì•ˆì— {{PROJECT_NAME}} ê°™ì€ê²Œ ìˆìœ¼ë©´
#       ì‹¤ì œ ê·¸ í–‰ì˜ í”„ë¡œì íŠ¸ ì´ë¦„ìœ¼ë¡œ ë°”ê¿”ì¹˜ê¸°í•´ì„œ ì „ì†¡í•¨.
# ==========================================

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("âŒ ì˜¤ë¥˜: í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

api_routes_code = r"""from flask import Blueprint, request, jsonify
from app.database import get_db_connection
from app.services.ssh_service import send_rule_via_ssh
import subprocess
import os

api_bp = Blueprint('api', __name__)

# --- Configuration for Agent ---
# ì—ì´ì „íŠ¸ê°€ ì ‘ì†í•  ì´ ì„œë²„(ë¸Œë¦¿ì§€)ì˜ ì£¼ì†Œ
BRIDGE_API_URL = "http://192.168.0.10:9111" # [ì¤‘ìš”] ì‹¤ì œ ìš°ë¶„íˆ¬ ì„œë²„ IPë¡œ ìˆ˜ì • í•„ìš”

@api_bp.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    target_ip = data.get('ip')
    user = data.get('account')
    path = data.get('path')
    cmd = ['code', '--no-sandbox', '--new-window']
    remote_arg = f"ssh-remote+{user}@{target_ip}"
    cmd.extend(['--remote', remote_arg, path])
    try:
        env = os.environ.copy()
        if 'DISPLAY' not in env: env['DISPLAY'] = ':0'
        subprocess.Popen(cmd, env=env)
        return jsonify({'status': 'success'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

@api_bp.route('/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, 'No Group') as GroupName, COUNT(*) as Cnt FROM FolderIndex GROUP BY ISNULL(GroupName, 'No Group')")
    group_counts = cursor.fetchall()
    cursor.execute("SELECT ISNULL(f.GroupName, 'No Group') as GroupName, COUNT(*) as Cnt FROM TaskQueue q JOIN FolderIndex f ON q.ProjectName = f.DisplayName WHERE q.Status IN ('Pending', 'Processing') GROUP BY ISNULL(f.GroupName, 'No Group')")
    active_counts = cursor.fetchall()
    conn.close()
    return jsonify({'groups': group_counts, 'active': active_counts})

@api_bp.route('/rules', methods=['GET', 'POST'])
def handle_rules():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM ProjectRules ORDER BY RuleID DESC")
        rules = cursor.fetchall()
        conn.close()
        return jsonify(rules)
    if request.method == 'POST':
        data = request.json
        cursor.execute("INSERT INTO ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", (data['name'], data['content']))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

@api_bp.route('/rules/deploy', methods=['POST'])
def deploy_rule():
    data = request.json
    project_name = data.get('project_name')
    rule_id = data.get('rule_id')
    
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    # 1. ë£° ì›ë³¸ ê°€ì ¸ì˜¤ê¸°
    cursor.execute("SELECT RuleContent FROM ProjectRules WHERE RuleID=%s", (rule_id,))
    rule_row = cursor.fetchone()
    
    # 2. íƒ€ê²Ÿ í”„ë¡œì íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    cursor.execute("SELECT IPAddress, Account, FullPath FROM FolderIndex WHERE DisplayName=%s", (project_name,))
    target = cursor.fetchone()
    
    if not rule_row or not target:
        conn.close()
        return jsonify({'status': 'error', 'message': 'Not found'}), 404
        
    # [í•µì‹¬ ë¡œì§ ë³µì›] ë™ì  ë³€ìˆ˜ ì¹˜í™˜ (Templating)
    # ë£° ë‚´ìš© ì†ì— ìˆëŠ” {{ë³€ìˆ˜}}ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
    final_content = rule_row['RuleContent']
    final_content = final_content.replace('{{PROJECT_NAME}}', project_name)
    final_content = final_content.replace('{{API_URL}}', BRIDGE_API_URL)
    final_content = final_content.replace('{{TARGET_IP}}', target['IPAddress'])
    final_content = final_content.replace('{{TARGET_PATH}}', target['FullPath'])
    
    # 3. ì „ì†¡ (ìˆ˜ì •ëœ ë‚´ìš©ìœ¼ë¡œ)
    success, msg = send_rule_via_ssh(target['IPAddress'], target['Account'], final_content, target['FullPath'])
    
    if success:
        cursor.execute("UPDATE FolderIndex SET LastRuleContent=%s WHERE DisplayName=%s", (final_content, project_name))
        conn.commit()
        
    conn.close()
    return jsonify({'status': 'success' if success else 'error', 'message': msg})

@api_bp.route('/memos/<project_name>', methods=['GET', 'POST'])
def handle_memo(project_name):
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT MemoContent FROM ProjectMemos WHERE ProjectName=%s", (project_name,))
        row = cursor.fetchone()
        conn.close()
        return jsonify({'content': row['MemoContent'] if row else ''})
    if request.method == 'POST':
        content = request.json.get('content')
        sql = "MERGE ProjectMemos AS target USING (SELECT %s as PName) AS source ON (target.ProjectName = source.PName) WHEN MATCHED THEN UPDATE SET MemoContent = %s, UpdatedAt = GETDATE() WHEN NOT MATCHED THEN INSERT (ProjectName, MemoContent) VALUES (%s, %s);"
        cursor.execute(sql, (project_name, content, project_name, content))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

@api_bp.route('/queue', methods=['GET', 'POST'])
def handle_queue():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        p_name = request.args.get('project')
        cursor.execute("SELECT * FROM TaskQueue WHERE ProjectName=%s AND Status IN ('Pending', 'Processing') ORDER BY TaskID", (p_name,))
        rows = cursor.fetchall()
        conn.close()
        return jsonify(rows)
    if request.method == 'POST':
        data = request.json
        p_name = data.get('project')
        content = data.get('content')
        cursor.execute("INSERT INTO TaskQueue (ProjectName, TaskContent) VALUES (%s, %s)", (p_name, content))
        cursor.execute("UPDATE FolderIndex SET TaskCount = TaskCount + 1, LastTaskDate = GETDATE() WHERE DisplayName=%s", (p_name,))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})
"""

with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(api_routes_code)

# ==========================================
# 2. DBì— 'Auto-Agent Rule' ìë™ ë“±ë¡
# ==========================================
# ì´ê²ƒì´ ë§ì”€í•˜ì‹  "Go/Do"ë¥¼ ì¹˜ë©´ APIë¥¼ í˜¸ì¶œí•˜ëŠ” í•µì‹¬ ë£°ì…ë‹ˆë‹¤.
# ì‚¬ìš©ìê°€ ì´ ë£°ì„ ì„ íƒí•´ì„œ ë°°í¬í•˜ë©´, í•´ë‹¹ í”„ë¡œì íŠ¸ì— ë§ëŠ” API ì£¼ì†Œì™€ í”„ë¡œì íŠ¸ëª…ì´ ë°•í™ë‹ˆë‹¤.

agent_rule_content = """# AI Agent Operation Rules (Auto-Generated)

## 1. Role & Identity
You are an AI developer agent assigned to the project: **{{PROJECT_NAME}}**.
Your primary control server is located at: **{{API_URL}}**

## 2. Magic Commands (Action Triggers)
When the user types specific keywords, you must execute the corresponding protocols immediately.

### Command: "Go" or "Do"
**Action:** Fetch and Execute Task
1.  **GET Task:** Send a GET request to `{{API_URL}}/api/queue?project={{PROJECT_NAME}}`
2.  **Check:**
    * If the list is empty, reply: "No pending tasks in queue."
    * If tasks exist, take the first task (TaskID) and change its status to 'Processing' (if API supports).
3.  **Execute:** Perform the instruction described in the `TaskContent`.
4.  **Report:** After completion, summarize the result and reply to the user.

## 3. Communication Protocol
* Always check the queue url: `{{API_URL}}/api/queue?project={{PROJECT_NAME}}`
* When reporting errors, include the full error trace.
* Do not hallucinate tasks; only execute what is in the JSON response.

## 4. Environment
* Project Path: `{{TARGET_PATH}}`
* OS: Windows/Linux (Auto-detect)
"""

def insert_default_rule():
    # DB ì ‘ì† ì •ë³´ (ê¸°ì¡´ê³¼ ë™ì¼)
    DB_HOST = '192.168.0.10'
    DB_USER = 'sa'
    DB_PASSWORD = 'password'
    DB_NAME = 'MyDatabase'
    
    conn = pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)
    cursor = conn.cursor()
    
    # ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
    cursor.execute("SELECT Count(*) FROM ProjectRules WHERE RuleName = 'Auto-Agent Protocol (Go/Do)'")
    if cursor.fetchone()[0] == 0:
        cursor.execute("INSERT INTO ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", 
                       ('Auto-Agent Protocol (Go/Do)', agent_rule_content))
        conn.commit()
        print("âœ… DB: 'Auto-Agent Protocol (Go/Do)' ë£°ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
    else:
        # ë‚´ìš© ì—…ë°ì´íŠ¸
        cursor.execute("UPDATE ProjectRules SET RuleContent = %s WHERE RuleName = 'Auto-Agent Protocol (Go/Do)'", 
                       (agent_rule_content,))
        conn.commit()
        print("âœ… DB: 'Auto-Agent Protocol (Go/Do)' ë£°ì´ ìµœì‹  ë‚´ìš©ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
        
    conn.close()

if __name__ == "__main__":
    try:
        insert_default_rule()
    except Exception as e:
        print(f"âš ï¸ DB ì—°ê²° ì‹¤íŒ¨ (ë£° ë“±ë¡ ìŠ¤í‚µ): {e}")
        print("ğŸ‘‰ api_routes.pyëŠ” ì •ìƒì ìœ¼ë¡œ íŒ¨ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.")

print("âœ… ì‹œìŠ¤í…œ ë³µêµ¬ ì™„ë£Œ!")
print("1. ë£° ì „ì†¡ ì‹œ {{PROJECT_NAME}}, {{API_URL}} ë“±ì´ ì‹¤ì œ ê°’ìœ¼ë¡œ ìë™ ì¹˜í™˜ë©ë‹ˆë‹¤.")
print("2. 'Go' ë˜ëŠ” 'Do' ì…ë ¥ ì‹œ ì‘ë™í•˜ëŠ” í‘œì¤€ í”„ë¡œí† ì½œ ë£°ì´ DBì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
print("ğŸ‘‰ ì´ì œ ì›¹ì—ì„œ 'Auto-Agent Protocol' ë£°ì„ ì„ íƒí•´ì„œ ì „ì†¡í•´ë³´ì„¸ìš”!")