import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("‚ùå ÌîÑÎ°úÏ†ùÌä∏ Ìè¥ÎçîÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.")
    exit()

print("üî• [CORE RESTORE] v52: Rule Management & Token Error Fix...")

# 1. settings.html (Î£∞ Í¥ÄÎ¶¨ UI + Î∂ÅÎßàÌÅ¨ Í¥ÄÎ¶¨ ÌÜµÌï© Î≥µÍµ¨)
settings_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>BRIDGE SETTINGS | RULES & LINKS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #050508; color: #e0e0e0; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .settings-card { background: rgba(20, 20, 35, 0.6); border: 1px solid rgba(100, 100, 255, 0.1); border-radius: 16px; padding: 25px; margin-bottom: 30px; backdrop-filter: blur(10px); }
        .form-control { background: #000; border: 1px solid #333; color: #fff; font-family: 'Consolas', monospace; }
        .form-control:focus { background: #0a0a0a; border-color: #5c6bc0; color: #fff; box-shadow: 0 0 10px rgba(92, 107, 192, 0.3); }
        .table { color: #ccc; vertical-align: middle; }
        .table thead th { border-bottom: 2px solid #5c6bc0; color: #00e5ff; text-transform: uppercase; font-size: 0.8rem; }
        .rule-content-preview { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #888; font-size: 0.85rem; }
        .nav-tabs { border-bottom: 1px solid #333; }
        .nav-link { color: #888; border: none !important; }
        .nav-link.active { background: transparent !important; color: #00e5ff !important; border-bottom: 2px solid #00e5ff !important; }
    </style>
</head>
<body class="p-5">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h2 class="fw-bold"><i class="bi bi-cpu-fill me-2 text-info"></i> SYSTEM CONFIGURATION</h2>
            <a href="/" class="btn btn-outline-light rounded-pill px-4"><i class="bi bi-arrow-left me-2"></i>Dashboard</a>
        </div>

        <ul class="nav nav-tabs mb-4" id="configTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules-pane">Manage Rules</button></li>
            <li class="nav-item"><button class="nav-link" id="links-tab" data-bs-toggle="tab" data-bs-target="#links-pane">Web Bookmarks</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="rules-pane">
                <div class="settings-card">
                    <h5 class="mb-4 text-info"><i class="bi bi-journal-code me-2"></i> Project Rules (.clinerules)</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><input type="text" id="ruleName" class="form-control" placeholder="Rule Name (e.g. Python Standard)"></div>
                        <div class="col-md-12">
                            <textarea id="ruleContent" class="form-control mt-2" rows="6" placeholder="Rule Content (Markdown format) - {SUBJECT}, {TARGET_PATH} Î≥ÄÏàò ÏÇ¨Ïö© Í∞ÄÎä•"></textarea>
                        </div>
                        <div class="col-md-12 text-end"><button class="btn btn-info px-5 fw-bold" onclick="addRule()">SAVE RULE</button></div>
                    </div>
                    
                    <table class="table">
                        <thead><tr><th>Name</th><th>Content Preview</th><th class="text-center">Action</th></tr></thead>
                        <tbody id="ruleList"></tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="links-pane">
                <div class="settings-card">
                    <h5 class="mb-4 text-warning"><i class="bi bi-link-45deg me-2"></i> External Links</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-5"><input type="text" id="bmTitle" class="form-control" placeholder="Title"></div>
                        <div class="col-md-5"><input type="text" id="bmUrl" class="form-control" placeholder="https://..."></div>
                        <div class="col-md-2"><button class="btn btn-warning w-100 fw-bold" onclick="addBookmark()">ADD LINK</button></div>
                    </div>
                    <table class="table">
                        <tbody id="bookmarkList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Î£∞ Í¥ÄÎ¶¨ Î°úÏßÅ
        function loadRules() {
            fetch('/api/rules').then(r => r.json()).then(data => {
                const list = document.getElementById('ruleList');
                list.innerHTML = data.map(r => `
                    <tr>
                        <td class="fw-bold text-white">${r.RuleName}</td>
                        <td><div class="rule-content-preview">${r.RuleContent}</div></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRule(${r.RuleID})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        function addRule() {
            const name = document.getElementById('ruleName').value;
            const content = document.getElementById('ruleContent').value;
            if(!name || !content) return alert('Ìï≠Î™©ÏùÑ Ï±ÑÏõåÎùº');
            fetch('/api/rules', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, content})
            }).then(() => {
                document.getElementById('ruleName').value = '';
                document.getElementById('ruleContent').value = '';
                loadRules();
            });
        }

        function deleteRule(id) {
            if(confirm('ÏÇ≠Ï†ú?')) fetch(`/api/rules?id=${id}`, { method: 'DELETE' }).then(() => loadRules());
        }

        // Î∂ÅÎßàÌÅ¨ Î°úÏßÅ (Í∏∞Ï°¥ Ïú†ÏßÄ)
        function loadBookmarks() {
            fetch('/api/bookmarks').then(r => r.json()).then(data => {
                const list = document.getElementById('bookmarkList');
                list.innerHTML = data.map(b => `<tr><td class="fw-bold">${b.Title}</td><td class="text-info">${b.URL}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="deleteBookmark(${b.BookmarkID})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
            });
        }
        
        function addBookmark() {
            const title = document.getElementById('bmTitle').value;
            const url = document.getElementById('bmUrl').value;
            fetch('/api/bookmarks', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({title, url}) }).then(() => { loadBookmarks(); });
        }

        function deleteBookmark(id) { fetch(`/api/bookmarks?id=${id}`, { method: 'DELETE' }).then(() => loadBookmarks()); }

        document.addEventListener('DOMContentLoaded', () => { loadRules(); loadBookmarks(); });
    </script>
</body>
</html>
"""
with open(os.path.join(base_dir, "app", "templates", "settings.html"), "w", encoding="utf-8") as f:
    f.write(settings_html)

# 2. api_routes.py (Î£∞ CRUD API Ï∂îÍ∞Ä Î∞è JSON ÏùëÎãµ Î≥¥Ïû•)
api_code = r"""from flask import Blueprint, request, jsonify, abort
from app.database import get_db_connection
import subprocess, os, json, shlex, urllib.request, ssl, re, base64

api_bp = Blueprint('api', __name__)

# üõ°Ô∏è [IP WHITELIST]
IP_WHITELIST = ["127.0.0.1", "localhost", "192.168.0.10"]

def get_v_ip():
    xf = request.headers.get('X-Forwarded-For')
    return xf.split(',')[0].strip() if xf else request.remote_addr

@api_bp.before_app_request
def gate():
    if request.path.startswith('/static'): return
    if get_v_ip() not in IP_WHITELIST:
        return jsonify({"error": "Unauthorized", "ip": get_v_ip()}), 403

# --- [RULE CRUD] ---
@api_bp.route('/api/rules', methods=['GET', 'POST', 'DELETE'])
def handle_rules():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_ProjectRules ORDER BY RuleID DESC")
        res = cursor.fetchall(); conn.close(); return jsonify(res)
    
    if request.method == 'POST':
        d = request.json
        cursor.execute("INSERT INTO cline_ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", (d['name'], d['content']))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})
    
    if request.method == 'DELETE':
        rid = request.args.get('id')
        cursor.execute("DELETE FROM cline_ProjectRules WHERE RuleID=%s", (rid,))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})

# --- [RULE DEPLOY] ---
@api_bp.route('/api/rules/deploy', methods=['POST'])
def deploy_rule():
    try:
        d = request.json
        conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
        cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (d['rule_id'],))
        r = cursor.fetchone()
        cursor.execute("SELECT IPAddress, Account FROM cline_FolderIndex WHERE FullPath=%s", (d['project_path'],))
        t = cursor.fetchone()
        if not r or not t: return jsonify({'status': 'error', 'message': 'Not Found'})

        content = r['RuleContent'].replace('{SUBJECT}', d['project_name']).replace('{TARGET_PATH}', d['project_path'].replace('\\', '/'))
        r_dir = os.path.join(d['project_path'], ".clinerules").replace('\\', '/')
        r_file = os.path.join(r_dir, "absoluterule.md").replace('\\', '/')
        b64 = base64.b64encode(content.encode('utf-8')).decode('utf-8')

        if t['IPAddress'] in ['127.0.0.1', 'localhost']:
            os.makedirs(r_dir, exist_ok=True)
            with open(r_file, 'w', encoding='utf-8') as f: f.write(content)
        else:
            cmd = f"mkdir -p {shlex.quote(r_dir)} && echo '{b64}' | base64 -d > {shlex.quote(r_file)}"
            subprocess.run(['ssh', f"{t['Account']}@{t['IPAddress']}", cmd], timeout=10)
        
        cursor.execute("UPDATE cline_FolderIndex SET LastRuleName=%s WHERE FullPath=%s", (r['RuleName'], d['project_path']))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

# --- [OTHERS] ---
@api_bp.route('/api/bookmarks', methods=['GET', 'POST', 'DELETE'])
def handle_bm():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_WebBookmarks"); r = cursor.fetchall(); conn.close(); return jsonify(r)
    if request.method == 'POST':
        d = request.json; cursor.execute("INSERT INTO cline_WebBookmarks (Title, URL) VALUES (%s, %s)", (d['title'], d['url']))
        conn.commit(); conn.close(); return jsonify({'status': 'success'})
    if request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_WebBookmarks WHERE BookmarkID=%s", (request.args.get('id'),)); conn.commit(); conn.close(); return jsonify({'status': 'success'})

@api_bp.route('/api/stats/dashboard', methods=['GET'])
def get_dash():
    conn = get_db_connection(); cursor = conn.cursor(as_dict=True); cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    g = cursor.fetchall(); conn.close(); return jsonify({'groups': g, 'counts': {'day':{'cnt':0}, 'week':{'cnt':0}, 'month':{'cnt':0}}})
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(api_code)

print("\n‚ú® [LIFEBLOOD RESTORED] v52: Rule Management UI & API is back.")
print("üëâ Ïù¥Ï†ú ÏÖãÌåÖ Ï∞ΩÏóêÏÑú Î£∞ÏùÑ ÎßàÏùåÍªè Ï∂îÍ∞ÄÌïòÍ≥† Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî. ÌÜ†ÌÅ∞ ÏóêÎü¨ÎèÑ Ïû°ÏïòÏäµÎãàÎã§.")