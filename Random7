import os
import sys

# ==============================================================================
# [설정] 현재 위치에 'dify_bridge' 폴더를 만듭니다.
# ==============================================================================
BASE_DIR = os.getcwd()
PROJECT_NAME = "dify_bridge"
TARGET_DIR = os.path.join(BASE_DIR, PROJECT_NAME)

# 님 가상환경 파이썬 경로
VENV_PYTHON = "/home/kw/myvenv1/bin/python" 
VENV_PIP = "/home/kw/myvenv1/bin/pip"

# ==============================================================================
# [파일 1] server.py : 브릿지 서버 (헤더 fsfds 제거 버전)
# ==============================================================================
SERVER_CODE = """
from flask import Flask, request, jsonify
import requests
import time
import json

app = Flask(__name__)

# ##############################################################################
# [사용자 수정 영역] ★ 여기만 고치면 됩니다 ★
# ##############################################################################

# 1. 회사 API 주소
COMPANY_API_URL = "http://YOUR_COMPANY_API_URL_HERE" 

# 2. 회사 API 키 (없으면 "" 빈칸 유지)
COMPANY_API_KEY = "YOUR_API_KEY_HERE"

# ##############################################################################

@app.route('/v1/chat/completions', methods=['POST'])
def proxy_chat():
    print(f"\\n[LOG] 질문 수신됨")
    try:
        # 1. Dify 데이터 파싱
        dify_data = request.json
        messages = dify_data.get('messages', [])
        user_input = messages[-1]['content'] if messages else ""
        
        print(f"[LOG] 사용자 질문: {user_input}")

        # 2. 회사 API 전송 (헤더 자동 처리)
        payload = {
            "input_type": "chat",
            "output_type": "chat",
            "input_value": user_input
        }
        
        headers = {}
        if COMPANY_API_KEY:
            headers["x-api-key"] = COMPANY_API_KEY

        # 3. 요청
        response = requests.post(
            COMPANY_API_URL, headers=headers, json=payload, timeout=120
        )
        
        # 4. 응답 처리
        if response.status_code == 200:
            try:
                ai_answer = str(response.json()) # JSON이면 문자열로 변환
            except:
                ai_answer = response.text        # 텍스트면 그대로 사용
        else:
            ai_answer = f"Error: {response.status_code} - {response.text}"

        print(f"[LOG] 답변 반환함")

        # 5. Dify 포맷 반환
        return jsonify({
            "id": "chatcmpl-" + str(int(time.time())),
            "object": "chat.completion",
            "created": int(time.time()),
            "model": "company-ai",
            "choices": [{"index": 0, "message": {"role": "assistant", "content": ai_answer}, "finish_reason": "stop"}],
            "usage": {"prompt_tokens": len(user_input), "completion_tokens": len(ai_answer), "total_tokens": 0}
        })

    except Exception as e:
        print(f"[ERROR] {e}")
        return jsonify({"error": str(e)}), 500

@app.route('/v1/models', methods=['GET'])
def list_models():
    return jsonify({"object": "list", "data": [{"id": "company-ai", "object": "model"}]})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001)
"""

# ==============================================================================
# [파일 2] run.sh : 실행 스크립트 (가상환경 자동 사용)
# ==============================================================================
RUN_SCRIPT = f"""#!/bin/bash
cd "{TARGET_DIR}"
echo "[시작] 1. 필요한 라이브러리 설치 (flask requests)..."
"{VENV_PIP}" install flask requests > /dev/null

echo "[시작] 2. 브릿지 서버 실행 (포트 5001)"
echo "---------------------------------------------------"
echo "★ 주의: 이 창을 끄면 서버도 꺼집니다. 최소화만 하세요."
echo "---------------------------------------------------"
"{VENV_PYTHON}" server.py
"""

def create_files():
    if not os.path.exists(TARGET_DIR):
        os.makedirs(TARGET_DIR)

    # server.py 생성
    with open(os.path.join(TARGET_DIR, "server.py"), "w", encoding="utf-8") as f:
        f.write(SERVER_CODE.strip())

    # run.sh 생성
    run_path = os.path.join(TARGET_DIR, "run.sh")
    with open(run_path, "w", encoding="utf-8") as f:
        f.write(RUN_SCRIPT.strip())
    os.chmod(run_path, 0o755)

    print("-" * 40)
    print(f"설치 완료! '{PROJECT_NAME}' 폴더가 생성되었습니다.")
    print("-" * 40)
    print(f"1. 설정 수정: nano {PROJECT_NAME}/server.py")
    print(f"   (들어가서 주소랑 키만 바꾸세요)")
    print("-" * 40)
    print(f"2. 서버 실행: {PROJECT_NAME}/run.sh")
    print(f"   (이것만 실행하면 됩니다)")
    print("-" * 40)

if __name__ == "__main__":
    create_files()