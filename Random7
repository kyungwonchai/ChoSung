import os
import pymssql

base_dir = "runcline"
if not os.path.exists(base_dir):
    print("‚ùå Ïò§Î•ò: 'runcline' Ìè¥ÎçîÍ∞Ä ÏóÜÏäµÎãàÎã§.")
    exit()

print("üöÄ AI Bridge v9: Bookmark & Readability Update...")

# DB Ï†ïÎ≥¥
DB_HOST = '192.168.0.10'
DB_USER = 'sa'
DB_PASSWORD = 'password'
DB_NAME = 'MyDatabase'

# ==========================================
# 1. DB Migration (Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÖåÏù¥Î∏î Ï∂îÍ∞Ä)
# ==========================================
print("1Ô∏è‚É£ DB Ïä§ÌÇ§Îßà ÏóÖÎç∞Ïù¥Ìä∏ (WebBookmarks Table)...")
try:
    conn = pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)
    cursor = conn.cursor()
    
    # Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
    sql = """
    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='cline_WebBookmarks' AND xtype='U')
    CREATE TABLE cline_WebBookmarks (
        BookmarkID INT IDENTITY(1,1) PRIMARY KEY,
        Title NVARCHAR(100) NOT NULL,
        URL NVARCHAR(1000) NOT NULL,
        CreatedAt DATETIME DEFAULT GETDATE()
    );
    """
    cursor.execute(sql)
    conn.commit()
    conn.close()
    print("   ‚úÖ cline_WebBookmarks ÌÖåÏù¥Î∏î Ï§ÄÎπÑ ÏôÑÎ£å.")

except Exception as e:
    print(f"‚ö†Ô∏è DB ÏûëÏóÖ Ï§ë Ïò§Î•ò: {e}")


# ==========================================
# 2. API Routes (app/routes/api_routes.py)
#    - Ï¶êÍ≤®Ï∞æÍ∏∞ CRUD Ï∂îÍ∞Ä
#    - Queue Ï°∞Ìöå Ïãú ÌïÑÌÑ∞ ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ Ï°∞Ìöå Î°úÏßÅ Ï∂îÍ∞Ä
# ==========================================
print("2Ô∏è‚É£ API Routes ÏóÖÎç∞Ïù¥Ìä∏...")
api_routes_code = r"""from flask import Blueprint, request, jsonify
from app.database import get_db_connection
from app.services.ssh_service import send_rule_via_ssh
import subprocess
import os

api_bp = Blueprint('api', __name__)
BRIDGE_API_URL = "http://192.168.0.10:9111"

@api_bp.route('/open_vscode', methods=['POST'])
def open_vscode():
    data = request.json
    target_ip = data.get('ip')
    user = data.get('account')
    path = data.get('path')
    cmd = ['code', '--no-sandbox', '--new-window']
    remote_arg = f"ssh-remote+{user}@{target_ip}"
    cmd.extend(['--remote', remote_arg, path])
    try:
        env = os.environ.copy()
        if 'DISPLAY' not in env: env['DISPLAY'] = ':0'
        subprocess.Popen(cmd, env=env)
        return jsonify({'status': 'success'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

@api_bp.route('/stats/dashboard', methods=['GET'])
def get_dashboard_stats():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT ISNULL(GroupName, IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_FolderIndex GROUP BY ISNULL(GroupName, IPAddress)")
    group_counts = cursor.fetchall()
    cursor.execute("SELECT ISNULL(f.GroupName, f.IPAddress) as GroupName, COUNT(*) as Cnt FROM cline_TaskQueue q JOIN cline_FolderIndex f ON q.ProjectPath = f.FullPath WHERE q.Status IN ('Pending', 'Processing') GROUP BY ISNULL(f.GroupName, f.IPAddress)")
    active_counts = cursor.fetchall()
    # ÏùºÎ≥Ñ/Ï£ºÎ≥Ñ ÌÜµÍ≥Ñ
    cursor.execute("SELECT TOP 7 CONVERT(VARCHAR(10), CreatedAt, 120) as Label, COUNT(*) as Val FROM cline_TaskQueue GROUP BY CONVERT(VARCHAR(10), CreatedAt, 120) ORDER BY Label DESC")
    daily_stats = cursor.fetchall()
    cursor.execute("SELECT TOP 7 CONVERT(VARCHAR(4), YEAR(CreatedAt)) + '-W' + CONVERT(VARCHAR(2), DATEPART(ISO_WEEK, CreatedAt)) as Label, COUNT(*) as Val FROM cline_TaskQueue GROUP BY CONVERT(VARCHAR(4), YEAR(CreatedAt)) + '-W' + CONVERT(VARCHAR(2), DATEPART(ISO_WEEK, CreatedAt)) ORDER BY Label DESC")
    weekly_stats = cursor.fetchall()
    conn.close()
    return jsonify({'groups': group_counts, 'active': active_counts, 'daily': daily_stats, 'weekly': weekly_stats})

@api_bp.route('/rules', methods=['GET', 'POST'])
def handle_rules():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_ProjectRules ORDER BY RuleID DESC")
        rules = cursor.fetchall()
        conn.close()
        return jsonify(rules)
    if request.method == 'POST':
        data = request.json
        cursor.execute("INSERT INTO cline_ProjectRules (RuleName, RuleContent) VALUES (%s, %s)", (data['name'], data['content']))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

@api_bp.route('/rules/<int:rule_id>', methods=['PUT', 'DELETE'])
def modify_rule(rule_id):
    conn = get_db_connection()
    cursor = conn.cursor()
    if request.method == 'PUT':
        data = request.json
        cursor.execute("UPDATE cline_ProjectRules SET RuleName=%s, RuleContent=%s WHERE RuleID=%s", (data['name'], data['content'], rule_id))
    elif request.method == 'DELETE':
        cursor.execute("DELETE FROM cline_ProjectRules WHERE RuleID=%s", (rule_id,))
    conn.commit()
    conn.close()
    return jsonify({'status': 'success'})

@api_bp.route('/rules/deploy', methods=['POST'])
def deploy_rule():
    data = request.json
    project_name = data.get('project_name')
    project_path = data.get('project_path')
    rule_id = data.get('rule_id')
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT RuleName, RuleContent FROM cline_ProjectRules WHERE RuleID=%s", (rule_id,))
    rule_row = cursor.fetchone()
    cursor.execute("SELECT IPAddress, Account, FullPath FROM cline_FolderIndex WHERE FullPath=%s", (project_path,))
    target = cursor.fetchone()
    if not rule_row or not target:
        conn.close()
        return jsonify({'status': 'error', 'message': 'Not found'}), 404
    final_content = rule_row['RuleContent']
    final_content = final_content.replace('{{PROJECT_NAME}}', project_name)
    final_content = final_content.replace('{{API_URL}}', BRIDGE_API_URL)
    final_content = final_content.replace('{{TARGET_IP}}', target['IPAddress'])
    final_content = final_content.replace('{{TARGET_PATH}}', target['FullPath'])
    final_content = final_content.replace('{SUBJECT}', project_name)
    final_content = final_content.replace('{SERVER_URL}', BRIDGE_API_URL)
    final_content = final_content.replace('{VENV}', 'python')
    final_content = final_content.replace('{TARGET_PATH}', target['FullPath'].replace('\\', '/'))
    success, msg = send_rule_via_ssh(target['IPAddress'], target['Account'], final_content, target['FullPath'])
    if success:
        cursor.execute("UPDATE cline_FolderIndex SET LastRuleContent=%s, LastRuleName=%s WHERE FullPath=%s", (final_content, rule_row['RuleName'], target['FullPath']))
        conn.commit()
    conn.close()
    return jsonify({'status': 'success' if success else 'error', 'message': msg})

@api_bp.route('/memos', methods=['POST'])
def handle_memo_post():
    data = request.json
    p_name = data.get('project')
    p_path = data.get('path')
    content = data.get('content')
    conn = get_db_connection()
    cursor = conn.cursor()
    sql = "MERGE cline_ProjectMemos AS target USING (SELECT %s as PPath, %s as PName) AS source ON (target.ProjectPath = source.PPath) WHEN MATCHED THEN UPDATE SET MemoContent = %s, UpdatedAt = GETDATE() WHEN NOT MATCHED THEN INSERT (ProjectName, ProjectPath, MemoContent) VALUES (%s, %s, %s);"
    cursor.execute(sql, (p_path, p_name, content, p_name, p_path, content))
    conn.commit()
    conn.close()
    return jsonify({'status': 'success'})

@api_bp.route('/memos/get', methods=['POST'])
def handle_memo_get():
    data = request.json
    p_path = data.get('path')
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT MemoContent FROM cline_ProjectMemos WHERE ProjectPath=%s", (p_path,))
    row = cursor.fetchone()
    conn.close()
    return jsonify({'content': row['MemoContent'] if row else ''})

@api_bp.route('/queue', methods=['GET', 'POST', 'DELETE'])
def handle_queue():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    if request.method == 'GET':
        p_path = request.args.get('path')
        if p_path:
            # ÌäπÏ†ï ÌîÑÎ°úÏ†ùÌä∏ ÌÅê Ï°∞Ìöå
            cursor.execute("SELECT * FROM cline_TaskQueue WHERE ProjectPath=%s AND Status IN ('Pending', 'Processing') ORDER BY TaskID", (p_path,))
        else:
            # [New] Ï†ÑÏ≤¥ ÌôúÏÑ± ÌÅê Ï°∞Ìöå (ÏÇ¨Ïù¥ÎìúÎ∞î ÌÅ¥Î¶≠Ïö©)
            cursor.execute("SELECT * FROM cline_TaskQueue WHERE Status IN ('Pending', 'Processing') ORDER BY ProjectName, TaskID")
            
        rows = cursor.fetchall()
        conn.close()
        return jsonify(rows)
        
    if request.method == 'POST':
        data = request.json
        p_name = data.get('project')
        p_path = data.get('path')
        content = data.get('content')
        common_inst = data.get('common_instruction', '')
        final_task_content = content
        if common_inst.strip():
            final_task_content += f"\n\n[SYSTEM NOTICE: ALWAYS EXECUTE THIS]\n{common_inst}"
        cursor.execute("INSERT INTO cline_TaskQueue (ProjectName, ProjectPath, TaskContent) VALUES (%s, %s, %s)", (p_name, p_path, final_task_content))
        cursor.execute("UPDATE cline_FolderIndex SET TaskCount = ISNULL(TaskCount, 0) + 1, LastTaskDate = GETDATE(), CommonInstruction = %s WHERE FullPath=%s", (common_inst, p_path))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})
        
    if request.method == 'DELETE':
        task_id = request.args.get('id')
        cursor.execute("DELETE FROM cline_TaskQueue WHERE TaskID=%s", (task_id,))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

@api_bp.route('/history', methods=['POST'])
def get_history():
    data = request.json
    p_path = data.get('path')
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT TaskID, TaskContent, Status, ResultContent, CONVERT(VARCHAR, CreatedAt, 120) as CreatedAt, CONVERT(VARCHAR, CompletedAt, 120) as CompletedAt FROM cline_TaskQueue WHERE ProjectPath=%s ORDER BY TaskID DESC", (p_path,))
    rows = cursor.fetchall()
    conn.close()
    return jsonify(rows)

# --- [New] Web Bookmarks ---
@api_bp.route('/bookmarks', methods=['GET', 'POST', 'DELETE'])
def handle_bookmarks():
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    
    if request.method == 'GET':
        cursor.execute("SELECT * FROM cline_WebBookmarks ORDER BY CreatedAt ASC")
        rows = cursor.fetchall()
        conn.close()
        return jsonify(rows)
        
    if request.method == 'POST':
        data = request.json
        title = data.get('title')
        url = data.get('url')
        cursor.execute("INSERT INTO cline_WebBookmarks (Title, URL) VALUES (%s, %s)", (title, url))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})
        
    if request.method == 'DELETE':
        bid = request.args.get('id')
        cursor.execute("DELETE FROM cline_WebBookmarks WHERE BookmarkID=%s", (bid,))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

# --- Agent Logic ---
@api_bp.route('/agent/next', methods=['POST'])
def agent_next_task():
    data = request.json
    project_name = data.get('subject')
    conn = get_db_connection()
    cursor = conn.cursor(as_dict=True)
    cursor.execute("SELECT TOP 1 TaskID, TaskContent, ProjectPath FROM cline_TaskQueue WHERE ProjectName=%s AND Status='Pending' ORDER BY TaskID ASC", (project_name,))
    task = cursor.fetchone()
    if task:
        cursor.execute("UPDATE cline_TaskQueue SET Status='Processing', StartedAt=GETDATE() WHERE TaskID=%s", (task['TaskID'],))
        conn.commit()
        conn.close()
        return jsonify({"status": "ok", "log_id": task['TaskID'], "command": task['TaskContent'], "path": task['ProjectPath']})
    else:
        conn.close()
        return jsonify({"status": "wait"})

@api_bp.route('/agent/result', methods=['POST'])
def agent_submit_result():
    data = request.json
    task_id = data.get('log_id')
    result_content = data.get('result')
    project_name = data.get('subject')
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("UPDATE cline_TaskQueue SET Status='Done', CompletedAt=GETDATE(), ResultContent=%s WHERE TaskID=%s", (result_content, task_id))
    if project_name:
        cursor.execute("UPDATE cline_FolderIndex SET LastTaskDate=GETDATE() WHERE DisplayName=%s", (project_name,))
    conn.commit()
    conn.close()
    return jsonify({"status": "received"})
"""
with open(os.path.join(base_dir, "app", "routes", "api_routes.py"), "w", encoding="utf-8") as f:
    f.write(api_routes_code)


# ==========================================
# 3. Settings HTML (Ï¶êÍ≤®Ï∞æÍ∏∞ Í¥ÄÎ¶¨ Ï∂îÍ∞Ä)
# ==========================================
print("3Ô∏è‚É£ Settings HTML ÏóÖÎç∞Ïù¥Ìä∏ (Ï¶êÍ≤®Ï∞æÍ∏∞ Í¥ÄÎ¶¨ Ï∂îÍ∞Ä)...")
settings_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-dark text-white p-4">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold"><i class="bi bi-gear-wide-connected text-info"></i> Settings</h2>
            <a href="/" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h4 class="text-info border-bottom pb-2 mb-3">Rule Management</h4>
                <div class="card bg-secondary text-white mb-3">
                    <div class="card-body">
                        <input type="hidden" id="editRuleId">
                        <input type="text" id="ruleName" class="form-control mb-2 bg-dark text-white border-secondary" placeholder="Rule Name">
                        <textarea id="ruleContent" class="form-control mb-2 bg-dark text-white border-secondary" rows="5" placeholder="Rule Content"></textarea>
                        <button class="btn btn-success w-100 mb-3" onclick="saveRule()">Save Rule</button>
                        
                        <h6 class="text-light">Rule List</h6>
                        <ul class="list-group list-group-flush bg-dark" id="ruleList"></ul>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <h4 class="text-warning border-bottom pb-2 mb-3">Web Favorites (Sidebar)</h4>
                <div class="card bg-secondary text-white">
                    <div class="card-body">
                        <div class="input-group mb-2">
                            <input type="text" id="bmTitle" class="form-control bg-dark text-white border-secondary" placeholder="Title (e.g. Google)">
                            <input type="text" id="bmUrl" class="form-control bg-dark text-white border-secondary" placeholder="URL (https://...)">
                            <button class="btn btn-warning" onclick="addBookmark()">Add</button>
                        </div>
                        
                        <h6 class="text-light mt-3">Current Favorites</h6>
                        <ul class="list-group list-group-flush bg-dark" id="bookmarkList"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rulesData = [];
        document.addEventListener('DOMContentLoaded', () => { loadRules(); loadBookmarks(); });

        // --- Rules ---
        function loadRules() {
            fetch('/api/rules').then(r => r.json()).then(data => {
                rulesData = data;
                const list = document.getElementById('ruleList');
                list.innerHTML = data.map((r, i) => `
                    <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                        <span>${r.RuleName}</span>
                        <div>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="loadRuleIntoForm(${i})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRule(${r.RuleID})"><i class="bi bi-trash"></i></button>
                        </div>
                    </li>`).join('');
            });
        }
        function loadRuleIntoForm(i) {
            const r = rulesData[i];
            document.getElementById('editRuleId').value = r.RuleID;
            document.getElementById('ruleName').value = r.RuleName;
            document.getElementById('ruleContent').value = r.RuleContent;
        }
        function saveRule() {
            const id = document.getElementById('editRuleId').value;
            const name = document.getElementById('ruleName').value;
            const content = document.getElementById('ruleContent').value;
            const url = id ? `/api/rules/${id}` : '/api/rules';
            const method = id ? 'PUT' : 'POST';
            fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify({name, content}) }).then(() => {
                document.getElementById('editRuleId').value = '';
                document.getElementById('ruleName').value = '';
                document.getElementById('ruleContent').value = '';
                loadRules();
            });
        }
        function deleteRule(id) { if(confirm('Delete?')) fetch(`/api/rules/${id}`, {method:'DELETE'}).then(()=>loadRules()); }

        // --- Bookmarks ---
        function loadBookmarks() {
            fetch('/api/bookmarks').then(r => r.json()).then(data => {
                const list = document.getElementById('bookmarkList');
                list.innerHTML = data.map(b => `
                    <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                        <a href="${b.URL}" target="_blank" class="text-decoration-none text-info">${b.Title}</a>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBookmark(${b.BookmarkID})"><i class="bi bi-x-lg"></i></button>
                    </li>`).join('');
            });
        }
        function addBookmark() {
            const title = document.getElementById('bmTitle').value;
            const url = document.getElementById('bmUrl').value;
            if(!title || !url) return alert('Input Title and URL');
            fetch('/api/bookmarks', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title, url}) })
            .then(() => {
                document.getElementById('bmTitle').value = '';
                document.getElementById('bmUrl').value = '';
                loadBookmarks();
            });
        }
        function deleteBookmark(id) { if(confirm('Delete?')) fetch(`/api/bookmarks?id=${id}`, {method:'DELETE'}).then(()=>loadBookmarks()); }
    </script>
</body>
</html>
"""
with open(os.path.join(base_dir, "app", "templates", "settings.html"), "w", encoding="utf-8") as f:
    f.write(settings_html)


# ==========================================
# 4. Index HTML (Ï¶êÍ≤®Ï∞æÍ∏∞ ÏÇ¨Ïù¥ÎìúÎ∞î + Ìè∞Ìä∏ ÏàòÏ†ï)
# ==========================================
print("4Ô∏è‚É£ Index HTML ÏóÖÎç∞Ïù¥Ìä∏ (Ìè∞Ìä∏ ÏµúÏ†ÅÌôî, Ï§ÑÎ∞îÍøà, Ï¶êÍ≤®Ï∞æÍ∏∞ Î∞î)...")
index_html = r"""<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #0d0d0d; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .table-dark { --bs-table-bg: #161616; }
        .table-hover tbody tr:hover { background-color: #2a2a2a; transition: 0.2s; }
        
        .sticky-sidebar { position: sticky; top: 20px; height: calc(100vh - 40px); overflow-y: auto; padding-right: 5px; }
        .stats-box { background: #222; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .stats-box:hover { background: #2a2a2a; border-color: #555; }
        
        .bookmark-btn { width: 100%; text-align: left; margin-bottom: 8px; background: #1a1a1a; border: 1px solid #333; color: #ccc; padding: 10px; border-radius: 8px; transition: 0.2s; display: block; text-decoration: none; }
        .bookmark-btn:hover { background: #333; color: #fff; border-color: #0dcaf0; }

        /* [ÌïµÏã¨] Markdown Í∞ÄÎèÖÏÑ± ÏµúÏ†ÅÌôî */
        .markdown-body {
            font-size: 0.9rem; /* Í∏ÄÏûê ÌÅ¨Í∏∞ Ï∂ïÏÜå */
            line-height: 1.6;
            white-space: pre-wrap; /* Ï§ÑÎ∞îÍøà Ïú†ÏßÄ */
            word-wrap: break-word;
        }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #444; padding-bottom: 0.3em; font-size: 1.4rem; color: #fff; }
        .markdown-body pre { background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        
        .gganji-search { width: 100%; background: #1a1a1a; border: none; border-radius: 50px; padding: 12px 20px 12px 50px; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background-image: linear-gradient(#1a1a1a, #1a1a1a), linear-gradient(45deg, #00c6ff, #0072ff); background-origin: border-box; background-clip: padding-box, border-box; border: 2px solid transparent; }
        .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #00c6ff; }
        .search-container { position: relative; width: 100%; max-width: 600px; }
        
        .modal-xl-custom { max-width: 95% !important; }
        .bg-active-job { background: linear-gradient(90deg, #0f3d24 0%, #161616 100%) !important; border-left: 4px solid #00e676; }
        .bg-memo-exists { background: linear-gradient(90deg, #0d3d52 0%, #161616 100%) !important; border-left: 4px solid #00bcd4; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-black border-bottom border-dark py-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold fs-3 text-white" href="#"><i class="bi bi-cpu-fill text-primary"></i> AI</a>
            <div class="search-container mx-auto">
                <i class="bi bi-search search-icon"></i>
                <input type="text" id="globalSearch" class="gganji-search" placeholder="Search..." onkeyup="filterTable()">
            </div>
            <div class="d-flex align-items-center">
                <span class="me-4 fs-5 text-secondary">Calls <span class="fw-bold text-success">{{ total_calls }}</span></span>
                <a href="/settings" class="btn btn-outline-secondary rounded-pill px-4"><i class="bi bi-gear-fill"></i> Settings</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row g-4">
            <div class="col-md-2">
                <div class="sticky-sidebar">
                    <div class="stats-box" onclick="openAllQueueModal()" title="Click to view details">
                        <h6 class="text-secondary text-uppercase small fw-bold mb-3"><i class="bi bi-lightning-fill text-warning"></i> Queue</h6>
                        <div id="activeStats" class="mt-2 text-warning fw-bold">None</div>
                    </div>
                    
                    <div class="mt-4">
                        <h6 class="text-secondary text-uppercase small fw-bold mb-3 ms-1"><i class="bi bi-star-fill text-warning"></i> Favorites</h6>
                        <div id="sidebarBookmarks">
                            </div>
                    </div>

                    <div class="stats-box mt-4">
                        <h6 class="text-secondary text-uppercase small fw-bold mb-3"><i class="bi bi-graph-up text-primary"></i> Trends</h6>
                        <div id="dailyStats" class="small"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-10">
                <table class="table table-dark table-hover align-middle shadow rounded overflow-hidden" id="projectTable">
                    <thead>
                        <tr class="text-secondary text-uppercase small" style="border-bottom: 2px solid #333;">
                            <th style="width: 100px;">Group</th>
                            <th style="min-width: 400px;">Actions</th>
                            <th class="text-center" style="width: 100px;">Count</th>
                            <th>Project</th>
                            <th>Active</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in projects %}
                        <tr class="{{ 'bg-active-job' if p.IsQueued else ('bg-memo-exists' if p.HasMemo else '') }}">
                            <td><span class="badge bg-secondary opacity-50 rounded-pill">{{ p.GroupName }}</span></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="openVsCode('{{ p.IPAddress }}', '{{ p.Account }}', '{{ p.FullPath }}')"><i class="bi bi-code-slash"></i></button>
                                    <button class="btn btn-success btn-sm rounded-pill px-3" onclick="openTaskModal('{{ p.DisplayName }}', '{{ p.FullPath }}', `{{ p.CommonInstruction or '' }}`)"><i class="bi bi-plus-lg"></i> Task</button>
                                    <div class="text-center" style="width: 100px;">
                                        <button class="btn {{ 'btn-info' if p.LastRuleName else 'btn-outline-info' }} btn-sm w-100 rounded-pill" onclick="openRuleModal('{{ p.DisplayName }}', '{{ p.FullPath }}')"><i class="bi bi-send"></i> Rule</button>
                                        {% if p.LastRuleName %}<span class="d-block mt-1 text-info small text-truncate" style="max-width:100px; font-size:0.7rem;">{{ p.LastRuleName }}</span>{% endif %}
                                    </div>
                                    <button class="btn btn-secondary btn-sm rounded-circle" onclick="openMemoModal('{{ p.DisplayName }}', '{{ p.FullPath }}')" style="width:32px;height:32px;"><i class="bi bi-sticky"></i></button>
                                    <button class="btn btn-warning btn-sm rounded-circle" onclick="openHistoryModal('{{ p.DisplayName }}', '{{ p.FullPath }}')" style="width:32px;height:32px;"><i class="bi bi-clock-history"></i></button>
                                </div>
                            </td>
                            <td class="text-center"><div class="fw-bold fs-5 text-white bg-dark border border-secondary rounded py-1 px-2">{{ p.TaskCount }}</div></td>
                            <td>
                                <div class="fw-bold text-white fs-5">{{ p.DisplayName }}</div>
                                <div class="text-warning small font-monospace opacity-75">{{ p.FullPath }}</div>
                            </td>
                            <td class="small opacity-50">{{ p.LastTaskDate }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="allQueueModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-lightning-fill text-warning"></i> All Active Tasks</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group bg-dark" id="allQueueList"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl-custom modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-secondary bg-dark">
                    <h5 class="modal-title"><i class="bi bi-clock-history text-warning"></i> Task History - <span id="histProjectName" class="text-white"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-black">
                    <div id="historyTimeline" class="p-4 container-fluid"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header border-secondary"><h5 class="modal-title">Task Manager - <span id="modalProjectName" class="text-warning"></span></h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 class="text-secondary mb-2">Queue</h6><ul class="list-group bg-dark mb-4" id="currentQueueList"></ul><div class="form-group mb-3"><label class="text-info small fw-bold">Common</label><textarea class="form-control bg-dark text-info border-info" id="commonInstruction" rows="2"></textarea></div><div class="form-group"><label class="text-white">New Task</label><textarea class="form-control bg-dark text-white border-secondary" id="taskContent" rows="3"></textarea></div></div><div class="modal-footer border-secondary"><button class="btn btn-success" onclick="submitTask()">Add</button></div></div></div></div>
    <div class="modal fade" id="ruleModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Deploy Rule</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Project: <span id="ruleProjectName" class="fw-bold"></span></p><select class="form-select bg-dark text-white mb-2" id="ruleSelect"></select></div><div class="modal-footer"><button class="btn btn-info" onclick="deployRule()">Deploy</button></div></div></div></div>
    <div class="modal fade" id="memoModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Memo</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea class="form-control bg-dark text-white" id="memoContent" rows="10"></textarea></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveMemo()">Save</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Set Marked Options (Break lines)
        marked.setOptions({ breaks: true, gfm: true });

        // Global
        let currentProject = '', currentPath = '';
        const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
        const ruleModal = new bootstrap.Modal(document.getElementById('ruleModal'));
        const memoModal = new bootstrap.Modal(document.getElementById('memoModal'));
        const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
        const allQueueModal = new bootstrap.Modal(document.getElementById('allQueueModal'));

        document.addEventListener('DOMContentLoaded', () => { 
            updateDashboardStats(); 
            loadSidebarBookmarks(); 
            setInterval(updateDashboardStats, 5000); 
        });

        function filterTable() {
            const input = document.getElementById('globalSearch').value.toUpperCase();
            const tr = document.getElementById('projectTable').getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                tr[i].style.display = (tr[i].textContent || tr[i].innerText).toUpperCase().indexOf(input) > -1 ? "" : "none";
            }
        }

        function updateDashboardStats() {
            fetch('/api/stats/dashboard').then(r => r.json()).then(data => {
                document.getElementById('groupStats').innerHTML = data.groups.map(g => `<div class="d-flex justify-content-between mb-1"><span>${g.GroupName}</span> <span class="badge bg-dark border">${g.Cnt}</span></div>`).join('');
                document.getElementById('activeStats').innerHTML = data.active.length ? data.active.map(a => `<div class="d-flex justify-content-between mb-1"><span>${a.GroupName}</span> <span class="badge bg-warning text-dark">${a.Cnt}</span></div>`).join('') : 'None';
                renderBars('dailyStats', data.daily);
            });
        }
        function renderBars(id, data) {
            if(!data || !data.length) { document.getElementById(id).innerHTML = '<div class="text-secondary small">No data</div>'; return; }
            const maxVal = Math.max(...data.map(d => d.Val));
            document.getElementById(id).innerHTML = data.map(d => `<div class="bar-container"><div class="bar-label">${d.Label}</div><div class="bar-wrapper"><div class="bar-fill" style="width: ${(d.Val/maxVal)*100}%"></div></div></div>`).join('');
        }

        // --- Sidebar Bookmarks ---
        function loadSidebarBookmarks() {
            fetch('/api/bookmarks').then(r => r.json()).then(data => {
                document.getElementById('sidebarBookmarks').innerHTML = data.map(b => `
                    <a href="${b.URL}" target="_blank" class="bookmark-btn">
                        <i class="bi bi-link-45deg me-2 text-info"></i> ${b.Title}
                    </a>
                `).join('');
            });
        }

        // --- All Queue Modal ---
        function openAllQueueModal() {
            fetch('/api/queue').then(r => r.json()).then(tasks => {
                const list = document.getElementById('allQueueList');
                if(tasks.length === 0) { list.innerHTML = '<li class="list-group-item bg-dark text-secondary text-center">No active tasks.</li>'; }
                else {
                    list.innerHTML = tasks.map(t => `
                        <li class="list-group-item bg-dark text-white border-secondary mb-2 rounded">
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-warning text-dark">${t.Status}</span>
                                <small class="text-secondary">${t.ProjectName}</small>
                            </div>
                            <div class="mt-2 font-monospace small text-white-50">${t.TaskContent}</div>
                        </li>
                    `).join('');
                }
                allQueueModal.show();
            });
        }

        // --- History (Marked) ---
        function openHistoryModal(name, path) {
            document.getElementById('histProjectName').innerText = name;
            const div = document.getElementById('historyTimeline');
            div.innerHTML = '<div class="text-center p-5 text-secondary">Loading...</div>';
            
            fetch('/api/history', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({path: path}) })
            .then(r => r.json())
            .then(rows => {
                if(rows.length === 0) { div.innerHTML = '<div class="text-center p-5 text-secondary">No history.</div>'; return; }
                div.innerHTML = rows.map(r => `
                    <div class="history-item ${r.Status==='Done'?'done':(r.Status==='Processing'?'processing':'')}">
                        <div class="d-flex justify-content-between mb-2"><div><span class="badge bg-${r.Status==='Done'?'success':'secondary'}">${r.Status}</span> <span class="text-secondary ms-2 small">#${r.TaskID}</span></div><div class="text-secondary small">${r.CompletedAt || r.CreatedAt}</div></div>
                        <div class="card bg-dark border-secondary mb-3"><div class="card-header border-secondary py-1 text-info small fw-bold">REQUEST</div><div class="card-body py-2 markdown-body">${marked.parse(r.TaskContent || '')}</div></div>
                        ${r.ResultContent ? `<div class="card bg-dark border-${r.Status==='Done'?'success':'warning'}"><div class="card-header border-${r.Status==='Done'?'success':'warning'} py-1 text-${r.Status==='Done'?'success':'warning'} small fw-bold">RESULT</div><div class="card-body py-3 markdown-body">${marked.parse(r.ResultContent)}</div></div>` : '<div class="text-secondary small ps-2">Waiting...</div>'}
                    </div>`).join('');
            });
            historyModal.show();
        }

        // Standard Actions
        function openTaskModal(name, path, common) { currentProject=name; currentPath=path; document.getElementById('modalProjectName').innerText=name; document.getElementById('taskContent').value=''; document.getElementById('commonInstruction').value=common; loadQueue(path); taskModal.show(); }
        function loadQueue(path) { fetch(`/api/queue?path=${encodeURIComponent(path)}`).then(r => r.json()).then(tasks => { document.getElementById('currentQueueList').innerHTML = tasks.length ? tasks.map(t => `<li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between"><div><span class="badge bg-warning text-dark me-2">${t.Status}</span> ${t.TaskContent.substring(0,30)}...</div><button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${t.TaskID})"><i class="bi bi-trash"></i></button></li>`).join('') : '<li class="list-group-item bg-dark text-secondary text-center">Empty</li>'; }); }
        function submitTask() { const c=document.getElementById('taskContent').value; const ci=document.getElementById('commonInstruction').value; if(!c) return; fetch('/api/queue', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({project:currentProject, path:currentPath, content:c, common_instruction:ci})}).then(()=>{ document.getElementById('taskContent').value=''; loadQueue(currentPath); updateDashboardStats(); location.reload(); }); }
        function deleteTask(id) { if(confirm('Delete?')) fetch(`/api/queue?id=${id}`, {method:'DELETE'}).then(()=>loadQueue(currentPath)); }
        function openVsCode(ip, acc, path) { fetch('/api/open_vscode', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ip, account:acc, path})}); }
        function openRuleModal(n, p) { currentProject=n; currentPath=p; document.getElementById('ruleProjectName').innerText=n; fetch('/api/rules').then(r=>r.json()).then(rules=>{ document.getElementById('ruleSelect').innerHTML=rules.map(r=>`<option value="${r.RuleID}">${r.RuleName}</option>`).join(''); ruleModal.show(); }); }
        function deployRule() { const id=document.getElementById('ruleSelect').value; fetch('/api/rules/deploy', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({project_name:currentProject, project_path:currentPath, rule_id:id})}).then(r=>r.json()).then(res=>{ alert(res.message); ruleModal.hide(); location.reload(); }); }
        function openMemoModal(n, p) { currentProject=n; currentPath=p; fetch('/api/memos/get', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({path:p})}).then(r=>r.json()).then(d=>{ document.getElementById('memoContent').value=d.content; memoModal.show(); }); }
        function saveMemo() { const c=document.getElementById('memoContent').value; fetch('/api/memos', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({project:currentProject, path:currentPath, content:c})}).then(()=>{ memoModal.hide(); location.reload(); }); }
    </script>
</body>
</html>
"""
with open(os.path.join(base_dir, "app", "templates", "index.html"), "w", encoding="utf-8") as f:
    f.write(index_html)


print("\n‚úÖ v9 ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å!")
print("1. ÎßàÌÅ¨Îã§Ïö¥: Ï§ÑÎ∞îÍøà Í∞ïÏ†ú Ï†ÅÏö© & Í∏ÄÏûê ÌÅ¨Í∏∞ ÏµúÏ†ÅÌôî.")
print("2. ÌÅê ÌòÑÌô©Ìåê: ÏÇ¨Ïù¥ÎìúÎ∞î ÌÅ¥Î¶≠ Ïãú Ï†ÑÏ≤¥ ÏûëÏóÖ Î™©Î°ù ÌôïÏù∏ Í∞ÄÎä•.")
print("3. Ï¶êÍ≤®Ï∞æÍ∏∞: ÏÑ§Ï†ïÏóêÏÑú Ï∂îÍ∞ÄÌïòÍ≥† ÏÇ¨Ïù¥ÎìúÎ∞îÏóêÏÑú Î∞îÎ°úÍ∞ÄÍ∏∞.")
print("üëâ 'python3 runcline/run_bridge.py' Ïã§ÌñâÌïòÏÑ∏Ïöî.")