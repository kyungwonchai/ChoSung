import os

base_dir = "runcline"
if not os.path.exists(base_dir):
    print(f"âŒ ì˜¤ë¥˜: '{base_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# ==========================================
# SSH Service ìˆ˜ì • (ê³µë°± ê²½ë¡œ ì™„ë²½ ëŒ€ì‘ ë²„ì „)
# ==========================================
ssh_service_code = r"""import subprocess
import os

def send_rule_via_ssh(ip, account, rule_content, project_path):
    try:
        # 1. ê²½ë¡œ ì •ê·œí™” (ìœˆë„ìš° ì—­ìŠ¬ë˜ì‹œ -> ìŠ¬ë˜ì‹œ)
        # ìŠ¬ë˜ì‹œëŠ” ìœˆë„ìš°/ë¦¬ëˆ…ìŠ¤ ëª¨ë‘ì—ì„œ ì•ˆì „í•˜ë©°, ë”°ì˜´í‘œ ì•ˆì—ì„œë„ ì•ˆì „í•©ë‹ˆë‹¤.
        if '\\' in project_path:
            project_path = project_path.replace('\\', '/')
            
        # 2. íƒ€ê²Ÿ ê²½ë¡œ ì„¤ì •
        target_dir = f"{project_path}/.clinerules"
        target_file = f"{target_dir}/absoluterule.md"
        
        # [í•µì‹¬] ê³µë°± ì²˜ë¦¬ë¥¼ ìœ„í•œ ê²½ë¡œ ë˜í•‘ (Quoting)
        # SSHë‚˜ SCP ëª…ë ¹ì–´ì— ê³µë°±ì´ ë“¤ì–´ê°„ ê²½ë¡œë¥¼ ë„˜ê¸¸ ë•ŒëŠ”
        # ë°˜ë“œì‹œ ì‘ì€ë”°ì˜´í‘œ(')ë¡œ ê°ì‹¸ì•¼ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ì¸ì‹ë©ë‹ˆë‹¤.
        safe_target_dir = f"'{target_dir}'"   # ì˜ˆ: 'C:/My Projects/.clinerules'
        safe_target_file = f"'{target_file}'" # ì˜ˆ: 'C:/My Projects/.clinerules/absoluterule.md'
        
        # 3. ë¡œì»¬ ì„ì‹œ íŒŒì¼ ìƒì„±
        temp_filename = f"temp_rule_{ip}.md"
        with open(temp_filename, 'w', encoding='utf-8') as f:
            f.write(rule_content)
            
        # 4. [í´ë” ìƒì„±]
        if ':' in project_path: 
            # [Windows PowerShell]
            # PowerShellì€ ê²½ë¡œì— ê³µë°±ì´ ìˆìœ¼ë©´ ì‘ì€ë”°ì˜´í‘œë¡œ ê°ì‹¸ì•¼ í•©ë‹ˆë‹¤.
            # ì´ë¯¸ safe_target_dirì— ì‘ì€ë”°ì˜´í‘œê°€ ìˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë„£ìŠµë‹ˆë‹¤.
            mkdir_cmd_str = f"powershell -Command \"New-Item -ItemType Directory -Force -Path {safe_target_dir}\""
            subprocess.run(['ssh', f'{account}@{ip}', mkdir_cmd_str], check=False)
        else:
            # [Linux]
            # mkdir -p 'path with spaces'
            mkdir_cmd_str = f"mkdir -p {safe_target_dir}"
            subprocess.run(['ssh', f'{account}@{ip}', mkdir_cmd_str], check=False)

        # 5. [SCP íŒŒì¼ ì „ì†¡]
        # SCP ë¬¸ë²•ì—ì„œ ì›ê²©ì§€ ê²½ë¡œëŠ” "user@ip:'path'" í˜•íƒœë¡œ
        # í°ë”°ì˜´í‘œ ì•ˆì— ì‘ì€ë”°ì˜´í‘œê°€ ë“¤ì–´ê°€ëŠ” êµ¬ì¡°ì—¬ì•¼ ê³µë°±ì´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        remote_dest = f'{account}@{ip}:"{target_file}"' 
        # ì£¼ì˜: ìœ„ì—ì„œ safe_target_fileì„ ì“°ì§€ ì•Šê³  ì§ì ‘ í¬ë§·íŒ…í•˜ëŠ” ì´ìœ ëŠ”
        # scp ë¼ì´ë¸ŒëŸ¬ë¦¬ë‚˜ ì‰˜ë§ˆë‹¤ ë”°ì˜´í‘œ í•´ì„ ìˆœì„œê°€ ë¯¸ë¬˜í•˜ê¸° ë•Œë¬¸ì—
        # ê°€ì¥ í˜¸í™˜ì„± ë†’ì€ ë°©ì‹ì¸ user@host:"/path/with space" ë°©ì‹ì„ ì”ë‹ˆë‹¤.
        
        # ë§Œì•½ ìœ„ ë°©ì‹ì´ ì‹¤íŒ¨í•˜ë©´ user@host:"'/path/with space'" ë°©ì‹ì„ ì¨ì•¼ í•˜ëŠ”ë°,
        # ìœˆë„ìš° OpenSSH ì„œë²„ëŠ” user@host:"path" (í°ë”°ì˜´í‘œë§Œ)ë¥¼ ì„ í˜¸í•˜ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤.
        
        scp_cmd = ['scp', '-o', 'StrictHostKeyChecking=no', temp_filename, remote_dest]
        
        # ì‹¤í–‰ (ì—ëŸ¬ ë°œìƒ ì‹œ ìº¡ì²˜)
        subprocess.check_call(scp_cmd)
        
        # 6. ì²­ì†Œ
        if os.path.exists(temp_filename):
            os.remove(temp_filename)
            
        return True, "Rule deployed successfully"
        
    except subprocess.CalledProcessError as e:
        return False, f"Transfer Failed (Check path/permissions): {e}"
    except Exception as e:
        return False, f"Error: {e}"
"""

target_file = os.path.join(base_dir, "app", "services", "ssh_service.py")
with open(target_file, "w", encoding="utf-8") as f:
    f.write(ssh_service_code)

print("âœ… ê³µë°± ê²½ë¡œ íŒ¨ì¹˜ ì™„ë£Œ!")
print("ğŸ‘‰ ì´ì œ 'C:/My Projects/...' ì²˜ëŸ¼ ê³µë°±ì´ ìˆì–´ë„ í´ë”ë¥¼ ìƒì„±í•˜ê³  íŒŒì¼ì„ ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
print("ğŸ‘‰ ë‹¤ì‹œ ì‹¤í–‰: python3 runcline/run_bridge.py")